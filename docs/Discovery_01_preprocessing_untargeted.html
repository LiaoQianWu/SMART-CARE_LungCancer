<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Qian-Wu Liao" />


<title>Preprocessing: Untargeted Lipidomics of Discovery cohort</title>

<script src="site_libs/header-attrs-2.26/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/main/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SMART-CARE: Lung Cancer</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/LiaoQianWu/SMART-CARE_LungCancer">
    <span class="fab fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Preprocessing: Untargeted Lipidomics of
Discovery cohort</h1>
<h4 class="author">Qian-Wu Liao</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span>
workflowr <span class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span
class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2024-05-15
</p>
<p>
<strong>Checks:</strong> <span
class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 6
<span class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span> 1
</p>
<p>
<strong>Knit directory:</strong> <code>SMART-CARE_LungCancer/</code>
<span class="glyphicon glyphicon-question-sign" aria-hidden="true"
title="This is the local directory in which the code in this file was executed.">
</span>
</p>
<p>
This reproducible <a href="https://rmarkdown.rstudio.com">R Markdown</a>
analysis was created with <a
  href="https://github.com/workflowr/workflowr">workflowr</a> (version
1.7.1). The <em>Checks</em> tab describes the reproducibility checks
that were applied when the results were created. The <em>Past
versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date
</a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate"
class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git
repository, you know the exact version of the code that produced these
results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the
global environment can affect the analysis in your R Markdown file in
unknown ways. For reproduciblity it’s best to always run the code in an
empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20230425code">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Seed:</strong>
<code>set.seed(20230425)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20230425code"
class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20230425)</code> was run prior to running
the code in the R Markdown file. Setting a seed ensures that any results
that rely on randomness, e.g. subsampling or permutations, are
reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Session information:</strong>
recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded"
class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package
versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be
confident that you successfully produced the results during this
run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongabsolute">
<span class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span> <strong>File paths:</strong> absolute </a>
</p>
</div>
<div id="strongFilepathsstrongabsolute" class="panel-collapse collapse">
<div class="panel-body">
<p>
Using absolute paths to the files within your workflowr project makes it
difficult for you and others to run your code on a different machine.
Change the absolute path(s) below to the suggested relative path(s) to
make your code more reproducible.
</p>
<table class="table table-condensed table-hover">
<thead>
<tr>
<th style="text-align:left;">
absolute
</th>
<th style="text-align:left;">
relative
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
/Users/qianwu/Desktop/SMART-CARE_LungCancer
</td>
<td style="text-align:left;">
.
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomLiaoQianWuSMARTCARELungCancertree9a5191e865f9c1d40a49ea46a7c1c020e986c53etargetblank9a5191ea">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Repository version:</strong>
<a href="https://github.com/LiaoQianWu/SMART-CARE_LungCancer/tree/9a5191e865f9c1d40a49ea46a7c1c020e986c53e" target="_blank">9a5191e</a>
</a>
</p>
</div>
<div
id="strongRepositoryversionstrongahrefhttpsgithubcomLiaoQianWuSMARTCARELungCancertree9a5191e865f9c1d40a49ea46a7c1c020e986c53etargetblank9a5191ea"
class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development
and connecting the code version to the results is critical for
reproducibility.
</p>
<p>
The results in this page were generated with repository version
<a href="https://github.com/LiaoQianWu/SMART-CARE_LungCancer/tree/9a5191e865f9c1d40a49ea46a7c1c020e986c53e" target="_blank">9a5191e</a>.
See the <em>Past versions</em> tab to see a history of the changes made
to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for
the analysis have been committed to Git prior to generating the results
(you can use <code>wflow_publish</code> or
<code>wflow_git_commit</code>). workflowr only checks the R Markdown
file, but you know if there are other scripts or data files that it
depends on. Below is the status of the Git repository when the results
were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .DS_Store
    Ignored:    .RData
    Ignored:    .Rhistory
    Ignored:    analysis/.DS_Store
    Ignored:    code/.DS_Store
    Ignored:    data/.DS_Store
    Ignored:    output/.DS_Store

Untracked files:
    Untracked:  analysis/CrossCohort_investigation_EXP.Rmd
    Untracked:  code/archive/
    Untracked:  code/comparison_funcs.R
    Untracked:  code/dataset_list.R
    Untracked:  code/workflowr_commands.R
    Untracked:  data/Discovery/
    Untracked:  data/MethodDev/
    Untracked:  data/aliquot_metadata.xlsx
    Untracked:  data/patient_metadata.xlsx
    Untracked:  data/sample_metadata.xlsx
    Untracked:  output/Discovery/
    Untracked:  output/MethodDev/
    Untracked:  output/SC_meeting/

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not
included in this status report because it is ok for generated content to
have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were
made to the R Markdown
(<code>analysis/Discovery_01_preprocessing_untargeted.Rmd</code>) and
HTML (<code>docs/Discovery_01_preprocessing_untargeted.html</code>)
files. If you’ve configured a remote Git repository (see
<code>?wflow_git_remote</code>), click on the hyperlinks in the table
below to view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/LiaoQianWu/SMART-CARE_LungCancer/blob/cd2e72fd51e912d4954dbe71a02224a607f18df9/analysis/Discovery_01_preprocessing_untargeted.Rmd" target="_blank">cd2e72f</a>
</td>
<td>
LiaoQianWu
</td>
<td>
2024-04-29
</td>
<td>
Do SVA and SOA of untargeted lipidomics
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/LiaoQianWu/SMART-CARE_LungCancer/blob/df818f2365f9e09d63fc82c5fb78ed7a7c78749c/analysis/Discovery_01_preprocessing_untargeted.Rmd" target="_blank">df818f2</a>
</td>
<td>
LiaoQianWu
</td>
<td>
2024-04-21
</td>
<td>
Redo investigation of impacts of sample missing levels on data and
retrain MOFA models using only common samples
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/LiaoQianWu/SMART-CARE_LungCancer/blob/fddf694f5651a6def9cf517cfc70d65591bbf119/analysis/Discovery_01_preprocessing_untargeted.Rmd" target="_blank">fddf694</a>
</td>
<td>
LiaoQianWu
</td>
<td>
2024-04-04
</td>
<td>
Redo investigation of association between data missingness and processed
data using PCA, instead of PPCA, and improve some parts in untargeted
lipidomics analysis
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/LiaoQianWu/SMART-CARE_LungCancer/blob/4903017c3600a960b6c4f97864a2b0dbe5d67446/analysis/Discovery_01_preprocessing_untargeted.Rmd" target="_blank">4903017</a>
</td>
<td>
LiaoQianWu
</td>
<td>
2024-03-22
</td>
<td>
Preprocess and compare plasma and tissue untargeted lipidomics generated
by different parameters
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<p><font size='4'> Description: Preprocess Discovery Tissue and Plasma
Untargeted Lipidomics generated by Dr. Qiuqin Zhou from AG Hopf,
including data cleansing, filtering (by RT, QC RSD%, missing values,
etc.), normalization (VSN), and batch correction if needed. All needed
information was then stored in SummarizedExperiment objects for further
analyses. Besides, datasets generated by different levels of
within-batch correction and batches used were compared to determine best
parameters. </font></p>
<p>Load libraries</p>
<pre class="r"><code>library(readr)
library(readxl)
library(vsn)
library(limma)
library(sva)
library(visdat)
library(ggrepel)
library(ggvenn)
library(SummarizedExperiment)
library(tidyverse)
# Load user-defined functions
source(&#39;./code/analysis_pipeline.R&#39;)
source(&#39;./code/misc.R&#39;)
source(&#39;./code/comparison_funcs.R&#39;)

# Set plot theme
th &lt;- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = &#39;bold&#39;),
        axis.text = element_text(face = &#39;bold&#39;),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
th4MissViz &lt;- theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0,
                                               size = 11, face = &#39;bold&#39;),
                    axis.text.y = element_blank(),
                    axis.title.y = element_text(size = 13, face = &#39;bold&#39;),
                    legend.text = element_text(size = 12, face = &#39;bold&#39;))</code></pre>
<pre class="r"><code># Load sample metadata
smpMetadat &lt;- readxl::read_excel(&#39;./data/sample_metadata.xlsx&#39;)
colnames(smpMetadat) &lt;- smpMetadat[3,, drop = F]
smpMetadat &lt;- dplyr::slice(smpMetadat, -c(1:3)) %&gt;%
  dplyr::select(c(Code, Parents, Visit, `Material submitted`, `Date and time of collection or surgery`,
                  `SMART-CARE cohort identifier`)) %&gt;%
  dplyr::rename(Sample = Code, Patient = Parents, TimePoint = Visit, SmpType = `Material submitted`,
                Date = `Date and time of collection or surgery`, Cohort = `SMART-CARE cohort identifier`) %&gt;%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, &#39;^SC_T_S_|^SC_DIS_S_|^SC_S_|_P&#39;),
                Patient = stringr::str_remove(Patient, &#39;^/THRX_SPACE/THRX_DB/&#39;),
                TimePoint = dplyr::case_when(TimePoint == &#39;PRETHERAPEUTIC&#39; ~ &#39;Baseline&#39;,
                                             TimePoint == &#39;FOLLOW-UP&#39; ~ &#39;Follow-up&#39;,
                                             TimePoint == &#39;RECURRENCE&#39; ~ &#39;Recurrence&#39;),
                SmpType = dplyr::case_when(SmpType == &#39;EDTA_PLASMA&#39; ~ &#39;Plasma&#39;,
                                           SmpType == &#39;FRESH_FROZEN_TISSUE&#39; ~ &#39;Tissue&#39;),
                Condition = dplyr::case_when(grepl(&#39;_TU|_TG&#39;, Sample) ~ &#39;Tumor&#39;,
                                             grepl(&#39;_NG&#39;, Sample) ~ &#39;Normal&#39;,
                                             !grepl(&#39;_TU|_TG|_NG&#39;, Sample) ~ TimePoint),
                TimePoint = dplyr::case_when(TimePoint %in% &#39;Recurrence&#39; ~ &#39;Follow-up&#39;,
                                             !TimePoint %in% &#39;Recurrence&#39; ~ TimePoint),
                Date = stringr::str_extract(Date, &#39;^\\d+-\\d+-\\d+&#39;),
                Cohort = dplyr::case_when(Cohort == &#39;DISCOVERY_COHORT&#39; ~ &#39;Discovery&#39;,
                                          Cohort == &#39;METHOD_DEVELOPMENT_COHORT&#39; ~ &#39;MethodDev&#39;),
                Date = as.Date(Date, format = &#39;%Y-%m-%d&#39;))

# Load patient metadata
patientMetadat &lt;- readxl::read_excel(&#39;./data/patient_metadata.xlsx&#39;)
colnames(patientMetadat) &lt;- patientMetadat[3,, drop = F]
patientMetadat &lt;- dplyr::slice(patientMetadat, -c(1:3)) %&gt;%
  dplyr::select(c(Code, Gender, `Age at diagnosis`, `Pathological stage`, `Smoking status`,
                  `Adjuvant chemotherapy`,)) %&gt;%
  dplyr::rename(Patient = Code, Age = `Age at diagnosis`, Stage = `Pathological stage`,
                Smoking = `Smoking status`, Adjuvant = `Adjuvant chemotherapy`) %&gt;%
  dplyr::mutate(Gender = dplyr::case_when(Gender == &#39;MALE&#39; ~ &#39;Male&#39;,
                                          Gender == &#39;FEMALE&#39; ~ &#39;Female&#39;),
                Smoking = dplyr::case_when(Smoking == &#39;SMOKER&#39; ~ &#39;Smoker&#39;,
                                           Smoking == &#39;EX-SMOKER&#39; ~ &#39;Ex-smoker&#39;,
                                           Smoking == &#39;NON-SMOKER&#39; ~ &#39;Non-smoker&#39;),
                Adjuvant = dplyr::case_when(Adjuvant == &#39;true&#39; ~ &#39;True&#39;,
                                            Adjuvant == &#39;false&#39; ~ &#39;False&#39;),
                Age = as.numeric(Age))
# Include patient recurrence information in patient metadata
recurPats &lt;- dplyr::filter(smpMetadat, Condition == &#39;Recurrence&#39;) %&gt;%
  dplyr::pull(Patient)
patientMetadat &lt;- dplyr::mutate(patientMetadat, Recurrence = dplyr::case_when(Patient %in% recurPats ~ &#39;Yes&#39;,
                                                                              !Patient %in% recurPats ~ &#39;No&#39;))

# Load aliquot metadata
aliquotMetadat &lt;- readxl::read_excel(&#39;./data/aliquot_metadata.xlsx&#39;)
colnames(aliquotMetadat) &lt;- aliquotMetadat[3,, drop = F]
aliquotMetadat &lt;- dplyr::slice(aliquotMetadat, -c(1:3)) %&gt;%
  dplyr::select(Code, Parents, `Tumor Cell Content (%)`, `Cohort Identifier`, `Submission to`,
                `Delivered?`) %&gt;%
  dplyr::rename(Aliquot = Code, Sample = Parents, TumorPurity = `Tumor Cell Content (%)`,
                Cohort = `Cohort Identifier`, To = `Submission to`, Delivered = `Delivered?`) %&gt;%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, &#39;^/THRX_SPACE/THRX_DB/SC_T_S_|_P&#39;),
                Sample = stringr::str_remove(Sample, &#39;^/THRX_SPACE/THRX_DB/SC_DIS_S_&#39;),
                Sample = stringr::str_remove(Sample, &#39;^/THRX_SPACE/THRX_DB/SC_S_&#39;),
                Sample = stringr::str_remove(Sample, &#39;^/THRX_SPACE/THRX_DB/SC_DIS_&#39;),
                Cohort = dplyr::case_when(Cohort == &#39;method establishment&#39; ~ &#39;MethodDev&#39;,
                                          Cohort == &#39;DISCOVERY_COHORT&#39; ~ &#39;Discovery&#39;),
                TumorPurity = as.numeric(TumorPurity),
                # Mislabeling??
                Sample = case_when(Sample %in% &#39;SDIR55_NG&#39; ~ &#39;PDIR55_NG&#39;,
                                   Sample %in% &#39;SDIR55_TU&#39; ~ &#39;PDIR55_TU&#39;,
                                   !Sample %in% c(&#39;SDIR55_NG&#39;, &#39;SDIR55_TU&#39;) ~ Sample)) %&gt;%
  dplyr::filter(To %in% &#39;HOPF&#39;)
# Prepare tumor purity information
tumorPurityInfo &lt;- dplyr::select(aliquotMetadat, Sample, TumorPurity)

# Combine all needed metadata
summMetadat &lt;- dplyr::left_join(smpMetadat, patientMetadat, by = &#39;Patient&#39;) %&gt;%
  dplyr::left_join(tumorPurityInfo, by = &#39;Sample&#39;)
summMetadat4Discovery &lt;- dplyr::select(aliquotMetadat, Aliquot, Sample, TumorPurity) %&gt;%
  dplyr::left_join(smpMetadat, by = &#39;Sample&#39;) %&gt;%
  dplyr::left_join(patientMetadat, by = &#39;Patient&#39;)

# List sample annotations to keep in SE objects
smpAnno &lt;- c(&#39;Patient&#39;, &#39;SmpType&#39;, &#39;TimePoint&#39;, &#39;Date&#39;, &#39;Cohort&#39;, &#39;Condition&#39;,
             &#39;Recurrence&#39;, &#39;Gender&#39;, &#39;Age&#39;, &#39;Smoking&#39;, &#39;Stage&#39;, &#39;Adjuvant&#39;)</code></pre>
<div id="tissue-lipidomics" class="section level1">
<h1>Tissue Lipidomics</h1>
<div id="wbc-25" class="section level2">
<h2>WBC-25%</h2>
<pre class="r"><code># Load data
lipTissueWBC25 &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Feature table_Discoverycohort_tissue_lipids_20240320.xlsx&#39;,
                                     sheet = &#39;25 percent within-batch correct&#39;)
# Assign column names
colnames(lipTissueWBC25) &lt;- lipTissueWBC25[6,]
lipTissueWBC25 &lt;- lipTissueWBC25[-seq_len(6),]
# Store red flag features (intensity blank / sample &gt;= 3)
redFlagFeats &lt;- lipTissueWBC25$Flags
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipTissueWBC25 &lt;- dplyr::select(lipTissueWBC25, -c(`M meas,`, Ions, `MS/MS`, Boxplot)) %&gt;%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %&gt;%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, &#39;/&#39;, CCS, &#39;/&#39;, MZ),
                Flags = redFlagFeats) %&gt;%
  dplyr::filter(RT &gt;= 0.3, RT &lt;= 9) %&gt;%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab &lt;- lipTissueWBC25
if (!any(duplicated(tidyTab$Feature))) {
  summFilt &lt;- c(`Ori feat num` = nrow(tidyTab), `m/z &lt; 300` = sum(tidyTab$MZ &lt; 300),
                `QC RSD% &gt; 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD &lt; 25, na.rm = T),
                `Red flag feats` = sum(grepl(&#39;RED&#39;, tidyTab$Flags)),
                `QC RSD% &gt; 25` = sum(tidyTab$QC_RSD &gt; 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat(&#39;There are duplicated features!&#39;)
}
WBC25 &lt;- summFilt
rm(tidyTab, summFilt)
####

lipTissueWBC25 &lt;- dplyr::filter(lipTissueWBC25, MZ &gt;= 300, QC_RSD &lt;= 25, !grepl(&#39;RED&#39;, Flags)) %&gt;%
  dplyr::select(-c(QC_RSD, contains(&#39;Pooled QC Tissue&#39;), contains(&#39;Processed blank&#39;), Flags))

# Convert data into long data and combine it with summarized metadata
lipTissueWBC25 &lt;- tidyr::pivot_longer(lipTissueWBC25, cols = -c(&#39;Feature&#39;, &#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      names_to = &#39;Aliquot&#39;, values_to = &#39;Abundance&#39;) %&gt;%
  dplyr::mutate(Aliquot = stringr::str_remove(Aliquot, &#39;_pos.+&#39;),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% &#39;SC_DIS_A_PDIR55_TU3&#39; ~ &#39;SC_DIS_A_PDIR55_TU2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_1QFJ7P_TU3&#39; ~ &#39;SC_DIS_A_1QFJ7P_TU1&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_8ZSMVV_NG1&#39; ~ &#39;SC_DIS_A_8ZSMVV_NG3&#39;,
                                    !Aliquot %in% c(&#39;SC_DIS_A_PDIR55_TU3&#39;,
                                                    &#39;SC_DIS_A_1QFJ7P_TU3&#39;,
                                                    &#39;SC_DIS_A_8ZSMVV_NG1&#39;) ~ Aliquot)) %&gt;%
  dplyr::left_join(summMetadat4Discovery, by = &#39;Aliquot&#39;) %&gt;%
  dplyr::select(-Aliquot)

# Keep only samples with good quality (decent tumor purity)
proTissue &lt;- readRDS(&#39;./data/Discovery/AG_Krijgsveld/proTissueVsn.rds&#39;)
lipTissueWBC25 &lt;- lipTissueWBC25[lipTissueWBC25$Patient %in% unique(colData(proTissue)$Patient),]</code></pre>
<p><font size='2'> <strong>Vsn normalized data BEFORE filtered by
missingness</strong> for checking associations between data and sample
median expressions and missing levels </font></p>
<pre class="r"><code># Normalize unfiltered data
lipTissueTab &lt;- lipTissueWBC25
lipTissueUnfiltVsn &lt;- doPreprocessing(lipTissueTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;TumorPurity&#39;), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipTissueUnfiltVsnTab &lt;- summExp2df(lipTissueUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipTissueUnfiltVsn)[2], &#39;samples and&#39;, dim(lipTissueUnfiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 86 samples and 2888 features</code></pre>
<pre class="r"><code># Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Unfiltered data&#39;) +
  th4MissViz + theme(axis.text.x = element_text(size = 9))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-2-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipTissueUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 9))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-2-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipTissueUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-2-3.png" width="960" style="display: block; margin: auto;" /></p>
<p><font size='2'> <strong>Vsn normalized data AFTER filtered by
missingness</strong> </font><br />
Features quantified in less than 2/3 of samples are removed.</p>
<pre class="r"><code># Filter and normalize data
lipTissueTab &lt;- lipTissueWBC25
lipTissue &lt;- doPreprocessing(lipTissueTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                             val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                             smpAnno = c(smpAnno, &#39;TumorPurity&#39;), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
lipTissueFilt &lt;- lipTissue$filt.data
lipTissueFiltVsn &lt;- lipTissue$vsn.data
# Prepare long data for plotting
lipTissueFiltVsnTab &lt;- summExp2df(lipTissueFiltVsn, assay = &#39;Abundance&#39;,
                                  row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;) %&gt;%
  # Compute sample missing levels
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(MissLevel = sum(is.na(Value)) / length(Value)) %&gt;%
  dplyr::ungroup()
lipTissueFiltVsn &lt;- df2SummExp(lipTissueFiltVsnTab, row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;,
                               values = &#39;Value&#39;, row_anno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                               col_anno = c(smpAnno, &#39;TumorPurity&#39;, &#39;MissLevel&#39;))
assay(lipTissueFiltVsn) &lt;- as.matrix(assay(lipTissueFiltVsn))
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipTissueFiltVsn)[2], &#39;samples and&#39;, dim(lipTissueFiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 86 samples and 2320 features</code></pre>
<pre class="r"><code># Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueFilt)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Filtered data&#39;) +
  th4MissViz + theme(axis.text.x = element_text(size = 9))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-3-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipTissueFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Filtered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 9))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-3-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipTissueFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-3-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Save preprocessed data
saveRDS(lipTissueFiltVsn, &#39;./data/Discovery/AG_Hopf/lipTissueVsn_WBC25.rds&#39;)</code></pre>
<p><strong>Do biological quality control</strong><br />
<font size='2'> <strong>PPCA</strong> </font></p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipTissueFiltVsn, meta_var = c(&#39;Condition&#39;, &#39;Recurrence&#39;, &#39;Gender&#39;,
                                               &#39;Age&#39;, &#39;Smoking&#39;, &#39;Stage&#39;, &#39;Adjuvant&#39;,
                                               &#39;MissLevel&#39;),
                pca_method = &#39;ppca&#39;, num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes</code></pre>
<pre><code>          Var1       Var2     pVal  pValAdj   Stat        Test
1  PC1 (41.5%)  Condition 3.39e-09 5.42e-07 -6.610      T-test
2  PC2 (13.5%)  Condition 6.12e-08 4.24e-06 -5.940      T-test
3  PC1 (41.5%)  MissLevel 7.95e-08 4.24e-06  0.540 Correlation
4  PC2 (13.5%)  MissLevel 2.40e-07 9.60e-06 -0.523 Correlation
5   PC5 (4.3%)    Smoking 1.74e-05 5.56e-04 12.500       ANOVA
6  PC13 (1.6%)      Stage 2.49e-04 6.64e-03  9.190       ANOVA
7  PC2 (13.5%)      Stage 1.17e-03 2.68e-02  7.330       ANOVA
8  PC17 (1.2%)        Age 1.88e-03 3.77e-02 -0.331 Correlation
9   PC4 (6.1%)  MissLevel 2.87e-03 5.10e-02 -0.318 Correlation
10 PC11 (1.8%)   Adjuvant 3.24e-03 5.18e-02 -3.030      T-test
11  PC4 (6.1%)  Condition 5.01e-03 7.29e-02  2.880      T-test
12 PC15 (1.3%)   Adjuvant 1.12e-02 1.45e-01 -2.590      T-test
13  PC8 (2.6%)  MissLevel 1.23e-02 1.45e-01 -0.269 Correlation
14  PC9 (2.2%)     Gender 1.29e-02 1.45e-01  2.540      T-test
15 PC2 (13.5%)     Gender 1.36e-02 1.45e-01  2.520      T-test
16    PC7 (3%)    Smoking 2.33e-02 2.33e-01  3.930       ANOVA
17 PC17 (1.2%) Recurrence 2.96e-02 2.79e-01 -2.210      T-test
18 PC11 (1.8%)     Gender 3.36e-02 2.98e-01 -2.160      T-test
19  PC3 (8.2%)     Gender 3.63e-02 3.06e-01  2.130      T-test
20  PC5 (4.3%)        Age 4.38e-02 3.20e-01  0.218 Correlation
21 PC11 (1.8%)    Smoking 4.47e-02 3.20e-01  3.230       ANOVA
22 PC1 (41.5%)     Gender 4.54e-02 3.20e-01 -2.030      T-test
23 PC11 (1.8%)        Age 4.82e-02 3.20e-01 -0.214 Correlation
24 PC19 (0.9%)    Smoking 4.95e-02 3.20e-01  3.120       ANOVA
25 PC14 (1.5%)      Stage 5.00e-02 3.20e-01  3.110       ANOVA</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab %&gt;%
  dplyr::mutate(Label = case_when(Sample %in% c(&#39;1NL5BV_TU&#39;, &#39;1NL5BV_NG&#39;,
                                                &#39;I0HVOL_TU&#39;, &#39;I0HVOL_NG&#39;,
                                                &#39;7EAOX7_TU&#39;, &#39;7EAOX7_NG&#39;) ~ Sample),
                Label2 = case_when(Sample %in% c(&#39;1NL5BV_TU&#39;, &#39;1NL5BV_NG&#39;,
                                                 &#39;1VVXHY_TU&#39;, &#39;1VVXHY_NG&#39;,
                                                 &#39;CMVZEW_TU&#39;, &#39;CMVZEW_NG&#39;,
                                                 &#39;1XUOU0_TU&#39;, &#39;1XUOU0_NG&#39;,
                                                 &#39;1XGTDZ_TU&#39;, &#39;1XGTDZ_NG&#39;,
                                                 &#39;11BMIX_TU&#39;, &#39;11BMIX_NG&#39;,
                                                 &#39;1IHGAC_TU&#39;, &#39;1IHGAC_NG&#39;,
                                                 &#39;1H3IW7_TU&#39;, &#39;1H3IW7_NG&#39;,
                                                 &#39;Q7B5U6_TU&#39;, &#39;Q7B5U6_NG&#39;,
                                                 &#39;NVJH6R_TU&#39;, &#39;NVJH6R_NG&#39;,
                                                 &#39;Q89YQK_TU&#39;, &#39;Q89YQK_NG&#39;,
                                                 &#39;MJMTYR_TU&#39;, &#39;MJMTYR_NG&#39;) ~ Sample))

ggplot(pcTab, aes(x=Condition, y=`PC1 (41.5%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-4-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC1 (41.5%)`, y=`PC2 (13.5%)`, col=Condition, label=Label)) +
  geom_point(size = 2.5) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-4-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC1 (41.5%)`, y=`PC2 (13.5%)`, col=MissLevel)) +
  geom_point(size = 2.5) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-4-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Store probable bad-quality samples
bqSmps &lt;- c(&#39;1NL5BV_TU&#39;, &#39;1NL5BV_NG&#39;, &#39;1VVXHY_NG&#39;, &#39;CMVZEW_NG&#39;, &#39;1XUOU0_NG&#39;, &#39;1XGTDZ_TU&#39;,
            &#39;1XGTDZ_NG&#39;, &#39;11BMIX_NG&#39;, &#39;1IHGAC_NG&#39;, &#39;1H3IW7_NG&#39;, &#39;Q7B5U6_TU&#39;, &#39;Q7B5U6_NG&#39;,
            &#39;NVJH6R_NG&#39;, &#39;Q89YQK_TU&#39;, &#39;Q89YQK_NG&#39;, &#39;MJMTYR_TU&#39;)</code></pre>
<p>=&gt; Tumor purity: I0HVOL_TU - 87% / 7EAOX7_TU - 70% / 1NL5BV_TU -
53%<br />
(Mean of sample tumor cell contents is 74%, ranging from 40% to
100%.)</p>
<p><font size='2'> <strong>Ordinary PCA</strong> </font></p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipTissueFiltVsn, meta_var = c(&#39;Condition&#39;, &#39;Recurrence&#39;, &#39;Gender&#39;,
                                               &#39;Age&#39;, &#39;Smoking&#39;, &#39;Stage&#39;, &#39;Adjuvant&#39;,
                                               &#39;MissLevel&#39;),
                pca_method = &#39;pca&#39;, num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes %&gt;%
  dplyr::filter(grepl(&#39;PC[1-9] \\(&#39;, Var1))</code></pre>
<pre><code>          Var1      Var2     pVal  pValAdj    Stat        Test
1  PC1 (27.4%) Condition 9.82e-17 6.76e-14 -10.400      T-test
2  PC2 (11.9%) MissLevel 8.07e-10 2.77e-07   0.603 Correlation
3     PC3 (9%) MissLevel 2.26e-06 5.18e-04  -0.485 Correlation
4   PC4 (5.7%) Condition 2.97e-04 4.09e-02  -3.780      T-test
5   PC7 (3.4%)   Smoking 1.30e-03 1.27e-01   7.200       ANOVA
6     PC3 (9%)     Stage 1.72e-03 1.30e-01   6.880       ANOVA
7  PC2 (11.9%)    Gender 1.89e-03 1.30e-01  -3.210      T-test
8   PC9 (2.3%)  Adjuvant 2.94e-03 1.84e-01   3.060      T-test
9   PC4 (5.7%)    Gender 8.13e-03 4.00e-01   2.710      T-test
10 PC1 (27.4%) MissLevel 1.09e-02 4.69e-01   0.273 Correlation
11  PC8 (2.6%)       Age 3.21e-02 6.63e-01   0.231 Correlation
12  PC7 (3.4%)       Age 3.59e-02 6.87e-01  -0.227 Correlation
13 PC2 (11.9%)  Adjuvant 4.31e-02 7.23e-01   2.050      T-test
14  PC5 (4.8%) Condition 4.33e-02 7.23e-01  -2.050      T-test
15  PC4 (5.7%)   Smoking 4.52e-02 7.23e-01   3.220       ANOVA</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab %&gt;%
  dplyr::mutate(Label = case_when(Sample %in% bqSmps ~ Sample),
                Label2 = case_when(Sample %in% c(&#39;1NL5BV_TU&#39;, &#39;1NL5BV_NG&#39;,
                                                 &#39;MJMTYR_TU&#39;, &#39;MJMTYR_NG&#39;,
                                                 &#39;1XGTDZ_TU&#39;, &#39;1XGTDZ_NG&#39;,
                                                 &#39;7EAOX7_TU&#39;, &#39;7EAOX7_NG&#39;,
                                                 &#39;I0HVOL_TU&#39;, &#39;I0HVOL_NG&#39;) ~ Sample))

ggplot(pcTab, aes(x=Condition, y=`PC1 (27.4%)`, col=Condition, fill=Condition, label=Label2)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  geom_text_repel(show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-5-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC1 (27.4%)`, y=`PC4 (5.7%)`, col=Condition, label=Label)) +
  geom_point(size = 2.5) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-5-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC1 (27.4%)`, y=`PC4 (5.7%)`, col=MissLevel)) +
  geom_point(size = 2.5) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-5-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=MissLevel, y=`PC2 (11.9%)`, col=MissLevel)) +
  geom_point(size = 2.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-5-4.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=MissLevel, y=`PC3 (9%)`, col=MissLevel)) +
  geom_point(size = 2.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-5-5.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC2 (11.9%)`, y=`PC3 (9%)`, col=MissLevel)) +
  geom_point(size = 2.5) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-5-6.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Do cluster correction using limma</strong></p>
<pre class="r"><code># Include cluster information (probably indicating sample quality) into SE object
lipTissueFiltVsnTab &lt;- dplyr::mutate(lipTissueFiltVsnTab,
                                     Cluster = case_when(!Sample %in% bqSmps ~ &#39;1&#39;,
                                                         Sample %in% bqSmps ~ &#39;2&#39;))
lipTissueFiltVsn &lt;- df2SummExp(lipTissueFiltVsnTab, row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;,
                               values = &#39;Value&#39;, row_anno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                               col_anno = c(smpAnno, &#39;TumorPurity&#39;, &#39;MissLevel&#39;, &#39;Cluster&#39;))
assay(lipTissueFiltVsn) &lt;- as.matrix(assay(lipTissueFiltVsn))

# Save preprocessed data
# saveRDS(lipTissueFiltVsn, &#39;./data/Discovery/AG_Hopf/lipTissueVsn_WBC25.rds&#39;)

# Perform cluster correction to see if two unwanted cluster can be merged
# Convert SE object into wide data
datMat &lt;- assay(lipTissueFiltVsn)
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab &lt;- tibble::as_tibble(colData(lipTissueFiltVsn), rownames = &#39;Sample&#39;)
design &lt;- model.matrix(~ smpAnnoTab$Recurrence + smpAnnoTab$Condition)
# Do correction
datMat_C &lt;- limma::removeBatchEffect(datMat, batch = smpAnnoTab$Cluster, design = design)
lipTissueFiltVsn_C &lt;- lipTissueFiltVsn
assay(lipTissueFiltVsn_C) &lt;- datMat_C

# Do single-omics analysis
pcaRes_C &lt;- doSOA(lipTissueFiltVsn_C, meta_var = c(&#39;Condition&#39;, &#39;MissLevel&#39;, &#39;Cluster&#39;),
                  pca_method = &#39;ppca&#39;, num_PCs = 20, do_onlyPCA = T)
pcaRes_C$pcSigAssoRes

# Visualize PCs
pcTab &lt;- pcaRes_C$pcTab %&gt;%
  dplyr::mutate(Label = case_when(Sample %in% bqSmps ~ Sample))

ggplot(pcTab, aes(x=`PC1 (31.1%)`, y=`PC3 (8.4%)`, col=Condition)) +
  geom_point(size = 2.5) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  th

ggplot(pcTab, aes(x=`PC1 (31.1%)`, y=`PC3 (8.4%)`, col=MissLevel)) +
  geom_point(size = 2.5) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th

# Save preprocessed data
saveRDS(lipTissueFiltVsn_C, &#39;./data/Discovery/AG_Hopf/lipTissueVsn_WBC25_C.rds&#39;)</code></pre>
<p><strong>Identify latent factors that explain unknown variance using
sva</strong></p>
<pre class="r"><code># Do SVA to identify latent factors that explain unknown variance
# Prepare data matrix and sample metadata table for creating model matrices
datMat &lt;- assay(lipTissueFiltVsn)
# Keep only complete features
keptFeats &lt;- apply(datMat, 1, function(featVec) {
  !any(is.na(featVec))
})
datMat &lt;- datMat[keptFeats,]
metadatTab &lt;- colData(lipTissueFiltVsn) %&gt;%
  tibble::as_tibble(rownames = &#39;Sample&#39;)
# Create full model matrix including both adjustment variables and variables of interest
modelMat &lt;- model.matrix(~ Recurrence, data = metadatTab)
# Create null model matrix including only adjustment variables
modelMat0 &lt;- model.matrix(~ 1, data = metadatTab)

# Perform SVA
# Identify number of latent factors that need to be estimated
numSV = sva::num.sv(datMat, modelMat, method = &#39;leek&#39;)
svObj = sva(datMat, modelMat, modelMat0, n.sv = numSV)</code></pre>
<pre><code>Number of significant surrogate variables is:  1 
Iteration (out of 5 ):1  2  3  4  5  </code></pre>
<pre class="r"><code># Prepare surrogate variable table
svTab &lt;- svObj$sv
rownames(svTab) &lt;- metadatTab$Sample
colnames(svTab) &lt;- paste0(&#39;SV&#39;, seq_len(ncol(svTab)))
svTab &lt;- tibble::as_tibble(svTab, rownames = &#39;Sample&#39;)

# Do association tests between SVs and patient metadata
# Prepare patient metadata table
metaTab &lt;- dplyr::select(metadatTab, Sample, Condition, Recurrence, Gender, Age,
                         Smoking, Stage, Adjuvant, TumorPurity, MissLevel)
# Do association tests
testAsso(svTab, metaTab, cmn_col = &#39;Sample&#39;) %&gt;%
  dplyr::filter(pVal &lt;= 0.05)</code></pre>
<pre><code>  Var1        Var2         pVal      pValAdj        Stat        Test
1  SV1   Condition 9.708501e-17 8.737651e-16 -10.3890562      T-test
2  SV1 TumorPurity 1.019562e-14 4.588030e-14   0.7848514 Correlation
3  SV1   MissLevel 9.599253e-03 2.879776e-02  -0.2778247 Correlation</code></pre>
<pre class="r"><code># Visualize significant SVs
vizTab &lt;- dplyr::left_join(svTab, metaTab, by = &#39;Sample&#39;)
# =&gt; High correlation between SV and TumorPurity just due to many 100% tumor samples
# and all 0% normal samples

ggplot(vizTab, aes(x=Condition, y=SV1, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-7-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(vizTab, aes(x=SV1, y=MissLevel, col=MissLevel)) +
  geom_point(size = 2.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-7-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Do differential analysis
# Include surrogate variables into model matrices
# modelMat &lt;- cbind(modelMat, svObj$sv)
# modelMat0 &lt;- cbind(modelMat0, svObj$sv)
# tRes &lt;- sva::f.pvalue(datMat, modelMat, modelMat0)
# tResAdj &lt;- p.adjust(tRes, method = &#39;BH&#39;)

# Include surrogate variables into SE object
# lipTissueFiltVsnTab &lt;- dplyr::left_join(lipTissueFiltVsnTab, svTab, by = &#39;Sample&#39;)
# lipTissueFiltVsn &lt;- df2SummExp(lipTissueFiltVsnTab, row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;,
#                                values = &#39;Value&#39;, row_anno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
#                                col_anno = c(smpAnno, &#39;TumorPurity&#39;,
#                                             paste0(&#39;SV&#39;, seq_len(ncol(svTab)-1))))
# assay(lipTissueFiltVsn) &lt;- as.matrix(assay(lipTissueFiltVsn))

# Save preprocessed data
# saveRDS(lipTissueFiltVsn, &#39;./data/Discovery/AG_Hopf/lipTissueVsn_WBC25.rds&#39;)</code></pre>
<p>=&gt; SVA will be conducted individually for Normal and Tumor dataset
later, because<br />
(1) including Condition (Tumor and Normal samples) into variables of
interest results in no SV identified, and without including Condition,
SVA tends to identify SV (r=0.99 with PC1 computed by ordinary PCA) that
is highly associated with Condition, which is not unwanted variation,
and<br />
(2) identified SVs could be more specific to sub-datasets, i.e, Normal
and Tumor datasets that will be analyzed separately.</p>
<p><strong>Investigate impacts of sample missing levels on observed
features</strong><br />
Display relationship between sample missing levels and median
expressions computed by fully observed features</p>
<pre class="r"><code># Normalize unfiltered data
lipTissueTab &lt;- lipTissueWBC25
lipTissueUnfiltVsn &lt;- doPreprocessing(lipTissueTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;TumorPurity&#39;), do_featFilt = F)$vsn.data
# Prepare long data for computing sample missing levels and median expressions
lipTissueUnfiltVsnTab &lt;- summExp2df(lipTissueUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;) %&gt;%
  # Prepare information of sample missing levels
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(OriMissLevel = sum(is.na(Value)) / length(Value)) %&gt;%
  dplyr::ungroup() %&gt;%
  # Prepare information of sample median expressions computed by fully observed features
  dplyr::group_by(Feature) %&gt;%
  dplyr::mutate(Keep = dplyr::case_when(!any(is.na(Value)) ~ &#39;Yes&#39;,
                                        any(is.na(Value)) ~ &#39;No&#39;)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(Keep %in% &#39;Yes&#39;) %&gt;%
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(MedianVsnAbun = median(Value)) %&gt;%
  dplyr::ungroup()
# Create SE object containing information of sample missing levels and median expressions
colAnno &lt;- dplyr::select(lipTissueUnfiltVsnTab, Sample, OriMissLevel, MedianVsnAbun) %&gt;%
  dplyr::filter(!duplicated(Sample)) %&gt;%
  tibble::column_to_rownames(&#39;Sample&#39;)
lipTissueUnfiltVsn &lt;- SummarizedExperiment(assays = list(Abundance = assay(lipTissueUnfiltVsn)),
                                           colData = colAnno)

# Visualize relationship between sample missing levels and median expressions
ggplot(lipTissueUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(x = &#39;Missing level&#39;, y = &#39;Median expression&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-8-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show significant associations between data and sample missing
levels</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipTissueUnfiltVsn, meta_var = &#39;OriMissLevel&#39;, pca_method = &#39;pca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample missing levels
pcaRes$pcSigAssoRes %&gt;%
  dplyr::filter(grepl(&#39;PC[1-9] \\(&#39;, Var1))</code></pre>
<pre><code>         Var1         Var2     pVal  pValAdj   Stat        Test
1 PC2 (11.9%) OriMissLevel 1.04e-05 0.000899  0.456 Correlation
2  PC8 (2.6%) OriMissLevel 4.34e-04 0.018700 -0.371 Correlation
3  PC5 (4.8%) OriMissLevel 3.57e-02 0.614000  0.227 Correlation</code></pre>
<pre class="r"><code># Visualize relationship between PCs and sample missing levels
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC2 (11.9%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(y = &#39;Missing level&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-9-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>lipTissueWBC25 &lt;- lipTissueFiltVsn
WBC25 &lt;- c(WBC25, `Filt feat num` = nrow(lipTissueWBC25))</code></pre>
</div>
<div id="wbc-no" class="section level2">
<h2>WBC-No</h2>
<pre class="r"><code># Load data
lipTissueNoWBC &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Feature table_Discoverycohort_tissue_lipids_20240320.xlsx&#39;,
                                     sheet = &#39;no within-batch correction&#39;)
# Assign column names
colnames(lipTissueNoWBC) &lt;- lipTissueNoWBC[4,]
lipTissueNoWBC &lt;- lipTissueNoWBC[-seq_len(4),]
# Store red flag features (intensity blank / sample &gt;= 3)
redFlagFeats &lt;- lipTissueNoWBC$Flags
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipTissueNoWBC &lt;- dplyr::select(lipTissueNoWBC, -c(`M meas,`, Ions, `MS/MS`, Boxplot)) %&gt;%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %&gt;%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, &#39;/&#39;, CCS, &#39;/&#39;, MZ),
                Flags = redFlagFeats) %&gt;%
  dplyr::filter(RT &gt;= 0.3, RT &lt;= 9) %&gt;%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab &lt;- lipTissueNoWBC
if (!any(duplicated(tidyTab$Feature))) {
  summFilt &lt;- c(`Ori feat num` = nrow(tidyTab), `m/z &lt; 300` = sum(tidyTab$MZ &lt; 300),
                `QC RSD% &gt; 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD &lt; 25, na.rm = T),
                `Red flag feats` = sum(grepl(&#39;RED&#39;, tidyTab$Flags)),
                `QC RSD% &gt; 25` = sum(tidyTab$QC_RSD &gt; 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat(&#39;There are duplicated features!&#39;)
}
NoWBC &lt;- summFilt
rm(tidyTab, summFilt)
####

lipTissueNoWBC &lt;- dplyr::filter(lipTissueNoWBC, MZ &gt;= 300, QC_RSD &lt;= 25, !grepl(&#39;RED&#39;, Flags)) %&gt;%
  dplyr::select(-c(QC_RSD, contains(&#39;Pooled QC Tissue&#39;), contains(&#39;Processed blank&#39;), Flags))

# Convert data into long data and combine it with summarized metadata
lipTissueNoWBC &lt;- tidyr::pivot_longer(lipTissueNoWBC, cols = -c(&#39;Feature&#39;, &#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      names_to = &#39;Aliquot&#39;, values_to = &#39;Abundance&#39;) %&gt;%
  dplyr::mutate(Aliquot = stringr::str_remove(Aliquot, &#39;_pos.+&#39;),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% &#39;SC_DIS_A_PDIR55_TU3&#39; ~ &#39;SC_DIS_A_PDIR55_TU2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_1QFJ7P_TU3&#39; ~ &#39;SC_DIS_A_1QFJ7P_TU1&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_8ZSMVV_NG1&#39; ~ &#39;SC_DIS_A_8ZSMVV_NG3&#39;,
                                    !Aliquot %in% c(&#39;SC_DIS_A_PDIR55_TU3&#39;,
                                                    &#39;SC_DIS_A_1QFJ7P_TU3&#39;,
                                                    &#39;SC_DIS_A_8ZSMVV_NG1&#39;) ~ Aliquot)) %&gt;%
  dplyr::left_join(summMetadat4Discovery, by = &#39;Aliquot&#39;) %&gt;%
  dplyr::select(-Aliquot)

# Keep only samples with good quality (decent tumor purity)
proTissue &lt;- readRDS(&#39;./data/Discovery/AG_Krijgsveld/proTissueVsn.rds&#39;)
lipTissueNoWBC &lt;- lipTissueNoWBC[lipTissueNoWBC$Patient %in% unique(colData(proTissue)$Patient),]</code></pre>
<p><font size='2'> <strong>Vsn normalized data BEFORE filtered by
missingness</strong> for checking associations between data and sample
median expressions and missing levels </font></p>
<pre class="r"><code># Normalize unfiltered data
lipTissueTab &lt;- lipTissueNoWBC
lipTissueUnfiltVsn &lt;- doPreprocessing(lipTissueTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;TumorPurity&#39;), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipTissueUnfiltVsnTab &lt;- summExp2df(lipTissueUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipTissueUnfiltVsn)[2], &#39;samples and&#39;, dim(lipTissueUnfiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 86 samples and 2736 features</code></pre>
<pre class="r"><code># Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Unfiltered data&#39;) +
  th4MissViz + theme(axis.text.x = element_text(size = 9))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-12-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipTissueUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 9))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-12-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipTissueUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-12-3.png" width="960" style="display: block; margin: auto;" /></p>
<p><font size='2'> <strong>Vsn normalized data AFTER filtered by
missingness</strong> </font><br />
Features quantified in less than 2/3 of samples are removed.</p>
<pre class="r"><code># Filter and normalize data
lipTissueTab &lt;- lipTissueNoWBC
lipTissue &lt;- doPreprocessing(lipTissueTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                             val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                             smpAnno = c(smpAnno, &#39;TumorPurity&#39;), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
lipTissueFilt &lt;- lipTissue$filt.data
lipTissueFiltVsn &lt;- lipTissue$vsn.data
# Prepare long data for plotting
lipTissueFiltVsnTab &lt;- summExp2df(lipTissueFiltVsn, assay = &#39;Abundance&#39;,
                                  row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipTissueFiltVsn)[2], &#39;samples and&#39;, dim(lipTissueFiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 86 samples and 2234 features</code></pre>
<pre class="r"><code># Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueFilt)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Filtered data&#39;) +
  th4MissViz + theme(axis.text.x = element_text(size = 9))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-13-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipTissueFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Filtered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 9))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-13-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipTissueFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-13-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Save preprocessed data
saveRDS(lipTissueFiltVsn, &#39;./data/Discovery/AG_Hopf/lipTissueVsn_NoWBC.rds&#39;)</code></pre>
<p><strong>Do biological quality control</strong><br />
</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipTissueFiltVsn, meta_var = c(&#39;Condition&#39;, &#39;Recurrence&#39;, &#39;Gender&#39;,
                                               &#39;Age&#39;, &#39;Smoking&#39;, &#39;Stage&#39;, &#39;Adjuvant&#39;),
                pca_method = &#39;ppca&#39;, num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes</code></pre>
<pre><code>          Var1       Var2     pVal  pValAdj   Stat        Test
1    PC1 (42%)  Condition 4.82e-09 6.75e-07  6.530      T-test
2    PC2 (13%)  Condition 1.30e-08 9.11e-07  6.300      T-test
3   PC5 (3.9%)    Smoking 5.25e-05 2.45e-03 11.100       ANOVA
4   PC8 (2.4%)    Smoking 2.13e-04 7.47e-03  9.380       ANOVA
5    PC2 (13%)      Stage 8.66e-04 2.42e-02  7.690       ANOVA
6  PC10 (1.7%) Recurrence 1.32e-03 2.68e-02  3.320      T-test
7  PC11 (1.7%)     Gender 1.34e-03 2.68e-02 -3.320      T-test
8    PC2 (13%)     Gender 1.12e-02 1.96e-01 -2.590      T-test
9  PC10 (1.7%)   Adjuvant 1.46e-02 2.27e-01  2.490      T-test
10 PC12 (1.5%)      Stage 1.75e-02 2.45e-01  4.250       ANOVA
11    PC4 (6%)   Adjuvant 2.28e-02 2.64e-01  2.320      T-test
12 PC11 (1.7%)      Stage 2.40e-02 2.64e-01  3.900       ANOVA
13 PC13 (1.4%)      Stage 2.45e-02 2.64e-01  3.880       ANOVA
14 PC19 (0.9%)    Smoking 2.67e-02 2.67e-01  3.790       ANOVA
15  PC8 (2.4%)        Age 2.93e-02 2.73e-01 -0.235 Correlation
16    PC4 (6%)  Condition 3.57e-02 3.13e-01 -2.130      T-test
17  PC5 (3.9%)        Age 4.32e-02 3.56e-01  0.219 Correlation
18  PC7 (2.8%)     Gender 4.82e-02 3.75e-01  2.000      T-test</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab %&gt;%
  dplyr::mutate(Label = case_when(Sample %in% c(&#39;1NL5BV_TU&#39;, &#39;1NL5BV_NG&#39;,
                                                &#39;I0HVOL_TU&#39;, &#39;I0HVOL_NG&#39;,
                                                &#39;7EAOX7_TU&#39;, &#39;7EAOX7_NG&#39;) ~ Sample))
ggplot(pcTab, aes(x=Condition, y=`PC1 (42%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-14-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC1 (42%)`, y=`PC2 (13%)`, col=Condition, label=Label)) +
  geom_point(size = 2.5) +
  geom_text_repel(size = 4) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-14-2.png" width="960" style="display: block; margin: auto;" />
=&gt; Tumor purity: I0HVOL_TU - 87% / 7EAOX7_TU - 70% / 1NL5BV_TU -
53%<br />
(Mean of sample tumor cell contents is 74%, ranging from 40% to
100%.)</p>
<pre class="r"><code># Prepare information of sample missing levels
missInfo &lt;- dplyr::group_by(lipTissueFiltVsnTab, Sample) %&gt;%
  dplyr::summarise(MissLevel = sum(is.na(Value)) / length(Value)) %&gt;%
  dplyr::filter(!duplicated(Sample))
# Show significant associations between PCs and sample missing levels
pcTab &lt;- tibble::as_tibble(pcaRes$pcaRes@scores, rownames = &#39;Sample&#39;)
testAssociation(pcTab, missInfo, cmn_col = &#39;Sample&#39;) %&gt;%
  dplyr::filter(pVal &lt;= 0.05)</code></pre>
<pre><code>  Var1      Var2     pVal  pValAdj   Stat        Test
1  PC1 MissLevel 4.17e-06 6.93e-05 -0.473 Correlation
2  PC2 MissLevel 6.93e-06 6.93e-05  0.464 Correlation
3  PC4 MissLevel 2.69e-04 1.79e-03  0.383 Correlation
4  PC9 MissLevel 1.11e-02 5.57e-02 -0.272 Correlation
5 PC18 MissLevel 2.11e-02 8.43e-02  0.248 Correlation</code></pre>
<pre class="r"><code>pcTab &lt;- pcaRes$pcTab %&gt;%
  dplyr::mutate(Label = case_when(Sample %in% c(&#39;1NL5BV_TU&#39;, &#39;1NL5BV_NG&#39;,
                                                &#39;I0HVOL_TU&#39;, &#39;I0HVOL_NG&#39;,
                                                &#39;1VVXHY_TU&#39;, &#39;1VVXHY_NG&#39;,
                                                &#39;CMVZEW_TU&#39;, &#39;CMVZEW_NG&#39;,
                                                &#39;1XUOU0_TU&#39;, &#39;1XUOU0_NG&#39;,
                                                &#39;1XGTDZ_TU&#39;, &#39;1XGTDZ_NG&#39;,
                                                &#39;11BMIX_TU&#39;, &#39;11BMIX_NG&#39;,
                                                &#39;1IHGAC_TU&#39;, &#39;1IHGAC_NG&#39;,
                                                &#39;1H3IW7_TU&#39;, &#39;1H3IW7_NG&#39;,
                                                &#39;Q7B5U6_TU&#39;, &#39;Q7B5U6_NG&#39;,
                                                &#39;NVJH6R_TU&#39;, &#39;NVJH6R_NG&#39;,
                                                &#39;Q89YQK_TU&#39;, &#39;Q89YQK_NG&#39;,
                                                &#39;MJMTYR_TU&#39;, &#39;MJMTYR_NG&#39;) ~ Sample)) %&gt;%
  dplyr::left_join(missInfo, by = &#39;Sample&#39;)

ggplot(pcTab, aes(x=`PC1 (42%)`, y=`PC2 (13%)`, col=MissLevel)) +
  geom_point(size = 2.5) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-15-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC1 (42%)`, y=`PC2 (13%)`, col=Gender, label=Label)) +
  geom_point(size = 2.5) +
  geom_text_repel(size = 4, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-15-2.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Investigate impacts of sample missing levels on observed
features</strong><br />
Display relationship between sample missing levels and median
expressions computed by fully observed features</p>
<pre class="r"><code># Normalize unfiltered data
lipTissueTab &lt;- lipTissueNoWBC
lipTissueUnfiltVsn &lt;- doPreprocessing(lipTissueTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;TumorPurity&#39;), do_featFilt = F)$vsn.data
# Prepare long data for computing sample missing levels and median expressions
lipTissueUnfiltVsnTab &lt;- summExp2df(lipTissueUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;) %&gt;%
  # Prepare information of sample missing levels
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(OriMissLevel = sum(is.na(Value)) / length(Value)) %&gt;%
  dplyr::ungroup() %&gt;%
  # Prepare information of sample median expressions computed by fully observed features
  dplyr::group_by(Feature) %&gt;%
  dplyr::mutate(Keep = dplyr::case_when(!any(is.na(Value)) ~ &#39;Yes&#39;,
                                        any(is.na(Value)) ~ &#39;No&#39;)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(Keep %in% &#39;Yes&#39;) %&gt;%
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(MedianVsnAbun = median(Value)) %&gt;%
  dplyr::ungroup()
# Create SE object containing information of sample missing levels and median expressions
colAnno &lt;- dplyr::select(lipTissueUnfiltVsnTab, Sample, OriMissLevel, MedianVsnAbun) %&gt;%
  dplyr::filter(!duplicated(Sample)) %&gt;%
  tibble::column_to_rownames(&#39;Sample&#39;)
lipTissueUnfiltVsn &lt;- SummarizedExperiment(assays = list(Abundance = assay(lipTissueUnfiltVsn)),
                                           colData = colAnno)

# Visualize relationship between sample missing levels and median expressions
ggplot(lipTissueUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(x = &#39;Missing level&#39;, y = &#39;Median expression&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-16-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show significant associations between data and sample missing
levels</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipTissueUnfiltVsn, meta_var = &#39;OriMissLevel&#39;, pca_method = &#39;pca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample missing levels
pcaRes$pcSigAssoRes %&gt;%
  dplyr::filter(grepl(&#39;PC[1-9] \\(&#39;, Var1))</code></pre>
<pre><code>         Var1         Var2     pVal  pValAdj  Stat        Test
1 PC2 (12.5%) OriMissLevel 8.80e-06 0.000757 0.459 Correlation
2  PC8 (2.7%) OriMissLevel 4.77e-03 0.137000 0.302 Correlation
3  PC4 (5.6%) OriMissLevel 3.50e-02 0.602000 0.228 Correlation</code></pre>
<pre class="r"><code># Visualize relationship between PCs and sample missing levels
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC2 (12.5%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(y = &#39;Missing level&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-17-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>lipTissueNoWBC &lt;- lipTissueFiltVsn
NoWBC &lt;- c(NoWBC, `Filt feat num` = nrow(lipTissueNoWBC))</code></pre>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>Visualize filtering<br />
<strong>Original vs Filtered feature space (by m/z, QC RSD%, and blank
relevant feature removal)</strong><br />
(Note that features with RT &lt; 0.3 and &gt; 9 were removed for
original feature space, which is consistent with Plasma Lipidomics)</p>
<pre class="r"><code># Visualize filtering in different datasets
# Prepare summarized filtering data
summFiltTab &lt;- data.frame(WBC25, NoWBC) %&gt;%
  dplyr::rename(`WBC-25%` = WBC25, `WBC-No` = NoWBC) %&gt;%
  tibble::rownames_to_column(&#39;Filtering&#39;) %&gt;%
  tidyr::pivot_longer(cols = -&#39;Filtering&#39;, names_to = &#39;Dataset&#39;, values_to = &#39;Count&#39;) %&gt;%
  dplyr::mutate(Dataset = factor(Dataset, levels = c(&#39;WBC-25%&#39;, &#39;WBC-No&#39;)))
featSpaceTab &lt;- dplyr::filter(summFiltTab, Filtering %in% c(&#39;Ori feat num&#39;, &#39;Filt feat num&#39;)) %&gt;%
  dplyr::rename(featSpace = Filtering) %&gt;%
  dplyr::mutate(featSpace = case_when(featSpace %in% &#39;Ori feat num&#39; ~ &#39;Original&#39;,
                                      featSpace %in% &#39;Filt feat num&#39; ~ &#39;After filtering&#39;),
                featSpace = factor(featSpace, levels = c(&#39;Original&#39;, &#39;After filtering&#39;)))
summFiltTab &lt;- dplyr::filter(summFiltTab, !Filtering %in% c(&#39;Ori feat num&#39;, &#39;QC RSD% &gt; 25 | NA&#39;, &#39;Filt feat num&#39;))
# Plot feature spaces
ggplot(featSpaceTab, aes(x=Dataset, y=Count)) +
  geom_bar(aes(fill=featSpace), stat = &#39;identity&#39;, position = position_dodge(), alpha = 0.9) +
  scale_fill_grey(name = &#39;Feature space&#39;, start = 0.7, end = 0.3) +
  labs(x = &#39;Dataset (Within-batch correction)&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-19-1.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Numbers of removed features</strong></p>
<pre class="r"><code># Plot numbers of removed features
ggplot(summFiltTab, aes(x=Dataset, y=Count, col=Filtering, group=Filtering)) +
  geom_point(size = 4, show.legend = F) +
  geom_line(linewidth = 2, linetype = &#39;dashed&#39;) +
  scale_color_brewer(name = &#39;Filtering criteria&#39;, palette = &#39;Dark2&#39;) +
  labs(x = &#39;Dataset (Within-batch correction)&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-20-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Display intersection of filtered feature space<br />
(Note that filtering done here includes whatever aforementioned and
missing levels, which means fully preprocessed data)</p>
<pre class="r"><code>ggvenn(list(`WBC-25%` = rownames(lipTissueWBC25), `WBC-No` = rownames(lipTissueNoWBC)),
       fill_color = c(&#39;firebrick1&#39;, &#39;dodgerblue1&#39;), fill_alpha = 0.6,
       set_name_color = c(&#39;firebrick1&#39;, &#39;dodgerblue1&#39;), set_name_size = 10,
       text_size = 8, stroke_size = 1.5)</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-21-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Display correlations of common features</p>
<pre class="r"><code># Compute correlations of common features between two datasets
corrRes &lt;- calcFeatCorr(lipTissueWBC25, lipTissueNoWBC, show_nFeats = F)
ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  labs(y = &#39;Frequency&#39;, title = &#39;WBC-25% vs WBC-No&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-22-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Display association of <strong>tissue type-related</strong> feature
significance between WBC-25% and WBC-No Tissue Lipidomics<br />
<strong>p-values (significance level = 0.05)</strong></p>
<pre class="r"><code># Prepare summarized tables of comparison between two datasets
condiFeatAssoTabs &lt;- summarizeFeatAssoRes(lipTissueWBC25, lipTissueNoWBC,
                                          &#39;WBC-25%&#39;, &#39;WBC-No&#39;, meta_var = &#39;Condition&#39;,
                                          method = &#39;proDA&#39;, alpha = 0.05)
# Plot p-values
ggplot(condiFeatAssoTabs$tbl_pVal, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance)) +
  geom_point(size = 2) +
  geom_abline(intercept = 0, slope = 1, col = &#39;black&#39;, linewidth = 0.8) +
  scale_color_manual(values = c(&#39;red&#39;, &#39;darkgreen&#39;, &#39;navy&#39;, &#39;grey&#39;)) +
  labs(x = &#39;-log10(pVal) of WBC-25%&#39;, y = &#39;-log10(pVal) of WBC-No&#39;, title = &#39;Tumor vs Normal&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-23-1.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>log(FC)</strong></p>
<pre class="r"><code># Plot log(FC)
ggplot(condiFeatAssoTabs$tbl_logFC, aes(x=logFC_dat1, y=logFC_dat2, col=Direction)) +
  geom_point(size = 2) +
  geom_abline(intercept = 0, slope = 1, col = &#39;black&#39;, linewidth = 0.8) +
  scale_color_manual(values = c(&#39;red&#39;, &#39;navy&#39;, &#39;grey&#39;)) +
  labs(x = &#39;log(FC) of WBC-25%&#39;, y = &#39;log(FC) of WBC-No&#39;, title = &#39;Tumor vs Normal&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-24-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Display proportions of <strong>recurrence-related</strong>
significant features</p>
<pre class="r"><code># Display proportions of significant features and data power about recurrence prediction
# Subset data
lipTumorWBC25 &lt;- lipTissueWBC25[, colData(lipTissueWBC25)$Condition %in% &#39;Tumor&#39;]
lipNormalWBC25 &lt;- lipTissueWBC25[, colData(lipTissueWBC25)$Condition %in% &#39;Normal&#39;]
lipTumorNoWBC &lt;- lipTissueNoWBC[, colData(lipTissueNoWBC)$Condition %in% &#39;Tumor&#39;]
lipNormalNoWBC &lt;- lipTissueNoWBC[, colData(lipTissueNoWBC)$Condition %in% &#39;Normal&#39;]
# Do SOA
soaResTumorWBC25 &lt;- doSOA(lipTumorWBC25, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                          num_PCs = 20, use_proDA = T)
soaResNormalWBC25 &lt;- doSOA(lipNormalWBC25, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                           num_PCs = 20, use_proDA = T)
soaResTumorNoWBC &lt;- doSOA(lipTumorNoWBC, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                          num_PCs = 20, use_proDA = T)
soaResNormalNoWBC &lt;- doSOA(lipNormalNoWBC, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                           num_PCs = 20, use_proDA = T)

# Prepare summarized feature significance data
propSigFeatsTumorWBC25 &lt;- nrow(soaResTumorWBC25$featSigAssoRes) / nrow(soaResTumorWBC25$data) * 100
propSigFeatsNormalWBC25 &lt;- nrow(soaResNormalWBC25$featSigAssoRes) / nrow(soaResNormalWBC25$data) * 100
propSigFeatsTumorNoWBC &lt;- nrow(soaResTumorNoWBC$featSigAssoRes) / nrow(soaResTumorNoWBC$data) * 100
propSigFeatsNormalNoWBC &lt;- nrow(soaResNormalNoWBC$featSigAssoRes) / nrow(soaResNormalNoWBC$data) * 100
sigFeatPropTab &lt;- data.frame(Dataset = factor(c(&#39;Tumor, WBC-25%&#39;, &#39;Normal, WBC-25%&#39;,
                                                &#39;Tumor, WBC-No&#39;, &#39;Normal, WBC-No&#39;),
                                              levels = c(&#39;Normal, WBC-No&#39;, &#39;Normal, WBC-25%&#39;,
                                                         &#39;Tumor, WBC-No&#39;, &#39;Tumor, WBC-25%&#39;)),
                             Proportion = c(propSigFeatsTumorWBC25, propSigFeatsNormalWBC25,
                                            propSigFeatsTumorNoWBC, propSigFeatsNormalNoWBC),
                             AbsNum = c(nrow(soaResTumorWBC25$featSigAssoRes),
                                        nrow(soaResNormalWBC25$featSigAssoRes),
                                        nrow(soaResTumorNoWBC$featSigAssoRes),
                                        nrow(soaResNormalNoWBC$featSigAssoRes))) %&gt;%
  dplyr::mutate(WBC = stringr::str_remove_all(Dataset, &#39;^Tumor, |^Normal, &#39;))

ggplot(sigFeatPropTab, aes(x=Dataset, y=Proportion, fill=WBC)) +
  geom_bar(stat = &#39;identity&#39;) +
  coord_flip() +
  scale_fill_grey(start = 0.3, end = 0.5) +
  labs(y = &#39;Percentage (%)&#39;, title = &#39;Recurrence vs Non-recurrence&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-25-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Display absolute counts of <strong>recurrence-related</strong>
significant features</p>
<pre class="r"><code>ggplot(sigFeatPropTab, aes(x=Dataset, y=AbsNum, fill=WBC)) +
  geom_bar(stat = &#39;identity&#39;) +
  coord_flip() +
  scale_fill_grey(start = 0.3, end = 0.5) +
  labs(y = &#39;Count&#39;, title = &#39;Recurrence vs Non-recurrence&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-26-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show <strong>recurrence-related</strong> significant PCs</p>
<pre class="r"><code># Prepare summarized PC significance data
sigPCTabTumorWBC25 &lt;- soaResTumorWBC25$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;Tumor, WBC-25%&#39;)
sigPCTabNormalWBC25 &lt;- soaResNormalWBC25$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;Normal, WBC-25%&#39;)
sigPCTabTumorNoWBC &lt;-soaResTumorNoWBC$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;Tumor, WBC-No&#39;)
sigPCTabNormalNoWBC &lt;-soaResNormalNoWBC$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;Normal, WBC-No&#39;)
dplyr::bind_rows(sigPCTabTumorWBC25, sigPCTabNormalWBC25, sigPCTabTumorNoWBC, sigPCTabNormalNoWBC) %&gt;%
  dplyr::relocate(Dataset)</code></pre>
<pre><code>          Dataset        Var1       Var2   pVal pValAdj  Stat   Test
1 Normal, WBC-25% PC18 (1.2%) Recurrence 0.0137   0.273  2.58 T-test
2   Tumor, WBC-No PC16 (1.6%) Recurrence 0.0285   0.571 -2.27 T-test</code></pre>
</div>
</div>
<div id="plasma-lipidomics" class="section level1">
<h1>Plasma Lipidomics</h1>
<div id="batch1-wbc-25" class="section level2">
<h2>Batch1, WBC-25%</h2>
<pre class="r"><code># Load data
lipPlasmaB1WBC25 &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_20231130.xlsx&#39;,
                                       sheet = &#39;14_Feature Table correction 25&#39;)
# Assign column names
colnames(lipPlasmaB1WBC25) &lt;- lipPlasmaB1WBC25[1,]
lipPlasmaB1WBC25 &lt;- lipPlasmaB1WBC25[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB1WBC25 &lt;- dplyr::select(lipPlasmaB1WBC25, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %&gt;%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %&gt;%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, &#39;/&#39;, CCS, &#39;/&#39;, MZ)) %&gt;%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab &lt;- lipPlasmaB1WBC25
# Collect features captured in water processed blank
waterDat &lt;- dplyr::select(tidyTab, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt &lt;- c(`Ori feat num` = nrow(tidyTab), `m/z &lt; 300` = sum(tidyTab$MZ &lt; 300),
                `QC RSD% &gt; 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD &lt; 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% &gt; 25` = sum(tidyTab$QC_RSD &gt; 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat(&#39;There are duplicated features!&#39;)
}
B1WBC25 &lt;- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB1WBC25 &lt;- dplyr::filter(lipPlasmaB1WBC25, RT &gt;= 0.3, RT &lt;= 9, MZ &gt;= 300, QC_RSD &lt;= 25) %&gt;%
  dplyr::select(-c(QC_RSD, contains(&#39;QC plasma&#39;), contains(&#39;QCplasma&#39;)))

# Remove features captured in water processed blank, which is not of interest
waterDat &lt;- dplyr::select(lipPlasmaB1WBC25, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats &lt;- rownames(waterDat)[rmFeats]
lipPlasmaB1WBC25 &lt;- dplyr::filter(lipPlasmaB1WBC25, !Feature %in% rmFeats) %&gt;%
  dplyr::select(-contains(&#39;water&#39;))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx&#39;)
colnames(smpPlateDat) &lt;- c(&#39;Plate&#39;, &#39;Batch_Sample&#39;)
smpPlateDat &lt;- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == &#39;Batch 3&#39;,
                             !grepl(&#39;^Box|QC plasma|QCplasma|water|ACN_H2O&#39;, Batch_Sample)) %&gt;%
  dplyr::mutate(Plate = stringr::str_remove(Plate, &#39;, Batch.+&#39;),
                Plate = stringr::str_replace_all(Plate, &#39;Box |Box&#39;, &#39;Plate&#39;),
                Plate = case_when(Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate4&#39;,
                                  !Plate %in% &#39;Plate3_4&#39; ~ Plate),
                Plate2 = case_when(Plate %in% &#39;Plate4&#39; ~ Plate,
                                   !Plate %in% &#39;Plate4&#39; ~ &#39;Plate1|2|3&#39;))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB1WBC25 &lt;- tidyr::pivot_longer(lipPlasmaB1WBC25, cols = -c(&#39;Feature&#39;, &#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                        names_to = &#39;Batch_Sample&#39;, values_to = &#39;Abundance&#39;) %&gt;%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, &#39;_Left.+$&#39;),
                Aliquot = stringr::str_remove_all(Batch_Sample, &#39;^Batch\\d_&#39;),
                Batch = stringr::str_extract(Batch_Sample, &#39;^Batch\\d&#39;),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V2_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V3_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V7_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_1TK71I_P_V4_2&#39; ~ &#39;SC_DIS_A_1TK71I_P_V3_2&#39;,
                                    !Aliquot %in% c(&#39;SC_DIS_A_F0X18FJY_P_V2_2&#39;,
                                                    &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39;,
                                                    &#39;SC_DIS_A_1TK71I_P_V4_2&#39;) ~ Aliquot)) %&gt;%
  dplyr::left_join(smpPlateDat, by = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::left_join(summMetadat4Discovery, by = &#39;Aliquot&#39;) %&gt;%
  dplyr::select(-c(Batch_Sample, Aliquot, TumorPurity))</code></pre>
<p><font size='2'> <strong>Vsn normalized data BEFORE filtered by
missingness</strong> for checking associations between data and sample
median expressions and missing levels </font></p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB1WBC25
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Batch&#39;, &#39;Plate&#39;, &#39;Plate2&#39;), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipPlasmaUnfiltVsnTab &lt;- summExp2df(lipPlasmaUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipPlasmaUnfiltVsn)[2], &#39;samples and&#39;, dim(lipPlasmaUnfiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 289 samples and 1195 features</code></pre>
<pre class="r"><code># Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipPlasmaUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = &#39;Samples&#39;, y = &#39;Features&#39;, title = &#39;Missingness of Unfiltered data&#39;) +
  th4MissViz + theme(axis.text.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-29-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipPlasmaUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_blank(),
             axis.ticks.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-29-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipPlasmaUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-29-3.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Take all plasma samples for normalization, and then subset
Baseline samples</strong><br />
<font size='2'> <strong>Vsn normalized data AFTER filtered by
missingness</strong> </font><br />
Features quantified in less than 2/3 of samples are removed.</p>
<pre class="r"><code># Filter and normalize data
lipPlasmaTab &lt;- lipPlasmaB1WBC25
lipPlasma &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                             val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                             smpAnno = c(smpAnno, &#39;Batch&#39;, &#39;Plate&#39;, &#39;Plate2&#39;), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
# Subset Baseline samples
lipPlasmaFilt &lt;- lipPlasma$filt.data
lipPlasmaFiltVsn &lt;- lipPlasma$vsn.data
lipBaseFilt &lt;- lipPlasmaFilt[, colData(lipPlasmaFilt)$TimePoint %in% &#39;Baseline&#39;]
lipBaseFiltVsn &lt;- lipPlasmaFiltVsn[, colData(lipPlasmaFiltVsn)$TimePoint %in% &#39;Baseline&#39;]
# Prepare long data for plotting
lipBaseFiltVsnTab &lt;- summExp2df(lipBaseFiltVsn, assay = &#39;Abundance&#39;,
                                row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseFiltVsn)[2], &#39;samples and&#39;, dim(lipBaseFiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 63 samples and 1115 features</code></pre>
<pre class="r"><code># Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseFilt)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Filtered data&#39;) +
  th4MissViz</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-30-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipBaseFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Filtered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-30-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-30-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Save preprocessed data
saveRDS(lipBaseFiltVsn, &#39;./data/Discovery/AG_Hopf/lipBaseVsn_B1WBC25.rds&#39;)</code></pre>
<p>Show significant associations between PCs and plates where samples
are located. Samples in Plate4 were frozen at -80°C.</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseFiltVsn, meta_var = &#39;Plate2&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1   Var2     pVal  pValAdj  Stat   Test
1 PC1 (20.4%) Plate2 2.74e-07 5.49e-06  5.78 T-test
2  PC6 (6.3%) Plate2 6.26e-04 6.26e-03 -3.61 T-test
3  PC3 (8.2%) Plate2 2.14e-02 1.42e-01 -2.36 T-test
4  PC8 (4.3%) Plate2 3.17e-02 1.51e-01  2.20 T-test
5    PC9 (4%) Plate2 3.78e-02 1.51e-01  2.12 T-test</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate2, y=`PC1 (20.4%)`, col=Plate2, fill=Plate2)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  ggpubr::stat_compare_means(method = &#39;t.test&#39;, paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-31-1.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Investigate impacts of sample missing levels on observed
features</strong><br />
Display relationship between sample missing levels and median
expressions computed by fully observed features</p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB1WBC25
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Batch&#39;, &#39;Plate&#39;, &#39;Plate2&#39;), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipPlasmaUnfiltVsnTab &lt;- summExp2df(lipPlasmaUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;) %&gt;%
  # Prepare information of sample missing levels
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(OriMissLevel = sum(is.na(Value)) / length(Value)) %&gt;%
  dplyr::ungroup() %&gt;%
  # Prepare information of sample median expressions computed by fully observed features
  dplyr::group_by(Feature) %&gt;%
  dplyr::mutate(Keep = dplyr::case_when(!any(is.na(Value)) ~ &#39;Yes&#39;,
                                        any(is.na(Value)) ~ &#39;No&#39;)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(Keep %in% &#39;Yes&#39;) %&gt;%
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(MedianVsnAbun = median(Value)) %&gt;%
  dplyr::ungroup()
# Create SE object containing information of sample missing levels and median expressions
colAnno &lt;- dplyr::select(lipPlasmaUnfiltVsnTab, Sample, OriMissLevel, MedianVsnAbun) %&gt;%
  dplyr::filter(!duplicated(Sample)) %&gt;%
  tibble::column_to_rownames(&#39;Sample&#39;)
lipPlasmaUnfiltVsn &lt;- SummarizedExperiment(assays = list(Abundance = assay(lipPlasmaUnfiltVsn)),
                                           colData = colAnno)

# Visualize relationship between sample missing levels and median expressions
ggplot(lipPlasmaUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(x = &#39;Missing level&#39;, y = &#39;Median expression&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-32-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show significant associations between data and sample missing
levels</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipPlasmaUnfiltVsn, meta_var = &#39;OriMissLevel&#39;, pca_method = &#39;pca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample missing levels
pcaRes$pcSigAssoRes %&gt;%
  dplyr::filter(grepl(&#39;PC[1-9] \\(&#39;, Var1))</code></pre>
<pre><code>         Var1         Var2     pVal  pValAdj   Stat        Test
1 PC1 (15.8%) OriMissLevel 1.65e-37 4.77e-35  0.660 Correlation
2 PC2 (11.3%) OriMissLevel 2.41e-05 2.32e-03  0.246 Correlation
3  PC8 (2.6%) OriMissLevel 7.34e-05 5.30e-03 -0.231 Correlation
4  PC4 (8.5%) OriMissLevel 1.95e-03 1.13e-01 -0.181 Correlation
5  PC7 (3.9%) OriMissLevel 1.22e-02 5.02e-01  0.147 Correlation</code></pre>
<pre class="r"><code># Visualize relationship between PCs and sample missing levels
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC1 (15.8%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(y = &#39;Missing level&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-33-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC1 (15.8%)`, y=`PC2 (11.3%)`, col=OriMissLevel)) +
  geom_point(size = 3.5) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-33-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>lipBaseB1WBC25 &lt;- lipBaseFiltVsn
B1WBC25 &lt;- c(B1WBC25, `Filt feat num` = nrow(lipBaseB1WBC25))</code></pre>
</div>
<div id="batch1-wbc-15" class="section level2">
<h2>Batch1, WBC-15%</h2>
<pre class="r"><code># Load data
lipPlasmaB1WBC15 &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_20231130.xlsx&#39;,
                                       sheet = &#39;10_Feature Table correction 15&#39;)
# Assign column names
colnames(lipPlasmaB1WBC15) &lt;- lipPlasmaB1WBC15[1,]
lipPlasmaB1WBC15 &lt;- lipPlasmaB1WBC15[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB1WBC15 &lt;- dplyr::select(lipPlasmaB1WBC15, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %&gt;%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %&gt;%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, &#39;/&#39;, CCS, &#39;/&#39;, MZ)) %&gt;%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab &lt;- lipPlasmaB1WBC15
# Collect features captured in water processed blank
waterDat &lt;- dplyr::select(tidyTab, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt &lt;- c(`Ori feat num` = nrow(tidyTab), `m/z &lt; 300` = sum(tidyTab$MZ &lt; 300),
                `QC RSD% &gt; 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD &lt; 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% &gt; 25` = sum(tidyTab$QC_RSD &gt; 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat(&#39;There are duplicated features!&#39;)
}
B1WBC15 &lt;- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB1WBC15 &lt;- dplyr::filter(lipPlasmaB1WBC15, RT &gt;= 0.3, RT &lt;= 9, MZ &gt;= 300, QC_RSD &lt;= 25) %&gt;%
  dplyr::select(-c(QC_RSD, contains(&#39;QC plasma&#39;), contains(&#39;QCplasma&#39;)))

# Remove features captured in water processed blank, which is not of interest
waterDat &lt;- dplyr::select(lipPlasmaB1WBC15, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats &lt;- rownames(waterDat)[rmFeats]
lipPlasmaB1WBC15 &lt;- dplyr::filter(lipPlasmaB1WBC15, !Feature %in% rmFeats) %&gt;%
  dplyr::select(-contains(&#39;water&#39;))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx&#39;)
colnames(smpPlateDat) &lt;- c(&#39;Plate&#39;, &#39;Batch_Sample&#39;)
smpPlateDat &lt;- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == &#39;Batch 3&#39;,
                             !grepl(&#39;^Box|QC plasma|QCplasma|water|ACN_H2O&#39;, Batch_Sample)) %&gt;%
  dplyr::mutate(Plate = stringr::str_remove(Plate, &#39;, Batch.+&#39;),
                Plate = stringr::str_replace_all(Plate, &#39;Box |Box&#39;, &#39;Plate&#39;),
                Plate = case_when(Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate4&#39;,
                                  !Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate1|2|3&#39;))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB1WBC15 &lt;- tidyr::pivot_longer(lipPlasmaB1WBC15, cols = -c(&#39;Feature&#39;, &#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                        names_to = &#39;Batch_Sample&#39;, values_to = &#39;Abundance&#39;) %&gt;%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, &#39;_Left.+$&#39;),
                Aliquot = stringr::str_remove_all(Batch_Sample, &#39;^Batch\\d_&#39;),
                Batch = stringr::str_extract(Batch_Sample, &#39;^Batch\\d&#39;),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V2_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V3_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V7_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_1TK71I_P_V4_2&#39; ~ &#39;SC_DIS_A_1TK71I_P_V3_2&#39;,
                                    !Aliquot %in% c(&#39;SC_DIS_A_F0X18FJY_P_V2_2&#39;,
                                                    &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39;,
                                                    &#39;SC_DIS_A_1TK71I_P_V4_2&#39;) ~ Aliquot)) %&gt;%
  dplyr::left_join(smpPlateDat, by = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::left_join(summMetadat4Discovery, by = &#39;Aliquot&#39;) %&gt;%
  dplyr::select(-c(Batch_Sample, Aliquot, TumorPurity))</code></pre>
<p><font size='2'> <strong>Vsn normalized data BEFORE filtered by
missingness</strong> for checking associations between data and sample
median expressions and missing levels </font></p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB1WBC15
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Batch&#39;, &#39;Plate&#39;), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipPlasmaUnfiltVsnTab &lt;- summExp2df(lipPlasmaUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipPlasmaUnfiltVsn)[2], &#39;samples and&#39;, dim(lipPlasmaUnfiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 289 samples and 783 features</code></pre>
<pre class="r"><code># Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipPlasmaUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Unfiltered data&#39;) +
  th4MissViz + theme(axis.text.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-36-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipPlasmaUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_blank(),
             axis.ticks.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-36-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipPlasmaUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-36-3.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Take all plasma samples for normalization, and then subset
Baseline samples</strong><br />
<font size='2'> <strong>Vsn normalized data AFTER filtered by
missingness</strong> </font><br />
Features quantified in less than 2/3 of samples are removed.</p>
<pre class="r"><code># Filter and normalize data
lipPlasmaTab &lt;- lipPlasmaB1WBC15
lipPlasma &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                             val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                             smpAnno = c(smpAnno, &#39;Batch&#39;, &#39;Plate&#39;), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
# Subset Baseline samples
lipPlasmaFilt &lt;- lipPlasma$filt.data
lipPlasmaFiltVsn &lt;- lipPlasma$vsn.data
lipBaseFilt &lt;- lipPlasmaFilt[, colData(lipPlasmaFilt)$TimePoint %in% &#39;Baseline&#39;]
lipBaseFiltVsn &lt;- lipPlasmaFiltVsn[, colData(lipPlasmaFiltVsn)$TimePoint %in% &#39;Baseline&#39;]
# Prepare long data for plotting
lipBaseFiltVsnTab &lt;- summExp2df(lipBaseFiltVsn, assay = &#39;Abundance&#39;,
                                row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseFiltVsn)[2], &#39;samples and&#39;, dim(lipBaseFiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 63 samples and 737 features</code></pre>
<pre class="r"><code># Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseFilt)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Filtered data&#39;) +
  th4MissViz</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-37-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipBaseFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Filtered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-37-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-37-3.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show significant associations between PCs and plates where samples
are located. Samples in Plate4 were frozen at -80°C.</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseFiltVsn, meta_var = &#39;Plate&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1  Var2    pVal pValAdj  Stat   Test
1   PC10 (3%) Plate 0.00012 0.00239  4.11 T-test
2 PC2 (15.8%) Plate 0.00276 0.02420 -3.12 T-test
3  PC4 (7.2%) Plate 0.00363 0.02420  3.03 T-test
4 PC1 (23.9%) Plate 0.00639 0.02850  2.82 T-test
5 PC3 (10.8%) Plate 0.00714 0.02850  2.78 T-test</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC10 (3%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  ggpubr::stat_compare_means(method = &#39;t.test&#39;, paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-38-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=Plate, y=`PC1 (23.9%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  ggpubr::stat_compare_means(method = &#39;t.test&#39;, paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-38-2.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Investigate impacts of sample missing levels on observed
features</strong><br />
Display relationship between sample missing levels and median
expressions computed by fully observed features</p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB1WBC15
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Batch&#39;, &#39;Plate&#39;), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipPlasmaUnfiltVsnTab &lt;- summExp2df(lipPlasmaUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;) %&gt;%
  # Prepare information of sample missing levels
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(OriMissLevel = sum(is.na(Value)) / length(Value)) %&gt;%
  dplyr::ungroup() %&gt;%
  # Prepare information of sample median expressions computed by fully observed features
  dplyr::group_by(Feature) %&gt;%
  dplyr::mutate(Keep = dplyr::case_when(!any(is.na(Value)) ~ &#39;Yes&#39;,
                                        any(is.na(Value)) ~ &#39;No&#39;)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(Keep %in% &#39;Yes&#39;) %&gt;%
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(MedianVsnAbun = median(Value)) %&gt;%
  dplyr::ungroup()
# Create SE object containing information of sample missing levels and median expressions
colAnno &lt;- dplyr::select(lipPlasmaUnfiltVsnTab, Sample, OriMissLevel, MedianVsnAbun) %&gt;%
  dplyr::filter(!duplicated(Sample)) %&gt;%
  tibble::column_to_rownames(&#39;Sample&#39;)
lipPlasmaUnfiltVsn &lt;- SummarizedExperiment(assays = list(Abundance = assay(lipPlasmaUnfiltVsn)),
                                           colData = colAnno)

# Visualize relationship between sample missing levels and median expressions
ggplot(lipPlasmaUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(x = &#39;Missing level&#39;, y = &#39;Median expression&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-39-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show significant associations between data and sample missing
levels</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipPlasmaUnfiltVsn, meta_var = &#39;OriMissLevel&#39;, pca_method = &#39;pca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample missing levels
pcaRes$pcSigAssoRes %&gt;%
  dplyr::filter(grepl(&#39;PC[1-9] \\(&#39;, Var1))</code></pre>
<pre><code>         Var1         Var2     pVal  pValAdj   Stat        Test
1 PC1 (17.1%) OriMissLevel 4.32e-40 1.25e-37  0.677 Correlation
2 PC3 (10.1%) OriMissLevel 1.20e-03 1.16e-01 -0.190 Correlation
3  PC8 (2.7%) OriMissLevel 2.97e-03 2.14e-01  0.174 Correlation
4  PC7 (3.9%) OriMissLevel 1.31e-02 6.28e-01  0.146 Correlation
5 PC2 (11.2%) OriMissLevel 1.52e-02 6.28e-01  0.143 Correlation
6  PC5 (5.6%) OriMissLevel 3.60e-02 8.97e-01 -0.123 Correlation
7  PC4 (7.8%) OriMissLevel 4.27e-02 9.50e-01 -0.119 Correlation</code></pre>
<pre class="r"><code># Visualize relationship between PCs and sample missing levels
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC1 (17.1%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(y = &#39;Missing level&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-40-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC1 (17.1%)`, y=`PC2 (11.2%)`, col=OriMissLevel)) +
  geom_point(size = 3.5) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-40-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>lipBaseB1WBC15 &lt;- lipBaseFiltVsn
B1WBC15 &lt;- c(B1WBC15, `Filt feat num` = nrow(lipBaseB1WBC15))</code></pre>
</div>
<div id="batch1-wbc-no" class="section level2">
<h2>Batch1, WBC-No</h2>
<pre class="r"><code># Load data
lipPlasmaB1NoWBC &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_20231130.xlsx&#39;,
                                       sheet = &#39;12_Feature Table no correction&#39;)
# Assign column names
colnames(lipPlasmaB1NoWBC) &lt;- lipPlasmaB1NoWBC[1,]
lipPlasmaB1NoWBC &lt;- lipPlasmaB1NoWBC[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB1NoWBC &lt;- dplyr::select(lipPlasmaB1NoWBC, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %&gt;%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %&gt;%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, &#39;/&#39;, CCS, &#39;/&#39;, MZ)) %&gt;%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab &lt;- lipPlasmaB1NoWBC
# Collect features captured in water processed blank
waterDat &lt;- dplyr::select(tidyTab, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt &lt;- c(`Ori feat num` = nrow(tidyTab), `m/z &lt; 300` = sum(tidyTab$MZ &lt; 300),
                `QC RSD% &gt; 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD &lt; 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% &gt; 25` = sum(tidyTab$QC_RSD &gt; 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat(&#39;There are duplicated features!&#39;)
}
B1NoWBC &lt;- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB1NoWBC &lt;- dplyr::filter(lipPlasmaB1NoWBC, RT &gt;= 0.3, RT &lt;= 9, MZ &gt;= 300, QC_RSD &lt;= 25) %&gt;%
  dplyr::select(-c(QC_RSD, contains(&#39;QC plasma&#39;), contains(&#39;QCplasma&#39;)))

# Remove features captured in water processed blank, which is not of interest
waterDat &lt;- dplyr::select(lipPlasmaB1NoWBC, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats &lt;- rownames(waterDat)[rmFeats]
lipPlasmaB1NoWBC &lt;- dplyr::filter(lipPlasmaB1NoWBC, !Feature %in% rmFeats) %&gt;%
  dplyr::select(-contains(&#39;water&#39;))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx&#39;)
colnames(smpPlateDat) &lt;- c(&#39;Plate&#39;, &#39;Batch_Sample&#39;)
smpPlateDat &lt;- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == &#39;Batch 3&#39;,
                             !grepl(&#39;^Box|QC plasma|QCplasma|water|ACN_H2O&#39;, Batch_Sample)) %&gt;%
  dplyr::mutate(Plate = stringr::str_remove(Plate, &#39;, Batch.+&#39;),
                Plate = stringr::str_replace_all(Plate, &#39;Box |Box&#39;, &#39;Plate&#39;),
                Plate = case_when(Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate4&#39;,
                                  !Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate1|2|3&#39;))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB1NoWBC &lt;- tidyr::pivot_longer(lipPlasmaB1NoWBC, cols = -c(&#39;Feature&#39;, &#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                        names_to = &#39;Batch_Sample&#39;, values_to = &#39;Abundance&#39;) %&gt;%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, &#39;_Left.+$&#39;),
                Aliquot = stringr::str_remove_all(Batch_Sample, &#39;^Batch\\d_&#39;),
                Batch = stringr::str_extract(Batch_Sample, &#39;^Batch\\d&#39;),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V2_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V3_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V7_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_1TK71I_P_V4_2&#39; ~ &#39;SC_DIS_A_1TK71I_P_V3_2&#39;,
                                    !Aliquot %in% c(&#39;SC_DIS_A_F0X18FJY_P_V2_2&#39;,
                                                    &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39;,
                                                    &#39;SC_DIS_A_1TK71I_P_V4_2&#39;) ~ Aliquot)) %&gt;%
  dplyr::left_join(smpPlateDat, by = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::left_join(summMetadat4Discovery, by = &#39;Aliquot&#39;) %&gt;%
  dplyr::select(-c(Batch_Sample, Aliquot, TumorPurity))</code></pre>
<p><font size='2'> <strong>Vsn normalized data BEFORE filtered by
missingness</strong> for checking associations between data and sample
median expressions and missing levels </font></p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB1NoWBC
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Batch&#39;, &#39;Plate&#39;), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipPlasmaUnfiltVsnTab &lt;- summExp2df(lipPlasmaUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipPlasmaUnfiltVsn)[2], &#39;samples and&#39;, dim(lipPlasmaUnfiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 289 samples and 1037 features</code></pre>
<pre class="r"><code># Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipPlasmaUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Unfiltered data&#39;) +
  th4MissViz + theme(axis.text.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-43-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipPlasmaUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_blank(),
             axis.ticks.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-43-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipPlasmaUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-43-3.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Take all plasma samples for normalization, and then subset
Baseline samples</strong><br />
<font size='2'> <strong>Vsn normalized data AFTER filtered by
missingness</strong> </font><br />
Features quantified in less than 2/3 of samples are removed.</p>
<pre class="r"><code># Filter and normalize data
lipPlasmaTab &lt;- lipPlasmaB1NoWBC
lipPlasma &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                             val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                             smpAnno = c(smpAnno, &#39;Batch&#39;, &#39;Plate&#39;), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
# Subset Baseline samples
lipPlasmaFilt &lt;- lipPlasma$filt.data
lipPlasmaFiltVsn &lt;- lipPlasma$vsn.data
lipBaseFilt &lt;- lipPlasmaFilt[, colData(lipPlasmaFilt)$TimePoint %in% &#39;Baseline&#39;]
lipBaseFiltVsn &lt;- lipPlasmaFiltVsn[, colData(lipPlasmaFiltVsn)$TimePoint %in% &#39;Baseline&#39;]
# Prepare long data for plotting
lipBaseFiltVsnTab &lt;- summExp2df(lipBaseFiltVsn, assay = &#39;Abundance&#39;,
                                row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseFiltVsn)[2], &#39;samples and&#39;, dim(lipBaseFiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 63 samples and 969 features</code></pre>
<pre class="r"><code># Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseFilt)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Filtered data&#39;) +
  th4MissViz</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-44-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipBaseFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Filtered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-44-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-44-3.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show significant associations between PCs and plates where samples
are located. Samples in Plate4 were frozen at -80°C.</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseFiltVsn, meta_var = &#39;Plate&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1  Var2     pVal  pValAdj  Stat   Test
1 PC1 (24.2%) Plate 2.35e-11 4.69e-10  8.16 T-test
2  PC5 (5.4%) Plate 1.82e-03 1.82e-02 -3.26 T-test
3 PC2 (20.5%) Plate 1.16e-02 7.77e-02  2.60 T-test</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC1 (24.2%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  ggpubr::stat_compare_means(method = &#39;t.test&#39;, paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-45-1.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Investigate impacts of sample missing levels on observed
features</strong><br />
Display relationship between sample missing levels and median
expressions computed by fully observed features</p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB1NoWBC
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Batch&#39;, &#39;Plate&#39;), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipPlasmaUnfiltVsnTab &lt;- summExp2df(lipPlasmaUnfiltVsn, assay = &#39;Abundance&#39;,
                                    row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;) %&gt;%
  # Prepare information of sample missing levels
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(OriMissLevel = sum(is.na(Value)) / length(Value)) %&gt;%
  dplyr::ungroup() %&gt;%
  # Prepare information of sample median expressions computed by fully observed features
  dplyr::group_by(Feature) %&gt;%
  dplyr::mutate(Keep = dplyr::case_when(!any(is.na(Value)) ~ &#39;Yes&#39;,
                                        any(is.na(Value)) ~ &#39;No&#39;)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(Keep %in% &#39;Yes&#39;) %&gt;%
  dplyr::group_by(Sample) %&gt;%
  dplyr::mutate(MedianVsnAbun = median(Value)) %&gt;%
  dplyr::ungroup()
# Create SE object containing information of sample missing levels and median expressions
colAnno &lt;- dplyr::select(lipPlasmaUnfiltVsnTab, Sample, OriMissLevel, MedianVsnAbun) %&gt;%
  dplyr::filter(!duplicated(Sample)) %&gt;%
  tibble::column_to_rownames(&#39;Sample&#39;)
lipPlasmaUnfiltVsn &lt;- SummarizedExperiment(assays = list(Abundance = assay(lipPlasmaUnfiltVsn)),
                                           colData = colAnno)

# Visualize relationship between sample missing levels and median expressions
ggplot(lipPlasmaUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(x = &#39;Missing level&#39;, y = &#39;Median expression&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-46-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show significant associations between data and sample missing
levels</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipPlasmaUnfiltVsn, meta_var = &#39;OriMissLevel&#39;, pca_method = &#39;pca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample missing levels
pcaRes$pcSigAssoRes %&gt;%
  dplyr::filter(grepl(&#39;PC[1-9] \\(&#39;, Var1))</code></pre>
<pre><code>         Var1         Var2     pVal  pValAdj   Stat        Test
1   PC1 (20%) OriMissLevel 2.79e-46 8.06e-44  0.714 Correlation
2   PC3 (10%) OriMissLevel 8.88e-06 1.28e-03 -0.258 Correlation
3 PC2 (11.9%) OriMissLevel 8.90e-05 6.43e-03  0.228 Correlation
4  PC6 (4.2%) OriMissLevel 2.03e-02 8.37e-01 -0.136 Correlation</code></pre>
<pre class="r"><code># Visualize relationship between PCs and sample missing levels
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC1 (20%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 6) +
  labs(y = &#39;Missing level&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-47-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=`PC1 (20%)`, y=`PC2 (11.9%)`, col=OriMissLevel)) +
  geom_point(size = 3.5) +
  scale_color_continuous(name = &#39;Missing level (%)&#39;, type = &#39;viridis&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-47-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>lipBaseB1NoWBC &lt;- lipBaseFiltVsn
B1NoWBC &lt;- c(B1NoWBC, `Filt feat num` = nrow(lipBaseB1NoWBC))</code></pre>
</div>
<div id="batch12-wbc-25" class="section level2">
<h2>Batch1&amp;2, WBC-25%</h2>
<pre class="r"><code># Load data
lipPlasmaB12WBC25 &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_2_20231130.xlsx&#39;,
                                        sheet = &#39;3_Feature Table correction 25&#39;)
# Assign column names
colnames(lipPlasmaB12WBC25) &lt;- lipPlasmaB12WBC25[1,]
lipPlasmaB12WBC25 &lt;- lipPlasmaB12WBC25[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB12WBC25 &lt;- dplyr::select(lipPlasmaB12WBC25, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %&gt;%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %&gt;%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, &#39;/&#39;, CCS, &#39;/&#39;, MZ)) %&gt;%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab &lt;- lipPlasmaB12WBC25
# Collect features captured in water processed blank
waterDat &lt;- dplyr::select(tidyTab, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt &lt;- c(`Ori feat num` = nrow(tidyTab), `m/z &lt; 300` = sum(tidyTab$MZ &lt; 300),
                `QC RSD% &gt; 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD &lt; 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% &gt; 25` = sum(tidyTab$QC_RSD &gt; 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat(&#39;There are duplicated features!&#39;)
}
B12WBC25 &lt;- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB12WBC25 &lt;- dplyr::filter(lipPlasmaB12WBC25, RT &gt;= 0.3, RT &lt;= 9, MZ &gt;= 300, QC_RSD &lt;= 25) %&gt;%
  dplyr::select(-c(QC_RSD, contains(&#39;QC plasma&#39;), contains(&#39;QCplasma&#39;), contains(&#39;Splash&#39;)))

# Remove features captured in water processed blank, which is not of interest
waterDat &lt;- dplyr::select(lipPlasmaB12WBC25, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats &lt;- rownames(waterDat)[rmFeats]
lipPlasmaB12WBC25 &lt;- dplyr::filter(lipPlasmaB12WBC25, !Feature %in% rmFeats) %&gt;%
  dplyr::select(-contains(&#39;water&#39;))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx&#39;)
colnames(smpPlateDat) &lt;- c(&#39;Plate&#39;, &#39;Batch_Sample&#39;)
smpPlateDat &lt;- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == &#39;Batch 3&#39;,
                             !grepl(&#39;^Box|QC plasma|QCplasma|water|ACN_H2O&#39;, Batch_Sample)) %&gt;%
  dplyr::mutate(Plate = stringr::str_remove(Plate, &#39;, Batch.+&#39;),
                Plate = stringr::str_replace_all(Plate, &#39;Box |Box&#39;, &#39;Plate&#39;),
                Plate = case_when(Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate4&#39;,
                                  !Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate1|2|3&#39;))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB12WBC25 &lt;- tidyr::pivot_longer(lipPlasmaB12WBC25, cols = -c(&#39;Feature&#39;, &#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                         names_to = &#39;Batch_Sample&#39;, values_to = &#39;Abundance&#39;) %&gt;%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, &#39;_Left.+$&#39;),
                Aliquot = stringr::str_remove_all(Batch_Sample, &#39;^Batch\\d_&#39;),
                Batch = stringr::str_extract(Batch_Sample, &#39;^Batch\\d&#39;),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V2_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V3_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V7_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_1TK71I_P_V4_2&#39; ~ &#39;SC_DIS_A_1TK71I_P_V3_2&#39;,
                                    !Aliquot %in% c(&#39;SC_DIS_A_F0X18FJY_P_V2_2&#39;,
                                                    &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39;,
                                                    &#39;SC_DIS_A_1TK71I_P_V4_2&#39;) ~ Aliquot)) %&gt;%
  dplyr::left_join(smpPlateDat, by = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::left_join(summMetadat4Discovery, by = &#39;Aliquot&#39;) %&gt;%
  dplyr::select(-c(Aliquot, TumorPurity))</code></pre>
<p><strong>Take all plasma samples from all batches for normalization,
and then subset Baseline samples</strong><br />
<strong>Normalize data without filtering by missingness</strong>
(because merging replicates could improve data missingness)</p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB12WBC25
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Batch_Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Sample&#39;, &#39;Batch&#39;, &#39;Plate&#39;),
                                      do_featFilt = F)$vsn.data
# Subset Baseline samples
lipBaseUnfiltVsn &lt;- lipPlasmaUnfiltVsn[, colData(lipPlasmaUnfiltVsn)$TimePoint %in% &#39;Baseline&#39;]
# Prepare long data for plotting
lipBaseUnfiltVsnTab &lt;- summExp2df(lipBaseUnfiltVsn, assay = &#39;Abundance&#39;,
                                  row_id = &#39;Feature&#39;, col_id = &#39;Batch_Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseUnfiltVsn)[2], &#39;samples and&#39;, dim(lipBaseUnfiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 126 samples and 1182 features</code></pre>
<pre class="r"><code># Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = &#39;Samples&#39;, y = &#39;Features&#39;, title = &#39;Missingness of Unfiltered data (Batch1 + Batch2)&#39;) +
  th4MissViz + theme(axis.text.x = element_blank(),
                     axis.title.x = element_text(size = 13, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-50-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipBaseUnfiltVsnTab, aes(x=Batch_Sample, y=Value, col=Batch)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-50-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-50-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize standard deviations of each feature between replicates
featDiffs &lt;- dplyr::group_by(lipBaseUnfiltVsnTab, Feature, Sample) %&gt;%
  dplyr::summarise(Distance = abs(diff(Value))) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::pull(Distance)
hist(featDiffs, breaks = 20, xlab = &#39;Difference&#39;, main = &#39;Histogram of distances of features between replicates&#39;)</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-50-4.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize relationships between replicates
B1 &lt;- dplyr::filter(lipBaseUnfiltVsnTab, Batch == &#39;Batch1&#39;) %&gt;%
  dplyr::select(Feature, Sample, Value) %&gt;%
  dplyr::rename(Batch1 = Value)
B2 &lt;- dplyr::filter(lipBaseUnfiltVsnTab, Batch == &#39;Batch2&#39;) %&gt;%
  dplyr::select(Feature, Sample, Value) %&gt;%
  dplyr::rename(Batch2 = Value)
scatTabB12 &lt;- dplyr::left_join(B1, B2, by = c(&#39;Feature&#39;, &#39;Sample&#39;))
ggplot(scatTabB12, aes(x=Batch1, y=Batch2)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = &#39;Relationships of replicates in Unfiltered vsn normalized data&#39;) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = &#39;red&#39;, linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = &#39;bold&#39;),
                                   axis.title = element_text(size = 14, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-51-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Check if there exists batch effect<br />
<strong>Hierarchical clustering</strong></p>
<pre class="r"><code># Compute sample euclidean distances
d &lt;- dist(t(assay(lipBaseUnfiltVsn)), method = &#39;euclidean&#39;)

# Visualize sample distances by heatmap with clustering
batchAnno &lt;- dplyr::select(lipBaseUnfiltVsnTab, Batch_Sample, Batch) %&gt;%
  dplyr::filter(!duplicated(Batch_Sample)) %&gt;%
  tibble::column_to_rownames(&#39;Batch_Sample&#39;)
pheatmap(as.matrix(d), annotation_col = batchAnno, scale = &#39;row&#39;, #row scaling is across columns
         color = colorRampPalette(c(&#39;navy&#39;, &#39;white&#39;, &#39;red&#39;))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = &#39;ward.D2&#39;, fontsize_col = 6,
         annotation_colors = list(Batch = c(Batch1 = &#39;grey30&#39;, Batch2 = &#39;grey60&#39;)))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-52-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Do hierarchical clustering
# hc &lt;- hclust(d, method = &#39;ward.D2&#39;)
# # Plot clustering result
# plot(hc, hang = 0.04, cex = 0.5, frame.plot = T, main = NULL)</code></pre>
<p>=&gt; Sample ‘1H3IW7_V1’ measured in different batches is not
clustered.</p>
<p><strong>PCA</strong></p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseUnfiltVsn, meta_var = &#39;Batch&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1  Var2   pVal pValAdj  Stat   Test
1  PC8 (3.2%) Batch 0.0129   0.174 -2.52 T-test
2 PC20 (0.9%) Batch 0.0174   0.174 -2.41 T-test
3 PC19 (1.1%) Batch 0.0369   0.246  2.11 T-test</code></pre>
<p><strong>Merge replicates by taking their means</strong></p>
<pre class="r"><code># Merge replicates from different batches
# Prepare sample metadata
smpAnnoTab &lt;- tibble::as_tibble(colData(lipBaseUnfiltVsn)) %&gt;%
  dplyr::select(-Batch) %&gt;%
  dplyr::distinct(Sample, .keep_all = T)
featAnnoTab &lt;- tibble::as_tibble(rowData(lipBaseUnfiltVsn), rownames = &#39;Feature&#39;)
# Take means of replicates from different batches
merge_lipBaseUnfiltVsnTab &lt;- summExp2df(lipBaseUnfiltVsn, assay = &#39;Abundance&#39;,
                                        row_id = &#39;Feature&#39;, col_id = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::group_by(Feature, Sample) %&gt;%
  dplyr::summarise(Value = mean(Value, na.rm = T)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::left_join(smpAnnoTab, by = &#39;Sample&#39;) %&gt;%
  dplyr::left_join(featAnnoTab, by = &#39;Feature&#39;)

# Visualize data distribution
ggplot(merge_lipBaseUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered Merged normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-55-1.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Remove features quantified in less than 2/3 of
samples</strong></p>
<pre class="r"><code># Remove features quantified in less than certain percent of samples
rmFeats &lt;- dplyr::group_by(merge_lipBaseUnfiltVsnTab, Feature) %&gt;%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Value)) / length(Value), 2)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(frac_nonNA &lt; 0.67) %&gt;%
  dplyr::pull(Feature)
merge_lipBaseFiltVsnTab &lt;- dplyr::filter(merge_lipBaseUnfiltVsnTab, !Feature %in% rmFeats)

# Convert long data to SE object
lipBaseFiltVsn &lt;- df2SummExp(merge_lipBaseFiltVsnTab, row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;,
                             values = &#39;Value&#39;, row_anno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                             col_anno = c(smpAnno, &#39;Plate&#39;))
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseFiltVsn)[2], &#39;samples and&#39;, dim(lipBaseFiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 63 samples and 1083 features</code></pre>
<pre class="r"><code># Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseFiltVsn)), cluster = T, sort_miss = T) +
  labs(y = &#39;Features&#39;, title = &#39;Missingness of Filtered Merged data&#39;) +
  th4MissViz</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-56-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show significant associations between PCs and plates where samples
are located. Samples in Plate4 were frozen at -80°C.</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseFiltVsn, meta_var = &#39;Plate&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1  Var2     pVal  pValAdj  Stat   Test
1 PC1 (18.8%) Plate 1.55e-06 0.000031 -5.32 T-test
2  PC8 (4.1%) Plate 1.27e-03 0.012700  3.38 T-test
3  PC7 (5.3%) Plate 3.46e-03 0.023100 -3.04 T-test</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC1 (18.8%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  ggpubr::stat_compare_means(method = &#39;t.test&#39;, paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-57-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>lipBaseB12WBC25 &lt;- lipBaseFiltVsn
B12WBC25 &lt;- c(B12WBC25, `Filt feat num` = nrow(lipBaseB12WBC25))</code></pre>
</div>
<div id="batch12-wbc-15" class="section level2">
<h2>Batch1&amp;2, WBC-15%</h2>
<pre class="r"><code># Load data
lipPlasmaB12WBC15 &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_2_20231130.xlsx&#39;,
                                        sheet = &#39;1_Feature Table correction 15&#39;)
# Assign column names
colnames(lipPlasmaB12WBC15) &lt;- lipPlasmaB12WBC15[1,]
lipPlasmaB12WBC15 &lt;- lipPlasmaB12WBC15[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB12WBC15 &lt;- dplyr::select(lipPlasmaB12WBC15, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %&gt;%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %&gt;%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, &#39;/&#39;, CCS, &#39;/&#39;, MZ)) %&gt;%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab &lt;- lipPlasmaB12WBC15
# Collect features captured in water processed blank
waterDat &lt;- dplyr::select(tidyTab, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt &lt;- c(`Ori feat num` = nrow(tidyTab), `m/z &lt; 300` = sum(tidyTab$MZ &lt; 300),
                `QC RSD% &gt; 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD &lt; 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% &gt; 25` = sum(tidyTab$QC_RSD &gt; 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat(&#39;There are duplicated features!&#39;)
}
B12WBC15 &lt;- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB12WBC15 &lt;- dplyr::filter(lipPlasmaB12WBC15, RT &gt;= 0.3, RT &lt;= 9, MZ &gt;= 300, QC_RSD &lt;= 25) %&gt;%
  dplyr::select(-c(QC_RSD, contains(&#39;QC plasma&#39;), contains(&#39;QCplasma&#39;), contains(&#39;Splash&#39;)))

# Remove features captured in water processed blank, which is not of interest
waterDat &lt;- dplyr::select(lipPlasmaB12WBC15, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats &lt;- rownames(waterDat)[rmFeats]
lipPlasmaB12WBC15 &lt;- dplyr::filter(lipPlasmaB12WBC15, !Feature %in% rmFeats) %&gt;%
  dplyr::select(-contains(&#39;water&#39;))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx&#39;)
colnames(smpPlateDat) &lt;- c(&#39;Plate&#39;, &#39;Batch_Sample&#39;)
smpPlateDat &lt;- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == &#39;Batch 3&#39;,
                             !grepl(&#39;^Box|QC plasma|QCplasma|water|ACN_H2O&#39;, Batch_Sample)) %&gt;%
  dplyr::mutate(Plate = stringr::str_remove(Plate, &#39;, Batch.+&#39;),
                Plate = stringr::str_replace_all(Plate, &#39;Box |Box&#39;, &#39;Plate&#39;),
                Plate = case_when(Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate4&#39;,
                                  !Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate1|2|3&#39;))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB12WBC15 &lt;- tidyr::pivot_longer(lipPlasmaB12WBC15, cols = -c(&#39;Feature&#39;, &#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                         names_to = &#39;Batch_Sample&#39;, values_to = &#39;Abundance&#39;) %&gt;%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, &#39;_Left.+$&#39;),
                Aliquot = stringr::str_remove_all(Batch_Sample, &#39;^Batch\\d_&#39;),
                Batch = stringr::str_extract(Batch_Sample, &#39;^Batch\\d&#39;),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V2_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V3_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V7_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_1TK71I_P_V4_2&#39; ~ &#39;SC_DIS_A_1TK71I_P_V3_2&#39;,
                                    !Aliquot %in% c(&#39;SC_DIS_A_F0X18FJY_P_V2_2&#39;,
                                                    &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39;,
                                                    &#39;SC_DIS_A_1TK71I_P_V4_2&#39;) ~ Aliquot)) %&gt;%
  dplyr::left_join(smpPlateDat, by = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::left_join(summMetadat4Discovery, by = &#39;Aliquot&#39;) %&gt;%
  dplyr::select(-c(Aliquot, TumorPurity))</code></pre>
<p><strong>Take all plasma samples from all batches for normalization,
and then subset Baseline samples</strong><br />
<strong>Normalize data without filtering by missingness</strong>
(because merging replicates could improve data missingness)</p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB12WBC15
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Batch_Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Sample&#39;, &#39;Batch&#39;, &#39;Plate&#39;),
                                      do_featFilt = F)$vsn.data
# Subset Baseline samples
lipBaseUnfiltVsn &lt;- lipPlasmaUnfiltVsn[, colData(lipPlasmaUnfiltVsn)$TimePoint %in% &#39;Baseline&#39;]
# Prepare long data for plotting
lipBaseUnfiltVsnTab &lt;- summExp2df(lipBaseUnfiltVsn, assay = &#39;Abundance&#39;,
                                  row_id = &#39;Feature&#39;, col_id = &#39;Batch_Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseUnfiltVsn)[2], &#39;samples and&#39;, dim(lipBaseUnfiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 126 samples and 719 features</code></pre>
<pre class="r"><code># Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = &#39;Samples&#39;, y = &#39;Features&#39;, title = &#39;Missingness of Unfiltered data (Batch1 + Batch2)&#39;) +
  th4MissViz + theme(axis.text.x = element_blank(),
                     axis.title.x = element_text(size = 13, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-60-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipBaseUnfiltVsnTab, aes(x=Batch_Sample, y=Value, col=Batch)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-60-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-60-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize standard deviations of each feature between replicates
featDiffs &lt;- dplyr::group_by(lipBaseUnfiltVsnTab, Feature, Sample) %&gt;%
  dplyr::summarise(Distance = abs(diff(Value))) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::pull(Distance)
hist(featDiffs, breaks = 20, xlab = &#39;Difference&#39;, main = &#39;Histogram of distances of features between replicates&#39;)</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-60-4.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize relationships between replicates
B1 &lt;- dplyr::filter(lipBaseUnfiltVsnTab, Batch == &#39;Batch1&#39;) %&gt;%
  dplyr::select(Feature, Sample, Value) %&gt;%
  dplyr::rename(Batch1 = Value)
B2 &lt;- dplyr::filter(lipBaseUnfiltVsnTab, Batch == &#39;Batch2&#39;) %&gt;%
  dplyr::select(Feature, Sample, Value) %&gt;%
  dplyr::rename(Batch2 = Value)
scatTabB12 &lt;- dplyr::left_join(B1, B2, by = c(&#39;Feature&#39;, &#39;Sample&#39;))
ggplot(scatTabB12, aes(x=Batch1, y=Batch2)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = &#39;Relationships of replicates in Unfiltered vsn normalized data&#39;) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = &#39;red&#39;, linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = &#39;bold&#39;),
                                   axis.title = element_text(size = 14, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-61-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Check if there exists batch effect<br />
<strong>Hierarchical clustering</strong></p>
<pre class="r"><code># Compute sample euclidean distances
d &lt;- dist(t(assay(lipBaseUnfiltVsn)), method = &#39;euclidean&#39;)

# Visualize sample distances by heatmap with clustering
batchAnno &lt;- dplyr::select(lipBaseUnfiltVsnTab, Batch_Sample, Batch) %&gt;%
  dplyr::filter(!duplicated(Batch_Sample)) %&gt;%
  tibble::column_to_rownames(&#39;Batch_Sample&#39;)
pheatmap(as.matrix(d), annotation_col = batchAnno, scale = &#39;row&#39;, #row scaling is across columns
         color = colorRampPalette(c(&#39;navy&#39;, &#39;white&#39;, &#39;red&#39;))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = &#39;ward.D2&#39;, fontsize_col = 6,
         annotation_colors = list(Batch = c(Batch1 = &#39;grey30&#39;, Batch2 = &#39;grey60&#39;)))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-62-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Do hierarchical clustering
# hc &lt;- hclust(d, method = &#39;ward.D2&#39;)
# # Plot clustering result
# plot(hc, hang = 0.04, cex = 0.5, frame.plot = T, main = NULL)</code></pre>
<p><strong>PCA</strong></p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseUnfiltVsn, meta_var = &#39;Batch&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1  Var2   pVal pValAdj  Stat   Test
1 PC15 (1.3%) Batch 0.0205   0.406  2.35 T-test
2 PC19 (0.8%) Batch 0.0406   0.406 -2.07 T-test</code></pre>
<p><strong>Merge replicates by taking their means</strong></p>
<pre class="r"><code># Merge replicates from different batches
# Prepare sample metadata
smpAnnoTab &lt;- tibble::as_tibble(colData(lipBaseUnfiltVsn)) %&gt;%
  dplyr::select(-Batch) %&gt;%
  dplyr::distinct(Sample, .keep_all = T)
featAnnoTab &lt;- tibble::as_tibble(rowData(lipBaseUnfiltVsn), rownames = &#39;Feature&#39;)
# Take means of replicates from different batches
merge_lipBaseUnfiltVsnTab &lt;- summExp2df(lipBaseUnfiltVsn, assay = &#39;Abundance&#39;,
                                        row_id = &#39;Feature&#39;, col_id = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::group_by(Feature, Sample) %&gt;%
  dplyr::summarise(Value = mean(Value, na.rm = T)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::left_join(smpAnnoTab, by = &#39;Sample&#39;) %&gt;%
  dplyr::left_join(featAnnoTab, by = &#39;Feature&#39;)

# Visualize data distribution
ggplot(merge_lipBaseUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered Merged normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-65-1.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Remove features quantified in less than 2/3 of
samples</strong></p>
<pre class="r"><code># Remove features quantified in less than certain percent of samples
rmFeats &lt;- dplyr::group_by(merge_lipBaseUnfiltVsnTab, Feature) %&gt;%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Value)) / length(Value), 2)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(frac_nonNA &lt; 0.67) %&gt;%
  dplyr::pull(Feature)
merge_lipBaseFiltVsnTab &lt;- dplyr::filter(merge_lipBaseUnfiltVsnTab, !Feature %in% rmFeats)

# Convert long data to SE object
lipBaseFiltVsn &lt;- df2SummExp(merge_lipBaseFiltVsnTab, row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;,
                             values = &#39;Value&#39;, row_anno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                             col_anno = c(smpAnno, &#39;Plate&#39;))
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseFiltVsn)[2], &#39;samples and&#39;, dim(lipBaseFiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 63 samples and 663 features</code></pre>
<p>Show significant associations between PCs and plates where samples
are located. Samples in Plate4 were frozen at -80°C.</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseFiltVsn, meta_var = &#39;Plate&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1  Var2     pVal  pValAdj  Stat   Test
1 PC2 (16.8%) Plate 1.04e-05 0.000208  4.81 T-test
2 PC3 (10.5%) Plate 3.38e-03 0.033800 -3.05 T-test
3  PC9 (3.7%) Plate 6.85e-03 0.045700 -2.80 T-test
4  PC6 (5.4%) Plate 3.81e-02 0.190000  2.12 T-test</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC2 (16.8%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  ggpubr::stat_compare_means(method = &#39;t.test&#39;, paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-67-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>lipBaseB12WBC15 &lt;- lipBaseFiltVsn
B12WBC15 &lt;- c(B12WBC15, `Filt feat num` = nrow(lipBaseB12WBC15))</code></pre>
</div>
<div id="batch12-wbc-no" class="section level2">
<h2>Batch1&amp;2, WBC-No</h2>
<pre class="r"><code># Load data
lipPlasmaB12NoWBC &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_2_20231130.xlsx&#39;,
                                        sheet = &#39;2_Feature Table no correction&#39;)
# Assign column names
colnames(lipPlasmaB12NoWBC) &lt;- lipPlasmaB12NoWBC[1,]
lipPlasmaB12NoWBC &lt;- lipPlasmaB12NoWBC[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB12NoWBC &lt;- dplyr::select(lipPlasmaB12NoWBC, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %&gt;%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %&gt;%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, &#39;/&#39;, CCS, &#39;/&#39;, MZ)) %&gt;%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab &lt;- lipPlasmaB12NoWBC
# Collect features captured in water processed blank
waterDat &lt;- dplyr::select(tidyTab, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt &lt;- c(`Ori feat num` = nrow(tidyTab), `m/z &lt; 300` = sum(tidyTab$MZ &lt; 300),
                `QC RSD% &gt; 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD &lt; 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% &gt; 25` = sum(tidyTab$QC_RSD &gt; 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat(&#39;There are duplicated features!&#39;)
}
B12NoWBC &lt;- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB12NoWBC &lt;- dplyr::filter(lipPlasmaB12NoWBC, RT &gt;= 0.3, RT &lt;= 9, MZ &gt;= 300, QC_RSD &lt;= 25) %&gt;%
  dplyr::select(-c(QC_RSD, contains(&#39;QC plasma&#39;), contains(&#39;QCplasma&#39;), contains(&#39;Splash&#39;)))

# Remove features captured in water processed blank, which is not of interest
waterDat &lt;- dplyr::select(lipPlasmaB12NoWBC, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats &lt;- rownames(waterDat)[rmFeats]
lipPlasmaB12NoWBC &lt;- dplyr::filter(lipPlasmaB12NoWBC, !Feature %in% rmFeats) %&gt;%
  dplyr::select(-contains(&#39;water&#39;))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx&#39;)
colnames(smpPlateDat) &lt;- c(&#39;Plate&#39;, &#39;Batch_Sample&#39;)
smpPlateDat &lt;- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == &#39;Batch 3&#39;,
                             !grepl(&#39;^Box|QC plasma|QCplasma|water|ACN_H2O&#39;, Batch_Sample)) %&gt;%
  dplyr::mutate(Plate = stringr::str_remove(Plate, &#39;, Batch.+&#39;),
                Plate = stringr::str_replace_all(Plate, &#39;Box |Box&#39;, &#39;Plate&#39;),
                Plate = case_when(Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate4&#39;,
                                  !Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate1|2|3&#39;))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB12NoWBC &lt;- tidyr::pivot_longer(lipPlasmaB12NoWBC, cols = -c(&#39;Feature&#39;, &#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                         names_to = &#39;Batch_Sample&#39;, values_to = &#39;Abundance&#39;) %&gt;%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, &#39;_Left.+$&#39;),
                Aliquot = stringr::str_remove_all(Batch_Sample, &#39;^Batch\\d_&#39;),
                Batch = stringr::str_extract(Batch_Sample, &#39;^Batch\\d&#39;),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V2_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V3_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V7_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_1TK71I_P_V4_2&#39; ~ &#39;SC_DIS_A_1TK71I_P_V3_2&#39;,
                                    !Aliquot %in% c(&#39;SC_DIS_A_F0X18FJY_P_V2_2&#39;,
                                                    &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39;,
                                                    &#39;SC_DIS_A_1TK71I_P_V4_2&#39;) ~ Aliquot)) %&gt;%
  dplyr::left_join(smpPlateDat, by = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::left_join(summMetadat4Discovery, by = &#39;Aliquot&#39;) %&gt;%
  dplyr::select(-c(Aliquot, TumorPurity))</code></pre>
<p><strong>Take all plasma samples from all batches for normalization,
and then subset Baseline samples</strong><br />
<strong>Normalize data without filtering by missingness</strong>
(because merging replicates could improve data missingness)</p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB12NoWBC
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Batch_Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Sample&#39;, &#39;Batch&#39;, &#39;Plate&#39;),
                                      do_featFilt = F)$vsn.data
# Subset Baseline samples
lipBaseUnfiltVsn &lt;- lipPlasmaUnfiltVsn[, colData(lipPlasmaUnfiltVsn)$TimePoint %in% &#39;Baseline&#39;]
# Prepare long data for plotting
lipBaseUnfiltVsnTab &lt;- summExp2df(lipBaseUnfiltVsn, assay = &#39;Abundance&#39;,
                                  row_id = &#39;Feature&#39;, col_id = &#39;Batch_Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseUnfiltVsn)[2], &#39;samples and&#39;, dim(lipBaseUnfiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 126 samples and 987 features</code></pre>
<pre class="r"><code># Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = &#39;Samples&#39;, y = &#39;Features&#39;, title = &#39;Missingness of Unfiltered data (Batch1 + Batch2)&#39;) +
  th4MissViz + theme(axis.text.x = element_blank(),
                     axis.title.x = element_text(size = 13, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-70-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipBaseUnfiltVsnTab, aes(x=Batch_Sample, y=Value, col=Batch)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-70-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-70-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize standard deviations of each feature between replicates
featDiffs &lt;- dplyr::group_by(lipBaseUnfiltVsnTab, Feature, Sample) %&gt;%
  dplyr::summarise(Distance = abs(diff(Value))) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::pull(Distance)
hist(featDiffs, breaks = 20, xlab = &#39;Difference&#39;, main = &#39;Histogram of distances of features between replicates&#39;)</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-70-4.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize relationships between replicates
B1 &lt;- dplyr::filter(lipBaseUnfiltVsnTab, Batch == &#39;Batch1&#39;) %&gt;%
  dplyr::select(Feature, Sample, Value) %&gt;%
  dplyr::rename(Batch1 = Value)
B2 &lt;- dplyr::filter(lipBaseUnfiltVsnTab, Batch == &#39;Batch2&#39;) %&gt;%
  dplyr::select(Feature, Sample, Value) %&gt;%
  dplyr::rename(Batch2 = Value)
scatTabB12 &lt;- dplyr::left_join(B1, B2, by = c(&#39;Feature&#39;, &#39;Sample&#39;))
ggplot(scatTabB12, aes(x=Batch1, y=Batch2)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = &#39;Relationships of replicates in Unfiltered vsn normalized data&#39;) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = &#39;red&#39;, linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = &#39;bold&#39;),
                                   axis.title = element_text(size = 14, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-71-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Check if there exists batch effect<br />
<strong>Hierarchical clustering</strong></p>
<pre class="r"><code># Compute sample euclidean distances
d &lt;- dist(t(assay(lipBaseUnfiltVsn)), method = &#39;euclidean&#39;)

# Visualize sample distances by heatmap with clustering
batchAnno &lt;- dplyr::select(lipBaseUnfiltVsnTab, Batch_Sample, Batch) %&gt;%
  dplyr::filter(!duplicated(Batch_Sample)) %&gt;%
  tibble::column_to_rownames(&#39;Batch_Sample&#39;)
pheatmap(as.matrix(d), annotation_col = batchAnno, scale = &#39;row&#39;, #row scaling is across columns
         color = colorRampPalette(c(&#39;navy&#39;, &#39;white&#39;, &#39;red&#39;))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = &#39;ward.D2&#39;, fontsize_col = 6,
         annotation_colors = list(Batch = c(Batch1 = &#39;grey30&#39;, Batch2 = &#39;grey60&#39;)))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-72-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Do hierarchical clustering
# hc &lt;- hclust(d, method = &#39;ward.D2&#39;)
# # Plot clustering result
# plot(hc, hang = 0.04, cex = 0.5, frame.plot = T, main = NULL)</code></pre>
<p><strong>PCA</strong></p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseUnfiltVsn, meta_var = &#39;Batch&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1  Var2   pVal pValAdj  Stat   Test
1 PC17 (1.2%) Batch 0.0208    0.21 -2.34 T-test
2  PC9 (3.3%) Batch 0.0210    0.21  2.34 T-test</code></pre>
<p><strong>Merge replicates by taking their means</strong></p>
<pre class="r"><code># Merge replicates from different batches
# Prepare sample metadata
smpAnnoTab &lt;- tibble::as_tibble(colData(lipBaseUnfiltVsn)) %&gt;%
  dplyr::select(-Batch) %&gt;%
  dplyr::distinct(Sample, .keep_all = T)
featAnnoTab &lt;- tibble::as_tibble(rowData(lipBaseUnfiltVsn), rownames = &#39;Feature&#39;)
# Take means of replicates from different batches
merge_lipBaseUnfiltVsnTab &lt;- summExp2df(lipBaseUnfiltVsn, assay = &#39;Abundance&#39;,
                                        row_id = &#39;Feature&#39;, col_id = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::group_by(Feature, Sample) %&gt;%
  dplyr::summarise(Value = mean(Value, na.rm = T)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::left_join(smpAnnoTab, by = &#39;Sample&#39;) %&gt;%
  dplyr::left_join(featAnnoTab, by = &#39;Feature&#39;)

# Visualize data distribution
ggplot(merge_lipBaseUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered Merged normalized data&#39;) +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-75-1.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Remove features quantified in less than 2/3 of
samples</strong></p>
<pre class="r"><code># Remove features quantified in less than certain percent of samples
rmFeats &lt;- dplyr::group_by(merge_lipBaseUnfiltVsnTab, Feature) %&gt;%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Value)) / length(Value), 2)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(frac_nonNA &lt; 0.67) %&gt;%
  dplyr::pull(Feature)
merge_lipBaseFiltVsnTab &lt;- dplyr::filter(merge_lipBaseUnfiltVsnTab, !Feature %in% rmFeats)

# Convert long data to SE object
lipBaseFiltVsn &lt;- df2SummExp(merge_lipBaseFiltVsnTab, row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;,
                             values = &#39;Value&#39;, row_anno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                             col_anno = c(smpAnno, &#39;Plate&#39;))
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseFiltVsn)[2], &#39;samples and&#39;, dim(lipBaseFiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 63 samples and 908 features</code></pre>
<p>Show significant associations between PCs and plates where samples
are located. Samples in Plate4 were frozen at -80°C.</p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseFiltVsn, meta_var = &#39;Plate&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1  Var2     pVal  pValAdj  Stat   Test
1 PC1 (24.5%) Plate 5.58e-07 1.12e-05  5.59 T-test
2 PC2 (19.6%) Plate 4.42e-06 4.42e-05 -5.04 T-test
3  PC5 (5.2%) Plate 8.49e-04 5.66e-03 -3.51 T-test</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC1 (24.5%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  ggpubr::stat_compare_means(method = &#39;t.test&#39;, paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-77-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>lipBaseB12NoWBC &lt;- lipBaseFiltVsn
B12NoWBC &lt;- c(B12NoWBC, `Filt feat num` = nrow(lipBaseB12NoWBC))</code></pre>
</div>
<div id="batch123-wbc-15" class="section level2">
<h2>Batch1&amp;2&amp;3, WBC-15%</h2>
<pre class="r"><code># Load data
lipPlasmaB123WBC15 &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_2_3_20231129.xlsx&#39;,
                                         sheet = &#39;2_Feature Table Correction 15&#39;)
# Assign column names
colnames(lipPlasmaB123WBC15) &lt;- lipPlasmaB123WBC15[1,]
lipPlasmaB123WBC15 &lt;- lipPlasmaB123WBC15[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB123WBC15 &lt;- dplyr::select(lipPlasmaB123WBC15, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`,
                                                           Name, `Molecular Formula`, Annotations,
                                                           AQ, `Annotation Source`, Boxplot,
                                                           Flags, Include)) %&gt;%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %&gt;%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, &#39;/&#39;, CCS, &#39;/&#39;, MZ)) %&gt;%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab &lt;- lipPlasmaB123WBC15
# Collect features captured in water processed blank
waterDat &lt;- dplyr::select(tidyTab, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt &lt;- c(`Ori feat num` = nrow(tidyTab), `m/z &lt; 300` = sum(tidyTab$MZ &lt; 300),
                `QC RSD% &gt; 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD &lt; 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% &gt; 25` = sum(tidyTab$QC_RSD &gt; 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat(&#39;There are duplicated features!&#39;)
}
B123WBC15 &lt;- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB123WBC15 &lt;- dplyr::filter(lipPlasmaB123WBC15, RT &gt;= 0.3, RT &lt;= 9, MZ &gt;= 300, QC_RSD &lt;= 25) %&gt;%
  dplyr::select(-c(QC_RSD, contains(&#39;QC plasma&#39;), contains(&#39;QCplasma&#39;)))

# Remove features captured in water processed blank, which is not of interest
waterDat &lt;- dplyr::select(lipPlasmaB123WBC15, Feature, contains(&#39;water&#39;)) %&gt;%
  tibble::column_to_rownames(&#39;Feature&#39;) %&gt;%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats &lt;- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats &lt;- rownames(waterDat)[rmFeats]
lipPlasmaB123WBC15 &lt;- dplyr::filter(lipPlasmaB123WBC15, !Feature %in% rmFeats) %&gt;%
  dplyr::select(-contains(&#39;water&#39;))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat &lt;- readxl::read_excel(&#39;./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx&#39;)
colnames(smpPlateDat) &lt;- c(&#39;Plate&#39;, &#39;Batch_Sample&#39;)
smpPlateDat &lt;- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == &#39;Batch 3&#39;,
                             !grepl(&#39;^Box|QC plasma|QCplasma|water|ACN_H2O&#39;, Batch_Sample)) %&gt;%
  dplyr::mutate(Plate = stringr::str_remove(Plate, &#39;, Batch.+&#39;),
                Plate = stringr::str_replace_all(Plate, &#39;Box |Box&#39;, &#39;Plate&#39;),
                Plate = case_when(Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate4&#39;,
                                  !Plate %in% &#39;Plate3_4&#39; ~ &#39;Plate1|2|3&#39;))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB123WBC15 &lt;- tidyr::pivot_longer(lipPlasmaB123WBC15, cols = -c(&#39;Feature&#39;, &#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                          names_to = &#39;Batch_Sample&#39;, values_to = &#39;Abundance&#39;) %&gt;%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, &#39;_Left.+$&#39;),
                Aliquot = stringr::str_remove_all(Batch_Sample, &#39;^Batch\\d_&#39;),
                Batch = stringr::str_extract(Batch_Sample, &#39;^Batch\\d&#39;),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V2_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V3_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39; ~ &#39;SC_DIS_A_F0X18FJY_P_V7_2&#39;,
                                    Aliquot %in% &#39;SC_DIS_A_1TK71I_P_V4_2&#39; ~ &#39;SC_DIS_A_1TK71I_P_V3_2&#39;,
                                    !Aliquot %in% c(&#39;SC_DIS_A_F0X18FJY_P_V2_2&#39;,
                                                    &#39;SC_DIS_A_F0X18FJY_P_V6_2&#39;,
                                                    &#39;SC_DIS_A_1TK71I_P_V4_2&#39;) ~ Aliquot)) %&gt;%
  dplyr::left_join(smpPlateDat, by = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::left_join(summMetadat4Discovery, by = &#39;Aliquot&#39;) %&gt;%
  dplyr::select(-c(Aliquot, TumorPurity))</code></pre>
<p><strong>Take all plasma samples from all batches for normalization,
and then subset Baseline samples</strong><br />
<strong>Normalize data without filtering by missingness</strong>
(because merging replicates could improve data missingness)</p>
<pre class="r"><code># Normalize unfiltered data
lipPlasmaTab &lt;- lipPlasmaB123WBC15
lipPlasmaUnfiltVsn &lt;- doPreprocessing(lipPlasmaTab, feat = &#39;Feature&#39;, smp = &#39;Batch_Sample&#39;,
                                      val = &#39;Abundance&#39;, featAnno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                                      smpAnno = c(smpAnno, &#39;Sample&#39;, &#39;Batch&#39;, &#39;Plate&#39;),
                                      do_featFilt = F)$vsn.data
# Subset Baseline samples
lipBaseUnfiltVsn &lt;- lipPlasmaUnfiltVsn[, colData(lipPlasmaUnfiltVsn)$TimePoint %in% &#39;Baseline&#39;]
# Prepare long data for plotting
lipBaseUnfiltVsnTab &lt;- summExp2df(lipBaseUnfiltVsn, assay = &#39;Abundance&#39;,
                                  row_id = &#39;Feature&#39;, col_id = &#39;Batch_Sample&#39;)
# Show dimensions of data
cat(&#39;Data dimensions:&#39;, dim(lipBaseUnfiltVsn)[2], &#39;samples and&#39;, dim(lipBaseUnfiltVsn)[1], &#39;features&#39;)</code></pre>
<pre><code>Data dimensions: 189 samples and 106 features</code></pre>
<pre class="r"><code># Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = &#39;Samples&#39;, y = &#39;Features&#39;, title = &#39;Missingness of Unfiltered data (Batch1 + Batch2 + Batch3)&#39;) +
  th4MissViz + theme(axis.text.x = element_blank(),
                     axis.title.x = element_text(size = 13, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-80-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize data distribution
ggplot(lipBaseUnfiltVsnTab, aes(x=Batch_Sample, y=Value, col=Batch)) +
  geom_boxplot() +
  labs(x = &#39;Sample&#39;, y = &#39;Abundance&#39;, title = &#39;Distribution of Unfiltered vsn normalized data&#39;) +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-80-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = &#39;Rank of mean&#39;, y = &#39;SD&#39;, title = &#39;Feature mean-sd relationship&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-80-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize standard deviations of each feature among replicates
featSDs &lt;- dplyr::group_by(lipBaseUnfiltVsnTab, Feature, Sample) %&gt;%
  dplyr::summarise(SD = sd(Value, na.rm = T)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::pull(SD)
hist(featSDs, breaks = 20, xlab = &#39;Standard deviation&#39;, main = &#39;Histogram of SDs of features among replicates&#39;)</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-80-4.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Visualize relationships between replicates
B1 &lt;- dplyr::filter(lipBaseUnfiltVsnTab, Batch == &#39;Batch1&#39;) %&gt;%
  dplyr::select(Feature, Sample, Value) %&gt;%
  dplyr::rename(Batch1 = Value)
B2 &lt;- dplyr::filter(lipBaseUnfiltVsnTab, Batch == &#39;Batch2&#39;) %&gt;%
  dplyr::select(Feature, Sample, Value) %&gt;%
  dplyr::rename(Batch2 = Value)
B3 &lt;- dplyr::filter(lipBaseUnfiltVsnTab, Batch == &#39;Batch3&#39;) %&gt;%
  dplyr::select(Feature, Sample, Value) %&gt;%
  dplyr::rename(Batch3 = Value)

scatTabB12 &lt;- dplyr::left_join(B1, B2, by = c(&#39;Feature&#39;, &#39;Sample&#39;))
ggplot(scatTabB12, aes(x=Batch1, y=Batch2)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = &#39;Relationships of replicates in Unfiltered vsn normalized data&#39;) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = &#39;red&#39;, linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = &#39;bold&#39;),
                                   axis.title = element_text(size = 14, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-81-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>scatTabB13 &lt;- dplyr::left_join(B1, B3, by = c(&#39;Feature&#39;, &#39;Sample&#39;))
ggplot(scatTabB13, aes(x=Batch1, y=Batch3)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = &#39;Relationships of replicates in Unfiltered vsn normalized data&#39;) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = &#39;red&#39;, linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = &#39;bold&#39;),
                                   axis.title = element_text(size = 14, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-81-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>scatTabB23 &lt;- dplyr::left_join(B2, B3, by = c(&#39;Feature&#39;, &#39;Sample&#39;))
ggplot(scatTabB23, aes(x=Batch2, y=Batch3)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = &#39;Relationships of replicates in Unfiltered vsn normalized data&#39;) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = &#39;pearson&#39;, size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = &#39;red&#39;, linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = &#39;bold&#39;),
                                   axis.title = element_text(size = 14, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-81-3.png" width="960" style="display: block; margin: auto;" /></p>
<p>Check if there exists batch effect<br />
<strong>Hierarchical clustering</strong></p>
<pre class="r"><code># Compute sample euclidean distances
d &lt;- dist(t(assay(lipBaseUnfiltVsn)), method = &#39;euclidean&#39;)

# Visualize sample distances by heatmap with clustering
batchAnno &lt;- dplyr::select(lipBaseUnfiltVsnTab, Batch_Sample, Batch) %&gt;%
  dplyr::filter(!duplicated(Batch_Sample)) %&gt;%
  tibble::column_to_rownames(&#39;Batch_Sample&#39;)
pheatmap(as.matrix(d), annotation_col = batchAnno, scale = &#39;row&#39;, #row scaling is across columns
         color = colorRampPalette(c(&#39;navy&#39;, &#39;white&#39;, &#39;red&#39;))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = &#39;ward.D2&#39;, fontsize_col = 5,
         annotation_colors = list(Batch = c(Batch1 = &#39;grey30&#39;, Batch2 = &#39;grey60&#39;, Batch3 = &#39;grey90&#39;)))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-82-1.png" width="1344" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Do hierarchical clustering
# hc &lt;- hclust(d, method = &#39;ward.D2&#39;)
# # Plot clustering result
# plot(hc, hang = 0.04, cex = 0.5, frame.plot = T, main = NULL)</code></pre>
<p><strong>PCA</strong></p>
<pre class="r"><code># Do PCA
pcaRes &lt;- doSOA(lipBaseUnfiltVsn, meta_var = &#39;Batch&#39;, pca_method = &#39;ppca&#39;,
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes</code></pre>
<pre><code>         Var1  Var2     pVal  pValAdj  Stat  Test
1 PC16 (0.5%) Batch 4.83e-07 9.67e-06 15.70 ANOVA
2  PC7 (3.3%) Batch 1.83e-04 1.83e-03  9.02 ANOVA
3 PC14 (0.8%) Batch 8.75e-04 5.83e-03  7.31 ANOVA
4 PC19 (0.3%) Batch 1.72e-03 7.91e-03  6.59 ANOVA
5  PC9 (2.2%) Batch 1.98e-03 7.91e-03  6.44 ANOVA
6  PC4 (7.2%) Batch 2.52e-03 8.41e-03  6.18 ANOVA
7 PC12 (1.1%) Batch 1.01e-02 2.89e-02  4.71 ANOVA</code></pre>
<pre class="r"><code># Visualize PCs
pcTab &lt;- pcaRes$pcTab
ggplot(pcTab, aes(x=Batch, y=`PC16 (0.5%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-83-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=Batch, y=`PC7 (3.3%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-83-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(pcTab, aes(x=Batch, y=`PC4 (7.2%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = &#39;Dark2&#39;) +
  scale_fill_brewer(palette = &#39;Dark2&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-83-3.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># **Merge replicates by taking their means**

# Merge replicates from different batches
# Prepare sample metadata
smpAnnoTab &lt;- tibble::as_tibble(colData(lipBaseUnfiltVsn)) %&gt;%
  dplyr::select(-Batch) %&gt;%
  dplyr::distinct(Sample, .keep_all = T)
featAnnoTab &lt;- tibble::as_tibble(rowData(lipBaseUnfiltVsn), rownames = &#39;Feature&#39;)
# Take means of replicates from different batches
merge_lipBaseUnfiltVsnTab &lt;- summExp2df(lipBaseUnfiltVsn, assay = &#39;Abundance&#39;,
                                        row_id = &#39;Feature&#39;, col_id = &#39;Batch_Sample&#39;) %&gt;%
  dplyr::group_by(Feature, Sample) %&gt;%
  dplyr::summarise(Value = mean(Value, na.rm = T)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::left_join(smpAnnoTab, by = &#39;Sample&#39;) %&gt;%
  dplyr::left_join(featAnnoTab, by = &#39;Feature&#39;)

# **Remove features quantified in less than 2/3 of samples**

# Remove features quantified in less than certain percent of samples
rmFeats &lt;- dplyr::group_by(merge_lipBaseUnfiltVsnTab, Feature) %&gt;%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Value)) / length(Value), 2)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(frac_nonNA &lt; 0.67) %&gt;%
  dplyr::pull(Feature)
merge_lipBaseFiltVsnTab &lt;- dplyr::filter(merge_lipBaseUnfiltVsnTab, !Feature %in% rmFeats)

# Convert long data to SE object
lipBaseFiltVsn &lt;- df2SummExp(merge_lipBaseFiltVsnTab, row_id = &#39;Feature&#39;, col_id = &#39;Sample&#39;,
                             values = &#39;Value&#39;, row_anno = c(&#39;RT&#39;, &#39;CCS&#39;, &#39;MZ&#39;),
                             col_anno = c(smpAnno, &#39;Plate&#39;))</code></pre>
<pre class="r"><code>B123WBC15 &lt;- c(B123WBC15, `Filt feat num` = length(unique(lipPlasmaB123WBC15$Feature)))</code></pre>
</div>
<div id="summary-1" class="section level2">
<h2>Summary</h2>
<p>Visualize filtering<br />
<strong>Original vs Filtered feature space (by m/z, QC RSD%, and blank
relevant feature removal)</strong></p>
<pre class="r"><code># Visualize filtering in different datasets
# Prepare summarized filtering data
summFiltTab &lt;- data.frame(B1WBC25, B1WBC15, B1NoWBC, B12WBC25, B12WBC15, B12NoWBC, B123WBC15) %&gt;%
  dplyr::rename(`B1, WBC-25%` = B1WBC25, `B1, WBC-15%` = B1WBC15, `B1, WBC-No` = B1NoWBC,
                `B1&amp;2, WBC-25%` = B12WBC25, `B1&amp;2, WBC-15%` = B12WBC15, `B1&amp;2, WBC-No` = B12NoWBC,
                `B1&amp;2&amp;3, WBC-15%` = B123WBC15) %&gt;%
  tibble::rownames_to_column(&#39;Filtering&#39;) %&gt;%
  tidyr::pivot_longer(cols = -&#39;Filtering&#39;, names_to = &#39;Dataset&#39;, values_to = &#39;Count&#39;) %&gt;%
  dplyr::mutate(Batch = stringr::str_remove(Dataset, &#39;, .+&#39;),
                Batch = stringr::str_replace(Batch, &#39;^B&#39;, &#39;Batch&#39;),
                WBC = stringr::str_extract(Dataset, &#39;WBC.+&#39;),
                WBC = factor(WBC, levels = c(&#39;WBC-25%&#39;, &#39;WBC-15%&#39;, &#39;WBC-No&#39;)))
featSpaceTab &lt;- dplyr::filter(summFiltTab, Filtering %in% c(&#39;Ori feat num&#39;, &#39;Filt feat num&#39;)) %&gt;%
  dplyr::rename(featSpace = Filtering) %&gt;%
  dplyr::mutate(featSpace = case_when(featSpace %in% &#39;Ori feat num&#39; ~ &#39;Original&#39;,
                                      featSpace %in% &#39;Filt feat num&#39; ~ &#39;After filtering&#39;),
                featSpace = factor(featSpace, levels = c(&#39;Original&#39;, &#39;After filtering&#39;)))
summFiltTab &lt;- dplyr::filter(summFiltTab, !Filtering %in% c(&#39;Ori feat num&#39;, &#39;QC RSD% &gt; 25 | NA&#39;, &#39;Filt feat num&#39;))
# Plot feature spaces
ggplot(featSpaceTab, aes(x=WBC, y=Count)) +
  geom_bar(aes(fill=featSpace), stat = &#39;identity&#39;, position = position_dodge(), alpha = 0.9) +
  scale_fill_grey(name = &#39;Feature space&#39;, start = 0.7, end = 0.3) +
  labs(x = &#39;Dataset (Within-batch correction)&#39;) +
  facet_wrap(~ Batch) +
  th + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
             strip.text = element_text(size = 16, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-87-1.png" width="960" style="display: block; margin: auto;" /></p>
<p><strong>Numbers of removed features</strong></p>
<pre class="r"><code># Plot numbers of removed features
ggplot(summFiltTab, aes(x=WBC, y=Count, col=Filtering, group=Filtering)) +
  geom_point(size = 4, show.legend = F) +
  geom_line(linewidth = 2, linetype = &#39;dashed&#39;) +
  scale_color_brewer(name = &#39;Filtering criteria&#39;, palette = &#39;Dark2&#39;) +
  labs(x = &#39;Dataset (Within-batch correction)&#39;) +
  facet_wrap(~ Batch) +
  th + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
             strip.text = element_text(size = 16, face = &#39;bold&#39;))</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-88-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># ggplot(featSpaceTab, aes(x=WBC, y=Count)) +
#   geom_bar(aes(fill=featSpace), stat = &#39;identity&#39;, position = position_dodge(), alpha = 0.9) +
#   geom_point(data = summFiltTab, aes(x=WBC, y=Count, col=Filtering), size = 2.5, show.legend = F) +
#   geom_line(data = summFiltTab, aes(col=Filtering, group=Filtering), linewidth = 1.2) +
#   scale_fill_grey(name = &#39;Feature space&#39;, start = 0.8, end = 0.6) +
#   scale_color_brewer(name = &#39;Filtering criteria&#39;, palette = &#39;Dark2&#39;) +
#   labs(x = &#39;Within-batch correction&#39;) +
#   facet_wrap(~ Batch) +
#   th + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
#              strip.text = element_text(size = 16, face = &#39;bold&#39;))</code></pre>
<p>Display proportions of <strong>recurrence-related</strong>
significant features</p>
<pre class="r"><code># Visualize proportions of significant features and data power about recurrence prediction
# Do SOA
soaResB1WBC25 &lt;- doSOA(lipBaseB1WBC25, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                       num_PCs = 20, use_proDA = T, unwantVar = &#39;Plate&#39;)
soaResB1WBC15 &lt;- doSOA(lipBaseB1WBC15, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                       num_PCs = 20, use_proDA = T, unwantVar = &#39;Plate&#39;)
soaResB1NoWBC &lt;- doSOA(lipBaseB1NoWBC, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                       num_PCs = 20, use_proDA = T, unwantVar = &#39;Plate&#39;)
soaResB12WBC25 &lt;- doSOA(lipBaseB12WBC25, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                        num_PCs = 20, use_proDA = T, unwantVar = &#39;Plate&#39;)
soaResB12WBC15 &lt;- doSOA(lipBaseB12WBC15, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                        num_PCs = 20, use_proDA = T, unwantVar = &#39;Plate&#39;)
soaResB12NoWBC &lt;- doSOA(lipBaseB12NoWBC, meta_var = &#39;Recurrence&#39;, pca_method = &#39;ppca&#39;,
                        num_PCs = 20, use_proDA = T, unwantVar = &#39;Plate&#39;)

# Prepare summarized feature significance data
propSigFeatsB1WBC25 &lt;- nrow(soaResB1WBC25$featSigAssoRes) / nrow(soaResB1WBC25$data) * 100
propSigFeatsB1WBC15 &lt;- nrow(soaResB1WBC15$featSigAssoRes) / nrow(soaResB1WBC15$data) * 100
propSigFeatsB1NoWBC &lt;- nrow(soaResB1NoWBC$featSigAssoRes) / nrow(soaResB1NoWBC$data) * 100
propSigFeatsB12WBC25 &lt;- nrow(soaResB12WBC25$featSigAssoRes) / nrow(soaResB12WBC25$data) * 100
propSigFeatsB12WBC15 &lt;- nrow(soaResB12WBC15$featSigAssoRes) / nrow(soaResB12WBC15$data) * 100
propSigFeatsB12NoWBC &lt;- nrow(soaResB12NoWBC$featSigAssoRes) / nrow(soaResB12NoWBC$data) * 100
sigFeatPropTab &lt;- data.frame(Dataset = factor(c(&#39;B1, WBC-25%&#39;, &#39;B1, WBC-15%&#39;, &#39;B1, WBC-No&#39;,
                                                &#39;B1&amp;2, WBC-25%&#39;, &#39;B1&amp;2, WBC-15%&#39;, &#39;B1&amp;2, WBC-No&#39;),
                                              levels = c(&#39;B1&amp;2, WBC-No&#39;, &#39;B1&amp;2, WBC-15%&#39;, &#39;B1&amp;2, WBC-25%&#39;,
                                                         &#39;B1, WBC-No&#39;, &#39;B1, WBC-15%&#39;, &#39;B1, WBC-25%&#39;)),
                             Proportion = c(propSigFeatsB1WBC25, propSigFeatsB1WBC15, propSigFeatsB1NoWBC,
                                            propSigFeatsB12WBC25, propSigFeatsB12WBC15, propSigFeatsB12NoWBC),
                             AbsNum = c(nrow(soaResB1WBC25$featSigAssoRes), nrow(soaResB1WBC15$featSigAssoRes),
                                        nrow(soaResB1NoWBC$featSigAssoRes), nrow(soaResB12WBC25$featSigAssoRes),
                                        nrow(soaResB12WBC15$featSigAssoRes), nrow(soaResB12NoWBC$featSigAssoRes))) %&gt;%
  dplyr::mutate(Batch = stringr::str_remove(Dataset, &#39;, .+&#39;),
                Batch = stringr::str_replace(Batch, &#39;^B&#39;, &#39;Batch&#39;))

ggplot(sigFeatPropTab, aes(x=Dataset, y=Proportion, fill=Batch)) +
  geom_bar(stat = &#39;identity&#39;) +
  coord_flip() +
  scale_fill_grey(start = 0.3, end = 0.5) +
  labs(y = &#39;Percentage (%)&#39;, title = &#39;Recurrence vs Non-recurrence&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-89-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Display absolute counts of <strong>recurrence-related</strong>
significant features</p>
<pre class="r"><code>ggplot(sigFeatPropTab, aes(x=Dataset, y=AbsNum, fill=Batch)) +
  geom_bar(stat = &#39;identity&#39;) +
  coord_flip() +
  scale_fill_grey(start = 0.3, end = 0.5) +
  labs(y = &#39;Count&#39;, title = &#39;Recurrence vs Non-recurrence&#39;) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-90-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>Show <strong>recurrence-related</strong> significant PCs</p>
<pre class="r"><code># Prepare summarized PC significance data
sigPCTabB1WBC25 &lt;- soaResB1WBC25$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;B1, WBC-25%&#39;)
sigPCTabB1WBC15 &lt;-soaResB1WBC15$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;B1, WBC-15%&#39;)
sigPCTabB1NoWBC &lt;-soaResB1NoWBC$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;B1, WBC-No&#39;)
sigPCTabB12WBC25 &lt;-soaResB12WBC25$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;B1&amp;2, WBC-25%&#39;)
sigPCTabB12WBC15 &lt;-soaResB12WBC15$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;B1&amp;2, WBC-15%&#39;)
sigPCTabB12NoWBC &lt;-soaResB12NoWBC$pcSigAssoRes %&gt;%
  dplyr::mutate(Dataset = &#39;B1&amp;2, WBC-No&#39;)
dplyr::bind_rows(sigPCTabB1WBC25, sigPCTabB1WBC15, sigPCTabB1NoWBC,
                 sigPCTabB12WBC25, sigPCTabB12WBC15, sigPCTabB12NoWBC) %&gt;%
  dplyr::relocate(Dataset)</code></pre>
<pre><code>        Dataset        Var1       Var2    pVal pValAdj  Stat   Test
1   B1, WBC-25%    PC5 (7%) Recurrence 0.00727   0.145  2.78 T-test
2    B1, WBC-No  PC7 (4.5%) Recurrence 0.04100   0.707 -2.09 T-test
3 B1&amp;2, WBC-25% PC17 (1.5%) Recurrence 0.01330   0.144 -2.55 T-test
4 B1&amp;2, WBC-25%    PC5 (7%) Recurrence 0.01440   0.144 -2.52 T-test
5  B1&amp;2, WBC-No  PC5 (5.2%) Recurrence 0.04920   0.708  2.01 T-test</code></pre>
<pre class="r"><code>ggplot(soaResB1WBC25$pcTab, aes(x=Recurrence, y=`PC5 (7%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_manual(values=c(&#39;#00BFC4&#39;, &#39;#F8766D&#39;)) +
  scale_fill_manual(values=c(&#39;#00BFC4&#39;, &#39;#F8766D&#39;)) +
  ggpubr::stat_compare_means(method = &#39;t.test&#39;, paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-91-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(soaResB12WBC25$pcTab, aes(x=Recurrence, y=`PC5 (7%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_manual(values=c(&#39;#00BFC4&#39;, &#39;#F8766D&#39;)) +
  scale_fill_manual(values=c(&#39;#00BFC4&#39;, &#39;#F8766D&#39;)) +
  ggpubr::stat_compare_means(method = &#39;t.test&#39;, paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th</code></pre>
<p><img src="figure/Discovery_01_preprocessing_untargeted.Rmd/unnamed-chunk-91-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.3.2 (2023-10-31)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/Berlin
tzcode source: internal

attached base packages:
[1] stats4    grid      stats     graphics  grDevices utils     datasets 
[8] methods   base     

other attached packages:
 [1] proDA_1.16.0                pcaMethods_1.94.0          
 [3] pheatmap_1.0.12             ggplotify_0.1.2            
 [5] lubridate_1.9.3             forcats_1.0.0              
 [7] stringr_1.5.1               purrr_1.0.2                
 [9] tidyr_1.3.1                 tibble_3.2.1               
[11] tidyverse_2.0.0             SummarizedExperiment_1.32.0
[13] GenomicRanges_1.54.1        GenomeInfoDb_1.38.8        
[15] IRanges_2.36.0              S4Vectors_0.40.2           
[17] MatrixGenerics_1.14.0       matrixStats_1.3.0          
[19] ggvenn_0.1.10               dplyr_1.1.4                
[21] ggrepel_0.9.5               ggplot2_3.5.1              
[23] visdat_0.6.0                sva_3.50.0                 
[25] BiocParallel_1.36.0         genefilter_1.84.0          
[27] mgcv_1.9-1                  nlme_3.1-164               
[29] limma_3.58.1                vsn_3.70.0                 
[31] Biobase_2.62.0              BiocGenerics_0.48.1        
[33] readxl_1.4.3                readr_2.1.5                
[35] workflowr_1.7.1            

loaded via a namespace (and not attached):
  [1] RColorBrewer_1.1-3      rstudioapi_0.16.0       jsonlite_1.8.8         
  [4] magrittr_2.0.3          farver_2.1.1            rmarkdown_2.26         
  [7] fs_1.6.3                zlibbioc_1.48.2         vctrs_0.6.5            
 [10] memoise_2.0.1           RCurl_1.98-1.14         rstatix_0.7.2          
 [13] htmltools_0.5.8.1       S4Arrays_1.2.1          broom_1.0.5            
 [16] cellranger_1.1.0        SparseArray_1.2.4       gridGraphics_0.5-1     
 [19] sass_0.4.9              bslib_0.7.0             extraDistr_1.10.0      
 [22] cachem_1.0.8            whisker_0.4.1           lifecycle_1.0.4        
 [25] pkgconfig_2.0.3         Matrix_1.6-5            R6_2.5.1               
 [28] fastmap_1.1.1           GenomeInfoDbData_1.2.11 digest_0.6.35          
 [31] colorspace_2.1-0        AnnotationDbi_1.64.1    ps_1.7.6               
 [34] rprojroot_2.0.4         RSQLite_2.3.6           ggpubr_0.6.0           
 [37] labeling_0.4.3          fansi_1.0.6             timechange_0.3.0       
 [40] httr_1.4.7              abind_1.4-5             compiler_4.3.2         
 [43] bit64_4.0.5             withr_3.0.0             backports_1.4.1        
 [46] carData_3.0-5           DBI_1.2.2               hexbin_1.28.3          
 [49] highr_0.10              ggsignif_0.6.4          DelayedArray_0.28.0    
 [52] tools_4.3.2             httpuv_1.6.15           glue_1.7.0             
 [55] callr_3.7.6             promises_1.3.0          getPass_0.2-4          
 [58] generics_0.1.3          gtable_0.3.5            tzdb_0.4.0             
 [61] preprocessCore_1.64.0   hms_1.1.3               car_3.1-2              
 [64] utf8_1.2.4              XVector_0.42.0          pillar_1.9.0           
 [67] yulab.utils_0.1.4       later_1.3.2             splines_4.3.2          
 [70] lattice_0.22-6          survival_3.5-8          bit_4.0.5              
 [73] annotate_1.80.0         tidyselect_1.2.1        locfit_1.5-9.9         
 [76] Biostrings_2.70.3       knitr_1.46              git2r_0.33.0           
 [79] edgeR_4.0.16            xfun_0.43               statmod_1.5.0          
 [82] stringi_1.8.3           yaml_2.3.8              evaluate_0.23          
 [85] codetools_0.2-20        BiocManager_1.30.22     cli_3.6.2              
 [88] affyio_1.72.0           xtable_1.8-4            munsell_0.5.1          
 [91] processx_3.8.4          jquerylib_0.1.4         Rcpp_1.0.12            
 [94] png_0.1-8               XML_3.99-0.16.1         parallel_4.3.2         
 [97] blob_1.2.4              bitops_1.0-7            viridisLite_0.4.2      
[100] scales_1.3.0            affy_1.80.0             crayon_1.5.2           
[103] rlang_1.1.3             KEGGREST_1.42.0        </code></pre>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.3.2 (2023-10-31)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/Berlin
tzcode source: internal

attached base packages:
[1] stats4    grid      stats     graphics  grDevices utils     datasets 
[8] methods   base     

other attached packages:
 [1] proDA_1.16.0                pcaMethods_1.94.0          
 [3] pheatmap_1.0.12             ggplotify_0.1.2            
 [5] lubridate_1.9.3             forcats_1.0.0              
 [7] stringr_1.5.1               purrr_1.0.2                
 [9] tidyr_1.3.1                 tibble_3.2.1               
[11] tidyverse_2.0.0             SummarizedExperiment_1.32.0
[13] GenomicRanges_1.54.1        GenomeInfoDb_1.38.8        
[15] IRanges_2.36.0              S4Vectors_0.40.2           
[17] MatrixGenerics_1.14.0       matrixStats_1.3.0          
[19] ggvenn_0.1.10               dplyr_1.1.4                
[21] ggrepel_0.9.5               ggplot2_3.5.1              
[23] visdat_0.6.0                sva_3.50.0                 
[25] BiocParallel_1.36.0         genefilter_1.84.0          
[27] mgcv_1.9-1                  nlme_3.1-164               
[29] limma_3.58.1                vsn_3.70.0                 
[31] Biobase_2.62.0              BiocGenerics_0.48.1        
[33] readxl_1.4.3                readr_2.1.5                
[35] workflowr_1.7.1            

loaded via a namespace (and not attached):
  [1] RColorBrewer_1.1-3      rstudioapi_0.16.0       jsonlite_1.8.8         
  [4] magrittr_2.0.3          farver_2.1.1            rmarkdown_2.26         
  [7] fs_1.6.3                zlibbioc_1.48.2         vctrs_0.6.5            
 [10] memoise_2.0.1           RCurl_1.98-1.14         rstatix_0.7.2          
 [13] htmltools_0.5.8.1       S4Arrays_1.2.1          broom_1.0.5            
 [16] cellranger_1.1.0        SparseArray_1.2.4       gridGraphics_0.5-1     
 [19] sass_0.4.9              bslib_0.7.0             extraDistr_1.10.0      
 [22] cachem_1.0.8            whisker_0.4.1           lifecycle_1.0.4        
 [25] pkgconfig_2.0.3         Matrix_1.6-5            R6_2.5.1               
 [28] fastmap_1.1.1           GenomeInfoDbData_1.2.11 digest_0.6.35          
 [31] colorspace_2.1-0        AnnotationDbi_1.64.1    ps_1.7.6               
 [34] rprojroot_2.0.4         RSQLite_2.3.6           ggpubr_0.6.0           
 [37] labeling_0.4.3          fansi_1.0.6             timechange_0.3.0       
 [40] httr_1.4.7              abind_1.4-5             compiler_4.3.2         
 [43] bit64_4.0.5             withr_3.0.0             backports_1.4.1        
 [46] carData_3.0-5           DBI_1.2.2               hexbin_1.28.3          
 [49] highr_0.10              ggsignif_0.6.4          DelayedArray_0.28.0    
 [52] tools_4.3.2             httpuv_1.6.15           glue_1.7.0             
 [55] callr_3.7.6             promises_1.3.0          getPass_0.2-4          
 [58] generics_0.1.3          gtable_0.3.5            tzdb_0.4.0             
 [61] preprocessCore_1.64.0   hms_1.1.3               car_3.1-2              
 [64] utf8_1.2.4              XVector_0.42.0          pillar_1.9.0           
 [67] yulab.utils_0.1.4       later_1.3.2             splines_4.3.2          
 [70] lattice_0.22-6          survival_3.5-8          bit_4.0.5              
 [73] annotate_1.80.0         tidyselect_1.2.1        locfit_1.5-9.9         
 [76] Biostrings_2.70.3       knitr_1.46              git2r_0.33.0           
 [79] edgeR_4.0.16            xfun_0.43               statmod_1.5.0          
 [82] stringi_1.8.3           yaml_2.3.8              evaluate_0.23          
 [85] codetools_0.2-20        BiocManager_1.30.22     cli_3.6.2              
 [88] affyio_1.72.0           xtable_1.8-4            munsell_0.5.1          
 [91] processx_3.8.4          jquerylib_0.1.4         Rcpp_1.0.12            
 [94] png_0.1-8               XML_3.99-0.16.1         parallel_4.3.2         
 [97] blob_1.2.4              bitops_1.0-7            viridisLite_0.4.2      
[100] scales_1.3.0            affy_1.80.0             crayon_1.5.2           
[103] rlang_1.1.3             KEGGREST_1.42.0        </code></pre>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
https://docs.mathjax.org/en/latest/web/configuration.html. This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>




</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
