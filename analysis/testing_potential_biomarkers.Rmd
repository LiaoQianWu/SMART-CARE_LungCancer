---
title: 'Testing: Potential biomarkers'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: yes
    toc_float: yes
    code_folding: hide
---

<font size='4'> Description: Test predictive ability of potential biomarkers identified
from Method Development cohort in lung Adenocarcinoma recurrence using Discovery cohort. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_Discovery')
```

Load libraries
```{r load libraries, message=F}
library(ggvenn)
library(SummarizedExperiment)
library(tidyverse)
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

# Normal Tissue Proteomics

## AG Krijgsveld
1089 potential Normal Tissue Proteins were identified in Method Development Normal
Tissue DIA Proteomics generated by AG Klingmüller and AG Krijgsveld, and 778 of
them were captured in Discovery dataset.

Show predictive ability of these 778 proteins in Discovery Normal Tissue DIA Proteomics
```{r}
# Load normalized data
proTissue <- readRDS('./data/AG_Krijgsveld/proTissueVsn.rds')
# Subset data
smpNormalIdx <- which(colData(proTissue)$Condition == 'Normal')
proNormal <- proTissue[, smpNormalIdx, drop = F]
# Keep first protein as representative if there are more than one
rownames(proNormal) <- stringr::str_remove_all(rownames(proNormal), ';.+')
# Retrieve needed information
smpMetadat <- tibble::as_tibble(colData(proNormal), rownames = 'Sample') %>%
  dplyr::select(Sample, Recurrence)
featMetadat <- tibble::as_tibble(rowData(proNormal), rownames = 'Protein') %>%
  dplyr::select(Protein, Genes) %>%
  dplyr::mutate(Genes = stringr::str_remove_all(Genes, ';.+'))

# Prepare significant features identified from Method Development cohort
methodDev_sigFeats_Klin <- readRDS('./data/potential_biomarkers/sigFeats_DIANP_Klin.rds') %>%
  dplyr::pull(name)
methodDev_sigFeats_Krij <- readRDS('./data/potential_biomarkers/sigFeats_DIANP_Krij.rds') %>%
  dplyr::pull(name)
methodDev_sigFeats <- unique(c(methodDev_sigFeats_Klin, methodDev_sigFeats_Krij))
methodDev_sigFeats <- intersect(methodDev_sigFeats, rownames(proNormal))
# Do association tests
dat <- t(SummarizedExperiment::assay(proNormal)) %>%
  tibble::as_tibble(rownames = 'Sample')
proNormalAssoRes <- testAssociation(dat, smpMetadat, cmn_col = 'Sample', use_proDA = T) %>%
  dplyr::select(-c(Var2, Test)) %>%
  dplyr::rename(Protein = Var1, tStat = Stat) %>%
  dplyr::mutate(Gene = plyr::mapvalues(Protein, from = featMetadat$Protein,
                                       to = featMetadat$Genes, warn_missing = F)) %>%
  dplyr::relocate(Gene, .after = Protein)
proNormalAssoResSub <- dplyr::filter(proNormalAssoRes, Protein %in% methodDev_sigFeats) %>%
  dplyr::mutate(pVal = round(pVal, 4),
                pValAdj = round(pValAdj, 4),
                tStat = round(tStat, 4))
# Show association test results
proNormalAssoResSub %>%
  DT::datatable()
```

Visualize predictive ability of top significant proteins
```{r fig.height=10}
# Prepare data table for making boxplots
nTopSigFeats <- 9
assoRes <- dplyr::select(proNormalAssoResSub, Protein, Gene, pVal) %>%
  dplyr::slice_head(n = nTopSigFeats) %>%
  dplyr::mutate(Name = paste0(Protein, ' (', Gene, ')', '\np = ', round(pVal, 4)))
proNormalTab4Plot <- SummarizedExperiment::assay(proNormal) %>%
  tibble::as_tibble(rownames = 'Protein') %>%
  tidyr::pivot_longer(cols = -'Protein', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(smpMetadat, by = 'Sample') %>%
  dplyr::left_join(assoRes, by = 'Protein') %>%
  dplyr::filter(Protein %in% assoRes$Protein) %>%
  dplyr::mutate(Name = factor(Name, levels = assoRes$Name))

ggplot(proNormalTab4Plot, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Name), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Show intersections of potential proteins identified in different datasets
```{r}
# Prepare significant feature list for making venn graph
discovery_sigFeats <- dplyr::filter(proNormalAssoRes, pVal <= 0.05) %>%
  dplyr::pull(Protein)

ggvenn(list(Discovery = discovery_sigFeats, MethodDev_Klin. = methodDev_sigFeats_Klin,
            MethodDev_Krij. = methodDev_sigFeats_Krij),
       fill_color = c('darkred', 'darkblue', 'darkgreen'), fill_alpha = 0.6,
       set_name_color = c('darkred', 'darkblue', 'darkgreen'), set_name_size = 9,
       text_size = 5, stroke_size = 1.5)
```
=> That one protein identified in all datasets is 'P37235 (HPCAL1)'.

## AG Klingmüller
Test predictive ability of 814 potential Normal Tissue Proteins identified in Method
Development Normal Tissue DIA Proteomics (Batch1) on Discovery one (Batch2) both
generated by AG Klingmüller. In this way, working group differences can be excluded.

Show predictive ability of potential proteins in Discovery Normal Tissue DIA Proteomics
```{r message=F}
# Load normalized data
proTissue <- readRDS('./data/AG_Klingmueller/proTissueVsn.rds')
# Retrieve Method Development cohort samples
smpMetadat <- readxl::read_excel('./data/sample_metadata.xlsx')
colnames(smpMetadat) <- smpMetadat[3,, drop = F]
methodDev_smps <- dplyr::slice(smpMetadat, -c(1:3)) %>%
  dplyr::filter(`SMART-CARE cohort identifier` == 'METHOD_DEVELOPMENT_COHORT',
                grepl('_TG|_NG', Code)) %>%
  dplyr::pull(Code) %>%
  stringr::str_remove('^SC_T_S_')
# Subset Discovery cohort Normal tissue samples
proTissue <- proTissue[, !colnames(proTissue) %in% methodDev_smps, drop = F]
smpNormalIdx <- which(colData(proTissue)$Condition == 'Normal')
proNormal <- proTissue[, smpNormalIdx, drop = F]
# Keep first protein as representative if there are more than one
rownames(proNormal) <- stringr::str_remove_all(rownames(proNormal), ';.+')
# Retrieve needed information
smpMetadat <- tibble::as_tibble(colData(proNormal), rownames = 'Sample') %>%
  dplyr::select(Sample, Recurrence)
featMetadat <- tibble::as_tibble(rowData(proNormal), rownames = 'Protein') %>%
  dplyr::select(Protein, PG.Genes) %>%
  dplyr::rename(Genes = PG.Genes) %>%
  dplyr::mutate(Genes = stringr::str_remove_all(Genes, ';.+'))

# Prepare significant features identified from Method Development cohort
methodDev_sigFeats_Klin <- readRDS('./data/potential_biomarkers/sigFeats_DIANP_Klin.rds') %>%
  dplyr::pull(name)
# Do association tests
dat <- t(SummarizedExperiment::assay(proNormal)) %>%
  tibble::as_tibble(rownames = 'Sample')
proNormalAssoRes <- testAssociation(dat, smpMetadat, cmn_col = 'Sample', use_proDA = T) %>%
  dplyr::select(-c(Var2, Test)) %>%
  dplyr::rename(Protein = Var1, tStat = Stat) %>%
  dplyr::mutate(Gene = plyr::mapvalues(Protein, from = featMetadat$Protein,
                                       to = featMetadat$Genes, warn_missing = F)) %>%
  dplyr::relocate(Gene, .after = Protein)
proNormalAssoResSub <- dplyr::filter(proNormalAssoRes, Protein %in% methodDev_sigFeats_Klin) %>%
  dplyr::mutate(pVal = round(pVal, 4),
                pValAdj = round(pValAdj, 4),
                tStat = round(tStat, 4))
# Show association test results
proNormalAssoResSub %>%
  DT::datatable()
```

Visualize predictive ability of top significant proteins
```{r fig.height=10}
# Prepare data table for making boxplots
nTopSigFeats <- 2:10
assoRes <- dplyr::select(proNormalAssoResSub, Protein, Gene, pVal) %>%
  dplyr::slice(nTopSigFeats) %>%
  dplyr::mutate(Name = paste0(Protein, ' (', Gene, ')', '\np = ', round(pVal, 4)))
proNormalTab4Plot <- SummarizedExperiment::assay(proNormal) %>%
  tibble::as_tibble(rownames = 'Protein') %>%
  tidyr::pivot_longer(cols = -'Protein', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(smpMetadat, by = 'Sample') %>%
  dplyr::left_join(assoRes, by = 'Protein') %>%
  dplyr::filter(Protein %in% assoRes$Protein) %>%
  dplyr::mutate(Name = factor(Name, levels = assoRes$Name))

ggplot(proNormalTab4Plot, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Name), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```
=> Recurrence patient group got only one quantified value of Protein 'Q8WVK2 (SNRNP27)'.

Show intersections of potential proteins identified in datasets of different batches
```{r}
# Prepare significant feature list for making venn graph
discovery_sigFeats <- dplyr::filter(proNormalAssoRes, pVal <= 0.05) %>%
  dplyr::pull(Protein)

ggvenn(list(Discovery = discovery_sigFeats, MethodDev = methodDev_sigFeats_Klin),
       fill_color = c('darkred', 'darkblue'), fill_alpha = 0.6,
       set_name_color = c('darkred', 'darkblue'), set_name_size = 10,
       text_size = 10, stroke_size = 1.5)
```
