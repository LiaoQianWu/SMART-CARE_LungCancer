---
title: 'MOFA: Downstream analysis'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Do multi-omics integration using MOFA. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer')
```

Load libraries
```{r library loading, message = F}
library('MOFA2')
library('reticulate')
# use_python('/Users/qianwu/opt/anaconda3/bin/python')
library('AnnotationDbi')
library('org.Hs.eg.db')
# This annotation object is accessed using AnnotationDbi:select()
hs <- org.Hs.eg.db
library('msigdbr')
library('clusterProfiler')
library('ggrepel')
library('SummarizedExperiment')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')
source('./code/mofa_funcs.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

# Comp. Klin. Pro. + Anno. Hopf Lip.
Complete DIA Proteomics from AG KlingmÃ¼ller + Annotated Untargeted Lipidomics from
AG Hopf (MethodDev + Discovery)

```{r message=F}
# Prepare data tables to train MOFA models
# Load normalized datasets
comb_proTissue_Klin <- readRDS('./data/Discovery/AG_Klingmueller/proTissueVsn.rds')
comb_proNormal_Klin <- comb_proTissue_Klin[, colData(comb_proTissue_Klin)$Condition == 'Normal']
comb_proTumor_Klin <- comb_proTissue_Klin[, colData(comb_proTissue_Klin)$Condition == 'Tumor']
comb_lipTissue_Hopf <- readRDS(paste0('./data/Discovery/AG_Hopf/partial_annotated/',
                                      'Comb_Prepro_lipTissueVsn_Anno_MDevB123_BC.rds'))
comb_lipNormal_Hopf <- comb_lipTissue_Hopf[, colData(comb_lipTissue_Hopf)$Condition == 'Normal']
comb_lipTumor_Hopf <- comb_lipTissue_Hopf[, colData(comb_lipTissue_Hopf)$Condition == 'Tumor']

# Sanity check dimensionality of each dataset (Feature x Sample)
# dataList <- list(Comb_Tissue_Proteomics_Klin = comb_proTissue_Klin,
#                  Comb_Tissue_Lipidomics_Hopf = comb_lipTissue_Hopf)
# lapply(dataList, dim)

# Prepare significant features for initial feature selection and corrected data
# matrix for model training
soaRes <- readRDS('./data/Discovery/AG_Klingmueller/soaRes/proNormalRes_Stage.rds')
sigFeats_comb_proNormal_Klin <- soaRes$sig.feat.tab$Var1
correct_comb_proNormal_Klin <- comb_proNormal_Klin
assay(correct_comb_proNormal_Klin) <- soaRes$SOA.res$dataCorrect
soaRes <- readRDS('./data/Discovery/AG_Hopf/partial_annotated/soaRes/lipNormalResSVs_Recur_Comb.rds')
sigFeats_comb_lipNormal_Hopf <- soaRes$sig.feat.tab$Var1
correct_comb_lipNormal_Hopf <- comb_lipNormal_Hopf
assay(correct_comb_lipNormal_Hopf) <- soaRes$SOA.res$dataCorrect

soaRes <- readRDS('./data/Discovery/AG_Klingmueller/soaRes/proTumorRes_SVs.rds')
sigFeats_comb_proTumor_Klin <- soaRes$sig.feat.tab$Var1
correct_comb_proTumor_Klin <- comb_proTumor_Klin
assay(correct_comb_proTumor_Klin) <- soaRes$SOA.res$dataCorrect
soaRes <- readRDS('./data/Discovery/AG_Hopf/partial_annotated/soaRes/lipTumorResSVs_Recur_Comb.rds')
sigFeats_comb_lipTumor_Hopf <- soaRes$sig.feat.tab$Var1
correct_comb_lipTumor_Hopf <- comb_lipTumor_Hopf
assay(correct_comb_lipTumor_Hopf) <- soaRes$SOA.res$dataCorrect

# Convert SE objects to long data for creating MOFA object through 'create_mofa_from_df'
# to include metadata
comb_proNormalTab_Klin <- mofa_summExp2df(comb_proNormal_Klin, smp_type = 'Tissue',
                                          data_acqui = 'Combined DIA', data_modal = 'Proteomics')
comb_lipNormalTab_Hopf <- mofa_summExp2df(comb_lipNormal_Hopf, smp_type = 'Tissue',
                                          data_acqui = 'Combined Untargeted', data_modal = 'Lipidomics')
correct_comb_proNormalTab_Klin <- mofa_summExp2df(correct_comb_proNormal_Klin, smp_type = 'Tissue',
                                                  data_acqui = 'Combined DIA', data_modal = 'Proteomics')
correct_comb_lipNormalTab_Hopf <- mofa_summExp2df(correct_comb_lipNormal_Hopf, smp_type = 'Tissue',
                                                  data_acqui = 'Combined Untargeted', data_modal = 'Lipidomics')

correct_comb_proTumorTab_Klin <- mofa_summExp2df(correct_comb_proTumor_Klin, smp_type = 'Tissue',
                                                 data_acqui = 'Combined DIA', data_modal = 'Proteomics')
correct_comb_lipTumorTab_Hopf <- mofa_summExp2df(correct_comb_lipTumor_Hopf, smp_type = 'Tissue',
                                                 data_acqui = 'Combined Untargeted', data_modal = 'Lipidomics')

# Prepare sample spaces from different datasets to remove unwanted samples later 
smps_CombNTP <- stringr::str_replace(colnames(comb_proNormal_Klin), '_NG', '_B')
smps_CombNTL <- stringr::str_replace(colnames(comb_lipNormal_Hopf), '_NG', '_B')
```

## NTP + NTL (Semi-Super, Correct)
DIA Normal Tissue Proteomics + Untargeted Normal Tissue Lipidomics\
**Note that NTP was corrected for Pathological Stage and NTL was corrected for SVs,**
**and only statistically significant recurrence-related features were used to train**
**a MOFA model. Check SOA results for more details**

```{r}
# Train MOFA model
# Prepare training data, e.g., removing unwanted samples, using significant features
# cmnSmps <- intersect(smps_CombNTP, smps_CombNTL)
# tmp_comb_proNormalTab_Klin <- dplyr::filter(correct_comb_proNormalTab_Klin,
#                                             feature %in% sigFeats_comb_proNormal_Klin)
# tmp_comb_lipNormalTab_Hopf <- dplyr::filter(correct_comb_lipNormalTab_Hopf,
#                                             feature %in% sigFeats_comb_lipNormal_Hopf,
#                                             sample %in% cmnSmps)
# 
# mofaObject <- trainMOFA(list(tmp_comb_proNormalTab_Klin, tmp_comb_lipNormalTab_Hopf),
#                         view_data = T, train_mofa = T, num_factors = 10,
#                         save_path = './data/Discovery/mofa/correct_sigFeats_CombDIANTPKlin_CombAnnoUntNTL')

# Load trained model
mofaObject <- readRDS('./data/Discovery/mofa/correct_sigFeats_CombDIANTPKlin_CombAnnoUntNTL.rds')
```

Overview model
```{r}
# Overview model
MOFA2::plot_data_overview(mofaObject)
```

Quantify amount of variance explained by each factor in each data modality
```{r}
# Do sanity check for factor correlations
# MOFA2::plot_factor_cor(mofaObject)

# Perform variance dedecomposition analysis (coefficient of determination)
MOFA2::plot_variance_explained(mofaObject, max_r2 = 10)
# MOFA2::get_variance_explained(mofaObject)
```

Display and visualize significant recurrence-related factors
```{r}
# Display significant associations between learned factors (Var1) and cancer recurrence
# (Var2) and visualize significant recurrence-related factors
sigFactor <- mofa_vizSigFactor(mofaObject, smpGroup = 'Baseline Group', show_res = F)
sigFactor$sigAssoRes

# Visualize significant recurrence-related factors
facTab <- dplyr::mutate(sigFactor$tab4Plot, Recurrence = factor(Recurrence, levels = c('Yes', 'No')))
ggplot(facTab, aes(x=Recurrence, y=Factor1, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 4, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             size = 9, show.legend = F, hjust = 0.4, vjust = 1) +
  scale_color_manual(values=c('#F8766D', '#00BFC4')) +
  scale_fill_manual(values=c('#F8766D', '#00BFC4')) +
  th +
  theme(axis.title = element_text(size = 28),
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 26), legend.text = element_text(size = 24))

ggplot(facTab, aes(x=Recurrence, y=Factor2, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 4, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             size = 9, show.legend = F, hjust = 0.4, vjust = 1) +
  scale_color_manual(values=c('#F8766D', '#00BFC4')) +
  scale_fill_manual(values=c('#F8766D', '#00BFC4')) +
  th
```

Compare Factors with recurrence-related PCs from SOA results
```{r}
# Visualize correlation between significant factor (MOFA) and significant PC (PCA)
# Prepare significant factor table
facTab <- sigFactor$tab4Plot %>%
  dplyr::select(sample, Factor1, Factor2, Recurrence) %>%
  dplyr::mutate(sample = stringr::str_replace(sample, '_B', '_NG'))
# Prepare significant PC table
proNormalRes_Klin <- readRDS('./data/Discovery/AG_Klingmueller/soaRes/proNormalRes_Stage.rds')
# Show significant PCs
# proNormalRes_Klin$sig.pc.tab
pcTab <- proNormalRes_Klin$SOA.res$pcTab %>%
  dplyr::select(Sample, `PC1 (14.3%)`, `PC10 (3.6%)`) %>%
  dplyr::rename(sample = Sample)
# Combine all information
combinedTab <- dplyr::left_join(facTab, pcTab, by = 'sample')
# Make a plot and compute correlation
ggplot(combinedTab, aes(x=Factor1, y=`PC1 (14.3%)`)) +
  geom_point(aes(col=Recurrence), size = 4) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 7) +
  th


# Prepare significant PC table
# lipNormalRes_Hopf <- readRDS('./data/Discovery/AG_Hopf/partial_annotated/soaRes/lipNormalResSVs_Recur_Comb.rds')
# # Show significant PCs
# # lipNormalRes_Hopf$sig.pc.tab
# pcTab <- lipNormalRes_Hopf$SOA.res$pcTab %>%
#   dplyr::select(Sample, `PC2 (10.9%)`, `PC5 (7%)`) %>%
#   dplyr::rename(sample = Sample)
# # Combine all information
# combinedTab <- dplyr::left_join(facTab, pcTab, by = 'sample')
# # Make a plot and compute correlation
# ggplot(combinedTab, aes(x=Factor2, y=`PC5 (7%)`)) +
#   geom_point(aes(col=Recurrence), size = 4) +
#   scale_color_manual(values=c('#00BFC4', '#F8766D')) +
#   scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
#   ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 7) +
#   th
```

Show enrichment analysis results
```{r message=F}
# Prepare ranked feature list
# Tidy up weight matrix and feature metadata to reduce information loss
proGeneTab <- rowData(comb_proNormal_Klin) %>%
  tibble::as_tibble(rownames = 'Proteins') %>%
  tibble::column_to_rownames('Proteins')
tidyWeiMat <- mofa_keepUniFeats(mofaObject, factor = 1, view = 'Combined DIA Normal Proteomics',
                                feat_anno = proGeneTab, to_genes = T)
# Rank feature weights
rankedGeneList <- mofa_rankFeatList(tidyWeiMat, factor = 1)

# Do GSEA
# Hallmark gene sets
gseaRes_H <- doEA(rankedGeneList, categoryDB = 'H', numSigGS = 20, rmPrefixGS = '^HALLMARK_')
gseaRes_H$plotTopSigGS +
  labs(title = 'Hallmark: Factor1')
```

## NTP + NTL (Un-Super, Correct)
DIA Normal Tissue Proteomics + Untargeted Normal Tissue Lipidomics\
**Note that NTP was corrected for Pathological Stage and NTL was corrected for SVs,**
**and all features were used to train a MOFA model. Check SOA results for more details**

```{r}
# Load trained model
mofaObject <- readRDS('./data/Discovery/mofa/correct_allFeats_CombDIANTPKlin_CombAnnoUntNTL.rds')
# Overview model
MOFA2::plot_data_overview(mofaObject)
# Perform variance dedecomposition analysis (coefficient of determination)
MOFA2::plot_variance_explained(mofaObject, max_r2 = 10)

# Display significant associations between learned factors (Var1) and cancer recurrence
# (Var2) and visualize significant recurrence-related factors
sigFactor <- mofa_vizSigFactor(mofaObject, smpGroup = 'Baseline Group', show_res = F)
sigFactor$sigAssoRes
# Visualize significant recurrence-related factors
sigFactor$plotList$Factor1
sigFactor$plotList$Factor7
```

```{r message=F}
# Prepare ranked feature list
# Tidy up weight matrix and feature metadata to reduce information loss
proGeneTab <- rowData(comb_proNormal_Klin) %>%
  tibble::as_tibble(rownames = 'Proteins') %>%
  tibble::column_to_rownames('Proteins')
tidyWeiMat <- mofa_keepUniFeats(mofaObject, factor = 1, view = 'Combined DIA Normal Proteomics',
                                feat_anno = proGeneTab, to_genes = T)
# Rank feature weights
rankedGeneList <- mofa_rankFeatList(tidyWeiMat, factor = 1)

# Do GSEA
# Hallmark gene sets
gseaRes_H <- doEA(rankedGeneList, categoryDB = 'H', numSigGS = 20, rmPrefixGS = '^HALLMARK_')
gseaRes_H$plotTopSigGS +
  labs(title = 'Hallmark: Factor1')
```

```{r message=F}
# Prepare ranked feature list
# Tidy up weight matrix and feature metadata to reduce information loss
proGeneTab <- rowData(comb_proNormal_Klin) %>%
  tibble::as_tibble(rownames = 'Proteins') %>%
  tibble::column_to_rownames('Proteins')
tidyWeiMat <- mofa_keepUniFeats(mofaObject, factor = 7, view = 'Combined DIA Normal Proteomics',
                                feat_anno = proGeneTab, to_genes = T)
# Rank feature weights
rankedGeneList <- mofa_rankFeatList(tidyWeiMat, factor = 7)

# Do GSEA
# Hallmark gene sets
gseaRes_H <- doEA(rankedGeneList, categoryDB = 'H', numSigGS = 20, rmPrefixGS = '^HALLMARK_')
gseaRes_H$plotTopSigGS +
  labs(title = 'Hallmark: Factor7')
```

```{r}
# Compare factors learned from different MOFA models
mofaObj1 <- readRDS('./data/Discovery/mofa/correct_sigFeats_CombDIANTPKlin_CombAnnoUntNTL.rds')
mofaObj2 <- readRDS('./data/Discovery/mofa/correct_allFeats_CombDIANTPKlin_CombAnnoUntNTL.rds')
# mofaObj3 <- readRDS('./data/Discovery/mofa/sigFeats_CombDIANTPKlin_CombAnnoUntNTL.rds')
# mofaObj4 <- readRDS('./data/Discovery/mofa/allFeats_CombDIANTPKlin_CombAnnoUntNTL.rds')

# MOFA2::plot_variance_explained(mofaObj1, max_r2 = 10) +
#   labs(title = 'Semi-Super, Correct: Factor1&2 Sig.')
# MOFA2::plot_variance_explained(mofaObj2, max_r2 = 10) +
#   labs(title = 'Un-Super, Correct: Factor1&7 Sig.')
# MOFA2::plot_variance_explained(mofaObj3, max_r2 = 10) +
#   labs(title = 'Semi-Super: Factor2 Sig.')
# MOFA2::plot_variance_explained(mofaObj4, max_r2 = 10) +
#   labs(title = 'Un-Super: Factor3&8 Sig.')
# MOFA2::get_variance_explained(mofaObj2)

MOFA2::compare_factors(list(Cor_Semi_Sup = mofaObj1, Cor_Un_Sup = mofaObj2))
                            # Semi_Sup = mofaObj3, Un_Sup = mofaObj4

# => Differences in factors from models trained on corrected and uncorrected data
# depends on associated views and how data was corrected. For example, two models
# either trained on uncorrected NTP or corrected NTP for Stage both got Factor1
# associated with recurrence. Relationship of two Factor1 is high, but one learned
# from corrected data performs better. As similar concept, supposed we trained two
# models on uncorrected NTL and corrected NTL for SVs. Since data adjustment is
# more complicated, significant Factor2 from corrected data and insignificant Factor6
# from uncorrected data are mildly correlated.

# => Both semi- and un-supervised models can capture significant Factor1 explaining,
# variance in NTP, but semi-supervised one performs better. It might be because
# NTP is more homogeneous. On other hand, semi-supervised model can capture Factor2
# explaining variance in NTL, but un-supervised one. It might be that NTL data without
# adjustment is too noisy.
```

## NTP + TTP + NTL + TTL (Semi-Super, Correct)
DIA Normal and Tumor Tissue Proteomics + Untargeted Normal and Tumor Tissue Lipidomics\
**Note that NTP was corrected for Pathological Stage and TTP, NTL, and TTL was corrected**
**for SVs, and only statistically significant recurrence-related features were used**
**to train a MOFA model. Check SOA results for more details**

```{r}
# Train MOFA model
# Prepare training data, e.g., removing unwanted samples, using significant features
# tmp_comb_proNormalTab_Klin <- dplyr::filter(correct_comb_proNormalTab_Klin,
#                                             feature %in% sigFeats_comb_proNormal_Klin)
# tmp_comb_lipNormalTab_Hopf <- dplyr::filter(correct_comb_lipNormalTab_Hopf,
#                                             feature %in% sigFeats_comb_lipNormal_Hopf)
# 
# tmp_comb_proTumorTab_Klin <- dplyr::filter(correct_comb_proTumorTab_Klin,
#                                            feature %in% sigFeats_comb_proTumor_Klin)
# tmp_comb_lipTumorTab_Hopf <- dplyr::filter(correct_comb_lipTumorTab_Hopf,
#                                            feature %in% sigFeats_comb_lipTumor_Hopf)
# 
# mofaObject <- trainMOFA(list(tmp_comb_proNormalTab_Klin, tmp_comb_lipNormalTab_Hopf,
#                              tmp_comb_proTumorTab_Klin, tmp_comb_lipTumorTab_Hopf),
#                         view_data = T, train_mofa = T, num_factors = 10,
#                         save_path = paste0('./data/Discovery/mofa/correct_sigFeats_',
#                                            'CombDIANTPKlin_CombAnnoUntNTL_TTP_TTL'))

# Load trained model
mofaObject <- readRDS(paste0('./data/Discovery/mofa/correct_sigFeats_',
                             'CombDIANTPKlin_CombAnnoUntNTL_TTP_TTL.rds'))
# Overview model
a <- MOFA2::plot_data_overview(mofaObject)
a$data$view_label <- factor(a$data$view_label, levels = c('Combined Untargeted Tumor Lipidomics\nD=21',
                                                          'Combined Untargeted Normal Lipidomics\nD=38',
                                                          'Combined DIA Tumor Proteomics\nD=438',
                                                          'Combined DIA Normal Proteomics\nD=736'))
a #+ theme(text = element_text(size = 22, face = 'bold'))
# ggsave('./output/Discovery/25.07.24_LGM/mofa_data_combined_NTP_TTP_Klin_NTL_TTL_Hopf.png',
#        device = 'png', dpi = 400, height = 8, width = 10)

# Do sanity check for factor correlations
# MOFA2::plot_factor_cor(mofaObject)
# Perform variance dedecomposition analysis (coefficient of determination)
a <- MOFA2::plot_variance_explained(mofaObject, max_r2 = 10)
a$data$view <- stringr::str_remove(a$data$view, '^Combined ') %>%
  factor(levels = c('DIA Normal Proteomics', 'DIA Tumor Proteomics',
                    'Untargeted Normal Lipidomics', 'Untargeted Tumor Lipidomics'))
a #+ theme(axis.text.x = element_text(size = 16, angle = 30, vjust = 1, hjust = 1, face = 'bold'),
#           axis.text.y = element_text(size = 18, face = 'bold'),
#           legend.title = element_text(size = 18),
#           legend.text = element_text(size = 16))
# ggsave('./output/Discovery/25.07.24_LGM/mofa_varExplained_combined_NTP_TTP_Klin_NTL_TTL_Hopf.png',
#        device = 'png', dpi = 400, height = 12, width = 9)

# Display significant associations between learned factors (Var1) and cancer recurrence
# (Var2) and visualize significant recurrence-related factors
sigFactor <- mofa_vizSigFactor(mofaObject, smpGroup = 'Baseline Group', show_res = F)
sigFactor$sigAssoRes
# Visualize significant recurrence-related factors
facTab <- dplyr::mutate(sigFactor$tab4Plot, Recurrence = factor(Recurrence, levels = c('Yes', 'No')))
ggplot(facTab, aes(x=Recurrence, y=Factor3, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 4, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             size = 8, show.legend = F, hjust = 0.4, vjust = 1) +
  scale_color_manual(values=c('#F8766D', '#00BFC4')) +
  scale_fill_manual(values=c('#F8766D', '#00BFC4')) +
  th +
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 14),
        legend.title = element_text(size = 22),
        legend.text = element_text(size = 20))
# ggsave('./output/Discovery/25.07.24_LGM/mofa_sigFac3_combined_NTP_TTP_Klin_NTL_TTL_Hopf.png',
#        device = 'png', dpi = 400, height = 8, width = 11)

sigFactor$plotList$Factor1
sigFactor$plotList$Factor2

# View top features with highest absolute weights
# a <- plot_top_weights(mofaObject, view = 'Combined Untargeted Tumor Lipidomics',
#                  factors = 3)
# modFeatIDs <- stringr::str_remove(a$data$feature, '_Combined Untargeted Tumor Lipidomics')
# a$data$feature_id <- factor(modFeatIDs, levels = rev(modFeatIDs))
# a + theme(strip.text = element_text(size = 20, face = 'bold'),
#           axis.text.y = element_text(size = 18, face = 'bold'),
#           axis.title.x = element_text(size = 18),
#           axis.text.x = element_text(size = 14))
# ggsave('./output/Discovery/25.07.24_LGM/mofa_topFeatsFac3_combined_NTP_TTP_Klin_NTL_TTL_Hopf.png',
#        device = 'png', dpi = 400, height = 8, width = 11)
```

Show enrichment analysis results
```{r message=F}
# Prepare ranked feature list
# Tidy up weight matrix and feature metadata to reduce information loss
proGeneTab <- rowData(comb_proTumor_Klin) %>%
  tibble::as_tibble(rownames = 'Proteins') %>%
  tibble::column_to_rownames('Proteins')
tidyWeiMat <- mofa_keepUniFeats(mofaObject, factor = 3, view = 'Combined DIA Tumor Proteomics',
                                feat_anno = proGeneTab, to_genes = T)
# Rank feature weights
rankedGeneList <- mofa_rankFeatList(tidyWeiMat, factor = 3)

# Do GSEA
# Hallmark gene sets
gseaRes_H <- doEA(rankedGeneList, categoryDB = 'H', numSigGS = 20, rmPrefixGS = '^HALLMARK_')
gseaRes_H$plotTopSigGS +
  labs(title = 'Hallmark: Factor3')
```

## NTP + TTP + NTL + TTL (Un-Super, Correct)
DIA Normal and Tumor Tissue Proteomics + Untargeted Normal and Tumor Tissue Lipidomics\
**Note that NTP was corrected for Pathological Stage and TTP, NTL, and TTL was corrected**
**for SVs, and all features were used to train a MOFA model. Check SOA results for more details**

```{r}
# Load trained model
mofaObject <- readRDS(paste0('./data/Discovery/mofa/correct_allFeats_',
                             'CombDIANTPKlin_CombAnnoUntNTL_TTP_TTL.rds'))

# Overview model
MOFA2::plot_data_overview(mofaObject)

# Do sanity check for factor correlations
# MOFA2::plot_factor_cor(mofaObject)
# Perform variance dedecomposition analysis (coefficient of determination)
MOFA2::plot_variance_explained(mofaObject, max_r2 = 10) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1))

# Display significant associations between learned factors (Var1) and cancer recurrence
# (Var2) and visualize significant recurrence-related factors
sigFactor <- mofa_vizSigFactor(mofaObject, smpGroup = 'Baseline Group', show_res = F)
sigFactor$sigAssoRes
# Visualize significant recurrence-related factors
sigFactor$plotList$Factor1
sigFactor$plotList$Factor9
```

Show enrichment analysis results
```{r message=F}
# Prepare ranked feature list
# Tidy up weight matrix and feature metadata to reduce information loss
proGeneTab <- rowData(comb_proNormal_Klin) %>%
  tibble::as_tibble(rownames = 'Proteins') %>%
  tibble::column_to_rownames('Proteins')
tidyWeiMat <- mofa_keepUniFeats(mofaObject, factor = 1, view = 'Combined DIA Normal Proteomics',
                                feat_anno = proGeneTab, to_genes = T)
# Rank feature weights
rankedGeneList <- mofa_rankFeatList(tidyWeiMat, factor = 1)

# Do GSEA
# Hallmark gene sets
gseaRes_H <- doEA(rankedGeneList, categoryDB = 'H', numSigGS = 20, rmPrefixGS = '^HALLMARK_')
gseaRes_H$plotTopSigGS +
  labs(title = 'Hallmark: Factor1')
```

Compare factors learned from different MOFA models\
**Cor_Semi_Sup: Semi-supervised model trained on corrected NTP and NTL (1st model)**\
**Cor_Semi_Sup_TTP_TTL: Semi-supervised model trained on corrected NTP, NTL, TTP, and TTL (3rd model)**\
**Cor_Un_Sup_TTP_TTL: Un-supervised model trained on corrected NTP, NTL, TTP, and TTL (4th model)**
```{r}
# Compare factors learned from different MOFA models
mofaObj1 <- readRDS('./data/Discovery/mofa/correct_sigFeats_CombDIANTPKlin_CombAnnoUntNTL.rds')
mofaObj2 <- readRDS(paste0('./data/Discovery/mofa/correct_sigFeats_',
                           'CombDIANTPKlin_CombAnnoUntNTL_TTP_TTL.rds'))
mofaObj3 <- readRDS(paste0('./data/Discovery/mofa/correct_allFeats_',
                           'CombDIANTPKlin_CombAnnoUntNTL_TTP_TTL.rds'))

# MOFA2::plot_variance_explained(mofaObj1, max_r2 = 10) +
#   labs(title = 'Semi-Super, Correct: Factor1&2 Sig.')
# MOFA2::plot_variance_explained(mofaObj2, max_r2 = 10) +
#   labs(title = 'Semi-Super, Correct (TTP+TTL): Factor3&1&2 Sig.')
# MOFA2::plot_variance_explained(mofaObj3, max_r2 = 10) +
#   labs(title = 'Un-Super, Correct (TTP+TTL): Factor1&9 Sig.')

MOFA2::compare_factors(list(Cor_Semi_Sup = mofaObj1, Cor_Semi_Sup_TTP_TTL = mofaObj2,
                            Cor_Un_Sup_TTP_TTL = mofaObj3))
```
=> All Factor1 mostly explain variance in NTP, and semi-supervised models perform
better than un-supervised model.
=> Both Factor2 from semi-supervised models are not correlated with PC2 and PC5
from NTL SOA results.
=> Factor3 from semi- and un-supervised models are correlated, but former one got
much more powerful in predicting recurrence, which might be due to heterogeneous
tumore data.

```{r include=F, eval=F}
# Compare Factors with recurrence-related PCs from SOA results
# Prepare significant Factor table
mofaObject <- readRDS(paste0('./data/Discovery/mofa/correct_sigFeats_',
                             'CombDIANTPKlin_CombAnnoUntNTL_TTP_TTL.rds'))
facTab <- mofa_vizSigFactor(mofaObject, smpGroup = 'Baseline Group', show_res = F)$tab4Plot %>%
  dplyr::select(sample, Factor2, Recurrence)

# Prepare significant PC table
# Tumor Proteomics
proTumorRes_Klin <- readRDS('./data/Discovery/AG_Klingmueller/soaRes/proTumorRes_SVs.rds')
pcTab <- proTumorRes_Klin$SOA.res$pcTab %>%
  dplyr::select(Sample, `PC1 (54.3%)`, `PC5 (1.8%)`, `PC2 (21.3%)`, `PC9 (1.3%)`) %>%
  dplyr::rename(sample = Sample) %>%
  dplyr::mutate(sample = stringr::str_replace_all(sample, '_TG|_TU', '_B'))
# Normal Proteomics
proNormalRes_Klin <- readRDS('./data/Discovery/AG_Klingmueller/soaRes/proNormalRes_Stage.rds')
pcTab <- proNormalRes_Klin$SOA.res$pcTab %>%
  dplyr::select(Sample, `PC1 (14.3%)`, `PC10 (3.6%)`) %>%
  dplyr::rename(sample = Sample) %>%
  dplyr::mutate(sample = stringr::str_replace_all(sample, '_NG', '_B'))
# Tumor Lipidomics
lipTumorRes_Hopf <- readRDS('./data/Discovery/AG_Hopf/partial_annotated/soaRes/lipTumorResSVs_Recur_Comb.rds')
pcTab <- lipTumorRes_Hopf$SOA.res$pcTab %>%
  dplyr::select(Sample, `PC19 (1.9%)`, `PC2 (11.5%)`) %>%
  dplyr::rename(sample = Sample) %>%
  dplyr::mutate(sample = stringr::str_replace_all(sample, '_TG|_TU', '_B'))
# Tumor Lipidomics
lipNormalRes_Hopf <- readRDS('./data/Discovery/AG_Hopf/partial_annotated/soaRes/lipNormalResSVs_Recur_Comb.rds')
pcTab <- lipNormalRes_Hopf$SOA.res$pcTab %>%
  dplyr::select(Sample, `PC2 (10.9%)`, `PC5 (7%)`) %>%
  dplyr::rename(sample = Sample) %>%
  dplyr::mutate(sample = stringr::str_replace_all(sample, '_NG', '_B'))

# Combine all information
combinedTab <- dplyr::left_join(facTab, pcTab, by = 'sample')
# Make a plot and compute correlation
ggplot(combinedTab, aes(x=Factor2, y=`PC5 (7%)`)) +
  geom_point(aes(col=Recurrence), size = 4) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 7) +
  th
```




# Incomp. Klin. Pro. + Unanno. Hopf Lip.
Incomplete DIA Proteomics from AG KlingmÃ¼ller + Unannotated Untargeted Lipidomics
from AG Hopf

```{r message=F}
# Prepare data tables to train MOFA models
# Load normalized datasets
comb_proTissue_Klin <- readRDS('./data/MethodDev/AG_Klingmueller/proTissueVsnBC.rds')
comb_proNormal_Klin <- comb_proTissue_Klin[, colData(comb_proTissue_Klin)$Condition == 'Normal']

comb_proTissue_Krij <- readRDS('./data/Discovery/AG_Krijgsveld/combined_proTissueVsnBC.rds')

dis_lipTissue_Hopf <- readRDS('./data/Discovery/AG_Hopf/lipTissueVsn_WBC25.rds')
dis_lipNormal_Hopf <- dis_lipTissue_Hopf[, colData(dis_lipTissue_Hopf)$Condition == 'Normal']

mDev_lipTissue_Hopf <- readRDS('./data/MethodDev/AG_Hopf/lipTissueVsn.rds')
mDev_lipNormal_Hopf <- mDev_lipTissue_Hopf[, colData(mDev_lipTissue_Hopf)$Condition == 'Normal']

dis_lipBase_Hopf <- readRDS('./data/Discovery/AG_Hopf/lipBaseVsn_B1WBC25.rds')

mDev_lipPlasma_Hopf <- readRDS('./data/MethodDev/AG_Hopf/lipPlasmaVsn.rds')
mDev_lipBase_Hopf <- mDev_lipPlasma_Hopf[, colData(mDev_lipPlasma_Hopf)$TimePoint == 'Baseline']

# Sanity check dimensionality of each dataset (Feature x Sample)
dataList <- list(Comb_Tissue_Proteomics_Klin = comb_proTissue_Klin,
                 Comb_Tissue_Proteomics_Krij = comb_proTissue_Krij,
                 Dis_Tissue_Lipidomics_Hopf = dis_lipTissue_Hopf,
                 MDev_Tissue_Lipidomics_Hopf = mDev_lipTissue_Hopf,
                 Dis_Baseline_Lipidomics_Hopf = dis_lipBase_Hopf,
                 MDev_Plasma_Lipidomics_Hopf = mDev_lipPlasma_Hopf)
# lapply(dataList, dim)

# Prepare significant features for feature selection
# soaRes <- readRDS('./data/Discovery/potential_proteins/Combined_proNormalRes_Klin_BC_SV1.rds')
# sigFeats_comb_proNormal_Klin <- soaRes$sig.feat.tab$Var1
# soaRes <- doSOA(dis_lipNormal_Hopf, meta_var = 'Recurrence', use_proDA = T)
# sigFeats_dis_lipNormal_Hopf <- soaRes$featSigAssoRes$Var1
# soaRes <- doSOA(mDev_lipNormal_Hopf, meta_var = 'Recurrence', use_proDA = T)
# sigFeats_mDev_lipNormal_Hopf <- soaRes$featSigAssoRes$Var1
# soaRes <- doSOA(dis_lipBase_Hopf, meta_var = 'Recurrence', use_proDA = T)
# sigFeats_dis_lipBase_Hopf <- soaRes$featSigAssoRes$Var1
# soaRes <- doSOA(mDev_lipBase_Hopf, meta_var = 'Recurrence', use_proDA = T)
# sigFeats_mDev_lipBase_Hopf <- soaRes$featSigAssoRes$Var1

# Convert SE objects to long data for creating MOFA object through 'create_mofa_from_df'
# to include metadata
# comb_proNormalTab_Klin <- mofa_summExp2df(comb_proNormal_Klin, smp_type = 'Tissue',
#                                           data_acqui = 'Combined DIA', data_modal = 'Proteomics') %>%
#   dplyr::filter(feature %in% sigFeats_comb_proNormal_Klin)
# dis_lipNormalTab_Hopf <- mofa_summExp2df(dis_lipNormal_Hopf, smp_type = 'Tissue',
#                                          data_acqui = 'Discovery Untargeted', data_modal = 'Lipidomics') %>%
#   dplyr::filter(feature %in% sigFeats_dis_lipNormal_Hopf)
# mDev_lipNormalTab_Hopf <- mofa_summExp2df(mDev_lipNormal_Hopf, smp_type = 'Tissue',
#                                           data_acqui = 'MethodDev Untargeted', data_modal = 'Lipidomics') %>%
#   dplyr::filter(feature %in% sigFeats_mDev_lipNormal_Hopf)
# dis_lipBaseTab_Hopf <- mofa_summExp2df(dis_lipBase_Hopf, smp_type = 'Plasma',
#                                        data_acqui = ' Discovery Untargeted', data_modal = 'Lipidomics') %>%
#   dplyr::filter(feature %in% sigFeats_dis_lipBase_Hopf)
# mDev_lipBaseTab_Hopf <- mofa_summExp2df(mDev_lipBase_Hopf, smp_type = 'Plasma',
#                                         data_acqui = 'MethodDev Untargeted', data_modal = 'Lipidomics') %>%
#   dplyr::filter(feature %in% sigFeats_mDev_lipBase_Hopf)

# Prepare sample spaces from different datasets to remove unwanted samples later 
smps_CombNTP <- stringr::str_replace(colnames(comb_proNormal_Klin), '_NG', '_B')
smps_DisNTL <- stringr::str_replace(colnames(dis_lipNormal_Hopf), '_NG', '_B')
smps_MDevNTL <- stringr::str_replace(colnames(mDev_lipNormal_Hopf), '_NG', '_B')
smps_DisBPL <- stringr::str_replace(colnames(dis_lipBase_Hopf), '_V1', '_B')
smps_MDevBPL <- colnames(mDev_lipBase_Hopf)
```

## NTP + NTL
Incomplete Combined DIA Normal Tissue Proteomics (MethodDev + Discovery) from AG KlingmÃ¼ller +
Discovery and MethodDev Unannotated Untargeted Normal Tissue Lipidomics\
(since features defined by RT/CCS/MZ have difficulty being combined together from different cohorts)\
**Note that only statistically significant recurrence-related features were used to train a MOFA model**

```{r}
# Train MOFA model
# Remove unwanted samples
# smpViewCounts <- table(c(smps_CombNTP, smps_DisNTL, smps_MDevNTL))
# rmSmps <- names(smpViewCounts)[smpViewCounts == 1]
# tmp_dis_lipNormalTab_Hopf <- dplyr::filter(dis_lipNormalTab_Hopf, !sample %in% rmSmps)
# tmp_mDev_lipNormalTab_Hopf <- dplyr::filter(mDev_lipNormalTab_Hopf, !sample %in% rmSmps)
# 
# mofaObject <- trainMOFA(list(comb_proNormalTab_Klin, tmp_dis_lipNormalTab_Hopf,
#                              tmp_mDev_lipNormalTab_Hopf),
#                         view_data = T, train_mofa = T, num_factors = 10,
#                         save_path = './data/Discovery/mofa/sigFeats_CombDIANTPKlin_DisMDevUntNTL')

# Load trained model
mofaObject <- readRDS(paste0('./data/Discovery/mofa/incompProKlin_unannoUntLip/',
                             'sigFeats_CombDIANTPKlin_DisMDevUntNTL.rds'))
```

Overview model\
Note that samples in only one view were removed from model training
```{r}
# Overview model
MOFA2::plot_data_overview(mofaObject)
```

Quantify amount of variance explained by each factor in each data modality
```{r}
# Do sanity check for factor correlations
# MOFA2::plot_factor_cor(mofaObject)

# Perform variance dedecomposition analysis (coefficient of determination)
MOFA2::plot_variance_explained(mofaObject, max_r2 = 15)
```

Display and visualize significant recurrence-related factors
```{r}
# Display significant associations between learned factors (Var1) and cancer recurrence
# (Var2) and visualize significant recurrence-related factors
sigFactor <- mofa_vizSigFactor(mofaObject, smpGroup = 'Baseline Group', show_res = F)
sigFactor$sigAssoRes

# Visualize significant recurrence-related factors
facTab <- dplyr::mutate(sigFactor$tab4Plot,
                        Recurrence = factor(Recurrence, levels = c('Yes', 'No')),
                        Label = dplyr::case_when(Recurrence %in% 'Yes' & Factor1 > 0 ~ sample,
                                                 Recurrence %in% 'No' & Factor1 < 0 ~ sample))
ggplot(facTab, aes(x=Recurrence, y=Factor1, col=Recurrence, fill=Recurrence, label=Label)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 4, show.legend = F) +
  geom_text_repel(show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             size = 9, show.legend = F, hjust = 0.4, vjust = 1) +
  scale_color_manual(values=c('#F8766D', '#00BFC4')) +
  scale_fill_manual(values=c('#F8766D', '#00BFC4')) +
  th +
  theme(axis.title = element_text(size = 28),
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 26), legend.text = element_text(size = 24))


ggplot(facTab, aes(x=Recurrence, y=Factor4, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 4, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             show.legend = F) +
  scale_color_manual(values=c('#F8766D', '#00BFC4')) +
  scale_fill_manual(values=c('#F8766D', '#00BFC4')) +
  th

ggplot(sigFactor$tab4Plot, aes(x=Factor1, y=Factor4, col=Recurrence)) +
  geom_point(size = 4) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  th

# Compute ROC-AUC score
response <- ifelse(facTab$Recurrence == 'Yes', yes = '1', no = '0') %>%
  factor(levels = c('1', '0'))
predictor <- facTab$Factor1
rocRes <- suppressMessages(
  pROC::roc(response = response, predictor = predictor, plot = T,
            legacy.axes = T, print.auc = T, print.auc.x = 0.4,
            xlab = 'False positive rate', ylab = 'True positive rate',
            main = 'ROC Curve for Factor1',
            cex.lab = 1.2, cex.main = 1.1, col = '#377eb8', lwd = 4,
            direction = '<')
)
```
=> Factor1 is highly correlated with PC1 from Klin. NTP and explains variance also
in MDev. NTL, but in Dis. NTL, which implies that significant features captured
from MDev. and Dis. NTL may provide distinct information probably due to biological
variations in different patient cohorts. In addition, Dis. Tissue Lipidomics got
worse sample or data quality than MDev., which is shown by their metadata-assisted
quality controls (Tumor vs Normal).

Compare Factor1 with recurrence-related PC1 learned from Combined Klin. Normal Tissue Proteomics
```{r}
# Visualize correlation between significant factor (MOFA) and significant PC (PCA)
# Prepare significant factor table
facTab <- sigFactor$tab4Plot %>%
  dplyr::select(sample, Factor1, Recurrence) %>%
  dplyr::mutate(sample = stringr::str_replace(sample, '_B', '_NG'))
# Prepare significant PC table
proNormalRes_Klin <- readRDS('./data/Discovery/potential_proteins/Combined_proNormalRes_Klin_BC_SV1.rds')
# Show significant PCs
# proNormalRes_Klin$sig.pc.tab
pcTab <- proNormalRes_Klin$SOA.res$pcTab %>%
  dplyr::select(Sample, `PC1 (11.1%)`) %>%
  dplyr::rename(sample = Sample)
# Combine all information
combinedTab <- dplyr::left_join(facTab, pcTab, by = 'sample')
# Make a plot and compute correlation
ggplot(combinedTab, aes(x=Factor1, y=`PC1 (11.1%)`)) +
  geom_point(aes(col=Recurrence), size = 4) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 7) +
  th
```

Show enrichment analysis results
```{r message=F}
# Prepare ranked feature list
# Tidy up weight matrix and feature metadata to reduce information loss
proGeneTab <- rowData(comb_proNormal_Klin) %>%
  tibble::as_tibble(rownames = 'Proteins') %>%
  tibble::column_to_rownames('Proteins')
tidyWeiMat <- mofa_keepUniFeats(mofaObject, factor = 1, view = 'Combined DIA Normal Proteomics',
                                feat_anno = proGeneTab, to_genes = T)
# Rank feature weights
rankedGeneList <- mofa_rankFeatList(tidyWeiMat, factor = 1)
# Make Recurrence group positive weights
rankedGeneList <- sort(-rankedGeneList, decreasing = T)

# Do enrichment analysis - Hallmark gene sets (H)
# Retrieve annotated gene sets
msigTabH <- msigdbr(species = 'Homo sapiens', category = 'H', subcategory = NULL) %>%
  dplyr::select(gs_name, human_gene_symbol)
# Run GSEA
gseaResH <- clusterProfiler::GSEA(geneList = rankedGeneList, TERM2GENE = msigTabH,
                                  minGSSize = 10, maxGSSize = 500,
                                  pvalueCutoff = 0.05, pAdjustMethod = 'BH',
                                  by = 'fgsea', eps = 0)

# Plot enrichment analysis results
gseaRes4Plot <- gseaResH@result %>%
  dplyr::select(Description, setSize, NES, pvalue, p.adjust, leading_edge) %>%
  dplyr::arrange(p.adjust) %>%
  dplyr::slice_head(n = 8) %>%
  dplyr::mutate(leading_edge = stringr::str_extract(leading_edge, '\\d\\d'),
                leading_edge = as.numeric(leading_edge),
                Recurrence = ifelse(test = NES > 0, yes = 'Yes', no = 'No')) %>%
  dplyr::rename(gene_ratio = leading_edge)
midGrad <- mean(gseaRes4Plot$p.adjust)

ggplot(gseaRes4Plot, aes(x=NES, y=reorder(Description, NES), fill=p.adjust, col=Recurrence)) +
  geom_bar(stat = 'identity', width = 0.6, size = 2) +
  scale_fill_gradient2(low='#5B1C00', high='#FFFCA5', mid = '#E86900', midpoint = midGrad, name = 'Adjusted pVal') +
  scale_color_manual(values = c(Yes = 'red', No = 'darkblue')) +
  labs(x = 'Normalized Enrichment Score', y = 'Pathway', title = 'MSigDB:H - Factor1') +
  theme_minimal() +
  theme(axis.title = element_text(size = 16, face = 'bold'),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 10, face = 'bold'),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12))

# => Factor4: HALLMARK_MYC_TARGETS_V1
```

```{r include=F, eval=F}
# Compare factors learned from different MOFA models
mofaObj1 <- readRDS(paste0('./data/Discovery/mofa/incompProKlin_unannoUntLip/',
                           'sigFeats_CombDIANTPKlin_DisMDevUntNTL.rds'))
mofaObj2 <- readRDS('./data/Discovery/mofa/X/sigFeats_CombDIANTPKlin_DisUntNTL.rds')
mofaObj3 <- readRDS('./data/Discovery/mofa/X/sigFeats_CombDIANTPKlin_MDevUntNTL.rds')

MOFA2::plot_variance_explained(mofaObj2, max_r2 = 15) +
  labs(title = 'DisUntNTL: Factor1&2 Sig.')
MOFA2::plot_variance_explained(mofaObj3, max_r2 = 15) +
  labs(title = 'MDevUntNTL: Factor1&3 Sig.')

MOFA2::compare_factors(list(DisMDevUntNTL = mofaObj1, DisUntNTL = mofaObj2, MDevUntNTL = mofaObj3))
```

## NTP + BPL
Incomplete Combined DIA Normal Tissue Proteomics (MethodDev + Discovery) from AG KlingmÃ¼ller +
Discovery and MethodDev Unannotated Untargeted Baseline Plasma Lipidomics\
(since features defined by RT/CCS/MZ have difficulty being combined together from different cohorts)\
**Note that only statistically significant recurrence-related features were used to train a MOFA model**

```{r}
# Train MOFA model
# Remove unwanted samples
# smpViewCounts <- table(c(smps_CombNTP, smps_DisBPL, smps_MDevBPL))
# rmSmps <- names(smpViewCounts)[smpViewCounts == 1]
# tmp_dis_lipBaseTab_Hopf <- dplyr::filter(dis_lipBaseTab_Hopf, !sample %in% rmSmps)
# tmp_mDev_lipBaseTab_Hopf <- dplyr::filter(mDev_lipBaseTab_Hopf, !sample %in% rmSmps)
# 
# mofaObject <- trainMOFA(list(comb_proNormalTab_Klin, tmp_dis_lipBaseTab_Hopf,
#                              tmp_mDev_lipBaseTab_Hopf),
#                         view_data = T, train_mofa = T, num_factors = 10,
#                         save_path = './data/Discovery/mofa/sigFeats_CombDIANTPKlin_DisMDevUntBPL')

# Load trained model
mofaObject <- readRDS(paste0('./data/Discovery/mofa/incompProKlin_unannoUntLip/',
                             'sigFeats_CombDIANTPKlin_DisMDevUntBPL.rds'))
# views_names(mofaObject) <- c('Dis. Unt. BPL', 'Comb. DIA NTP', 'MDev. Unt. BPL')
```

Overview model\
Note that samples in only one view were removed from model training
```{r}
# Overview model
MOFA2::plot_data_overview(mofaObject) #+
  # theme(text = element_text(size = 28))
# ggsave('./output/Discovery/2nd_TAC/mofa_data_UntBPL_combined_proNormal_Klin.png',
#        device = 'png', dpi = 400, height = 8, width = 11)
```

Quantify amount of variance explained by each factor in each data modality
```{r}
# Do sanity check for factor correlations
# MOFA2::plot_factor_cor(mofaObject)

# Perform variance dedecomposition analysis (coefficient of determination)
MOFA2::plot_variance_explained(mofaObject, max_r2 = 15) #+
# theme(axis.text.x = element_text(size = 22), axis.text.y = element_text(size =20),
#       legend.title = element_text(size = 22), legend.text = element_text(size = 20))
# ggsave('./output/Discovery/2nd_TAC/mofa_varExplain_UntBPL_combined_proNormal_Klin.png',
       # device = 'png', dpi = 400, height = 8, width = 11)
```

Display and visualize significant recurrence-related factors
```{r}
# Display significant associations between learned factors (Var1) and cancer recurrence
# (Var2) and visualize significant recurrence-related factors
sigFactor <- mofa_vizSigFactor(mofaObject, smpGroup = 'Baseline Group', show_res = F)
sigFactor$sigAssoRes

# Visualize significant recurrence-related factors
facTab <- dplyr::mutate(sigFactor$tab4Plot,
                        Recurrence = factor(Recurrence, levels = c('Yes', 'No')),
                        Label = dplyr::case_when(Recurrence %in% 'Yes' & Factor1 > 0 ~ sample,
                                                 Recurrence %in% 'No' & Factor1 < 0 ~ sample))
ggplot(facTab, aes(x=Recurrence, y=Factor1, col=Recurrence, fill=Recurrence, label=Label)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 4, show.legend = F) +
  geom_text_repel(show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             size = 9, show.legend = F, hjust = 0.4, vjust = 1) +
  scale_color_manual(values=c('#F8766D', '#00BFC4')) +
  scale_fill_manual(values=c('#F8766D', '#00BFC4')) +
  th +
  theme(axis.title = element_text(size = 30), axis.text = element_text(size = 20),
        legend.title = element_text(size = 28), legend.text = element_text(size = 26))
# ggsave('./output/Discovery/2nd_TAC/mofa_fac1_UntBPL_combined_proNormal_Klin.png',
#        device = 'png', dpi = 400, height = 8, width = 11)

# Compute ROC-AUC score
response <- ifelse(facTab$Recurrence == 'Yes', yes = '1', no = '0') %>%
  factor(levels = c('1', '0'))
predictor <- facTab$Factor1
rocRes <- pROC::roc(response = response, predictor = predictor, plot = T,
                    legacy.axes = T, print.auc = T, print.auc.x = 0.4,
                    xlab = substitute(paste(bold('False positive rate'))),
                    ylab = substitute(paste(bold('True positive rate'))),
                    main = 'ROC Curve for Factor1',
                    cex.lab = 1.8, cex.axis = 1.2, cex.main = 1.8, col = '#377eb8',
                    lwd = 6, direction = '<', quiet = T)
# pROC::ci.auc(rocRes)
```

Compare Factor1 with recurrence-related PC1 learned from Combined Klin. Normal Tissue
Proteomics and another Factor1 from model built on Klin. NTP and Unt. NTL
```{r}
# Visualize correlation between significant factors (MOFA) and significant PC (PCA)
# Prepare significant factor table
facTab <- sigFactor$tab4Plot %>%
  dplyr::select(sample, Factor1, Recurrence) %>%
  dplyr::mutate(sample = stringr::str_replace(sample, '_B', '_NG'))
# Prepare significant PC table
proNormalRes_Klin <- readRDS('./data/Discovery/potential_proteins/Combined_proNormalRes_Klin_BC_SV1.rds')
# Show significant PCs
# proNormalRes_Klin$sig.pc.tab
pcTab <- proNormalRes_Klin$SOA.res$pcTab %>%
  dplyr::select(Sample, `PC1 (11.1%)`) %>%
  dplyr::rename(sample = Sample)
# Combine all information
combinedTab <- dplyr::left_join(facTab, pcTab, by = 'sample') %>%
  dplyr::mutate(Recurrence = factor(Recurrence, levels = c('Yes', 'No')))
# Make a plot and compute correlation
ggplot(combinedTab, aes(x=Factor1, y=`PC1 (11.1%)`)) +
  geom_point(aes(col=Recurrence), size = 4) +
  scale_color_manual(values=c('#F8766D', '#00BFC4')) +
  scale_fill_manual(values=c('#F8766D', '#00BFC4')) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 9) +
  th +
  theme(axis.title = element_text(size = 30), axis.text = element_text(size = 20),
        legend.title = element_text(size = 28), legend.text = element_text(size = 26))
# ggsave('./output/Discovery/2nd_TAC/mofa_fac1_vs_pc1_UntBPL_combined_proNormal_Klin.png',
#        device = 'png', dpi = 400, height = 8, width = 11)

# Prepare significant factor tables
facTab <- sigFactor$tab4Plot %>%
  dplyr::select(sample, Factor1, Recurrence) %>%
  dplyr::rename(Factor1_BPL = Factor1)
mofaObj <- readRDS(paste0('./data/Discovery/mofa/incompProKlin_unannoUntLip/',
                          'sigFeats_CombDIANTPKlin_DisMDevUntNTL.rds'))
facTab2 <- get_factors(mofaObj)[['Baseline Group']] %>%
  tibble::as_tibble(rownames = 'sample') %>%
  dplyr::select(sample, Factor1) %>%
  dplyr::rename(Factor1_NTL = Factor1)
# Combine all information and remove unwanted samples
combinedTab <- dplyr::left_join(facTab, facTab2, by = 'sample')
# Make a plot and compute correlation
ggplot(combinedTab, aes(x=Factor1_BPL, y=Factor1_NTL)) +
  geom_point(aes(col=Recurrence), size = 4) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 7) +
  th
```

Show enrichment analysis results
```{r message=F}
# Prepare ranked feature list
# Tidy up weight matrix and feature metadata to reduce information loss
proGeneTab <- rowData(comb_proNormal_Klin) %>%
  tibble::as_tibble(rownames = 'Proteins') %>%
  tibble::column_to_rownames('Proteins')
tidyWeiMat <- mofa_keepUniFeats(mofaObject, factor = 1, view = 'Combined DIA Normal Proteomics',
                                feat_anno = proGeneTab, to_genes = T)
# Rank feature weights
rankedGeneList <- mofa_rankFeatList(tidyWeiMat, factor = 1)
# Make Recurrence group positive weights
rankedGeneList <- sort(-rankedGeneList, decreasing = T)

# Do enrichment analysis - Hallmark gene sets (H)
# Retrieve annotated gene sets
msigTabH <- msigdbr(species = 'Homo sapiens', category = 'H', subcategory = NULL) %>%
  dplyr::select(gs_name, human_gene_symbol)
# Run GSEA
gseaResH <- clusterProfiler::GSEA(geneList = rankedGeneList, TERM2GENE = msigTabH,
                                  minGSSize = 10, maxGSSize = 500,
                                  pvalueCutoff = 0.05, pAdjustMethod = 'BH',
                                  by = 'fgsea', eps = 0)

# Plot enrichment analysis results
gseaRes4Plot <- gseaResH@result %>%
  dplyr::select(Description, setSize, NES, pvalue, p.adjust, leading_edge) %>%
  dplyr::arrange(p.adjust) %>%
  dplyr::slice_head(n = 8) %>%
  dplyr::mutate(leading_edge = stringr::str_extract(leading_edge, '\\d\\d'),
                leading_edge = as.numeric(leading_edge),
                Recurrence = ifelse(test = NES > 0, yes = 'Yes', no = 'No')) %>%
  dplyr::rename(gene_ratio = leading_edge)
midGrad <- mean(gseaRes4Plot$p.adjust)

ggplot(gseaRes4Plot, aes(x=NES, y=reorder(Description, NES), fill=p.adjust, col=Recurrence)) +
  geom_bar(stat = 'identity', width = 0.6, size = 2) +
  scale_fill_gradient2(low='#5B1C00', high='#FFFCA5', mid = '#E86900', midpoint = midGrad, name = 'Adjusted pVal') +
  scale_color_manual(values = c(Yes = 'red', No = 'darkblue')) +
  labs(x = 'Normalized Enrichment Score', y = 'Pathway', title = 'MSigDB:H - Factor1') +
  theme_minimal() +
  theme(axis.title = element_text(size = 16, face = 'bold'),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 10, face = 'bold'),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12))
```

```{r include=F, eval=F}
# Compare factors learned from different MOFA models
mofaObj1 <- readRDS(paste0('./data/Discovery/mofa/incompProKlin_unannoUntLip/',
                           'sigFeats_CombDIANTPKlin_DisMDevUntNTL.rds'))
mofaObj2 <- readRDS(paste0('./data/Discovery/mofa/incompProKlin_unannoUntLip/',
                           'sigFeats_CombDIANTPKlin_DisMDevUntBPL.rds'))

MOFA2::compare_factors(list(NTL = mofaObj1, BPL = mofaObj2))
```
