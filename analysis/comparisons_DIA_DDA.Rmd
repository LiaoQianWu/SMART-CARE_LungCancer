---
title: "Comparisons between DIA and DDA proteomics datasets"
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Compare DIA and DDA Plasma and Tissue Proteomics generated
by AG Krijgsveld. Basically, correlations of common features between DIA and DDA
Proteomics were computed to see data reproducibility using different data acquisition
methods.\

Update: Compare DIA Tissue Proteomics generated by AG Klingmüller with aforementioned
DIA and DDA Tissue Proteomics from AG Krijgsveld. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_MethodDev')
```

Load libraries
```{r library loading, message = F}
library(SummarizedExperiment)
library(ggrepel)
library(igraph)
library(ggraph)
library(tidyverse)
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

# Plasma Proteomics
Compute Pearson correlations of all common features between Plasma Proteomics datasets.
Note that both Baseline and Follow-up samples were used.\

DIA (445) vs DDA (435) Plasma Proteomics both from AG Krijgsveld => 351 common features
```{r}
# Load preprocessed data
proPlasma_DIA <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm_DIA.rds')
proPlasma_DDA <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm.rds')
# Extract data matrix
datMat_DIA <- SummarizedExperiment::assay(proPlasma_DIA)
datMat_DDA <- SummarizedExperiment::assay(proPlasma_DDA)
# Make two matrices share same sample and feature spaces and in same row and column order
# Remove patient samples not measured in DIA proteomics from DDA proteomics
commonSmps <- colnames(datMat_DIA)
datMat_DIA <- datMat_DIA[, commonSmps]
datMat_DDA <- datMat_DDA[, commonSmps]
# Keep only common features between DIA and DDA proteomics
# Select first protein as representative if there are more than one
rownames(datMat_DIA) <- stringr::str_remove(rownames(datMat_DIA), ';.*')
rownames(datMat_DDA) <- stringr::str_remove(rownames(datMat_DDA), ';.*')
commonFeats <- intersect(rownames(datMat_DIA), rownames(datMat_DDA))
datMat_DIA <- datMat_DIA[commonFeats,]
datMat_DDA <- datMat_DDA[commonFeats,]

# Compute feature correlations between DIA and DDA proteomics
if (identical(rownames(datMat_DIA), rownames(datMat_DDA)) &
    identical(colnames(datMat_DIA), colnames(datMat_DDA))) {
  corrs <- sapply(seq_len(nrow(datMat_DIA)), function(i) {
    corr <- cor.test(datMat_DIA[i,], datMat_DDA[i,], method = 'pearson',
                     use = "pairwise.complete.obs")
    corr$estimate
  })
  corrRes <- data.frame(Feature = rownames(datMat_DIA), Correlation = corrs) %>%
    dplyr::arrange(Correlation) %>%
    dplyr::mutate(Feature = factor(Feature, levels = Feature))
}

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.5, 1, 0.25))) +
  labs(y = 'Frequency', title = 'DIA vs DDA Proteomics both from AG Krijgsveld') +
  th

# ggplot(corrRes, aes(x=Feature, y=Correlation)) +
#   geom_point(size = 2, color = 'grey60') +
#   geom_hline(yintercept = 0.7, color = 'red', linewidth = 0.7) +
#   geom_text(x=-7, y=0.7, label = '0.7', size = 4.5, color = 'red') +
#   coord_cartesian(clip = 'off') +
#   th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
#              panel.grid.major.x = element_blank())
```

```{r include=F, eval=F}
ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.5, 1, 0.25))) +
  labs(y = 'Frequency') +
  th + theme(axis.title = element_text(size = 22),
             axis.text = element_text(size = 20))
ggsave('./output/group_meeting/proPlasma_Kri_DIA_DDA_comparison.png', device = 'png',
       dpi = 400, height = 8, width = 8)
```

```{r message=F, include=F, eval=F}
# Display significant associations between features and cancer recurrence
# DIA
# Prepare protein-gene table for changing protein names to gene names
featInfo_DIA <- tibble::as_tibble(rowData(proPlasma_DIA), rownames = 'Protein.Groups')
# Subset baseline samples
smpBaseIdx <- which(colData(proPlasma_DIA)$Condition == 'Baseline')
proBase_DIA <- proPlasma_DIA[, smpBaseIdx]
datMat_DIA <- SummarizedExperiment::assay(proBase_DIA)
smpAnno_DIA <- tibble::as_tibble(colData(proBase_DIA), rownames = 'Sample')

# Perform analysis
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat_DIA, design = ~ smpAnno_DIA$Recurrence)
all_proDAProBaseRes_DIA <- proDA::test_diff(fit,
                                            contrast = Intercept + `smpAnno_DIA$RecurrenceYes` - Intercept,
                                            sort_by = 'pval') %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx, n_obs)) %>%
  dplyr::rename(Protein = name, pVal = pval, pValAdj = adj_pval, tStat = t_statistic) %>%
  dplyr::mutate(Gene = plyr::mapvalues(Protein,
                                       from = featInfo_DIA$Protein.Groups,
                                       to = featInfo_DIA$Genes,
                                       warn_missing = F))
# Identify significant differentially abundant entities
proDAProBaseRes_DIA <- dplyr::filter(all_proDAProBaseRes_DIA, pVal < 0.05)
# Display features significantly separating recurrence and non-recurrence patients
proDAProBaseRes_DIA

# DDA
# Prepare protein-gene table for changing protein names to gene names
featInfo_DDA <- tibble::as_tibble(rowData(proPlasma_DDA), rownames = 'PG.Groups')
# Subset baseline samples
smpBaseIdx <- which(colData(proPlasma_DDA)$Condition == 'Baseline')
proBase_DDA <- proPlasma_DDA[, smpBaseIdx]

# Perform analysis
proBaseRes_DDA <- doSOA(proBase_DDA, meta_var = 'Recurrence', num_PCfeats = 30)
tFeatSigRes_DDA <- proBaseRes_DDA$tFeatSigRes %>%
  dplyr::select(-c(Test, Var2)) %>%
  dplyr::rename(Protein = Var1, tStat = Stat) %>%
  dplyr::mutate(Gene = plyr::mapvalues(Protein,
                                       from = featInfo_DDA$PG.Groups,
                                       to = featInfo_DDA$PG.Genes,
                                       warn_missing = F))
# Display features significantly separating recurrence and non-recurrence patients
tFeatSigRes_DDA

# Display overlaps between DIA and DDA significant proteins
# Select first protein as representative if there are more than one
sigFeats_DIA <- stringr::str_remove(proDAProBaseRes_DIA$Protein, ';.*')
sigFeats_DDA <- stringr::str_remove(tFeatSigRes_DDA$Protein, ';.*')
cat('Overlaps of significant features:',
    plyr::mapvalues(intersect(sigFeats_DIA, sigFeats_DDA),
                    from = featInfo_DIA$Protein.Groups,
                    to = featInfo_DIA$Genes,
                    warn_missing = F), '\n',
    sep = '  ')

# Compute correlation of p-values between DIA and DDA roteomics
pVal_DIA <- dplyr::select(all_proDAProBaseRes_DIA, c(Protein, pVal)) %>%
  dplyr::mutate(Protein = stringr::str_remove(Protein, ';.*')) %>%
  dplyr::filter(Protein %in% commonFeats) %>%
  dplyr::arrange(Protein)
pVal_DDA <- dplyr::select(proBaseRes_DDA$tFeatRes, c(Var1, pVal)) %>%
  dplyr::rename(Protein = Var1) %>%
  dplyr::mutate(Protein = stringr::str_remove(Protein, ';.*')) %>%
  dplyr::filter(Protein %in% commonFeats) %>%
  dplyr::arrange(Protein)
if (identical(pVal_DDA$Protein, pVal_DIA$Protein)) {
  cat('Correlation of p-values:', cor.test(pVal_DIA$pVal, pVal_DDA$pVal, method = 'pearson',
                                           use = "pairwise.complete.obs")$estimate)
}
```

# Tissue Proteomics
Compute Pearson correlations of all common features between Tissue Proteomics datasets.
Note that both Baseline and Follow-up samples were used.

```{r}
# Load preprocessed data
proTissue_DIA <- readRDS('./data/AG_Krijgsveld/proTissueNorm_DIA.rds')
proTissue_DDA <- readRDS('./data/AG_Krijgsveld/proTissueNorm.rds')
proTissue_DIA_Klin <- readRDS('./data/AG_Klingmuller/proTissueNorm_DIA.rds')
```

DIA (5658) vs DDA (5193) Tissue Proteomics both from AG Krijgsveld => 4636 common features
```{r}
# Extract data matrix
datMat_DIA <- SummarizedExperiment::assay(proTissue_DIA)
datMat_DDA <- SummarizedExperiment::assay(proTissue_DDA)

# Make two matrices share same sample and feature spaces and in same row and column order
# Remove patient samples not measured in DIA proteomics from DDA proteomics
commonSmps <- colnames(datMat_DIA)
datMat_DIA <- datMat_DIA[, commonSmps]
datMat_DDA <- datMat_DDA[, commonSmps]
# Keep only common features between DIA and DDA proteomics
# Select first protein as representative if there are more than one
rownames(datMat_DIA) <- stringr::str_remove(rownames(datMat_DIA), ';.*')
rownames(datMat_DDA) <- stringr::str_remove(rownames(datMat_DDA), ';.*')
commonFeats <- intersect(rownames(datMat_DIA), rownames(datMat_DDA))
datMat_DIA <- datMat_DIA[commonFeats,]
datMat_DDA <- datMat_DDA[commonFeats,]

# Compute feature correlations between DIA and DDA proteomics
if (identical(rownames(datMat_DIA), rownames(datMat_DDA)) &
    identical(colnames(datMat_DIA), colnames(datMat_DDA))) {
  corrs <- sapply(seq_len(nrow(datMat_DIA)), function(i) {
    corr <- cor.test(datMat_DIA[i,], datMat_DDA[i,], method = 'pearson',
                     use = "pairwise.complete.obs")
    corr$estimate
  })
  corrRes <- data.frame(Feature = rownames(datMat_DIA), Correlation = corrs) %>%
    dplyr::arrange(Correlation) %>%
    dplyr::mutate(Feature = factor(Feature, levels = Feature))
}

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(-0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6)) +
  labs(y = 'Frequency', title = 'DIA vs DDA Tissue Proteomics both from AG Krijgsveld') +
  th
```

```{r include=F, eval=F}
ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.75, 0.65, 0.25))) +
  labs(y = 'Frequency') +
  th + theme(axis.title = element_text(size = 22),
             axis.text = element_text(size = 20))
ggsave('./output/group_meeting/proTissue_Kri_DIA_DDA_comparison.png', device = 'png',
       dpi = 400, height = 8, width = 8)
```
<br/>
<br/>

DIA Tissue Proteomics from AG Klingmüller (8257) vs DDA Tissue Proteomics from AG
Krijgsveld (5193) => 5022 common features
```{r}
# Extract data matrix
dat1 <- SummarizedExperiment::assay(proTissue_DIA_Klin)
dat2 <- SummarizedExperiment::assay(proTissue_DDA)

# Make two matrices share same sample and feature spaces and in same row and column order
# Keep only common samples
commonSmps <- intersect(colnames(dat1), colnames(dat2))
dat1 <- dat1[, commonSmps]
dat2 <- dat2[, commonSmps]
# Keep only common features
# Select first protein as representative if there are more than one
rownames(dat1) <- stringr::str_remove(rownames(dat1), ';.*')
rownames(dat2) <- stringr::str_remove(rownames(dat2), ';.*')
commonFeats <- intersect(rownames(dat1), rownames(dat2))
dat1 <- dat1[commonFeats,]
dat2 <- dat2[commonFeats,]

# Compute feature correlations between DIA and DDA proteomics
if (identical(rownames(dat1), rownames(dat2)) &
    identical(colnames(dat1), colnames(dat2))) {
  corrs <- sapply(seq_len(nrow(dat1)), function(i) {
    corr <- cor.test(dat1[i,], dat2[i,], method = 'pearson', use = "pairwise.complete.obs")
    corr$estimate
  })
  corrRes <- data.frame(Feature = rownames(dat1), Correlation = corrs) %>%
    dplyr::arrange(Correlation) %>%
    dplyr::mutate(Feature = factor(Feature, levels = Feature))
}

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.5, 1, 0.25))) +
  labs(y = 'Frequency', title = 'DIA Proteomics from AG Klingmüller vs DDA Proteomics from AG Krijgsveld') +
  th
```
<br/>
<br/>

DIA Tissue Proteomics from AG Krijgsveld (5658) vs AG Klingmüller (8257) => 5451 common features
```{r}
# Extract data matrix
dat1 <- SummarizedExperiment::assay(proTissue_DIA)
dat2 <- SummarizedExperiment::assay(proTissue_DIA_Klin)

# Make two matrices share same sample and feature spaces and in same row and column order
# Keep only common samples
commonSmps <- intersect(colnames(dat1), colnames(dat2))
dat1 <- dat1[, commonSmps]
dat2 <- dat2[, commonSmps]
# Keep only common features
# Select first protein as representative if there are more than one
rownames(dat1) <- stringr::str_remove(rownames(dat1), ';.*')
rownames(dat2) <- stringr::str_remove(rownames(dat2), ';.*')
commonFeats <- intersect(rownames(dat1), rownames(dat2))
dat1 <- dat1[commonFeats,]
dat2 <- dat2[commonFeats,]

# Compute feature correlations between DIA and DDA proteomics
if (identical(rownames(dat1), rownames(dat2)) &
    identical(colnames(dat1), colnames(dat2))) {
  corrs <- sapply(seq_len(nrow(dat1)), function(i) {
    corr <- cor.test(dat1[i,], dat2[i,], method = 'pearson', use = "pairwise.complete.obs")
    corr$estimate
  })
  corrRes <- data.frame(Feature = rownames(dat1), Correlation = corrs) %>%
    dplyr::arrange(Correlation) %>%
    dplyr::mutate(Feature = factor(Feature, levels = Feature))
}

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.8, 0.6, 0.2))) +
  labs(y = 'Frequency', title = 'DIA Proteomics from AG Krijgsveld vs AG Klingmüller') +
  th
```
