---
title: "Comparisons between DIA and DDA proteomics datasets"
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Compare DIA and DDA Plasma and Tissue Proteomics generated
by AG Krijgsveld. Basically, correlations of common features between DIA and DDA
Proteomics were computed to see data reproducibility using different data acquisition
methods.\

Update: Compare DIA Tissue Proteomics generated by AG Klingm√ºller with aforementioned
DIA and DDA Tissue Proteomics from AG Krijgsveld. In addition, significant cancer
recurrence-related proteins from each dataset are also summarized.\

Update: Compare New DIA Plasma and Tissue Proteomics from AG Krijgsveld with all
aforementioned datasets. Old DIA Tissue Proteomics from AG Krijgsveld may have
something wrong! </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_MethodDev')
```

Load libraries
```{r library loading, message = F}
library(SummarizedExperiment)
library(ggrepel)
library(igraph)
library(ggraph)
library(tidyverse)
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

```{r}
calcFeatCorr <- function(data1, data2, show_nFeats = F) {
  #' Systematically compute feature correlations between two PROTEOMICS (for now) datasets
  #' 
  #' Parameters
  #' data1, data2: SummarizedExperiment objects that contain data matrices
  #' 
  #' Return
  #' corrRes: A table of correlations of overlapped features between two datasets
  
  # Extract data matrix
  dat1 <- SummarizedExperiment::assay(data1)
  dat2 <- SummarizedExperiment::assay(data2)
  
  # Make two matrices share same sample and feature spaces and in same row and column order
  # Keep only common samples
  commonSmps <- intersect(colnames(dat1), colnames(dat2))
  dat1 <- dat1[, commonSmps]
  dat2 <- dat2[, commonSmps]
  # Keep only common features
  # Select first protein as representative if there are more than one
  rownames(dat1) <- stringr::str_remove(rownames(dat1), ';.*')
  rownames(dat2) <- stringr::str_remove(rownames(dat2), ';.*')
  commonFeats <- intersect(rownames(dat1), rownames(dat2))
  dat1 <- dat1[commonFeats,]
  dat2 <- dat2[commonFeats,]
  if (show_nFeats) {
    cat('Features in data1: ', nrow(data1), '\n', 'Features in data2: ', nrow(data2), '\n',
        'Features in common: ', length(commonFeats), sep = '')
  }
  
  # Compute feature correlations between two proteomics datasets
  # Do sanity check
  if (identical(rownames(dat1), rownames(dat2)) &
      identical(colnames(dat1), colnames(dat2))) {
    corrs <- sapply(seq_len(nrow(dat1)), function(i) {
      corr <- cor.test(dat1[i,], dat2[i,], method = 'pearson', use = "pairwise.complete.obs")
      corr$estimate
    })
    corrRes <- data.frame(Feature = rownames(dat1), Correlation = corrs) %>%
      dplyr::arrange(Correlation)
  }
  
  return(corrRes)
}


doFeatAssoTest <- function(data, condition) {
  #' Conduct univariate association test between each feature and CANCER RECURRENCE (for now)
  #' 
  #' Parameters
  #' data: A SummarizedExperiment object that contains the data matrix and metadata
  #' condition: A character specifying the sample metadata to split the dataset
  #' 
  #' Return
  #' assoTestRes: A table of feature significance test results
  
  # Subset samples
  subsetIdx <- which(colData(data)$Condition == condition)
  datSub <- data[, subsetIdx]
  datMat <- SummarizedExperiment::assay(datSub)
  
  if (all(complete.cases(datMat))) {
    # Perform analysis
    soaRes <- doSOA(datSub, meta_var = 'Recurrence')
    assoTestRes <- soaRes$tFeatRes %>%
      dplyr::select(Var1, pVal) %>%
      dplyr::rename(Feature = Var1)
  } else {
    smpAnno <- tibble::as_tibble(colData(datSub), rownames = 'Sample')
    # Perform analysis
    # Fit linear probabilistic dropout model to normalized data
    fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
    assoTestRes <- proDA::test_diff(fit,
                                 contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                 sort_by = 'pval') %>%
      dplyr::select(name, pval) %>%
      dplyr::rename(Feature = name, pVal = pval)
  }
  
  return(assoTestRes)
}

combineFeatAsso <- function(data1, data2, name1, name2, condition, prot_gene_tbl) {
  #' Conduct univariate association tests between features and CANCER RECURRENCE (for now)
  #' and combine and tidy up results and information into a table for making plots
  #' 
  #' Parameters
  #' data1, data2: SummarizedExperiment objects that contain the data matrices and metadata
  #' name1, name2: Characters indicating the dataset names in the plot legend
  #' condition: A character specifying the sample metadata to split the dataset
  #' prot_gene_tbl: A table containing proteins and their encoding genes for plot
  #' labeling. The column for proteins should be named 'Proteins' and for genes
  #' should be named 'Genes'. Furthermore, only the first protein and gene should
  #' be kept if there are more than one
  #' 
  #' Return:
  #' combinedAssoTestRes: A table containing association test results, labeling
  #' information, etc. for making plots
  
  # Extract common features between two datasets
  # Select first protein as representative if there are more than one
  commonFeats <- intersect(stringr::str_remove(rownames(data1), ';.*'),
                           stringr::str_remove(rownames(data2), ';.*'))
  
  # Compute associations between features and cancer recurrence and tidy up association test results
  assoTestRes_dat1 <- doFeatAssoTest(data1, condition = condition) %>%
    dplyr::mutate(Feature = stringr::str_remove(Feature, ';.*'),
                  Sig_dat1 = dplyr::case_when(pVal <= 0.05 ~ 'Yes',
                                              pVal > 0.05 ~ 'No')) %>%
    dplyr::filter(Feature %in% commonFeats) %>%
    dplyr::rename(pVal_dat1 = pVal)
  assoTestRes_dat2 <- doFeatAssoTest(data2, condition = condition) %>%
    dplyr::mutate(Feature = stringr::str_remove(Feature, ';.*'),
                  Sig_dat2 = dplyr::case_when(pVal <= 0.05 ~ 'Yes',
                                              pVal > 0.05 ~ 'No')) %>%
    dplyr::filter(Feature %in% commonFeats) %>%
    dplyr::rename(pVal_dat2 = pVal)
  
  # Combine association test results into a table and prepare color and label information
  combinedAssoTestRes <- dplyr::left_join(assoTestRes_dat1, assoTestRes_dat2, by = 'Feature') %>%
    dplyr::mutate(Significance = dplyr::case_when(Sig_dat1 == 'Yes' & Sig_dat2 == 'Yes' ~ 'Sig. in Both',
                                                  Sig_dat1 == 'Yes' & Sig_dat2 == 'No' ~ paste('Sig. in', name1),
                                                  Sig_dat1 == 'No' & Sig_dat2 == 'Yes' ~ paste('Sig. in', name2),
                                                  Sig_dat1 == 'No' & Sig_dat2 == 'No' ~ 'Not sig.'),
                  Gene = plyr::mapvalues(Feature,
                                         from = prot_gene_tbl$Proteins,
                                         to = prot_gene_tbl$Genes,
                                         warn_missing = F),
                  Label = dplyr::case_when(Significance == 'Sig. in Both' ~ Gene))
  # Reorder points in graph
  significance <- combinedAssoTestRes$Significance
  combinedAssoTestRes <- combinedAssoTestRes[c(which(significance == 'Not sig.'),
                                               which(significance == 'Sig. in Both'),
                                               which(significance == paste('Sig. in', name1)),
                                               which(significance == paste('Sig. in', name2))),]
  
  return(combinedAssoTestRes)
}
```

# Plasma Proteomics

```{r}
# Load preprocessed data
proPlasma_DIA <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm_DIA.rds')
proPlasma_DDA <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm.rds')
new_proPlasma_DIA <- readRDS('./data/AG_Krijgsveld/new_proPlasmaNorm_DIA.rds')
```

## Two DIA from AG Krijgsveld

Compute Pearson correlations of all common features between Plasma Proteomics datasets.
Note that both Baseline and Follow-up samples were used.\
New DIA (648) vs DIA (445) Plasma Proteomics both from AG Krijgsveld => 402 common features
```{r}
# Compute correlations of common features between two datasets
corrRes <- calcFeatCorr(new_proPlasma_DIA, proPlasma_DIA)

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.25, 1, 0.25))) +
  labs(y = 'Frequency', title = 'Two DIA Proteomics both from AG Krijgsveld') +
  th
```

Display associations of feature recurrence predictive power between Plasma Proteomics datasets\
Two DIA Plasma Proteomics both from AG Krijgsveld (significance level = 0.05)\
**Baseline Plasma**
```{r}
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(new_proPlasma_DIA), rownames = 'Proteins') %>%
  dplyr::select(Proteins, Genes) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))

# Prepare association test results including color and label information
combinedAssoTestRes <- combineFeatAsso(new_proPlasma_DIA, proPlasma_DIA, 'New DIA', 'DIA',
                                       condition = 'Baseline', prot_gene_tbl = featInfo)

ggplot(combinedAssoTestRes, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance, label=Label)) +
  geom_point(size = 3) +
  scale_color_manual(values = c('grey', 'red', 'darkgreen', 'navy')) +
  geom_text_repel(size = 5, show.legend = F) +
  labs(x = '-log10(pVal) of New DIA', y = '-log10(pVal) of DIA',
       title = 'Two DIA Baseline Plasma Proteomics both from AG Krijgsveld') +
  th
```

## New DIA vs DDA both from AG Krijgsveld

Compute Pearson correlations of all common features. Note that both Baseline and
Follow-up samples were used.\
New DIA (648) vs DDA (435) Plasma Proteomics both from AG Krijgsveld => 366 common features
```{r}
# Compute correlations of common features between two datasets
corrRes <- calcFeatCorr(new_proPlasma_DIA, proPlasma_DDA)

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.4, 1, 0.2))) +
  labs(y = 'Frequency', title = 'New DIA vs DDA Proteomics both from AG Krijgsveld') +
  th
```

Display associations of feature recurrence predictive power\
New DIA vs DDA Plasma Proteomics both from AG Krijgsveld (significance level = 0.05)\
**Baseline Plasma**
```{r}
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(new_proPlasma_DIA), rownames = 'Proteins') %>%
  dplyr::select(Proteins, Genes) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))

# Prepare association test results including color and label information
combinedAssoTestRes <- combineFeatAsso(new_proPlasma_DIA, proPlasma_DDA, 'New DIA', 'DDA',
                                       condition = 'Baseline', prot_gene_tbl = featInfo)

ggplot(combinedAssoTestRes, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance, label=Label)) +
  geom_point(size = 3) +
  scale_color_manual(values = c('grey', 'red', 'darkgreen', 'navy')) +
  geom_text_repel(size = 5, show.legend = F) +
  labs(x = '-log10(pVal) of New DIA', y = '-log10(pVal) of DDA',
       title = 'New DIA vs DDA Baseline Plasma Proteomics both from AG Krijgsveld') +
  th
```

## DIA vs DDA both from AG Krijgsveld

Compute Pearson correlations of all common features between Plasma Proteomics datasets.
Note that both Baseline and Follow-up samples were used.\
DIA (445) vs DDA (435) Plasma Proteomics both from AG Krijgsveld => 351 common features
```{r}
# Compute correlations of common features between two datasets
corrRes <- calcFeatCorr(proPlasma_DIA, proPlasma_DDA)

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.5, 1, 0.25))) +
  labs(y = 'Frequency', title = 'DIA vs DDA Proteomics both from AG Krijgsveld') +
  th
```

```{r include=F, eval=F}
ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.5, 1, 0.25))) +
  labs(y = 'Frequency') +
  th + theme(axis.title = element_text(size = 22),
             axis.text = element_text(size = 20))
ggsave('./output/group_meeting/proPlasma_Kri_DIA_DDA_comparison.png', device = 'png',
       dpi = 400, height = 8, width = 8)
```

Display associations of feature recurrence predictive power between Plasma Proteomics datasets\
DIA vs DDA Plasma Proteomics both from AG Krijgsveld (significance level = 0.05)\
**Baseline Plasma**
```{r}
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(proPlasma_DIA), rownames = 'Proteins') %>%
  dplyr::select(Proteins, Genes) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))

# Prepare association test results including color and label information
combinedAssoTestRes <- combineFeatAsso(proPlasma_DIA, proPlasma_DDA, 'DIA', 'DDA',
                                       condition = 'Baseline', prot_gene_tbl = featInfo)

ggplot(combinedAssoTestRes, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance, label=Label)) +
  geom_point(size = 3) +
  scale_color_manual(values = c('grey', 'red', 'darkgreen', 'navy')) +
  geom_text_repel(size = 5, show.legend = F) +
  labs(x = '-log10(pVal) of DIA', y = '-log10(pVal) of DDA',
       title = 'DIA vs DDA Baseline Plasma Proteomics both from AG Krijgsveld') +
  th
```




# Tissue Proteomics

```{r}
# Load preprocessed data
proTissue_DIA <- readRDS('./data/AG_Krijgsveld/proTissueNorm_DIA.rds')
proTissue_DDA <- readRDS('./data/AG_Krijgsveld/proTissueNorm.rds')
proTissue_DIA_Klin <- readRDS('./data/AG_Klingmuller/proTissueNorm_DIA.rds')
# Extract only Method Development samples
proTissue_DIA_Klin <- proTissue_DIA_Klin[, colnames(proTissue_DIA_Klin) %in% colnames(proTissue_DDA)]
new_proTissue_DIA <- readRDS('./data/AG_Krijgsveld/new_proTissueNorm_DIA.rds')
```

## DIA from AG Klingm√ºller vs New DIA from AG Krijgsveld

Compute Pearson correlations of all common features between Tissue Proteomics datasets.
Note that both Tumor and Normal samples were used.\
DIA Tissue Proteomics from AG Klingm√ºller (8257) vs New DIA Tissue Proteomics from
AG Krijgsveld (6873) => 6482 common features
```{r}
# Compute correlations of common features between two datasets
corrRes <- calcFeatCorr(proTissue_DIA_Klin, new_proTissue_DIA)

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.5, 1, 0.25))) +
  labs(y = 'Frequency', title = 'DIA Proteomics from AG Klingm√ºller vs New DIA from AG Krijgsveld') +
  th
```

Display associations of feature recurrence predictive power between Tissue Proteomics datasets\
DIA Tissue Proteomics from AG Klingm√ºller vs New DIA Tissue Proteomics from AG Krijgsveld
(significance level = 0.05)\
**Tumor Tissue**
```{r}
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(new_proTissue_DIA), rownames = 'Proteins') %>%
  dplyr::select(Proteins, Genes) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))

# Prepare association test results including color and label information
combinedAssoTestRes <- combineFeatAsso(proTissue_DIA_Klin, new_proTissue_DIA, 'DIA (Klin.)', 'DIA (Krij.)',
                                       condition = 'Tumor', prot_gene_tbl = featInfo)

ggplot(combinedAssoTestRes, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance, label=Label)) +
  geom_point(size = 3) +
  scale_color_manual(values = c('grey', 'red', 'darkgreen', 'navy')) +
  geom_text_repel(size = 5, show.legend = F) +
  labs(x = '-log10(pVal) of DIA (Klin.)', y = '-log10(pVal) of DIA (Krij.)',
       title = 'DIA Tumor Tissue Proteomics from AG Klingm√ºller vs New DIA from AG Krijgsveld') +
  th
```

**Normal Tissue**
```{r}
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(new_proTissue_DIA), rownames = 'Proteins') %>%
  dplyr::select(Proteins, Genes) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))

# Prepare association test results including color and label information
combinedAssoTestRes <- combineFeatAsso(proTissue_DIA_Klin, new_proTissue_DIA, 'DIA (Klin.)', 'DIA (Krij.)',
                                       condition = 'Normal', prot_gene_tbl = featInfo)

ggplot(combinedAssoTestRes, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance, label=Label)) +
  geom_point(size = 2) +
  scale_color_manual(values = c('grey', 'red', 'darkgreen', 'navy')) +
  geom_text_repel(size = 4, show.legend = F) +
  labs(x = '-log10(pVal) of DIA (Klin.)', y = '-log10(pVal) of DIA (Krij.)',
       title = 'DIA Normal Tissue Proteomics from AG Klingm√ºller vs New DIA from AG Krijgsveld') +
  th
```

## DIA from AG Klingm√ºller vs DDA from AG Krijgsveld

Compute Pearson correlations of all common features. Note that both Tumor and Normal
samples were used.\
DIA Tissue Proteomics from AG Klingm√ºller (8257) vs DDA Tissue Proteomics from AG
Krijgsveld (5193) => 5022 common features
```{r}
# Compute correlations of common features between two datasets
corrRes <- calcFeatCorr(proTissue_DIA_Klin, proTissue_DDA)

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.5, 1, 0.25))) +
  labs(y = 'Frequency', title = 'DIA Proteomics from AG Klingm√ºller vs DDA from AG Krijgsveld') +
  th
```

Display associations of feature recurrence predictive power\
DIA Tissue Proteomics from AG Klingm√ºller vs DDA Tissue Proteomics from AG Krijgsveld
(significance level = 0.05)\
**Tumor Tissue**
```{r}
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(proTissue_DDA), rownames = 'Proteins') %>%
  dplyr::select(Proteins, PG.Genes) %>%
  dplyr::rename(Genes = PG.Genes) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))

# Prepare association test results including color and label information
combinedAssoTestRes <- combineFeatAsso(proTissue_DIA_Klin, proTissue_DDA, 'DIA (Klin.)', 'DDA (Krij.)',
                                       condition = 'Tumor', prot_gene_tbl = featInfo)

ggplot(combinedAssoTestRes, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance, label=Label)) +
  geom_point(size = 3) +
  scale_color_manual(values = c('grey', 'red', 'darkgreen', 'navy')) +
  geom_text_repel(size = 5, show.legend = F) +
  labs(x = '-log10(pVal) of DIA (Klin.)', y = '-log10(pVal) of DDA (Krij.)',
       title = 'DIA Tumor Tissue Proteomics from AG Klingm√ºller vs DDA from AG Krijgsveld') +
  th
```

**Normal Tissue**
```{r}
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(proTissue_DDA), rownames = 'Proteins') %>%
  dplyr::select(Proteins, PG.Genes) %>%
  dplyr::rename(Genes = PG.Genes) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))

# Prepare association test results including color and label information
combinedAssoTestRes <- combineFeatAsso(proTissue_DIA_Klin, proTissue_DDA, 'DIA (Klin.)', 'DDA (Krij.)',
                                       condition = 'Normal', prot_gene_tbl = featInfo)

ggplot(combinedAssoTestRes, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance, label=Label)) +
  geom_point(size = 3) +
  scale_color_manual(values = c('grey', 'red', 'darkgreen', 'navy')) +
  geom_text_repel(size = 5, show.legend = F) +
  labs(x = '-log10(pVal) of DIA (Klin.)', y = '-log10(pVal) of DDA (Krij.)',
       title = 'DIA Normal Tissue Proteomics from AG Klingm√ºller vs DDA from AG Krijgsveld') +
  th
```

## New DIA vs DDA from AG Krijgsveld

Compute Pearson correlations of all common features. Note that both Tumor and Normal
samples were used.\
New DIA (6873) vs DDA (5193) Tissue Proteomics both from AG Krijgsveld => 4913 common features
```{r}
# Compute correlations of common features between two datasets
corrRes <- calcFeatCorr(new_proTissue_DIA, proTissue_DDA)

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.5, 1, 0.25))) +
  labs(y = 'Frequency', title = 'New DIA Proteomics vs DDA both from AG Krijgsveld') +
  th
```

Display associations of feature recurrence predictive power\
New DIA vs DDA Tissue Proteomics both from AG Krijgsveld (significance level = 0.05)\
**Tumor Tissue**
```{r}
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(new_proTissue_DIA), rownames = 'Proteins') %>%
  dplyr::select(Proteins, Genes) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))

# Prepare association test results including color and label information
combinedAssoTestRes <- combineFeatAsso(proTissue_DIA_Klin, proTissue_DDA, 'DIA', 'DDA',
                                       condition = 'Tumor', prot_gene_tbl = featInfo)

ggplot(combinedAssoTestRes, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance, label=Label)) +
  geom_point(size = 3) +
  scale_color_manual(values = c('grey', 'red', 'darkgreen', 'navy')) +
  geom_text_repel(size = 5, show.legend = F) +
  labs(x = '-log10(pVal) of DIA', y = '-log10(pVal) of DDA',
       title = 'New DIA vs DDA Tumor Tissue Proteomics both from AG Krijgsveld') +
  th
```

**Normal Tissue**
```{r}
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(new_proTissue_DIA), rownames = 'Proteins') %>%
  dplyr::select(Proteins, Genes) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))

# Prepare association test results including color and label information
combinedAssoTestRes <- combineFeatAsso(proTissue_DIA_Klin, proTissue_DDA, 'DIA', 'DDA',
                                       condition = 'Normal', prot_gene_tbl = featInfo)

ggplot(combinedAssoTestRes, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance, label=Label)) +
  geom_point(size = 3) +
  scale_color_manual(values = c('grey', 'red', 'darkgreen', 'navy')) +
  geom_text_repel(size = 5, show.legend = F) +
  labs(x = '-log10(pVal) of DIA', y = '-log10(pVal) of DDA',
       title = 'DIA vs DDA Normal Tissue Proteomics both from AG Krijgsveld') +
  th
```

## DIA from AG Klingm√ºller vs DIA from AG Krijgsveld

Compute Pearson correlations of all common features. Note that both Tumor and Normal
samples were used.\
DIA Tissue Proteomics from AG Klingm√ºller (8257) vs DIA Tissue Proteomics from AG
Krijgsveld (5658) => 5451 common features
```{r}
# Compute correlations of common features between two datasets
corrRes <- calcFeatCorr(proTissue_DIA_Klin, proTissue_DIA)

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.8, 0.6, 0.2))) +
  labs(y = 'Frequency', title = 'DIA Proteomics from AG Klingm√ºller vs AG Krijgsveld') +
  th
```

## DIA vs DDA from AG Krijgsveld

Compute Pearson correlations of all common features. Note that both Tumor and Normal
samples were used.\
DIA (5658) vs DDA (5193) Tissue Proteomics both from AG Krijgsveld => 4636 common features
```{r}
# Compute correlations of common features between two datasets
corrRes <- calcFeatCorr(proTissue_DIA, proTissue_DDA)

ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(-0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6)) +
  labs(y = 'Frequency', title = 'DIA vs DDA Tissue Proteomics both from AG Krijgsveld') +
  th
```

```{r include=F, eval=F}
ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-0.75, 0.65, 0.25))) +
  labs(y = 'Frequency') +
  th + theme(axis.title = element_text(size = 22),
             axis.text = element_text(size = 20))
ggsave('./output/group_meeting/proTissue_Kri_DIA_DDA_comparison.png', device = 'png',
       dpi = 400, height = 8, width = 8)
```
