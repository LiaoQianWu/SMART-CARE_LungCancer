---
title: 'Single-omics analysis: Untargeted Metabolomics of Method Development cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Conduct univariate (t-test) and multivariate (PCA)
analyses on individual datasets, i.e., Plasma and Tissue Untargeted Metabolomics
and Lipidomics generated by AG Hopf, to have overview of data and take initial look
at data power in terms of predicting patient cancer recurrence. Association between
each feature (metabolite and lipid level) and cancer recurrence was tested by t-test,
which captures significant features that can separate recurrence and non-recurrence
patient groups. PCA was performed to view sources of data variance associated with
certain metadata variables. </font>

**Metadata variables**\
Patient (n = 20):\
Recurrence -> Cancer recurrences, Yes:No = 1:1\
Gender -> Male:Female = 13:7\
Age -> Diagnosis ages ranging from 56 to 84\
Smoking -> Smoker:Ex-smoker:Non-Smoker = 3:14:3\
Stage -> Pathological stages, IB:IIA:IIB = 11:8:1\
Adjuvant -> Adjuvant chemotherapy, True:False = 13:7\
Sample (n = 40):\
Condition -> Tissue sample conditions, Tumor:Normal = 1:1\
TimePoint -> Plasma sample collection time points, Baseline:2 years later = 1:1

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer')
```

Load libraries
```{r library loading, message = F}
library('SummarizedExperiment')
library('pcaMethods')
library('proDA')
library('limma')
library('pheatmap')
library('ggrepel')
library('openxlsx')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

Display associations between cancer recurrence and the other patient metadata variables
to identify potential predictors (or confounders)
```{r}
# Test associations between metadata variables
# Prepare sample metadata
metaPlasmaVsn <- readRDS('./data/MethodDev/AG_Hopf/metaPlasmaVsn.rds')
patientMetadat <- tibble::as_tibble(colData(metaPlasmaVsn)) %>%
  dplyr::filter(!duplicated(Patient)) %>%
  dplyr::select(Patient, Recurrence, Gender, Age, Smoking, Stage, Adjuvant)
patientRecur <- dplyr::select(patientMetadat, Patient, Recurrence)
patientMetadat <- dplyr::select(patientMetadat, -Recurrence)
testAsso(patientMetadat, patientRecur, cmn_col = 'Patient') %>%
  dplyr::select(-Stat)
```

# Plasma Metabolomics
Based on PCA result obtained by analyzing whole Plasma Metabolomics dataset that
includes Baseline and Follow-up samples, we found that PCA mainly captures source
of variation in time points, the unwanted variation. Besides, we attempt to identify
biomarkers that can predict whether patients WILL experience cancer recurrence or
not. Therefore, we decided to analyze Baseline and Follow-up samples separately.

```{r}
# Load normalized data
metaPlasmaVsn <- readRDS('./data/MethodDev/AG_Hopf/metaPlasmaVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(metaPlasmaVsn), rownames = 'Feature')

# Perform analysis
metaPlasmaRes <- doSOA(metaPlasmaVsn, meta_var = 'TimePoint', pca_method = 'ppca', do_onlyPCA = T)
pcSigAssoRes <- metaPlasmaRes$pcSigAssoRes
pcTab <- metaPlasmaRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variable (Var2)
```{r}
# Display PCs of interest
pcSigAssoRes
```

PC1 explains large amount of variation in data and separates samples by time points.
```{r}
ggplot(pcTab, aes(x=TimePoint, y=`PC1 (24.4%)`, col=TimePoint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  labs(x = 'Sample collection time point', color = 'Time Point') +
  th
```

## Baseline samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(metaPlasmaVsn)$Condition == 'Baseline')
metaBase <- metaPlasmaVsn[, smpBaseIdx]

# Display significant associations between PCs and metadata variables
metaBaseAssoRes <- doSOA(metaBase, meta_var = c('Recurrence', 'Gender', 'Age',
                                                'Smoking', 'Stage', 'Adjuvant'),
                         pca_method = 'ppca', do_onlyPCA = T, num_PCs = 17)
metaBaseAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaBaseRes <- doSOA(metaBase, meta_var = 'Recurrence', pca_method = 'ppca',
                     num_PCs = 17, num_PCfeats = 30)
datMat <- metaBaseRes$data
smpAnno <- metaBaseRes$smpMetadata
featSigAssoRes <- metaBaseRes$featSigAssoRes
pcSigAssoRes <- metaBaseRes$pcSigAssoRes
pcTab <- metaBaseRes$pcTab
pcTopFeatTab <- metaBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, m.z_RT = plyr::mapvalues(Var1,
                                                                         from = featInfo$Feature,
                                                                         to = featInfo$m.z_RT,
                                                                         warn_missing = F))
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', #row scaling is across columns
         main = 'Baseline plasma metabolomics')
```

Owing to missing values, there might be a situation that only few observations in
sample groups, resulting in unreliable t-statistics. We used probabilistic dropout
model (proDA package) to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAMetaBaseRes <- proDA::test_diff(fit,
                                         contrast = `smpAnno$RecurrenceYes`,
                                         sort_by = 'pval')
proDAMetaBaseRes <- dplyr::select(all_proDAMetaBaseRes,
                                  -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(m.z_RT = plyr::mapvalues(name,
                                         from = featInfo$Feature,
                                         to = featInfo$m.z_RT,
                                         warn_missing = F))
proDAMetaBaseRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaBaseRes, dplyr::desc(t_statistic))$name
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Baseline plasma metabolomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- list(BasePlasmaMetab_Feats = proDAMetaBaseRes)
```

```{r}
ovl <- intersect(metaBaseRes$featSigAssoRes$Var1, proDAMetaBaseRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```
-> Most of recurrence-related features captured by proDA are covered in ordinary t-test.
<br/>
<br/>

Visualize data of top 6 significant features based on proDA result (ns: p > 0.05,
$*$: p <= 0.05, $**$: p <= 0.01, $***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including all samples
dat <- metaPlasmaRes$data
anno <- metaPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Baseline', 'No_Baseline', 'Yes_Follow-up', 'No_Follow-up')
tpCol = c('firebrick', 'grey50') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- proDAMetaBaseRes[1:num_sigFeats,] %>%
  dplyr::select(name, m.z_RT) %>%
  dplyr::rename(Var1 = name) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', m.z_RT, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(anno, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Baseline', 'No_Baseline'),
                                                c('Yes_Follow-up', 'No_Follow-up')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- all_proDAMetaBaseRes$pval
hist(p, xlab = 'P-value', main = 'Baseline Plasma Metabolomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

PC14 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC14 (2.6%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Baseline plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

Plot molecular signatures captured by PC14 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
There is no single feature that can decently hint if patients will suffer cancer
recurrence or not, which means each of these top features contributes a bit to
explaining variation between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC14$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap(datMat[topFeatsIdx, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F,
         scale = 'row', main = 'Baseline plasma metabolomics - PC14')
```

Display top features that build the PC14
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC14, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(BasePlasmaMetab_PC14 = pcTopFeats))
```

## Follow-up samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(metaPlasmaVsn)$Condition != 'Baseline')
metaFolo <- metaPlasmaVsn[, smpFoloIdx]

# Display significant associations between PCs and metadata variables
metaFoloAssoRes <- doSOA(metaFolo, meta_var = c('Recurrence', 'Gender', 'Adjuvant'),
                         pca_method = 'ppca', do_onlyPCA = T, num_PCs = 17)
metaFoloAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and recurrence (Var2) and
observe molecular signatures in input data through heatmap. Use probabilistic dropout
model (proDA package) to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaFoloRes <- doSOA(metaFolo, meta_var = 'Recurrence', pca_method = 'ppca',
                     num_PCs = 17, num_PCfeats = 30, use_proDA = T)
datMat <- metaFoloRes$data
smpAnno <- metaFoloRes$smpMetadata
featSigAssoRes <- metaFoloRes$featSigAssoRes
featAssoRes <- metaFoloRes$featAssoRes
pcSigAssoRes <- metaFoloRes$pcSigAssoRes
pcTab <- metaFoloRes$pcTab
pcTopFeatTab <- metaFoloRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, m.z_RT = plyr::mapvalues(Var1,
                                                                         from = featInfo$Feature,
                                                                         to = featInfo$m.z_RT,
                                                                         warn_missing = F))
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Follow-up plasma metabolomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaMetab_Feats = featSigAssoRes))
# Prepare significant feature table for summary
proDAMetaFoloRes <- featSigAssoRes
all_proDAMetaFoloRes <- featAssoRes
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including all samples
dat <- metaPlasmaRes$data
anno <- metaPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Follow-up', 'No_Follow-up', 'Yes_Baseline', 'No_Baseline')
tpCol = c('grey50', 'firebrick') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, m.z_RT) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', m.z_RT, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(anno, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Follow-up', 'No_Follow-up'),
                                                c('Yes_Baseline', 'No_Baseline')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Follow-up Plasma Metabolomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC13 (3.2%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Follow-up plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC13, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaMetab_PC13 = pcTopFeats))
```




# Plasma Lipidomics
As described in Plasma Metabolomics section, we analyzed Baseline and Follow-up
samples separately.

```{r}
# Load normalized data
lipPlasmaVsn <- readRDS('./data/MethodDev/AG_Hopf/lipPlasmaVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(lipPlasmaVsn), rownames = 'Feature')

# Perform analysis
lipPlasmaRes <- doSOA(lipPlasmaVsn, meta_var = 'TimePoint', pca_method = 'ppca', do_onlyPCA = T)
pcSigAssoRes <- lipPlasmaRes$pcSigAssoRes
pcTab <- lipPlasmaRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variable (Var2)
```{r}
# Display PCs of interest
pcSigAssoRes
```

PC1 and PC2 explain large amount of variation in data and separate samples by time point.
```{r}
ggplot(pcTab, aes(x=`PC1 (16.7%)`, y=`PC2 (12.8%)`, col=TimePoint, group=Patient)) +
  geom_point(size = 5) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  scale_color_discrete(name = 'Time point') +
  th
```

## Baseline samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(lipPlasmaVsn)$Condition == 'Baseline')
lipBase <- lipPlasmaVsn[, smpBaseIdx]

# Display significant associations between PCs and metadata variables
lipBaseAssoRes <- doSOA(lipBase, meta_var = c('Recurrence', 'Gender', 'Age',
                                              'Smoking', 'Stage', 'Adjuvant'),
                        pca_method = 'ppca', do_onlyPCA = T, num_PCs = 17)
lipBaseAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and recurrence (Var2) and
observe molecular signatures in input data through heatmap. Use probabilistic dropout
model (proDA package) to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
lipBaseRes <- doSOA(lipBase, meta_var = 'Recurrence', pca_method = 'ppca',
                    num_PCs = 17, num_PCfeats = 30, use_proDA = T)
datMat <- lipBaseRes$data
smpAnno <- lipBaseRes$smpMetadata
featSigAssoRes <- lipBaseRes$featSigAssoRes
featAssoRes <- lipBaseRes$featAssoRes
pcSigAssoRes <- lipBaseRes$pcSigAssoRes
pcTab <- lipBaseRes$pcTab
pcTopFeatTab <- lipBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, m.z_RT = plyr::mapvalues(Var1,
                                                                         from = featInfo$Feature,
                                                                         to = featInfo$m.z_RT,
                                                                         warn_missing = F))
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Baseline plasma lipidomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(BasePlasmaLipid_Feats = featSigAssoRes))
# Prepare significant feature table for summary
proDALipBaseRes <- featSigAssoRes
all_proDALipBaseRes <- featAssoRes
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including all samples
dat <- lipPlasmaRes$data
anno <- lipPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Baseline', 'No_Baseline', 'Yes_Follow-up', 'No_Follow-up')
tpCol = c('firebrick', 'grey50') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, m.z_RT) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', m.z_RT, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(anno, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Baseline', 'No_Baseline'),
                                                c('Yes_Follow-up', 'No_Follow-up')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Baseline Plasma Lipidomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC5 (6%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Baseline plasma lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC5, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(BasePlasmaLipid_PC5 = pcTopFeats))
```

## Follow-up samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(lipPlasmaVsn)$Condition != 'Baseline')
lipFolo <- lipPlasmaVsn[, smpFoloIdx]
# Remove features fully missing
allNAsIdx <- which(apply(SummarizedExperiment::assay(lipFolo), 1, function(x) {all(is.na(x))}))
lipFolo <- lipFolo[-allNAsIdx,]

# Display significant associations between PCs and metadata variables
lipFoloAssoRes <- doSOA(lipFolo, meta_var = c('Recurrence', 'Gender', 'Adjuvant'),
                        pca_method = 'ppca', do_onlyPCA = T, num_PCs = 17)
lipFoloAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and recurrence (Var2) and
observe molecular signatures in input data through heatmap. Use probabilistic dropout
model (proDA package) to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
lipFoloRes <- doSOA(lipFolo, meta_var = 'Recurrence', pca_method = 'ppca',
                    num_PCs = 17, num_PCfeats = 30, use_proDA = T)
datMat <- lipFoloRes$data
smpAnno <- lipFoloRes$smpMetadata
featSigAssoRes <- lipFoloRes$featSigAssoRes
featAssoRes <- lipFoloRes$featAssoRes
pcSigAssoRes <- lipFoloRes$pcSigAssoRes
pcTab <- lipFoloRes$pcTab
pcTopFeatTab <- lipFoloRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, m.z_RT = plyr::mapvalues(Var1,
                                                                         from = featInfo$Feature,
                                                                         to = featInfo$m.z_RT,
                                                                         warn_missing = F)) %>%
  dplyr::select(-Test)
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = F,
         scale = 'row', main = 'Follow-up plasma lipidomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaLipid_Feats = featSigAssoRes))
# Prepare significant feature table for summary
proDALipFoloRes <- featSigAssoRes
all_proDALipFoloRes <- featAssoRes
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including all samples
dat <- lipPlasmaRes$data
anno <- lipPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Follow-up', 'No_Follow-up', 'Yes_Baseline', 'No_Baseline')
tpCol = c('grey50', 'firebrick') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, m.z_RT) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', m.z_RT, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(anno, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Follow-up', 'No_Follow-up'),
                                                c('Yes_Baseline', 'No_Baseline')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Follow-up Plasma Lipidomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC4 (8%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Follow-up plasma lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC4, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaLipid_PC4 = pcTopFeats))
```




# Tissue Metabolomics
Based on PCA result obtained by analyzing whole Tissue Metabolomics dataset that
includes Tumor and Normal samples, we found that PCA mainly captures source of
variation in tissue conditions, which is not of direct interest. In addition,
recurrence-related significant PCs do not work that well, perhaps because Tumor
and Normal samples are noise to each other. Therefore, we decided to analyze Tumor
and Normal samples separately.

```{r}
# Load normalized data
metaTissueVsn <- readRDS('./data/MethodDev/AG_Hopf/metaTissueVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(metaTissueVsn), rownames = 'Feature')

# Perform analysis
metaTissueRes <- doSOA(metaTissueVsn, meta_var = c('Recurrence', 'Condition'),
                       pca_method = 'ppca', do_onlyPCA = T)
pcSigAssoRes <- metaTissueRes$pcSigAssoRes
pcTab <- metaTissueRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variable
(Var2). Note that each patient has two samples that have same recurrence annotations,
so association test results may have additive effects.
```{r}
# Display PCs of interest
pcSigAssoRes
```

PCA mainly capture variation in sample conditions (tumor and normal) and those
PCs significantly associated with cancer recurrence do not perform that well.
```{r}
ggplot(pcTab, aes(x=`PC1 (16.5%)`, y=`PC2 (12.7%)`, col=Condition, group=Patient)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Dark2') +
  geom_line(col = 'grey50', linetype = 'dashed') +
  th

ggplot(pcTab, aes(x=Recurrence, y=`PC14 (2.5%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

## Tumor samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(metaTissueVsn)$Condition == 'Tumor')
metaTumor <- metaTissueVsn[, smpTumorIdx]

# Display significant associations between PCs and metadata variables
metaTumorAssoRes <- doSOA(metaTumor, meta_var = c('Recurrence', 'Gender', 'Age',
                                                  'Smoking', 'Stage', 'Adjuvant', 'TumorPurity'),
                          pca_method = 'ppca', do_onlyPCA = T, num_PCs = 18)
metaTumorAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and recurrence (Var2) and
observe molecular signatures in input data through heatmap. Use probabilistic dropout
model (proDA package) to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaTumorRes <- doSOA(metaTumor, meta_var = 'Recurrence', pca_method = 'ppca',
                      num_PCs = 18, num_PCfeats = 30, use_proDA = T)
datMat <- metaTumorRes$data
smpAnno <- metaTumorRes$smpMetadata
featSigAssoRes <- metaTumorRes$featSigAssoRes
featAssoRes <- metaTumorRes$featAssoRes
pcSigAssoRes <- metaTumorRes$pcSigAssoRes
pcTab <- metaTumorRes$pcTab
pcTopFeatTab <- metaTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, MZ.RT = plyr::mapvalues(Var1,
                                                                        from = featInfo$Feature,
                                                                        to = featInfo$MZ.RT,
                                                                        warn_missing = F))
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         fontsize = 16, fontsize_col = 14,
         scale = 'row', main = 'Tumor tissue metabolomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(TumorTissueMetab_Feats = featSigAssoRes))
# Prepare significant feature table for summary
proDAMetaTumorRes <- featSigAssoRes
all_proDAMetaTumorRes <- featAssoRes
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- metaTissueRes$data
smpAnnoTab <- metaTissueRes$smpMetadata
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Tumor', 'No_Tumor', 'Yes_Normal', 'No_Normal')
condiCol = c('grey50', 'firebrick') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, MZ.RT) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', MZ.RT, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Tumor', 'No_Tumor'), c('Yes_Normal', 'No_Normal')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Tumor Tissue Metabolomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC17 (1.7%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Tumor tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 9) +
  th

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC17, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(TumorTissueMetab_PC17 = pcTopFeats))
```

## Normal samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(metaTissueVsn)$Condition == 'Normal')
metaNormal <- metaTissueVsn[, smpNormalIdx]
# Remove features fully missing
allNAsIdx <- which(apply(SummarizedExperiment::assay(metaNormal), 1, function(x) {all(is.na(x))}))
metaNormal <- metaNormal[-allNAsIdx,]

# Display significant associations between PCs and metadata variables
metaNormalAssoRes <- doSOA(metaNormal, meta_var = c('Recurrence', 'Gender', 'Age',
                                                    'Smoking', 'Stage', 'Adjuvant'),
                           pca_method = 'ppca', do_onlyPCA = T, num_PCs = 18)
metaNormalAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and recurrence (Var2) and
observe molecular signatures in input data through heatmap. Use probabilistic dropout
model (proDA package) to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaNormalRes <- doSOA(metaNormal, meta_var = 'Recurrence', pca_method = 'ppca',
                       num_PCs = 18, num_PCfeats = 30, use_proDA = T)
datMat <- metaNormalRes$data
smpAnno <- metaNormalRes$smpMetadata
featSigAssoRes <- metaNormalRes$featSigAssoRes
featAssoRes <- metaNormalRes$featAssoRes
pcSigAssoRes <- metaNormalRes$pcSigAssoRes

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, MZ.RT = plyr::mapvalues(Var1,
                                                                        from = featInfo$Feature,
                                                                        to = featInfo$MZ.RT,
                                                                        warn_missing = F))
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Normal tissue metabolomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(NormalTissueMetab_Feats = featSigAssoRes))
# Prepare significant feature table for summary
proDAMetaNormalRes <- featSigAssoRes
all_proDAMetaNormalRes <- featAssoRes
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- metaTissueRes$data
smpAnnoTab <- metaTissueRes$smpMetadata
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Normal', 'No_Normal', 'Yes_Tumor', 'No_Tumor')
condiCol = c('firebrick', 'grey50') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, MZ.RT) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', MZ.RT, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Normal', 'No_Normal'), c('Yes_Tumor', 'No_Tumor')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Normal Tissue Metabolomics (proDA)')
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```




# Tissue Lipidomics
As described in Tissue Metabolomics section, we analyzed Tumor and Normal samples separately.

```{r}
# Load normalized data
lipTissueVsn <- readRDS('./data/MethodDev/AG_Hopf/lipTissueVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(lipTissueVsn), rownames = 'Feature')

# Perform analysis
lipTissueRes <- doSOA(lipTissueVsn, meta_var = c('Recurrence', 'Condition'),
                      pca_method = 'ppca', do_onlyPCA = T)
pcSigAssoRes <- lipTissueRes$pcSigAssoRes
pcTab <- lipTissueRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variable
(Var2). Note that each patient has two samples that have same recurrence annotations,
so association test results may have additive effects.
```{r}
# Display PCs of interest
pcSigAssoRes
```

PCA tends to capture variation in sample conditions (tumor and normal) and those
PCs significantly associated with cancer recurrence do not perform that well.
```{r}
ggplot(pcTab, aes(x=Condition, y=`PC1 (22.5%)`, color=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(x = 'Sample condition') +
  th

ggplot(pcTab, aes(x=Recurrence, y=`PC13 (2.1%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

## Tumor samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(lipTissueVsn)$Condition == 'Tumor')
lipTumor <- lipTissueVsn[, smpTumorIdx]

# Display significant associations between PCs and metadata variables
lipTumorAssoRes <- doSOA(lipTumor, meta_var = c('Recurrence', 'Gender', 'Age',
                                                'Smoking', 'Stage', 'Adjuvant', 'TumorPurity'),
                         pca_method = 'ppca', do_onlyPCA = T, num_PCs = 18)
lipTumorAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and recurrence (Var2) and
observe molecular signatures in input data through heatmap. Use probabilistic dropout
model (proDA package) to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
lipTumorRes <- doSOA(lipTumor, meta_var = 'Recurrence', pca_method = 'ppca',
                     num_PCs = 18, num_PCfeats = 30, use_proDA = T)
datMat <- lipTumorRes$data
smpAnno <- lipTumorRes$smpMetadata
featSigAssoRes <- lipTumorRes$featSigAssoRes
featAssoRes <- lipTumorRes$featAssoRes
pcSigAssoRes <- lipTumorRes$pcSigAssoRes

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, MZ.RT = plyr::mapvalues(Var1,
                                                                        from = featInfo$Feature,
                                                                        to = featInfo$MZ.RT,
                                                                        warn_missing = F))
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Tumor tissue lipidomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(TumorTissueLipid_Feats = featSigAssoRes))
# Prepare significant feature table for summary
proDALipTumorRes <- featSigAssoRes
all_proDALipTumorRes <- featAssoRes
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- lipTissueRes$data
smpAnnoTab <- lipTissueRes$smpMetadata
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Tumor', 'No_Tumor', 'Yes_Normal', 'No_Normal')
condiCol = c('grey50', 'firebrick') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, MZ.RT) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', MZ.RT, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Tumor', 'No_Tumor'), c('Yes_Normal', 'No_Normal')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Tumor Tissue Lipidomics (proDA)')
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

## Normal samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(lipTissueVsn)$Condition == 'Normal')
lipNormal <- lipTissueVsn[, smpNormalIdx]
# Remove features fully missing
allNAsIdx <- which(apply(SummarizedExperiment::assay(lipNormal), 1, function(x) {all(is.na(x))}))
lipNormal <- lipNormal[-allNAsIdx,]

# Display significant associations between PCs and metadata variables
lipNormalAssoRes <- doSOA(lipNormal, meta_var = c('Recurrence', 'Gender', 'Age',
                                                  'Smoking', 'Stage', 'Adjuvant'),
                          pca_method = 'ppca', do_onlyPCA = T, num_PCs = 18)
lipNormalAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and recurrence (Var2) and
observe molecular signatures in input data through heatmap. Use probabilistic dropout
model (proDA package) to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
lipNormalRes <- doSOA(lipNormal, meta_var = 'Recurrence', pca_method = 'ppca',
                      num_PCs = 18, num_PCfeats = 30, use_proDA = T)
datMat <- lipNormalRes$data
smpAnno <- lipNormalRes$smpMetadata
featSigAssoRes <- lipNormalRes$featSigAssoRes
featAssoRes <- lipNormalRes$featAssoRes
pcSigAssoRes <- lipNormalRes$pcSigAssoRes
pcTab <- lipNormalRes$pcTab
pcTopFeatTab <- lipNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, MZ.RT = plyr::mapvalues(Var1,
                                                                        from = featInfo$Feature,
                                                                        to = featInfo$MZ.RT,
                                                                        warn_missing = F))
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Normal tissue lipidomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(NormalTissueLipid_Feats = featSigAssoRes))
# Prepare significant feature table for summary
proDALipNormalRes <- featSigAssoRes
all_proDALipNormalRes <- featAssoRes
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- lipTissueRes$data
smpAnnoTab <- lipTissueRes$smpMetadata
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Normal', 'No_Normal', 'Yes_Tumor', 'No_Tumor')
condiCol = c('firebrick', 'grey50') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, MZ.RT) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', MZ.RT, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Normal', 'No_Normal'), c('Yes_Tumor', 'No_Tumor')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Normal Tissue Lipidomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC15 (1.5%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Normal tissue lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  th

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC15, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(NormalTissueLipid_PC15 = pcTopFeats))
```




# Summary

```{r}
# Export tables containing significant features as Excel file
# write.xlsx(sigFeatSheet,
#            file = paste0(project_path, 'results/single-omics_significant_features.xlsx'))
```

Display proportion of recurrence-related significant features (done by proDA) in
each dataset. Alpha was set to 0.05 and numbers after bars indicate feature sizes.
Note that results were not corrected through any p-value adjustment method and linear
models accounted only for recurrence, so there may be abundant false positives.
```{r}
# Barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats <- nrow(proDAMetaBaseRes) / nrow(metaBaseRes$data) * 100
metaFoloSigFeats <- nrow(proDAMetaFoloRes) / nrow(metaFoloRes$data) * 100
lipBaseSigFeats <- nrow(proDALipBaseRes) / nrow(lipBaseRes$data) * 100
lipFoloSigFeats <- nrow(proDALipFoloRes) / nrow(lipFoloRes$data) * 100
metaTumorSigFeats <- nrow(proDAMetaTumorRes) / nrow(metaTumorRes$data) * 100
metaNormalSigFeats <- nrow(proDAMetaNormalRes) / nrow(metaNormalRes$data) * 100
lipTumorSigFeats <- nrow(proDALipTumorRes) / nrow(lipTumorRes$data) * 100
lipNormalSigFeats <- nrow(proDALipNormalRes) / nrow(lipNormalRes$data) * 100

# Prepare needed information for barplot
dat <- rev(c('Baseline Plasma Metabolomics', 'Follow-up Plasma Metabolomics',
             'Baseline Plasma Lipidomics', 'Follow-up Plasma Lipidomics',
             'Tumor Tissue Metabolomics', 'Normal Tissue Metabolomics',
             'Tumor Tissue Lipidomics', 'Normal Tissue Lipidomics'))
datModal <- rev(c(rep('Plasma Metabolomics', 2), rep('Plasma Lipidomics', 2),
                  rep('Tissue Metabolomics', 2), rep('Tissue Lipidomics', 2)))
datOf <- rev(c(rep('Plasma', 4), rep('Tissue', 4)))
proportion <- rev(c(metaBaseSigFeats, metaFoloSigFeats,
                    lipBaseSigFeats, lipFoloSigFeats,
                    metaTumorSigFeats, metaNormalSigFeats,
                    lipTumorSigFeats, lipNormalSigFeats))
numFeat <- rev(c(nrow(metaBaseRes$data), nrow(metaFoloRes$data),
                 nrow(lipBaseRes$data), nrow(lipFoloRes$data),
                 nrow(metaTumorRes$data), nrow(metaNormalRes$data),
                 nrow(lipTumorRes$data), nrow(lipNormalRes$data)))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = dat),
                             Data_modality = datModal,
                             Data_of = datOf,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill=Data_of, label=Feature_number)) +
  geom_bar(stat = 'identity') +
  ylim(0, 9) +
  coord_flip() +
  geom_text(size = 5, hjust = -0.2) +
  labs(y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Sample Type') +
  th
```
1. Plasma datasets got overall higher proportions of Recurrence-related features
than Tissue while they have similar feature sizes. This unbiased result indicates
that Plasma samples can potentially provide more information in terms of separating
recurrence and non-recurrence patient groups and Tissue samples are more noisy.\
2. There is a way higher proportion of Recurrence-related features in Follow-up
Plasma Lipidomics compared to the results of the other datasets, and in the meantime,
there are much more replicated features (same m/z and retention time) in Plasma
Lipidomics dataset. Are many of these Recurrence-related features replicates? No,
there are only 3 (out of 255) replicates in the significance test result, which is negligible.
<br/>
<br/>

```{r, include = F, eval = F}
# Retrieve m/z and retention time information of features
featInfo <- tibble::as_tibble(rowData(lipPlasmaVsn), rownames = 'Feature')
# Collect duplicated features, i.e., identical m/z and retention time
dupMZ.RT <- rowData(lipPlasmaVsn)$`m/z_RT`
dupMZ.RT <- unique(dupMZ.RT[duplicated(dupMZ.RT)])
cat('There are', length(dupMZ.RT), 'features in replicate in Plasma Lipidomics,',
    'resulting in total', sum(featInfo$m.z_RT %in% dupMZ.RT), 'replicated features.')

# Display duplicated features in significance test result not accounting for missing
# values
dplyr::select(lipFoloRes$tFeatSigRes, Var1) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(Var1,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F)) %>%
  dplyr::filter(MZ_RT %in% dupMZ.RT, duplicated(MZ_RT))
# Display duplicated features in significance test result accounting for missing
# values
# dplyr::filter(proDALipFoloRes, MZ_RT %in% dupMZ.RT)
```

Visualize recurrence-related features through volcano plots. Significance results
were done by proDA. Log2-FC (up and down) is recurrence to non-recurrence groups.
To be clearer, entities on up side are more abundant in recurrence group than non-recurrence
group, and so forth.
```{r message = F}
# Volcano plots for summarizing association test results between features and recurrence
# Prepare feature information for converting feature IDs to m/z ratio and retention time
metaPlasmaFeatInfo <- tibble::as_tibble(rowData(metaPlasmaVsn), rownames = 'Feature_ID')
lipPlasmaFeatInfo <- tibble::as_tibble(rowData(lipPlasmaVsn), rownames = 'Feature_ID')
metaTissueFeatInfo <- tibble::as_tibble(rowData(metaTissueVsn), rownames = 'Feature_ID')
lipTissueFeatInfo <- tibble::as_tibble(rowData(lipTissueVsn), rownames = 'Feature_ID')

# Prepare log2-fold change information
# PM
metaPlasmaMedi <- readRDS('./data/MethodDev/AG_Hopf/metaPlasmaMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPM
metaBaseLogFC <- dplyr::filter(metaPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPM
metaFoloLogFC <- dplyr::filter(metaPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# PL
lipPlasmaMedi <- readRDS('./data/MethodDev/AG_Hopf/lipPlasmaMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPL
lipBaseLogFC <- dplyr::filter(lipPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPL
lipFoloLogFC <- dplyr::filter(lipPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TM
metaTissueMedi <- readRDS('./data/MethodDev/AG_Hopf/metaTissueMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTM
metaTumorLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTM
metaNormalLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TL
lipTissueMedi <- readRDS('./data/MethodDev/AG_Hopf/lipTissueMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTL
lipTumorLogFC <- dplyr::filter(lipTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTL
lipNormalLogFC <- dplyr::filter(lipTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)


# Collect all needed information for volcano plots
# Baseline Plasma Metabolomics
metaBaseVolTab <- dplyr::select(all_proDAMetaBaseRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(metaBaseLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Baseline Plasma Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaPlasmaFeatInfo$Feature_ID,
                                        to = metaPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))
# Follow-up Plasma Metabolomics
metaFoloVolTab <- dplyr::select(all_proDAMetaFoloRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaFoloLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Follow-up Plasma Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaPlasmaFeatInfo$Feature_ID,
                                        to = metaPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))

# Baseline Plasma Lipidomics
lipBaseVolTab <- dplyr::select(all_proDALipBaseRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(lipBaseLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Baseline Plasma Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipPlasmaFeatInfo$Feature_ID,
                                        to = lipPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))
# Follow-up Plasma Lipidomics
lipFoloVolTab <- dplyr::select(all_proDALipFoloRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(lipFoloLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Follow-up Plasma Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipPlasmaFeatInfo$Feature_ID,
                                        to = lipPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))

# Tumor Tissue Metabolomics
metaTumorVolTab <- dplyr::select(all_proDAMetaTumorRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaTumorLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Tumor Tissue Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaTissueFeatInfo$Feature_ID,
                                        to = metaTissueFeatInfo$MZ.RT,
                                        warn_missing = F))
# Normal Tissue Metabolomics
metaNormalVolTab <- dplyr::select(all_proDAMetaNormalRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaNormalLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Normal Tissue Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaTissueFeatInfo$Feature_ID,
                                        to = metaTissueFeatInfo$MZ.RT,
                                        warn_missing = F))

# Tumor Tissue Lipidomics
lipTumorVolTab <- dplyr::select(all_proDALipTumorRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(lipTumorLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Tumor Tissue Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipTissueFeatInfo$Feature_ID,
                                        to = lipTissueFeatInfo$MZ.RT,
                                        warn_missing = F))
# Normal Tissue Lipidomics
lipNormalVolTab <- dplyr::select(all_proDALipNormalRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(lipNormalLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Normal Tissue Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipTissueFeatInfo$Feature_ID,
                                        to = lipTissueFeatInfo$MZ.RT,
                                        warn_missing = F))
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# BPM
volTab <- metaBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Metabolomics') +
  th
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# FPM
volTab <- metaFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Metabolomics') +
  th
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# BPL
volTab <- lipBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 3) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 5, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Lipidomics') +
  th
```

Log2-FC cutoffs are 1 (FC=2) and -1 (FC=0.5).
```{r}
# FPL
volTab <- lipFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 1] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -1] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-1, 1), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Lipidomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.4) and -0.5 (FC=0.7).
```{r}
# TTM
volTab <- metaTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), color=DE, label=Label)) +
  geom_point(size = 3.5) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3.5, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Metabolomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.4) and -0.5 (FC=0.7).
```{r}
# NTM
volTab <- metaNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Metabolomics') +
  th
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# TTL
volTab <- lipTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Lipidomics') +
  th
```

Log2-FC cutoffs are 0.9 (FC=1.9) and -0.9 (FC=0.5).
```{r}
# NTL
volTab <- lipNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.9] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.9] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.9, 0.9), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Lipidomics') +
  th
```

```{r include = F, eval = F}
# Baseline and follow-up plasma datasets
# Combine result tables for plotting
volTab <- dplyr::bind_rows(metaBaseVolTab, metaFoloVolTab,
                           lipBaseVolTab, lipFoloVolTab)
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.9] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.9] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.9, 0.9), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 2, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  facet_wrap(vars(Data)) +
  labs(x = 'log2(FC)') +
  th

# Tumor and normal tissue datasets
# Combine result tables for plotting
volTab <- dplyr::bind_rows(metaTumorVolTab, metaNormalVolTab,
                           lipTumorVolTab, lipNormalVolTab)
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.9] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.9] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.9, 0.9), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 2, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  facet_wrap(vars(Data)) +
  labs(x = 'log2(FC)') +
  th
```
