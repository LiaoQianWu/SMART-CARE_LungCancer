---
title: "Single-omics analysis: Method development lung cancer patient cohort"
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10)#, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_MethodDev')
```

Load libraries
```{r library loading, message = F}
library('SummarizedExperiment')
library('proDA')
library('ggrepel')
library('ggfortify')
library('openxlsx')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')
```

# Plasma Proteomics
ADD COMMENT!

```{r}
# Load normalized data
proPlasma <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm_DIA.rds')

# Add time point information into data
timePoint <- as.data.frame(colData(proPlasma)) %>%
  dplyr::mutate(TimePoint = dplyr::case_when(
    Condition == 'Baseline' ~ 'Baseline',
    Condition != 'Baseline' ~ '2 years later')) %>%
  dplyr::select(TimePoint)
colData(proPlasma)['TimePoint'] <- timePoint

# Perform analysis
proPlasmaRes <- SOA(proPlasma, fac = c('Recurrence', 'TimePoint'))
tPCASigRes <- proPlasmaRes$tPCASigRes
pcaRes <- proPlasmaRes$pcaRes
pcTab <- proPlasmaRes$pcTab
```

Display associations between learned PCs (Var1) and factors (Var2). Basically
t-test was performed to test significance of difference between two groups, e.g.,
recurrence and non-recurrence patient groups or baseline and follow-up sample groups.
```{r}
# Display PCs of interest
tPCASigRes
```

PC10 and PC15 can significantly separate recurrence and non-recurrence patient
groups while both Baseline and Follow-up samples are used for PCA.
```{r}
ggplot(pcTab, aes(x=PC10, y=PC15, col=Recurrence, group=Patient)) +
  geom_point(size = 4) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  geom_line(col = 'grey50', linetype = 'dashed')

ggplot(pcTab, aes(x=Recurrence, y=PC10, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)

ggplot(pcTab, aes(x=Recurrence, y=PC15, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Baseline samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(proPlasma)$Condition == 'Baseline')
proBase <- proPlasma[, smpBaseIdx]

# Perform analysis
proBaseRes <- SOA(proBase, fac = 'Recurrence', num_feats = 30)
datMat <- proBaseRes$data
smpAnno <- proBaseRes$smpMetadata
tFeatSigRes <- proBaseRes$tFeatSigRes
tPCASigRes <- proBaseRes$tPCASigRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', #row scaling is across columns
                   main = 'Baseline plasma proteomics')
```

Owing to missing values, there might be a situation that only few observations in
sample groups, resulting in unreliable t-statistics. (e.g., proteins Q14103 and
P16401 right above) We used probabilistic dropout model to account for data missingness
and identify differentially abundant entities that are significantly associated
with cancer recurrence. Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAProBaseRes <- proDA::test_diff(fit,
                                        contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                        sort_by = 'pval')
proDAProBaseRes <- dplyr::select(all_proDAProBaseRes, -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05)
proDAProBaseRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAProBaseRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Baseline plasma proteomics (proDA)')
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAProBaseRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```
-> ADD COMMENT!
<br/>
<br/>

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```

## Follow-up samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(proPlasma)$Condition != 'Baseline')
proFolo <- proPlasma[, smpFoloIdx]

# Perform analysis
proFoloRes <- SOA(proFolo, fac = 'Recurrence', num_feats = 30)
datMat <- proFoloRes$data
smpAnno <- proFoloRes$smpMetadata
tFeatSigRes <- proFoloRes$tFeatSigRes
tPCASigRes <- proFoloRes$tPCASigRes
pcaRes <- proFoloRes$pcaRes
pcTab <- proFoloRes$pcTab
pcTopFeatTab <- proFoloRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma proteomics')
```

Use probabilistic dropout model to account for data missingness and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAProFoloRes <- proDA::test_diff(fit,
                                        contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                        sort_by = 'pval')
proDAProFoloRes <- dplyr::select(all_proDAProFoloRes, -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05)
proDAProFoloRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAProFoloRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma proteomics (proDA)')
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAProFoloRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Follow-up plasma proteomics')
```

PC11 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC11, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Follow-up plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F)
```

Plot molecular signatures captured by PC11 in input data. We took a look at top
20 features with highest loadings and observed protein levels of these top features
through heatmap. Note that features in heatmap are ordered by their loadings. There
is no single feature that can decently hint if patients will suffer cancer recurrence
or not, which means each of these top features contributes a bit to explaining variation
between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC11$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma proteomics - PC11')
```

Display top features that build the PC11
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC11
```

## Changes in time course
Differences between Follow-up and Baseline samples (Follow-up matrix - baseline matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(proPlasma)$Condition == 'Baseline')
proBase <- proPlasma[, smpBaseIdx]
# Subset follow-up samples
smpFoloIdx <- which(colData(proPlasma)$Condition != 'Baseline')
proFolo <- proPlasma[, smpFoloIdx]
# Modify column names for matching two matrices
colnames(proBase) <- stringr::str_remove(colnames(proBase), '_P_B')
colnames(proFolo) <- stringr::str_remove(colnames(proFolo), '_P_R')
# Retrieve data matrix
proBaseMat <- SummarizedExperiment::assay(proBase)
proFoloMat <- SummarizedExperiment::assay(proFolo)
# Subtract follow-up matrix by baseline matrix
if (identical(colnames(proBaseMat), colnames(proFoloMat)) &
    identical(rownames(proBaseMat), rownames(proFoloMat))) {
  proPlasmaDiffMat <- proFoloMat - proBaseMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(proBase)), Patient, Recurrence)
proPlasmaDiff <- SummarizedExperiment(assays = proPlasmaDiffMat, colData = colAnno)

# Perform analysis
proPlasmaDiffRes <- SOA(proPlasmaDiff, fac = 'Recurrence', num_feats = 30)
datMat <- proPlasmaDiffRes$data
smpAnno <- proPlasmaDiffRes$smpMetadata
tFeatSigRes <- proPlasmaDiffRes$tFeatSigRes
tPCASigRes <- proPlasmaDiffRes$tPCASigRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential plasma proteomics')
```

Use probabilistic dropout model to account for data missingness and identify differentially
abundant entity differences that are significantly associated with cancer recurrence.
Note that there is no differentially abundant protein.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDAProPlasmaDiffRes <- proDA::test_diff(fit,
                                          contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                          sort_by = 'pval', n_max = 30) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx))
proDAProPlasmaDiffRes
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```




# Tissue Proteomics
ADD COMMENT!

```{r}
# Load normalized data
proTissue <- readRDS('./data/AG_Krijgsveld/proTissueNorm_DIA.rds')

# Perform analysis
proTissueRes <- SOA(proTissue, fac = c('Recurrence', 'Condition'))
tPCASigRes <- proTissueRes$tPCASigRes
pcaRes <- proTissueRes$pcaRes
pcTab <- proTissueRes$pcTab
```

Display associations between learned PCs (Var1) and factors (Var2). Basically
t-test was performed to test significance of difference between two groups, e.g.,
recurrence and non-recurrence patient groups or tumor and normal sample groups.
```{r}
# Display PCs of interest
tPCASigRes
```

PC28, PC6, and PC5 can significantly separate recurrence and non-recurrence patient
groups while both Tumor and Normal samples are used for PCA.
```{r}
ggplot(pcTab, aes(x=Recurrence, y=PC28, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)

ggplot(pcTab, aes(x=PC6, y=PC5, col=Recurrence, group=Patient)) +
  geom_point(size = 4) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  geom_line(col = 'grey50', linetype = 'dashed')

ggplot(pcTab, aes(x=Recurrence, y=PC6, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)

ggplot(pcTab, aes(x=Recurrence, y=PC5, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Tumor samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(proTissue)$Condition == 'Tumor')
proTumor <- proTissue[, smpTumorIdx]

# Perform analysis
proTumorRes <- SOA(proTumor, fac = 'Recurrence', num_feats = 30)
datMat <- proTumorRes$data
smpAnno <- proTumorRes$smpMetadata
tFeatSigRes <- proTumorRes$tFeatSigRes
tPCASigRes <- proTumorRes$tPCASigRes
pcaRes <- proTumorRes$pcaRes
pcTab <- proTumorRes$pcTab
pcTopFeatTab <- proTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', #row scaling is across columns
                   main = 'Tumor Tissue proteomics')
```

Owing to missing values, there might be a situation that only few observations in
sample groups, resulting in unreliable t-statistics. To this end, we used probabilistic
dropout model to account for data missingness and identify differentially abundant
entities that are significantly associated with cancer recurrence. Note that features
in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAProTumorRes <- proDA::test_diff(fit,
                                         contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                         sort_by = 'pval')
proDAProTumorRes <- dplyr::select(all_proDAProTumorRes, -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05)
proDAProTumorRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAProTumorRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Tumor Tissue proteomics (proDA)')
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAProTumorRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Tumor tissue proteomics')
```

PC13 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC13, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tumor Tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F)
```

Plot molecular signatures captured by PC13 in input data. We took a look at top
20 features with highest loadings and observed protein levels of these top features
through heatmap. Note that features in heatmap are ordered by their loadings. There
is no single feature that can decently hint if patients will suffer cancer recurrence
or not, which means each of these top features contributes a bit to explaining variation
between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC13$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor Tissue proteomics - PC13')
```

Display top features that build the PC13
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC13
```

## Normal samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(proTissue)$Condition == 'Normal')
proNormal <- proTissue[, smpNormalIdx]

# Perform analysis
proNormalRes <- SOA(proNormal, fac = 'Recurrence', num_feats = 30)
datMat <- proNormalRes$data
smpAnno <- proNormalRes$smpMetadata
tFeatSigRes <- proNormalRes$tFeatSigRes
tPCASigRes <- proNormalRes$tPCASigRes
pcaRes <- proNormalRes$pcaRes
pcTab <- proNormalRes$pcTab
pcTopFeatTab <- proNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Normal tissue proteomics')
```

Use probabilistic dropout model to account for data missingness and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAProNormalRes <- proDA::test_diff(fit,
                                          contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                          sort_by = 'pval')
proDAProNormalRes <- dplyr::select(all_proDAProNormalRes, -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05)
proDAProNormalRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAProNormalRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Normal Tissue proteomics (proDA)')
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAProNormalRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Normal tissue proteomics')
```

PC5 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC5, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Normal tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F)
```

Plot molecular signatures captured by PC5 in input data. We took a look at top
20 features with highest loadings and observed protein levels of these top features
through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC5$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Normal tissue proteomics - PC5')
```

Display top features that build the PC5
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC5
```

## Difference in tissue conditions
Differences between Tumor and Normal samples (Tumor matrix - Normal matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(proTissue)$Condition == 'Tumor')
proTumor <- proTissue[, smpTumorIdx]
# Subset normal samples
smpNormalIdx <- which(colData(proTissue)$Condition == 'Normal')
proNormal <- proTissue[, smpNormalIdx]
# Modify column names for matching two matrices
colnames(proTumor) <- stringr::str_remove(colnames(proTumor), '_TG')
colnames(proNormal) <- stringr::str_remove(colnames(proNormal), '_NG')
# Retrieve data matrix
proTumorMat <- SummarizedExperiment::assay(proTumor)
proNormalMat <- SummarizedExperiment::assay(proNormal)
# Subtract normal matrix by tumor matrix
if (identical(colnames(proTumorMat), colnames(proNormalMat)) &
    identical(rownames(proTumorMat), rownames(proNormalMat))) {
  proTissueDiffMat <- proTumorMat - proNormalMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(proTumor)), Patient, Recurrence)
proTissueDiff <- SummarizedExperiment(assays = proTissueDiffMat, colData = colAnno)

# Perform analysis
proTissueDiffRes <- SOA(proTissueDiff, fac = 'Recurrence', num_feats = 30)
datMat <- proTissueDiffRes$data
smpAnno <- proTissueDiffRes$smpMetadata
tFeatSigRes <- proTissueDiffRes$tFeatSigRes
tPCASigRes <- proTissueDiffRes$tPCASigRes
pcaRes <- proTissueDiffRes$pcaRes
pcTab <- proTissueDiffRes$pcTab
pcTopFeatTab <- proTissueDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Differential tissue proteomics')
```

Use probabilistic dropout model to account for data missingness and identify differentially
abundant entity differences that are significantly associated with cancer recurrence.
Note that there is no differentially abundant protein.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDAProTissueDiffRes <- proDA::test_diff(fit,
                                          contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                          sort_by = 'pval', n_max = 30) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx))
proDAProTissueDiffRes
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential tissue proteomics')
```

PC15 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC15, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F)
```

Plot molecular signatures captured by PC15 in input data. We took a look at top
20 features with highest loadings and observed protein levels of these top features
through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC15$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential tissue proteomics - PC15')
```

Display top features that build the PC15
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC15
```




# Summary
Display proportions of significant features that can separate cancer recurrence
and non-recurrence patient groups for all datasets we currently have. Numbers after
bars indicate feature numbers.

```{r}
# Specific functions for subsetting data
subPlasma <- function(summ_exp) {
  smpAnno <- as.data.frame(colData(summ_exp))
  base <- summ_exp[, smpAnno[['Condition']] == 'Baseline']
  folo <- summ_exp[, smpAnno[['Condition']] != 'Baseline']
  return(list(Base = base, Folo = folo))
}

subTissue <- function(summ_exp) {
  smpAnno <- as.data.frame(colData(summ_exp))
  tumor <- summ_exp[, smpAnno[['Condition']] == 'Tumor']
  normal <- summ_exp[, smpAnno[['Condition']] == 'Normal']
  return(list(Tumor = tumor, Normal = normal))
}

# Load normalized datasets and subset them into Baseline/Follow-up and Tumor/Normal datasets
# NO MISSINGNESS
# Targeted Plasma Metabolomics
metaPlasma_Hell <- readRDS('./data/AG_Hell/metaPlasmaNorm.rds')
metaBase_Hell <- subPlasma(metaPlasma_Hell)$Base
metaFolo_Hell <- subPlasma(metaPlasma_Hell)$Folo

# Targeted Tissue Metabolomics
metaTissue_Hell <- readRDS('./data/AG_Hell/metaTissueNorm.rds')
metaTumor_Hell <- subTissue(metaTissue_Hell)$Tumor
metaNormal_Hell <- subTissue(metaTissue_Hell)$Normal

# DDA Plasma Proteomics
proPlasma_Kri_DDA <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm.rds')
proBase_Kri_DDA <- subPlasma(proPlasma_Kri_DDA)$Base
proFolo_Kri_DDA <- subPlasma(proPlasma_Kri_DDA)$Folo

# DDA Tissue Proteomics
proTissue_Kri_DDA <- readRDS('./data/AG_Krijgsveld/proTissueNorm.rds')
proTumor_Kri_DDA <- subTissue(proTissue_Kri_DDA)$Tumor
proNormal_Kri_DDA <- subTissue(proTissue_Kri_DDA)$Normal

# WITH MISSINGNESS
# Untargeted Plasma Metabolomics
metaPlasma_Hopf <- readRDS('./data/AG_Hopf/metaPlasmaVsn.rds')
metaBase_Hopf <- subPlasma(metaPlasma_Hopf)$Base
metaFolo_Hopf <- subPlasma(metaPlasma_Hopf)$Folo

# Untargeted Tissue Metabolomics
metaTissue_Hopf <- readRDS('./data/AG_Hopf/metaTissueVsn.rds')
metaTumor_Hopf <- subTissue(metaTissue_Hopf)$Tumor
metaNormal_Hopf <- subTissue(metaTissue_Hopf)$Normal

# Untargeted Plasma Lipidomics
lipPlasma_Hopf <- readRDS('./data/AG_Hopf/lipPlasmaVsn.rds')
lipBase_Hopf <- subPlasma(lipPlasma_Hopf)$Base
lipFolo_Hopf <- subPlasma(lipPlasma_Hopf)$Folo

# Untargeted Tissue Lipidomics
lipTissue_Hopf <- readRDS('./data/AG_Hopf/lipTissueVsn.rds')
lipTumor_Hopf <- subTissue(lipTissue_Hopf)$Tumor
lipNormal_Hopf <- subTissue(lipTissue_Hopf)$Normal

# DIA Plasma Proteomics
proPlasma_Kri_DIA <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm_DIA.rds')
proBase_Kri_DIA <- subPlasma(proPlasma_Kri_DIA)$Base
proFolo_Kri_DIA <- subPlasma(proPlasma_Kri_DIA)$Folo

# DIA Tissue Proteomics
proTissue_Kri_DIA <- readRDS('./data/AG_Krijgsveld/proTissueNorm_DIA.rds')
proTumor_Kri_DIA <- subTissue(proTissue_Kri_DIA)$Tumor
proNormal_Kri_DIA <- subTissue(proTissue_Kri_DIA)$Normal
```

```{r}
# Prepare significant feature lists for all datasets
# NO MISSINGNESS
# Targeted Plasma Metabolomics
metaBaseRes_Hell <- SOA(metaBase_Hell, factor = 'Recurrence')
metaFoloRes_Hell <- SOA(metaFolo_Hell, factor = 'Recurrence')

# Targeted Tissue Metabolomics
metaTumorRes_Hell <- SOA(metaTumor_Hell, factor = 'Recurrence')
metaNormalRes_Hell <- SOA(metaNormal_Hell, factor = 'Recurrence')

# DDA Plasma Proteomics
proBaseRes_Kri_DDA <- SOA(proBase_Kri_DDA, factor = 'Recurrence')
proFoloRes_Kri_DDA <- SOA(proFolo_Kri_DDA, factor = 'Recurrence')

# DDA Tissue Proteomics
proTumorRes_Kri_DDA <- SOA(proTumor_Kri_DDA, factor = 'Recurrence')
proNormalRes_Kri_DDA <- SOA(proNormal_Kri_DDA, factor = 'Recurrence')

# WITH MISSINGNESS (use proDA)
# Untargeted Plasma Metabolomics
metaBaseRes_Hopf <- SOA(metaBase_Hopf, factor = 'Recurrence')
datMat <- metaBaseRes_Hopf$data
smpAnno <- metaBaseRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAmetaBaseRes_Hopf <- proDA::test_diff(fit,
                                              contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                              sort_by = 'pval')
proDAmetaBaseRes_Hopf <- dplyr::filter(all_proDAmetaBaseRes_Hopf, pval < 0.05)

metaFoloRes_Hopf <- SOA(metaFolo_Hopf, factor = 'Recurrence')
datMat <- metaFoloRes_Hopf$data
smpAnno <- metaFoloRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAmetaFoloRes_Hopf <- proDA::test_diff(fit,
                                              contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                              sort_by = 'pval')
proDAmetaFoloRes_Hopf <- dplyr::filter(all_proDAmetaFoloRes_Hopf, pval < 0.05)

# Untargeted Tissue Metabolomics
metaTumorRes_Hopf <- SOA(metaTumor_Hopf, factor = 'Recurrence')
datMat <- metaTumorRes_Hopf$data
smpAnno <- metaTumorRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAmetaTumorRes_Hopf <- proDA::test_diff(fit,
                                               contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                               sort_by = 'pval')
proDAmetaTumorRes_Hopf <- dplyr::filter(all_proDAmetaTumorRes_Hopf, pval < 0.05)

metaNormalRes_Hopf <- SOA(metaNormal_Hopf, factor = 'Recurrence')
datMat <- metaNormalRes_Hopf$data
smpAnno <- metaNormalRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAmetaNormalRes_Hopf <- proDA::test_diff(fit,
                                                contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                sort_by = 'pval')
proDAmetaNormalRes_Hopf <- dplyr::filter(all_proDAmetaNormalRes_Hopf, pval < 0.05)

# Untargeted Plasma Lipidomics
lipBaseRes_Hopf <- SOA(lipBase_Hopf, factor = 'Recurrence')
datMat <- lipBaseRes_Hopf$data
smpAnno <- lipBaseRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAlipBaseRes_Hopf <- proDA::test_diff(fit,
                                             contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                             sort_by = 'pval')
proDAlipBaseRes_Hopf <- dplyr::filter(all_proDAlipBaseRes_Hopf, pval < 0.05)

lipFoloRes_Hopf <- SOA(lipFolo_Hopf, factor = 'Recurrence')
datMat <- lipFoloRes_Hopf$data
smpAnno <- lipFoloRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAlipFoloRes_Hopf <- proDA::test_diff(fit,
                                             contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                             sort_by = 'pval')
proDAlipFoloRes_Hopf <- dplyr::filter(all_proDAlipFoloRes_Hopf, pval < 0.05)

# Untargeted Tissue Lipidomics
lipTumorRes_Hopf <- SOA(lipTumor_Hopf, factor = 'Recurrence')
datMat <- lipTumorRes_Hopf$data
smpAnno <- lipTumorRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAlipTumorRes_Hopf <- proDA::test_diff(fit,
                                              contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                              sort_by = 'pval')
proDAlipTumorRes_Hopf <- dplyr::filter(all_proDAlipTumorRes_Hopf, pval < 0.05)

lipNormalRes_Hopf <- SOA(lipNormal_Hopf, factor = 'Recurrence')
datMat <- lipNormalRes_Hopf$data
smpAnno <- lipNormalRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAlipNormalRes_Hopf <- proDA::test_diff(fit,
                                               contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                               sort_by = 'pval')
proDAlipNormalRes_Hopf <- dplyr::filter(all_proDAlipNormalRes_Hopf, pval < 0.05)

# DIA Plasma Proteomics
proBaseRes_Kri_DIA <- SOA(proBase_Kri_DIA, factor = 'Recurrence')
datMat <- proBaseRes_Kri_DIA$data
smpAnno <- proBaseRes_Kri_DIA$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAproBaseRes_Kri_DIA <- proDA::test_diff(fit,
                                                contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                sort_by = 'pval')
proDAproBaseRes_Kri_DIA <- dplyr::filter(all_proDAproBaseRes_Kri_DIA, pval < 0.05)

proFoloRes_Kri_DIA <- SOA(proFolo_Kri_DIA, factor = 'Recurrence')
datMat <- proFoloRes_Kri_DIA$data
smpAnno <- proFoloRes_Kri_DIA$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAproFoloRes_Kri_DIA <- proDA::test_diff(fit,
                                                contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                sort_by = 'pval')
proDAproFoloRes_Kri_DIA <- dplyr::filter(all_proDAproFoloRes_Kri_DIA, pval < 0.05)

# DIA Tissue Proteomics
proTumorRes_Kri_DIA <- SOA(proTumor_Kri_DIA, factor = 'Recurrence')
datMat <- proTumorRes_Kri_DIA$data
smpAnno <- proTumorRes_Kri_DIA$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAproTumorRes_Kri_DIA <- proDA::test_diff(fit,
                                                 contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                 sort_by = 'pval')
proDAproTumorRes_Kri_DIA <- dplyr::filter(all_proDAproTumorRes_Kri_DIA, pval < 0.05)

proNormalRes_Kri_DIA <- SOA(proNormal_Kri_DIA, factor = 'Recurrence')
datMat <- proNormalRes_Kri_DIA$data
smpAnno <- proNormalRes_Kri_DIA$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAproNormalRes_Kri_DIA <- proDA::test_diff(fit,
                                                  contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                  sort_by = 'pval')
proDAproNormalRes_Kri_DIA <- dplyr::filter(all_proDAproNormalRes_Kri_DIA, pval < 0.05)
```

```{r}
# Make barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats_Hell <- nrow(metaBaseRes_Hell$tFeatSigRes) / nrow(metaBaseRes_Hell$data) * 100
metaFoloSigFeats_Hell <- nrow(metaFoloRes_Hell$tFeatSigRes) / nrow(metaFoloRes_Hell$data) * 100
metaTumorSigFeats_Hell <- nrow(metaTumorRes_Hell$tFeatSigRes) / nrow(metaTumorRes_Hell$data) * 100
metaNormalSigFeats_Hell <- nrow(metaNormalRes_Hell$tFeatSigRes) / nrow(metaNormalRes_Hell$data) * 100
proBaseSigFeats_Kri_DDA <- nrow(proBaseRes_Kri_DDA$tFeatSigRes) / nrow(proBaseRes_Kri_DDA$data) * 100
proFoloSigFeats_Kri_DDA <- nrow(proFoloRes_Kri_DDA$tFeatSigRes) / nrow(proFoloRes_Kri_DDA$data) * 100
proTumorSigFeats_Kri_DDA <- nrow(proTumorRes_Kri_DDA$tFeatSigRes) / nrow(proTumorRes_Kri_DDA$data) * 100
proNormalSigFeats_Kri_DDA <- nrow(proNormalRes_Kri_DDA$tFeatSigRes) / nrow(proNormalRes_Kri_DDA$data) * 100

metaBaseSigFeats_Hopf <- nrow(proDAmetaBaseRes_Hopf) / nrow(metaBaseRes_Hopf$data) * 100
metaFoloSigFeats_Hopf <- nrow(proDAmetaFoloRes_Hopf) / nrow(metaFoloRes_Hopf$data) * 100
metaTumorSigFeats_Hopf <- nrow(proDAmetaTumorRes_Hopf) / nrow(metaTumorRes_Hopf$data) * 100
metaNormalSigFeats_Hopf <- nrow(proDAmetaNormalRes_Hopf) / nrow(metaNormalRes_Hopf$data) * 100
lipBaseSigFeats_Hopf <- nrow(proDAlipBaseRes_Hopf) / nrow(lipBaseRes_Hopf$data) * 100
lipFoloSigFeats_Hopf <- nrow(proDAlipFoloRes_Hopf) / nrow(lipFoloRes_Hopf$data) * 100
lipTumorSigFeats_Hopf <- nrow(proDAlipTumorRes_Hopf) / nrow(lipTumorRes_Hopf$data) * 100
lipNormalSigFeats_Hopf <- nrow(proDAlipNormalRes_Hopf) / nrow(lipNormalRes_Hopf$data) * 100
proBaseSigFeats_Kri_DIA <- nrow(proDAproBaseRes_Kri_DIA) / nrow(proBaseRes_Kri_DIA$data) * 100
proFoloSigFeats_Kri_DIA <- nrow(proDAproFoloRes_Kri_DIA) / nrow(proFoloRes_Kri_DIA$data) * 100
proTumorSigFeats_Kri_DIA <- nrow(proDAproTumorRes_Kri_DIA) / nrow(proTumorRes_Kri_DIA$data) * 100
proNormalSigFeats_Kri_DIA <- nrow(proDAproNormalRes_Kri_DIA) / nrow(proNormalRes_Kri_DIA$data) * 100

# Prepare needed information for barplot
dat <- c('Untargeted Metabolomics', 'Untargeted Metabolomics',
         'Targeted Metabolomics', 'Targeted Metabolomics',
         'Untargeted Lipidomics', 'Untargeted Lipidomics',
         'DIA Proteomics', 'DIA Proteomics',
         'DDA Proteomics', 'DDA Proteomics',
         'Untargeted Metabolomics', 'Untargeted Metabolomics',
         'Targeted Metabolomics', 'Targeted Metabolomics',
         'Untargeted Lipidomics', 'Untargeted Lipidomics',
         'DIA Proteomics', 'DIA Proteomics',
         'DDA Proteomics', 'DDA Proteomics')
datModal <- c(rep(c('Baseline', 'Follow-up'), 5), rep(c('Tumor', 'Normal'), 5))
datOf <- c(rep('Plasma', 10), rep('Tissue', 10))
proportion <- c(metaBaseSigFeats_Hopf, metaFoloSigFeats_Hopf,
                metaBaseSigFeats_Hell, metaFoloSigFeats_Hell,
                lipBaseSigFeats_Hopf, lipFoloSigFeats_Hopf,
                proBaseSigFeats_Kri_DIA, proFoloSigFeats_Kri_DIA,
                proBaseSigFeats_Kri_DDA, proFoloSigFeats_Kri_DDA,
                metaTumorSigFeats_Hopf, metaNormalSigFeats_Hopf,
                metaTumorSigFeats_Hell, metaNormalSigFeats_Hell,
                lipTumorSigFeats_Hopf, lipNormalSigFeats_Hopf,
                proTumorSigFeats_Kri_DIA, proNormalSigFeats_Kri_DIA,
                proTumorSigFeats_Kri_DDA, proNormalSigFeats_Kri_DDA)
numFeat <- c(c('1406', NA), c('630', NA), c(NA, '2493'), c('505', NA), c('435', NA),
             c('1387', NA), c('630', NA), c(NA, '2168'), c('6929', NA), c(NA, '5193'))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = unique(dat)),
                             Data_modality = datModal,
                             Data_of = datOf,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill = Data_modality, label=Feature_number)) +
  geom_bar(stat = 'identity', position=position_dodge()) +
  geom_text(vjust = -0.7) +
  facet_wrap(~Data_of) +
  labs(x = 'Data', y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Sample Condition') +
  theme(strip.text = element_text(size = 16), axis.title = element_text(size = 17),
        axis.text.x = element_text(size = 11.5, angle = 60, vjust = 1, hjust = 1), axis.text.y = element_text(size = 12),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        panel.grid.major.x = element_blank())
# ggsave('./output/percentage_sigFeats.png', device = 'png', dpi = 400, height = 8, width = 18)
```
```{r include = F, eval = F}
# Prepare needed information for barplot
dat <- rev(c('Baseline Plasma Untargeted Metabolomics', 'Follow-up Plasma Untargeted Metabolomics',
             'Baseline Plasma Targeted Metabolomics', 'Follow-up Plasma Targeted Metabolomics',
             'Baseline Plasma Untargeted Lipidomics', 'Follow-up Plasma Untargeted Lipidomics',
             'Baseline Plasma DIA Proteomics', 'Follow-up Plasma DIA Proteomics',
             'Baseline Plasma DDA Proteomics', 'Follow-up Plasma DDA Proteomics',
             'Tumor Tissue Untargeted Metabolomics', 'Normal Tissue Untargeted Metabolomics',
             'Tumor Tissue Targeted Metabolomics', 'Normal Tissue Targeted Metabolomics',
             'Tumor Tissue Untargeted Lipidomics', 'Normal Tissue Untargeted Lipidomics',
             'Tumor Tissue DIA Proteomics', 'Normal Tissue DIA Proteomics',
             'Tumor Tissue DDA Proteomics', 'Normal Tissue DDA Proteomics'))
datModal <- rev(c(rep('Plasma Metabolomics', 4), rep('Plasma Lipidomics', 2), rep('Plasma Proteomics', 4),
                  rep('Tissue Metabolomics', 4), rep('Tissue Lipidomics', 2), rep('Tissue Proteomics', 4)))
datOf <- rev(c(rep('Plasma', 10), rep('Tissue', 10)))
proportion <- rev(c(metaBaseSigFeats_Hopf, metaFoloSigFeats_Hopf,
                    metaBaseSigFeats_Hell, metaFoloSigFeats_Hell,
                    lipBaseSigFeats_Hopf, lipFoloSigFeats_Hopf,
                    proBaseSigFeats_Kri_DIA, proFoloSigFeats_Kri_DIA,
                    proBaseSigFeats_Kri_DDA, proFoloSigFeats_Kri_DDA,
                    metaTumorSigFeats_Hopf, metaNormalSigFeats_Hopf,
                    metaTumorSigFeats_Hell, metaNormalSigFeats_Hell,
                    lipTumorSigFeats_Hopf, lipNormalSigFeats_Hopf,
                    proTumorSigFeats_Kri_DIA, proNormalSigFeats_Kri_DIA,
                    proTumorSigFeats_Kri_DDA, proNormalSigFeats_Kri_DDA))
numFeat <- rev(c(rep('1406', 2), rep('630', 2), rep('2493', 2), rep('505', 2), rep('435', 2),
                 rep('1387', 2), rep('630', 2), rep('2168', 2), rep('6929', 2), rep('5193', 2)))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = dat),
                             Data_modality = datModal,
                             Data_of = datOf,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill=Data_of, label=Feature_number)) +
  geom_bar(stat = 'identity') +
  geom_text(size = 5, hjust = -0.2) +
  ylim(0, 9) +
  coord_flip() +
  labs(x = 'Data', y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Sample Type') +
  theme(axis.title = element_text(size = 18),
        axis.text.x = element_text(size = 13), axis.text.y = element_text(size = 12),
        legend.title = element_text(size = 14), legend.text = element_text(size = 14))
```







