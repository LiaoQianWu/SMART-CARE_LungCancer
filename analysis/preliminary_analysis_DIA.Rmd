---
title: "Single-omics analysis: Method development lung cancer patient cohort"
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: </font>

**Metadata variables**\
Patient:\
Gender -> Male:Female = 13:7\
Age -> Diagnosis ages ranging from 56 to 84\
Smoking -> Smoker:Ex-smoker:Non-Smoker = 3:14:3\
Recurrence -> Cancer recurrences, Yes:No = 1:1\
Stage -> Pathological stages, IB:IIA:IIB = 16:1:3\
Metastasis -> Derived from stages, whether cancer cells spread to lymph nodes, Yes:No = 3:17\
Sample:\
Condition -> Baseline:Follow-up:Recurrence = 2:1:1, Tumor:Normal = 1:1\
TimePoint -> Time points that samples were collected at, Baseline:2 years later = 1:1

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_MethodDev')
```

Load libraries
```{r library loading, message = F}
library('SummarizedExperiment')
library('proDA')
library('ggrepel')
library('ggfortify')
library('openxlsx')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

# Plasma Proteomics
ADD COMMENT!

```{r}
# Load normalized data
proPlasma <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm_DIA.rds')
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(proPlasma), rownames = 'Protein.Groups')
# Manually modify metadata information (time point, metastasis)
tmp_metadata <- as.data.frame(colData(proPlasma)) %>%
  dplyr::mutate(
    TimePoint = dplyr::case_when(
      Condition == 'Baseline' ~ 'Baseline',
      Condition != 'Baseline' ~ '2 years later'
      ),
    Metastasis = case_when(
      Stage == 'IIB' ~ 'Yes',
      Stage != 'IIB' ~ 'No'
    ))
colData(proPlasma)['TimePoint'] <- tmp_metadata$TimePoint
colData(proPlasma)['Metastasis'] <- tmp_metadata$Metastasis

# Perform analysis
proPlasmaRes <- doSOA(proPlasma, meta_var = c('Recurrence', 'Gender', 'Age',
                                              'Condition', 'TimePoint', 'Smoking',
                                              'Stage', 'Metastasis'),
                      do_onlyPCA = T, pca_method = 'ppca')
tPCASigRes <- proPlasmaRes$tPCASigRes
pcaRes <- proPlasmaRes$pcaRes
pcTab <- proPlasmaRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variables
(Var2). Note that each patient has two samples that have same patient annotations,
so association test results may have additive effects. Besides, some patient annotations
are only meaningful at Baseline time point, such as diagnosis ages, pathological stages, etc.
```{r}
# Display PCs of interest
tPCASigRes
```

Visualize some significant PCs
```{r}
ggplot(pcTab, aes(x=PC1, y=PC2, col=Gender, shape=Metastasis, group=Patient)) +
  geom_point(size = 4) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  th

ggplot(pcTab, aes(x=PC1, y=PC4, col=Metastasis, group=Patient)) +
  geom_point(size = 4) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  th

ggplot(pcTab, aes(x=Recurrence, y=PC11, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Baseline samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(proPlasma)$Condition == 'Baseline')
proBase <- proPlasma[, smpBaseIdx]

# Display significant associations between PCs and metadata variables
proBaseAssoRes <- doSOA(proBase, meta_var = c('Recurrence', 'Gender', 'Age',
                                              'Smoking', 'Stage', 'Metastasis'),
                        do_onlyPCA = T, pca_method = 'ppca', num_PCs = 15)
proBaseAssoRes$tPCASigRes
```

```{r include = F, eval = F}
# Compare learned PCs using conventional PCA and PPCA
# Impute missing values using PPCA
impuDatMat <- proBaseAssoRes$pcaRes@completeObs
# Run PPCA on imputed data
ppcaRes <- doPCA(t(impuDatMat), pca_method = 'ppca', num_PCs = 15)
# Conduct association tests between PCs and metadata
pcTab <- tibble::as_tibble(ppcaRes@scores, rownames = 'Sample')
metaTab <- tibble::as_tibble(colData(proBase), rownames = 'Sample') %>%
  dplyr::select(Sample, Recurrence, Gender, Age, Smoking, Stage, Metastasis)
assoRes <- testAssociation(data = pcTab, metadata = metaTab, cmn_col = 'Sample') %>%
  dplyr::filter(pVal < 0.05)
assoRes

# Run conventional PCA on imputed data
pcaRes <- doPCA(t(impuDatMat), pca_method = 'pca')
# Conduct association test between PCs and metadata
pcTab <- tibble::as_tibble(pcaRes$x, rownames = 'Sample')
metaTab <- tibble::as_tibble(colData(proBase), rownames = 'Sample') %>%
  dplyr::select(Sample, Recurrence, Gender, Age, Smoking, Stage, Metastasis)
assoRes <- testAssociation(data = pcTab, metadata = metaTab, cmn_col = 'Sample') %>%
  dplyr::filter(pVal < 0.05)
assoRes

# PCA is matrix factorization, which decomposes a matrix into two matrices, score
# and loading matrices. Imputing data using PPCA is basically product of learned
# score and loading matrices. Results will be similar despite running PPCA on original
# data with missingness or imputed data using PPCA. Results of conventional PCA
# or PPCA on same complete data should be similar.
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
proBaseRes <- doSOA(proBase, meta_var = 'Recurrence', pca_method = 'ppca',
                    num_PCs = 15, num_PCfeats = 30)
datMat <- proBaseRes$data
smpAnno <- proBaseRes$smpMetadata
tFeatSigRes <- proBaseRes$tFeatSigRes
tPCASigRes <- proBaseRes$tPCASigRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$Protein.Groups,
                                                  to = featInfo$Genes,
                                                  warn_missing = F))

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', #row scaling is across columns
                   main = 'Baseline plasma proteomics')
```

Owing to missing values, there might be a situation that only few observations in
one sample group, e.g., KRT17 right above, resulting in unreliable t-statistics.
We used probabilistic dropout model to account for data missingness and identify
differentially abundant entities that are significantly associated with cancer
recurrence. Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAProBaseRes <- proDA::test_diff(fit,
                                        contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                        sort_by = 'pval')
proDAProBaseRes <- dplyr::select(all_proDAProBaseRes, -c(diff, se, df, avg_abundance, n_approx, n_obs)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(Gene = plyr::mapvalues(name,
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F))
proDAProBaseRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAProBaseRes, dplyr::desc(t_statistic))$name
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Baseline plasma proteomics (proDA)')
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAProBaseRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$Protein.Groups,
                                          to = featInfo$Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$Protein.Groups,
                                                                   to = featInfo$Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```
-> ADD COMMENT!
<br/>
<br/>

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```

## Follow-up samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(proPlasma)$Condition != 'Baseline')
proFolo <- proPlasma[, smpFoloIdx]

# Display significant associations between PCs and metadata variables
proFoloAssoRes <- doSOA(proFolo, meta_var = c('Recurrence', 'Gender'),
                        do_onlyPCA = T, pca_method = 'ppca', num_PCs = 15)
proFoloAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
proFoloRes <- doSOA(proFolo, meta_var = 'Recurrence', pca_method = 'ppca',
                    num_PCs = 15, num_PCfeats = 30)
datMat <- proFoloRes$data
smpAnno <- proFoloRes$smpMetadata
tFeatSigRes <- proFoloRes$tFeatSigRes
tPCASigRes <- proFoloRes$tPCASigRes
pcaRes <- proFoloRes$pcaRes
pcTab <- proFoloRes$pcTab
pcTopFeatTab <- proFoloRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$Protein.Groups,
                                                  to = featInfo$Genes,
                                                  warn_missing = F)) %>%
  dplyr::select(-Test)

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma proteomics')
```

Use probabilistic dropout model to account for data missingness and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAProFoloRes <- proDA::test_diff(fit,
                                        contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                        sort_by = 'pval')
proDAProFoloRes <- dplyr::select(all_proDAProFoloRes, -c(diff, se, df, avg_abundance, n_approx, n_obs)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(Gene = plyr::mapvalues(name,
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F))
proDAProFoloRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAProFoloRes, dplyr::desc(t_statistic))$name
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma proteomics (proDA)')
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAProFoloRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$Protein.Groups,
                                          to = featInfo$Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$Protein.Groups,
                                                                   to = featInfo$Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Follow-up plasma proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC9 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC9, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Follow-up plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  th
```

Plot molecular signatures captured by PC9 in input data. We took a look at top
20 features with highest loadings and observed protein levels of these top features
through heatmap. Note that features in heatmap are ordered by their loadings. There
is no single feature that can decently hint if patients will suffer cancer recurrence
or not, which means each of these top features contributes a bit to explaining variation
between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC9$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)

# Manually shorten names
rownames(datMatSub)[20] <- 'H2AC11;H2AC12'

pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma proteomics - PC9')
```

Display top features that build the PC9
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab <- dplyr::mutate(pcTopFeatTab$PC9, Gene = plyr::mapvalues(Feature,
                                                                       from = featInfo$Protein.Groups,
                                                                       to = featInfo$Genes,
                                                                       warn_missing = F))

# Manually shorten names
pcTopFeatTab$Feature[20] <- 'P0C0S8;P20671'
pcTopFeatTab$Gene[20] <- 'H2AC11;H2AC12'
pcTopFeatTab
```

## Changes in time course
Differences between Follow-up and Baseline samples (Follow-up matrix - baseline matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(proPlasma)$Condition == 'Baseline')
proBase <- proPlasma[, smpBaseIdx]
# Subset follow-up samples
smpFoloIdx <- which(colData(proPlasma)$Condition != 'Baseline')
proFolo <- proPlasma[, smpFoloIdx]
# Modify column names for matching two matrices
colnames(proBase) <- stringr::str_remove(colnames(proBase), '_P_B')
colnames(proFolo) <- stringr::str_remove(colnames(proFolo), '_P_R')
# Retrieve data matrix
proBaseMat <- SummarizedExperiment::assay(proBase)
proFoloMat <- SummarizedExperiment::assay(proFolo)
# Subtract follow-up matrix by baseline matrix
if (identical(colnames(proBaseMat), colnames(proFoloMat)) &
    identical(rownames(proBaseMat), rownames(proFoloMat))) {
  proPlasmaDiffMat <- proFoloMat - proBaseMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(proBase)), Patient, Recurrence)
proPlasmaDiff <- SummarizedExperiment(assays = proPlasmaDiffMat, colData = colAnno)

# Perform analysis
proPlasmaDiffRes <- doSOA(proPlasmaDiff, meta_var = 'Recurrence', pca_method = 'ppca',
                          num_PCs = 15, num_PCfeats = 30)
datMat <- proPlasmaDiffRes$data
smpAnno <- proPlasmaDiffRes$smpMetadata
tFeatSigRes <- proPlasmaDiffRes$tFeatSigRes
tPCASigRes <- proPlasmaDiffRes$tPCASigRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$Protein.Groups,
                                                  to = featInfo$Genes,
                                                  warn_missing = F))

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential plasma proteomics')
```

Use probabilistic dropout model to account for data missingness and identify differentially
abundant entity differences that are significantly associated with cancer recurrence.
Note that there is no differentially abundant protein.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDAProPlasmaDiffRes <- proDA::test_diff(fit,
                                          contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                          sort_by = 'pval', n_max = 20) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx, n_obs)) %>%
  dplyr::mutate(Gene = plyr::mapvalues(name,
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F))
proDAProPlasmaDiffRes
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$Protein.Groups,
                                          to = featInfo$Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$Protein.Groups,
                                                                   to = featInfo$Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```




# Tissue Proteomics
**Tumor and Normal Tissue sample groups cannot be easily separated, bad data quality?**

```{r}
# Load normalized data
proTissue <- readRDS('./data/AG_Krijgsveld/proTissueNorm_DIA.rds')
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(proTissue), rownames = 'Protein.Groups')
# Manually modify metadata information (metastasis)
tmp_metadata <- as.data.frame(colData(proTissue)) %>%
  dplyr::mutate(
    Metastasis = case_when(
      Stage == 'IIB' ~ 'Yes',
      Stage != 'IIB' ~ 'No'
    ))
colData(proTissue)['Metastasis'] <- tmp_metadata$Metastasis

# Perform analysis
proTissueRes <- doSOA(proTissue, meta_var = c('Recurrence', 'Gender', 'Age',
                                              'Condition', 'Smoking', 'Stage',
                                              'Metastasis'),
                      do_onlyPCA = T, pca_method = 'ppca')
tPCASigRes <- proTissueRes$tPCASigRes
pcaRes <- proTissueRes$pcaRes
pcTab <- proTissueRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variables
(Var2). Note that each patient has two samples that have same patient annotations,
so association test results may have additive effects.
```{r}
# Display PCs of interest
tPCASigRes
```

Visualize some significant PCs
```{r}
ggplot(pcTab, aes(x=PC6, y=PC5, col=Condition, group=Patient)) +
  geom_point(size = 4) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  th

ggplot(pcTab, aes(x=Condition, y=PC6, color=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

ggplot(pcTab, aes(x=Condition, y=PC5, color=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th
```

```{r include=F, eval=F}
ggplot(pcTab, aes(x=PC6, y=PC5, col=Condition, group=Patient)) +
  geom_point(size = 5) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  th + theme(axis.title = element_text(size = 22),
             axis.text = element_text(size = 18),
             legend.title = element_text(size = 22), 
             legend.text = element_text(size = 22))
ggsave('./output/group_meeting/proTissue_Kri_DIA_PCA_condition.png',
       device = 'png', dpi = 400, height = 8, width = 10)
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Tumor samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(proTissue)$Condition == 'Tumor')
proTumor <- proTissue[, smpTumorIdx]

# Display significant associations between PCs and metadata variables
proTumorAssoRes <- doSOA(proTumor, meta_var = c('Recurrence', 'Gender', 'Age',
                                                'Smoking', 'Stage', 'Metastasis'),
                         do_onlyPCA = T, pca_method = 'ppca', num_PCs = 15)
proTumorAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
proTumorRes <- doSOA(proTumor, meta_var = 'Recurrence', pca_method = 'ppca',
                     num_PCs = 15, num_PCfeats = 30)
datMat <- proTumorRes$data
smpAnno <- proTumorRes$smpMetadata
tFeatSigRes <- proTumorRes$tFeatSigRes
tPCASigRes <- proTumorRes$tPCASigRes
pcaRes <- proTumorRes$pcaRes
pcTab <- proTumorRes$pcTab
pcTopFeatTab <- proTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes <- dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                                 from = featInfo$Protein.Groups,
                                                                 to = featInfo$Genes,
                                                                 warn_missing = F)) %>%
  dplyr::select(-Test)

# Manually shorten names
tFeatSigRes$Var1[127] <- 'P05496;P48201'
tFeatSigRes$Gene[127] <- 'ATP5MC1;ATP5MC2'
tFeatSigRes
tFeatSigRes$Var1[127] <- 'P05496;P48201;Q06055'
tFeatSigRes$Gene[127] <- 'ATP5MC1;ATP5MC2;ATP5MC3'

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', #row scaling is across columns
                   main = 'Tumor Tissue proteomics')
```

Owing to missing values, there might be a situation that only few observations in
sample groups, resulting in unreliable t-statistics. To this end, we used probabilistic
dropout model to account for data missingness and identify differentially abundant
entities that are significantly associated with cancer recurrence. Note that features
in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAProTumorRes <- proDA::test_diff(fit,
                                         contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                         sort_by = 'pval')
proDAProTumorRes <- dplyr::select(all_proDAProTumorRes, -c(diff, se, df, avg_abundance, n_approx, n_obs)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(Gene = plyr::mapvalues(name,
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F))

# Manually shorten names
proDAProTumorRes$name[107] <- 'P05496;P48201'
proDAProTumorRes$Gene[107] <- 'ATP5MC1;ATP5MC2'
proDAProTumorRes
proDAProTumorRes$name[107] <- 'P05496;P48201;Q06055'
proDAProTumorRes$Gene[107] <- 'ATP5MC1;ATP5MC2;ATP5MC3'

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAProTumorRes, dplyr::desc(t_statistic))$name
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Tumor Tissue proteomics (proDA)')
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAProTumorRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$Protein.Groups,
                                          to = featInfo$Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$Protein.Groups,
                                                                   to = featInfo$Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Tumor tissue proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC9 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC9, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tumor Tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  th
```

Plot molecular signatures captured by PC9 in input data. We took a look at top
20 features with highest loadings and observed protein levels of these top features
through heatmap. Note that features in heatmap are ordered by their loadings. There
is no single feature that can decently hint if patients will suffer cancer recurrence
or not, which means each of these top features contributes a bit to explaining variation
between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC9$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor Tissue proteomics - PC9')
```

Display top features that build the PC13
```{r}
# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC9, Gene = plyr::mapvalues(Feature,
                                                       from = featInfo$Protein.Groups,
                                                       to = featInfo$Genes,
                                                       warn_missing = F))
```

## Normal samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(proTissue)$Condition == 'Normal')
proNormal <- proTissue[, smpNormalIdx]

# Display significant associations between PCs and metadata variables
proNormalAssoRes <- doSOA(proNormal, meta_var = c('Recurrence', 'Gender', 'Age',
                                                  'Smoking', 'Stage', 'Metastasis'),
                          do_onlyPCA = T, pca_method = 'ppca', num_PCs = 15)
proNormalAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
proNormalRes <- doSOA(proNormal, meta_var = 'Recurrence', pca_method = 'ppca',
                      num_PCs = 15, num_PCfeats = 30)
datMat <- proNormalRes$data
smpAnno <- proNormalRes$smpMetadata
tFeatSigRes <- proNormalRes$tFeatSigRes
tPCASigRes <- proNormalRes$tPCASigRes
pcaRes <- proNormalRes$pcaRes
pcTab <- proNormalRes$pcTab
pcTopFeatTab <- proNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes <- dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                                 from = featInfo$Protein.Groups,
                                                                 to = featInfo$Genes,
                                                                 warn_missing = F)) %>%
  dplyr::select(-Test)

# Manually shorten names
tFeatSigRes$Var1[16] <- 'A0A075B6P5'
tFeatSigRes$Gene[16] <- 'IGKV2-28'
tFeatSigRes$Var1[100] <- 'A6NCE7'
tFeatSigRes$Gene[100] <- 'MAP1LC3B'
tFeatSigRes
tFeatSigRes$Var1[16] <- 'A0A075B6P5;A0A087WW87;P01614;P01615'
tFeatSigRes$Gene[16] <- 'IGKV2-28;IGKV2-40;IGKV2D-28;IGKV2D-40'
tFeatSigRes$Var1[100] <- 'A6NCE7;Q9GZQ8'
tFeatSigRes$Gene[100] <- 'MAP1LC3B;MAP1LC3B2'

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Normal tissue proteomics')
```

Use probabilistic dropout model to account for data missingness and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAProNormalRes <- proDA::test_diff(fit,
                                          contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                          sort_by = 'pval')
proDAProNormalRes <- dplyr::select(all_proDAProNormalRes, -c(diff, se, df, avg_abundance, n_approx, n_obs)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(Gene = plyr::mapvalues(name,
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F))

# Manually shorten names
proDAProNormalRes$name[19] <- 'A0A075B6P5;A0A087WW87'
proDAProNormalRes$Gene[19] <- 'IGKV2-28;IGKV2-40'
proDAProNormalRes
proDAProNormalRes$name[19] <- 'A0A075B6P5;A0A087WW87;P01614;P01615'
proDAProNormalRes$Gene[19] <- 'IGKV2-28;IGKV2-40;IGKV2D-28;IGKV2D-40'

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAProNormalRes, dplyr::desc(t_statistic))$name
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Normal Tissue proteomics (proDA)')
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAProNormalRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$Protein.Groups,
                                          to = featInfo$Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$Protein.Groups,
                                                                   to = featInfo$Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```

## Difference in tissue conditions
Differences between Tumor and Normal samples (Tumor matrix - Normal matrix):\

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(proTissue)$Condition == 'Tumor')
proTumor <- proTissue[, smpTumorIdx]
# Subset normal samples
smpNormalIdx <- which(colData(proTissue)$Condition == 'Normal')
proNormal <- proTissue[, smpNormalIdx]
# Modify column names for matching two matrices
colnames(proTumor) <- stringr::str_remove(colnames(proTumor), '_TG')
colnames(proNormal) <- stringr::str_remove(colnames(proNormal), '_NG')
# Retrieve data matrix
proTumorMat <- SummarizedExperiment::assay(proTumor)
proNormalMat <- SummarizedExperiment::assay(proNormal)
# Subtract normal matrix by tumor matrix
if (identical(colnames(proTumorMat), colnames(proNormalMat)) &
    identical(rownames(proTumorMat), rownames(proNormalMat))) {
  proTissueDiffMat <- proTumorMat - proNormalMat
  # Remove features fully missing
  allNAsIdx <- which(apply(proTissueDiffMat, 1, function(x) {all(is.na(x))}))
  proTissueDiffMat <- proTissueDiffMat[-allNAsIdx,]
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(proTumor)), Patient, Recurrence)
proTissueDiff <- SummarizedExperiment(assays = proTissueDiffMat, colData = colAnno)

# Display significant associations between PCs and metadata variables
proTissueDiffAssoRes <- doSOA(proTissueDiff, meta_var = c('Recurrence', 'Gender', 'Age',
                                                          'Smoking', 'Stage', 'Metastasis'),
                              do_onlyPCA = T, pca_method = 'ppca', num_PCs = 15)
proTissueDiffAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
proTissueDiffRes <- doSOA(proTissueDiff, meta_var = 'Recurrence', pca_method = 'ppca',
                          num_PCs = 15, num_PCfeats = 30)
datMat <- proTissueDiffRes$data
smpAnno <- proTissueDiffRes$smpMetadata
tFeatSigRes <- proTissueDiffRes$tFeatSigRes
tPCASigRes <- proTissueDiffRes$tPCASigRes
pcaRes <- proTissueDiffRes$pcaRes
pcTab <- proTissueDiffRes$pcTab
pcTopFeatTab <- proTissueDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$Protein.Groups,
                                                  to = featInfo$Genes,
                                                  warn_missing = F))

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Differential tissue proteomics')
```

Use probabilistic dropout model to account for data missingness and identify differentially
abundant entity differences that are significantly associated with cancer recurrence.
Note that there is no differentially abundant protein.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDAProTissueDiffRes <- proDA::test_diff(fit,
                                          contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                          sort_by = 'pval', n_max = 20) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx, n_obs)) %>%
  dplyr::mutate(Gene = plyr::mapvalues(name,
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F))
proDAProTissueDiffRes
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$Protein.Groups,
                                          to = featInfo$Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$Protein.Groups,
                                                                   to = featInfo$Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential tissue proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC15 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC15, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  th
```

Plot molecular signatures captured by PC15 in input data. We took a look at top
20 features with highest loadings and observed protein levels of these top features
through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC15$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$Protein.Groups,
                                       to = featInfo$Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential tissue proteomics - PC15')
```

Display top features that build the PC15
```{r}
# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC15, Gene = plyr::mapvalues(Feature,
                                                        from = featInfo$Protein.Groups,
                                                        to = featInfo$Genes,
                                                        warn_missing = F))
```




# Summary

Visualize Recurrence-related features through volcano plots. Log2-FC (up and down)
is recurrence to non-recurrence groups. To be clearer, entities on up side are more
abundant in recurrence group than non-recurrence group, and so forth.
```{r message = F}
# Prepare protein-gene table for annotations
proPlasmaFeatInfo <- tibble::as_tibble(rowData(proPlasma), rownames = 'Protein.Groups')

# Compute log2(FC)
# PP
proPlasmaMedi <- readRDS('./data/AG_Krijgsveld/proPlasmaMedi_DIA.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPP
proBaseLogFC <- dplyr::filter(proPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPP
proFoloLogFC <- dplyr::filter(proPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# Collect all needed information for volcano plots
# BPP
proBaseVolTab <- dplyr::select(proBaseRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proBaseLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proPlasmaFeatInfo$Protein.Groups,
                                       to = proPlasmaFeatInfo$Genes,
                                       warn_missing = F))
# FPP
proFoloVolTab <- dplyr::select(proFoloRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proFoloLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proPlasmaFeatInfo$Protein.Groups,
                                       to = proPlasmaFeatInfo$Genes,
                                       warn_missing = F))
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# BPP
volTab <- proBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Proteomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# FPP
volTab <- proFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Proteomics') +
  th
```

Display proportions of significant features that can separate cancer recurrence
and non-recurrence patient groups for all datasets we currently have. Numbers above
bars indicate total feature numbers.
```{r}
# Specific functions for subsetting data
subPlasma <- function(summ_exp) {
  smpAnno <- as.data.frame(colData(summ_exp))
  base <- summ_exp[, smpAnno[['Condition']] == 'Baseline']
  folo <- summ_exp[, smpAnno[['Condition']] != 'Baseline']
  return(list(Base = base, Folo = folo))
}

subTissue <- function(summ_exp) {
  smpAnno <- as.data.frame(colData(summ_exp))
  tumor <- summ_exp[, smpAnno[['Condition']] == 'Tumor']
  normal <- summ_exp[, smpAnno[['Condition']] == 'Normal']
  return(list(Tumor = tumor, Normal = normal))
}

# Load normalized datasets and subset them into Baseline/Follow-up and Tumor/Normal datasets
# NO MISSINGNESS
# Targeted Plasma Metabolomics
metaPlasma_Hell <- readRDS('./data/AG_Hell/metaPlasmaNorm.rds')
metaBase_Hell <- subPlasma(metaPlasma_Hell)$Base
metaFolo_Hell <- subPlasma(metaPlasma_Hell)$Folo

# Targeted Tissue Metabolomics
metaTissue_Hell <- readRDS('./data/AG_Hell/metaTissueNorm.rds')
metaTumor_Hell <- subTissue(metaTissue_Hell)$Tumor
metaNormal_Hell <- subTissue(metaTissue_Hell)$Normal

# DDA Plasma Proteomics
proPlasma_Kri_DDA <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm.rds')
proBase_Kri_DDA <- subPlasma(proPlasma_Kri_DDA)$Base
proFolo_Kri_DDA <- subPlasma(proPlasma_Kri_DDA)$Folo

# DDA Tissue Proteomics
proTissue_Kri_DDA <- readRDS('./data/AG_Krijgsveld/proTissueNorm.rds')
proTumor_Kri_DDA <- subTissue(proTissue_Kri_DDA)$Tumor
proNormal_Kri_DDA <- subTissue(proTissue_Kri_DDA)$Normal

# WITH MISSINGNESS
# Untargeted Plasma Metabolomics
metaPlasma_Hopf <- readRDS('./data/AG_Hopf/metaPlasmaVsn.rds')
metaBase_Hopf <- subPlasma(metaPlasma_Hopf)$Base
metaFolo_Hopf <- subPlasma(metaPlasma_Hopf)$Folo

# Untargeted Tissue Metabolomics
metaTissue_Hopf <- readRDS('./data/AG_Hopf/metaTissueVsn.rds')
metaTumor_Hopf <- subTissue(metaTissue_Hopf)$Tumor
metaNormal_Hopf <- subTissue(metaTissue_Hopf)$Normal

# Untargeted Plasma Lipidomics
lipPlasma_Hopf <- readRDS('./data/AG_Hopf/lipPlasmaVsn.rds')
lipBase_Hopf <- subPlasma(lipPlasma_Hopf)$Base
lipFolo_Hopf <- subPlasma(lipPlasma_Hopf)$Folo

# Untargeted Tissue Lipidomics
lipTissue_Hopf <- readRDS('./data/AG_Hopf/lipTissueVsn.rds')
lipTumor_Hopf <- subTissue(lipTissue_Hopf)$Tumor
lipNormal_Hopf <- subTissue(lipTissue_Hopf)$Normal

# DIA Plasma Proteomics
proPlasma_Kri_DIA <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm_DIA.rds')
proBase_Kri_DIA <- subPlasma(proPlasma_Kri_DIA)$Base
proFolo_Kri_DIA <- subPlasma(proPlasma_Kri_DIA)$Folo

# DIA Tissue Proteomics
proTissue_Kri_DIA <- readRDS('./data/AG_Krijgsveld/proTissueNorm_DIA.rds')
proTumor_Kri_DIA <- subTissue(proTissue_Kri_DIA)$Tumor
proNormal_Kri_DIA <- subTissue(proTissue_Kri_DIA)$Normal
```

```{r message = F}
# Prepare significant feature lists for all datasets
# NO MISSINGNESS
# Targeted Plasma Metabolomics
metaBaseRes_Hell <- doSOA(metaBase_Hell, meta_var = 'Recurrence')
metaFoloRes_Hell <- doSOA(metaFolo_Hell, meta_var = 'Recurrence')

# Targeted Tissue Metabolomics
metaTumorRes_Hell <- doSOA(metaTumor_Hell, meta_var = 'Recurrence')
metaNormalRes_Hell <- doSOA(metaNormal_Hell, meta_var = 'Recurrence')

# DDA Plasma Proteomics
proBaseRes_Kri_DDA <- doSOA(proBase_Kri_DDA, meta_var = 'Recurrence')
proFoloRes_Kri_DDA <- doSOA(proFolo_Kri_DDA, meta_var = 'Recurrence')

# DDA Tissue Proteomics
proTumorRes_Kri_DDA <- doSOA(proTumor_Kri_DDA, meta_var = 'Recurrence')
proNormalRes_Kri_DDA <- doSOA(proNormal_Kri_DDA, meta_var = 'Recurrence')

# WITH MISSINGNESS (use proDA)
# Untargeted Plasma Metabolomics
metaBaseRes_Hopf <- doSOA(metaBase_Hopf, meta_var = 'Recurrence')
datMat <- metaBaseRes_Hopf$data
smpAnno <- metaBaseRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAmetaBaseRes_Hopf <- proDA::test_diff(fit,
                                              contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                              sort_by = 'pval')
proDAmetaBaseRes_Hopf <- dplyr::filter(all_proDAmetaBaseRes_Hopf, pval < 0.05)

metaFoloRes_Hopf <- doSOA(metaFolo_Hopf, meta_var = 'Recurrence')
datMat <- metaFoloRes_Hopf$data
smpAnno <- metaFoloRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAmetaFoloRes_Hopf <- proDA::test_diff(fit,
                                              contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                              sort_by = 'pval')
proDAmetaFoloRes_Hopf <- dplyr::filter(all_proDAmetaFoloRes_Hopf, pval < 0.05)

# Untargeted Tissue Metabolomics
metaTumorRes_Hopf <- doSOA(metaTumor_Hopf, meta_var = 'Recurrence')
datMat <- metaTumorRes_Hopf$data
smpAnno <- metaTumorRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAmetaTumorRes_Hopf <- proDA::test_diff(fit,
                                               contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                               sort_by = 'pval')
proDAmetaTumorRes_Hopf <- dplyr::filter(all_proDAmetaTumorRes_Hopf, pval < 0.05)

metaNormalRes_Hopf <- doSOA(metaNormal_Hopf, meta_var = 'Recurrence')
datMat <- metaNormalRes_Hopf$data
smpAnno <- metaNormalRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAmetaNormalRes_Hopf <- proDA::test_diff(fit,
                                                contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                sort_by = 'pval')
proDAmetaNormalRes_Hopf <- dplyr::filter(all_proDAmetaNormalRes_Hopf, pval < 0.05)

# Untargeted Plasma Lipidomics
lipBaseRes_Hopf <- doSOA(lipBase_Hopf, meta_var = 'Recurrence')
datMat <- lipBaseRes_Hopf$data
smpAnno <- lipBaseRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAlipBaseRes_Hopf <- proDA::test_diff(fit,
                                             contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                             sort_by = 'pval')
proDAlipBaseRes_Hopf <- dplyr::filter(all_proDAlipBaseRes_Hopf, pval < 0.05)

lipFoloRes_Hopf <- doSOA(lipFolo_Hopf, meta_var = 'Recurrence')
datMat <- lipFoloRes_Hopf$data
smpAnno <- lipFoloRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAlipFoloRes_Hopf <- proDA::test_diff(fit,
                                             contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                             sort_by = 'pval')
proDAlipFoloRes_Hopf <- dplyr::filter(all_proDAlipFoloRes_Hopf, pval < 0.05)

# Untargeted Tissue Lipidomics
lipTumorRes_Hopf <- doSOA(lipTumor_Hopf, meta_var = 'Recurrence')
datMat <- lipTumorRes_Hopf$data
smpAnno <- lipTumorRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAlipTumorRes_Hopf <- proDA::test_diff(fit,
                                              contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                              sort_by = 'pval')
proDAlipTumorRes_Hopf <- dplyr::filter(all_proDAlipTumorRes_Hopf, pval < 0.05)

lipNormalRes_Hopf <- doSOA(lipNormal_Hopf, meta_var = 'Recurrence')
datMat <- lipNormalRes_Hopf$data
smpAnno <- lipNormalRes_Hopf$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAlipNormalRes_Hopf <- proDA::test_diff(fit,
                                               contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                               sort_by = 'pval')
proDAlipNormalRes_Hopf <- dplyr::filter(all_proDAlipNormalRes_Hopf, pval < 0.05)

# DIA Plasma Proteomics
proBaseRes_Kri_DIA <- doSOA(proBase_Kri_DIA, meta_var = 'Recurrence')
datMat <- proBaseRes_Kri_DIA$data
smpAnno <- proBaseRes_Kri_DIA$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAproBaseRes_Kri_DIA <- proDA::test_diff(fit,
                                                contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                sort_by = 'pval')
proDAproBaseRes_Kri_DIA <- dplyr::filter(all_proDAproBaseRes_Kri_DIA, pval < 0.05)

proFoloRes_Kri_DIA <- doSOA(proFolo_Kri_DIA, meta_var = 'Recurrence')
datMat <- proFoloRes_Kri_DIA$data
smpAnno <- proFoloRes_Kri_DIA$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAproFoloRes_Kri_DIA <- proDA::test_diff(fit,
                                                contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                sort_by = 'pval')
proDAproFoloRes_Kri_DIA <- dplyr::filter(all_proDAproFoloRes_Kri_DIA, pval < 0.05)

# DIA Tissue Proteomics
proTumorRes_Kri_DIA <- doSOA(proTumor_Kri_DIA, meta_var = 'Recurrence')
datMat <- proTumorRes_Kri_DIA$data
smpAnno <- proTumorRes_Kri_DIA$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAproTumorRes_Kri_DIA <- proDA::test_diff(fit,
                                                 contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                 sort_by = 'pval')
proDAproTumorRes_Kri_DIA <- dplyr::filter(all_proDAproTumorRes_Kri_DIA, pval < 0.05)

proNormalRes_Kri_DIA <- doSOA(proNormal_Kri_DIA, meta_var = 'Recurrence')
datMat <- proNormalRes_Kri_DIA$data
smpAnno <- proNormalRes_Kri_DIA$smpMetadata
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
all_proDAproNormalRes_Kri_DIA <- proDA::test_diff(fit,
                                                  contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                                  sort_by = 'pval')
proDAproNormalRes_Kri_DIA <- dplyr::filter(all_proDAproNormalRes_Kri_DIA, pval < 0.05)
```

```{r}
# Make barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats_Hell <- nrow(metaBaseRes_Hell$tFeatSigRes) / nrow(metaBaseRes_Hell$data) * 100
metaFoloSigFeats_Hell <- nrow(metaFoloRes_Hell$tFeatSigRes) / nrow(metaFoloRes_Hell$data) * 100
metaTumorSigFeats_Hell <- nrow(metaTumorRes_Hell$tFeatSigRes) / nrow(metaTumorRes_Hell$data) * 100
metaNormalSigFeats_Hell <- nrow(metaNormalRes_Hell$tFeatSigRes) / nrow(metaNormalRes_Hell$data) * 100
proBaseSigFeats_Kri_DDA <- nrow(proBaseRes_Kri_DDA$tFeatSigRes) / nrow(proBaseRes_Kri_DDA$data) * 100
proFoloSigFeats_Kri_DDA <- nrow(proFoloRes_Kri_DDA$tFeatSigRes) / nrow(proFoloRes_Kri_DDA$data) * 100
proTumorSigFeats_Kri_DDA <- nrow(proTumorRes_Kri_DDA$tFeatSigRes) / nrow(proTumorRes_Kri_DDA$data) * 100
proNormalSigFeats_Kri_DDA <- nrow(proNormalRes_Kri_DDA$tFeatSigRes) / nrow(proNormalRes_Kri_DDA$data) * 100

metaBaseSigFeats_Hopf <- nrow(proDAmetaBaseRes_Hopf) / nrow(metaBaseRes_Hopf$data) * 100
metaFoloSigFeats_Hopf <- nrow(proDAmetaFoloRes_Hopf) / nrow(metaFoloRes_Hopf$data) * 100
metaTumorSigFeats_Hopf <- nrow(proDAmetaTumorRes_Hopf) / nrow(metaTumorRes_Hopf$data) * 100
metaNormalSigFeats_Hopf <- nrow(proDAmetaNormalRes_Hopf) / nrow(metaNormalRes_Hopf$data) * 100
lipBaseSigFeats_Hopf <- nrow(proDAlipBaseRes_Hopf) / nrow(lipBaseRes_Hopf$data) * 100
lipFoloSigFeats_Hopf <- nrow(proDAlipFoloRes_Hopf) / nrow(lipFoloRes_Hopf$data) * 100
lipTumorSigFeats_Hopf <- nrow(proDAlipTumorRes_Hopf) / nrow(lipTumorRes_Hopf$data) * 100
lipNormalSigFeats_Hopf <- nrow(proDAlipNormalRes_Hopf) / nrow(lipNormalRes_Hopf$data) * 100
proBaseSigFeats_Kri_DIA <- nrow(proDAproBaseRes_Kri_DIA) / nrow(proBaseRes_Kri_DIA$data) * 100
proFoloSigFeats_Kri_DIA <- nrow(proDAproFoloRes_Kri_DIA) / nrow(proFoloRes_Kri_DIA$data) * 100
proTumorSigFeats_Kri_DIA <- nrow(proDAproTumorRes_Kri_DIA) / nrow(proTumorRes_Kri_DIA$data) * 100
proNormalSigFeats_Kri_DIA <- nrow(proDAproNormalRes_Kri_DIA) / nrow(proNormalRes_Kri_DIA$data) * 100

# Prepare needed information for barplot
dat <- c('Untargeted Metabolomics', 'Untargeted Metabolomics',
         'Targeted Metabolomics', 'Targeted Metabolomics',
         'Untargeted Lipidomics', 'Untargeted Lipidomics',
         'DIA Proteomics', 'DIA Proteomics',
         'DDA Proteomics', 'DDA Proteomics',
         'Untargeted Metabolomics', 'Untargeted Metabolomics',
         'Targeted Metabolomics', 'Targeted Metabolomics',
         'Untargeted Lipidomics', 'Untargeted Lipidomics',
         'DIA Proteomics', 'DIA Proteomics',
         'DDA Proteomics', 'DDA Proteomics')
datModal <- c(rep(c('Baseline', 'Follow-up'), 5), rep(c('Tumor', 'Normal'), 5))
datOf <- c(rep('Plasma', 10), rep('Tissue', 10))
proportion <- c(metaBaseSigFeats_Hopf, metaFoloSigFeats_Hopf,
                metaBaseSigFeats_Hell, metaFoloSigFeats_Hell,
                lipBaseSigFeats_Hopf, lipFoloSigFeats_Hopf,
                proBaseSigFeats_Kri_DIA, proFoloSigFeats_Kri_DIA,
                proBaseSigFeats_Kri_DDA, proFoloSigFeats_Kri_DDA,
                metaTumorSigFeats_Hopf, metaNormalSigFeats_Hopf,
                metaTumorSigFeats_Hell, metaNormalSigFeats_Hell,
                lipTumorSigFeats_Hopf, lipNormalSigFeats_Hopf,
                proTumorSigFeats_Kri_DIA, proNormalSigFeats_Kri_DIA,
                proTumorSigFeats_Kri_DDA, proNormalSigFeats_Kri_DDA)
numFeat <- c(c(nrow(metaBaseRes_Hopf$data), NA), c(nrow(metaBaseRes_Hell$data), NA),
             c(NA, nrow(lipFoloRes_Hopf$data)), c(nrow(proBaseRes_Kri_DIA$data), NA),
             c(nrow(proBaseRes_Kri_DDA$data), NA),
             c(nrow(metaTumorRes_Hopf$data), NA), c(nrow(metaTumorRes_Hell$data), NA),
             c(NA, nrow(lipNormalRes_Hopf$data)), c(nrow(proTumorRes_Kri_DIA$data), NA),
             c(nrow(proNormalRes_Kri_DDA$data), NA))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = unique(dat)),
                             Data_modality = datModal,
                             Data_of = datOf,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill = Data_modality, label=Feature_number)) +
  geom_bar(stat = 'identity', position=position_dodge()) +
  geom_text(size = 5, vjust = -0.3) +
  facet_wrap(~Data_of) +
  labs(x = 'Data', y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Sample Condition') +
  th + theme(axis.text.x = element_text(angle = 65, vjust = 1, hjust = 1),
             strip.text = element_text(size = 16, face = 'bold'))
  # theme(strip.text = element_text(size = 26), axis.title = element_text(size = 26),
  #       axis.text.x = element_text(size = 11.5, angle = 60, vjust = 1, hjust = 1), axis.text.y = element_text(size = 22),
  #       legend.title = element_text(size = 24), legend.text = element_text(size = 24),
  #       panel.background = element_blank(), axis.line = element_line(color = 'black'))
# ggsave('./output/percentage_sigFeats.png', device = 'png', dpi = 400, height = 8, width = 18)
```
ADD COMMENT!

```{r include = F, eval = F}
# Prepare needed information for barplot
dat <- rev(c('Baseline Plasma Untargeted Metabolomics', 'Follow-up Plasma Untargeted Metabolomics',
             'Baseline Plasma Targeted Metabolomics', 'Follow-up Plasma Targeted Metabolomics',
             'Baseline Plasma Untargeted Lipidomics', 'Follow-up Plasma Untargeted Lipidomics',
             'Baseline Plasma DIA Proteomics', 'Follow-up Plasma DIA Proteomics',
             'Baseline Plasma DDA Proteomics', 'Follow-up Plasma DDA Proteomics',
             'Tumor Tissue Untargeted Metabolomics', 'Normal Tissue Untargeted Metabolomics',
             'Tumor Tissue Targeted Metabolomics', 'Normal Tissue Targeted Metabolomics',
             'Tumor Tissue Untargeted Lipidomics', 'Normal Tissue Untargeted Lipidomics',
             'Tumor Tissue DIA Proteomics', 'Normal Tissue DIA Proteomics',
             'Tumor Tissue DDA Proteomics', 'Normal Tissue DDA Proteomics'))
datModal <- rev(c(rep('Plasma Metabolomics', 4), rep('Plasma Lipidomics', 2), rep('Plasma Proteomics', 4),
                  rep('Tissue Metabolomics', 4), rep('Tissue Lipidomics', 2), rep('Tissue Proteomics', 4)))
datOf <- rev(c(rep('Plasma', 10), rep('Tissue', 10)))
proportion <- rev(c(metaBaseSigFeats_Hopf, metaFoloSigFeats_Hopf,
                    metaBaseSigFeats_Hell, metaFoloSigFeats_Hell,
                    lipBaseSigFeats_Hopf, lipFoloSigFeats_Hopf,
                    proBaseSigFeats_Kri_DIA, proFoloSigFeats_Kri_DIA,
                    proBaseSigFeats_Kri_DDA, proFoloSigFeats_Kri_DDA,
                    metaTumorSigFeats_Hopf, metaNormalSigFeats_Hopf,
                    metaTumorSigFeats_Hell, metaNormalSigFeats_Hell,
                    lipTumorSigFeats_Hopf, lipNormalSigFeats_Hopf,
                    proTumorSigFeats_Kri_DIA, proNormalSigFeats_Kri_DIA,
                    proTumorSigFeats_Kri_DDA, proNormalSigFeats_Kri_DDA))
numFeat <- rev(c(rep('1406', 2), rep('630', 2), rep('2493', 2), rep('505', 2), rep('435', 2),
                 rep('1387', 2), rep('630', 2), rep('2168', 2), rep('6929', 2), rep('5193', 2)))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = dat),
                             Data_modality = datModal,
                             Data_of = datOf,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill=Data_of, label=Feature_number)) +
  geom_bar(stat = 'identity') +
  geom_text(size = 5, hjust = -0.2) +
  ylim(0, 9) +
  coord_flip() +
  labs(x = 'Data', y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Sample Type') +
  theme(axis.title = element_text(size = 18),
        axis.text.x = element_text(size = 13), axis.text.y = element_text(size = 12),
        legend.title = element_text(size = 14), legend.text = element_text(size = 14))
```
