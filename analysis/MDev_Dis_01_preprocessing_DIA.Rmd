---
title: "Preprocessing: DIA Proteomics of Method Dev and Discovery cohorts"
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: yes
    toc_float: yes
    code_folding: hide
---

<font size='4'> Description: Preprocess and combine Method Development and Discovery
Tissue DIA Proteomics generated from AG Klingmüller and AG Krijgsveld, including
data cleansing, filtering, normalization (VSN), and data merging. All needed information
was then stored in SummarizedExperiment objects for further analyses.

For Klin. data: Sample **Q89YQK_NG**, **1TK71I_TU**, **NG1IWD_TU**, **125CII_TU**,
**1LJXIN_TU**, **I0HVOL_TU**, **7EAOX7_TU**, and **PDIR55_NG** were excluded. (Check
Section '**Show reasons for removing samples**' for more details)

For Krij. data: Sample **I0HVOL_TU**, **7EAOX7_TU**, **3M0D40_TU**, **MJMTYR_TU**,
**PDIR55_NG**, and **XFKHGP_NG** were excluded.
(Check Section '**Show reasons for removing samples**' for more details). </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer')
```

Load libraries
```{r load libraries, message=F}
library(readr)
library(readxl)
library(vsn)
library(limma)
library(sva)
library(visdat)
library(ggrepel)
library(MultiAssayExperiment)
library(SummarizedExperiment)
library(tidyverse)
# Load user-defined functions
source('./code/analysis_pipeline.R')
source('./code/misc.R')
source('./code/comparison_funcs.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

```{r prepare global info, message=F}
# Load sample metadata
smpMetadat <- readxl::read_excel('./data/metadata_latest/sample_metadata.xlsx')
colnames(smpMetadat) <- smpMetadat[3,, drop = F]
smpMetadat <- dplyr::slice(smpMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Parents, Visit, `Material submitted`, `Date and time of collection or surgery`,
                  `SMART-CARE cohort identifier`)) %>%
  dplyr::rename(Sample = Code, Patient = Parents, TimePoint = Visit, SmpType = `Material submitted`,
                Date = `Date and time of collection or surgery`, Cohort = `SMART-CARE cohort identifier`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^SC_T_S_|^SC_DIS_S_|^SC_VAL_S_|^SC_S_|_P'),
                Patient = stringr::str_remove(Patient, '^/THRX_SPACE/THRX_DB/'),
                TimePoint = dplyr::case_when(TimePoint == 'PRETHERAPEUTIC' ~ 'Baseline',
                                             TimePoint == 'FOLLOW-UP' ~ 'Follow-up',
                                             TimePoint == 'RECURRENCE' ~ 'Recurrence'),
                SmpType = dplyr::case_when(SmpType == 'EDTA_PLASMA' ~ 'Plasma',
                                           SmpType == 'FRESH_FROZEN_TISSUE' ~ 'Tissue'),
                Condition = dplyr::case_when(grepl('_TU|_TG', Sample) ~ 'Tumor',
                                             grepl('_NG', Sample) ~ 'Normal',
                                             !grepl('_TU|_TG|_NG', Sample) ~ TimePoint),
                TimePoint = dplyr::case_when(TimePoint %in% 'Recurrence' ~ 'Follow-up',
                                             !TimePoint %in% 'Recurrence' ~ TimePoint),
                Date = stringr::str_extract(Date, '^\\d+-\\d+-\\d+'),
                Cohort = dplyr::case_when(Cohort == 'DISCOVERY_COHORT' ~ 'Discovery',
                                          Cohort == 'METHOD_DEVELOPMENT_COHORT' ~ 'MethodDev',
                                          Cohort == 'VALIDATION_COHORT' ~ 'Validation'),
                Date = as.Date(Date, format = '%Y-%m-%d'))

# Load patient metadata
patientMetadat <- readxl::read_excel('./data/metadata_latest/patient_metadata.xlsx')
colnames(patientMetadat) <- patientMetadat[3,, drop = F]
patientMetadat <- dplyr::slice(patientMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Gender, `Age at diagnosis`, `Pathological stage`, `Smoking status`,
                  `Adjuvant chemotherapy`, Nutrition)) %>%
  dplyr::rename(Patient = Code, Age = `Age at diagnosis`, Stage = `Pathological stage`,
                Smoking = `Smoking status`, Adjuvant = `Adjuvant chemotherapy`) %>%
  dplyr::mutate(Gender = dplyr::case_when(Gender == 'MALE' ~ 'Male',
                                          Gender == 'FEMALE' ~ 'Female'),
                Smoking = dplyr::case_when(Smoking == 'SMOKER' ~ 'Smoker',
                                           Smoking == 'EX-SMOKER' ~ 'Ex-smoker',
                                           Smoking == 'NON-SMOKER' ~ 'Non-smoker'),
                Adjuvant = dplyr::case_when(Adjuvant == 'true' ~ 'True',
                                            Adjuvant == 'false' ~ 'False'),
                Age = as.numeric(Age),
                Nutrition = dplyr::case_when(Nutrition == 'WHOLE_FOOD' ~ 'Whole_food'))
# Include patient recurrence information in patient metadata
recurPats <- dplyr::filter(smpMetadat, Condition == 'Recurrence') %>%
  dplyr::pull(Patient)
patientMetadat <- dplyr::mutate(patientMetadat, Recurrence = dplyr::case_when(Patient %in% recurPats ~ 'Yes',
                                                                              !Patient %in% recurPats ~ 'No'))

# Load aliquot metadata
aliquotMetadat <- readxl::read_excel('./data/metadata_latest/aliquot_metadata.xlsx')
colnames(aliquotMetadat) <- aliquotMetadat[3,, drop = F]
aliquotMetadat <- dplyr::slice(aliquotMetadat, -c(1:3)) %>%
  dplyr::select(Code, Parents, `Tumor Cell Content (%)`, `Cohort Identifier`, `Submission to`,
                `Delivered?`) %>%
  dplyr::rename(Aliquot = Code, Sample = Parents, TumorPurity = `Tumor Cell Content (%)`,
                Cohort = `Cohort Identifier`, To = `Submission to`, Delivered = `Delivered?`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^/THRX_SPACE/THRX_DB/SC_T_S_|_P'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_VAL_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_VAL_'),
                Cohort = dplyr::case_when(Cohort == 'method establishment' ~ 'MethodDev',
                                          Cohort == 'DISCOVERY_COHORT' ~ 'Discovery',
                                          Cohort == 'VALIDATION_COHORT' ~ 'Validation'),
                TumorPurity = as.numeric(TumorPurity),
                TumorPurity = dplyr::case_when(grepl('_TU|_TG', Sample) ~ TumorPurity),
                # Mislabeling??
                Sample = case_when(Sample %in% 'SDIR55_NG' ~ 'PDIR55_NG',
                                   Sample %in% 'SDIR55_TU' ~ 'PDIR55_TU',
                                   Sample %in% 'SD4ADT_NG' ~ 'PD4ADT_NG',
                                   Sample %in% 'SD4ADT_TU' ~ 'PD4ADT_TU',
                                   !Sample %in% c('SDIR55_NG', 'SDIR55_TU',
                                                  'SD4ADT_NG', 'SD4ADT_TU') ~ Sample)) %>%
  dplyr::filter(To %in% c('KLINGMUELLER', 'KRIJGSVELD'))
# Prepare tumor purity information
tumorPurityInfo <- dplyr::select(aliquotMetadat, Sample, TumorPurity) %>%
  dplyr::filter(!duplicated(Sample))

# Combine all needed metadata
summMetadat <- dplyr::select(aliquotMetadat, Aliquot, Sample, TumorPurity, To) %>%
  dplyr::left_join(smpMetadat, by = 'Sample') %>%
  dplyr::left_join(patientMetadat, by = 'Patient')
summMetadat4Krij <- dplyr::left_join(smpMetadat, patientMetadat, by = 'Patient') %>%
  dplyr::left_join(tumorPurityInfo, by = 'Sample')
# Manually add an extra sample to summarized metadata
smp <- summMetadat4Krij[summMetadat4Krij$Sample == '6EY5JO_TU',]
smp[1, 1] <- '6EY5JO_II_TU'
summMetadat4Krij <- rbind(summMetadat4Krij, smp)

# List sample annotations to keep in SE objects
smpAnno <- c('Patient', 'SmpType', 'TimePoint', 'Date', 'Cohort', 'Condition',
             'Recurrence', 'Gender', 'Age', 'Smoking', 'Stage', 'Adjuvant',
             'Nutrition', 'TumorPurity')
```

# Tissue samples

## AG Klingmüller

### Proteomics

```{r}
# Load MultiAssayExperiment object containing Proteomics, Phosphoproteomics, and
# Phospho ratio of Method Dev and Discovery cohorts summarized by Junyan
proPhosTissue_MDevDis <- readRDS('./data/Discovery/AG_Klingmueller/COMP_2696.SMART_Lung_MethodDiscov_ProPhos.rds')
# Convert data matrix to long data for tidying up data and conducting preprocessing
proTissue <- proPhosTissue_MDevDis@ExperimentList$Proteome
featAnnoTab <- tibble::as_tibble(rowData(proTissue), rownames = 'p') %>%
  dplyr::rename(Feature = UniprotID)
summMetadat_Klin <- dplyr::filter(summMetadat, To %in% 'KLINGMUELLER')
proTissueTab <- tibble::as_tibble((assay(proTissue)), rownames = 'p') %>%
  tidyr::pivot_longer(cols = -p, names_to = 'Aliquot', values_to = 'Abundance') %>%
  dplyr::mutate(Aliquot = stringr::str_remove(Aliquot, '_FP$'),
                Aliquot = dplyr::case_when(Aliquot %in% 'SC_T_A_1WFPXHTG_4' ~ 'SC_T_A_1WFPXHTG_1',
                                           Aliquot %in% 'SC_T_A_7ZY8GLNG_2' ~ 'SC_T_A_7ZY8GLNG_1',
                                           Aliquot %in% 'SC_DIS_A_PDIR55_TU3' ~ 'SC_DIS_A_PDIR55_TU1',
                                           !Aliquot %in% c('SC_T_A_1WFPXHTG_4', 'SC_T_A_7ZY8GLNG_2',
                                                           'SC_T_A_1WFPXHTG_4') ~ Aliquot)) %>%
  dplyr::left_join(featAnnoTab, by = 'p') %>%
  dplyr::left_join(summMetadat_Klin, by = 'Aliquot') %>%
  dplyr::select(-c(p, Aliquot)) %>%
  # Compute sample missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MissLevel = sum(is.na(Abundance)) / length(Abundance)) %>%
  dplyr::ungroup()

# Remove tumor samples with low tumor purity
proTissue_Dis_Krij <- readRDS('./data/Discovery/AG_Krijgsveld/proTissueVsn.rds')
goodSmps_Dis <- colnames(proTissue_Dis_Krij)
allSmps_Dis <- unique(proTissueTab[proTissueTab$Cohort == 'Discovery', 'Sample', drop = T])
badSmps_Dis <- allSmps_Dis[!allSmps_Dis %in% goodSmps_Dis]
# Manually remove Sample '1HTNWJ_TU' from bad quality sample list due to its missingness
# in good quality sample list
badSmps_Dis <- badSmps_Dis[-which(badSmps_Dis == '1HTNWJ_TU')]
# badSmps_Dis <- badSmps_Dis[grepl('_TU', badSmps_Dis)] #for now, assume all samples from those patients are bad quality
# proTissueTab <- dplyr::filter(proTissueTab, !Sample %in% badSmps_Dis)
rm(proTissue_Dis_Krij, goodSmps_Dis, allSmps_Dis)

# Remove samples with high missing level or low tumor purity and misclassified
allProTissueTab <- proTissueTab
proTissueTab <- dplyr::filter(proTissueTab, !Sample %in% c('Q89YQK_NG', '125CII_TU',
                                                           '1TK71I_TU', '1LJXIN_TU',
                                                           'NG1IWD_TU', 'I0HVOL_TU',
                                                           '7EAOX7_TU', 'PDIR55_NG'))
```

<font size='4'> **Overview original data** </font>\
6 Tumor samples and 2 Normal sample have been excluded before preprocessing. Check
**Show reasons for removing samples** for more details
```{r}
# Preprocess data
proTissuePrepro <- doPreprocessing(proTissueTab, feat = 'Feature', smp = 'Sample',
                                   val = 'Abundance', smpAnno = c(smpAnno, 'MissLevel'),
                                   featAnno = 'Gene', do_featFilt = T, cutoff = 0.5, viz_miss = T)
                                   # save_path = './data/Discovery/AG_Klingmueller/proTissue'
# Show dimensions of data
cat('Data dimensions:', dim(proTissuePrepro$ori.data)[2], 'samples and',
    dim(proTissuePrepro$ori.data)[1], 'features')

# Visualize data missingness
proTissuePrepro$ori.data.miss +
  labs(title = 'Missingness of original data') +
  theme(axis.text.x = element_text(size = 5))

# Visualize data distribution
proTissuePrepro$ori.data.dist +
  labs(title = 'Distribution of original data') +
  theme(axis.text.x = element_text(size = 5))
```

<font size='4'> **Overview filtered vsn normalized data** </font>\
Features quantified in less than half of samples are removed.
```{r}
# Show dimensions of data
cat('Filtered data dimensions:', dim(proTissuePrepro$filt.data)[2], 'samples and',
    dim(proTissuePrepro$filt.data)[1], 'features')

# Visualize data missingness
proTissuePrepro$filt.data.miss +
  labs(title = 'Missingness of filtered data') +
  theme(axis.text.x = element_text(size = 5))

# Visualize data distribution
proTissuePrepro$vsn.data.dist +
  labs(y = 'Log(Abundance)', title = 'Distribution of filtered vsn normalized data') +
  theme(axis.text.x = element_text(size = 5))

# Visualize mean-sd relationship
proTissuePrepro$vsn.feat.mean.var +
  labs(title = 'Feature mean-sd relationship after vsn normalization')
```

<font size='4'> **Do metadata-assisted quality control: Tumor vs Normal samples** </font>
```{r}
# Do PCA
pcaRes <- doSOA(proTissuePrepro$vsn.data, meta_var = 'Condition', #'TumorPurity', 'MissLevel'
                pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes$pcSigAssoRes
# Visualize PCs
# Prepare samples to be labeled
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Extra = dplyr::case_when(Sample %in% badSmps_Dis ~ 'Yes',
                                         !Sample %in% badSmps_Dis ~ 'No'))
ggplot(pcTab, aes(x=Condition, y=`PC1 (33.3%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 4, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th
#   theme(axis.title = element_text(size = 22),
#         axis.text.x = element_text(size = 18),
#         axis.text.y = element_text(size = 14),
#         legend.title = element_text(size = 22),
#         legend.text = element_text(size = 20))
# ggsave('./output/Discovery/25.07.24_LGM/QC_combined_proTissue_Klin_PC1_rmSmps.png',
#        device = 'png', dpi = 400, height = 8, width = 10)

# Check quality of those extra normal samples whose tumor counterparts were removed
# ggplot(pcTab, aes(x=`PC1 (33.3%)`, y=`PC2 (14.4%)`, col=Condition, shape=Extra)) +
#   geom_point(size = 2.5) +
#   scale_color_brewer(palette = 'Dark2') +
#   scale_shape_manual(name = 'Extra samples', values = c(16, 3)) +
#   th

# Check tumor purity of tumor samples
# ggplot(pcTab, aes(x=`PC1 (33.3%)`, y=`PC2 (14.4%)`, col=TumorPurity, shape=Condition)) +
#   geom_point(size = 2.5) +
#   scale_color_continuous(name = 'Tumor purity (%)') +
#   th

# Check missing levels of samples
# ggplot(pcTab, aes(x=`PC1 (33.3%)`, y=`PC2 (14.4%)`, col=MissLevel*100, shape=Condition)) +
#   geom_point(size = 2.5) +
#   scale_color_continuous(name = 'Missing level (%)', type = 'viridis') +
#   th
```

<font size='4'> **Show reasons for removing samples** </font>\
Samples '1TK71I_TU', 'NG1IWD_TU', '125CII_TU', and '1LJXIN_TU' are removed due to
low tumor purity and misclassification in metadata-assisted quality control (Tumor
vs Normal, PC1, clustering). Samples 'I0HVOL_TU' and '7EAOX7_TU' got decent tumor
purity but still got removed due to misclassification and similar molecular signature
as normal samples (PC1, clustering). Sample 'Q89YQK_NG' is removed due to high level
of missingness (71%) and potential outlier (PC2). Sample 'PDIR55_NG' is removed
because its molecular signature is more like that of tumor samples (clustering).

**PCA**
```{r}
# Prepare preprocessed data containing all samples
allProTissueVsn <- doPreprocessing(allProTissueTab, feat = 'Feature', smp = 'Sample',
                                   val = 'Abundance', smpAnno = c(smpAnno, 'MissLevel'),
                                   featAnno = 'Gene', do_featFilt = T, cutoff = 0.5)$vsn.data
# Do PCA
pcaRes <- doSOA(allProTissueVsn, meta_var = 'Condition', pca_method = 'ppca', num_PCs = 20,
                do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Label = dplyr::case_when(Sample %in% c('I0HVOL_TU', 'I0HVOL_NG',
                                                       '7EAOX7_TU', '7EAOX7_NG',
                                                       '1LJXIN_TU','125CII_TU', 
                                                       '1TK71I_TU', 'NG1IWD_TU',
                                                       'PDIR55_NG') ~ Sample),
                Label2 = dplyr::case_when(Sample %in% 'Q89YQK_NG' ~ Sample))
ggplot(pcTab, aes(x=Condition, y=`PC1 (29.9%)`, col=Condition, fill=Condition, label=Label)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 4, show.legend = F) +
  geom_text_repel(size = 6, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th
#   theme(axis.title = element_text(size = 22),
#         axis.text.x = element_text(size = 18),
#         axis.text.y = element_text(size = 14),
#         legend.title = element_text(size = 22),
#         legend.text = element_text(size = 20))
# ggsave('./output/Discovery/25.07.24_LGM/QC_combined_proTissue_Klin_PC1_allSmps.png',
#        device = 'png', dpi = 400, height = 8, width = 10)

# Check missing levels of samples
ggplot(pcTab, aes(x=`PC1 (29.9%)`, y=`PC2 (14%)`, col=MissLevel*100, shape=Condition, label=Label2)) +
  geom_point(size = 5) +
  geom_text_repel(size = 7, show.legend = F) +
  scale_color_continuous(name = 'Missing level (%)') +
  th
  # theme(axis.title = element_text(size = 22),
  #       axis.text = element_text(size = 14),
  #       legend.title = element_text(size = 22),
  #       legend.text = element_text(size = 20))
# ggsave('./output/Discovery/25.07.24_LGM/QC_combined_proTissue_Klin_PC1&2_allSmps.png',
#        device = 'png', dpi = 400, height = 8, width = 11)


# Display tumor purity and missing levels of misclassified samples and potential outlier
dplyr::distinct(allProTissueTab, Sample, .keep_all = T) %>%
  dplyr::select(Sample, TumorPurity, MissLevel) %>%
  dplyr::filter(Sample %in% c('I0HVOL_TU', '7EAOX7_TU', '1LJXIN_TU', '125CII_TU',
                              '1TK71I_TU', 'NG1IWD_TU', 'Q89YQK_NG', 'PDIR55_NG')) %>%
  as.data.frame()
```
=> Mean of sample tumor cell contents is 67%, ranging from 10% to 100%.\
=> Mean of sample missing levels is 31%, ranging from 21% to 71%.

**Hierarchical clustering**\
Top 100 significant features between Tumor and Normal samples are used, of which
Bad-quality samples were excluded for significance testing. Features (rows) are
ordered by t-statistics.
```{r message=F}
# Check if potential bad-quality Tumor samples get condition-associated molecular
# signature identified in good-quality samples
# Prepare top significant features between Tumor and Normal samples
# subProTissueTab <- dplyr::filter(allProTissueTab, !Sample %in% badSmps_Dis)
# proTissueVsn <- doPreprocessing(subProTissueTab, feat = 'Feature', smp = 'Sample',
#                                 val = 'Abundance', smpAnno = c(smpAnno, 'MissLevel'),
#                                 featAnno = 'Gene', do_featFilt = T, cutoff = 0.5)$vsn.data
# soaRes <- doSOA(proTissueVsn, meta_var = 'Condition', pca_method = 'ppca',
#                 num_PCs = 20, use_proDA = T, level_metaVar = c('Tumor', 'Normal'))
# saveRDS(soaRes, './data/Discovery/AG_Klingmueller/soaRes/proTissueRes_rmBadSmps.rds')
soaRes <- readRDS('./data/Discovery/AG_Klingmueller/soaRes/proTissueRes_rmBadSmps.rds')
topSigFeatIdx <- order(abs(soaRes$featSigAssoRes$Stat), decreasing = T)[1:100]
topSigFeats <- soaRes$featSigAssoRes$Var1[topSigFeatIdx]
# Order top significant features by t-statistics
topSigFeatStats <- soaRes$featSigAssoRes$Stat[topSigFeatIdx]
featOrder <- topSigFeats[order(topSigFeatStats, decreasing = T)]

# Prepare preprocessed abundance matrix of all samples
proTissueVsn <- doPreprocessing(allProTissueTab, feat = 'Feature', smp = 'Sample',
                                val = 'Abundance', smpAnno = c(smpAnno, 'MissLevel'),
                                featAnno = 'Gene', do_featFilt = T, cutoff = 0.5)$vsn.data
datMat <- assay(proTissueVsn)
# Cluster samples by sample conditions
normalSmpIdx <- grep('_NG' ,colnames(datMat))
smpOrder <- c(colnames(datMat)[-normalSmpIdx], colnames(datMat)[normalSmpIdx])
# Prepare sample annotation table
smpAnnoTab <- dplyr::select(allProTissueTab, Sample, Condition) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
# Color sample groups as same as in PC plots
smpAnnoCols <- list(Condition = c(Normal = '#1B9E77', Tumor = '#D95F02'))

# View molecular signature of all samples
datMatSub <- datMat[featOrder, smpOrder]
pheatmap(datMatSub, scale = 'row', annotation_col = smpAnnoTab, annotation_colors = smpAnnoCols,
         color = colorRampPalette(c('navy', 'white', 'red'))(100), clustering_method = 'ward.D2',
         cluster_rows = F, cluster_cols = F, show_rownames = F, fontsize_col = 5,
         main = 'All samples (170)')

# View molecular signature of bad-quality samples
# rmSmps <- c('NG1IWD_TU', '1LJXIN_TU', '1TK71I_TU', '125CII_TU', '7EAOX7_TU', 'I0HVOL_TU',
#             'NG1IWD_NG', '1LJXIN_NG', '1TK71I_NG', '125CII_NG', '7EAOX7_NG', 'I0HVOL_NG')
badSmps <- c(badSmps_Dis, c('1LJXIN_TU', '7EAOX7_TU', 'I0HVOL_TU', '1LJXIN_NG',
                            '7EAOX7_NG', 'I0HVOL_NG'))
datMatSub <- datMat[featOrder, badSmps]
pheatmap(datMatSub, scale = 'row', annotation_col = smpAnnoTab, annotation_colors = smpAnnoCols,
         color = colorRampPalette(c('navy', 'white', 'red'))(100), clustering_method = 'ward.D2',
         cluster_rows = F, show_rownames = F,
         main = 'Potential bad-quality samples and corresponding normal samples')
```




</br>
</br>
<font size='5'> **Check data reproducibility by comparing New and Old Proteomics** </font>\
Note that only common samples between two datasets are considered.
```{r}
# Prepare preprocessed data sharing same sample space
proTissue_Old <- readRDS('./data/MethodDev/AG_Klingmueller/proTissueVsn.rds')
proTissue_New <- dplyr::filter(allProTissueTab, Sample %in% colnames(proTissue_Old)) %>%
  doPreprocessing(feat = 'Feature', smp = 'Sample', val = 'Abundance', featAnno = 'Gene',
                  smpAnno = smpAnno, do_featFilt = T, cutoff = 0.5)
proTissue_New <- proTissue_New$vsn.data
# Prepare preprocessed data corrected for SVs
svaRes_New <- doSVA(proTissue_New, wantedVar = c('Condition', 'Recurrence'), numSV_method = 'leek',
                    asso_metaVar = c('Condition', 'Recurrence', 'Gender', 'Age',
                                     'Smoking', 'Stage', 'Adjuvant', 'TumorPurity'))
svaRes_Old <- doSVA(proTissue_Old, wantedVar = c('Condition', 'Recurrence'), numSV_method = 'leek',
                    asso_metaVar = c('Condition', 'Recurrence', 'Gender', 'Age',
                                     'Smoking', 'Stage', 'Adjuvant', 'TumorPurity', 'Batch'))
proTissueSVs_New <- svaRes_New$summExp_SVs
proTissueSVs_Old <- svaRes_Old$summExp_SVs
```

```{r message=F, include=F, eval=F}
# <font size='4'> **Raw intensity data** </font>\
# **Feature correlations (data1: New data, data2: Old data)**

# Prepare raw intensity data sharing same sample space
# Old data
# Load and tidy unpreprocessed data
proTissueRaw_Old <- readr::read_tsv(
  './data/MethodDev/AG_Klingmueller/20230309_103228_SmartCare_TumorFree_Tumor_Yang001_Report.tsv'
) %>%
  dplyr::select(-c(PG.ProteinDescriptions, contains('PG.NrOfPrecursorsIdentified'),
                   contains('PG.IBAQ'), contains('PG.IsIdentified'))) %>%
  tidyr::pivot_longer(cols = -c('PG.ProteinGroups', 'PG.Genes'),
                      names_to = 'Experiment_ID',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Experiment_ID = stringr::str_remove_all(Experiment_ID, '\\[.*\\] |\\.PG\\.Quantity'),
                Abundance = gsub(',', '\\.', Abundance),
                Abundance = as.numeric(Abundance))
# Convert NaN to NA for vsn
proTissueRaw_Old$Abundance[is.nan(proTissueRaw_Old$Abundance)] <- NA

# Load experimental ID annotations
idAnnoTab <- readxl::read_excel('./data/MethodDev/AG_Klingmueller/230620_SMART-CARE_overview_OpenBIS_BH.xlsx') %>%
  dplyr::select(`Experimental ID`, `Aliquot ID`, Batch) %>%
  dplyr::rename(Aliquot = `Aliquot ID`, Experiment_ID = `Experimental ID`) %>%
  dplyr::mutate(Batch = dplyr::case_when(Batch == 'first' ~ '1', Batch == 'second' ~ '2'))
# Manually correct typo
idAnnoTab[which(idAnnoTab$Experiment_ID == 'Recurrence _TumorFree_P21'), 'Experiment_ID'] <- 'Recurrence_TumorFree_P21'
idAnnoTab[which(idAnnoTab$Experiment_ID == 'Recurrence _Tumor_P21'), 'Experiment_ID'] <- 'Recurrence_Tumor_P21'

# Convert long data to wide data
# Include summarized metadata
proTissueRaw_Old <- dplyr::left_join(proTissueRaw_Old, idAnnoTab, by = 'Experiment_ID') %>%
  dplyr::left_join(summMetadat, by = 'Aliquot') %>%
  dplyr::select(PG.ProteinGroups, Sample, Abundance) %>%
  dplyr::group_by(PG.ProteinGroups) %>%
  # Compute proportion of observed data points of each group (feature)
  dplyr::mutate(frac_nonNA = round(sum(!is.na(Abundance)) / length(Abundance), 2)) %>%
  dplyr::ungroup() %>%
  # Keep features observed in more than certain proportion of samples
  dplyr::filter(frac_nonNA >= 0.5) %>%
  dplyr::select(-frac_nonNA) %>%
  tidyr::pivot_wider(names_from = 'Sample', values_from = 'Abundance') %>%
  tibble::column_to_rownames('PG.ProteinGroups') %>%
  as.matrix()

# New data
# Convert long data to wide data
proTissueRaw_New <- dplyr::filter(allProTissueTab, Sample %in% colnames(proTissueRaw_Old)) %>%
  dplyr::select(Feature, Sample, Abundance) %>%
  dplyr::group_by(Feature) %>%
  # Compute proportion of observed data points of each group (feature)
  dplyr::mutate(frac_nonNA = round(sum(!is.na(Abundance)) / length(Abundance), 2)) %>%
  dplyr::ungroup() %>%
  # Keep features observed in more than certain proportion of samples
  dplyr::filter(frac_nonNA >= 0.5) %>%
  dplyr::select(-frac_nonNA) %>%
  tidyr::pivot_wider(names_from = 'Sample', values_from = 'Abundance') %>%
  tibble::column_to_rownames('Feature') %>%
  as.matrix()

# Compute feature correlations between two datasets
corrRes <- calcFeatCorr(proTissueRaw_New, proTissueRaw_Old, show_nFeats = T)
# Plot feature correlations
ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-1, 1, 0.1))) +
  labs(y = 'Frequency', title = 'Feature Correlations: New vs Old Proteomics (Raw)') +
  th
```

<font size='4'> **Preprocessed data without any covariate correction** </font>\
**Feature correlations (data1: New data, data2: Old data)**
```{r}
# Compute feature correlations between two datasets
corrRes <- calcFeatCorr(proTissue_New, proTissue_Old, show_nFeats = T)
# Plot feature correlations
ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-1, 1, 0.2))) +
  labs(y = 'Frequency', title = 'Feature Correlations: New vs Old Proteomics (Uncorrected)') +
  th
  # theme(axis.title = element_text(size = 22),
  #       axis.text = element_text(size = 18))
# ggsave('./output/Discovery/25.07.24_LGM/compFeatCorr_combined_proTissue_Klin_new_vs_old.png',
#        device = 'png', dpi = 400, height = 8, width = 10)
```

**log(FC) between Tumor and Normal samples**
```{r}
# Compute log(FC) and t-statistics between Tumor and Normal tissue samples in two datasets
# Prepare protein-gene table for providing gene names
featInfo <- tibble::as_tibble(rowData(proTissue_New), rownames = 'Proteins') %>%
  dplyr::rename(Genes = Gene) %>%
  dplyr::mutate(Proteins = stringr::str_remove(Proteins, ';.*'),
                Genes = stringr::str_remove(Genes, ';.*'))
# Prepare summarized tables of comparison for visualization
# condiFeatAssoTabs <- summarizeFeatAssoRes(proTissue_New, proTissue_Old, 'New', 'Old',
#                                           meta_var = 'Condition', subset = NULL,
#                                           method = 'proDA', alpha = 0.05, prot_gene_tbl = featInfo)
condiFeatAssoTabs <- readRDS('./data/Discovery/AG_Klingmueller/soaRes/New_vs_Old_condiFeatAsso.rds')

# Plot log(FC)
ggplot(condiFeatAssoTabs$tbl_logFC, aes(x=logFC_dat1, y=logFC_dat2, col=Direction)) +
  geom_point(size = 3) +
  ggpubr::stat_cor(data = condiFeatAssoTabs$tbl_logFC,
                   aes(x=logFC_dat1, y=logFC_dat2, col=NULL,
                       label=paste(..rr.label.., ..p.label.., sep = "~`,`~")),
                   size = 7, show.legend = F) +
  geom_abline(intercept = 0, slope = 1, col = 'black', linewidth = 0.8) +
  scale_color_manual(values = c('red', 'navy', 'grey')) +
  labs(x = 'log(FC) of New data', y = 'log(FC) of Old data',
       title = 'log(FC): Tumor vs Normal (Uncorrected)') +
  th
  # theme(axis.title = element_text(size = 22),
  #       axis.text = element_text(size = 14),
  #       legend.title = element_text(size = 22),
  #       legend.text = element_text(size = 20))
# ggsave('./output/Discovery/25.07.24_LGM/compLogFC_combined_proTissue_Klin_new_vs_old_condi.png',
#        device = 'png', dpi = 400, height = 8, width = 11)
```

**p-values (Tumor vs Normal samples, alpha = 0.05)**
```{r}
# Plot p-values
# Compute result consistency
percent <- round(sum(condiFeatAssoTabs$tbl_pVal$Significance == 'Sig. in Both') /
                   sum(condiFeatAssoTabs$tbl_pVal$Significance != 'Not Sig.'), 3) * 100

ggplot(condiFeatAssoTabs$tbl_pVal, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance)) +
  geom_point(size = 2) +
  geom_abline(intercept = 0, slope = 1, col = 'black', linewidth = 0.8) +
  scale_color_manual(values = c('red', 'darkgreen', 'navy', 'grey')) +
  labs(x = '-log10(pVal) of New data', y = '-log10(pVal) of Old data',
       title = 'p-val: Tumor vs Normal (Uncorrected)') +
  annotate('text', x = 5, y = 30, size = 4,
           label = paste0(percent, '% of significant results consistent')) +
  th
```

</br>
<font size='4'> **Preprocessed data accounted for SVs** </font>\
**Feature correlations**
```{r}
# Compute feature correlations between two datasets
corrRes <- calcFeatCorr(svaRes_New$correctDatMat, svaRes_Old$correctDatMat, show_nFeats = F)
# Plot feature correlations
ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = c(seq(-1, 1, 0.1))) +
  labs(y = 'Frequency', title = 'Feature Correlations: New vs Old Proteomics (Corrected)') +
  th
```

**log(FC) between Tumor and Normal samples**
```{r}
# Compute log(FC) and t-statistics between Tumor and Normal tissue samples in two datasets
# Prepare summarized tables of comparison for visualization
# condiFeatAssoTabs_SVs <- summarizeFeatAssoRes(proTissueSVs_New, proTissueSVs_Old,
#                                               'New', 'Old', meta_var = 'Condition',
#                                               subset = NULL, method = 'proDA', alpha = 0.05,
#                                               unwantVar1 = 'SV1', unwantVar2 = 'SV1')
condiFeatAssoTabs_SVs <- readRDS('./data/Discovery/AG_Klingmueller/soaRes/New_vs_Old_condiFeatAsso_SVs_leek.rds')

# Plot log(FC)
ggplot(condiFeatAssoTabs_SVs$tbl_logFC, aes(x=logFC_dat1, y=logFC_dat2, col=Direction)) +
  geom_point(size = 2) +
  ggpubr::stat_cor(data = condiFeatAssoTabs_SVs$tbl_logFC,
                   aes(x=logFC_dat1, y=logFC_dat2, col=NULL,
                       label=paste(..rr.label.., ..p.label.., sep = "~`,`~")),
                   size = 6, show.legend = F) +
  geom_abline(intercept = 0, slope = 1, col = 'black', linewidth = 0.8) +
  scale_color_manual(values = c('red', 'navy', 'grey')) +
  labs(x = 'log(FC) of New data', y = 'log(FC) of Old data',
       title = 'log(FC): Tumor vs Normal (SV-Corrected)') +
  th
```

**p-values (Tumor vs Normal samples, alpha = 0.05)**
```{r}
# Plot p-values
# Compute result consistency
percent <- round(sum(condiFeatAssoTabs_SVs$tbl_pVal$Significance == 'Sig. in Both') /
                   sum(condiFeatAssoTabs_SVs$tbl_pVal$Significance != 'Not Sig.'), 3) * 100

ggplot(condiFeatAssoTabs_SVs$tbl_pVal, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance)) +
  geom_point(size = 2) +
  geom_abline(intercept = 0, slope = 1, col = 'black', linewidth = 0.8) +
  scale_color_manual(values = c('red', 'darkgreen', 'navy', 'grey')) +
  labs(x = '-log10(pVal) of New data', y = '-log10(pVal) of Old data',
       title = 'p-val: Tumor vs Normal (SV-Corrected)') +
  annotate('text', x = 5, y = 30, size = 4,
           label = paste0(percent, '% of significant results consistent')) +
  th
```
=> SV-corrected data does not give rise to better result consistency.
</br>
</br>
</br>
</br>




## AG Krijgsveld
Combine Method Dev and Discovery cohorts

```{r message=F}
# Prepare long data containing original data and needed information
# Discovery
# Load original data
proTissueTab_Discovery <- readr::read_tsv('./data/Discovery/AG_Krijgsveld/20230815_MarcS_Discovery_Tissue.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Sample = stringr::str_remove_all(Sample, '^.+SC_A_|^.+SC_DIS_A_|4\\.raw$'))
# Include summarized metadata
proTissueTab_Discovery <- dplyr::left_join(proTissueTab_Discovery, summMetadat4Krij, by = 'Sample')

# Discovery - Low Tumor Purity
# Load and tidy up original data and include summarized metadata into it
proTissueTab_Discovery_LowTP <- readr::read_tsv('./data/Discovery/AG_Krijgsveld/Discovery_Tissue_Low_Tumor_Content.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Sample = stringr::str_remove_all(Sample, '^.+SC_DIS_A_|3_\\d+\\.raw$|1_\\d+\\.raw$')) %>%
  dplyr::left_join(summMetadat4Krij, by = 'Sample') %>%
  dplyr::mutate(Cohort = paste0(Cohort, '_LTP'))

# MethodDev
# Load and tidy up original data and include summarized metadata into it
summMetadat_Krij <- dplyr::filter(summMetadat, To %in% 'KRIJGSVELD')
proTissueTab_MethodDev <- readr::read_delim('./data/MethodDev/AG_Krijgsveld/20230726_Thorax_Method_Est_tissue.txt') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Aliquot',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Aliquot = stringr::str_remove_all(Aliquot, '\\.raw$')) %>%
  dplyr::left_join(summMetadat_Krij, by = 'Aliquot') %>%
  dplyr::select(-Aliquot)

# Extract common features for combining data
featSpace_Discovery <- unique(proTissueTab_Discovery$Protein.Group)
featSpace_Discovery_LowTP <- unique(proTissueTab_Discovery_LowTP$Protein.Group)
featSpace_MethodDev <- unique(proTissueTab_MethodDev$Protein.Group)
cmnFeats <- intersect(featSpace_Discovery, featSpace_Discovery_LowTP)
cmnFeats <- intersect(cmnFeats, featSpace_MethodDev)
# Filter common features
proTissueTab_Discovery <- dplyr::filter(proTissueTab_Discovery, Protein.Group %in% cmnFeats)
proTissueTab_Discovery_LowTP <- dplyr::filter(proTissueTab_Discovery_LowTP, Protein.Group %in% cmnFeats)
proTissueTab_MethodDev <- dplyr::filter(proTissueTab_MethodDev, Protein.Group %in% cmnFeats)
# Combine data
proTissueTab_Combined <- dplyr::bind_rows(proTissueTab_Discovery,
                                          proTissueTab_Discovery_LowTP,
                                          proTissueTab_MethodDev) %>%
  # Compute sample missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MissLevel = sum(is.na(Abundance)) / length(Abundance)) %>%
  dplyr::ungroup()

# Remove potential bad-quality samples
allProTissueTab <- proTissueTab_Combined
proTissueTab_Combined <- dplyr::filter(proTissueTab_Combined, !Sample %in% c('I0HVOL_TU', '7EAOX7_TU',
                                                                             'PDIR55_NG', 'XFKHGP_NG',
                                                                             '3M0D40_TU', 'MJMTYR_TU'))
```

<font size='4'> **Overview original data** </font>\
4 Tumor samples and 2 Normal sample have been excluded before preprocessing. Check
**Show reasons for removing samples** for more details
```{r}
# Preprocess data
proTissue_Combined <- doPreprocessing(proTissueTab_Combined, feat = 'Protein.Group', smp = 'Sample',
                                      val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                                      smpAnno = c(smpAnno, 'MissLevel'), do_featFilt = T, cutoff = 0.5, viz_miss = T)
                                      # save_path = './data/Discovery/AG_Krijgsveld/combined_proTissue'

# Show dimensions of data
cat('Data dimensions:', dim(proTissue_Combined$ori.data)[2], 'samples and',
    dim(proTissue_Combined$ori.data)[1], 'features')

# Visualize data missingness
proTissue_Combined$ori.data.miss +
  labs(title = 'Missingness of original data') +
  theme(axis.text.x = element_text(size = 5))

# Visualize data distribution
# Convert SE object into long data
longData <- summExp2df(proTissue_Combined$ori.data, row_id = 'Protein.Group', col_id = 'Sample')
# Order samples based on cohorts so that same cohorts are clustered in plot
smpLevels <- dplyr::arrange(longData, Cohort) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  dplyr::pull(Sample)
longData <- dplyr::mutate(longData, Sample = factor(Sample, levels = smpLevels))
ggplot(longData, aes(x=Sample, y=Value, col=Cohort)) +
  geom_boxplot(outlier.size = 0.8) +
  scale_color_brewer(palette = 'Set2') +
  scale_y_log10() +
  labs(y = 'Abundance', title = 'Distribution of original data') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

<font size='4'> **Overview filtered vsn normalized data** </font>\
Features quantified in less than half of samples are removed.
```{r}
# Show dimensions of data
cat('Filtered data dimensions:', dim(proTissue_Combined$filt.data)[2], 'samples and',
    dim(proTissue_Combined$filt.data)[1], 'features')

# Visualize data missingness
proTissue_Combined$filt.data.miss +
  labs(title = 'Missingness of filtered data') +
  theme(axis.text.x = element_text(size = 5))

# Visualize data distribution
# Convert SE object into long data
longData <- summExp2df(proTissue_Combined$vsn.data, row_id = 'Protein.Group', col_id = 'Sample')
# Order samples based on cohorts so that same cohorts are clustered in plot
smpLevels <- dplyr::arrange(longData, Cohort) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  dplyr::pull(Sample)
longData <- dplyr::mutate(longData, Sample = factor(Sample, levels = smpLevels))
ggplot(longData, aes(x=Sample, y=Value, col=Cohort)) +
  geom_boxplot(outlier.size = 0.8) +
  scale_color_brewer(palette = 'Set2') +
  labs(y = 'Log(Abundance)', title = 'Distribution of filtered vsn normalized data') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

# Visualize mean-sd relationship
proTissue_Combined$vsn.feat.mean.var +
  labs(title = 'Feature mean-sd relationship after vsn normalization')
```

<font size='4'> **Do metadata-assisted quality control: Tumor vs Normal samples** </font>\
Note that there exists strong batch effect

**PCA**
```{r}
# Do PCA
pcaRes <- doSOA(proTissue_Combined$vsn.data, meta_var = c('Condition', 'Cohort'),
                pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC1 (28.9%)`, y=`PC2 (24.8%)`, col=Cohort, shape=Condition)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th #+ theme(axis.title = element_text(size = 28),
#              axis.text.x = element_text(size = 24), axis.text.y = element_text(size = 18),
#              legend.title = element_text(size = 26), legend.text = element_text(size = 24))
# ggsave('./output/Discovery/group_meeting/quality_control_beforeBC_combined_proTissue_Krij_condi.png',
#        device = 'png', dpi = 400, height = 8, width = 10)
```

**Hierarchical clustering**
```{r}
# Compute sample euclidean distances using top variable features
abunMat <- assay(proTissue_Combined$vsn.data)
featSDs <- rowSds(abunMat, na.rm = T)
topVarFeats <- names(sort(featSDs, decreasing = T)[1:1000])
abunMatSub <- abunMat[topVarFeats,]
d <- dist(t(abunMatSub), method = 'euclidean')

# Visualize sample distances by heatmap with clustering
colAnno <- dplyr::select(proTissueTab_Combined, Sample, Condition, Cohort) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
pheatmap(as.matrix(d), annotation_col = colAnno, scale = 'row', #row scaling is across columns
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = 'ward.D2', fontsize_col = 4.5,
         annotation_colors = list(Cohort = c(Discovery = 'grey30', Discovery_LTP = 'grey60', MethodDev = 'grey90'),
                                  Condition = c(Tumor = '#d95f02', Normal = '#1b9e77')))
```

<font size='4'> **Do batch correction using limma** </font>\
Batch effect is successfully removed, which supports that existing batch effect is linear.
Batch factor (Cohort) should be included in linear model for statistical analysis.
```{r}
# Perform batch correction to see if cohorts can be merged
# Convert SE object into wide data
datMat <- SummarizedExperiment::assay(proTissue_Combined$vsn.data)
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab <- as_tibble(colData(proTissue_Combined$vsn.data), rownames = 'Sample')
design <- model.matrix(~ Condition + Recurrence + Cohort, data = smpAnnoTab)
wantedDesign <- design[, seq_len(3)]
unwantedDesign <- design[, -seq_len(3)]
# Do batch correction
datMat_BC <- limma::removeBatchEffect(datMat, design = wantedDesign, covariates = unwantedDesign)
proTissueVsn_BC <- proTissue_Combined$vsn.data
assay(proTissueVsn_BC) <- datMat_BC
# Save batch corrected data
# saveRDS(proTissueVsn_BC, './data/Discovery/AG_Krijgsveld/combined_proTissueVsnBC.rds')

# Do PCA
pcaRes_BC <- doSOA(proTissueVsn_BC, meta_var = c('Condition', 'Cohort'),
                   pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes_BC$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes_BC$pcTab %>%
  dplyr::mutate(Label = dplyr::case_when(Sample %in% c('XFKHGP_TU', '1TK71I_TU') ~ Sample))
ggplot(pcTab, aes(x=Condition, y=`PC1 (40.7%)`, col=Condition, fill=Condition, label = Label)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  geom_text_repel(show.legend = F, size = 5) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th #+ theme(axis.title = element_text(size = 28),
#              axis.text.x = element_text(size = 24), axis.text.y = element_text(size = 18),
#              legend.title = element_text(size = 26), legend.text = element_text(size = 24))
# ggsave('./output/Discovery/group_meeting/quality_control_afterBC_combined_proTissue_Krij_condi.png',
#        device = 'png', dpi = 400, height = 8, width = 10)
```

```{r}
# Compute sample euclidean distances using top variable features
abunMat <- assay(proTissueVsn_BC)
featSDs <- rowSds(abunMat, na.rm = T)
topVarFeats <- names(sort(featSDs, decreasing = T)[1:1000])
abunMatSub <- abunMat[topVarFeats,]
d <- dist(t(abunMatSub), method = 'euclidean')

# Visualize sample distances by heatmap with clustering
colAnno <- dplyr::select(proTissueTab_Combined, Sample, Condition, Cohort) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
pheatmap(as.matrix(d), annotation_col = colAnno, scale = 'row', #row scaling is across columns
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = 'ward.D2', fontsize_col = 4.5,
         annotation_colors = list(Cohort = c(Discovery = 'grey30', Discovery_LTP = 'grey60', MethodDev = 'grey90'),
                                  Condition = c(Tumor = '#d95f02', Normal = '#1b9e77')))
```

<font size='4'> **Show reasons for removing samples** </font>\
Samples 'I0HVOL_TU' and '7EAOX7_TU' got decent tumor purity but still got removed
due to misclassification in metadata-assisted quality control and similar molecular
signature as normal samples (Tumor vs Normal, PC1, clustering). Samples '3M0D40_TU'
and 'MJMTYR_TU' are removed due to low tumor purity, misclassification, and barely
following pattern in tumor samples (PC1, clustering). Sample 'PDIR55_NG' and 'XFKHGP_NG'
are removed because they hardly have molecular signatures of normal samples (clustering).

**PCA**
```{r}
# Prepare preprocessed data containing all samples
allProTissueVsn <- doPreprocessing(allProTissueTab, feat = 'Protein.Group', smp = 'Sample',
                                   val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                                   smpAnno = c(smpAnno, 'MissLevel'), do_featFilt = T, cutoff = 0.5)$vsn.data
# Do batch correction
datMat <- SummarizedExperiment::assay(allProTissueVsn)
smpAnnoTab <- as_tibble(colData(allProTissueVsn), rownames = 'Sample')
design <- model.matrix(~ Condition + Recurrence + Cohort, data = smpAnnoTab)
wantedDesign <- design[, seq_len(3)]
unwantedDesign <- design[, -seq_len(3)]
datMat_BC <- limma::removeBatchEffect(datMat, design = wantedDesign, covariates = unwantedDesign)
allProTissueVsn_BC <- allProTissueVsn
assay(allProTissueVsn_BC) <- datMat_BC

# Do PCA
pcaRes_BC <- doSOA(allProTissueVsn_BC, meta_var = c('Condition', 'Cohort'),
                   pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes_BC$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes_BC$pcTab %>%
  dplyr::mutate(Label = dplyr::case_when(Sample %in% c('I0HVOL_TU', 'I0HVOL_NG',
                                                       '7EAOX7_TU', '7EAOX7_NG',
                                                       'XFKHGP_TU', 'XFKHGP_NG',
                                                       'MJMTYR_TU', '1TK71I_TU',
                                                       '3M0D40_TU', 'PDIR55_NG') ~ Sample),
                Label2 = dplyr::case_when(Sample %in% 'HH3U27K2_TG' ~ Sample))
ggplot(pcTab, aes(x=`PC1 (39.9%)`, y=`PC2 (8.9%)`, col=Cohort, shape=Condition, label = Label2)) +
  geom_point(size = 4) +
  geom_text_repel(show.legend = F, size = 5) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th

ggplot(pcTab, aes(x=Condition, y=`PC1 (39.9%)`, col=Condition, fill=Condition, label = Label)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  geom_text_repel(show.legend = F, size = 5) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

# Display tumor purity and missing levels of misclassified samples and potential outlier
dplyr::distinct(allProTissueTab, Sample, .keep_all = T) %>%
  dplyr::select(Sample, TumorPurity, MissLevel) %>%
  dplyr::filter(Sample %in% c('I0HVOL_TU', '7EAOX7_TU', 'XFKHGP_TU', 'MJMTYR_TU',
                              '1TK71I_TU', '3M0D40_TU', 'PDIR55_NG', 'HH3U27K2_TG', 'XFKHGP_NG')) %>%
  as.data.frame()
```
=> Mean of sample tumor cell contents is 67%, ranging from 10% to 100%.\
=> Mean of sample missing levels is 31%, ranging from 21% to 71%.

**Hierarchical clustering**\
Top 100 significant features between Tumor and Normal samples are used, of which
Bad-quality samples were excluded for significance testing. Features (rows) are
ordered by t-statistics.
```{r message=F}
# Check if potential bad-quality Tumor samples get condition-associated molecular
# signature identified in good-quality samples
# Prepare top significant features between Tumor and Normal samples
# subProTissueTab <- dplyr::filter(allProTissueTab, !Cohort %in% 'Discovery_LTP')
# proTissueVsn <- doPreprocessing(subProTissueTab, feat = 'Protein.Group', smp = 'Sample',
#                                 val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
#                                 smpAnno = c(smpAnno, 'MissLevel'), do_featFilt = T, cutoff = 0.5)$vsn.data
# soaRes <- doSOA(proTissueVsn, meta_var = 'Condition', pca_method = 'ppca', num_PCs = 20,
#                 use_proDA = T, unwantVar = 'Cohort', level_metaVar = c('Tumor', 'Normal'))
# saveRDS(soaRes, './data/Discovery/AG_Krijgsveld/soaRes/proTissueRes_rmBadSmps.rds')
soaRes <- readRDS('./data/Discovery/AG_Krijgsveld/soaRes/proTissueRes_rmBadSmps.rds')
topSigFeatIdx <- order(abs(soaRes$featSigAssoRes$Stat), decreasing = T)[1:100]
topSigFeats <- soaRes$featSigAssoRes$Var1[topSigFeatIdx]
# Order top significant features by t-statistics
topSigFeatStats <- soaRes$featSigAssoRes$Stat[topSigFeatIdx]
featOrder <- topSigFeats[order(topSigFeatStats, decreasing = T)]

# Prepare preprocessed abundance matrix of all samples
proTissueVsn <- doPreprocessing(allProTissueTab, feat = 'Protein.Group', smp = 'Sample',
                                val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                                smpAnno = c(smpAnno, 'MissLevel'), do_featFilt = T, cutoff = 0.5)$vsn.data
# Do batch correction
datMat <- SummarizedExperiment::assay(proTissueVsn)
smpAnnoTab <- as_tibble(colData(proTissueVsn), rownames = 'Sample')
design <- model.matrix(~ Condition + Recurrence + Cohort, data = smpAnnoTab)
wantedDesign <- design[, seq_len(3)]
unwantedDesign <- design[, -seq_len(3)]
datMat_BC <- limma::removeBatchEffect(datMat, design = wantedDesign, covariates = unwantedDesign)
# Cluster samples by sample conditions
normalSmpIdx <- grep('_NG' ,colnames(datMat_BC))
smpOrder <- c(colnames(datMat_BC)[-normalSmpIdx], colnames(datMat_BC)[normalSmpIdx])
# Prepare sample annotation table
smpAnnoTab <- dplyr::select(allProTissueTab, Sample, Condition) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
# Color sample groups as same as in PC plots
smpAnnoCols <- list(Condition = c(Normal = '#1B9E77', Tumor = '#D95F02'))

# View molecular signature of all samples
datMatSub_BC <- datMat_BC[featOrder, smpOrder]
pheatmap(datMatSub_BC, scale = 'row', annotation_col = smpAnnoTab, annotation_colors = smpAnnoCols,
         color = colorRampPalette(c('navy', 'white', 'red'))(100), clustering_method = 'ward.D2',
         cluster_rows = F, cluster_cols = F, show_rownames = F, fontsize_col = 5,
         main = 'All samples (170)')

# View molecular signature of bad-quality samples
# Include '1LJXIN_TU' due to quality control result in Klin. data
badSmps <- c(unique(proTissueTab_Discovery_LowTP$Sample), c('I0HVOL_TU', 'I0HVOL_NG',
                                                            '7EAOX7_TU', '7EAOX7_NG',
                                                            'MJMTYR_TU', 'MJMTYR_NG',
                                                            'XFKHGP_TU', 'XFKHGP_NG',
                                                            'HH3U27K2_TG', 'HH3U27K2_NG',
                                                            '1LJXIN_TU', '1LJXIN_NG'))
datMatSub_BC <- datMat_BC[featOrder, badSmps]
pheatmap(datMatSub_BC, scale = 'row', annotation_col = smpAnnoTab, annotation_colors = smpAnnoCols,
         color = colorRampPalette(c('navy', 'white', 'red'))(100), clustering_method = 'ward.D2',
         cluster_rows = F, show_rownames = F,
         main = 'Potential bad-quality samples and corresponding normal samples')
```
