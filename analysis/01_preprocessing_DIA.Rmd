---
title: 'Preprocessing: Discovery lung cancer patient cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: yes
    toc_float: yes
    code_folding: hide
---

<font size='4'> Description: Preprocess Tumor and Plasma DIA Proteomics generated
by Karim Aljakouch from AG Krijgsveld, including data cleansing, filtering, and
normalization (VSN). All needed information was then stored in SummarizedExperiment
objects for further analyses. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_Discovery')
```

Load libraries
```{r load libraries, message=F}
library(readr)
library(readxl)
library(vsn)
library(limma)
library(visdat)
library(ggrepel)
library(SummarizedExperiment)
library(tidyverse)
# Load user-defined functions
source('./code/analysis_pipeline.R')
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

```{r prepare global info, message=F}
# Load sample metadata
smpMetadat <- readxl::read_excel('./data/sample_metadata.xlsx')
colnames(smpMetadat) <- smpMetadat[3,, drop = F]
smpMetadat <- dplyr::slice(smpMetadat, -c(1:3)) %>%
  dplyr::filter(`SMART-CARE cohort identifier` == 'DISCOVERY_COHORT') %>%
  dplyr::select(c(Code, Visit, `Material submitted`, `Date and time of collection or surgery`, Parents)) %>%
  dplyr::rename(Sample = Code, Status = Visit, SmpType = `Material submitted`,
                Date = `Date and time of collection or surgery`, Patient = Parents) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^SC_DIS_S_|^SC_S_|_P'),
                Status = dplyr::case_when(Status == 'PRETHERAPEUTIC' ~ 'Baseline',
                                          Status == 'FOLLOW-UP' ~ 'Follow-up',
                                          Status == 'RECURRENCE' ~ 'Recurrence'),
                SmpType = dplyr::case_when(SmpType == 'EDTA_PLASMA' ~ 'Plasma',
                                           SmpType == 'FRESH_FROZEN_TISSUE' ~ 'Tissue'),
                Date = stringr::str_extract(Date, '\\d+-\\d+'),
                Patient = stringr::str_remove(Patient, '/THRX_SPACE/THRX_DB/')) %>%
  dplyr::arrange(Patient)

# Load patient metadata
patientMetadat <- readxl::read_excel('./data/patient_metadata.xlsx')
colnames(patientMetadat) <- patientMetadat[3,, drop = F]
patientMetadat <- dplyr::slice(patientMetadat, -c(1:3)) %>%
  dplyr::select(-c(Identifier, Diagnosis, Nutrition)) %>%
  dplyr::rename(Patient = Code, Age = `Age at diagnosis`, Stage = `Pathological stage`,
                Smoking = `Smoking status`, Adjuvant = `Adjuvant chemotherapy`) %>%
  dplyr::mutate(Gender = dplyr::case_when(Gender == 'MALE' ~ 'Male',
                                          Gender == 'FEMALE' ~ 'Female'),
                Smoking = dplyr::case_when(Smoking == 'SMOKER' ~ 'Smoker',
                                           Smoking == 'EX-SMOKER' ~ 'Ex-smoker',
                                           Smoking == 'NON-SMOKER' ~ 'Non-smoker'),
                Adjuvant = dplyr::case_when(Adjuvant == 'true' ~ 'True',
                                            Adjuvant == 'false' ~ 'False'),
                Metastasis = dplyr::case_when(Stage == 'IIB' ~ 'Yes',
                                              Stage != 'IIB' ~ 'No'),
                Age = as.numeric(Age))
# Include patient recurrence information
recurPats <- dplyr::filter(smpMetadat, Status == 'Recurrence') %>%
  dplyr::pull(Patient)
patientMetadat <- dplyr::mutate(patientMetadat,
                                Recurrence = dplyr::case_when(Patient %in% recurPats ~ 'Yes',
                                                              !Patient %in% recurPats ~ 'No')) %>%
  dplyr::relocate(Recurrence, .after = Patient)

# List sample annotations to keep in SE objects
smpAnno <- c('Condition', 'Patient', 'Recurrence', 'Gender', 'Age', 'Smoking',
             'Stage', 'Adjuvant', 'Metastasis')
```

# Tissue Proteomics

```{r message=F}
# Load unprocessed data
proTissueTab <- readr::read_tsv('./data/AG_Krijgsveld/20230815_MarcS_Discovery_Tissue.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Sample = stringr::str_remove_all(Sample, '^.+SC_A_|^.+SC_DIS_A_|4\\.raw$'),
                Condition = dplyr::case_when(grepl('_NG', Sample) ~ 'Normal',
                                             grepl('TU', Sample) ~ 'Tumor'),
                Patient = stringr::str_remove(Sample, '_.+$'))
# Include patient metadata
proTissueTab <- dplyr::left_join(proTissueTab, patientMetadat, by = 'Patient')

# Preprocess data
proTissue <- doPreprocessing(proTissueTab, feat = 'Protein.Group', smp = 'Sample',
                             val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                             smpAnno = smpAnno, do_featFilt = T, cutoff = 0.67,
                             viz_miss = T) #save_path = './data/AG_Krijgsveld/proTissue'
```

Show dimensions of original data (86 samples and 7986 features)
```{r}
dim(proTissue$ori.data)
```

Show missingness of original data
```{r}
proTissue$ori.data.miss +
  theme(axis.text.x = element_text(size = 10))
```

Show distribution of original data
```{r}
proTissue$ori.data.dist +
  theme(axis.text.x = element_text(size = 10))
```

Show feature mean-variance relationship of original data
```{r}
proTissue$ori.feat.mean.var +
  scale_y_log10()
```

**Remove features quantified in less than 2/3 of samples**\
Show dimensions of filtered data (86 samples and 5316 features)
```{r}
dim(proTissue$filt.data)
```

Show missingness of filter data
```{r}
proTissue$filt.data.miss +
  theme(axis.text.x = element_text(size = 10))
```

Show distribution of filtered data
```{r}
proTissue$filt.data.dist +
  theme(axis.text.x = element_text(size = 10))
```

**Normalize filtered data by VSN**\
Show distribution of vsn normalized data
```{r}
proTissue$vsn.data.dist +
  theme(axis.text.x = element_text(size = 10))
```

Show feature mean-variance relationship of vsn normalized data
```{r}
proTissue$vsn.feat.mean.var
```

Show data quality
```{r}
# Do single-omics analysis
proTissueSOA <- doSOA(proTissue$vsn.data, meta_var = 'Condition', pca_method = 'ppca',
                      do_onlyPCA = T)
# Prepare labels for samples of interest
pcTab <- proTissueSOA$pcTab %>%
  dplyr::mutate(Label = dplyr::case_when(Sample %in% c('I0HVOL_TU', '7EAOX7_TU',
                                                       'MJMTYR_TU', 'XFKHGP_TU',
                                                       'XFKHGP_NG', 'MJMTYR_NG',
                                                       'I0HVOL_NG', '7EAOX7_NG') ~ Sample))
ggplot(pcTab, aes(x=Condition, y=`PC1 (36.3%)`, col=Condition, fill=Condition, label=Label)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  geom_text_repel(show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(x = 'Sample condition') +
  th
```
=> I0HVOL_TU: 87%, 14mg / 7EAOX7_TU: 70%, 19mg / MJMTYR_TU: 40%, 31mg / XFKHGP_TU: 100%, 4mg\
(Tumor cell contents ranging from 40 - 100%, and Tissue weight from 4 - 54mg)

```{r message=F, eval=F}
# Fix patient recurrence information in Tissue Proteomics from AG Klingm√ºller that
# contains Method Development and part of Discovery cohort samples
# Load normalized data
proTissue_Klin <- readRDS('./data/AG_Klingmueller/proTissueVsn.rds')
# Prepare patient recurrence information for both Method Development and Discovery cohorts
# Retrieve Method Development cohort samples
methodDev_smpMetadat <- readxl::read_excel('./data/sample_metadata.xlsx')
colnames(methodDev_smpMetadat) <- methodDev_smpMetadat[3,, drop = F]
methodDev_smps <- dplyr::slice(methodDev_smpMetadat, -c(1:3)) %>%
  dplyr::filter(`SMART-CARE cohort identifier` == 'METHOD_DEVELOPMENT_COHORT',
                grepl('_TG|_NG', Code)) %>%
  dplyr::pull(Code) %>%
  stringr::str_remove('^SC_T_S_')
# Prepare recurrence information of Method Development cohort patients
proTissueSub <- proTissue_Klin[, colnames(proTissue_Klin) %in% methodDev_smps, drop = F]
methodDev_recurInfo <- tibble::as_tibble(colData(proTissueSub)) %>%
  dplyr::select(Patient, Recurrence) %>%
  dplyr::filter(!duplicated(Patient))
# Prepare recurrence information of Discovery cohort patients
methodDev_pats <- unique(stringr::str_remove(methodDev_smps, '_.+'))
discovery_recurInfo <- dplyr::select(patientMetadat, Patient, Recurrence) %>%
  dplyr::filter(!Patient %in% methodDev_pats)
# Combine all recurrence information
recurInfo <- dplyr::bind_rows(methodDev_recurInfo, discovery_recurInfo)
# Update sample annotations
smpAnno <- tibble::as_tibble(colData(proTissue_Klin), rownames = 'Sample') %>%
  dplyr::select(-Recurrence) %>%
  dplyr::left_join(recurInfo, by = 'Patient') %>%
  dplyr::mutate(Metastasis = dplyr::case_when(Stage == 'IIB' ~ 'Yes',
                                              Stage != 'IIB' ~ 'No')) %>%
  tibble::column_to_rownames('Sample') %>%
  dplyr::relocate(Recurrence, .after = Patient) %>%
  dplyr::relocate(Metastasis, .after = Adjuvant) %>%
  dplyr::relocate(Identifier, .after = Batch)
# Create SE object with updated sample annotations
featAnno <- tibble::as_tibble(rowData(proTissue_Klin), rownames = 'Feature') %>%
  tibble::column_to_rownames('Feature')
proTissue_Klin <- SummarizedExperiment(assays = list(Abundance = assay(proTissue_Klin)),
                                       rowData = featAnno, colData = smpAnno)
# saveRDS(proTissue_Klin, './data/AG_Klingmueller/proTissueVsn.rds')
```




# Plasma Proteomics

```{r message=F}
# Load unprocessed data
proPlasmaTab <- readr::read_tsv('./data/AG_Krijgsveld/20230811_MarcS_Discovery_Plasma.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Sample = stringr::str_remove_all(Sample, '^.+SC_DIS_A_|_4\\.raw$|\\.raw$|^.+KA_|_P'),
                Sample = stringr::str_replace(Sample, 'P_', '_'),
                Sample = stringr::str_remove(Sample, '^SC_A_'),
                Sample = dplyr::case_when(Sample == 'FD01075852' ~ 'R1WTOP_V1',
                                          Sample == 'FD05926483' ~ 'R1WTOP_V2',
                                          Sample == 'FD01282286' ~ 'R1WTOP_V3',
                                          Sample == 'FD07174643' ~ 'R1WTOP_V4',
                                          !Sample %in% c('FD01075852', 'FD05926483',
                                                         'FD01282286', 'FD07174643') ~ Sample),
                Sample = stringr::str_remove_all(Sample, '_FD\\d+|_LV\\d+'),
                Patient = stringr::str_remove(Sample, '_.+$'),
                TimePoint = stringr::str_remove(Sample, '^.+_'),
                TimePoint = factor(TimePoint, levels = paste0('V', seq_along(unique(TimePoint)))))
# Include sample and patient metadata
smpPlasmaMetadat <- dplyr::filter(smpMetadat, SmpType == 'Plasma') %>%
  dplyr::select(Sample, Status, Date) %>%
  dplyr::rename(Condition = Status)
proPlasmaTab <- dplyr::left_join(proPlasmaTab, smpPlasmaMetadat, by = 'Sample')
proPlasmaTab <- dplyr::left_join(proPlasmaTab, patientMetadat, by = 'Patient')

# Preprocess data
proPlasma <- doPreprocessing(proPlasmaTab, feat = 'Protein.Group', smp = 'Sample',
                             val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                             smpAnno = c(smpAnno, 'TimePoint', 'Date'), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T, bins = 20) #save_path = './data/AG_Krijgsveld/proPlasma'
```

Explore statuses and time points of plasma samples
```{r fig.height=10}
# Explore time points of plasma samples
smpPlasmaMetadat %>%
  DT::datatable()
# Visualize time points of plasma samples
ggplot(proPlasmaTab, aes(x=TimePoint, y=Patient)) +
  geom_point(shape = 4, size = 2) +
  labs(x = 'Time point') +
  theme_minimal() +
  theme(axis.title = element_text(size = 12, face = 'bold'),
        axis.text.x = element_text(size = 10))
```

Show dimensions of original data (289 samples and 969 features)
```{r}
dim(proPlasma$ori.data)
```

Show missingness of original data
```{r}
proPlasma$ori.data.miss +
  labs(x = 'Samples') +
  theme(axis.text.x = element_blank(), axis.title = element_text(size = 13, face = 'bold'),
        panel.grid.major.y = element_blank())
```

Show sample mean-variance relationship of original data
```{r}
proPlasma$ori.smp.mean.var
```

Show feature mean-variance relationship of original data
```{r}
proPlasma$ori.feat.mean.var +
  scale_y_log10()
```

**Remove features quantified in less than 2/3 of samples**\
Show dimensions of filtered data (289 samples and 542 features)
```{r}
dim(proPlasma$filt.data)
```

Show missingness of filter data
```{r}
proPlasma$filt.data.miss +
  labs(x = 'Samples') +
  theme(axis.text.x = element_blank(), axis.title = element_text(size = 13, face = 'bold'))
```

**Normalize filtered data by VSN**\
Show sample mean-variance relationship of vsn normalized data
```{r}
proPlasma$vsn.smp.mean.var +
  ylim(2.4, 3.6)
```

Show feature mean-variance relationship of vsn normalized data
```{r}
proPlasma$vsn.feat.mean.var
```
