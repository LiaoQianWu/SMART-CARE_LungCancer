---
title: 'Single-omics analysis: Targeted Metabolomics and DDA Proteomics of Method Development cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Conduct univariate (t-test) and multivariate (PCA)
analyses on individual datasets, i.e., Plasma and Tissue Targeted Metabolomics from
AG Hell and DDA Proteomics from AG Krijgsveld, to have overview of data and take
initial look at data power in terms of predicting patient cancer recurrence. Association
between each feature (metabolite or protein level) and cancer recurrence was tested
by t-test, which captures significant features that can separate recurrence and
non-recurrence patient groups. PCA was performed to view sources of data variance
associated with certain metadata variables. </font>

**Metadata variables**\
Patient (n = 20):\
Recurrence -> Cancer recurrences, Yes:No = 1:1\
Gender -> Male:Female = 13:7\
Age -> Diagnosis ages ranging from 56 to 84\
Smoking -> Smoker:Ex-smoker:Non-Smoker = 3:14:3\
Stage -> Pathological stages, IB:IIA:IIB = 11:8:1\
Adjuvant -> Adjuvant chemotherapy, True:False = 13:7\
Sample (n = 40):\
Condition -> Tissue sample conditions, Tumor:Normal = 1:1\
TimePoint -> Plasma sample collection time points, Baseline:2 years later = 1:1

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F, message = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer')
```

Load libraries
```{r library loading, message = FALSE}
library('SummarizedExperiment')
library('limma')
library('pheatmap')
library('ggrepel')
library('umap')
library('openxlsx')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

Display associations between cancer recurrence and the other patient metadata variables
to identify potential predictors (or confounders)
```{r}
# Test associations between metadata variables
# Prepare sample metadata
metaPlasmaVsn <- readRDS('./data/MethodDev/AG_Hell/metaPlasmaVsn.rds')
patientMetadat <- tibble::as_tibble(colData(metaPlasmaVsn)) %>%
  dplyr::filter(!duplicated(Patient)) %>%
  dplyr::select(Patient, Recurrence, Gender, Age, Smoking, Stage, Adjuvant)
patientRecur <- dplyr::select(patientMetadat, Patient, Recurrence)
patientMetadat <- dplyr::select(patientMetadat, -Recurrence)
testAsso(patientMetadat, patientRecur, cmn_col = 'Patient') %>%
  dplyr::select(-Stat)
```

# Plasma Metabolomics
Based on PCA result obtained by analyzing whole Plasma Metabolomics dataset that
includes Baseline and Follow-up samples, we found that PCA mainly captures source
of variation in time points, the unwanted variation. Besides, we attempt to identify
biomarkers that can predict whether patients WILL experience cancer recurrence or
not. Therefore, we decided to analyze Baseline and Follow-up samples separately.

```{r}
# Load normalized data
metaPlasmaNorm <- readRDS('./data/MethodDev/AG_Hell/metaPlasmaVsn.rds')
# Manually modify time point information
tmp_metadata <- as.data.frame(colData(metaPlasmaNorm)) %>%
  dplyr::mutate(TimePoint = dplyr::case_when(Condition == 'Baseline' ~ 'Baseline',
                                             Condition != 'Baseline' ~ '2 years later'))
colData(metaPlasmaNorm)['TimePoint'] <- tmp_metadata$TimePoint

# Perform analysis
metaPlasmaRes <- doSOA(metaPlasmaNorm, meta_var = 'TimePoint', do_onlyPCA = T)
pcSigAssoRes <- metaPlasmaRes$pcSigAssoRes
pcTab <- metaPlasmaRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Display PCs of interest
pcSigAssoRes
```

PC2 explains quite some variation in data and separates samples by time points.
```{r}
ggplot(pcTab, aes(x=TimePoint, y=`PC2 (16.8%)`, col=TimePoint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  labs(x = 'Sample collection time point', title = 'Plasma metabolomics', color = 'Time Point') +
  th
```

## Baseline samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(metaPlasmaNorm)$Condition == 'Baseline')
metaBase <- metaPlasmaNorm[, smpBaseIdx]

# Display significant associations between PCs and metadata variables
metaBaseAssoRes <- doSOA(metaBase, meta_var = c('Recurrence', 'Gender', 'Age',
                                                'Smoking', 'Stage', 'Adjuvant'),
                         do_onlyPCA = T)
metaBaseAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
differentially abundant entities are identified using limma and features in heatmap
are ordered by their t-statistics.
```{r}
# Perform analysis
metaBaseRes <- doSOA(metaBase, meta_var = 'Recurrence', num_PCfeats = 30, use_limma = T)
datMat <- metaBaseRes$data
smpAnno <- metaBaseRes$smpMetadata
featSigAssoRes <- metaBaseRes$featSigAssoRes
featAssoRes <- metaBaseRes$featAssoRes
pcSigAssoRes <- metaBaseRes$pcSigAssoRes
pcTab <- metaBaseRes$pcTab
pcTopFeatTab <- metaBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', #row scaling is across columns
         main = 'Baseline plasma metabolomics (limma)')
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including all samples
dat <- metaPlasmaRes$data
anno <- metaPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Baseline', 'No_Baseline', 'Yes_Follow-up', 'No_Follow-up')
tpCol = c('firebrick', 'grey50') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::pull(Var1)
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(anno, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel),
                Var1 = factor(Var1, levels = topSigFeats))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Baseline', 'No_Baseline'),
                                                c('Yes_Follow-up', 'No_Follow-up')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Var1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Baseline Plasma Metabolomics')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

PC11 potentially separates recurrence and non-recurrence patients.
```{r}
# PC11
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC11 (2.7%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Baseline plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 7) +
  th
```

Plot molecular signatures captured by PC11 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
There is no single feature that can decently hint if patients will suffer cancer
recurrence or not, which means each of these top features contributes a bit to
explaining variation between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC11$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Baseline plasma metabolomics - PC11')
```

Display top features that build the PC11
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC11
```

Another PC that significantly separates recurrence and non-recurrence patients
```{r}
# PC15
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC15 (1.7%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Baseline plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 7) +
  th

# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC15
```

## Follow-up samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(metaPlasmaNorm)$Condition != 'Baseline')
metaFolo <- metaPlasmaNorm[, smpFoloIdx]

# Display significant associations between PCs and metadata variables
metaFoloAssoRes <- doSOA(metaFolo, meta_var = c('Recurrence', 'Gender', 'Adjuvant'),
                         do_onlyPCA = T)
metaFoloAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaFoloRes <- doSOA(metaFolo, meta_var = 'Recurrence', num_PCfeats = 30, use_limma = T)
datMat <- metaFoloRes$data
smpAnno <- metaFoloRes$smpMetadata
featSigAssoRes <- metaFoloRes$featSigAssoRes
featAssoRes <- metaFoloRes$featAssoRes
pcSigAssoRes <- metaFoloRes$pcSigAssoRes

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Follow-up plasma metabolomics')
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including all samples
dat <- metaPlasmaRes$data
anno <- metaPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Follow-up', 'No_Follow-up', 'Yes_Baseline', 'No_Baseline')
tpCol = c('grey50', 'firebrick') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::pull(Var1)
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(anno, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel),
                Var1 = factor(Var1, levels = topSigFeats))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Follow-up', 'No_Follow-up'),
                                                c('Yes_Baseline', 'No_Baseline')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Var1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Follow-up Plasma Metabolomics')
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

## Changes in time course
Differences between Follow-up and Baseline samples (Follow-up matrix - baseline
matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(metaPlasmaNorm)$Condition == 'Baseline')
metaBase <- metaPlasmaNorm[, smpBaseIdx]
# Subset follow-up samples
smpFoloIdx <- which(colData(metaPlasmaNorm)$Condition != 'Baseline')
metaFolo <- metaPlasmaNorm[, smpFoloIdx]
# Modify sample names for matching two datasets
colnames(metaBase) <- stringr::str_remove(colnames(metaBase), '_B')
colnames(metaFolo) <- stringr::str_remove(colnames(metaFolo), '_R')
# Retrieve data matrix
metaBaseMat <- SummarizedExperiment::assay(metaBase)
metaFoloMat <- SummarizedExperiment::assay(metaFolo)
# Subtract follow-up matrix by baseline matrix
if (identical(colnames(metaBaseMat), colnames(metaFoloMat)) &
    identical(rownames(metaBaseMat), rownames(metaFoloMat))) {
  metaDiffMat <- metaFoloMat - metaBaseMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- as.data.frame(colData(metaBase))
metaDiff <- SummarizedExperiment(assays = metaDiffMat, colData = colAnno)

# Perform analysis
metaPlasmaDiffRes <- doSOA(metaDiff, meta_var = 'Recurrence', num_PCfeats = 30, use_limma = T)
datMat <- metaPlasmaDiffRes$data
smpAnno <- metaPlasmaDiffRes$smpMetadata
featSigAssoRes <- metaPlasmaDiffRes$featSigAssoRes
featAssoRes <- metaPlasmaDiffRes$featAssoRes
pcSigAssoRes <- metaPlasmaDiffRes$pcSigAssoRes
pcTab <- metaPlasmaDiffRes$pcTab
pcTopFeatTab <- metaPlasmaDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Differential plasma metabolomics')
```

Visualize data of top 6 significant features
```{r}
# Visualize data of top 6 significant features
topSigFeats <- featSigAssoRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC17 (1.8%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Differential plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC17
```




# Tissue Metabolomics
Based on PCA result obtained by analyzing whole Tissue Metabolomics dataset that
includes Tumor and Normal samples, we found that PCA mainly captures source of
variation in tissue conditions, which is not of direct interest. In addition,
recurrence-related significant PCs do not work that well, perhaps because Tumor
and Normal samples are noise to each other. Therefore, we decided to analyze Tumor
and Normal samples separately.

```{r}
# Load normalized data
metaTissueNorm <- readRDS('./data/MethodDev/AG_Hell/metaTissueVsn.rds')

# Perform analysis
metaTissueRes <- doSOA(metaTissueNorm, meta_var = c('Recurrence', 'Condition'), do_onlyPCA = T)
pcSigAssoRes <- metaTissueRes$pcSigAssoRes
pcTab <- metaTissueRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variables
(Var2). Note that each patient has two samples that have same recurrence annotations,
so association test results may have additive effects.
```{r}
# Display PCs of interest
pcSigAssoRes
```

PC2 explains quite some variation in data and separates samples by tissue conditions.
```{r}
ggplot(pcTab, aes(x=Condition, y=`PC2 (18.2%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(title = 'Tissue metabolomics') +
  th
```

Visualize recurrence-related significant PCs
```{r}
ggplot(pcTab, aes(x=`PC14 (1.4%)`, y=`PC15 (1.3%)`, col=Recurrence, group=Patient)) +
  geom_point(size = 3) +
  labs(title = 'Tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  th
```

## Tumor Samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(metaTissueNorm)$Condition == 'Tumor')
metaTumor <- metaTissueNorm[, smpTumorIdx]

# Display significant associations between PCs and metadata variables
metaTumorAssoRes <- doSOA(metaTumor, meta_var = c('Recurrence', 'Gender', 'Age',
                                                  'Smoking', 'Stage', 'Adjuvant', 'TumorPurity'),
                         do_onlyPCA = T)
metaTumorAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaTumorRes <- doSOA(metaTumor, meta_var = 'Recurrence', num_PCfeats = 30, use_limma = T)
datMat <- metaTumorRes$data
smpAnno <- metaTumorRes$smpMetadata
featSigAssoRes <- metaTumorRes$featSigAssoRes
featAssoRes <- metaTumorRes$featAssoRes
pcSigAssoRes <- metaTumorRes$pcSigAssoRes
pcTab <- metaTumorRes$pcTab
pcTopFeatTab <- metaTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         fontsize = 18, fontsize_col = 14,
         scale = 'row', main = 'Tumor tissue metabolomics')
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- metaTissueRes$data
smpAnnoTab <- metaTissueRes$smpMetadata
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Tumor', 'No_Tumor', 'Yes_Normal', 'No_Normal')
condiCol = c('grey50', 'firebrick') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::pull(Var1)
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel),
                Var1 = factor(Var1, levels = topSigFeats))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Tumor', 'No_Tumor'), c('Yes_Normal', 'No_Normal')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Var1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Tumor Tissue Metabolomics')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC16 (1.4%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Tumor tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 7, hjust = 0) +
  th

# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC16
```

## Normal samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(metaTissueNorm)$Condition == 'Normal')
metaNormal <- metaTissueNorm[, smpNormalIdx]

# Display significant associations between PCs and metadata variables
metaNormalAssoRes <- doSOA(metaNormal, meta_var = c('Recurrence', 'Gender', 'Age',
                                                    'Smoking', 'Stage', 'Adjuvant'),
                         do_onlyPCA = T)
metaNormalAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaNormalRes <- doSOA(metaNormal, meta_var = 'Recurrence', num_PCfeats = 30, use_limma = T)
datMat <- metaNormalRes$data
smpAnno <- metaNormalRes$smpMetadata
featSigAssoRes <- metaNormalRes$featSigAssoRes
featAssoRes <- metaNormalRes$featAssoRes
pcSigAssoRes <- metaNormalRes$pcSigAssoRes
pcTab <- metaNormalRes$pcTab
pcTopFeatTab <- metaNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap(datMat[featOrder, smpOrder],
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Normal tissue metabolomics')
```

Visualize data of those 4 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- metaTissueRes$data
smpAnnoTab <- metaTissueRes$smpMetadata
# Prepare significant feature table
num_sigFeats <- 4
gpLevel = c('Yes_Normal', 'No_Normal', 'Yes_Tumor', 'No_Tumor')
condiCol = c('firebrick', 'grey50') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::pull(Var1)
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel),
                Var1 = factor(Var1, levels = topSigFeats))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Normal', 'No_Normal'), c('Yes_Tumor', 'No_Tumor')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Var1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Normal Tissue Metabolomics')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# PC6
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC6 (3.8%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Normal tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC6
```




# Tissue Proteomics
As described in Tissue Metabolomics section, we analyzed Tumor and Normal samples
separately.

```{r}
# Load normalized data
proTissueNorm <- readRDS('./data/MethodDev/AG_Krijgsveld/proTissueVsn_DDA.rds')
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(proTissueNorm), rownames = 'PG.Groups')

# Perform analysis
proTissueRes <- doSOA(proTissueNorm, meta_var = c('Recurrence', 'Condition'), do_onlyPCA = T)
pcSigAssoRes <- proTissueRes$pcSigAssoRes
pcTab <- proTissueRes$pcTab

# Display PCs of interest
pcSigAssoRes

ggplot(pcTab, aes(x=Condition, y=`PC1 (41.1%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(title = 'Tissue proteomics') +
  th
```

## Tumor Samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(proTissueNorm)$Condition == 'Tumor')
proTumor <- proTissueNorm[, smpTumorIdx]

# Display significant associations between PCs and metadata variables
proTumorAssoRes <- doSOA(proTumor, meta_var = c('Recurrence', 'Gender', 'Age',
                                                'Smoking', 'Stage', 'Adjuvant', 'TumorPurity'),
                         do_onlyPCA = T)
proTumorAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
proTumorRes <- doSOA(proTumor, meta_var = 'Recurrence', num_PCfeats = 30, use_limma = T)
datMat <- proTumorRes$data
smpAnno <- proTumorRes$smpMetadata
featSigAssoRes <- proTumorRes$featSigAssoRes
featAssoRes <- proTumorRes$featAssoRes
pcSigAssoRes <- proTumorRes$pcSigAssoRes
pcTab <- proTumorRes$pcTab
pcTopFeatTab <- proTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, Gene = plyr::mapvalues(Var1,
                                                                       from = featInfo$PG.Groups,
                                                                       to = featInfo$PG.Genes,
                                                                       warn_missing = F))
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap(datMatSub,
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = F,
         scale = 'row', main = 'Tumor Tissue proteomics')
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- proTissueRes$data
smpAnnoTab <- proTissueRes$smpMetadata
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Tumor', 'No_Tumor', 'Yes_Normal', 'No_Normal')
condiCol = c('grey50', 'firebrick') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, ' (', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Tumor', 'No_Tumor'), c('Yes_Normal', 'No_Normal')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Tumor Tissue Proteomics')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC14 (2.9%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Tumor tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC14, Gene = plyr::mapvalues(Feature,
                                                        from = featInfo$PG.Groups,
                                                        to = featInfo$PG.Genes,
                                                        warn_missing = F))
```

## Normal samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(proTissueNorm)$Condition == 'Normal')
proNormal <- proTissueNorm[, smpNormalIdx]

# Display significant associations between PCs and metadata variables
proNormalAssoRes <- doSOA(proNormal, meta_var = c('Recurrence', 'Gender', 'Age',
                                                  'Smoking', 'Stage', 'Adjuvant'),
                          do_onlyPCA = T)
proNormalAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
proNormalRes <- doSOA(proNormal, meta_var = 'Recurrence', num_PCfeats = 30, use_limma = T)
datMat <- proNormalRes$data
smpAnno <- proNormalRes$smpMetadata
featSigAssoRes <- proNormalRes$featSigAssoRes
featAssoRes <- proNormalRes$featAssoRes
pcSigAssoRes <- proNormalRes$pcSigAssoRes
pcTab <- proNormalRes$pcTab
pcTopFeatTab <- proNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, Gene = plyr::mapvalues(Var1,
                                                                       from = featInfo$PG.Groups,
                                                                       to = featInfo$PG.Genes,
                                                                       warn_missing = F)) %>%
  dplyr::select(-Test)
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap(datMatSub,
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = F,
         scale = 'row', main = 'Normal tissue proteomics')
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- proTissueRes$data
smpAnnoTab <- proTissueRes$smpMetadata
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Normal', 'No_Normal', 'Yes_Tumor', 'No_Tumor')
condiCol = c('firebrick', 'grey50') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, ' (', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Normal', 'No_Normal'), c('Yes_Tumor', 'No_Tumor')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Normal Tissue Proteomics')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC4 (6.3%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Normal tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC4, Gene = plyr::mapvalues(Feature,
                                                       from = featInfo$PG.Groups,
                                                       to = featInfo$PG.Genes,
                                                       warn_missing = F))
```




# Plasma Proteomics
As described in Plasma Metabolomics section, we analyzed Baseline and Follow-up
samples separately.

```{r}
# Load normalized data
proPlasmaNorm <- readRDS('./data/MethodDev/AG_Krijgsveld/proPlasmaVsn_DDA.rds')
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(proPlasmaNorm), rownames = 'PG.Groups')
# Manually modify metadata time point information
tmp_metadata <- as.data.frame(colData(proPlasmaNorm)) %>%
  dplyr::mutate(TimePoint = dplyr::case_when(Condition == 'Baseline' ~ 'Baseline',
                                             Condition != 'Baseline' ~ '2 years later'))
colData(proPlasmaNorm)['TimePoint'] <- tmp_metadata$TimePoint

# Perform analysis
proPlasmaRes <- doSOA(proPlasmaNorm, meta_var = 'TimePoint', do_onlyPCA = T)
pcSigAssoRes <- proPlasmaRes$pcSigAssoRes

# Display PCs of interest
# pcSigAssoRes
```

## Baseline samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(proPlasmaNorm)$Condition == 'Baseline')
proBase <- proPlasmaNorm[, smpBaseIdx]

# Display significant associations between PCs and metadata variables
proBaseAssoRes <- doSOA(proBase, meta_var = c('Recurrence', 'Gender', 'Age',
                                              'Smoking', 'Stage', 'Adjuvant'),
                        do_onlyPCA = T)
proBaseAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
proBaseRes <- doSOA(proBase, meta_var = 'Recurrence', num_PCfeats = 30, use_limma = T)
datMat <- proBaseRes$data
smpAnno <- proBaseRes$smpMetadata
featSigAssoRes <- proBaseRes$featSigAssoRes
featAssoRes <- proBaseRes$featAssoRes
pcSigAssoRes <- proBaseRes$pcSigAssoRes
pcTab <- proBaseRes$pcTab
pcTopFeatTab <- proBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, Gene = plyr::mapvalues(Var1,
                                                                       from = featInfo$PG.Groups,
                                                                       to = featInfo$PG.Genes,
                                                                       warn_missing = F)) %>%
  dplyr::select(-Test)
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap(datMatSub,
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Baseline plasma proteomics')
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including all samples
dat <- proPlasmaRes$data
anno <- proPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Baseline', 'No_Baseline', 'Yes_Follow-up', 'No_Follow-up')
tpCol = c('firebrick', 'grey50') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(anno, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Baseline', 'No_Baseline'),
                                                c('Yes_Follow-up', 'No_Follow-up')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Baseline Plasma Proteomics')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# PC11
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC11 (3.8%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Baseline plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC11, Gene = plyr::mapvalues(Feature,
                                                        from = featInfo$PG.Groups,
                                                        to = featInfo$PG.Genes,
                                                        warn_missing = F))

# PC13
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC13 (2.8%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Baseline plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC13, Gene = plyr::mapvalues(Feature,
                                                        from = featInfo$PG.Groups,
                                                        to = featInfo$PG.Genes,
                                                        warn_missing = F))
```

## Follow-up samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(proPlasmaNorm)$Condition != 'Baseline')
proFolo <- proPlasmaNorm[, smpFoloIdx]

# Display significant associations between PCs and metadata variables
proFoloAssoRes <- doSOA(proFolo, meta_var = c('Recurrence', 'Gender', 'Adjuvant'),
                        do_onlyPCA = T)
proFoloAssoRes$pcSigAssoRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
proFoloRes <- doSOA(proFolo, meta_var = 'Recurrence', num_PCfeats = 30, use_limma = T)
datMat <- proFoloRes$data
smpAnno <- proFoloRes$smpMetadata
featSigAssoRes <- proFoloRes$featSigAssoRes
featAssoRes <- proFoloRes$featAssoRes
pcSigAssoRes <- proFoloRes$pcSigAssoRes
pcTab <- proFoloRes$pcTab
pcTopFeatTab <- proFoloRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence patients
featSigAssoRes <- dplyr::mutate(featSigAssoRes, Gene = plyr::mapvalues(Var1,
                                                                       from = featInfo$PG.Groups,
                                                                       to = featInfo$PG.Genes,
                                                                       warn_missing = F))
featSigAssoRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(featSigAssoRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap(datMatSub,
         annotation_col = smpRecur,
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_rows = F, cluster_cols = F, show_rownames = T,
         scale = 'row', main = 'Follow-up plasma proteomics')
```

Visualize data of top 6 significant features (ns: p > 0.05, $*$: p <= 0.05, $**$: p <= 0.01,
$***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including all samples
dat <- proPlasmaRes$data
anno <- proPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
num_sigFeats <- 6
gpLevel = c('Yes_Follow-up', 'No_Follow-up', 'Yes_Baseline', 'No_Baseline')
tpCol = c('grey50', 'firebrick') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoRes[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(anno, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Follow-up', 'No_Follow-up'),
                                                c('Yes_Baseline', 'No_Baseline')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
p <- featAssoRes$pVal
hist(p, xlab = 'P-value', main = 'Follow-up Plasma Proteomics')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
pcSigAssoRes
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=`PC9 (3.8%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  labs(title = 'Follow-up plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC9, Gene = plyr::mapvalues(Feature,
                                                       from = featInfo$PG.Groups,
                                                       to = featInfo$PG.Genes,
                                                       warn_missing = F))
```




# Summary

Display proportion of significant features in each dataset in terms of separating
cancer recurrence and non-recurrence patient groups. Plasma and Tissue Metabolomics
has 630 features, Plasma Proteomics has 435 features, and Tissue Proteomics has
5193 features. Alpha was set to 0.05 and numbers after bars indicate feature sizes.
Note that results were not corrected through any p-value adjustment method and linear
models accounted only for recurrence, so there may be abundant false positives.
```{r}
# Barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats <- nrow(metaBaseRes$featSigAssoRes) / nrow(metaBaseRes$data) * 100
metaFoloSigFeats <- nrow(metaFoloRes$featSigAssoRes) / nrow(metaFoloRes$data) * 100
proBaseSigFeats <- nrow(proBaseRes$featSigAssoRes) / nrow(proBaseRes$data) * 100
proFoloSigFeats <- nrow(proFoloRes$featSigAssoRes) / nrow(proFoloRes$data) * 100
metaTumorSigFeats <- nrow(metaTumorRes$featSigAssoRes) / nrow(metaTumorRes$data) * 100
metaNormalSigFeats <- nrow(metaNormalRes$featSigAssoRes) / nrow(metaNormalRes$data) * 100
proTumorSigFeats <- nrow(proTumorRes$featSigAssoRes) / nrow(proTumorRes$data) * 100
proNormalSigFeats <- nrow(proNormalRes$featSigAssoRes) / nrow(proNormalRes$data) * 100

# Prepare needed information for barplot
dat <- rev(c('Baseline Plasma Metabolomics', 'Follow-up Plasma Metabolomics',
             'Baseline Plasma Proteomics', 'Follow-up Plasma Proteomics',
             'Tumor Tissue Metabolomics', 'Normal Tissue Metabolomics',
             'Tumor Tissue Proteomics', 'Normal Tissue Proteomics'))
datModal <- rev(c(rep('Plasma Metabolomics', 2), rep('Plasma Proteomics', 2),
                  rep('Tissue Metabolomics', 2), rep('Tissue Proteomics', 2)))
proportion <- rev(c(metaBaseSigFeats, metaFoloSigFeats,
                    proBaseSigFeats, proFoloSigFeats,
                    metaTumorSigFeats, metaNormalSigFeats,
                    proTumorSigFeats, proNormalSigFeats))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = dat),
                             Data_modality = datModal,
                             Proportion = proportion)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill=Data_modality)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  labs(y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Data modality') +
  th + theme(title = element_text(size = 11))
```
1. All sorts of datasets in this script provide information for predicting patient
cancer recurrence and the PCA models built on them have more or less similar performance.\
2. Overall, Plasma datasets got higher proportions of recurrence-related features
than Tissue when they have the same feature list (Metabolomics) or even Tissue have
much larger feature space (Proteomics). Hence, Plasma samples seem to be more informative
and Tissue samples are more noisy. Yet, since Targeted and DDA methods are biased
(and sample size is very small), these hypotheses have to be validated by unbiased
methods, like Untargeted (please check analysis results of the data from AG Hopf)
and DIA.
<br/>
<br/>

Visualize Recurrence-related features through volcano plots. Log2-FC (up and down)
is recurrence to non-recurrence groups. To be clearer, entities on up side are more
abundant in recurrence group than non-recurrence group, and so forth.
```{r message = F}
# Prepare protein-gene table for annotations
proPlasmaFeatInfo <- tibble::as_tibble(rowData(proPlasmaNorm), rownames = 'PG.Groups')
proTissueFeatInfo <- tibble::as_tibble(rowData(proTissueNorm), rownames = 'PG.Groups')

# Compute log2(FC)
# PM
metaPlasmaMedi <- readRDS('./data/MethodDev/AG_Hell/metaPlasmaMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPM
metaBaseLogFC <- dplyr::filter(metaPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPM
metaFoloLogFC <- dplyr::filter(metaPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TM
metaTissueMedi <- readRDS('./data/MethodDev/AG_Hell/metaTissueMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTM
metaTumorLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTM
metaNormalLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# PP
proPlasmaMedi <- readRDS('./data/MethodDev/AG_Krijgsveld/proPlasmaMedi_DDA.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPP
proBaseLogFC <- dplyr::filter(proPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPP
proFoloLogFC <- dplyr::filter(proPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TP
proTissueMedi <- readRDS('./data/MethodDev/AG_Krijgsveld/proTissueMedi_DDA.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTP
proTumorLogFC <- dplyr::filter(proTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTP
proNormalLogFC <- dplyr::filter(proTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# Collect all needed information for volcano plots
# BPM
metaBaseVolTab <- dplyr::select(metaBaseRes$featAssoRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaBaseLogFC, by = 'Feature')
# FPM
metaFoloVolTab <- dplyr::select(metaFoloRes$featAssoRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaFoloLogFC, by = 'Feature')
# TTM
metaTumorVolTab <- dplyr::select(metaTumorRes$featAssoRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaTumorLogFC, by = 'Feature')
# NTM
metaNormalVolTab <- dplyr::select(metaNormalRes$featAssoRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaNormalLogFC, by = 'Feature')
# BPP
proBaseVolTab <- dplyr::select(proBaseRes$featAssoRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proBaseLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proPlasmaFeatInfo$PG.Groups,
                                       to = proPlasmaFeatInfo$PG.Genes,
                                       warn_missing = F))
# FPP
proFoloVolTab <- dplyr::select(proFoloRes$featAssoRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proFoloLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proPlasmaFeatInfo$PG.Groups,
                                       to = proPlasmaFeatInfo$PG.Genes,
                                       warn_missing = F))
# TTP
proTumorVolTab <- dplyr::select(proTumorRes$featAssoRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proTumorLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proTissueFeatInfo$PG.Groups,
                                       to = proTissueFeatInfo$PG.Genes,
                                       warn_missing = F))
# NTP
proNormalVolTab <- dplyr::select(proNormalRes$featAssoRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proNormalLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proTissueFeatInfo$PG.Groups,
                                       to = proTissueFeatInfo$PG.Genes,
                                       warn_missing = F))
```

Log2-FC cutoffs are 0.55 (FC=1.46) and -0.55 (FC=0.68).
```{r}
# BPM
volTab <- metaBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.55] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.55] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Feature[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.55, 0.55), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Metabolomics') +
  th
```

Log2-FC cutoffs are 0.6 (FC=1.52) and -0.6 (FC=0.66).
```{r}
# FPM
volTab <- metaFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.6] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.6] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Feature[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.6, 0.6), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Metabolomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# TTM
volTab <- metaTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Feature[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 5, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Metabolomics') +
  th + theme(axis.title = element_text(size = 26), axis.text = element_text(size = 20),
             legend.title = element_text(size = 22), legend.text = element_text(size = 22)) +
  scale_x_continuous(breaks = c(-4, -3, -2, -1, 0, 1, 2, 3))
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# NTM
volTab <- metaNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Feature[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Metabolomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# BPP
volTab <- proBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Proteomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# FPP
volTab <- proFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Proteomics') +
  th
```

Log2-FC cutoffs are 0.8 (FC=1.74) and -0.8 (FC=0.57).
```{r}
# TTP
volTab <- proTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.8] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.8] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.8, 0.8), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Proteomics') +
  th
```

Log2-FC cutoffs are 0.7 (FC=1.62) and -0.7 (FC=0.62).
```{r}
# NTP
volTab <- proNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Proteomics') +
  th
```

```{r eval=F}
# Generate feature association test result tables
# Crude functions
stats_recur <- function(se, seMedi, smpType) {
  if (smpType == 'Plasma') {
    # Extract needed information from median normalized SE object
    seMedi <- summExp2df(seMedi, assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
      dplyr::select(Feature, Value, Condition, Recurrence) %>%
      dplyr::mutate(Condition = dplyr::case_when(Condition == 'Baseline' ~ 'Baseline',
                                                 Condition != 'Baseline' ~ 'Follow-up'))
    # Baseline samples
    # Compute log2(FC)
    baseLogFC <- dplyr::filter(seMedi, Condition == 'Baseline') %>%
      dplyr::group_by(Feature, Recurrence) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Yes - No,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    # Conduct association test
    base <- se[, which(colData(se)$Condition == 'Baseline')]
    baseRes <- doSOA(base, meta_var = 'Recurrence', use_limma = T)
    baseFeatAsso <- baseRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (limma)` = Stat) %>%
      # Merge results
      dplyr::left_join(baseLogFC, by = 'Feature')
    # Follow-up samples
    foloLogFC <- dplyr::filter(seMedi, Condition != 'Baseline') %>%
      dplyr::group_by(Feature, Recurrence) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Yes - No,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    folo <- se[, which(colData(se)$Condition != 'Baseline')]
    foloRes <- doSOA(folo, meta_var = 'Recurrence', use_limma = T)
    foloFeatAsso <- foloRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (limma)` = Stat) %>%
      dplyr::left_join(foloLogFC, by = 'Feature')
    tumorFeatAsso <- NULL
    normalFeatAsso <- NULL
  } else if (smpType == 'Tissue') {
    seMedi <- summExp2df(seMedi, assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
      dplyr::select(Feature, Value, Condition, Recurrence)
    # Tumor samples
    tumorLogFC <- dplyr::filter(seMedi, Condition == 'Tumor') %>%
      dplyr::group_by(Feature, Recurrence) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Yes - No,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    tumor <- se[, which(colData(se)$Condition == 'Tumor')]
    tumorRes <- doSOA(tumor, meta_var = 'Recurrence', use_limma = T)
    tumorFeatAsso <- tumorRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (limma)` = Stat) %>%
      dplyr::left_join(tumorLogFC, by = 'Feature')
    # Normal samples
    normalLogFC <- dplyr::filter(seMedi, Condition == 'Normal') %>%
      dplyr::group_by(Feature, Recurrence) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Yes - No,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    normal <- se[, which(colData(se)$Condition == 'Normal')]
    normalRes <- doSOA(normal, meta_var = 'Recurrence', use_limma = T)
    normalFeatAsso <- normalRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (limma)` = Stat) %>%
      dplyr::left_join(normalLogFC, by = 'Feature')
    baseFeatAsso <- NULL
    foloFeatAsso <- NULL
  }
  return(list(baseFeatAsso = baseFeatAsso, foloFeatAsso = foloFeatAsso,
              tumorFeatAsso = tumorFeatAsso, normalFeatAsso = normalFeatAsso))
}

stats_condi <- function(se, seMedi, smpType) {
  if (smpType == 'Plasma') {
    # Extract needed information from median normalized SE object
    seMedi <- summExp2df(seMedi, assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
      dplyr::select(Feature, Value, Condition, Recurrence) %>%
      dplyr::mutate(Condition = dplyr::case_when(Condition == 'Baseline' ~ 'Baseline',
                                                 Condition != 'Baseline' ~ 'Follow-up'))
    # Recurrence samples
    # Compute log2(FC)
    recurrenceLogFC <- dplyr::filter(seMedi, Recurrence == 'Yes') %>%
      dplyr::group_by(Feature, Condition) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Condition', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = `Follow-up` - Baseline,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    # Conduct association test
    recurrence <- se[, which(colData(se)$Recurrence == 'Yes')]
    recurrenceRes <- doSOA(recurrence, meta_var = 'Condition', use_limma = T)
    recurrenceFeatAsso <- recurrenceRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (limma)` = Stat) %>%
      # Merge results
      dplyr::left_join(recurrenceLogFC, by = 'Feature')
    # Non-recurrence samples
    nonrecurLogFC <- dplyr::filter(seMedi, Recurrence == 'No') %>%
      dplyr::group_by(Feature, Condition) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Condition', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = `Follow-up` - Baseline,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    nonrecur <- se[, which(colData(se)$Recurrence == 'No')]
    nonrecurRes <- doSOA(nonrecur, meta_var = 'Condition', use_limma = T)
    nonrecurFeatAsso <- nonrecurRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (limma)` = Stat) %>%
      dplyr::left_join(nonrecurLogFC, by = 'Feature')
  } else if (smpType == 'Tissue') {
    seMedi <- summExp2df(seMedi, assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
      dplyr::select(Feature, Value, Condition, Recurrence)
    # Recurrence samples
    recurrenceLogFC <- dplyr::filter(seMedi, Recurrence == 'Yes') %>%
      dplyr::group_by(Feature, Condition) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Condition', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Tumor - Normal,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    recurrence <- se[, which(colData(se)$Recurrence == 'Yes')]
    recurrenceRes <- doSOA(recurrence, meta_var = 'Condition', use_limma = T)
    recurrenceFeatAsso <- recurrenceRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (limma)` = Stat) %>%
      dplyr::left_join(recurrenceLogFC, by = 'Feature')
    # Non-recurrence samples
    nonrecurLogFC <- dplyr::filter(seMedi, Recurrence == 'No') %>%
      dplyr::group_by(Feature, Condition) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Condition', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Tumor - Normal,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    nonrecur <- se[, which(colData(se)$Recurrence == 'No')]
    nonrecurRes <- doSOA(nonrecur, meta_var = 'Condition', use_limma = T)
    nonrecurFeatAsso <- nonrecurRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (limma)` = Stat) %>%
      dplyr::left_join(nonrecurLogFC, by = 'Feature')
  }
  return(list(recurrenceFeatAsso = recurrenceFeatAsso, nonrecurFeatAsso = nonrecurFeatAsso))
}


# Load preprocessed data
metaPlasma <- readRDS('./data/MethodDev/AG_Hell/metaPlasmaVsn.rds')
metaPlasmaMedi <- readRDS('./data/MethodDev/AG_Hell/metaPlasmaMedi.rds')
metaTissue <- readRDS('./data/MethodDev/AG_Hell/metaTissueVsn.rds')
metaTissueMedi <- readRDS('./data/MethodDev/AG_Hell/metaTissueMedi.rds')
# Generate feature association test result tables
targ.plasma.meta_recur <- stats_recur(metaPlasma, metaPlasmaMedi, 'Plasma')
targ.tissue.meta_recur <- stats_recur(metaTissue, metaTissueMedi, 'Tissue')
targ.plasma.meta_condi <- stats_condi(metaPlasma, metaPlasmaMedi, 'Plasma')
targ.tissue.meta_condi <- stats_condi(metaTissue, metaTissueMedi, 'Tissue')

# Store tables in a list for exporting them as an Excel file
featAssoSheets <- list(Recur_Targ.Base.Plasma.Metab = targ.plasma.meta_recur$baseFeatAsso,
                       Recur_Targ.FoloUp.Plasma.Metab = targ.plasma.meta_recur$foloFeatAsso,
                       Recur_Targ.Tumor.Tissue.Metab = targ.tissue.meta_recur$tumorFeatAsso,
                       Recur_Targ.Normal.Tissue.Metab = targ.tissue.meta_recur$normalFeatAsso,
                       SmpTime_Targ.Recur.Plasma.Metab = targ.plasma.meta_condi$recurrenceFeatAsso,
                       SmpTime_Targ.NonRe.Plasma.Metab = targ.plasma.meta_condi$nonrecurFeatAsso,
                       SmpType_Targ.Recur.Tissue.Metab = targ.tissue.meta_condi$recurrenceFeatAsso,
                       SmpType_Targ.NonRe.Tissue.Metab = targ.tissue.meta_condi$nonrecurFeatAsso)
openxlsx::write.xlsx(featAssoSheets, file = './data/MethodDev/stats/featAsso/Target_Metab.xlsx')
```




```{r umap-proPlasma, include = F, eval = F}
# UMAP
# UMAP (non-linear method) was performed to see separation of Plasma samples.

## Plasma Proteomics

# UMAP

# Run UMAP to see non-linear relationships between plasma samples
# Plasma proteomics
resUMAP <- umap(t(assay(proPlasmaNorm)))
embedding <- tibble::as_tibble(resUMAP$layout, rownames = 'Sample') %>%
  dplyr::left_join(as_tibble(colData(proPlasmaNorm)), by = 'Sample') %>%
  dplyr::select(-Sample_IDs) %>%
  dplyr::rename(UMAP1 = V1, UMAP2 = V2)
ggplot(embedding, aes(x=UMAP1, y=UMAP2, col=Condition, group=Patient)) +
  geom_point() +
  geom_line(col = 'grey50', linetype = 'dashed') +
  ggtitle('Plasma Proteomics') + theme(plot.title = element_text(hjust = 0.5))
```

```{r pca-proPlasma, include = F, eval = F}
# PCA results for comparisons

# PCA
# Plasma proteomics
exprMat <- assay(proPlasmaNorm)
resPC <- prcomp(t(exprMat), center = T, scale. = F)
proPlasmaNorm4Plot <- as_tibble(resPC$x[, 1:10], rownames = 'Sample') %>%
  dplyr::left_join(as_tibble(colData(proPlasmaNorm)), by = 'Sample')
ggplot(proPlasmaNorm4Plot, aes(x=PC1, y=PC2, col=Condition, group=Patient)) +
  geom_point() +
  geom_line(col = 'grey50', linetype = 'dashed') +
  ggtitle('Plasma Proteomics') +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r umap-metaPlasma, include = F, eval = F}
## Plasma Metabolomics

# UMAP

# Plasma metabolomics
resUMAP <- umap(t(assay(metaPlasmaNorm)))
embedding <- tibble::as_tibble(resUMAP$layout, rownames = 'Sample') %>%
  dplyr::left_join(as_tibble(colData(metaPlasmaNorm), rownames = 'Sample'),
                   by = 'Sample') %>%
  dplyr::rename(UMAP1 = V1, UMAP2 = V2)
ggplot(embedding, aes(x=UMAP1, y=UMAP2, col=Condition, group=Patient)) +
  geom_point() +
  geom_line(col = 'grey50', linetype = 'dashed') +
  ggtitle('Plasma Metabolomics') + theme(plot.title = element_text(hjust = 0.5))
```

```{r pca-metaPlasma, include = F, eval = F}
# PCA results for comparisons

# Plasma metabolomics
exprMat <- assay(metaPlasmaNorm)
sd <- rowSds(exprMat)
# exprMatSub <- exprMat[order(sd, decreasing = TRUE)[1:100],]
resPC <- prcomp(t(exprMat), center = T, scale. = F)
metaPlasmaNorm4Plot <- as_tibble(resPC$x[,1:10], rownames = 'Sample') %>%
  left_join(as_tibble(colData(metaPlasmaNorm), rownames = 'Sample'), by = 'Sample')
ggplot(metaPlasmaNorm4Plot, aes(x=PC1, y=PC2, col=Condition, group=Patient)) +
  geom_point() +
  geom_line(col = 'grey50', linetype = 'dashed') +
  ggtitle('Plasma Metabolomics') +
  theme(plot.title = element_text(hjust = 0.5))
```
