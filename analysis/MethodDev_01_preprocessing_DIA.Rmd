---
title: 'Preprocessing: DIA Proteomics of Method Development cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: yes
    toc_float: yes
    code_folding: hide
---

<font size='4'> Description: Preprocess Tissue and Plasma DIA Proteomics generated
by Karim Aljakouch from AG Krijgsveld and Tissue DIA Proteomics from AG Klingmüller,
including data cleansing, filtering, and normalization (VSN). All needed information
was then stored in SummarizedExperiment objects for further analyses. Note that
there are two Tissue and two Plasma DIA Proteomics generated by AG Krijgsveld, and
concentration is suggested on new ones owing to some technical problems and missing
samples with old ones. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer')
```

Load libraries
```{r library loading, message = FALSE}
library('readr')
library('readxl')
library('vsn')
library('visdat')
library('ggrepel')
library('SummarizedExperiment')
library('tidyverse')
# Load user-defined functions
source('./code/analysis_pipeline.R')
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

```{r prepare global info, message=F}
# Load sample metadata
smpMetadat <- readxl::read_excel('./data/sample_metadata.xlsx')
colnames(smpMetadat) <- smpMetadat[3,, drop = F]
smpMetadat <- dplyr::slice(smpMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Parents, Visit, `Material submitted`, `Date and time of collection or surgery`,
                  `SMART-CARE cohort identifier`)) %>%
  dplyr::rename(Sample = Code, Patient = Parents, TimePoint = Visit, SmpType = `Material submitted`,
                Date = `Date and time of collection or surgery`, Cohort = `SMART-CARE cohort identifier`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^SC_T_S_|^SC_DIS_S_|^SC_S_|_P'),
                Patient = stringr::str_remove(Patient, '^/THRX_SPACE/THRX_DB/'),
                TimePoint = dplyr::case_when(TimePoint == 'PRETHERAPEUTIC' ~ 'Baseline',
                                             TimePoint == 'FOLLOW-UP' ~ 'Follow-up',
                                             TimePoint == 'RECURRENCE' ~ 'Recurrence'),
                SmpType = dplyr::case_when(SmpType == 'EDTA_PLASMA' ~ 'Plasma',
                                           SmpType == 'FRESH_FROZEN_TISSUE' ~ 'Tissue'),
                Condition = dplyr::case_when(grepl('_TU|TG', Sample) ~ 'Tumor',
                                             grepl('_NG', Sample) ~ 'Normal',
                                             !grepl('_TU|_NG', Sample) ~ TimePoint),
                Date = stringr::str_extract(Date, '^\\d+-\\d+-\\d+'),
                Cohort = dplyr::case_when(Cohort == 'DISCOVERY_COHORT' ~ 'Discovery',
                                          Cohort == 'METHOD_DEVELOPMENT_COHORT' ~ 'MethodDev'),
                Date = as.Date(Date, format = '%Y-%m-%d'))

# Load patient metadata
patientMetadat <- readxl::read_excel('./data/patient_metadata.xlsx')
colnames(patientMetadat) <- patientMetadat[3,, drop = F]
patientMetadat <- dplyr::slice(patientMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Gender, `Age at diagnosis`, `Pathological stage`, `Smoking status`,
                  `Adjuvant chemotherapy`,)) %>%
  dplyr::rename(Patient = Code, Age = `Age at diagnosis`, Stage = `Pathological stage`,
                Smoking = `Smoking status`, Adjuvant = `Adjuvant chemotherapy`) %>%
  dplyr::mutate(Gender = dplyr::case_when(Gender == 'MALE' ~ 'Male',
                                          Gender == 'FEMALE' ~ 'Female'),
                Smoking = dplyr::case_when(Smoking == 'SMOKER' ~ 'Smoker',
                                           Smoking == 'EX-SMOKER' ~ 'Ex-smoker',
                                           Smoking == 'NON-SMOKER' ~ 'Non-smoker'),
                Adjuvant = dplyr::case_when(Adjuvant == 'true' ~ 'True',
                                            Adjuvant == 'false' ~ 'False'),
                Age = as.numeric(Age))
# Include patient recurrence information in patient metadata
recurPats <- dplyr::filter(smpMetadat, TimePoint == 'Recurrence') %>%
  dplyr::pull(Patient)
patientMetadat <- dplyr::mutate(patientMetadat, Recurrence = dplyr::case_when(Patient %in% recurPats ~ 'Yes',
                                                                              !Patient %in% recurPats ~ 'No'))

# Load aliquot metadata
aliquotMetadat <- readxl::read_excel('./data/aliquot_metadata.xlsx')
colnames(aliquotMetadat) <- aliquotMetadat[3,, drop = F]
aliquotMetadat <- dplyr::slice(aliquotMetadat, -c(1:3)) %>%
  dplyr::select(Code, Parents, `Tumor Cell Content (%)`, `Cohort Identifier`, `Submission to`,
                `Delivered?`) %>%
  dplyr::rename(Aliquot = Code, Sample = Parents, TumorPurity = `Tumor Cell Content (%)`,
                Cohort = `Cohort Identifier`, To = `Submission to`, Delivered = `Delivered?`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^/THRX_SPACE/THRX_DB/SC_T_S_|_P'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_'),
                Cohort = dplyr::case_when(Cohort == 'method establishment' ~ 'MethodDev',
                                          Cohort == 'DISCOVERY_COHORT' ~ 'Discovery'),
                TumorPurity = as.numeric(TumorPurity)) %>%
  dplyr::filter(To %in% c('KRIJGSVELD', 'KLINGMUELLER'))
# Prepare aliquot metadata containing tumor purity information
tumorPurityInfo <- dplyr::select(aliquotMetadat, Aliquot, Sample, TumorPurity)

# Combine all needed metadata
summMetadat <- dplyr::left_join(tumorPurityInfo, smpMetadat, by = 'Sample') %>%
  dplyr::left_join(patientMetadat, by = 'Patient')

# List sample annotations to keep in SE objects
smpAnno <- c('Patient', 'SmpType', 'TimePoint', 'Date', 'Cohort', 'Condition',
             'Recurrence', 'Gender', 'Age', 'Smoking', 'Stage', 'Adjuvant')
```

# Tissue Proteomics (AG Krijgsveld)

## New
Old DIA Tissue Proteomics generated by AG Krijgsveld appears not to have good quality
because sample conditions are not major variance in data, i.e., Tumor and Normal
samples are not nicely separated. Check visualization down below in 'Old' part

```{r message=F}
# Load and tidy up unpreprocessed data and include summarized metadata into it
new_proTissueTab <- readr::read_delim('./data/MethodDev/AG_Krijgsveld/20230726_Thorax_Method_Est_tissue.txt') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Aliquot',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Aliquot = stringr::str_remove_all(Aliquot, '\\.raw$')) %>%
  dplyr::left_join(summMetadat, by = 'Aliquot')
```

Show dimensions of original data (40 samples and 7537 features)
```{r}
# Preprocess data
new_proTissue <- doPreprocessing(new_proTissueTab, feat = 'Protein.Group', smp = 'Sample',
                             val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                             smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = T,
                             cutoff = 0.5, viz_miss = T, save_path = './data/MethodDev/AG_Krijgsveld/new_proTissue')
dim(new_proTissue$ori.data)
```

Show missingness of original data
```{r}
new_proTissue$ori.data.miss
```

Show distribution of original data
```{r}
new_proTissue$ori.data.dist
```

**Remove features quantified in less than 1/2 of samples**\
Show dimensions of filtered data (40 samples and 6614 features)
```{r}
dim(new_proTissue$filt.data)
```

Show missingness of filtered data
```{r}
new_proTissue$filt.data.miss
```

**Normalize filtered data by VSN**\
Show distribution of vsn normalized data
```{r}
new_proTissue$vsn.data.dist
```

Show feature mean-variance relationship of vsn normalized data
```{r}
new_proTissue$vsn.feat.mean.var
```

**Do metadata-assisted quality control**\
PC1 significantly separates Tumor and Normal samples, which implies fine data quality.
```{r}
# Do single-omics analysis
new_proTissueSOA <- doSOA(new_proTissue$vsn.data, meta_var = 'Condition', pca_method = 'ppca',
                          do_onlyPCA = T)
pcTab <- new_proTissueSOA$pcTab
ggplot(pcTab, aes(x=Condition, y=`PC1 (24.2%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(x = 'Sample condition') +
  th
```

## Old
Q: Samples from Patient 'P3457YLC', '93417JCT', and 'G33TNUQD' are missing? A: They
were dropped out from study.

```{r message=F}
# Load and tidy up unpreprocessed data and include summarized metadata into it
proTissueTab <- readr::read_tsv('./data/MethodDev/AG_Krijgsveld/20230104_MarcS_Method_Estab_Tissue.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Aliquot',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Aliquot = stringr::str_remove_all(Aliquot, 'D:.*oecf4.*Exploris_|\\.raw')) %>%
  dplyr::left_join(summMetadat, by = 'Aliquot')
# Preprocess data
proTissue <- doPreprocessing(proTissueTab, feat = 'Protein.Group', smp = 'Sample',
                             val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                             smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = T,
                             cutoff = 0.5, viz_miss = T)
```

Show dimensions of normalized filtered data (34 samples and 5746 features)
```{r}
dim(proTissue$vsn.data)
```

**Do metadata-assisted quality control**\
Visualize significant PCs associated with sample conditions
```{r}
# Do single-omics analysis
proTissueSOA <- doSOA(proTissue$vsn.data, meta_var = 'Condition', pca_method = 'ppca',
                      do_onlyPCA = T)
proTissueSOA$pcSigAssoRes

pcTab <- proTissueSOA$pcTab
ggplot(pcTab, aes(x=Condition, y=`PC19 (1.6%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(x = 'Sample condition') +
  th

ggplot(pcTab, aes(x=Condition, y=`PC6 (5.2%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(x = 'Sample condition') +
  th
```




# Plasma Proteomics (AG Krijgsveld)

## New

```{r message=F}
# Load unpreprocessed data
new_proPlasmaTab <- readr::read_delim('./data/MethodDev/AG_Krijgsveld/20230726_Thorax_Method_Est_plasma.txt') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Aliquot',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Aliquot = stringr::str_remove_all(Aliquot, '\\.raw$')) %>%
  dplyr::left_join(summMetadat, by = 'Aliquot')
```

Show dimensions of original data (40 samples and 1097 features)
```{r}
# Preprocess data
new_proPlasma <- doPreprocessing(new_proPlasmaTab, feat = 'Protein.Group', smp = 'Sample',
                                 val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                                 smpAnno = smpAnno, do_featFilt = T, cutoff = 0.5,
                                 viz_miss = T, bins = 30, save_path = './data/MethodDev/AG_Krijgsveld/new_proPlasma')
dim(new_proPlasma$ori.data)
```

Show missingness of original data
```{r}
new_proPlasma$ori.data.miss
```

Show distribution of original data
```{r}
new_proPlasma$ori.data.dist
```

**Remove features quantified in less than 1/2 of samples**\
Show dimensions of filtered data (40 samples and 640 features)
```{r}
dim(new_proPlasma$filt.data)
```

Show missingness of filtered data
```{r}
new_proPlasma$filt.data.miss
```

**Normalize filtered data by VSN**\
Show distribution of vsn normalized data
```{r}
new_proPlasma$vsn.data.dist
```

Show feature mean-variance relationship of vsn normalized data
```{r}
new_proPlasma$vsn.feat.mean.var
```

## Old
Samples from Patient 'P3457YLC', '93417JCT', and 'G33TNUQD' are missing.

```{r message=F}
# Load and tidy up unpreprocessed data and include summarized metadata into it
proPlasmaTab <- readr::read_tsv('./data/MethodDev/AG_Krijgsveld/20230104_MarcS_Method_Estab_Plasma.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Aliquot',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Aliquot = stringr::str_remove_all(Aliquot, 'D:.*oecf4.*Exploris_|\\.raw')) %>%
  dplyr::left_join(summMetadat, by = 'Aliquot')
```

Show dimensions of original data (34 samples and 505 features)
```{r}
# Preprocess data
proPlasma <- doPreprocessing(proPlasmaTab, feat = 'Protein.Group', smp = 'Sample',
                             val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                             smpAnno = smpAnno, do_featFilt = T, cutoff = 0.5,
                             viz_miss = T, bins = 30, save_path = './data/MethodDev/AG_Krijgsveld/proPlasma')
dim(proPlasma$ori.data)
```

Show missingness of original data
```{r}
proPlasma$ori.data.miss
```

Show distribution of original data
```{r}
proPlasma$ori.data.dist
```

**Remove features quantified in less than 1/2 of samples**\
Show dimensions of filtered data (34 samples and 446 features)
```{r}
dim(proPlasma$filt.data)
```

Show missingness of filtered data
```{r}
proPlasma$filt.data.miss
```

**Normalize filtered data by VSN**\
Show distribution of vsn normalized data
```{r}
proPlasma$vsn.data.dist
```

Show feature mean-variance relationship of vsn normalized data
```{r}
proPlasma$vsn.feat.mean.var
```




# Tissue Proteomics (AG Klingmüller)
Q: Samples from Method Development Patient 'M2J6VHZ3' and '1HU6PFFQ' are missing?\
Samples from 21 Discovery Patients were measured.

```{r message=F}
# Load and tidy unpreprocessed data
proTissueTab_Klin <- readr::read_tsv(
  './data/MethodDev/AG_Klingmueller/20230309_103228_SmartCare_TumorFree_Tumor_Yang001_Report.tsv'
  ) %>%
  dplyr::select(-c(PG.ProteinDescriptions, contains('PG.NrOfPrecursorsIdentified'),
                   contains('PG.IBAQ'), contains('PG.IsIdentified'))) %>%
  tidyr::pivot_longer(cols = -c('PG.ProteinGroups', 'PG.Genes'),
                      names_to = 'Experiment_ID',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Experiment_ID = stringr::str_remove_all(Experiment_ID, '\\[.*\\] |\\.PG\\.Quantity'),
                Abundance = gsub(',', '\\.', Abundance),
                Abundance = as.numeric(Abundance))
# Convert NaN to NA for vsn
proTissueTab_Klin$Abundance[is.nan(proTissueTab_Klin$Abundance)] <- NA

# Load experimental ID annotations
idAnnoTab <- readxl::read_excel('./data/MethodDev/AG_Klingmueller/230620_SMART-CARE_overview_OpenBIS_BH.xlsx') %>%
  dplyr::select(`Experimental ID`, `Aliquot ID`, Batch) %>%
  dplyr::rename(Aliquot = `Aliquot ID`, Experiment_ID = `Experimental ID`) %>%
  dplyr::mutate(Batch = dplyr::case_when(Batch == 'first' ~ '1', Batch == 'second' ~ '2'))
# Manually correct typo
idAnnoTab[which(idAnnoTab$Experiment_ID == 'Recurrence _TumorFree_P21'), 'Experiment_ID'] <- 'Recurrence_TumorFree_P21'
idAnnoTab[which(idAnnoTab$Experiment_ID == 'Recurrence _Tumor_P21'), 'Experiment_ID'] <- 'Recurrence_Tumor_P21'

# Include summarized metadata
proTissueTab_Klin <- dplyr::left_join(proTissueTab_Klin, idAnnoTab, by = 'Experiment_ID') %>%
  dplyr::left_join(summMetadat, by = 'Aliquot')
```

Show dimensions of original data (78 samples and 9659 features)
```{r}
# Preprocess data
proTissue_Klin <- doPreprocessing(proTissueTab_Klin, feat = 'PG.ProteinGroups',
                                  smp = 'Sample', val = 'Abundance', featAnno = 'PG.Genes',
                                  smpAnno = c(smpAnno, 'TumorPurity', 'Batch'),
                                  do_featFilt = T, cutoff = 0.5, viz_miss = T,
                                  save_path = './data/MethodDev/AG_Klingmueller/proTissue')
dim(proTissue_Klin$ori.data)
```

Show missingness of original data
```{r}
proTissue_Klin$ori.data.miss +
  theme(axis.text.x = element_text(size = 10))
```

Show distribution of original data
```{r}
proTissue_Klin$ori.data.dist +
  theme(axis.text.x = element_text(size = 10))
```

**Remove features quantified in less than 1/2 of samples**\
Show dimensions of filtered data (78 samples and 8250 features)
```{r}
dim(proTissue_Klin$filt.data)
```

Show missingness of filtered data
```{r}
proTissue_Klin$filt.data.miss +
  theme(axis.text.x = element_text(size = 10))
```

**Normalize filtered data by VSN**\
Show distribution of vsn normalized data
```{r}
proTissue_Klin$vsn.data.dist +
  theme(axis.text.x = element_text(size = 10))
```

Show feature mean-variance relationship of vsn normalized data
```{r}
proTissue_Klin$vsn.feat.mean.var
```

**Do metadata-assisted quality control**\
Visualize significant PCs associated with sample conditions and batches (1 is Method
Development cohort and 2 is Discovery cohort)
```{r}
# Do single-omics analysis
proTissueSOA_Klin <- doSOA(proTissue_Klin$vsn.data, meta_var = c('Condition', 'Batch'),
                           pca_method = 'ppca', do_onlyPCA = T)
proTissueSOA_Klin$pcSigAssoRes

# Prepare labels for samples of interest
pcTab <- proTissueSOA_Klin$pcTab %>%
  dplyr::mutate(Label = dplyr::case_when(Sample %in% c('I0HVOL_TU', '7EAOX7_TU',
                                                       'MJMTYR_TU', 'XFKHGP_TU',
                                                       'XFKHGP_NG', 'MJMTYR_NG',
                                                       'I0HVOL_NG', '7EAOX7_NG') ~ Sample))
ggplot(pcTab, aes(x=Condition, y=`PC1 (31.1%)`, col=Condition, fill=Condition, label = Label)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  geom_text_repel(show.legend = F, size = 5) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(x = 'Sample condition') +
  th
```
=> Tumor purity: I0HVOL_TU - 87% (Mean of sample tumor cell contents is 93%, ranging from 73% to 100%.)

```{r}
ggplot(pcTab, aes(x=Batch, y=`PC8 (3.5%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

ggplot(pcTab, aes(x=Batch, y=`PC12 (2.6%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

ggplot(pcTab, aes(x=Batch, y=`PC2 (11.3%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

ggplot(pcTab, aes(x=Batch, y=`PC5 (4.5%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th
```
