---
title: 'Single-omics analysis: DIA Proteomics of Method Development cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Conduct univariate (t-test) and multivariate (PCA)
analyses on individual datasets, i.e., New Plasma and Tissue DIA Proteomics from
AG Krijgsveld and Tissue DIA Proteomics from AG Klingmüller (3 datasets), to have
overview of data and take initial look at data power in terms of predicting patient
cancer recurrence. Association between each feature (protein level) and cancer
recurrence was tested by t-test, which captures significant features that can separate
recurrence and non-recurrence patient groups. PCA was performed to view sources
of data variance associated with certain metadata variables. At end of this report,
summary of all considered Method Development datasets is displayed. </font>

**Metadata variables**\
Patient (n = 20):\
Recurrence -> Cancer recurrences, Yes:No = 1:1\
Gender -> Male:Female = 13:7\
Age -> Diagnosis ages ranging from 56 to 84\
Smoking -> Smoker:Ex-smoker:Non-Smoker = 3:14:3\
Stage -> Pathological stages, IB:IIA:IIB = 11:8:1\
Adjuvant -> Adjuvant chemotherapy, True:False = 13:7\
Sample (n = 40):\
Condition -> Tissue sample conditions, Tumor:Normal = 1:1\
TimePoint -> Plasma sample collection time points, Baseline:2 years later = 1:1

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer')
```

Load libraries
```{r library loading, message = F}
library('SummarizedExperiment')
library('pcaMethods')
library('limma')
library('proDA')
library('pheatmap')
library('ggrepel')
library('openxlsx')
library('tidyverse')
# Load user-defined functions
source('./code/analysis_pipeline.R')
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

Display associations between cancer recurrence and the other patient metadata variables
to identify potential predictors (or confounders)
```{r}
# Test associations between cancer recurrence and the other patient metadata variables
# Prepare patient metadata
proTissue <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proTissueVsn.rds')
patientMetadat <- tibble::as_tibble(colData(proTissue)) %>%
  dplyr::filter(!duplicated(Patient)) %>%
  dplyr::select(Patient, Recurrence, Gender, Age, Smoking, Stage, Adjuvant)
patientRecur <- dplyr::select(patientMetadat, Patient, Recurrence)
patientMetadat <- dplyr::select(patientMetadat, -Recurrence)
testAsso(patientMetadat, patientRecur, cmn_col = 'Patient') %>%
  dplyr::select(-Stat)
```

# New Tissue Proteomics (AG Krijgsveld)

```{r}
# Load normalized data
proTissue <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proTissueVsn.rds')
# Prepare feature annotation table
featAnnoTab <- tibble::as_tibble(rowData(proTissue), rownames = 'Protein') %>%
  dplyr::select(Protein, Genes) %>%
  dplyr::rename(Gene = Genes) %>%
  tibble::column_to_rownames('Protein')

# Perform single-omics analysis
proTissueRes <- doSOA(proTissue, meta_var = 'Condition', pca_method = 'ppca', do_onlyPCA = T)
```

**Do metadata-assisted quality control**\
After testing associations between PCs and tissue sample conditions, we found that
PC1 nicely separates Tumor and Normal samples, which should indicate good data quality.
```{r}
pcTab <- proTissueRes$pcTab
ggplot(pcTab, aes(x=Condition, y=`PC1 (24.2%)`, color=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(x = 'Sample condition') +
  th
```
=> Tumor and Normal tissue samples will be analyzed separately for two reasons:
(1) They are characteristically different and might be offsets to each other, and
(2) Normal tissues is always obtainable in case that Tumor tissues were not preserved
after surgery.

## Tumor samples

```{r}
# Subset certain samples
proTumor <- proTissue[, which(colData(proTissue)$Condition == 'Tumor')]
# Perform single-omics analysis
proTumorRes <- doSingleOmicsAnalysis(proTumor, soa_metaVar = 'Recurrence', num_sigFeats = 6,
                                     pca_method = 'ppca', num_PCs = 18, num_PCfeats = 30,
                                     use_limma = F, use_proDA = T, feat_anno = featAnnoTab,
                                     feat_conv = T, plot_title = NULL, show_rownames = F,
                                     pca_metaVar = c('Recurrence', 'Gender', 'Age',
                                                     'Smoking', 'Stage', 'Adjuvant', 'TumorPurity'))
```

Display significant associations between PCs (Var1) and sample metadata variables
(Var2) to overview sources of variance in data
```{r}
proTumorRes$data.var.source
```

Display significant associations between features (Var1) and cancer recurrence (Var2).
Owing to missing values, there may be situation that only few observations in sample
groups, resulting in unreliable t-statistics. To this end, we used probabilistic
dropout model (proDA) to account for data missingness.
```{r}
proTumorRes$sig.feat.tab %>%
  dplyr::select(-Test)
```

Visualize molecular signatures of significant features in data. Note that features
in rows are ordered by t-statistics.
```{r}
proTumorRes$sig.feat.heat
```

Visualize top significant features identified in Tumor samples (ns: p > 0.05,
$*$: p <= 0.05, $**$: p <= 0.01, $***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- proTissueRes$data
smpAnnoTab <- proTissueRes$smpMetadata
# Prepare significant feature table
featSigAssoTab <- proTumorRes$sig.feat.tab
num_sigFeats <- 6
gpLevel = c('Yes_Tumor', 'No_Tumor', 'Yes_Normal', 'No_Normal')
condiCol = c('grey50', 'firebrick') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoTab[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, ' (', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Tumor', 'No_Tumor'), c('Yes_Normal', 'No_Normal')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
proTumorRes$pval.hist
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
proTumorRes$sig.pc.tab
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
proTumorRes$sig.pc.dist$PC15
proTumorRes$pc.top.feat.tab$PC15
```

## Normal samples

```{r}
# Subset certain samples
proNormal <- proTissue[, which(colData(proTissue)$Condition == 'Normal')]
# Perform single-omics analysis
proNormalRes <- doSingleOmicsAnalysis(proNormal, soa_metaVar = 'Recurrence', num_sigFeats = 6,
                                      pca_method = 'ppca', num_PCs = 18, num_PCfeats = 30,
                                      use_limma = F, use_proDA = T, feat_anno = featAnnoTab,
                                      feat_conv = T, plot_title = NULL, show_rownames = F,
                                      pca_metaVar = c('Recurrence', 'Gender', 'Age',
                                                      'Smoking', 'Stage', 'Adjuvant'))
```

Display significant associations between PCs (Var1) and sample metadata variables
(Var2) to overview sources of variance in data
```{r}
proNormalRes$data.var.source
```

Display significant associations between features (Var1) and cancer recurrence (Var2)
```{r}
sig.feat.tab <- proNormalRes$sig.feat.tab %>%
  dplyr::select(-Test)
sig.feat.tab$Var1[142] <- 'P09086;P14859'
sig.feat.tab$Gene[142] <- 'POU2F1;POU2F2'
sig.feat.tab$Var1[319] <- 'P0DP23;P0DP24'
sig.feat.tab$Gene[319] <- 'CALM1;CALM2'
sig.feat.tab
```

Visualize molecular signatures of significant features in data. Note that features
in rows are ordered by t-statistics.
```{r}
proNormalRes$sig.feat.heat
```

Visualize top significant features identified in Normal samples (ns: p > 0.05,
$*$: p <= 0.05, $**$: p <= 0.01, $***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- proTissueRes$data
smpAnnoTab <- proTissueRes$smpMetadata
# Prepare significant feature table
featSigAssoTab <- proNormalRes$sig.feat.tab
num_sigFeats <- 6
gpLevel = c('Yes_Normal', 'No_Normal', 'Yes_Tumor', 'No_Tumor')
condiCol = c('firebrick', 'grey50') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoTab[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, ' (', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Normal', 'No_Normal'), c('Yes_Tumor', 'No_Tumor')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th +
  theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
proNormalRes$pval.hist
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
proNormalRes$sig.pc.tab
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
proNormalRes$sig.pc.dist$PC13
proNormalRes$pc.top.feat.tab$PC13
```




# Tissue Proteomics (AG Klingmüller)

```{r}
# Load normalized data
proTissue_Klin <- readRDS('./data/MethodDev/AG_Klingmueller/proTissueVsn.rds')
# Extract Method Development samples
proTissue_Klin <- proTissue_Klin[, colData(proTissue_Klin)$Cohort == 'MethodDev']
# Prepare feature annotation table
featAnnoTab <- tibble::as_tibble(rowData(proTissue_Klin), rownames = 'Protein') %>%
  dplyr::select(Protein, PG.Genes) %>%
  dplyr::rename(Gene = PG.Genes) %>%
  tibble::column_to_rownames('Protein')

# Perform single-omics analysis
proTissueRes_Klin <- doSOA(proTissue_Klin, meta_var = 'Condition', pca_method = 'ppca', do_onlyPCA = T)
```

**Do metadata-assisted quality control**\
After testing associations between PCs and tissue sample conditions, we found that
PC1 nicely separates Tumor and Normal samples, which should indicate good data quality.
```{r}
pcTab <- proTissueRes_Klin$pcTab
ggplot(pcTab, aes(x=Condition, y=`PC1 (20.8%)`, color=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(x = 'Sample condition') +
  th
```
=> Tumor and Normal tissue samples will be analyzed separately for two reasons:
(1) They are characteristically different and might be offsets to each other, and
(2) Normal tissues is always obtainable in case that Tumor tissues were not preserved
after surgery.

## Tumor samples

```{r}
# Subset certain samples
proTumor <- proTissue_Klin[, which(colData(proTissue_Klin)$Condition == 'Tumor')]
# Perform single-omics analysis
proTumorRes_Klin <- doSingleOmicsAnalysis(proTumor, soa_metaVar = 'Recurrence', num_sigFeats = 6,
                                          pca_method = 'ppca', num_PCs = 16, num_PCfeats = 30,
                                          use_limma = F, use_proDA = T, feat_anno = featAnnoTab,
                                          feat_conv = T, plot_title = NULL, show_rownames = F,
                                          pca_metaVar = c('Recurrence', 'Gender', 'Age',
                                                          'Smoking', 'Stage', 'Adjuvant', 'TumorPurity'))
```

Display significant associations between PCs (Var1) and sample metadata variables
(Var2) to overview sources of variance in data
```{r}
proTumorRes_Klin$data.var.source
```

Display significant associations between features (Var1) and cancer recurrence (Var2).
Owing to missing values, there may be situation that only few observations in sample
groups, resulting in unreliable t-statistics. To this end, we used probabilistic
dropout model (proDA) to account for data missingness.
```{r}
proTumorRes_Klin$sig.feat.tab
```

Visualize molecular signatures of significant features in data. Note that features
in rows are ordered by t-statistics.
```{r}
proTumorRes_Klin$sig.feat.heat
```

Visualize top significant features identified in Tumor samples (ns: p > 0.05,
$*$: p <= 0.05, $**$: p <= 0.01, $***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- proTissueRes_Klin$data
smpAnnoTab <- proTissueRes_Klin$smpMetadata
# Prepare significant feature table
featSigAssoTab <- proTumorRes_Klin$sig.feat.tab
num_sigFeats <- 6
gpLevel = c('Yes_Tumor', 'No_Tumor', 'Yes_Normal', 'No_Normal')
condiCol = c('grey50', 'firebrick') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoTab[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, ' (', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Tumor', 'No_Tumor'), c('Yes_Normal', 'No_Normal')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
proTumorRes_Klin$pval.hist
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
proTumorRes_Klin$sig.pc.tab
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
proTumorRes_Klin$sig.pc.dist$PC15
proTumorRes_Klin$pc.top.feat.tab$PC15
proTumorRes_Klin$sig.pc.dist$PC11
proTumorRes_Klin$pc.top.feat.tab$PC11
```

## Normal samples

```{r}
# Subset certain samples
proNormal <- proTissue_Klin[, which(colData(proTissue_Klin)$Condition == 'Normal')]
# Perform single-omics analysis
proNormalRes_Klin <- doSingleOmicsAnalysis(proNormal, soa_metaVar = 'Recurrence', num_sigFeats = 6,
                                           pca_method = 'ppca', num_PCs = 16, num_PCfeats = 30,
                                           use_limma = F, use_proDA = T, feat_anno = featAnnoTab,
                                           feat_conv = T, plot_title = NULL, show_rownames = F,
                                           pca_metaVar = c('Recurrence', 'Gender', 'Age',
                                                           'Smoking', 'Stage', 'Adjuvant'))
```

Display significant associations between PCs (Var1) and sample metadata variables
(Var2) to overview sources of variance in data
```{r}
proNormalRes_Klin$data.var.source
```

Display significant associations between features (Var1) and cancer recurrence (Var2)
```{r}
proNormalRes_Klin$sig.feat.tab %>%
  dplyr::select(-Test)
```

Visualize molecular signatures of significant features in data. Note that features
in rows are ordered by t-statistics.
```{r}
proNormalRes_Klin$sig.feat.heat
```

Visualize top significant features identified in Normal samples (ns: p > 0.05,
$*$: p <= 0.05, $**$: p <= 0.01, $***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Tumor and Normal samples
datMat <- proTissueRes_Klin$data
smpAnnoTab <- proTissueRes_Klin$smpMetadata
# Prepare significant feature table
featSigAssoTab <- proNormalRes_Klin$sig.feat.tab
num_sigFeats <- 6
gpLevel = c('Yes_Normal', 'No_Normal', 'Yes_Tumor', 'No_Tumor')
condiCol = c('firebrick', 'grey50') #c(Normal, Tumor)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoTab[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, ' (', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(datMat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_Condi = paste0(Recurrence, '_', Condition),
                Recur_Condi = factor(Recur_Condi, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_Condi, y=Abundance, col=Condition, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Normal', 'No_Normal'), c('Yes_Tumor', 'No_Tumor')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = condiCol) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th +
  theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
proNormalRes_Klin$pval.hist
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
proNormalRes_Klin$sig.pc.tab
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
proNormalRes_Klin$sig.pc.dist$PC1
proNormalRes_Klin$pc.top.feat.tab$PC1
proNormalRes_Klin$sig.pc.dist$PC7
proNormalRes_Klin$pc.top.feat.tab$PC7
```




# New Plasma Proteomics (AG Krijgsveld)
We attempt to identify biomarkers that can predict whether patients WILL suffer
from cancer recurrence or not. Therefore, we decided to analyze Baseline and Follow-up
samples separately.

```{r}
# Load normalized data
proPlasma <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proPlasmaVsn.rds')
# Manually modify metadata time point information
tmp_metadata <- as.data.frame(colData(proPlasma)) %>%
  dplyr::mutate(TimePoint = dplyr::case_when(Condition == 'Baseline' ~ 'Baseline',
                                             Condition != 'Baseline' ~ '2 years later'))
colData(proPlasma)['TimePoint'] <- tmp_metadata$TimePoint
# Prepare feature annotation table
featAnnoTab <- tibble::as_tibble(rowData(proPlasma), rownames = 'Protein') %>%
  dplyr::select(Protein, Genes) %>%
  dplyr::rename(Gene = Genes) %>%
  tibble::column_to_rownames('Protein')

# Perform single-omics analysis
proPlasmaRes <- doSOA(proPlasma, meta_var = 'TimePoint', pca_method = 'ppca', do_onlyPCA = T)
```

## Baseline samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset certain samples
proBase <- proPlasma[, which(colData(proPlasma)$Condition == 'Baseline')]

# Perform single-omics analysis
proBaseRes <- doSingleOmicsAnalysis(proBase, soa_metaVar = 'Recurrence', num_sigFeats = 6,
                                    pca_method = 'ppca', num_PCs = 19, num_PCfeats = 30,
                                    use_limma = F, use_proDA = T, feat_anno = featAnnoTab,
                                    feat_conv = T, plot_title = NULL,
                                    pca_metaVar = c('Recurrence', 'Gender', 'Age',
                                                    'Smoking', 'Stage', 'Adjuvant'))
```

```{r include = F, eval = F}
# Compare learned PCs using conventional PCA and PPCA
# Impute missing values using PPCA
impuDatMat <- proBaseAssoRes$pcaRes@completeObs
# Run PPCA on imputed data
ppcaRes <- doPCA(t(impuDatMat), pca_method = 'ppca', num_PCs = 15)
# Conduct association tests between PCs and metadata
pcTab <- tibble::as_tibble(ppcaRes@scores, rownames = 'Sample')
metaTab <- tibble::as_tibble(colData(proBase), rownames = 'Sample') %>%
  dplyr::select(Sample, Recurrence, Gender, Age, Smoking, Stage, Metastasis)
assoRes <- testAssociation(data = pcTab, metadata = metaTab, cmn_col = 'Sample') %>%
  dplyr::filter(pVal < 0.05)
assoRes

# Run conventional PCA on imputed data
pcaRes <- doPCA(t(impuDatMat), pca_method = 'pca')
# Conduct association test between PCs and metadata
pcTab <- tibble::as_tibble(pcaRes$x, rownames = 'Sample')
metaTab <- tibble::as_tibble(colData(proBase), rownames = 'Sample') %>%
  dplyr::select(Sample, Recurrence, Gender, Age, Smoking, Stage, Metastasis)
assoRes <- testAssociation(data = pcTab, metadata = metaTab, cmn_col = 'Sample') %>%
  dplyr::filter(pVal < 0.05)
assoRes

# PCA is matrix factorization, which decomposes a matrix into two matrices, score
# and loading matrices. Imputing data using PPCA is basically product of learned
# score and loading matrices. Results will be similar despite running PPCA on original
# data with missingness or imputed data using PPCA. Results of conventional PCA
# or PPCA on same complete data should be similar.
```

Display significant associations between PCs (Var1) and sample metadata variables
(Var2) to overview sources of variance in data
```{r}
proBaseRes$data.var.source
```

Display significant associations between features (Var1) and cancer recurrence (Var2).
Owing to missing values, there may be situation that only few observations in sample
groups, resulting in unreliable t-statistics. To this end, we used probabilistic
dropout model (proDA) to account for data missingness.
```{r}
proBaseRes$sig.feat.tab
```

Visualize molecular signatures of significant features in data. Note that features
in rows are ordered by t-statistics.
```{r}
proBaseRes$sig.feat.heat
```

Visualize top significant features identified in Baseline samples (ns: p > 0.05,
$*$: p <= 0.05, $**$: p <= 0.01, $***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Baseline and Follow-up samples
dat <- proPlasmaRes$data
smpAnnoTab <- proPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
featSigAssoTab <- proBaseRes$sig.feat.tab
num_sigFeats <- 6
gpLevel = c('Yes_Baseline', 'No_Baseline', 'Yes_Follow-up', 'No_Follow-up')
tpCol = c('firebrick', 'grey50') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoTab[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Baseline', 'No_Baseline'),
                                                c('Yes_Follow-up', 'No_Follow-up')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
proBaseRes$pval.hist
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
proBaseRes$sig.pc.tab
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
proBaseRes$sig.pc.dist$PC10
proBaseRes$pc.top.feat.tab$PC10
proBaseRes$sig.pc.dist$PC4
proBaseRes$pc.top.feat.tab$PC4
```

## Follow-up samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset follow-up samples
proFolo <- proPlasma[, which(colData(proPlasma)$Condition != 'Baseline')]

# Perform single-omics analysis
proFoloRes <- doSingleOmicsAnalysis(proFolo, soa_metaVar = 'Recurrence', num_sigFeats = 6,
                                    pca_method = 'ppca', num_PCs = 18, num_PCfeats = 30,
                                    use_limma = F, use_proDA = T, feat_anno = featAnnoTab,
                                    feat_conv = T, plot_title = NULL,
                                    pca_metaVar = c('Recurrence', 'Gender', 'Adjuvant'))
```

Display significant associations between PCs (Var1) and sample metadata variables
(Var2) to overview sources of variance in data
```{r}
proFoloRes$data.var.source
```

Display significant associations between features (Var1) and cancer recurrence (Var2).
Owing to missing values, there may be situation that only few observations in sample
groups, resulting in unreliable t-statistics. To this end, we used probabilistic
dropout model (proDA) to account for data missingness.
```{r}
proFoloRes$sig.feat.tab
```

Visualize molecular signatures of significant features in data. Note that features
in rows are ordered by t-statistics.
```{r}
proFoloRes$sig.feat.heat
```

Visualize top significant features identified in Follow-up samples (ns: p > 0.05,
$*$: p <= 0.05, $**$: p <= 0.01, $***$: p <= 0.001)
```{r fig.height=10}
# Prepare data matrix and metadata including both Baseline and Follow-up samples
dat <- proPlasmaRes$data
smpAnnoTab <- proPlasmaRes$smpMetadata %>%
  dplyr::mutate(TimePoint = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                             TimePoint == '2 years later' ~ 'Follow-up'))
# Prepare significant feature table
featSigAssoTab <- proFoloRes$sig.feat.tab
num_sigFeats <- 6
gpLevel = c('Yes_Follow-up', 'No_Follow-up', 'Yes_Baseline', 'No_Baseline')
tpCol = c('grey50', 'firebrick') #c(Baseline, Follow-up)
# Extract top significant features and prepare needed information
topSigFeats <- featSigAssoTab[1:num_sigFeats,] %>%
  dplyr::select(Var1, Gene) %>%
  dplyr::mutate(newVar1 = paste0(Var1, '\n(', Gene, ')'),
                newVar1 = factor(newVar1, levels = unique(newVar1)))
topSigFeatDat <- tibble::as_tibble(dat[topSigFeats$Var1,], rownames = 'Var1') %>%
  tidyr::pivot_longer(cols = -'Var1', names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Var1') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::mutate(Recur_TP = paste0(Recurrence, '_', TimePoint),
                Recur_TP = factor(Recur_TP, levels = gpLevel))
ggplot(topSigFeatDat, aes(x=Recur_TP, y=Abundance, col=TimePoint, fill=Recurrence)) +
  geom_boxplot(alpha = 1, outlier.shape = NA, linewidth = 1) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, method.args = list(var.equal = T),
                             comparisons = list(c('Yes_Follow-up', 'No_Follow-up'),
                                                c('Yes_Baseline', 'No_Baseline')),
                             label = 'p.signif', tip.length = 0.015, bracket.size = 0.7, size = 4) +
  labs(x = 'Recurrence') +
  scale_color_manual(values = tpCol, name = 'Time Point') +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(newVar1), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'),
             axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Assess data power by p-value histogram
```{r}
proFoloRes$pval.hist
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
proFoloRes$sig.pc.tab
```

Visualize significant PCs and display their top features with greatest absolute loadings
```{r}
proFoloRes$sig.pc.dist$PC14
proFoloRes$pc.top.feat.tab$PC14
```




# Summary

```{r}
# Load and subset all considered Method Development datasets
# Specific functions for subsetting data
subPlasma <- function(summ_exp) {
  smpAnno <- as.data.frame(colData(summ_exp))
  base <- summ_exp[, smpAnno[['Condition']] == 'Baseline']
  folo <- summ_exp[, smpAnno[['Condition']] != 'Baseline']
  return(list(Base = base, Folo = folo))
}

subTissue <- function(summ_exp) {
  smpAnno <- as.data.frame(colData(summ_exp))
  tumor <- summ_exp[, smpAnno[['Condition']] == 'Tumor']
  normal <- summ_exp[, smpAnno[['Condition']] == 'Normal']
  return(list(Tumor = tumor, Normal = normal))
}

# Load normalized datasets and subset them into Baseline/Follow-up and Tumor/Normal datasets
# NO MISSINGNESS
# Targeted Plasma Metabolomics
metaPlasma_Hell <- readRDS('./data/MethodDev/AG_Hell/metaPlasmaVsn.rds')
metaBase_Hell <- subPlasma(metaPlasma_Hell)$Base
metaFolo_Hell <- subPlasma(metaPlasma_Hell)$Folo

# Targeted Tissue Metabolomics
metaTissue_Hell <- readRDS('./data/MethodDev/AG_Hell/metaTissueVsn.rds')
metaTumor_Hell <- subTissue(metaTissue_Hell)$Tumor
metaNormal_Hell <- subTissue(metaTissue_Hell)$Normal

# DDA Plasma Proteomics
proPlasma_Kri_DDA <- readRDS('./data/MethodDev/AG_Krijgsveld/proPlasmaVsn_DDA.rds')
proBase_Kri_DDA <- subPlasma(proPlasma_Kri_DDA)$Base
proFolo_Kri_DDA <- subPlasma(proPlasma_Kri_DDA)$Folo

# DDA Tissue Proteomics
proTissue_Kri_DDA <- readRDS('./data/MethodDev/AG_Krijgsveld/proTissueVsn_DDA.rds')
proTumor_Kri_DDA <- subTissue(proTissue_Kri_DDA)$Tumor
proNormal_Kri_DDA <- subTissue(proTissue_Kri_DDA)$Normal

# WITH MISSINGNESS
# Untargeted Plasma Metabolomics
metaPlasma_Hopf <- readRDS('./data/MethodDev/AG_Hopf/metaPlasmaVsn.rds')
metaBase_Hopf <- subPlasma(metaPlasma_Hopf)$Base
metaFolo_Hopf <- subPlasma(metaPlasma_Hopf)$Folo

# Untargeted Tissue Metabolomics
metaTissue_Hopf <- readRDS('./data/MethodDev/AG_Hopf/metaTissueVsn.rds')
metaTumor_Hopf <- subTissue(metaTissue_Hopf)$Tumor
metaNormal_Hopf <- subTissue(metaTissue_Hopf)$Normal

# Untargeted Plasma Lipidomics
lipPlasma_Hopf <- readRDS('./data/MethodDev/AG_Hopf/lipPlasmaVsn.rds')
lipBase_Hopf <- subPlasma(lipPlasma_Hopf)$Base
lipFolo_Hopf <- subPlasma(lipPlasma_Hopf)$Folo

# Untargeted Tissue Lipidomics
lipTissue_Hopf <- readRDS('./data/MethodDev/AG_Hopf/lipTissueVsn.rds')
lipTumor_Hopf <- subTissue(lipTissue_Hopf)$Tumor
lipNormal_Hopf <- subTissue(lipTissue_Hopf)$Normal

# DIA Plasma Proteomics (AG Krijgsveld)
proPlasma_Kri_DIA <- readRDS('./data/MethodDev/AG_Krijgsveld/proPlasmaVsn.rds')
proBase_Kri_DIA <- subPlasma(proPlasma_Kri_DIA)$Base
proFolo_Kri_DIA <- subPlasma(proPlasma_Kri_DIA)$Folo

# New DIA Plasma Proteomics (AG Krijgsveld)
new_proPlasma_Kri_DIA <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proPlasmaVsn.rds')
new_proBase_Kri_DIA <- subPlasma(new_proPlasma_Kri_DIA)$Base
new_proFolo_Kri_DIA <- subPlasma(new_proPlasma_Kri_DIA)$Folo

# New DIA Tissue Proteomics (AG Krijgsveld)
new_proTissue_Kri_DIA <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proTissueVsn.rds')
new_proTumor_Kri_DIA <- subTissue(new_proTissue_Kri_DIA)$Tumor
new_proNormal_Kri_DIA <- subTissue(new_proTissue_Kri_DIA)$Normal

# DIA Tissue Proteomics (AG Klingmüller)
proTissue_Klin_DIA <- readRDS('./data/MethodDev/AG_Klingmueller/proTissueVsn.rds')
# Extract Method Development samples
proTissue_Klin_DIA <- proTissue_Klin_DIA[, colData(proTissue_Klin_DIA)$Cohort == 'MethodDev']
proTumor_Klin_DIA <- subTissue(proTissue_Klin_DIA)$Tumor
proNormal_Klin_DIA <- subTissue(proTissue_Klin_DIA)$Normal
```

Visualize recurrence-related features from new DIA Tissue and Plasma Proteomics
generated by AG Krijgsveld and DIA Tissue Proteomics by AG Klingmüller through
volcano plots. Log2-FC (up and down) is recurrence to non-recurrence groups. To
be clearer, entities on up side are more abundant in recurrence group than non-recurrence
group, and so forth.
```{r message = F}
# Prepare protein-gene tables for annotations
proTissueFeatInfo_Kri <- tibble::as_tibble(rowData(new_proTissue_Kri_DIA), rownames = 'Feature') %>%
  dplyr::select(Feature, Genes) %>%
  dplyr::rename(Gene = Genes)
proTissueFeatInfo_Klin <- tibble::as_tibble(rowData(proTissue_Klin_DIA), rownames = 'Feature') %>%
  dplyr::select(Feature, PG.Genes) %>%
  dplyr::rename(Gene = PG.Genes)
proPlasmaFeatInfo_Kri <- tibble::as_tibble(rowData(new_proPlasma_Kri_DIA), rownames = 'Feature') %>%
  dplyr::select(Feature, Genes) %>%
  dplyr::rename(Gene = Genes)

# Compute log2(FC)
# TP (AG Krijgsveld)
new_proTissueMedi_Kri <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proTissueMedi.rds') %>%
  summExp2df(row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTP
proTumorLogFC_Kri <- dplyr::filter(new_proTissueMedi_Kri, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTP
proNormalLogFC_Kri <- dplyr::filter(new_proTissueMedi_Kri, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TP (AG Klingmüller)
proTissueMedi_Klin <- readRDS('./data/MethodDev/AG_Klingmueller/proTissueMedi.rds') %>%
  summExp2df(row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::filter(Cohort == 'MethodDev') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTP
proTumorLogFC_Klin <- dplyr::filter(proTissueMedi_Klin, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTP
proNormalLogFC_Klin <- dplyr::filter(proTissueMedi_Klin, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# PP
new_proPlasmaMedi_Kri <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proPlasmaMedi.rds') %>%
  summExp2df(row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPP
proBaseLogFC_Kri <- dplyr::filter(new_proPlasmaMedi_Kri, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPP
proFoloLogFC_Kri <- dplyr::filter(new_proPlasmaMedi_Kri, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# Prepare tables of associations between features and cancer recurrence
proTumorFeatAsso_Kri <- proTumorRes$SOA.res$featAssoRes
proNormalFeatAsso_Kri <- proNormalRes$SOA.res$featAssoRes
proTumorFeatAsso_Klin <- proTumorRes_Klin$SOA.res$featAssoRes
proNormalFeatAsso_Klin <- proNormalRes_Klin$SOA.res$featAssoRes
proBaseFeatAsso_Kri <- proBaseRes$SOA.res$featAssoRes
proFoloFeatAsso_Kri <- proFoloRes$SOA.res$featAssoRes

# Collect all needed information for volcano plots
# TTP (AG Krijgsveld)
proTumorVolTab_Kri <- dplyr::select(proTumorFeatAsso_Kri, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proTumorLogFC_Kri, by = 'Feature') %>%
  dplyr::left_join(proTissueFeatInfo_Kri, by = 'Feature')
# NTP (AG Krijgsveld)
proNormalVolTab_Kri <- dplyr::select(proNormalFeatAsso_Kri, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proNormalLogFC_Kri, by = 'Feature') %>%
  dplyr::left_join(proTissueFeatInfo_Kri, by = 'Feature')

# TTP (AG Klingmüller)
proTumorVolTab_Klin <- dplyr::select(proTumorFeatAsso_Klin, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proTumorLogFC_Klin, by = 'Feature') %>%
  dplyr::left_join(proTissueFeatInfo_Klin, by = 'Feature')
# NTP (AG Klingmüller)
proNormalVolTab_Klin <- dplyr::select(proNormalFeatAsso_Klin, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proNormalLogFC_Klin, by = 'Feature') %>%
  dplyr::left_join(proTissueFeatInfo_Klin, by = 'Feature')

# BPP
proBaseVolTab_Kri <- dplyr::select(proBaseFeatAsso_Kri, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proBaseLogFC_Kri, by = 'Feature') %>%
  dplyr::left_join(proPlasmaFeatInfo_Kri, by = 'Feature')
# FPP
proFoloVolTab_Kri <- dplyr::select(proFoloFeatAsso_Kri, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proFoloLogFC_Kri, by = 'Feature') %>%
  dplyr::left_join(proPlasmaFeatInfo_Kri, by = 'Feature')
```

Log2-FC cutoffs are 1 (FC=2) and -1 (FC=0.5).
```{r}
# TTP
volTab <- proTumorVolTab_Kri
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 1] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -1] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-1, 1), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'New Tumor Tissue Proteomics (AG Krij.)') +
  th
```

Log2-FC cutoffs are 1 (FC=2) and -1 (FC=0.5).
```{r}
# NTP
volTab <- proNormalVolTab_Kri
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 1] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -1] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-1, 1), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'New Normal Tissue Proteomics (AG Krij.)') +
  th
```

Log2-FC cutoffs are 1 (FC=2) and -1 (FC=0.5).
```{r}
# TTP
volTab <- proTumorVolTab_Klin
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 1] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -1] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-1, 1), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Proteomics (AG Klin.)') +
  th
```

Log2-FC cutoffs are 2 (FC=4) and -2 (FC=0.25).
```{r}
# NTP
volTab <- proNormalVolTab_Klin
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 2] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -2] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-2, 2), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Proteomics (AG Klin.)') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# BPP
volTab <- proBaseVolTab_Kri
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'New Baseline Plasma Proteomics (AG Krij.)') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# FPP
volTab <- proFoloVolTab_Kri
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'New Follow-up Plasma Proteomics (AG Krij.)') +
  th
```

Display proportions of significant features that can separate cancer recurrence
and non-recurrence patient groups for all considered Method Development datasets,
including Targeted/Untargeted Plasma/Tissue Metabolomics and Lipidomics (6 datasets)
and DIA/DDA Plasma/Tissue Proteomics (6 datasets). Alpha was set to 0.05 and numbers
after bars indicate feature sizes. Note that results were not corrected through
any p-value adjustment method and linear models accounted only for recurrence, so
there may be abundant false positives.
```{r message = F}
# Prepare significant feature lists for all considered datasets
# NO MISSINGNESS
# Targeted Plasma Metabolomics
metaBaseRes_Hell <- doSOA(metaBase_Hell, meta_var = 'Recurrence', use_limma = T, alpha = 0.05)
metaFoloRes_Hell <- doSOA(metaFolo_Hell, meta_var = 'Recurrence', use_limma = T, alpha = 0.05)

# Targeted Tissue Metabolomics
metaTumorRes_Hell <- doSOA(metaTumor_Hell, meta_var = 'Recurrence', use_limma = T, alpha = 0.05)
metaNormalRes_Hell <- doSOA(metaNormal_Hell, meta_var = 'Recurrence', use_limma = T, alpha = 0.05)

# DDA Plasma Proteomics
proBaseRes_Kri_DDA <- doSOA(proBase_Kri_DDA, meta_var = 'Recurrence', use_limma = T, alpha = 0.05)
proFoloRes_Kri_DDA <- doSOA(proFolo_Kri_DDA, meta_var = 'Recurrence', use_limma = T, alpha = 0.05)

# DDA Tissue Proteomics
proTumorRes_Kri_DDA <- doSOA(proTumor_Kri_DDA, meta_var = 'Recurrence', use_limma = T, alpha = 0.05)
proNormalRes_Kri_DDA <- doSOA(proNormal_Kri_DDA, meta_var = 'Recurrence', use_limma = T, alpha = 0.05)

# WITH MISSINGNESS
# Untargeted Plasma Metabolomics
metaBaseRes_Hopf <- doSOA(metaBase_Hopf, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)
metaFoloRes_Hopf <- doSOA(metaFolo_Hopf, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)

# Untargeted Tissue Metabolomics
metaTumorRes_Hopf <- doSOA(metaTumor_Hopf, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)
metaNormalRes_Hopf <- doSOA(metaNormal_Hopf, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)

# Untargeted Plasma Lipidomics
lipBaseRes_Hopf <- doSOA(lipBase_Hopf, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)
lipFoloRes_Hopf <- doSOA(lipFolo_Hopf, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)

# Untargeted Tissue Lipidomics
lipTumorRes_Hopf <- doSOA(lipTumor_Hopf, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)
lipNormalRes_Hopf <- doSOA(lipNormal_Hopf, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)

# DIA Plasma Proteomics (AG Krijgsveld)
proBaseRes_Kri_DIA <- doSOA(proBase_Kri_DIA, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)
proFoloRes_Kri_DIA <- doSOA(proFolo_Kri_DIA, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)

# New DIA Plasma Proteomics (AG Krijgsveld)
# new_proBaseRes_Kri_DIA <- proBaseRes$SOA.res
# new_proFoloRes_Kri_DIA <- proFoloRes$SOA.res
new_proBaseRes_Kri_DIA <- doSOA(new_proBase_Kri_DIA, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)
new_proFoloRes_Kri_DIA <- doSOA(new_proFolo_Kri_DIA, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)

# New DIA Tissue Proteomics (AG Krijgsveld)
# new_proTumorRes_Kri_DIA <- proTumorRes$SOA.res
# new_proNormalRes_Kri_DIA <- proNormalRes$SOA.res
new_proTumorRes_Kri_DIA <- doSOA(new_proTumor_Kri_DIA, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)
new_proNormalRes_Kri_DIA <- doSOA(new_proNormal_Kri_DIA, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)

# DIA Tissue Proteomics (AG Klingmüller)
# proTumorRes_Klin_DIA <- proTumorRes_Klin$SOA.res
# proNormalRes_Klin_DIA <- proNormalRes_Klin$SOA.res
proTumorRes_Klin_DIA <- doSOA(proTumor_Klin_DIA, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)
proNormalRes_Klin_DIA <- doSOA(proNormal_Klin_DIA, meta_var = 'Recurrence', use_proDA = T, alpha = 0.05)
```

```{r}
# Make barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats_Hell <- nrow(metaBaseRes_Hell$featSigAssoRes) / nrow(metaBaseRes_Hell$data) * 100
metaFoloSigFeats_Hell <- nrow(metaFoloRes_Hell$featSigAssoRes) / nrow(metaFoloRes_Hell$data) * 100
metaTumorSigFeats_Hell <- nrow(metaTumorRes_Hell$featSigAssoRes) / nrow(metaTumorRes_Hell$data) * 100
metaNormalSigFeats_Hell <- nrow(metaNormalRes_Hell$featSigAssoRes) / nrow(metaNormalRes_Hell$data) * 100
proBaseSigFeats_Kri_DDA <- nrow(proBaseRes_Kri_DDA$featSigAssoRes) / nrow(proBaseRes_Kri_DDA$data) * 100
proFoloSigFeats_Kri_DDA <- nrow(proFoloRes_Kri_DDA$featSigAssoRes) / nrow(proFoloRes_Kri_DDA$data) * 100
proTumorSigFeats_Kri_DDA <- nrow(proTumorRes_Kri_DDA$featSigAssoRes) / nrow(proTumorRes_Kri_DDA$data) * 100
proNormalSigFeats_Kri_DDA <- nrow(proNormalRes_Kri_DDA$featSigAssoRes) / nrow(proNormalRes_Kri_DDA$data) * 100

metaBaseSigFeats_Hopf <- nrow(metaBaseRes_Hopf$featSigAssoRes) / nrow(metaBaseRes_Hopf$data) * 100
metaFoloSigFeats_Hopf <- nrow(metaFoloRes_Hopf$featSigAssoRes) / nrow(metaFoloRes_Hopf$data) * 100
metaTumorSigFeats_Hopf <- nrow(metaTumorRes_Hopf$featSigAssoRes) / nrow(metaTumorRes_Hopf$data) * 100
metaNormalSigFeats_Hopf <- nrow(metaNormalRes_Hopf$featSigAssoRes) / nrow(metaNormalRes_Hopf$data) * 100
lipBaseSigFeats_Hopf <- nrow(lipBaseRes_Hopf$featSigAssoRes) / nrow(lipBaseRes_Hopf$data) * 100
lipFoloSigFeats_Hopf <- nrow(lipFoloRes_Hopf$featSigAssoRes) / nrow(lipFoloRes_Hopf$data) * 100
lipTumorSigFeats_Hopf <- nrow(lipTumorRes_Hopf$featSigAssoRes) / nrow(lipTumorRes_Hopf$data) * 100
lipNormalSigFeats_Hopf <- nrow(lipNormalRes_Hopf$featSigAssoRes) / nrow(lipNormalRes_Hopf$data) * 100
# proBaseSigFeats_Kri_DIA <- nrow(proBaseRes_Kri_DIA$featSigAssoRes) / nrow(proBaseRes_Kri_DIA$data) * 100
# proFoloSigFeats_Kri_DIA <- nrow(proFoloRes_Kri_DIA$featSigAssoRes) / nrow(proFoloRes_Kri_DIA$data) * 100
new_proBaseSigFeats_Kri_DIA <- nrow(new_proBaseRes_Kri_DIA$featSigAssoRes) /
  nrow(new_proBaseRes_Kri_DIA$data) * 100
new_proFoloSigFeats_Kri_DIA <- nrow(new_proFoloRes_Kri_DIA$featSigAssoRes) /
  nrow(new_proFoloRes_Kri_DIA$data) * 100
new_proTumorSigFeats_Kri_DIA <- nrow(new_proTumorRes_Kri_DIA$featSigAssoRes) /
  nrow(new_proTumorRes_Kri_DIA$data) * 100
new_proNormalSigFeats_Kri_DIA <- nrow(new_proNormalRes_Kri_DIA$featSigAssoRes) /
  nrow(new_proNormalRes_Kri_DIA$data) * 100
proTumorSigFeats_Klin_DIA <- nrow(proTumorRes_Klin_DIA$featSigAssoRes) /
  nrow(proTumorRes_Klin_DIA$data) * 100
proNormalSigFeats_Klin_DIA <- nrow(proNormalRes_Klin_DIA$featSigAssoRes) /
  nrow(proNormalRes_Klin_DIA$data) * 100

# Prepare needed information for barplot
proportion <- c(metaBaseSigFeats_Hell, metaFoloSigFeats_Hell,
                metaBaseSigFeats_Hopf, metaFoloSigFeats_Hopf,
                lipBaseSigFeats_Hopf, lipFoloSigFeats_Hopf,
                # proBaseSigFeats_Kri_DIA, proFoloSigFeats_Kri_DIA,
                new_proBaseSigFeats_Kri_DIA, new_proFoloSigFeats_Kri_DIA,
                proBaseSigFeats_Kri_DDA, proFoloSigFeats_Kri_DDA,
                metaTumorSigFeats_Hell, metaNormalSigFeats_Hell,
                metaTumorSigFeats_Hopf, metaNormalSigFeats_Hopf,
                lipTumorSigFeats_Hopf, lipNormalSigFeats_Hopf,
                proTumorSigFeats_Klin_DIA, proNormalSigFeats_Klin_DIA,
                new_proTumorSigFeats_Kri_DIA, new_proNormalSigFeats_Kri_DIA,
                proTumorSigFeats_Kri_DDA, proNormalSigFeats_Kri_DDA)
dat <- c('Targeted Metab.', 'Targeted Metab.',
         'Untargeted Metab.', 'Untargeted Metab.',
         'Untargeted Lipid.', 'Untargeted Lipid.',
         # 'SDS DIA Pro.', 'SDS DIA Pro.',
         'New SDS DIA Pro.', 'New SDS DIA Pro.',
         'DDA Pro.', 'DDA Pro.',
         'Targeted Metab.', 'Targeted Metab.',
         'Untargeted Metab.', 'Untargeted Metab.',
         'Untargeted Lipid.', 'Untargeted Lipid.',
         'NP-40 DIA Pro.', 'NP-40 DIA Pro.',
         'New SDS DIA Pro.', 'New SDS DIA Pro.',
         'DDA Pro.', 'DDA Pro.')
datModal <- c(rep(c('Baseline', 'Follow-up'), 5), rep(c('Tumor', 'Normal'), 6))
datOf <- c(rep('Plasma', 10), rep('Tissue', 12))
numFeat <- c(c(nrow(metaBaseRes_Hell$data), NA), c(nrow(metaBaseRes_Hopf$data), NA),
             c(NA, nrow(lipFoloRes_Hopf$data)), #c(nrow(proBaseRes_Kri_DIA$data), NA),
             c(NA, nrow(new_proFoloRes_Kri_DIA$data)), c(nrow(proBaseRes_Kri_DDA$data), NA),
             c(nrow(metaTumorRes_Hell$data), NA), c(NA, nrow(metaNormalRes_Hopf$data)),
             c(NA, nrow(lipNormalRes_Hopf$data)), c(NA, nrow(proNormalRes_Klin_DIA$data)),
             c(NA, nrow(new_proNormalRes_Kri_DIA$data)), c(nrow(proTumorRes_Kri_DDA$data), NA))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = c('Targeted Metab.',
                                                           'Untargeted Metab.',
                                                           'Untargeted Lipid.',
                                                           'NP-40 DIA Pro.', 'New SDS DIA Pro.', 'DDA Pro.')),
                             Data_modality = datModal,
                             Data_of = datOf,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill = Data_modality, label=Feature_number)) +
  geom_bar(stat = 'identity', position=position_dodge()) +
  geom_text(size = 6, vjust = -0.17) +
  facet_wrap(~Data_of) +
  labs(x = 'Data', y = 'Percentage (%)', title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_manual(name = 'Sample Condition',
                    values = c('navy', 'grey60', 'firebrick', 'forestgreen'),
                    breaks = c('Baseline', 'Follow-up', 'Normal', 'Tumor')) +
  th +
  theme(axis.text.x = element_text(angle = 65, vjust = 1, hjust = 1),
             strip.text = element_text(size = 16, face = 'bold'))
# theme(strip.text = element_text(size = 26, face = 'bold'), axis.title = element_text(size = 26),
#       axis.text.x = element_text(size = 20, angle = 70, vjust = 1, hjust = 1), axis.text.y = element_text(size = 18),
#       legend.title = element_text(size = 24), legend.text = element_text(size = 24),
#       panel.grid.minor = element_blank(), panel.grid.major.x = element_blank())
# ggsave('./output/MethodDev/Latest/percentage_sigFeats2.png', device = 'png', dpi = 400, height = 8, width = 18)
```
1. Plasma Metabolomics/Lipidomics shows higher signal-to-noise ratios than that of
Tissues. This is a great finding in a real clinical context since Plasma samples
can be obtained more easily.\
2. Normal Tissue DIA Proteomics datasets (Normal Tissue Proteins) perform nicely,
implying that tumor microenvironment may be critical to cancer recurrence.\
3. Baseline samples are comparable to Follow-up samples, which indicates recurrence
prediction is workable.

```{r eval=F, message=F}
# Generate feature association test result tables
# Crude functions
stats_recur <- function(se, seMedi, smpType, featAnno) {
  if (smpType == 'Plasma') {
    # Extract needed information from median normalized SE object
    seMedi <- summExp2df(seMedi, row_id = 'Feature', col_id = 'Sample') %>%
      dplyr::select(Feature, Value, Condition, Recurrence) %>%
      dplyr::mutate(Condition = dplyr::case_when(Condition == 'Baseline' ~ 'Baseline',
                                                 Condition != 'Baseline' ~ 'Follow-up'))
    # Baseline samples
    # Compute log2(FC)
    baseLogFC <- dplyr::filter(seMedi, Condition == 'Baseline') %>%
      dplyr::group_by(Feature, Recurrence) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Yes - No,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    # Conduct association test
    base <- se[, which(colData(se)$Condition == 'Baseline')]
    baseRes <- doSOA(base, meta_var = 'Recurrence', use_proDA = T)
    baseFeatAsso <- baseRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (proDA)` = Stat) %>%
      # Merge results
      dplyr::left_join(baseLogFC, by = 'Feature') %>%
      dplyr::left_join(featAnno, by = 'Feature') %>%
      dplyr::relocate(Gene, .after = Feature)
    # Follow-up samples
    foloLogFC <- dplyr::filter(seMedi, Condition != 'Baseline') %>%
      dplyr::group_by(Feature, Recurrence) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Yes - No,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    folo <- se[, which(colData(se)$Condition != 'Baseline')]
    foloRes <- doSOA(folo, meta_var = 'Recurrence', use_proDA = T)
    foloFeatAsso <- foloRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (proDA)` = Stat) %>%
      dplyr::left_join(foloLogFC, by = 'Feature') %>%
      dplyr::left_join(featAnno, by = 'Feature') %>%
      dplyr::relocate(Gene, .after = Feature)
    tumorFeatAsso <- NULL
    normalFeatAsso <- NULL
  } else if (smpType == 'Tissue') {
    seMedi <- summExp2df(seMedi, row_id = 'Feature', col_id = 'Sample') %>%
      dplyr::select(Feature, Value, Condition, Recurrence)
    # Tumor samples
    tumorLogFC <- dplyr::filter(seMedi, Condition == 'Tumor') %>%
      dplyr::group_by(Feature, Recurrence) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Yes - No,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    tumor <- se[, which(colData(se)$Condition == 'Tumor')]
    tumorRes <- doSOA(tumor, meta_var = 'Recurrence', use_proDA = T)
    tumorFeatAsso <- tumorRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (proDA)` = Stat) %>%
      dplyr::left_join(tumorLogFC, by = 'Feature') %>%
      dplyr::left_join(featAnno, by = 'Feature') %>%
      dplyr::relocate(Gene, .after = Feature)
    # Normal samples
    normalLogFC <- dplyr::filter(seMedi, Condition == 'Normal') %>%
      dplyr::group_by(Feature, Recurrence) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Yes - No,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    normal <- se[, which(colData(se)$Condition == 'Normal')]
    normalRes <- doSOA(normal, meta_var = 'Recurrence', use_proDA = T)
    normalFeatAsso <- normalRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (proDA)` = Stat) %>%
      dplyr::left_join(normalLogFC, by = 'Feature') %>%
      dplyr::left_join(featAnno, by = 'Feature') %>%
      dplyr::relocate(Gene, .after = Feature)
    baseFeatAsso <- NULL
    foloFeatAsso <- NULL
  }
  return(list(baseFeatAsso = baseFeatAsso, foloFeatAsso = foloFeatAsso,
              tumorFeatAsso = tumorFeatAsso, normalFeatAsso = normalFeatAsso))
}

stats_condi <- function(se, seMedi, smpType, featAnno) {
  if (smpType == 'Plasma') {
    # Extract needed information from median normalized SE object
    seMedi <- summExp2df(seMedi, row_id = 'Feature', col_id = 'Sample') %>%
      dplyr::select(Feature, Value, Condition, Recurrence) %>%
      dplyr::mutate(Condition = dplyr::case_when(Condition == 'Baseline' ~ 'Baseline',
                                                 Condition != 'Baseline' ~ 'Follow-up'))
    # Recurrence samples
    # Compute log2(FC)
    recurrenceLogFC <- dplyr::filter(seMedi, Recurrence == 'Yes') %>%
      dplyr::group_by(Feature, Condition) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Condition', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = `Follow-up` - Baseline,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    # Conduct association test
    recurrence <- se[, which(colData(se)$Recurrence == 'Yes')]
    recurrenceRes <- doSOA(recurrence, meta_var = 'Condition', use_proDA = T)
    recurrenceFeatAsso <- recurrenceRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (proDA)` = Stat) %>%
      # Merge results
      dplyr::left_join(recurrenceLogFC, by = 'Feature') %>%
      dplyr::left_join(featAnno, by = 'Feature') %>%
      dplyr::relocate(Gene, .after = Feature)
    # Non-recurrence samples
    nonrecurLogFC <- dplyr::filter(seMedi, Recurrence == 'No') %>%
      dplyr::group_by(Feature, Condition) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Condition', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = `Follow-up` - Baseline,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    nonrecur <- se[, which(colData(se)$Recurrence == 'No')]
    nonrecurRes <- doSOA(nonrecur, meta_var = 'Condition', use_proDA = T)
    nonrecurFeatAsso <- nonrecurRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (proDA)` = Stat) %>%
      dplyr::left_join(nonrecurLogFC, by = 'Feature') %>%
      dplyr::left_join(featAnno, by = 'Feature') %>%
      dplyr::relocate(Gene, .after = Feature)
  } else if (smpType == 'Tissue') {
    seMedi <- summExp2df(seMedi, row_id = 'Feature', col_id = 'Sample') %>%
      dplyr::select(Feature, Value, Condition, Recurrence)
    # Recurrence samples
    recurrenceLogFC <- dplyr::filter(seMedi, Recurrence == 'Yes') %>%
      dplyr::group_by(Feature, Condition) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Condition', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Tumor - Normal,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    recurrence <- se[, which(colData(se)$Recurrence == 'Yes')]
    recurrenceRes <- doSOA(recurrence, meta_var = 'Condition', use_proDA = T)
    recurrenceFeatAsso <- recurrenceRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (proDA)` = Stat) %>%
      dplyr::left_join(recurrenceLogFC, by = 'Feature') %>%
      dplyr::left_join(featAnno, by = 'Feature') %>%
      dplyr::relocate(Gene, .after = Feature)
    # Non-recurrence samples
    nonrecurLogFC <- dplyr::filter(seMedi, Recurrence == 'No') %>%
      dplyr::group_by(Feature, Condition) %>%
      dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(names_from = 'Condition', values_from = 'Mean') %>%
      dplyr::mutate(log2FC = Tumor - Normal,
                    log2FC = as.numeric(formatC(log2FC, format = 'g', digits = 3))) %>%
      dplyr::select(Feature, log2FC)
    nonrecur <- se[, which(colData(se)$Recurrence == 'No')]
    nonrecurRes <- doSOA(nonrecur, meta_var = 'Condition', use_proDA = T)
    nonrecurFeatAsso <- nonrecurRes$featAssoRes %>%
      dplyr::select(Var1, pVal, pValAdj, Stat) %>%
      dplyr::rename(Feature = Var1, `tStat (proDA)` = Stat) %>%
      dplyr::left_join(nonrecurLogFC, by = 'Feature') %>%
      dplyr::left_join(featAnno, by = 'Feature') %>%
      dplyr::relocate(Gene, .after = Feature)
  }
  return(list(recurrenceFeatAsso = recurrenceFeatAsso, nonrecurFeatAsso = nonrecurFeatAsso))
}


# Load preprocessed data
proTissue_Klin <- readRDS('./data/MethodDev/AG_Klingmueller/proTissueVsn.rds')
proTissueMedi_Klin <- readRDS('./data/MethodDev/AG_Klingmueller/proTissueMedi.rds')
proTissue <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proTissueVsn.rds')
proTissueMedi <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proTissueMedi.rds')
proPlasma <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proPlasmaVsn.rds')
proPlasmaMedi <- readRDS('./data/MethodDev/AG_Krijgsveld/new_proPlasmaMedi.rds')
# Prepare feature annotation information
proTissueFeatAnno_Klin <- tibble::as_tibble(rowData(proTissue_Klin), rownames = 'Feature') %>%
  dplyr::rename(Gene = PG.Genes)
proTissueFeatAnno <- tibble::as_tibble(rowData(proTissue), rownames = 'Feature') %>%
  dplyr::select(Feature, Genes) %>%
  dplyr::rename(Gene = Genes)
proPlasmaFeatAnno <- tibble::as_tibble(rowData(proPlasma), rownames = 'Feature') %>%
  dplyr::select(Feature, Genes) %>%
  dplyr::rename(Gene = Genes)
# Generate feature association test result tables
dia.tissue.pro_recur_Klin <- stats_recur(proTissue_Klin, proTissueMedi_Klin, 'Tissue',
                                         proTissueFeatAnno_Klin)
dia.tissue.pro_recur <- stats_recur(proTissue, proTissueMedi, 'Tissue', proTissueFeatAnno)
dia.plasma.pro_recur <- stats_recur(proPlasma, proPlasmaMedi, 'Plasma', proPlasmaFeatAnno)
dia.tissue.pro_condi_Klin <- stats_condi(proTissue_Klin, proTissueMedi_Klin, 'Tissue',
                                         proTissueFeatAnno_Klin)
dia.tissue.pro_condi <- stats_condi(proTissue, proTissueMedi, 'Tissue', proTissueFeatAnno)
dia.plasma.pro_condi <- stats_condi(proPlasma, proPlasmaMedi, 'Plasma', proPlasmaFeatAnno)

# Store tables in a list for exporting them as an Excel file
featAssoSheets <- list(Recur_DIA.Tumor.Tissue.Pro.Klin = dia.tissue.pro_recur_Klin$tumorFeatAsso,
                       Recur_DIA.Norm.Tissue.Pro.Klin = dia.tissue.pro_recur_Klin$normalFeatAsso,
                       Recur_DIA.Tumor.Tissue.Pro.Krij = dia.tissue.pro_recur$tumorFeatAsso,
                       Recur_DIA.Norm.Tissue.Pro.Krij = dia.tissue.pro_recur$normalFeatAsso,
                       Recur_DIA.Base.Plasma.Pro.Krij = dia.plasma.pro_recur$baseFeatAsso,
                       Recur_DIA.Folo.Plasma.Pro.Krij = dia.plasma.pro_recur$foloFeatAsso,
                       Condi_DIA.Recur.Tissue.Pro.Klin = dia.tissue.pro_condi_Klin$recurrenceFeatAsso,
                       Condi_DIA.NonRe.Tissue.Pro.Klin = dia.tissue.pro_condi_Klin$nonrecurFeatAsso,
                       Condi_DIA.Recur.Tissue.Pro.Krij = dia.tissue.pro_condi$recurrenceFeatAsso,
                       Condi_DIA.NonRe.Tissue.Pro.Krij = dia.tissue.pro_condi$nonrecurFeatAsso,
                       Time_DIA.Recur.Plasma.Pro.Krij = dia.plasma.pro_condi$recurrenceFeatAsso,
                       Time_DIA.NonRe.Plasma.Pro.Krij = dia.plasma.pro_condi$nonrecurFeatAsso)
openxlsx::write.xlsx(featAssoSheets, file = './data/MethodDev/stats/featAsso/DIA_Pro.xlsx')
```
