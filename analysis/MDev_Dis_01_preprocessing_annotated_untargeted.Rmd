---
title: 'Preprocessing: Annotated Untargeted Lipidomics of Method Dev and Discovery cohorts'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Preprocess and merge Annotated Tissue Untargeted Lipidomics
of Method Development and Discovery cohorts provided by Dr. Qiuqin Zhou from AG
Hopf, including data cleansing, filtering (by RT, m/z, missing values, etc.), normalization
(VSN), and batch correction if needed. All needed information was then stored in
SummarizedExperiment objects for further analyses. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer')
```

Load libraries
```{r load libraries, message=F}
library(readr)
library(readxl)
library(vsn)
library(limma)
library(sva)
library(visdat)
library(ggrepel)
library(ggvenn)
library(SummarizedExperiment)
library(tidyverse)
# Load user-defined functions
source('./code/analysis_pipeline.R')
source('./code/misc.R')
source('./code/comparison_funcs.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
th4MissViz <- theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0,
                                               size = 11, face = 'bold'),
                    axis.text.y = element_blank(),
                    axis.title.y = element_text(size = 13, face = 'bold'),
                    legend.text = element_text(size = 12, face = 'bold'))
```

```{r prepare global info, message=F}
# Load sample metadata
smpMetadat <- readxl::read_excel('./data/metadata_latest/sample_metadata.xlsx')
colnames(smpMetadat) <- smpMetadat[3,, drop = F]
smpMetadat <- dplyr::slice(smpMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Parents, Visit, `Material submitted`, `Date and time of collection or surgery`,
                  `SMART-CARE cohort identifier`)) %>%
  dplyr::rename(Sample = Code, Patient = Parents, TimePoint = Visit, SmpType = `Material submitted`,
                Date = `Date and time of collection or surgery`, Cohort = `SMART-CARE cohort identifier`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^SC_T_S_|^SC_DIS_S_|^SC_VAL_S_|^SC_S_|_P'),
                Patient = stringr::str_remove(Patient, '^/THRX_SPACE/THRX_DB/'),
                TimePoint = dplyr::case_when(TimePoint == 'PRETHERAPEUTIC' ~ 'Baseline',
                                             TimePoint == 'FOLLOW-UP' ~ 'Follow-up',
                                             TimePoint == 'RECURRENCE' ~ 'Recurrence'),
                SmpType = dplyr::case_when(SmpType == 'EDTA_PLASMA' ~ 'Plasma',
                                           SmpType == 'FRESH_FROZEN_TISSUE' ~ 'Tissue'),
                Condition = dplyr::case_when(grepl('_TU|_TG', Sample) ~ 'Tumor',
                                             grepl('_NG', Sample) ~ 'Normal',
                                             !grepl('_TU|_TG|_NG', Sample) ~ TimePoint),
                TimePoint = dplyr::case_when(TimePoint %in% 'Recurrence' ~ 'Follow-up',
                                             !TimePoint %in% 'Recurrence' ~ TimePoint),
                Date = stringr::str_extract(Date, '^\\d+-\\d+-\\d+'),
                Cohort = dplyr::case_when(Cohort == 'DISCOVERY_COHORT' ~ 'Discovery',
                                          Cohort == 'METHOD_DEVELOPMENT_COHORT' ~ 'MethodDev',
                                          Cohort == 'VALIDATION_COHORT' ~ 'Validation'),
                Date = as.Date(Date, format = '%Y-%m-%d'))

# Load patient metadata
patientMetadat <- readxl::read_excel('./data/metadata_latest/patient_metadata.xlsx')
colnames(patientMetadat) <- patientMetadat[3,, drop = F]
patientMetadat <- dplyr::slice(patientMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Gender, `Age at diagnosis`, `Pathological stage`, `Smoking status`,
                  `Adjuvant chemotherapy`, Nutrition)) %>%
  dplyr::rename(Patient = Code, Age = `Age at diagnosis`, Stage = `Pathological stage`,
                Smoking = `Smoking status`, Adjuvant = `Adjuvant chemotherapy`) %>%
  dplyr::mutate(Gender = dplyr::case_when(Gender == 'MALE' ~ 'Male',
                                          Gender == 'FEMALE' ~ 'Female'),
                Smoking = dplyr::case_when(Smoking == 'SMOKER' ~ 'Smoker',
                                           Smoking == 'EX-SMOKER' ~ 'Ex-smoker',
                                           Smoking == 'NON-SMOKER' ~ 'Non-smoker'),
                Adjuvant = dplyr::case_when(Adjuvant == 'true' ~ 'True',
                                            Adjuvant == 'false' ~ 'False'),
                Age = as.numeric(Age),
                Nutrition = dplyr::case_when(Nutrition == 'WHOLE_FOOD' ~ 'Whole_food'))
# Include patient recurrence information in patient metadata
recurPats <- dplyr::filter(smpMetadat, Condition == 'Recurrence') %>%
  dplyr::pull(Patient)
patientMetadat <- dplyr::mutate(patientMetadat, Recurrence = dplyr::case_when(Patient %in% recurPats ~ 'Yes',
                                                                              !Patient %in% recurPats ~ 'No'))

# Load aliquot metadata
aliquotMetadat <- readxl::read_excel('./data/metadata_latest/aliquot_metadata.xlsx')
colnames(aliquotMetadat) <- aliquotMetadat[3,, drop = F]
aliquotMetadat <- dplyr::slice(aliquotMetadat, -c(1:3)) %>%
  dplyr::select(Code, Parents, `Tumor Cell Content (%)`, `Cohort Identifier`, `Submission to`,
                `Delivered?`) %>%
  dplyr::rename(Aliquot = Code, Sample = Parents, TumorPurity = `Tumor Cell Content (%)`,
                Cohort = `Cohort Identifier`, To = `Submission to`, Delivered = `Delivered?`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^/THRX_SPACE/THRX_DB/SC_T_S_|_P'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_VAL_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_VAL_'),
                Cohort = dplyr::case_when(Cohort == 'method establishment' ~ 'MethodDev',
                                          Cohort == 'DISCOVERY_COHORT' ~ 'Discovery',
                                          Cohort == 'VALIDATION_COHORT' ~ 'Validation'),
                TumorPurity = as.numeric(TumorPurity),
                TumorPurity = dplyr::case_when(grepl('_TU|_TG', Sample) ~ TumorPurity),
                # Mislabeling??
                Sample = case_when(Sample %in% 'SDIR55_NG' ~ 'PDIR55_NG',
                                   Sample %in% 'SDIR55_TU' ~ 'PDIR55_TU',
                                   Sample %in% 'SD4ADT_NG' ~ 'PD4ADT_NG',
                                   Sample %in% 'SD4ADT_TU' ~ 'PD4ADT_TU',
                                   !Sample %in% c('SDIR55_NG', 'SDIR55_TU',
                                                  'SD4ADT_NG', 'SD4ADT_TU') ~ Sample)) %>%
  dplyr::filter(To %in% 'HOPF')
# Prepare tumor purity information
tumorPurityInfo <- dplyr::select(aliquotMetadat, Sample, TumorPurity)

# Combine all needed metadata
# summMetadat <- dplyr::left_join(smpMetadat, patientMetadat, by = 'Patient') %>%
#   dplyr::left_join(tumorPurityInfo, by = 'Sample')
summMetadat <- dplyr::select(aliquotMetadat, Aliquot, Sample, TumorPurity) %>%
  dplyr::left_join(smpMetadat, by = 'Sample') %>%
  dplyr::left_join(patientMetadat, by = 'Patient')

# List sample annotations to keep in SE objects
smpAnno <- c('Patient', 'SmpType', 'TimePoint', 'Date', 'Cohort', 'Condition',
             'Recurrence', 'Gender', 'Age', 'Smoking', 'Stage', 'Adjuvant',
             'Nutrition', 'TumorPurity')
```

# Tissue Lipidomics

## Method Dev cohort

### Replicate1&2&3

```{r message=F}
# Load data
lipTissue_MDev <- readxl::read_excel(paste0('./data/Discovery/AG_Hopf/partial_annotated/',
                                            'Method development cohort tissue lipidomics',
                                            '_CH_with partial annotation_20240618.xlsx'))
# Assign column names
colnames(lipTissue_MDev) <- lipTissue_MDev[9,]
lipTissue_MDev <- lipTissue_MDev[-seq_len(9),]
# Tidy up data table, define features, and filter features based on RT and m/z
lipTissue_MDev <- dplyr::select(lipTissue_MDev, `RT [min]`, `CCS (Å²)`, `m/z meas.`,
                                Name, `Molecular Formula`, Flags, contains('Sample')) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas.`, Lipid = Name,
                Formula = `Molecular Formula`, Flag = Flags) %>%
  dplyr::mutate(across(contains('Sample'), as.numeric),
                RT = as.numeric(RT),
                CCS = as.numeric(CCS),
                MZ = as.numeric(MZ),
                Feature = paste0(RT, '/', CCS, '/', MZ),
                Flag = stringr::str_remove_all(Flag, '\\[|\\]')) %>%
  # SOME METABOLITES (?) WHOSE M/Z IS SMALLER THAN 250 ARE REMOVED?
  dplyr::filter(RT >= 0.3, RT <= 9, MZ >= 250) %>%
  dplyr::relocate(Feature)

# Convert data into long data and combine it with summarized metadata
# Prepare sample ID mapping table for mapping vial numbers to aliquot IDs
smpIdMappingTab <- readxl::read_excel('./data/Discovery/AG_Hopf/partial_annotated/MDev_TISSUE.Sample IDs.xlsx') %>%
  dplyr::select(`Code from OpenBis`, `Number on MS vials`) %>%
  dplyr::rename(Aliquot = `Code from OpenBis`, Vial = `Number on MS vials`) %>%
  dplyr::mutate(Vial = as.character(Vial))
lipTissue_MDev <- tidyr::pivot_longer(lipTissue_MDev, cols = -c('Feature', 'RT', 'CCS', 'MZ',
                                                                'Lipid', 'Formula', 'Flag'),
                                      names_to = 'Vial', values_to = 'Abundance') %>%
  dplyr::mutate(Vial = stringr::str_remove_all(Vial, 'Sample _|_lipids|_pos.+'),
                Batch = stringr::str_extract(Vial, '_batch\\d$'),
                Batch = dplyr::case_when(is.na(Batch) ~ 'Batch1',
                                         Batch == '_batch2' ~ 'Batch2',
                                         Batch == '_batch3' ~ 'Batch3'),
                Vial = stringr::str_remove(Vial, '_batch\\d$'),
                Abundance = replace(Abundance, Abundance == 0, NA)) %>%
  dplyr::left_join(smpIdMappingTab, by = 'Vial') %>%
  dplyr::left_join(summMetadat, by = 'Aliquot') %>%
  dplyr::select(-c(Vial, Aliquot)) %>%
  dplyr::mutate(Sample_Batch = paste0(Sample, '_', Batch))
```

<font size='4'> **Overview data before filtered by missingness** </font>
```{r}
# Overview data
lipTissueOriTab <- lipTissue_MDev
# Normalize data
lipTissuePrepro <- doPreprocessing(lipTissueOriTab, feat = 'Feature', smp = 'Sample_Batch',
                                   val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ',
                                                                   'Lipid', 'Formula', 'Flag'),
                                   smpAnno = c('Sample', smpAnno, 'Batch'), do_featFilt = F)
# Prepare data for visualization
lipTissueOri <- lipTissuePrepro$ori.data
lipTissueVsn <- lipTissuePrepro$vsn.data
lipTissueVsnTab <- summExp2df(lipTissueVsn, assay = 'Abundance', row_id = 'Feature', col_id = 'Sample_Batch')
# Show dimensions of data
cat('Data dimensions:', dim(lipTissueVsn)[2], 'samples (triplicates) and', dim(lipTissueVsn)[1], 'features')

# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueOri)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of unfiltered original data') +
  th4MissViz + theme(axis.text.x = element_text(size = 7))

# Visualize data distribution
ggplot(lipTissueOriTab, aes(x=Sample_Batch, y=Abundance)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(title = 'Distribution of unfiltered original data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6))

ggplot(lipTissueVsnTab, aes(x=Sample_Batch, y=Value)) +
  geom_boxplot() +
  labs(y = 'Log(Abundance)', title = 'Distribution of unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6))

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipTissueVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship after normalization') +
  th
```

<font size='4'> **Check whether there exists replicate effect** </font>\
**Hierarchical clustering**
```{r}
# Compute sample euclidean distances using top variable features
abunMat <- assay(lipTissueVsn)
featSDs <- rowSds(abunMat, na.rm = T)
topVarFeats <- names(sort(featSDs, decreasing = T)[1:1000])
abunMatSub <- abunMat[rownames(abunMat) %in% topVarFeats,]
d <- dist(t(abunMatSub), method = 'euclidean')

# Visualize sample distances by heatmap with clustering
colAnno <- dplyr::select(lipTissueVsnTab, Sample_Batch, Condition, Batch) %>%
  dplyr::filter(!duplicated(Sample_Batch)) %>%
  tibble::column_to_rownames('Sample_Batch') %>%
  dplyr::mutate(Batch = dplyr::case_when(Batch %in% 'Batch1' ~ 'Replicate1',
                                         Batch %in% 'Batch2' ~ 'Replicate2',
                                         Batch %in% 'Batch3' ~ 'Replicate3'))
pheatmap(as.matrix(d), annotation_col = colAnno, scale = 'row', #row scaling is across columns
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = 'ward.D2', fontsize_col = 6,
         annotation_colors = list(Batch = c(Replicate1 = 'grey30', Replicate2 = 'grey60', Replicate3 = 'grey90'),
                                  Condition = c(Tumor = '#d95f02', Normal = '#1b9e77')))

# Do hierarchical clustering
# hc <- hclust(d, method = 'ward.D2')
# Plot clustering result
# plot(hc, hang = 0.04, cex = 0.5, frame.plot = T, main = NULL)
```
-> 'H03Y07RT_TG' got tumor purity of 91%, but misclassified.

**PCA**
```{r}
# Do PCA
lipTissueVsnSub <- lipTissueVsn[rownames(lipTissueVsn) %in% topVarFeats,]
pcaRes <- doSOA(lipTissueVsnSub, meta_var = 'Batch', pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and batches
pcaRes$pcSigAssoRes %>%
  dplyr::mutate(Var2 = 'Replicate')
```

<font size='4'> **Overview merged data before filtered by missingness** </font>\
Merging triplicates can mitigate data missingness.
```{r message=F}
# Merge triplicates
# Prepare sample and feature metadata
smpAnnoTab <- tibble::as_tibble(colData(lipTissueVsn)) %>%
  dplyr::select(-Batch) %>%
  dplyr::distinct(Sample, .keep_all = T)
featAnnoTab <- tibble::as_tibble(rowData(lipTissueVsn), rownames = 'Feature')
# Take means of triplicates
merge_lipTissueVsnTab <- dplyr::group_by(lipTissueVsnTab, Feature, Sample) %>%
  dplyr::summarise(Value = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::left_join(featAnnoTab, by = 'Feature')
# Prepare data for visualization
merge_lipTissueVsn <- df2SummExp(merge_lipTissueVsnTab, row_id = 'Feature', col_id = 'Sample',
                                 values = 'Value', row_anno = c('RT', 'CCS', 'MZ',
                                                                'Lipid', 'Formula', 'Flag'),
                                 col_anno = smpAnno)

# Visualize data distribution
ggplot(merge_lipTissueVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(y = 'Log(Abundance)', title = 'Distribution of unfiltered merged normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(merge_lipTissueVsn)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of unfiltered merged normalized data') +
  th4MissViz
```

<font size='4'> **Remove features quantified in less than half of samples** </font>
```{r}
# Remove features quantified in less than certain percent of samples
rmFeats <- dplyr::group_by(merge_lipTissueVsnTab, Feature) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Value)) / length(Value), 2)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(frac_nonNA < 0.5) %>%
  dplyr::pull(Feature)
merge_lipTissueFiltVsnTab <- dplyr::filter(merge_lipTissueVsnTab, !Feature %in% rmFeats)

# Convert long data to SE object
lipTissueFiltVsn <- df2SummExp(merge_lipTissueFiltVsnTab, row_id = 'Feature', col_id = 'Sample',
                               values = 'Value', row_anno = c('RT', 'CCS', 'MZ',
                                                              'Lipid', 'Formula', 'Flag'),
                               col_anno = smpAnno)
saveRDS(lipTissueFiltVsn, './data/Discovery/AG_Hopf/partial_annotated/MDev_lipTissueVsn_Anno_B123.rds')
# Show dimensions of data
cat('Data dimensions:', dim(lipTissueFiltVsn)[2], 'samples and', dim(lipTissueFiltVsn)[1], 'features')

# Visualize data distribution
ggplot(merge_lipTissueFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(y = 'Log(Abundance)', title = 'Distribution of filtered merged normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueFiltVsn)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of filtered merged normalized data') +
  th4MissViz
```

The following annotated lipids are filtered out:\
(GREEN - Based on MS2; YELLOW - Based on MS1, other candidates possible)
```{r}
# Show identified lipids that are filtered out
featAnnoTab <- rowData(lipTissueVsn) %>%
  tibble::as_tibble(rownames = 'Feature')
rmLipids <- featAnnoTab[featAnnoTab$Feature %in% rmFeats, c('Lipid', 'Flag')] %>%
  dplyr::filter(!is.na(Lipid))
as.data.frame(rmLipids)
```

<font size='4'> **Do metadata-assisted quality control** </font>\
**Tumor vs Normal samples**
```{r}
# Do PCA
abunMat <- as.matrix(assay(lipTissueFiltVsn))
featSDs <- rowSds(abunMat, na.rm = T)
topVarFeats <- names(sort(featSDs, decreasing = T)[1:1000])
lipTissueFiltVsnSub <- lipTissueFiltVsn[rownames(lipTissueFiltVsn) %in% topVarFeats,]
pcaRes <- doSOA(lipTissueFiltVsnSub, meta_var = 'Condition', pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=Condition, y=`PC1 (13.6%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th
```

```{r message = F, include=F, eval=F}
# Store median normalized data for computing log2(FC) later
# Prepare sample and feature metadata
smpAnnoTab <- tibble::as_tibble(colData(lipTissueOri), rownames = 'Sample_Batch')
featAnnoTab <- tibble::as_tibble(rowData(lipTissueOri), rownames = 'Feature')
# Perform median normalization (log2-transformation followed by median scaling)
abunMat <- assay(lipTissueOri)
lipTissueMediTab <- log2(abunMat) %>%
  limma::normalizeBetweenArrays(method = 'scale') %>%
  tibble::as_tibble(rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample_Batch',
                      values_to = 'mediAbundance') %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample_Batch') %>%
  dplyr::left_join(featAnnoTab, by = 'Feature')
lipTissueMedi <- df2SummExp(lipTissueMediTab, row_id = 'Feature', col_id = 'Sample_Batch',
                            values = 'mediAbundance', row_anno = c('RT', 'CCS', 'MZ',
                                                                   'Lipid', 'Formula', 'Flag'),
                            col_anno = c('Sample', smpAnno, 'Batch'))
# Visualize data distribution
# ggplot(lipTissueMediTab, aes(x=Sample_Batch, y=mediAbundance)) +
#   geom_boxplot() +
#   labs(y = 'Log2(Abundance)', title = 'Median normalized data') +
#   th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6))

# Do hierarchical clustering to check if there exists batch effect
# Compute sample euclidean distances
abunMat <- as.matrix(assay(lipTissueMedi))
featSDs <- rowSds(abunMat, na.rm = T)
topVarFeats <- names(sort(featSDs, decreasing = T)[1:1000])
abunMatSub <- abunMat[rownames(abunMat) %in% topVarFeats,]
d <- dist(t(abunMatSub), method = 'euclidean')
# Visualize sample distances by heatmap with clustering
colAnno <- dplyr::select(lipTissueMediTab, Sample_Batch, Condition, Batch) %>%
  dplyr::filter(!duplicated(Sample_Batch)) %>%
  tibble::column_to_rownames('Sample_Batch')
# pheatmap(as.matrix(d), annotation_col = colAnno, scale = 'row', #row scaling is across columns
#          color = colorRampPalette(c('navy', 'white', 'red'))(100),
#          cluster_cols = T, cluster_rows = F, show_rownames = F,
#          clustering_method = 'ward.D2', fontsize_col = 6,
#          annotation_colors = list(Batch = c(Batch1 = 'grey30', Batch2 = 'grey60', Batch3 = 'grey90'),
#                                   Condition = c(Tumor = '#d95f02', Normal = '#1b9e77')))

# Merge data by taking means of triplicates
smpAnnoTab <- dplyr::select(smpAnnoTab, -c(Sample_Batch, Batch)) %>%
  dplyr::distinct(Sample, .keep_all = T)
merge_lipTissueMediTab <- dplyr::group_by(lipTissueMediTab, Feature, Sample) %>%
  dplyr::summarise(mediAbundance = mean(mediAbundance, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::left_join(featAnnoTab, by = 'Feature')
merge_lipTissueMedi <- df2SummExp(merge_lipTissueMediTab, row_id = 'Feature', col_id = 'Sample',
                                  values = 'mediAbundance', row_anno = c('RT', 'CCS', 'MZ',
                                                                         'Lipid', 'Formula', 'Flag'),
                                  col_anno = smpAnno)
# Visualize data distribution
# ggplot(merge_lipTissueMediTab, aes(x=Sample, y=mediAbundance)) +
#   geom_boxplot() +
#   labs(y = 'Log2(Abundance)', title = 'Merged median normalized data') +
#   th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Remove features quantified in less than certain percent of samples
rmFeats <- dplyr::group_by(merge_lipTissueMediTab, Feature) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(mediAbundance)) / length(mediAbundance), 2)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(frac_nonNA < 0.5) %>%
  dplyr::pull(Feature)
merge_lipTissueFiltMediTab <- dplyr::filter(merge_lipTissueMediTab, !Feature %in% rmFeats)
# Visualize data distribution
# ggplot(merge_lipTissueFiltMediTab, aes(x=Sample, y=mediAbundance)) +
#   geom_boxplot() +
#   labs(y = 'Log2(Abundance)', title = 'Filtered merged median normalized data') +
#   th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Convert long data to SE object
lipTissueFiltMedi <- df2SummExp(merge_lipTissueFiltMediTab, row_id = 'Feature', col_id = 'Sample',
                                values = 'mediAbundance', row_anno = c('RT', 'CCS', 'MZ',
                                                                       'Lipid', 'Formula', 'Flag'),
                                col_anno = smpAnno)
# saveRDS(lipTissueFiltMedi, './data/Discovery/AG_Hopf/partial_annotated/MDev_lipTissueMedi_Anno_B123.rds')

# Do metadata-assisted quality control
# Do PCA
abunMat <- as.matrix(assay(lipTissueFiltMedi))
featSDs <- rowSds(abunMat, na.rm = T)
topVarFeats <- names(sort(featSDs, decreasing = T)[1:500])
lipTissueFiltMediSub <- lipTissueFiltMedi[rownames(lipTissueFiltMedi) %in% topVarFeats,]
pcaRes <- doSOA(lipTissueFiltMediSub, meta_var = 'Condition', pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
# pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
# ggplot(pcTab, aes(x=Condition, y=`PC1 (13.6%)`, col=Condition, fill=Condition)) +
#   geom_boxplot(alpha = 0.7, outliers = F) +
#   geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
#   scale_color_brewer(palette = 'Dark2') +
#   scale_fill_brewer(palette = 'Dark2') +
#   th
```

### Replicate1

<font size='4'> **Overview original data** </font>
```{r}
# Extract Replicate1 data
lipTissueB1_MDev <- dplyr::filter(lipTissue_MDev, Batch == 'Batch1') %>%
  dplyr::select(-c(Sample_Batch, Batch))
# Preprocess data
lipTissueOriTab <- lipTissueB1_MDev
lipTissuePrepro <- doPreprocessing(lipTissueOriTab, feat = 'Feature', smp = 'Sample',
                                   val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ',
                                                                   'Lipid', 'Formula', 'Flag'),
                                   smpAnno = smpAnno, do_featFilt = T,
                                   cutoff = 0.5, viz_miss = T)
# saveRDS(lipTissuePrepro$vsn.data, './data/Discovery/AG_Hopf/partial_annotated/MDev_lipTissueVsn_Anno_B1.rds')
# saveRDS(lipTissuePrepro$medi.data, './data/Discovery/AG_Hopf/partial_annotated/MDev_lipTissueMedi_Anno_B1.rds')
# Show dimensions of data
cat('Data dimensions:', dim(lipTissuePrepro$ori.data)[2], 'samples and', dim(lipTissuePrepro$ori.data)[1], 'features')

# Visualize data missingness
lipTissuePrepro$ori.data.miss +
  labs(title = 'Missingness of original data')

# Visualize data distribution
lipTissuePrepro$ori.data.dist +
  labs(title = 'Distribution of original data')
```

<font size='4'> **Overview filtered vsn normalized data** </font>\
Features quantified in less than half of samples are removed.
```{r}
# Show dimensions of data
cat('Filtered data dimensions:', dim(lipTissuePrepro$filt.data)[2], 'samples and',
    dim(lipTissuePrepro$filt.data)[1], 'features')

# Visualize data missingness
lipTissuePrepro$filt.data.miss +
  labs(title = 'Missingness of filtered data')

# Visualize data distribution
lipTissuePrepro$vsn.data.dist +
  labs(y = 'Log(Abundance)', title = 'Distribution of filtered vsn normalized data')

# Visualize mean-sd relationship
lipTissuePrepro$vsn.feat.mean.var +
  labs(title = 'Feature mean-sd relationship after vsn normalization')
```

The following annotated lipids are filtered out:\
(GREEN - Based on MS2; YELLOW - Based on MS1, other candidates possible)
```{r}
# Show identified lipids that are filtered out
oriFeatSpace <- rownames(lipTissuePrepro$ori.data)
filtFeatSpace <- rownames(lipTissuePrepro$filt.data)
rmFeats <- oriFeatSpace[!oriFeatSpace %in% filtFeatSpace]
featAnnoTab <- rowData(lipTissuePrepro$ori.data) %>%
  tibble::as_tibble(rownames = 'Feature')
rmLipids <- featAnnoTab[featAnnoTab$Feature %in% rmFeats, c('Lipid', 'Flag')] %>%
  dplyr::filter(!is.na(Lipid))
DT::datatable(rmLipids)
```

<font size='4'> **Do metadata-assisted quality control** </font>\
**Tumor vs Normal samples**
```{r}
# Do PCA
lipTissueFiltVsn <- lipTissuePrepro$vsn.data
abunMat <- as.matrix(assay(lipTissueFiltVsn))
featSDs <- rowSds(abunMat, na.rm = T)
topVarFeats <- names(sort(featSDs, decreasing = T)[1:1000])
lipTissueFiltVsnSub <- lipTissueFiltVsn[rownames(lipTissueFiltVsn) %in% topVarFeats,]
pcaRes <- doSOA(lipTissueFiltVsnSub, meta_var = 'Condition', pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=Condition, y=`PC1 (14.2%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th
```

## Discovery cohort

```{r message=F}
# Load data
lipTissue_Dis <- readxl::read_excel(paste0('./data/Discovery/AG_Hopf/partial_annotated/',
                                           'Discovery cohort_tissue lipidomics',
                                           '_CH_with partial annotation_20240618_QZ.xlsx'))
# Assign column names
lipTissue_Dis <- lipTissue_Dis[, -seq_len(2)]
colnames(lipTissue_Dis) <- lipTissue_Dis[8,]
lipTissue_Dis <- lipTissue_Dis[-seq_len(9),]
# Tidy up data table, define features, and filter features based on RT and m/z
lipTissue_Dis <- dplyr::select(lipTissue_Dis, -c(Ions, `ΔCCS [%]`, AQ, `Δm/z [ppm]`,
                                                 `M meas.`, `MS/MS`, `MS/MS score`,
                                                 `Mob. 1/K0`, contains('Pooled QC'),
                                                 contains('Processed blank'))) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas.`, Lipid = Name,
                Formula = `Molecular Formula`, Flag = Flags) %>%
  dplyr::mutate(across(contains('SC_'), as.numeric),
                RT = as.numeric(RT),
                CCS = as.numeric(CCS),
                MZ = as.numeric(MZ),
                Feature = paste0(RT, '/', CCS, '/', MZ),
                Flag = stringr::str_remove_all(Flag, '\\[|\\]')) %>%
  # RT <= 9 IS NOT USED DUE TO GREEN ANNOTATED LIPIDS
  dplyr::filter(RT >= 0.3, MZ >= 250, !is.na(MZ), Flag != 'RED, GREEN') %>% #RT <= 9
  dplyr::relocate(Feature)

# Convert data into long data and combine it with summarized metadata
lipTissue_Dis <- tidyr::pivot_longer(lipTissue_Dis, cols = -c('Feature', 'RT', 'CCS', 'MZ',
                                                              'Lipid', 'Formula', 'Flag'),
                                     names_to = 'Aliquot', values_to = 'Abundance') %>%
  dplyr::mutate(Aliquot = stringr::str_remove(Aliquot, '_pos_.+$'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Mislabeling??
                Aliquot = dplyr::case_when(Aliquot %in% 'SC_DIS_A_PDIR55_TU3' ~ 'SC_DIS_A_PDIR55_TU2',
                                           Aliquot %in% 'SC_DIS_A_1QFJ7P_TU3' ~ 'SC_DIS_A_1QFJ7P_TU1',
                                           Aliquot %in% 'SC_DIS_A_8ZSMVV_NG1' ~ 'SC_DIS_A_8ZSMVV_NG3',
                                           !Aliquot %in% c('SC_DIS_A_PDIR55_TU3', 'SC_DIS_A_1QFJ7P_TU3',
                                                           'SC_DIS_A_8ZSMVV_NG1') ~ Aliquot)) %>%
  dplyr::left_join(summMetadat, by = 'Aliquot') %>%
  dplyr::select(-Aliquot) %>%
  # Compute sample missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MissLevel = sum(is.na(Abundance)) / length(Abundance)) %>%
  dplyr::ungroup()

# Remove tumor samples with low tumor purity
proTissue <- readRDS('./data/Discovery/AG_Krijgsveld/proTissueVsn.rds')
goodSmps <- colnames(proTissue)
allSmps <- unique(lipTissue_Dis$Sample)
badSmps <- allSmps[!allSmps %in% goodSmps]
# Manually remove '1HTNWJ_TU' sample from bad quality sample list due to its missingness
# in good quality sample list
badSmps <- badSmps[-which(badSmps == '1HTNWJ_TU')]
badSmps <- badSmps[grepl('_TU', badSmps)]
# lipTissue_Dis <- dplyr::filter(lipTissue_Dis, !Sample %in% badSmps)
```

<font size='4'> **Overview original data** </font>
```{r}
# Preprocess data
lipTissueOriTab <- lipTissue_Dis
lipTissuePrepro <- doPreprocessing(lipTissueOriTab, feat = 'Feature', smp = 'Sample',
                                   val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ',
                                                                   'Lipid', 'Formula', 'Flag'),
                                   smpAnno = c(smpAnno, 'MissLevel'),
                                   do_featFilt = T, cutoff = 0.5, viz_miss = T)
# saveRDS(lipTissuePrepro$vsn.data, './data/Discovery/AG_Hopf/partial_annotated/Dis_lipTissueVsn_Anno.rds')
# saveRDS(lipTissuePrepro$medi.data, './data/Discovery/AG_Hopf/partial_annotated/Dis_lipTissueMedi_Anno.rds')
# Show dimensions of data
cat('Data dimensions:', dim(lipTissuePrepro$ori.data)[2], 'samples and', dim(lipTissuePrepro$ori.data)[1], 'features')

# Visualize data missingness
lipTissuePrepro$ori.data.miss +
  labs(title = 'Missingness of original data') +
  theme(axis.text.x = element_text(size = 6))

# Visualize data distribution
lipTissuePrepro$ori.data.dist +
  labs(title = 'Distribution of original data') +
  theme(axis.text.x = element_text(size = 6))
```

<font size='4'> **Overview filtered vsn normalized data** </font>\
Features quantified in less than half of samples are removed.
```{r}
# Show dimensions of data
cat('Filtered data dimensions:', dim(lipTissuePrepro$filt.data)[2], 'samples and',
    dim(lipTissuePrepro$filt.data)[1], 'features')
# Visualize data missingness
lipTissuePrepro$filt.data.miss +
  labs(title = 'Missingness of filtered data') +
  theme(axis.text.x = element_text(size = 6))

# Visualize data distribution
lipTissuePrepro$vsn.data.dist +
  labs(y = 'Log(Abundance)', title = 'Distribution of filtered vsn normalized data') +
  theme(axis.text.x = element_text(size = 6))

# Visualize mean-sd relationship
lipTissuePrepro$vsn.feat.mean.var +
  labs(title = 'Feature mean-sd relationship after vsn normalization')
```

The following annotated lipids are filtered out:\
(GREEN - Based on MS2; YELLOW - Based on MS1, other candidates possible)
```{r}
# Show identified lipids that are filtered out
oriFeatSpace <- rownames(lipTissuePrepro$ori.data)
filtFeatSpace <- rownames(lipTissuePrepro$filt.data)
rmFeats <- oriFeatSpace[!oriFeatSpace %in% filtFeatSpace]
featAnnoTab <- rowData(lipTissuePrepro$ori.data) %>%
  tibble::as_tibble(rownames = 'Feature')
rmLipids <- featAnnoTab[featAnnoTab$Feature %in% rmFeats, c('Lipid', 'Flag')] %>%
  dplyr::filter(!is.na(Lipid))
DT::datatable(rmLipids)
```

<font size='4'> **Do metadata-assisted quality control** </font>\
**Tumor vs Normal samples**
```{r}
# Do PCA
lipTissueFiltVsn <- lipTissuePrepro$vsn.data
abunMat <- as.matrix(assay(lipTissueFiltVsn))
featSDs <- rowSds(abunMat, na.rm = T)
topVarFeats <- names(sort(featSDs, decreasing = T)[1:1000])
lipTissueFiltVsnSub <- lipTissueFiltVsn[rownames(lipTissueFiltVsn) %in% topVarFeats,]
pcaRes <- doSOA(lipTissueFiltVsnSub, meta_var = c('Condition', 'MissLevel'), pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes$pcSigAssoRes
# Visualize PCs
# Prepare samples to be labeled
labelSmps <- gsub('_TU', '_NG', badSmps)
labelSmps <- c(labelSmps, badSmps)
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Label = dplyr::case_when(Sample %in% labelSmps ~ Sample),
                Extra = dplyr::case_when(Sample %in% labelSmps ~ 'Yes',
                                         !Sample %in% labelSmps ~ 'No'),
                TumorPurity = dplyr::case_when(Condition == 'Normal' ~ NA,
                                               Condition == 'Tumor' ~ TumorPurity))
ggplot(pcTab, aes(x=Condition, y=`PC1 (39.8%)`, col=Condition, fill=Condition, label=Label)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  # geom_text_repel(size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

ggplot(pcTab, aes(x=Condition, y=`PC3 (11.9%)`, col=Condition, fill=Condition, label=Label)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  # geom_text_repel(size = 3, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

ggplot(pcTab, aes(x=`PC1 (39.8%)`, y=`PC3 (11.9%)`, col=Condition, shape=Extra)) +
  geom_point(size = 2.5) +
  scale_color_brewer(palette = 'Dark2') +
  scale_shape_manual(name = 'Extra samples', values = c(16, 3)) +
  th

ggplot(pcTab, aes(x=`PC1 (39.8%)`, y=`PC3 (11.9%)`, col=MissLevel, shape=Condition)) +
  geom_point(size = 2.5) +
  scale_color_continuous(name = 'Missing level (%)', type = 'viridis') +
  scale_shape_manual(values = c(0, 16)) +
  th

ggplot(pcTab, aes(x=`PC1 (39.8%)`, y=`PC3 (11.9%)`, col=TumorPurity, shape=Condition)) +
  geom_point(size = 2.5) +
  scale_color_continuous(name = 'Tumor purity (%)') +
  scale_shape_manual(values = c(0, 16)) +
  th
```

## Combined data
Method Dev + Discovery cohort

```{r}
# Keep duplicated annotated features with maximal abundances
rmDupLips <- function(summExp) {
  lipids <- rowData(summExp)$Lipid
  dupLipids <- unique(lipids[duplicated(lipids)])
  rmLipids <- c()
  for (lip in dupLipids) {
    datMat <- assay(summExp)
    orderedLips <- apply(datMat[lipids %in% lip,], 1, function (lipVec) {
      mean(lipVec, na.rm = T)
    }) %>%
      sort(decreasing = T) %>%
      names()
    rmLipids <- c(rmLipids, orderedLips[-1])
  }
  summExp <- summExp[!rownames(summExp) %in% rmLipids,]
  longDat <- summExp2df(summExp, row_id = 'Feature', col_id = 'Sample') %>%
    dplyr::select(-Feature)
  return(longDat)
}
```

### MDev (Prepro, Rep1&2&3) + Dis
Merge Preprocessed Method Dev (Replicate1&2&3) and Discovery data

```{r}
# Load preprocessed data
lipTissueVsnB123_MDev <- readRDS('./data/Discovery/AG_Hopf/partial_annotated/MDev_lipTissueVsn_Anno_B123.rds')
lipTissueVsn_Dis <- readRDS('./data/Discovery/AG_Hopf/partial_annotated/Dis_lipTissueVsn_Anno.rds')
# Prepare list of common annotated features
lipids_MDev <- rowData(lipTissueVsnB123_MDev)$Lipid
lipids_Dis <- rowData(lipTissueVsn_Dis)$Lipid
cmnLipids <- intersect(lipids_MDev, lipids_Dis)
# Subset datasets by common annotated features
lipTissueVsnB123_MDev <- lipTissueVsnB123_MDev[!is.na(lipids_MDev) & lipids_MDev %in% cmnLipids,]
lipTissueVsn_Dis <- lipTissueVsn_Dis[!is.na(lipids_Dis) & lipids_Dis %in% cmnLipids,]
# Keep duplicated annotated features with maximal abundances
annoLipTissueVsnB123_MDev <- rmDupLips(lipTissueVsnB123_MDev)
annoLipTissueVsn_Dis <- rmDupLips(lipTissueVsn_Dis)
# Combine datasets
combLipTissue <- dplyr::bind_rows(annoLipTissueVsnB123_MDev, annoLipTissueVsn_Dis) %>%
  dplyr::select(-MissLevel)
# Convert long data to SE object
combLipTissueVsn <- df2SummExp(combLipTissue, row_id = 'Lipid', col_id = 'Sample',
                               values = 'Value', row_anno = c('Formula', 'Flag'),
                               col_anno = smpAnno)
```

<font size='4'> **Do metadata-assisted quality control** </font>\
**Tumor vs Normal samples**
```{r}
# Do PCA
pcaRes <- doSOA(combLipTissueVsn, meta_var = c('Cohort', 'Condition'),
                pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(pcTab, aes(x=`PC1 (46.8%)`, y=`PC2 (21.1%)`, col=Cohort, shape=Condition)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th
```

<font size='4'> **Do batch correction using limma** </font>\
```{r}
# Perform batch correction to see if two cohorts can be merged
# Extract data matrix from SE object
datMat <- as.matrix(assay(combLipTissueVsn))
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab <- as_tibble(colData(combLipTissueVsn), rownames = 'Sample')
design <- model.matrix(~ Condition + Recurrence + Cohort, data = smpAnnoTab)
wantedDesign <- design[, seq_len(3)]
unwantedDesign <- design[, -seq_len(3)]
# Do batch correction
datMat_BC <- limma::removeBatchEffect(datMat, design = wantedDesign, covariates = unwantedDesign)
combLipTissueVsn_BC <- combLipTissueVsn
assay(combLipTissueVsn_BC) <- datMat_BC
# Save batch corrected data
# saveRDS(combLipTissueVsn_BC, './data/Discovery/AG_Hopf/partial_annotated/Comb_Prepro_lipTissueVsn_Anno_MDevB123_BC.rds')
# saveRDS(combLipTissueVsn, './data/Discovery/AG_Hopf/partial_annotated/Comb_Prepro_lipTissueVsn_Anno_MDevB123.rds')

# Do single-omics analysis
pcaRes <- doSOA(combLipTissueVsn_BC, meta_var = c('Condition', 'Cohort'), pca_method = 'ppca', do_onlyPCA = T)
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(pcTab, aes(x=Condition, y=`PC1 (36.6%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

ggplot(pcTab, aes(x=`PC1 (36.6%)`, y=`PC2 (18.3%)`, col=Cohort, shape=Condition)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th
```

### MDev (Raw, Rep1&2&3) + Dis
Replicates in Method Dev data are merged on Raw intensity level, which may be not
reliable due to highly variable values.

```{r}
# Prepare tidy data containing only annotated features
annoLipTissueB123_MDev <- dplyr::group_by(lipTissue_MDev, Feature, Sample) %>%
  dplyr::mutate(Abundance = mean(Abundance, na.rm = T),
                Feature_Sample = paste0(Feature, '_', Sample)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(!duplicated(Feature_Sample)) %>%
  dplyr::select(-c(Sample_Batch, Batch, Feature_Sample)) %>%
  dplyr::filter(!is.na(Lipid)) %>%
  dplyr::select(-c(RT, CCS, MZ)) %>%
  dplyr::mutate(Abundance = dplyr::case_when(is.nan(Abundance) ~ NA,
                                             !is.nan(Abundance) ~ Abundance))
annoLipTissueB1_MDev <- dplyr::filter(lipTissueB1_MDev, !is.na(Lipid)) %>%
  dplyr::select(-c(RT, CCS, MZ))
annoLipTissue_Dis <- dplyr::select(lipTissue_Dis, -MissLevel) %>%
  dplyr::filter(!is.na(Lipid)) %>%
  dplyr::select(-c(RT, CCS, MZ))
# Keep only common annotated features between cohort data
cmnFeats <- intersect(unique(annoLipTissueB123_MDev$Lipid), unique(annoLipTissue_Dis$Lipid))
annoLipTissueB123_MDev <- dplyr::filter(annoLipTissueB123_MDev, Lipid %in% cmnFeats)
annoLipTissueB1_MDev <- dplyr::filter(annoLipTissueB1_MDev, Lipid %in% cmnFeats)
annoLipTissue_Dis <- dplyr::filter(annoLipTissue_Dis, Lipid %in% cmnFeats)
# Keep duplicated annotated features with maximal abundances
tmp_lipTissueB123_MDev <- df2SummExp(annoLipTissueB123_MDev, row_id = 'Feature', col_id = 'Sample',
                                     values = 'Abundance', row_anno = c('Lipid', 'Formula', 'Flag'),
                                     col_anno = smpAnno)
tmp_lipTissueB1_MDev <- df2SummExp(annoLipTissueB1_MDev, row_id = 'Feature', col_id = 'Sample',
                                   values = 'Abundance', row_anno = c('Lipid', 'Formula', 'Flag'),
                                   col_anno = smpAnno)
tmp_lipTissue_Dis <- df2SummExp(annoLipTissue_Dis, row_id = 'Feature', col_id = 'Sample',
                                values = 'Abundance', row_anno = c('Lipid', 'Formula', 'Flag'),
                                col_anno = smpAnno)

annoLipTissueB123_MDev <- rmDupLips(tmp_lipTissueB123_MDev)
annoLipTissueB1_MDev <- rmDupLips(tmp_lipTissueB1_MDev)
annoLipTissue_Dis <- rmDupLips(tmp_lipTissue_Dis)
rm(tmp_lipTissueB123_MDev, tmp_lipTissueB1_MDev, tmp_lipTissue_Dis)
```

<font size='4'> **Overview original data** </font>
```{r}
# Combine datasets and do preprocessing
combLipTissue <- dplyr::bind_rows(annoLipTissueB123_MDev, annoLipTissue_Dis)
combLipTissuePrepro <- doPreprocessing(combLipTissue, feat = 'Lipid', smp = 'Sample',
                                       val = 'Value', featAnno = c('Formula', 'Flag'),
                                       smpAnno = smpAnno, do_featFilt = T,
                                       cutoff = 0.5, viz_miss = T, bins = 20)
# Show dimensions of data
cat('Data dimensions:', dim(combLipTissuePrepro$ori.data)[2], 'samples and',
    dim(combLipTissuePrepro$ori.data)[1], 'features')

# Visualize data missingness
combLipTissuePrepro$ori.data.miss +
  labs(title = 'Missingness of original data') +
  theme(axis.text.x = element_text(size = 5))

# Visualize data distribution
oriDatTab <- summExp2df(combLipTissuePrepro$ori.data, row_id = 'Lipid', col_id = 'Sample') %>%
  dplyr::mutate(Sample = factor(Sample, levels = c(unique(annoLipTissueB123_MDev$Sample),
                                                   unique(annoLipTissue_Dis$Sample))),
                Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(oriDatTab, aes(x=Sample, y=Value, col=Cohort)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Abundance', title = 'Distribution of original data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 4))
```

<font size='4'> **Overview filtered vsn normalized data** </font>\
Features quantified in less than half of samples are removed.
```{r}
# Show dimensions of data
cat('Filtered data dimensions:', dim(combLipTissuePrepro$filt.data)[2], 'samples and',
    dim(combLipTissuePrepro$filt.data)[1], 'features')
# Visualize data missingness
combLipTissuePrepro$filt.data.miss +
  labs(title = 'Missingness of filtered data') +
  theme(axis.text.x = element_text(size = 5))

# Visualize data distribution
vsnDatTab <- summExp2df(combLipTissuePrepro$vsn.data, row_id = 'Lipid', col_id = 'Sample') %>%
  dplyr::mutate(Sample = factor(Sample, levels = c(unique(annoLipTissueB123_MDev$Sample),
                                                   unique(annoLipTissue_Dis$Sample))),
                Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(vsnDatTab, aes(x=Sample, y=Value, col=Cohort)) +
  geom_boxplot() +
  labs(y = 'Log(Abundance)', title = 'Distribution of filtered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 4))

# Visualize mean-sd relationship
combLipTissuePrepro$vsn.feat.mean.var +
  labs(title = 'Feature mean-sd relationship after vsn normalization')
```

The following annotated lipids are filtered out:\
(GREEN - Based on MS2; YELLOW - Based on MS1, other candidates possible)
```{r}
# Show identified lipids that are filtered out
oriFeatSpace <- rownames(combLipTissuePrepro$ori.data)
filtFeatSpace <- rownames(combLipTissuePrepro$filt.data)
rmFeats <- oriFeatSpace[!oriFeatSpace %in% filtFeatSpace]
rowData(combLipTissuePrepro$ori.data) %>%
  tibble::as_tibble(rownames = 'Lipid') %>%
  dplyr::filter(Lipid %in% rmFeats)
```

<font size='4'> **Do metadata-assisted quality control** </font>\
**Tumor vs Normal samples**
```{r}
# Do PCA
pcaRes <- doSOA(combLipTissuePrepro$vsn.data, meta_var = c('Cohort', 'Condition'),
                pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(pcTab, aes(x=`PC1 (42.3%)`, y=`PC2 (19.8%)`, col=Cohort, shape=Condition)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th
```

<font size='4'> **Do batch correction using limma** </font>\
```{r}
# Perform batch correction to see if two cohorts can be merged
# Extract data matrix from SE object
datMat <- assay(combLipTissuePrepro$vsn.data)
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab <- as_tibble(colData(combLipTissuePrepro$vsn.data), rownames = 'Sample')
design <- model.matrix(~ Condition + Recurrence + Cohort, data = smpAnnoTab)
wantedDesign <- design[, seq_len(3)]
unwantedDesign <- design[, -seq_len(3)]
# Do batch correction
datMat_BC <- limma::removeBatchEffect(datMat, design = wantedDesign, covariates = unwantedDesign)
combLipTissueVsn_BC <- combLipTissuePrepro$vsn.data
assay(combLipTissueVsn_BC) <- datMat_BC
# Save batch corrected data
# saveRDS(combLipTissueVsn_BC, './data/Discovery/AG_Hopf/partial_annotated/Comb_lipTissueVsn_Anno_MDevB123_BC.rds')

# Do single-omics analysis
pcaRes <- doSOA(combLipTissueVsn_BC, meta_var = c('Condition', 'Cohort'), pca_method = 'ppca', do_onlyPCA = T)
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(pcTab, aes(x=Condition, y=`PC1 (33.8%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

ggplot(pcTab, aes(x=`PC1 (33.8%)`, y=`PC3 (8.9%)`, col=Cohort, shape=Condition)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th
```

### MDev (Rep1) + Dis

<font size='4'> **Overview original data** </font>
```{r}
# Combine datasets and do preprocessing
combLipTissue <- dplyr::bind_rows(annoLipTissueB1_MDev, annoLipTissue_Dis)
combLipTissuePrepro <- doPreprocessing(combLipTissue, feat = 'Lipid', smp = 'Sample',
                                       val = 'Value', featAnno = c('Formula', 'Flag'),
                                       smpAnno = smpAnno, do_featFilt = T,
                                       cutoff = 0.5, viz_miss = T, bins = 20)
# Show dimensions of data
cat('Data dimensions:', dim(combLipTissuePrepro$ori.data)[2], 'samples and',
    dim(combLipTissuePrepro$ori.data)[1], 'features')

# Visualize data missingness
combLipTissuePrepro$ori.data.miss +
  labs(title = 'Missingness of original data') +
  theme(axis.text.x = element_text(size = 5))

# Visualize data distribution
oriDatTab <- summExp2df(combLipTissuePrepro$ori.data, row_id = 'Lipid', col_id = 'Sample') %>%
  dplyr::mutate(Sample = factor(Sample, levels = c(unique(annoLipTissueB1_MDev$Sample),
                                                   unique(annoLipTissue_Dis$Sample))),
                Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(oriDatTab, aes(x=Sample, y=Value, col=Cohort)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Abundance', title = 'Distribution of original data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 4))
```

<font size='4'> **Overview filtered vsn normalized data** </font>\
Features quantified in less than half of samples are removed.
```{r}
# Show dimensions of data
cat('Filtered data dimensions:', dim(combLipTissuePrepro$filt.data)[2], 'samples and',
    dim(combLipTissuePrepro$filt.data)[1], 'features')
# Visualize data missingness
combLipTissuePrepro$filt.data.miss +
  labs(title = 'Missingness of filtered data') +
  theme(axis.text.x = element_text(size = 5))

# Visualize data distribution
vsnDatTab <- summExp2df(combLipTissuePrepro$vsn.data, row_id = 'Lipid', col_id = 'Sample') %>%
  dplyr::mutate(Sample = factor(Sample, levels = c(unique(annoLipTissueB1_MDev$Sample),
                                                   unique(annoLipTissue_Dis$Sample))),
                Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(vsnDatTab, aes(x=Sample, y=Value, col=Cohort)) +
  geom_boxplot() +
  labs(y = 'Log(Abundance)', title = 'Distribution of filtered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 4))

# Visualize mean-sd relationship
combLipTissuePrepro$vsn.feat.mean.var +
  labs(title = 'Feature mean-sd relationship after vsn normalization')
```

The following annotated lipids are filtered out:\
(GREEN - Based on MS2; YELLOW - Based on MS1, other candidates possible)
```{r}
# Show identified lipids that are filtered out
oriFeatSpace <- rownames(combLipTissuePrepro$ori.data)
filtFeatSpace <- rownames(combLipTissuePrepro$filt.data)
rmFeats <- oriFeatSpace[!oriFeatSpace %in% filtFeatSpace]
rowData(combLipTissuePrepro$ori.data) %>%
  tibble::as_tibble(rownames = 'Lipid') %>%
  dplyr::filter(Lipid %in% rmFeats)
```

<font size='4'> **Do metadata-assisted quality control** </font>\
**Tumor vs Normal samples**
```{r}
# Do PCA
pcaRes <- doSOA(combLipTissuePrepro$vsn.data, meta_var = c('Cohort', 'Condition'),
                pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample conditions
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(pcTab, aes(x=`PC1 (39.8%)`, y=`PC2 (20.8%)`, col=Cohort, shape=Condition)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th
```

<font size='4'> **Do batch correction using limma** </font>\
```{r}
# Perform batch correction to see if two cohorts can be merged
# Extract data matrix from SE object
datMat <- assay(combLipTissuePrepro$vsn.data)
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab <- as_tibble(colData(combLipTissuePrepro$vsn.data), rownames = 'Sample')
design <- model.matrix(~ Condition + Recurrence + Cohort, data = smpAnnoTab)
wantedDesign <- design[, seq_len(3)]
unwantedDesign <- design[, -seq_len(3)]
# Do batch correction
datMat_BC <- limma::removeBatchEffect(datMat, design = wantedDesign, covariates = unwantedDesign)
combLipTissueVsn_BC <- combLipTissuePrepro$vsn.data
assay(combLipTissueVsn_BC) <- datMat_BC
# Save batch corrected data
# saveRDS(combLipTissueVsn_BC, './data/Discovery/AG_Hopf/partial_annotated/Comb_lipTissueVsn_Anno_MDevB1_BC.rds')

# Do single-omics analysis
pcaRes <- doSOA(combLipTissueVsn_BC, meta_var = c('Condition', 'Cohort'), pca_method = 'ppca', do_onlyPCA = T)
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Cohort = factor(Cohort, levels = c('MethodDev', 'Discovery')))
ggplot(pcTab, aes(x=Condition, y=`PC1 (34.1%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

ggplot(pcTab, aes(x=`PC1 (34.1%)`, y=`PC2 (16.1%)`, col=Cohort, shape=Condition)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th
```
