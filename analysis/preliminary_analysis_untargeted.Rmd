---
title: 'Single-omics analysis: Method development lung cancer patient cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Conduct univariate (association test) and multivariate
(PCA) analyses on individual datasets, Plasma and Tissue Untargeted Metabolomics
and Lipidomics generated by AG Hopf, to take an initial look at power of each dataset
in terms of predicting patient cancer recurrences and also potentially to provide
evidence for latter multi-omics analyses. Association test between each feature
(metabolite and lipid level) and cancer recurrence was performed to capture
significant features that can separate recurrence and non-recurrence patients. PCA
was performed to see if there is any significant PC that can separate recurrence
and non-recurrence patients.\

Update: Perform association tests between PCs and some other metadata variables,
such as patient genders, diagnosis ages, etc. </font>

**Metadata variables**\
Patient:\
Gender -> Male:Female = 13:7\
Age -> Diagnosis ages ranging from 56 to 84\
Smoking -> Smoker:Ex-smoker:Non-Smoker = 3:14:3\
Recurrence -> Cancer recurrences, Yes:No = 1:1\
Stage -> Pathological stages, IB:IIA:IIB = 16:1:3\
Metastasis -> Derived from stages, whether cancer cells spread to lymph nodes, Yes:No = 3:17\
Sample:\
Condition -> Baseline:Follow-up:Recurrence = 2:1:1, Tumor:Normal = 1:1\
TimePoint -> Time points that samples were collected at, Baseline:2 years later = 1:1

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_MethodDev')
```

Load libraries
```{r library loading, message = F}
library('SummarizedExperiment')
library('pcaMethods')
library('proDA')
library('limma')
library('ggrepel')
library('ggfortify')
library('openxlsx')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

Test associations between patient Cancer Recurrence and other metadata variables
to see if there is any variable significantly associated with Recurrence, could be
predictor or potential confounder?
```{r}
# Test associations between metadata variables
# Prepare sample metadata
metaPlasmaVsn <- readRDS('./data/AG_Hopf/metaPlasmaVsn.rds')
metadat <- tibble::as_tibble(colData(metaPlasmaVsn)) %>%
  dplyr::select(Patient, Recurrence, Gender, Age, Smoking, Stage) %>%
  dplyr::filter(!duplicated(Patient)) #%>%
  # dplyr::mutate(
  #   Metastasis = case_when(
  #     Stage == 'IIB' ~ 'Yes',
  #     Stage != 'IIB' ~ 'No'
  #   ))
recur <- dplyr::select(metadat, Patient, Recurrence)

# Conduct association test
assoRes <- testAsso(metadat, recur, cmn_col = 'Patient') %>%
  dplyr::mutate(Var1 = stringr::str_remove(Var1, '\\.x'),
                Var2 = stringr::str_remove(Var2, '\\.y')) %>%
  dplyr::filter(Var1 != Var2) %>%
  # Remove duplicated variable pairs
  # dplyr::rowwise() %>%
  # dplyr::mutate(varPair = paste(sort(c(Var1, Var2)), collapse = '')) %>%
  # dplyr::distinct(varPair, .keep_all = T) %>%
  dplyr::select(Var1, Var2, pVal, pValAdj, Test) %>%
  as.data.frame()
assoRes
```

# Plasma Metabolomics
Based on PCA result obtained by analyzing whole Plasma Metabolomics dataset that
includes Baseline and Follow-up samples, we found that PCA mainly captures source
of variation in time points, the unwanted variation. Besides, we attempt to identify
biomarkers that can predict whether patients WILL suffer from cancer recurrence or
not. Therefore, we decided to analyze Baseline and Follow-up samples separately.

```{r}
# Load normalized data
metaPlasmaVsn <- readRDS('./data/AG_Hopf/metaPlasmaVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(metaPlasmaVsn), rownames = 'Feature')
# Manually modify metadata information (time point, metastasis)
tmp_metadata <- as.data.frame(colData(metaPlasmaVsn)) %>%
  dplyr::mutate(
    TimePoint = dplyr::case_when(
      Condition == 'Baseline' ~ 'Baseline',
      Condition != 'Baseline' ~ '2 years later'
      ),
    Metastasis = case_when(
      Stage == 'IIB' ~ 'Yes',
      Stage != 'IIB' ~ 'No'
    ))
colData(metaPlasmaVsn)['TimePoint'] <- tmp_metadata$TimePoint
colData(metaPlasmaVsn)['Metastasis'] <- tmp_metadata$Metastasis

# Perform analysis
metaPlasmaRes <- doSOA(metaPlasmaVsn, meta_var = c('Recurrence', 'Gender', 'Age',
                                                   'Condition', 'TimePoint', 'Smoking',
                                                   'Stage', 'Metastasis'),
                       do_onlyPCA = T, pca_method = 'ppca')
tPCASigRes <- metaPlasmaRes$tPCASigRes
pcaRes <- metaPlasmaRes$pcaRes
pcTab <- metaPlasmaRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variable
(Var2). Note that each patient has two samples that have same patient annotations,
so association test results may have additive effects. Besides, some patient annotations
are only meaningful at Baseline time point, such as diagnosis ages, pathological stages, etc.
```{r}
# Display PCs of interest
tPCASigRes
```

PC1 explains most variation in data and separates patient samples by time points.
```{r}
ggplot(pcTab, aes(x=TimePoint, y=PC1, col=TimePoint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  labs(x = '', color = 'Time Point') +
  th
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Baseline samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(metaPlasmaVsn)$Condition == 'Baseline')
metaBase <- metaPlasmaVsn[, smpBaseIdx]

# Display significant associations between PCs and metadata variables
metaBaseAssoRes <- doSOA(metaBase, meta_var = c('Recurrence', 'Gender', 'Age',
                                                'Smoking', 'Stage', 'Metastasis'),
                         do_onlyPCA = T, pca_method = 'ppca', num_PCs = 17)
metaBaseAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaBaseRes <- doSOA(metaBase, meta_var = 'Recurrence', pca_method = 'ppca',
                     num_PCs = 17, num_PCfeats = 30)
datMat <- metaBaseRes$data
smpAnno <- metaBaseRes$smpMetadata
tFeatSigRes <- metaBaseRes$tFeatSigRes
tPCASigRes <- metaBaseRes$tPCASigRes
pcaRes <- metaBaseRes$pcaRes
pcTab <- metaBaseRes$pcTab
pcTopFeatTab <- metaBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', #row scaling is across columns
                   main = 'Baseline plasma metabolomics')
```

Owing to missing values, there might be a situation that only few observations in
sample groups, resulting in unreliable t-statistics. (check e.g., Tumor Tissue
Metabolomics) We used probabilistic dropout model to account for missing values
and identify differentially abundant entities that are significantly associated
with cancer recurrence. Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAMetaBaseRes <- proDA::test_diff(fit,
                                         contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                         sort_by = 'pval')
proDAMetaBaseRes <- dplyr::select(all_proDAMetaBaseRes,
                                  -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDAMetaBaseRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaBaseRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Baseline plasma metabolomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- list(BasePlasmaMetab_Feats = proDAMetaBaseRes)
```

```{r}
ovl <- intersect(metaBaseRes$tFeatSigRes$Var1, proDAMetaBaseRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```
-> Most of Recurrence-related features captured by proDA are covered in regular
significance test.
<br/>
<br/>

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaBaseRes[1:6,] %>%
  dplyr::select(name, pval, MZ_RT) %>%
  dplyr::rename(Feature = name, pVal = pval)
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats$Feature,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Feature') %>%
  dplyr::mutate(MZ_RT = paste0(MZ_RT, '\n(p = ', round(pVal, 4), ')'),
                MZ_RT = factor(MZ_RT, levels = unique(MZ_RT))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(MZ_RT), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
  # theme(strip.text = element_text(size = 14),
  #       axis.title = element_text(size = 17), axis.text = element_text(size = 12),
  #       legend.title = element_text(size = 15), legend.text = element_text(size = 15),
  #       panel.grid.major.x = element_blank())
# ggsave('./output/AG_Hopf/boxplot_proDA_topSigFeats_BPM.png', device = 'png',
# dpi = 400, height = 8, width = 10)
```

Assess data power by p-value histogram
```{r}
p <- all_proDAMetaBaseRes$pval
hist(p, xlab = 'P-value', main = 'Baseline Plasma Metabolomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)', title = 'Baseline plasma metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC14 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC14, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Baseline plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

Plot molecular signatures captured by PC14 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
There is no single feature that can decently hint if patients will suffer cancer
recurrence or not, which means each of these top features contributes a bit to
explaining variation between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC14$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Baseline plasma metabolomics - PC14')
```

Display top features that build the PC14
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC14, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(BasePlasmaMetab_PC14 = pcTopFeats))
```

## Follow-up samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(metaPlasmaVsn)$Condition != 'Baseline')
metaFolo <- metaPlasmaVsn[, smpFoloIdx]

# Display significant associations between PCs and metadata variables
metaFoloAssoRes <- doSOA(metaFolo, meta_var = c('Recurrence', 'Gender'),
                         do_onlyPCA = T, pca_method = 'ppca', num_PCs = 17)
metaFoloAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaFoloRes <- doSOA(metaFolo, meta_var = 'Recurrence', pca_method = 'ppca',
                     num_PCs = 17, num_PCfeats = 30)
datMat <- metaFoloRes$data
smpAnno <- metaFoloRes$smpMetadata
tFeatSigRes <- metaFoloRes$tFeatSigRes
tPCASigRes <- metaFoloRes$tPCASigRes
pcaRes <- metaFoloRes$pcaRes
pcTab <- metaFoloRes$pcTab
pcTopFeatTab <- metaFoloRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Follow-up plasma metabolomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAMetaFoloRes <- proDA::test_diff(fit,
                                         contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                         sort_by = 'pval')
proDAMetaFoloRes <- dplyr::select(all_proDAMetaFoloRes,
                                  -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDAMetaFoloRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaFoloRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Follow-up plasma metabolomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaMetab_Feats = proDAMetaFoloRes))
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaFoloRes[1:6,] %>%
  dplyr::select(name, pval, MZ_RT) %>%
  dplyr::rename(Feature = name, pVal = pval)
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats$Feature,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Feature') %>%
  dplyr::mutate(MZ_RT = paste0(MZ_RT, '\n(p = ', round(pVal, 4), ')'),
                MZ_RT = factor(MZ_RT, levels = unique(MZ_RT))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(MZ_RT), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Assess data power by p-value histogram
```{r}
p <- all_proDAMetaFoloRes$pval
hist(p, xlab = 'P-value', main = 'Follow-up Plasma Metabolomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)', title = 'Follow-up plasma metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC13 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC13, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Follow-up plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

Plot molecular signatures captured by PC13 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC13$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma metabolomics - PC13')
```

Display top features that build the PC13
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC13, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaMetab_PC13 = pcTopFeats))
```

## Changes in time course
Differences between Follow-up and Baseline samples (Follow-up matrix - baseline
matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(metaPlasmaVsn)$Condition == 'Baseline')
metaBase <- metaPlasmaVsn[, smpBaseIdx]
# Subset follow-up samples
smpFoloIdx <- which(colData(metaPlasmaVsn)$Condition != 'Baseline')
metaFolo <- metaPlasmaVsn[, smpFoloIdx]
# Modify column names for matching two matrices
colnames(metaBase) <- stringr::str_remove(colnames(metaBase), '_P_B')
colnames(metaFolo) <- stringr::str_remove(colnames(metaFolo), '_P_R')
# Retrieve data matrix
metaBaseMat <- SummarizedExperiment::assay(metaBase)
metaFoloMat <- SummarizedExperiment::assay(metaFolo)
# Subtract follow-up matrix by baseline matrix
if (identical(colnames(metaBaseMat), colnames(metaFoloMat)) &
    identical(rownames(metaBaseMat), rownames(metaFoloMat))) {
  metaPlasmaDiffMat <- metaFoloMat - metaBaseMat
  # Remove features fully missing
  allNAsIdx <- which(apply(metaPlasmaDiffMat, 1, function(x) {all(is.na(x))}))
  metaPlasmaDiffMat <- metaPlasmaDiffMat[-allNAsIdx,]
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(metaBase)), Patient, Recurrence)
metaPlasmaDiff <- SummarizedExperiment(assays = metaPlasmaDiffMat, colData = colAnno)

# Perform analysis
metaPlasmaDiffRes <- doSOA(metaPlasmaDiff, meta_var = 'Recurrence', pca_method = 'ppca',
                           num_PCs = 17, num_PCfeats = 30)
datMat <- metaPlasmaDiffRes$data
smpAnno <- metaPlasmaDiffRes$smpMetadata
tFeatSigRes <- metaPlasmaDiffRes$tFeatSigRes
tPCASigRes <- metaPlasmaDiffRes$tPCASigRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F)) %>%
  dplyr::select(-Test)
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Differential plasma metabolomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entity differences that are significantly associated with cancer recurrence.
Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDAMetaPlasmaDiffRes <- proDA::test_diff(fit,
                                           contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                           sort_by = 'pval') %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05)  %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDAMetaPlasmaDiffRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaPlasmaDiffRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, scale = 'row',
                   main = 'Differential plasma metabolomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(DiffPlasmaMetab_Feats = proDAMetaPlasmaDiffRes))
```

```{r}
ovl <- intersect(metaPlasmaDiffRes$tFeatSigRes$Var1, proDAMetaPlasmaDiffRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaPlasmaDiffRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```




# Plasma Lipidomics
As described in Plasma Metabolomics section, we analyzed Baseline and Follow-up
samples separately.

```{r}
# Load normalized data
lipPlasmaVsn <- readRDS('./data/AG_Hopf/lipPlasmaVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(lipPlasmaVsn), rownames = 'Feature')
# Manually modify metadata information (time point, metastasis)
tmp_metadata <- as.data.frame(colData(lipPlasmaVsn)) %>%
  dplyr::mutate(
    TimePoint = dplyr::case_when(
      Condition == 'Baseline' ~ 'Baseline',
      Condition != 'Baseline' ~ '2 years later'
      ),
    Metastasis = case_when(
      Stage == 'IIB' ~ 'Yes',
      Stage != 'IIB' ~ 'No'
    ))
colData(lipPlasmaVsn)['TimePoint'] <- tmp_metadata$TimePoint
colData(lipPlasmaVsn)['Metastasis'] <- tmp_metadata$Metastasis

# Perform analysis
lipPlasmaRes <- doSOA(lipPlasmaVsn, meta_var = c('Recurrence', 'Gender', 'Age',
                                                 'Condition', 'TimePoint', 'Smoking',
                                                 'Stage', 'Metastasis'),
                      do_onlyPCA = T, pca_method = 'ppca')
tPCASigRes <- lipPlasmaRes$tPCASigRes
pcaRes <- lipPlasmaRes$pcaRes
pcTab <- lipPlasmaRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variable
(Var2). Note that each patient has two samples that have same patient annotations,
so association test results may have additive effects. Besides, some patient annotations
are only meaningful at Baseline time point, such as diagnosis ages, pathological stages, etc.
```{r}
# Display PCs of interest
tPCASigRes
```

PC1 and PC2 explain most variation in data and separate patient samples by time point.
```{r}
ggplot(pcTab, aes(x=PC1, y=PC2, col=TimePoint, group=Patient)) +
  geom_point(size = 5) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  scale_color_discrete(name = 'Time point') +
  th
  # theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20),
  #       legend.title = element_text(size = 18), legend.text = element_text(size = 18),
  #       panel.background = element_blank(), axis.line = element_line(color = 'black'))
# ggsave('./output/AG_Hopf/pca_PL.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Baseline samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(lipPlasmaVsn)$Condition == 'Baseline')
lipBase <- lipPlasmaVsn[, smpBaseIdx]

# Display significant associations between PCs and metadata variables
lipBaseAssoRes <- doSOA(lipBase, meta_var = c('Recurrence', 'Gender', 'Age',
                                              'Smoking', 'Stage', 'Metastasis'),
                        do_onlyPCA = T, pca_method = 'ppca', num_PCs = 17)
lipBaseAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
lipBaseRes <- doSOA(lipBase, meta_var = 'Recurrence', pca_method = 'ppca',
                    num_PCs = 17, num_PCfeats = 30)
datMat <- lipBaseRes$data
smpAnno <- lipBaseRes$smpMetadata
tFeatSigRes <- lipBaseRes$tFeatSigRes
tPCASigRes <- lipBaseRes$tPCASigRes
pcaRes <- lipBaseRes$pcaRes
pcTab <- lipBaseRes$pcTab
pcTopFeatTab <- lipBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Baseline plasma lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDALipBaseRes <- proDA::test_diff(fit,
                                        contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                        sort_by = 'pval')
proDALipBaseRes <- dplyr::select(all_proDALipBaseRes,
                                 -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDALipBaseRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDALipBaseRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Baseline plasma lipidomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(BasePlasmaLipid_Feats = proDALipBaseRes))
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDALipBaseRes[1:6,] %>%
  dplyr::select(name, pval, MZ_RT) %>%
  dplyr::rename(Feature = name, pVal = pval)
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats$Feature,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Feature') %>%
  dplyr::mutate(MZ_RT = paste0(MZ_RT, '\n(p = ', round(pVal, 4), ')'),
                MZ_RT = factor(MZ_RT, levels = unique(MZ_RT))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(MZ_RT), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Assess data power by p-value histogram
```{r}
p <- all_proDALipBaseRes$pval
hist(p, xlab = 'P-value', main = 'Baseline Plasma Lipidomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)', title = 'Baseline plasma lipidomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC5 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC5, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Baseline plasma lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

Plot molecular signatures captured by PC5 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
There is no single feature that can decently hint if patients will suffer cancer
recurrence or not, which means each of these top features contributes a bit to
explaining variation between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC5$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Baseline plasma lipidomics - PC5')
```

Display top features that build the PC5
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC5, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(BasePlasmaLipid_PC5 = pcTopFeats))
```

## Follow-up samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(lipPlasmaVsn)$Condition != 'Baseline')
lipFolo <- lipPlasmaVsn[, smpFoloIdx]
# Remove features fully missing
allNAsIdx <- which(apply(SummarizedExperiment::assay(lipFolo), 1, function(x) {all(is.na(x))}))
lipFolo <- lipFolo[-allNAsIdx,]

# Display significant associations between PCs and metadata variables
lipFoloAssoRes <- doSOA(lipFolo, meta_var = c('Recurrence', 'Gender'),
                        do_onlyPCA = T, pca_method = 'ppca', num_PCs = 17)
lipFoloAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
lipFoloRes <- doSOA(lipFolo, meta_var = 'Recurrence', pca_method = 'ppca',
                    num_PCs = 17, num_PCfeats = 30)
datMat <- lipFoloRes$data
smpAnno <- lipFoloRes$smpMetadata
tFeatSigRes <- lipFoloRes$tFeatSigRes
tPCASigRes <- lipFoloRes$tPCASigRes
pcaRes <- lipFoloRes$pcaRes
pcTab <- lipFoloRes$pcTab
pcTopFeatTab <- lipFoloRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F)) %>%
  dplyr::select(-Test)
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Follow-up plasma lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDALipFoloRes <- proDA::test_diff(fit,
                                        contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                        sort_by = 'pval')
proDALipFoloRes <- dplyr::select(all_proDALipFoloRes,
                                 -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDALipFoloRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDALipFoloRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder], #Feature794 only has 2 observed values
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Follow-up plasma lipidomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaLipid_Feats = proDALipFoloRes))
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDALipFoloRes[1:6,] %>%
  dplyr::select(name, pval, MZ_RT) %>%
  dplyr::rename(Feature = name, pVal = pval)
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats$Feature,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Feature') %>%
  dplyr::mutate(MZ_RT = paste0(MZ_RT, '\n(p = ', round(pVal, 4), ')'),
                MZ_RT = factor(MZ_RT, levels = unique(MZ_RT))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(MZ_RT), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Assess data power by p-value histogram
```{r}
p <- all_proDALipFoloRes$pval
hist(p, xlab = 'P-value', main = 'Follow-up Plasma Lipidomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)', title = 'Follow-up plasma lipidomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC4 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC4, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Follow-up plasma lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

Plot molecular signatures captured by PC4 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC4$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma lipidomics - PC4')
```

Display top features that build the PC4
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC4, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaLipid_PC4 = pcTopFeats))
```

## Changes in time course
Differences between Follow-up and Baseline samples (Follow-up matrix - baseline
matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset Baseline samples
smpBaseIdx <- which(colData(lipPlasmaVsn)$Condition == 'Baseline')
lipBase <- lipPlasmaVsn[, smpBaseIdx]
# Subset follow-up samples
smpFoloIdx <- which(colData(lipPlasmaVsn)$Condition != 'Baseline')
lipFolo <- lipPlasmaVsn[, smpFoloIdx]
# Modify column names for matching two matrices
colnames(lipBase) <- stringr::str_remove(colnames(lipBase), '_P_B')
colnames(lipFolo) <- stringr::str_remove(colnames(lipFolo), '_P_R')
# Retrieve data matrix
lipBaseMat <- SummarizedExperiment::assay(lipBase)
lipFoloMat <- SummarizedExperiment::assay(lipFolo)
# Subtract follow-up matrix by baseline matrix
if (identical(colnames(lipBaseMat), colnames(lipFoloMat)) &
    identical(rownames(lipBaseMat), rownames(lipFoloMat))) {
  lipPlasmaDiffMat <- lipFoloMat - lipBaseMat
  # Remove features fully missing
  allNAsIdx <- which(apply(lipPlasmaDiffMat, 1, function(x) {all(is.na(x))}))
  lipPlasmaDiffMat <- lipPlasmaDiffMat[-allNAsIdx,]
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(lipBase)), Patient, Recurrence)
lipPlasmaDiff <- SummarizedExperiment(assays = lipPlasmaDiffMat, colData = colAnno)

# Perform analysis
lipPlasmaDiffRes <- doSOA(lipPlasmaDiff, meta_var = 'Recurrence', pca_method = 'ppca',
                          num_PCs = 17, num_PCfeats = 30)
datMat <- lipPlasmaDiffRes$data
smpAnno <- lipPlasmaDiffRes$smpMetadata
tFeatSigRes <- lipPlasmaDiffRes$tFeatSigRes
tPCASigRes <- lipPlasmaDiffRes$tPCASigRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Differential plasma lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entity differences that are significantly associated with cancer recurrence.
Note that there is no differentially abundant lipid.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDALipPlasmaDiffRes <- proDA::test_diff(fit,
                             contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                             sort_by = 'pval', n_max = 30) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::mutate(m.z_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDALipPlasmaDiffRes

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(DiffPlasmaLipid_Feats = proDALipPlasmaDiffRes))
```

We took top 30 differentially abundant features from proDA() to see overlaps
```{r}
ovl <- intersect(lipPlasmaDiffRes$tFeatSigRes$Var1, proDALipPlasmaDiffRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are overlapped between two methods:\n', ovl)

# Filter univariate result for making summarized plot
proDALipPlasmaDiffRes <- dplyr::filter(proDALipPlasmaDiffRes, pval < 0.05)
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```




# Tissue Metabolomics
Based on PCA result obtained by analyzing whole Tissue Metabolomics dataset that
includes Tumor and Normal samples, we found that PCA mainly captures source of
variation in tissue conditions, which is not of direct interest. In addition,
Recurrence-related significant PCs do not work that well, perhaps because Tumor
and Normal samples are noise to each other. Therefore, we decided to analyze Tumor
and Normal samples separately.

```{r}
# Load normalized data
metaTissueVsn <- readRDS('./data/AG_Hopf/metaTissueVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(metaTissueVsn), rownames = 'Feature')
# Manually modify metadata information
tmp_metadata <- as.data.frame(colData(metaTissueVsn)) %>%
  dplyr::mutate(
    Metastasis = case_when(
      Stage == 'IIB' ~ 'Yes',
      Stage != 'IIB' ~ 'No'
    ))
colData(metaTissueVsn)['Metastasis'] <- tmp_metadata$Metastasis

# Perform analysis
metaTissueRes <- doSOA(metaTissueVsn, meta_var = c('Recurrence', 'Gender', 'Age',
                                                   'Condition', 'Smoking', 'Stage',
                                                   'Metastasis'),
                       do_onlyPCA = T, pca_method = 'ppca')
tPCASigRes <- metaTissueRes$tPCASigRes
pcaRes <- metaTissueRes$pcaRes
pcTab <- metaTissueRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variable
(Var2). Note that each patient has two samples that have same patient annotations,
so association test results may have additive effects.
```{r}
# Display PCs of interest
tPCASigRes
```

PCA tends to capture variation in sample conditions (tumor and normal) and those
PCs significantly associated with cancer recurrence do not perform that well.
```{r}
ggplot(pcTab, aes(x=PC1, y=PC2, col=Age, shape=Condition, group=Patient)) +
  geom_point(size = 4) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  scale_color_gradient(low = "grey90", high = "black") +
  th

ggplot(pcTab, aes(x=Recurrence, y=PC14, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Tumor samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(metaTissueVsn)$Condition == 'Tumor')
metaTumor <- metaTissueVsn[, smpTumorIdx]

# Display significant associations between PCs and metadata variables
metaTumorAssoRes <- doSOA(metaTumor, meta_var = c('Recurrence', 'Gender', 'Age',
                                                  'Smoking', 'Stage', 'Metastasis'),
                          do_onlyPCA = T, pca_method = 'ppca', num_PCs = 18)
metaTumorAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaTumorRes <- doSOA(metaTumor, meta_var = 'Recurrence', pca_method = 'ppca',
                      num_PCs = 18, num_PCfeats = 30)
datMat <- metaTumorRes$data
smpAnno <- metaTumorRes$smpMetadata
tFeatSigRes <- metaTumorRes$tFeatSigRes
tPCASigRes <- metaTumorRes$tPCASigRes
pcaRes <- metaTumorRes$pcaRes
pcTab <- metaTumorRes$pcTab
pcTopFeatTab <- metaTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
a <- pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   fontsize = 16, fontsize_col = 14,
                   scale = 'row')#, main = 'Tumor tissue metabolomics')
# ggsave('./output/YIG_seminar/heatmap_sigFeats_UTTM.png', a, device = 'png', dpi = 400, height = 8, width = 10)
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant metabolites in Tumor tissue that are significantly associated with cancer
recurrence. Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAMetaTumorRes <- proDA::test_diff(fit,
                                      contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                      sort_by = 'pval')
proDAMetaTumorRes <- dplyr::select(all_proDAMetaTumorRes,
                                   -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDAMetaTumorRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaTumorRes, dplyr::desc(t_statistic))$name
a <- pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   fontsize = 18, fontsize_col = 14,
                   scale = 'row')#, main = 'Tumor tissue metabolomics (proDA)')
# ggsave('./output/YIG_seminar/heatmap_proDA_sigFeats_UTTM.png', a, device = 'png', dpi = 400, height = 8, width = 10)

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(TumorTissueMetab_Feats = proDAMetaTumorRes))
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaTumorRes[1:6,] %>%
  dplyr::select(name, pval, MZ_RT) %>%
  dplyr::rename(Feature = name, pVal = pval)
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats$Feature,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Feature') %>%
  dplyr::mutate(MZ_RT = paste0(MZ_RT, '\n(p = ', round(pVal, 4), ')'),
                MZ_RT = factor(MZ_RT, levels = unique(MZ_RT))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(MZ_RT), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
  # theme(strip.text = element_text(size = 14),
  #       axis.title = element_text(size = 17), axis.text = element_text(size = 12),
  #       legend.title = element_text(size = 15), legend.text = element_text(size = 15),
  #       panel.grid.major.x = element_blank())
# ggsave('./output/AG_Hopf/boxplot_proDA_topSigFeats_TTM.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Assess data power by p-value histogram
```{r}
p <- all_proDAMetaTumorRes$pval
hist(p, xlab = 'P-value', main = 'Tumor Tissue Metabolomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Tumor tissue metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC17 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC17, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(y = 'PC17') +#title = 'Tumor tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 9) +
  th #+
  # theme(axis.title = element_text(size = 26), axis.text = element_text(size = 20),
  #       legend.title = element_text(size = 22), legend.text = element_text(size = 22))
# ggsave('./output/YIG_seminar/boxplot_PC17_UTTM.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Plot molecular signatures captured by PC17 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
There is no single feature that can decently hint if patients will suffer cancer
recurrence or not, which means each of these top features contributes a bit to
explaining variation between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC17$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue metabolomics - PC17')
```

Display top features that build the PC17
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC17, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(TumorTissueMetab_PC17 = pcTopFeats))
```

## Normal samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(metaTissueVsn)$Condition == 'Normal')
metaNormal <- metaTissueVsn[, smpNormalIdx]
# Remove features fully missing
allNAsIdx <- which(apply(SummarizedExperiment::assay(metaNormal), 1, function(x) {all(is.na(x))}))
metaNormal <- metaNormal[-allNAsIdx,]

# Display significant associations between PCs and metadata variables
metaNormalAssoRes <- doSOA(metaNormal, meta_var = c('Recurrence', 'Gender', 'Age',
                                                    'Smoking', 'Stage', 'Metastasis'),
                           do_onlyPCA = T, pca_method = 'ppca', num_PCs = 18)
metaNormalAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaNormalRes <- doSOA(metaNormal, meta_var = 'Recurrence', pca_method = 'ppca',
                       num_PCs = 18, num_PCfeats = 30)
datMat <- metaNormalRes$data
smpAnno <- metaNormalRes$smpMetadata
tFeatSigRes <- metaNormalRes$tFeatSigRes
tPCASigRes <- metaNormalRes$tPCASigRes
pcaRes <- metaNormalRes$pcaRes
pcTab <- metaNormalRes$pcTab
pcTopFeatTab <- metaNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Normal tissue metabolomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant metabolites in Normal tissue that are significantly associated with cancer
recurrence. Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAMetaNormalRes <- proDA::test_diff(fit,
                                           contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                           sort_by = 'pval')
proDAMetaNormalRes <- dplyr::select(all_proDAMetaNormalRes,
                                    -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDAMetaNormalRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaNormalRes, dplyr::desc(t_statistic))$name
a <- pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Normal tissue metabolomics (proDA)')
# ggsave(paste0(result_path, 'AG_Hopf/metaNormal_sigFeats.png'), plot = a, device = 'png', dpi = 400,
#        height = 8, width = 10)

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(NormalTissueMetab_Feats = proDAMetaNormalRes))
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaNormalRes[1:6,] %>%
  dplyr::select(name, pval, MZ_RT) %>%
  dplyr::rename(Feature = name, pVal = pval)
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats$Feature,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Feature') %>%
  dplyr::mutate(MZ_RT = paste0(MZ_RT, '\n(p = ', round(pVal, 4), ')'),
                MZ_RT = factor(MZ_RT, levels = unique(MZ_RT))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(MZ_RT), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Assess data power by p-value histogram
```{r}
p <- all_proDAMetaNormalRes$pval
hist(p, xlab = 'P-value', main = 'Normal Tissue Metabolomics (proDA)')
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```

## Difference in tissue conditions
Differences between Tumor and Normal samples (Tumor matrix - Normal matrix):\

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(metaTissueVsn)$Condition == 'Tumor')
metaTumor <- metaTissueVsn[, smpTumorIdx]
# Subset normal samples
smpNormalIdx <- which(colData(metaTissueVsn)$Condition == 'Normal')
metaNormal <- metaTissueVsn[, smpNormalIdx]
# Modify column names for matching two matrices
colnames(metaTumor) <- stringr::str_remove(colnames(metaTumor), '_TG')
colnames(metaNormal) <- stringr::str_remove(colnames(metaNormal), '_NG')
# Retrieve data matrix
metaTumorMat <- SummarizedExperiment::assay(metaTumor)
metaNormalMat <- SummarizedExperiment::assay(metaNormal)
# Subtract tumor matrix by normal matrix
if (identical(colnames(metaTumorMat), colnames(metaNormalMat)) &
    identical(rownames(metaTumorMat), rownames(metaNormalMat))) {
  metaTissueDiffMat <- metaTumorMat - metaNormalMat
  # Remove features fully missing
  allNAsIdx <- which(apply(metaTissueDiffMat, 1, function(x) {all(is.na(x))}))
  metaTissueDiffMat <- metaTissueDiffMat[-allNAsIdx,]
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- as.data.frame(colData(metaTumor))
metaTissueDiff <- SummarizedExperiment(assays = metaTissueDiffMat, colData = colAnno)

# Display significant associations between PCs and metadata variables
metaTissueDiffAssoRes <- doSOA(metaTissueDiff, meta_var = c('Recurrence', 'Gender', 'Age',
                                                            'Smoking', 'Stage', 'Metastasis'),
                               do_onlyPCA = T, pca_method = 'ppca', num_PCs = 18)
metaTissueDiffAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
metaTissueDiffRes <- doSOA(metaTissueDiff, meta_var = 'Recurrence', pca_method = 'ppca',
                           num_PCs = 18, num_PCfeats = 30)
datMat <- metaTissueDiffRes$data
smpAnno <- metaTissueDiffRes$smpMetadata
tFeatSigRes <- metaTissueDiffRes$tFeatSigRes
tPCASigRes <- metaTissueDiffRes$tPCASigRes
pcaRes <- metaTissueDiffRes$pcaRes
pcTab <- metaTissueDiffRes$pcTab
pcTopFeatTab <- metaTissueDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Differential tissue metabolomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant metabolite difference between Tumor and Normal tissues that are significantly
associated with cancer recurrence. Note that there is no differentially abundant metabolite.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDAMetaTissueDiffRes <- proDA::test_diff(fit,
                                           contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                           sort_by = 'pval', n_max = 30) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDAMetaTissueDiffRes

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(DiffTissueMetab_Feats = proDAMetaTissueDiffRes))
```

We took top 30 differentially abundant features from proDA() to see overlaps
```{r}
ovl <- intersect(metaTissueDiffRes$tFeatSigRes$Var1, proDAMetaTissueDiffRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are overlapped between two methods:\n', ovl)

# Filter univariate result for making summarized plot
proDAMetaTissueDiffRes <- dplyr::filter(proDAMetaTissueDiffRes, pval < 0.05)
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential tissue metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC10 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC10, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

Plot molecular signatures captured by PC10 in input data. We took a look at top
20 features with highest loadings and observed protein levels of these top features
through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC10$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential tissue metabolomics - PC10')

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC10, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(DiffTissueMetab_PC10 = pcTopFeats))
```




# Tissue Lipidomics
As described in Tissue Metabolomics section, we analyzed Tumor and Normal samples separately.

```{r}
# Load normalized data
lipTissueVsn <- readRDS('./data/AG_Hopf/lipTissueVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(lipTissueVsn), rownames = 'Feature')
# Manually modify metadata information (metastasis)
tmp_metadata <- as.data.frame(colData(lipTissueVsn)) %>%
  dplyr::mutate(
    Metastasis = case_when(
      Stage == 'IIB' ~ 'Yes',
      Stage != 'IIB' ~ 'No'
    ))
colData(lipTissueVsn)['Metastasis'] <- tmp_metadata$Metastasis

# Perform analysis
lipTissueRes <- doSOA(lipTissueVsn, meta_var = c('Recurrence', 'Gender', 'Age',
                                                 'Condition', 'Smoking', 'Stage',
                                                 'Metastasis'),
                      do_onlyPCA = T, pca_method = 'ppca')
tPCASigRes <- lipTissueRes$tPCASigRes
pcaRes <- lipTissueRes$pcaRes
pcTab <- lipTissueRes$pcTab
```

Display significant associations between learned PCs (Var1) and metadata variable
(Var2). Note that each patient has two samples that have same patient annotations,
so association test results may have additive effects.
```{r}
# Display PCs of interest
tPCASigRes
```

PCA tends to capture variation in sample conditions (tumor and normal) and those
PCs significantly associated with cancer recurrence do not perform that well.
```{r}
ggplot(pcTab, aes(x=PC1, y=PC2, col=Age, shape=Condition, group=Patient)) +
  geom_point(size = 4) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  scale_color_gradient(low = 'grey90', high = 'black') +
  th

ggplot(pcTab, aes(x=Recurrence, y=PC13, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 5) +
  th
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Tumor samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(lipTissueVsn)$Condition == 'Tumor')
lipTumor <- lipTissueVsn[, smpTumorIdx]

# Display significant associations between PCs and metadata variables
lipTumorAssoRes <- doSOA(lipTumor, meta_var = c('Recurrence', 'Gender', 'Age',
                                                'Smoking', 'Stage', 'Metastasis'),
                         do_onlyPCA = T, pca_method = 'ppca', num_PCs = 18)
lipTumorAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
lipTumorRes <- doSOA(lipTumor, meta_var = 'Recurrence', pca_method = 'ppca',
                     num_PCs = 18, num_PCfeats = 30)
datMat <- lipTumorRes$data
smpAnno <- lipTumorRes$smpMetadata
tFeatSigRes <- lipTumorRes$tFeatSigRes
tPCASigRes <- lipTumorRes$tPCASigRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Tumor tissue lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant lipids in Tumor tissue that are significantly associated with cancer recurrence.
Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDALipTumorRes <- proDA::test_diff(fit,
                                     contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                     sort_by = 'pval')
proDALipTumorRes <- dplyr::select(all_proDALipTumorRes,
                                  -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDALipTumorRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDALipTumorRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue lipidomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(TumorTissueLipid_Feats = proDALipTumorRes))
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDALipTumorRes[1:6,] %>%
  dplyr::select(name, pval, MZ_RT) %>%
  dplyr::rename(Feature = name, pVal = pval)
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats$Feature,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Feature') %>%
  dplyr::mutate(MZ_RT = paste0(MZ_RT, '\n(p = ', round(pVal, 4), ')'),
                MZ_RT = factor(MZ_RT, levels = unique(MZ_RT))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(MZ_RT), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Assess data power by p-value histogram
```{r}
p <- all_proDALipTumorRes$pval
hist(p, xlab = 'P-value', main = 'Tumor Tissue Lipidomics (proDA)')
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```

## Normal samples

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(lipTissueVsn)$Condition == 'Normal')
lipNormal <- lipTissueVsn[, smpNormalIdx]
# Remove features fully missing
allNAsIdx <- which(apply(SummarizedExperiment::assay(lipNormal), 1, function(x) {all(is.na(x))}))
lipNormal <- lipNormal[-allNAsIdx,]

# Display significant associations between PCs and metadata variables
lipNormalAssoRes <- doSOA(lipNormal, meta_var = c('Recurrence', 'Gender', 'Age',
                                                  'Smoking', 'Stage', 'Metastasis'),
                          do_onlyPCA = T, pca_method = 'ppca', num_PCs = 18)
lipNormalAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
lipNormalRes <- doSOA(lipNormal, meta_var = 'Recurrence', pca_method = 'ppca',
                      num_PCs = 18, num_PCfeats = 30)
datMat <- lipNormalRes$data
smpAnno <- lipNormalRes$smpMetadata
tFeatSigRes <- lipNormalRes$tFeatSigRes
tPCASigRes <- lipNormalRes$tPCASigRes
pcaRes <- lipNormalRes$pcaRes
pcTab <- lipNormalRes$pcTab
pcTopFeatTab <- lipNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Normal tissue lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant lipids in Normal tissue that are significantly associated with cancer recurrence.
Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDALipNormalRes <- proDA::test_diff(fit,
                                      contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                      sort_by = 'pval')
proDALipNormalRes <- dplyr::select(all_proDALipNormalRes,
                                   -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDALipNormalRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDALipNormalRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Normal tissue lipidomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(NormalTissueLipid_Feats = proDALipNormalRes))
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDALipNormalRes[1:6,] %>%
  dplyr::select(name, pval, MZ_RT) %>%
  dplyr::rename(Feature = name, pVal = pval)
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats$Feature,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::left_join(topSigFeats, by = 'Feature') %>%
  dplyr::mutate(MZ_RT = paste0(MZ_RT, '\n(p = ', round(pVal, 4), ')'),
                MZ_RT = factor(MZ_RT, levels = unique(MZ_RT))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(MZ_RT), scales = 'free') +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Assess data power by p-value histogram
```{r}
p <- all_proDALipNormalRes$pval
hist(p, xlab = 'P-value', main = 'Normal Tissue Lipidomics (proDA)')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Normal tissue lipidomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC15 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC15, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Normal tissue lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  th
```

Plot molecular signatures captured by PC15 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC15$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue lipidomics - PC15')
```

Display top features that build the PC15
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC15, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(NormalTissueLipid_PC15 = pcTopFeats))
```

## Difference in tissue conditions
Differences between Tumor and Normal samples (Tumor matrix - Normal matrix):\

Display significant associations between learned PCs (Var1) and metadata variables (Var2)
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(lipTissueVsn)$Condition == 'Tumor')
lipTumor <- lipTissueVsn[, smpTumorIdx]
# Subset normal samples
smpNormalIdx <- which(colData(lipTissueVsn)$Condition == 'Normal')
lipNormal <- lipTissueVsn[, smpNormalIdx]
# Modify column names for matching two matrices
colnames(lipTumor) <- stringr::str_remove(colnames(lipTumor), '_TG')
colnames(lipNormal) <- stringr::str_remove(colnames(lipNormal), '_NG')
# Retrieve data matrix
lipTumorMat <- SummarizedExperiment::assay(lipTumor)
lipNormalMat <- SummarizedExperiment::assay(lipNormal)
# Subtract tumor matrix by normal matrix
if (identical(colnames(lipTumorMat), colnames(lipNormalMat)) &
    identical(rownames(lipTumorMat), rownames(lipNormalMat))) {
  lipTissueDiffMat <- lipTumorMat - lipNormalMat
  # Remove features fully missing
  allNAsIdx <- which(apply(lipTissueDiffMat, 1, function(x) {all(is.na(x))}))
  lipTissueDiffMat <- lipTissueDiffMat[-allNAsIdx,]
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- as.data.frame(colData(lipTumor))
lipTissueDiff <- SummarizedExperiment(assays = lipTissueDiffMat, colData = colAnno)

# Display significant associations between PCs and metadata variables
lipTissueDiffAssoRes <- doSOA(lipTissueDiff, meta_var = c('Recurrence', 'Gender', 'Age',
                                                          'Smoking', 'Stage', 'Metastasis'),
                              do_onlyPCA = T, pca_method = 'ppca', num_PCs = 18)
lipTissueDiffAssoRes$tPCASigRes
```

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Perform analysis
lipTissueDiffRes <- doSOA(lipTissueDiff, meta_var = 'Recurrence', pca_method = 'ppca',
                          num_PCs = 18, num_PCfeats = 30)
datMat <- lipTissueDiffRes$data
smpAnno <- lipTissueDiffRes$smpMetadata
tFeatSigRes <- lipTissueDiffRes$tFeatSigRes
tPCASigRes <- lipTissueDiffRes$tPCASigRes
pcaRes <- lipTissueDiffRes$pcaRes
pcTab <- lipTissueDiffRes$pcTab
pcTopFeatTab <- lipTissueDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F)) %>%
  dplyr::select(-Test)
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(Stat))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Differential tissue lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant lipid difference between Tumor and Normal tissues that are significantly
associated with cancer recurrence.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDALipTissueDiffRes <- proDA::test_diff(fit,
                                          contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                          sort_by = 'pval', n_max = 30) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDALipTissueDiffRes

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(DiffTissueLipid_Feats = proDALipTissueDiffRes))
```

We took top 30 differentially abundant features from proDA() to see overlaps
```{r}
ovl <- intersect(lipTissueDiffRes$tFeatSigRes$Var1, proDALipTissueDiffRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are overlapped betweeb two methods:\n', ovl)

# Filter univariate result for making summarized plot
proDALipTissueDiffRes <- dplyr::filter(proDALipTissueDiffRes, pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential tissue lipidomics')
```

PC5 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC5, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential tissue lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th
```

Plot molecular signatures captured by PC5 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC5$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential tissue metabolomics - PC5')

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC5, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(DiffTissueLipid_PC5 = pcTopFeats))
```




# Summary

```{r}
# Export tables containing significant features as Excel file
# write.xlsx(sigFeatSheet,
#            file = paste0(project_path, 'results/single-omics_significant_features.xlsx'))
```

Display proportion of significant features that can separate cancer recurrence and
non-recurrence patient groups in each dataset. Numbers after bars indicate total
feature numbers.

**proDA R package that accounts for missing values**
```{r}
# Barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats <- nrow(proDAMetaBaseRes) / nrow(metaBaseRes$data) * 100
metaFoloSigFeats <- nrow(proDAMetaFoloRes) / nrow(metaFoloRes$data) * 100
lipBaseSigFeats <- nrow(proDALipBaseRes) / nrow(lipBaseRes$data) * 100
lipFoloSigFeats <- nrow(proDALipFoloRes) / nrow(lipFoloRes$data) * 100
metaTumorSigFeats <- nrow(proDAMetaTumorRes) / nrow(metaTumorRes$data) * 100
metaNormalSigFeats <- nrow(proDAMetaNormalRes) / nrow(metaNormalRes$data) * 100
lipTumorSigFeats <- nrow(proDALipTumorRes) / nrow(lipTumorRes$data) * 100
lipNormalSigFeats <- nrow(proDALipNormalRes) / nrow(lipNormalRes$data) * 100

# Prepare needed information for barplot
dat <- rev(c('Baseline Plasma Metabolomics', 'Follow-up Plasma Metabolomics',
             'Baseline Plasma Lipidomics', 'Follow-up Plasma Lipidomics',
             'Tumor Tissue Metabolomics', 'Normal Tissue Metabolomics',
             'Tumor Tissue Lipidomics', 'Normal Tissue Lipidomics'))
datModal <- rev(c(rep('Plasma Metabolomics', 2), rep('Plasma Lipidomics', 2),
                  rep('Tissue Metabolomics', 2), rep('Tissue Lipidomics', 2)))
datOf <- rev(c(rep('Plasma', 4), rep('Tissue', 4)))
proportion <- rev(c(metaBaseSigFeats, metaFoloSigFeats,
                    lipBaseSigFeats, lipFoloSigFeats,
                    metaTumorSigFeats, metaNormalSigFeats,
                    lipTumorSigFeats, lipNormalSigFeats))
numFeat <- rev(c(nrow(metaBaseRes$data), nrow(metaFoloRes$data),
                 nrow(lipBaseRes$data), nrow(lipFoloRes$data),
                 nrow(metaTumorRes$data), nrow(metaNormalRes$data),
                 nrow(lipTumorRes$data), nrow(lipNormalRes$data)))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = dat),
                             Data_modality = datModal,
                             Data_of = datOf,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill=Data_of, label=Feature_number)) +
  geom_bar(stat = 'identity') +
  ylim(0, 9) +
  coord_flip() +
  geom_text(size = 5, hjust = -0.2) +
  labs(y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Sample Type') +
  th
# ggsave(paste0(result_path, 'AG_Hopf/proporSigFeats.png'), device = 'png', dpi = 400,
#        height = 8, width = 10)
```

**Regular significance test that does not account for missing values**
```{r}
# Barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats <- nrow(metaBaseRes$tFeatSigRes) / nrow(metaBaseRes$data) * 100
metaFoloSigFeats <- nrow(metaFoloRes$tFeatSigRes) / nrow(metaFoloRes$data) * 100
# metaPlasmaDiffSigFeats <- nrow(metaPlasmaDiffRes$tFeatSigRes) / nrow(metaPlasmaDiffRes$data) * 100
lipBaseSigFeats <- nrow(lipBaseRes$tFeatSigRes) / nrow(lipBaseRes$data) * 100
lipFoloSigFeats <- nrow(lipFoloRes$tFeatSigRes) / nrow(lipFoloRes$data) * 100
# lipPlasmaDiffSigFeats <- nrow(lipPlasmaDiffRes$tFeatSigRes) / nrow(lipPlasmaDiffRes$data) * 100
metaTumorSigFeats <- nrow(metaTumorRes$tFeatSigRes) / nrow(metaTumorRes$data) * 100
metaNormalSigFeats <- nrow(metaNormalRes$tFeatSigRes) / nrow(metaNormalRes$data) * 100
# metaTissueDiffSigFeats <- nrow(metaTissueDiffRes$tFeatSigRes) / nrow(metaTissueDiffRes$data) * 100
lipTumorSigFeats <- nrow(lipTumorRes$tFeatSigRes) / nrow(lipTumorRes$data) * 100
lipNormalSigFeats <- nrow(lipNormalRes$tFeatSigRes) / nrow(lipNormalRes$data) * 100
# lipTissueDiffSigFeats <- nrow(lipTissueDiffRes$tFeatSigRes) / nrow(lipTissueDiffRes$data) * 100

# Prepare needed information for barplot
dat <- rev(c('Baseline Plasma Metabolomics', 'Follow-up Plasma Metabolomics',#'Differential Plasma Metabolomics',
             'Baseline Plasma Lipidomics', 'Follow-up Plasma Lipidomics',#'Differential Plasma Lipidomics',
             'Tumor Tissue Metabolomics', 'Normal Tissue Metabolomics',#'Differential Tissue Metabolomics',
             'Tumor Tissue Lipidomics', 'Normal Tissue Lipidomics'))#'Differential Tissue Lipidomics'
datModal <- rev(c(rep('Plasma Metabolomics', 2), rep('Plasma Lipidomics', 2),
                  rep('Tissue Metabolomics', 2), rep('Tissue Lipidomics', 2)))
proportion <- rev(c(metaBaseSigFeats, metaFoloSigFeats, #metaPlasmaDiffSigFeats,
                    lipBaseSigFeats, lipFoloSigFeats, #lipPlasmaDiffSigFeats,
                    metaTumorSigFeats, metaNormalSigFeats, #metaTissueDiffSigFeats,
                    lipTumorSigFeats, lipNormalSigFeats)) #lipTissueDiffSigFeats
numFeat <- rev(c(nrow(metaBaseRes$data), nrow(metaFoloRes$data),
                 nrow(lipBaseRes$data), nrow(lipFoloRes$data),
                 nrow(metaTumorRes$data), nrow(metaNormalRes$data),
                 nrow(lipTumorRes$data), nrow(lipNormalRes$data)))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = dat),
                             Data_modality = datModal,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill=Data_modality, label=Feature_number)) +
  geom_bar(stat = 'identity') +
  ylim(0, 11) +
  coord_flip() +
  geom_text(hjust = -0.05) +
  labs(y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Data modality') +
  th
```
1. Plasma datasets got overall higher proportions of Recurrence-related features
than Tissue while they have similar feature sizes. This unbiased result indicates
that Plasma samples can potentially provide more information in terms of separating
recurrence and non-recurrence patient groups and Tissue samples are more noisy.\
2. There is a way higher proportion of Recurrence-related features in Follow-up
Plasma Lipidomics compared to the results of the other datasets, and in the meantime,
there are much more replicated features (same m/z and retention time) in Plasma
Lipidomics dataset (check the preprocessing report of the Untargeted data). Are
many of these Recurrence-related features replicates? No, there are only 3 (out
of 255) replicates in the significance test result, which is negligible.
<br/>
<br/>

```{r, include = F, eval = F}
# Retrieve m/z and retention time information of features
featInfo <- tibble::as_tibble(rowData(lipPlasmaVsn), rownames = 'Feature')
# Collect duplicated features, i.e., identical m/z and retention time
dupMZ.RT <- rowData(lipPlasmaVsn)$`m/z_RT`
dupMZ.RT <- unique(dupMZ.RT[duplicated(dupMZ.RT)])
cat('There are', length(dupMZ.RT), 'features in replicate in Plasma Lipidomics,',
    'resulting in total', sum(featInfo$m.z_RT %in% dupMZ.RT), 'replicated features.')

# Display duplicated features in significance test result not accounting for missing
# values
dplyr::select(lipFoloRes$tFeatSigRes, Var1) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(Var1,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F)) %>%
  dplyr::filter(MZ_RT %in% dupMZ.RT, duplicated(MZ_RT))
# Display duplicated features in significance test result accounting for missing
# values
# dplyr::filter(proDALipFoloRes, MZ_RT %in% dupMZ.RT)
```

Visualize Recurrence-related features through volcano plots. Significance results
were done by proDA R package that uses probabilistic dropout model to account for
data missingness, which makes t-test results more reliable. Log2-FC (up and down)
is recurrence to non-recurrence groups. To be clearer, entities on up side are more
abundant in recurrence group than non-recurrence group, and so forth.
```{r message = F}
# Volcano plots for summarizing association test results between features and
# cancer recurrence
# Prepare feature information for converting feature IDs to m/z ratio and retention
# time
metaPlasmaFeatInfo <- tibble::as_tibble(rowData(metaPlasmaVsn), rownames = 'Feature_ID')
lipPlasmaFeatInfo <- tibble::as_tibble(rowData(lipPlasmaVsn), rownames = 'Feature_ID')
metaTissueFeatInfo <- tibble::as_tibble(rowData(metaTissueVsn), rownames = 'Feature_ID')
lipTissueFeatInfo <- tibble::as_tibble(rowData(lipTissueVsn), rownames = 'Feature_ID')

# Prepare log2-fold change information
# PM
metaPlasmaMedi <- readRDS('./data/AG_Hopf/metaPlasmaMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPM
metaBaseLogFC <- dplyr::filter(metaPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPM
metaFoloLogFC <- dplyr::filter(metaPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# PL
lipPlasmaMedi <- readRDS('./data/AG_Hopf/lipPlasmaMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPL
lipBaseLogFC <- dplyr::filter(lipPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPL
lipFoloLogFC <- dplyr::filter(lipPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TM
metaTissueMedi <- readRDS('./data/AG_Hopf/metaTissueMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTM
metaTumorLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTM
metaNormalLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TL
lipTissueMedi <- readRDS('./data/AG_Hopf/lipTissueMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTL
lipTumorLogFC <- dplyr::filter(lipTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTL
lipNormalLogFC <- dplyr::filter(lipTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)


# Collect all needed information for volcano plots
# Baseline Plasma Metabolomics
metaBaseVolTab <- dplyr::select(all_proDAMetaBaseRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(metaBaseLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Baseline Plasma Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaPlasmaFeatInfo$Feature_ID,
                                        to = metaPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))
# Follow-up Plasma Metabolomics
metaFoloVolTab <- dplyr::select(all_proDAMetaFoloRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(metaFoloLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Follow-up Plasma Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaPlasmaFeatInfo$Feature_ID,
                                        to = metaPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))

# Baseline Plasma Lipidomics
lipBaseVolTab <- dplyr::select(all_proDALipBaseRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(lipBaseLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Baseline Plasma Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipPlasmaFeatInfo$Feature_ID,
                                        to = lipPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))
# Follow-up Plasma Lipidomics
lipFoloVolTab <- dplyr::select(all_proDALipFoloRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(lipFoloLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Follow-up Plasma Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipPlasmaFeatInfo$Feature_ID,
                                        to = lipPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))

# Tumor Tissue Metabolomics
# proDA
metaTumorVolTab <- dplyr::select(all_proDAMetaTumorRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(metaTumorLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Tumor Tissue Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaTissueFeatInfo$Feature_ID,
                                        to = metaTissueFeatInfo$MZ.RT,
                                        warn_missing = F))
# Regular t-test
# metaTumorVolTab <- dplyr::select(metaTumorRes$tFeatRes, Var1, pVal) %>%
#   dplyr::rename(Feature = Var1, pVal = pVal) %>%
#   dplyr::left_join(metaTumorLogFC, by = 'Feature') %>%
#   dplyr::mutate(Data = 'Tumor Tissue Metabolomics',
#                 MZ.RT = plyr::mapvalues(Feature,
#                                         from = metaTissueFeatInfo$Feature_ID,
#                                         to = metaTissueFeatInfo$MZ.RT,
#                                         warn_missing = F))
# Normal Tissue Metabolomics
metaNormalVolTab <- dplyr::select(all_proDAMetaNormalRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(metaNormalLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Normal Tissue Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaTissueFeatInfo$Feature_ID,
                                        to = metaTissueFeatInfo$MZ.RT,
                                        warn_missing = F))

# Tumor Tissue Lipidomics
lipTumorVolTab <- dplyr::select(all_proDALipTumorRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(lipTumorLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Tumor Tissue Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipTissueFeatInfo$Feature_ID,
                                        to = lipTissueFeatInfo$MZ.RT,
                                        warn_missing = F))
# Normal Tissue Lipidomics
lipNormalVolTab <- dplyr::select(all_proDALipNormalRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(lipNormalLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Normal Tissue Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipTissueFeatInfo$Feature_ID,
                                        to = lipTissueFeatInfo$MZ.RT,
                                        warn_missing = F))
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# BPM
volTab <- metaBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Metabolomics') +
  th
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# FPM
volTab <- metaFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Metabolomics') +
  th
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# BPL
volTab <- lipBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 3) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 5, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)') + #, title = 'Baseline Plasma Lipidomics') +
  th
  # theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20),
  #       legend.title = element_text(size = 18), legend.text = element_text(size = 18),
  #       panel.background = element_blank(), axis.line = element_line(color = 'black'))
# ggsave('./output/AG_Hopf/volcano_BPL.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Log2-FC cutoffs are 1 (FC=2) and -1 (FC=0.5).
```{r}
# FPL
volTab <- lipFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 1] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -1] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-1, 1), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Lipidomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.4) and -0.5 (FC=0.7).
```{r}
# TTM
volTab <- metaTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), color=DE, label=Label)) +
  geom_point(size = 3.5) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3.5, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)')+#, title = 'Tumor Tissue Metabolomics') +
  th #+
#   theme(axis.title = element_text(size = 26), axis.text = element_text(size = 20),
#         legend.title = element_text(size = 22), legend.text = element_text(size = 22))
# ggsave('./output/YIG_seminar/volcano_proDA_UTTM.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Log2-FC cutoffs are 0.5 (FC=1.4) and -0.5 (FC=0.7).
```{r}
# NTM
volTab <- metaNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Metabolomics') +
  th
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# TTL
volTab <- lipTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Lipidomics') +
  th
```

Log2-FC cutoffs are 0.9 (FC=1.9) and -0.9 (FC=0.5).
```{r}
# NTL
volTab <- lipNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.9] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.9] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.9, 0.9), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Lipidomics') +
  th
```

```{r include = F, eval = F}
# Baseline and follow-up plasma datasets
# Combine result tables for plotting
volTab <- dplyr::bind_rows(metaBaseVolTab, metaFoloVolTab,
                           lipBaseVolTab, lipFoloVolTab)
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.9] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.9] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.9, 0.9), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 2, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  facet_wrap(vars(Data)) +
  labs(x = 'log2(FC)') +
  th

# Tumor and normal tissue datasets
# Combine result tables for plotting
volTab <- dplyr::bind_rows(metaTumorVolTab, metaNormalVolTab,
                           lipTumorVolTab, lipNormalVolTab)
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.9] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.9] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.9, 0.9), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 2, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  facet_wrap(vars(Data)) +
  labs(x = 'log2(FC)') +
  th
```
