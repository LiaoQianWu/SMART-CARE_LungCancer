---
title: 'Single-omics analysis: Method development lung cancer patient cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Conduct univariate (association test) and multivariate
(PCA) analyses on individual datasets, Plasma and Tissue Untargeted Metabolomics
and Lipidomics generated by AG Hopf, to take an initial look at power of each dataset
in terms of predicting patient cancer recurrences and also potentially to provide
evidence for latter multi-omics analyses. Association test between each feature
(metabolite and lipid level) and cancer recurrence was performed to capture
significant features that can separate recurrence and non-recurrence patients. PCA
was performed to see if there is any significant PC that can separate recurrence
and non-recurrence patients. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_MethodDev')
```

Load libraries
```{r library loading, message = F}
library('SummarizedExperiment')
library('proDA')
library('limma')
library('ggrepel')
library('ggfortify')
library('openxlsx')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')
```

# Plasma Metabolomics
Based on PCA result obtained by analyzing whole Plasma Metabolomics dataset that
includes Baseline and Follow-up samples, we found that PCA mainly captures source
of variation in time points, the unwanted variation. Besides, we attempt to identify
biomarkers that can predict whether patients WILL suffer from cancer recurrence or
not. Therefore, we decided to analyze Baseline and Follow-up samples separately.

```{r}
# Load normalized data
metaPlasmaVsn <- readRDS('./data/AG_Hopf/metaPlasmaVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(metaPlasmaVsn), rownames = 'Feature')

# Load Plasma Metabolomics data from AG Hell for changing sample names
metaPlasma_Hell <- readRDS('./data/AG_Hell/metaPlasmaNorm.rds')
smpNames <- tibble::as_tibble(colData(metaPlasma_Hell), rownames = 'Sample') %>%
  dplyr::select(Sample, Identifier) %>%
  dplyr::mutate(Identifier = stringr::str_remove(Identifier, '_3$'))
# Change sample names
colnames(metaPlasmaVsn) <- plyr::mapvalues(colnames(metaPlasmaVsn),
                                           from = smpNames$Identifier,
                                           to = smpNames$Sample)
# Add time point information into data
timePoint <- as.data.frame(colData(metaPlasmaVsn)) %>%
  dplyr::mutate(TimePoint = dplyr::case_when(
    Condition == 'Baseline' ~ 'Baseline',
    Condition != 'Baseline' ~ '2 years later')) %>%
  dplyr::select(TimePoint)
colData(metaPlasmaVsn)['TimePoint'] <- timePoint

# Perform analysis
metaPlasmaRes <- SOA(metaPlasmaVsn, fac = c('Recurrence', 'TimePoint'))
tPCASigRes <- metaPlasmaRes$tPCASigRes
pcaRes <- metaPlasmaRes$pcaRes
pcTab <- metaPlasmaRes$pcTab
```

Display associations between learned PCs (Var1) and factors (Var2). Basically
t-test was performed to test significance of difference between two groups, e.g.,
recurrence and non-recurrence patient groups or baseline and follow-up sample groups.
```{r}
# Display PCs of interest
tPCASigRes
```

PC1 explains most variation in data and separates patient samples by time points.
```{r}
# ggfortify
# ggplot2::autoplot(pcaRes, x = 1, y =2)

ggplot(pcTab, aes(x=PC1, y=PC2, col=TimePoint, shape=Recurrence, group=Patient)) +
  geom_point(size = 4) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  scale_color_discrete(name = 'Time point',
                       labels = c('Baseline', '2 years later')) +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))

ggplot(pcTab, aes(x=Recurrence, y=PC2, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Baseline samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(metaPlasmaVsn)$Condition == 'Baseline')
metaBase <- metaPlasmaVsn[, smpBaseIdx]

# Perform analysis
metaBaseRes <- SOA(metaBase, fac = 'Recurrence', num_feats = 30)
datMat <- metaBaseRes$data
smpAnno <- metaBaseRes$smpMetadata
tFeatSigRes <- metaBaseRes$tFeatSigRes
tPCASigRes <- metaBaseRes$tPCASigRes
pcaRes <- metaBaseRes$pcaRes
pcTab <- metaBaseRes$pcTab
pcTopFeatTab <- metaBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', #row scaling is across columns
                   main = 'Baseline plasma metabolomics')
```

Owing to missing values, there might be a situation that only few observations in
sample groups, resulting in unreliable t-statistics. (check e.g., Tumor Tissue
Metabolomics) We used probabilistic dropout model to account for missing values
and identify differentially abundant entities that are significantly associated
with cancer recurrence. Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAMetaBaseRes <- proDA::test_diff(fit,
                                         contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                         sort_by = 'pval')
proDAMetaBaseRes <- dplyr::select(all_proDAMetaBaseRes,
                                  -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDAMetaBaseRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaBaseRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Baseline plasma metabolomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- list(BasePlasmaMetab_Feats = proDAMetaBaseRes)
```

```{r}
ovl <- intersect(metaBaseRes$tFeatSigRes$Var1, proDAMetaBaseRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```
-> Most of Recurrence-related features captured by proDA are covered in regular
significance test.
<br/>
<br/>

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaBaseRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```

## Follow-up samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(metaPlasmaVsn)$Condition != 'Baseline')
metaFolo <- metaPlasmaVsn[, smpFoloIdx]

# Perform analysis
metaFoloRes <- SOA(metaFolo, fac = 'Recurrence', num_feats = 30)
datMat <- metaFoloRes$data
smpAnno <- metaFoloRes$smpMetadata
tFeatSigRes <- metaFoloRes$tFeatSigRes
tPCASigRes <- metaFoloRes$tPCASigRes
pcaRes <- metaFoloRes$pcaRes
pcTab <- metaFoloRes$pcTab
pcTopFeatTab <- metaFoloRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Follow-up plasma metabolomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAMetaFoloRes <- proDA::test_diff(fit,
                                         contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                         sort_by = 'pval')
proDAMetaFoloRes <- dplyr::select(all_proDAMetaFoloRes,
                                  -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDAMetaFoloRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaFoloRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Follow-up plasma metabolomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaMetab_Feats = proDAMetaFoloRes))
```

```{r}
ovl <- intersect(metaFoloRes$tFeatSigRes$Var1, proDAMetaFoloRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaFoloRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Follow-up plasma metabolomics')
```

PC12 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC12, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Follow-up plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Plot molecular signatures captured by PC12 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
There is no single feature that can decently hint if patients will suffer cancer
recurrence or not, which means each of these top features contributes a bit to
explaining variation between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC12$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma metabolomics - PC12')
```

Display top features that build the PC12
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC12, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaMetab_PC12 = pcTopFeats))
```

## Changes in time course
Differences between Follow-up and Baseline samples (Follow-up matrix - baseline
matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(metaPlasmaVsn)$Condition == 'Baseline')
metaBase <- metaPlasmaVsn[, smpBaseIdx]
# Subset follow-up samples
smpFoloIdx <- which(colData(metaPlasmaVsn)$Condition != 'Baseline')
metaFolo <- metaPlasmaVsn[, smpFoloIdx]
# Modify column names for matching two matrices
colnames(metaBase) <- stringr::str_remove(colnames(metaBase), '_P_B')
colnames(metaFolo) <- stringr::str_remove(colnames(metaFolo), '_P_R')
# Retrieve data matrix
metaBaseMat <- SummarizedExperiment::assay(metaBase)
metaFoloMat <- SummarizedExperiment::assay(metaFolo)
# Subtract follow-up matrix by baseline matrix
if (identical(colnames(metaBaseMat), colnames(metaFoloMat)) &
    identical(rownames(metaBaseMat), rownames(metaFoloMat))) {
  metaPlasmaDiffMat <- metaFoloMat - metaBaseMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(metaBase)), Patient, Recurrence)
metaPlasmaDiff <- SummarizedExperiment(assays = metaPlasmaDiffMat, colData = colAnno)

# Perform analysis
metaPlasmaDiffRes <- SOA(metaPlasmaDiff, fac = 'Recurrence', num_feats = 30)
datMat <- metaPlasmaDiffRes$data
smpAnno <- metaPlasmaDiffRes$smpMetadata
tFeatSigRes <- metaPlasmaDiffRes$tFeatSigRes
tPCASigRes <- metaPlasmaDiffRes$tPCASigRes
pcaRes <- metaPlasmaDiffRes$pcaRes
pcTab <- metaPlasmaDiffRes$pcTab
pcTopFeatTab <- metaPlasmaDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Differential plasma metabolomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entity differences that are significantly associated with cancer recurrence.
Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDAMetaPlasmaDiffRes <- proDA::test_diff(fit,
                                           contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                           sort_by = 'pval') %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05)  %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDAMetaPlasmaDiffRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaPlasmaDiffRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, scale = 'row',
                   main = 'Differential plasma metabolomics (proDA)')

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(DiffPlasmaMetab_Feats = proDAMetaPlasmaDiffRes))
```

```{r}
ovl <- intersect(metaPlasmaDiffRes$tFeatSigRes$Var1, proDAMetaPlasmaDiffRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaPlasmaDiffRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential plasma metabolomics')
```

PC12 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC12, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Plot molecular signatures captured by PC12 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC12$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential plasma metabolomics - PC12')
```

Display top features that build the PC12
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC12, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(DiffPlasmaMetab_PC12 = pcTopFeats))
```




# Plasma Lipidomics
As described in Plasma Metabolomics section, we analyzed Baseline and Follow-up
samples separately.

```{r}
# Load normalized data
lipPlasmaVsn <- readRDS('./data/AG_Hopf/lipPlasmaVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(lipPlasmaVsn), rownames = 'Feature')

# Load Plasma Metabolomics data from AG Hell for changing sample names
metaPlasma_Hell <- readRDS('./data/AG_Hell/metaPlasmaNorm.rds')
smpNames <- tibble::as_tibble(colData(metaPlasma_Hell), rownames = 'Sample') %>%
  dplyr::select(Sample, Identifier) %>%
  dplyr::mutate(Identifier = stringr::str_remove(Identifier, '_3$'))
# Change sample names
colnames(lipPlasmaVsn) <- plyr::mapvalues(colnames(lipPlasmaVsn),
                                          from = smpNames$Identifier,
                                          to = smpNames$Sample)
# Add time point information into data
timePoint <- as.data.frame(colData(lipPlasmaVsn)) %>%
  dplyr::mutate(TimePoint = dplyr::case_when(
    Condition == 'Baseline' ~ 'Baseline',
    Condition != 'Baseline' ~ '2 years later')) %>%
  dplyr::select(TimePoint)
colData(lipPlasmaVsn)['TimePoint'] <- timePoint

# Perform analysis
lipPlasmaRes <- SOA(lipPlasmaVsn, fac = c('Recurrence', 'TimePoint'))
tPCASigRes <- lipPlasmaRes$tPCASigRes
pcaRes <- lipPlasmaRes$pcaRes
pcTab <- lipPlasmaRes$pcTab
```

Display associations between learned PCs (Var1) and factors (Var2). Basically
t-test was performed to test significance of difference between two groups, e.g.,
recurrence and non-recurrence patient groups or baseline and follow-up sample groups.
```{r}
# Display PCs of interest
tPCASigRes
```

PC1 and PC2 explain most variation in data and separate patient samples by time point.
```{r}
ggplot(pcTab, aes(x=PC1, y=PC2, col=TimePoint, shape=Recurrence, group=Patient)) +
  geom_point(size = 3) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  scale_color_discrete(name = 'Time point',
                       labels = c('Baseline', '2 years later'))
ggsave('./output/AG_Hopf/pca_PL.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Baseline samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(lipPlasmaVsn)$Condition == 'Baseline')
lipBase <- lipPlasmaVsn[, smpBaseIdx]

# Perform analysis
lipBaseRes <- SOA(lipBase, fac = 'Recurrence', num_feats = 30)
datMat <- lipBaseRes$data
smpAnno <- lipBaseRes$smpMetadata
tFeatSigRes <- lipBaseRes$tFeatSigRes
tPCASigRes <- lipBaseRes$tPCASigRes
pcaRes <- lipBaseRes$pcaRes
pcTab <- lipBaseRes$pcTab
pcTopFeatTab <- lipBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Baseline plasma lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDALipBaseRes <- proDA::test_diff(fit,
                                        contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                        sort_by = 'pval')
proDALipBaseRes <- dplyr::select(all_proDALipBaseRes,
                                 -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDALipBaseRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDALipBaseRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Baseline plasma lipidomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(BasePlasmaLipid_Feats = proDALipBaseRes))
```

```{r}
ovl <- intersect(lipBaseRes$tFeatSigRes$Var1, proDALipBaseRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDALipBaseRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```

## Follow-up samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(lipPlasmaVsn)$Condition != 'Baseline')
lipFolo <- lipPlasmaVsn[, smpFoloIdx]

# Perform analysis
lipFoloRes <- SOA(lipFolo, fac = 'Recurrence', num_feats = 30)
datMat <- lipFoloRes$data
smpAnno <- lipFoloRes$smpMetadata
tFeatSigRes <- lipFoloRes$tFeatSigRes
tPCASigRes <- lipFoloRes$tPCASigRes
pcaRes <- lipFoloRes$pcaRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Follow-up plasma lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entities that are significantly associated with cancer recurrence. Note
that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDALipFoloRes <- proDA::test_diff(fit,
                                        contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                        sort_by = 'pval')
proDALipFoloRes <- dplyr::select(all_proDALipFoloRes,
                                 -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDALipFoloRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDALipFoloRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder], #Feature794 only has 2 observed values
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Follow-up plasma lipidomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(FolloPlasmaLipid_Feats = proDALipFoloRes))
```

```{r}
ovl <- intersect(lipFoloRes$tFeatSigRes$Var1, proDALipFoloRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDALipFoloRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```

## Changes in time course
Differences between Follow-up and Baseline samples (Follow-up matrix - baseline
matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset Baseline samples
smpBaseIdx <- which(colData(lipPlasmaVsn)$Condition == 'Baseline')
lipBase <- lipPlasmaVsn[, smpBaseIdx]
# Subset follow-up samples
smpFoloIdx <- which(colData(lipPlasmaVsn)$Condition != 'Baseline')
lipFolo <- lipPlasmaVsn[, smpFoloIdx]
# Modify column names for matching two matrices
colnames(lipBase) <- stringr::str_remove(colnames(lipBase), '_P_B')
colnames(lipFolo) <- stringr::str_remove(colnames(lipFolo), '_P_R')
# Retrieve data matrix
lipBaseMat <- SummarizedExperiment::assay(lipBase)
lipFoloMat <- SummarizedExperiment::assay(lipFolo)
# Subtract follow-up matrix by baseline matrix
if (identical(colnames(lipBaseMat), colnames(lipFoloMat)) &
    identical(rownames(lipBaseMat), rownames(lipFoloMat))) {
  lipPlasmaDiffMat <- lipFoloMat - lipBaseMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(lipBase)), Patient, Recurrence)
lipPlasmaDiff <- SummarizedExperiment(assays = lipPlasmaDiffMat, colData = colAnno)

# Perform analysis
lipPlasmaDiffRes <- SOA(lipPlasmaDiff, fac = 'Recurrence', num_feats = 30)
datMat <- lipPlasmaDiffRes$data
smpAnno <- lipPlasmaDiffRes$smpMetadata
tFeatSigRes <- lipPlasmaDiffRes$tFeatSigRes
tPCASigRes <- lipPlasmaDiffRes$tPCASigRes
pcaRes <- lipPlasmaDiffRes$pcaRes
pcTab <- lipPlasmaDiffRes$pcTab
pcTopFeatTab <- lipPlasmaDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, m.z_RT = plyr::mapvalues(Var1,
                                                                  from = featInfo$Feature,
                                                                  to = featInfo$m.z_RT,
                                                                  warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Differential plasma lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant entity differences that are significantly associated with cancer recurrence.
Note that there is no differentially abundant lipid.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDALipPlasmaDiffRes <- proDA::test_diff(fit,
                             contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                             sort_by = 'pval', n_max = 30) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::mutate(m.z_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F))
proDALipPlasmaDiffRes

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(DiffPlasmaLipid_Feats = proDALipPlasmaDiffRes))
```

We took top 30 differentially abundant features from proDA() to see overlaps
```{r}
ovl <- intersect(lipPlasmaDiffRes$tFeatSigRes$Var1, proDALipPlasmaDiffRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are overlapped between two methods:\n', ovl)

# Filter univariate result for making summarized plot
proDALipPlasmaDiffRes <- dplyr::filter(proDALipPlasmaDiffRes, pval < 0.05)
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential plasma lipidomics')
```

PC18 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC18, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential plasma lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Plot molecular signatures captured by PC18 in input data. We took a look at top
20 features with highest loadings and observed lipid levels of these top features
through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC18$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, scale = 'row',
                   main = 'Differential plasma lipidomics - PC18')

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC18, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(DiffPlasmaLipid_PC18 = pcTopFeats))
```




# Tissue Metabolomics
Based on PCA result obtained by analyzing whole Tissue Metabolomics dataset that
includes Tumor and Normal samples, we found that PCA mainly captures source of
variation in tissue conditions, which is not of direct interest. In addition,
Recurrence-related significant PCs do not work that well, perhaps because Tumor
and Normal samples are noise to each other. Therefore, we decided to analyze Tumor
and Normal samples separately.

```{r}
# Load normalized data
metaTissueVsn <- readRDS('./data/AG_Hopf/metaTissueVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(metaTissueVsn), rownames = 'Feature')

# Perform analysis
metaTissueRes <- SOA(metaTissueVsn, factor = c('Recurrence', 'Condition'))

tPCASigRes <- metaTissueRes$tPCASigRes
pcaRes <- metaTissueRes$pcaRes
pcTab <- metaTissueRes$pcTab
```

Display associations between learned PCs (Var1) and factors (Var2). Basically
t-test was performed to test significance of difference between two groups, e.g.,
recurrence and non-recurrence patient groups or tumor and normal sample groups.
```{r}
# Display PCs of interest
tPCASigRes
```

PCA tends to capture variation in sample conditions (tumor and normal) and those
PCs significantly associated with cancer recurrence do not perform that well.
```{r}
ggplot(pcTab, aes(x=PC1, y=PC2, col=Condition, shape=Recurrence, group=Patient)) +
  geom_point(size = 4) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))

ggplot(pcTab, aes(x=Recurrence, y=PC9, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Tumor samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(metaTissueVsn)$Condition == 'Tumor')
metaTumor <- metaTissueVsn[, smpTumorIdx]

# Perform analysis
metaTumorRes <- SOA(metaTumor, factor = 'Recurrence', num_feats = 30)

datMat <- metaTumorRes$data
smpAnno <- metaTumorRes$smpMetadata
tFeatSigRes <- metaTumorRes$tFeatSigRes
tPCASigRes <- metaTumorRes$tPCASigRes
pcaRes <- metaTumorRes$pcaRes
pcTab <- metaTumorRes$pcTab
pcTopFeatTab <- metaTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Tumor tissue metabolomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant metabolites in Tumor tissue that are significantly associated with cancer
recurrence. Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAMetaTumorRes <- proDA::test_diff(fit,
                                      contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                      sort_by = 'pval')
proDAMetaTumorRes <- dplyr::select(all_proDAMetaTumorRes,
                                   -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDAMetaTumorRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaTumorRes, dplyr::desc(t_statistic))$name
a <- pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue metabolomics (proDA)')
# ggsave(paste0(result_path, 'AG_Hopf/metaTumor_sigFeats.png'), plot = a, device = 'png', dpi = 400,
#        height = 8, width = 10)

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(TumorTissueMetab_Feats = proDAMetaTumorRes))
```

```{r}
ovl <- intersect(metaTumorRes$tFeatSigRes$Var1, proDAMetaTumorRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaTumorRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
# ggsave(paste0(result_path, 'AG_Hopf/metaTumor_topSigFeats.png'), device = 'png', dpi = 400,
#        height = 8, width = 10)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Tumor tissue metabolomics')
```

PC5 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC5, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # labs(title = 'Tumor tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))
# ggsave(paste0(result_path, 'AG_Hopf/metaTumor_pca.png'), device = 'png', dpi = 400,
#        height = 8, width = 10)
```

Plot molecular signatures captured by PC5 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
There is no single feature that can decently hint if patients will suffer cancer
recurrence or not, which means each of these top features contributes a bit to
explaining variation between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC5$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue metabolomics - PC5')
```

Display top features that build the PC5
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC5, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(TumorTissueMetab_PC5 = pcTopFeats))
```

## Normal samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(metaTissueVsn)$Condition == 'Normal')
metaNormal <- metaTissueVsn[, smpNormalIdx]

# Perform analysis
metaNormalRes <- SOA(metaNormal, factor = 'Recurrence', num_feats = 30)

datMat <- metaNormalRes$data
smpAnno <- metaNormalRes$smpMetadata
tFeatSigRes <- metaNormalRes$tFeatSigRes
tPCASigRes <- metaNormalRes$tPCASigRes
pcaRes <- metaNormalRes$pcaRes
pcTab <- metaNormalRes$pcTab
pcTopFeatTab <- metaNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Normal tissue metabolomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant metabolites in Normal tissue that are significantly associated with cancer
recurrence. Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDAMetaNormalRes <- proDA::test_diff(fit,
                                           contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                           sort_by = 'pval')
proDAMetaNormalRes <- dplyr::select(all_proDAMetaNormalRes,
                                    -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDAMetaNormalRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDAMetaNormalRes, dplyr::desc(t_statistic))$name
a <- pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Normal tissue metabolomics (proDA)')
# ggsave(paste0(result_path, 'AG_Hopf/metaNormal_sigFeats.png'), plot = a, device = 'png', dpi = 400,
#        height = 8, width = 10)

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(NormalTissueMetab_Feats = proDAMetaNormalRes))
```

```{r}
ovl <- intersect(metaNormalRes$tFeatSigRes$Var1, proDAMetaNormalRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDAMetaNormalRes$name[2:7]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
# ggsave(paste0(result_path, 'AG_Hopf/metaNormal_topSigFeats.png'), device = 'png', dpi = 400,
#        height = 8, width = 10)
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```

## Difference in tissue conditions
Differences between Tumor and Normal samples (Tumor matrix - Normal matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(metaTissueVsn)$Condition == 'Tumor')
metaTumor <- metaTissueVsn[, smpTumorIdx]
# Subset normal samples
smpNormalIdx <- which(colData(metaTissueVsn)$Condition == 'Normal')
metaNormal <- metaTissueVsn[, smpNormalIdx]
# Modify column names for matching two matrices
colnames(metaTumor) <- stringr::str_remove(colnames(metaTumor), '_TG')
colnames(metaNormal) <- stringr::str_remove(colnames(metaNormal), '_NG')
# Retrieve data matrix
metaTumorMat <- SummarizedExperiment::assay(metaTumor)
metaNormalMat <- SummarizedExperiment::assay(metaNormal)
# Subtract tumor matrix by normal matrix
if (identical(colnames(metaTumorMat), colnames(metaNormalMat)) &
    identical(rownames(metaTumorMat), rownames(metaNormalMat))) {
  metaTissueDiffMat <- metaTumorMat - metaNormalMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(metaTumor)), Patient, Recurrence)
metaTissueDiff <- SummarizedExperiment(assays = metaTissueDiffMat, colData = colAnno)

# Perform analysis
metaTissueDiffRes <- SOA(metaTissueDiff, factor = 'Recurrence', num_feats = 30)

datMat <- metaTissueDiffRes$data
smpAnno <- metaTissueDiffRes$smpMetadata
tFeatSigRes <- metaTissueDiffRes$tFeatSigRes
tPCASigRes <- metaTissueDiffRes$tPCASigRes
pcaRes <- metaTissueDiffRes$pcaRes
pcTab <- metaTissueDiffRes$pcTab
pcTopFeatTab <- metaTissueDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Differential tissue metabolomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant metabolite difference between Tumor and Normal tissues that are significantly
associated with cancer recurrence. Note that there is no differentially abundant metabolite.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDAMetaTissueDiffRes <- proDA::test_diff(fit,
                                           contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                           sort_by = 'pval', n_max = 30) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDAMetaTissueDiffRes

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(DiffTissueMetab_Feats = proDAMetaTissueDiffRes))
```

We took top 30 differentially abundant features from proDA() to see overlaps
```{r}
ovl <- intersect(metaTissueDiffRes$tFeatSigRes$Var1, proDAMetaTissueDiffRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are overlapped between two methods:\n', ovl)

# Filter univariate result for making summarized plot
proDAMetaTissueDiffRes <- dplyr::filter(proDAMetaTissueDiffRes, pval < 0.05)
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

There is no significant association between PCs (Var1) and cancer recurrence (Var2).
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential tissue metabolomics')
```




# Tissue Lipidomics
As described in Tissue Metabolomics section, we analyzed Tumor and Normal samples separately.

```{r}
# Load normalized data
lipTissueVsn <- readRDS('./data/AG_Hopf/lipTissueVsn.rds')
# Retrieve feature information for making significant feature table
featInfo <- tibble::as_tibble(rowData(lipTissueVsn), rownames = 'Feature')

# Perform analysis
lipTissueRes <- SOA(lipTissueVsn, factor = c('Recurrence', 'Condition'))

tPCASigRes <- lipTissueRes$tPCASigRes
pcaRes <- lipTissueRes$pcaRes
pcTab <- lipTissueRes$pcTab
```

Display associations between learned PCs (Var1) and factors (Var2). Basically
t-test was performed to test significance of difference between two groups, e.g.,
recurrence and non-recurrence patient groups or tumor and normal sample groups.
```{r}
# Display PCs of interest
tPCASigRes
```

PCA tends to capture variation in sample conditions (tumor and normal) and those
PCs significantly associated with cancer recurrence do not perform that well.
```{r}
ggplot(pcTab, aes(x=PC1, y=PC2, col=Condition, shape=Recurrence, group=Patient)) +
  geom_point(size = 4) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))

ggplot(pcTab, aes(x=Recurrence, y=PC24, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Tumor samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(lipTissueVsn)$Condition == 'Tumor')
lipTumor <- lipTissueVsn[, smpTumorIdx]

# Perform analysis
lipTumorRes <- SOA(lipTumor, factor = 'Recurrence', num_feats = 30)

datMat <- lipTumorRes$data
smpAnno <- lipTumorRes$smpMetadata
tFeatSigRes <- lipTumorRes$tFeatSigRes
tPCASigRes <- lipTumorRes$tPCASigRes
pcaRes <- lipTumorRes$pcaRes
pcTab <- lipTumorRes$pcTab
pcTopFeatTab <- lipTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Tumor tissue lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant lipids in Tumor tissue that are significantly associated with cancer recurrence.
Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDALipTumorRes <- proDA::test_diff(fit,
                                     contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                     sort_by = 'pval')
proDALipTumorRes <- dplyr::select(all_proDALipTumorRes,
                                  -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDALipTumorRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDALipTumorRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue lipidomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(TumorTissueLipid_Feats = proDALipTumorRes))
```

```{r}
ovl <- intersect(lipTumorRes$tFeatSigRes$Var1, proDALipTumorRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDALipTumorRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Tumor tissue lipidomics')
```

PC10 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC10, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tumor tissue lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))
```

Plot molecular signatures captured by PC10 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC10$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue lipidomics - PC10')
```

Display top features that build the PC10
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC10, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(TumorTissueLipid_PC10 = pcTopFeats))
```

Another PC that significantly separates recurrence and non-recurrence patients
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC13, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tumor tissue lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC13$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue lipidomics - PC13')

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC13, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(TumorTissueLipid_PC13 = pcTopFeats))
```

## Normal samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(lipTissueVsn)$Condition == 'Normal')
lipNormal <- lipTissueVsn[, smpNormalIdx]

# Perform analysis
lipNormalRes <- SOA(lipNormal, factor = 'Recurrence', num_feats = 30)

datMat <- lipNormalRes$data
smpAnno <- lipNormalRes$smpMetadata
tFeatSigRes <- lipNormalRes$tFeatSigRes
tPCASigRes <- lipNormalRes$tPCASigRes
pcaRes <- lipNormalRes$pcaRes
pcTab <- lipNormalRes$pcTab
pcTopFeatTab <- lipNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Normal tissue lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant lipids in Normal tissue that are significantly associated with cancer recurrence.
Note that features in heatmap are ordered by their t-statistics.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
all_proDALipNormalRes <- proDA::test_diff(fit,
                                      contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                      sort_by = 'pval')
proDALipNormalRes <- dplyr::select(all_proDALipNormalRes,
                                   -c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::filter(pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDALipNormalRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(proDALipNormalRes, dplyr::desc(t_statistic))$name
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Normal tissue lipidomics (proDA)')

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(NormalTissueLipid_Feats = proDALipNormalRes))
```

```{r}
ovl <- intersect(lipNormalRes$tFeatSigRes$Var1, proDALipNormalRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are tested significant by both methods:\n', ovl)
```

Visualize data of top 6 significant features based on proDA result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- proDALipNormalRes$name[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Normal tissue lipidomics')
```

PC14 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC14, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Normal tissue lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))
```

Plot molecular signatures captured by PC14 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC14$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue lipidomics - PC14')
```

Display top features that build the PC14
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC14, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(NormalTissueLipid_PC14 = pcTopFeats))
```

## Difference in tissue conditions
Differences between Tumor and Normal samples (Tumor matrix - Normal matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(lipTissueVsn)$Condition == 'Tumor')
lipTumor <- lipTissueVsn[, smpTumorIdx]
# Subset normal samples
smpNormalIdx <- which(colData(lipTissueVsn)$Condition == 'Normal')
lipNormal <- lipTissueVsn[, smpNormalIdx]
# Modify column names for matching two matrices
colnames(lipTumor) <- stringr::str_remove(colnames(lipTumor), '_TG')
colnames(lipNormal) <- stringr::str_remove(colnames(lipNormal), '_NG')
# Retrieve data matrix
lipTumorMat <- SummarizedExperiment::assay(lipTumor)
lipNormalMat <- SummarizedExperiment::assay(lipNormal)
# Subtract tumor matrix by normal matrix
if (identical(colnames(lipTumorMat), colnames(lipNormalMat)) &
    identical(rownames(lipTumorMat), rownames(lipNormalMat))) {
  lipTissueDiffMat <- lipTumorMat - lipNormalMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(lipTumor)), Patient, Recurrence)
lipTissueDiff <- SummarizedExperiment(assays = lipTissueDiffMat, colData = colAnno)

# Perform analysis
lipTissueDiffRes <- SOA(lipTissueDiff, factor = 'Recurrence', num_feats = 30)

datMat <- lipTissueDiffRes$data
smpAnno <- lipTissueDiffRes$smpMetadata
tFeatSigRes <- lipTissueDiffRes$tFeatSigRes
tPCASigRes <- lipTissueDiffRes$tPCASigRes
pcaRes <- lipTissueDiffRes$pcaRes
pcTab <- lipTissueDiffRes$pcTab
pcTopFeatTab <- lipTissueDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
sigFeatTab <- dplyr::mutate(tFeatSigRes, MZ.RT = plyr::mapvalues(Var1,
                                                                 from = featInfo$Feature,
                                                                 to = featInfo$MZ.RT,
                                                                 warn_missing = F))
sigFeatTab

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Differential tissue lipidomics')
```

Use probabilistic dropout model to account for missing values and identify differentially
abundant lipid difference between Tumor and Normal tissues that are significantly
associated with cancer recurrence. Note that there is no differentially abundant lipid.
```{r}
# Fit linear probabilistic dropout model to normalized data
fit <- proDA::proDA(datMat, design = ~ smpAnno$Recurrence)
# fit

# Check coefficient names for Parameter 'contrast' in proDA::test_diff()
# proDA::result_names(fit)
# Identify significant differentially abundant entities
proDALipTissueDiffRes <- proDA::test_diff(fit,
                                          contrast = Intercept + `smpAnno$RecurrenceYes` - Intercept,
                                          sort_by = 'pval', n_max = 30) %>%
  dplyr::select(-c(diff, se, df, avg_abundance, n_approx)) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
proDALipTissueDiffRes

# Store table in list for creating Excel file
# sigFeatSheet <- append(sigFeatSheet, list(DiffTissueLipid_Feats = proDALipTissueDiffRes))
```

We took top 30 differentially abundant features from proDA() to see overlaps
```{r}
ovl <- intersect(lipTissueDiffRes$tFeatSigRes$Var1, proDALipTissueDiffRes$name)
cat('The following features', paste0('(n =', length(ovl), ')'),
    'are overlapped betweeb two methods:\n', ovl)

# Filter univariate result for making summarized plot
proDALipTissueDiffRes <- dplyr::filter(proDALipTissueDiffRes, pval < 0.05) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(name,
                                        from = featInfo$Feature,
                                        to = featInfo$MZ.RT,
                                        warn_missing = F))
```

Visualize data of top 6 significant features based on regular t-test result
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential tissue lipidomics')
```

PC15 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC15, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential tissue lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F)
```

Plot molecular signatures captured by PC15 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC15$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential tissue metabolomics - PC15')

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC15, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(DiffTissueLipid_PC15 = pcTopFeats))
```

Another PC that significantly separates recurrence and non-recurrence patients
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC6, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential tissue lipidomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 6,
                             method.args = list(var.equal = T), hjust = 0.65,
                             show.legend = F) +
  theme(axis.title = element_text(size = 16),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC6$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential tissue lipidomics - PC6')

# Display top features with highest loadings of PC of interest
pcTopFeats <- dplyr::left_join(pcTopFeatTab$PC6, featInfo, by = 'Feature')
pcTopFeats

# Store table in list for creating Excel file
sigFeatSheet <- append(sigFeatSheet, list(DiffTissueLipid_PC6 = pcTopFeats))
```




# Summary

```{r}
# Export tables containing significant features as Excel file
# write.xlsx(sigFeatSheet,
#            file = paste0(project_path, 'results/single-omics_significant_features.xlsx'))
```

Display proportion of significant features that can separate cancer recurrence and
non-recurrence patient groups in each dataset. Numbers after bars indicate total
feature numbers.

**proDA R package that accounts for missing values**
```{r}
# Barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats <- nrow(proDAMetaBaseRes) / nrow(metaBaseRes$data) * 100
metaFoloSigFeats <- nrow(proDAMetaFoloRes) / nrow(metaFoloRes$data) * 100
lipBaseSigFeats <- nrow(proDALipBaseRes) / nrow(lipBaseRes$data) * 100
lipFoloSigFeats <- nrow(proDALipFoloRes) / nrow(lipFoloRes$data) * 100
metaTumorSigFeats <- nrow(proDAMetaTumorRes) / nrow(metaTumorRes$data) * 100
metaNormalSigFeats <- nrow(proDAMetaNormalRes) / nrow(metaNormalRes$data) * 100
lipTumorSigFeats <- nrow(proDALipTumorRes) / nrow(lipTumorRes$data) * 100
lipNormalSigFeats <- nrow(proDALipNormalRes) / nrow(lipNormalRes$data) * 100

# Prepare needed information for barplot
dat <- rev(c('Baseline Plasma Metabolomics', 'Follow-up Plasma Metabolomics',
             'Baseline Plasma Lipidomics', 'Follow-up Plasma Lipidomics',
             'Tumor Tissue Metabolomics', 'Normal Tissue Metabolomics',
             'Tumor Tissue Lipidomics', 'Normal Tissue Lipidomics'))
datModal <- rev(c(rep('Plasma Metabolomics', 2), rep('Plasma Lipidomics', 2),
                  rep('Tissue Metabolomics', 2), rep('Tissue Lipidomics', 2)))
datOf <- rev(c(rep('Plasma', 4), rep('Tissue', 4)))
proportion <- rev(c(metaBaseSigFeats, metaFoloSigFeats,
                    lipBaseSigFeats, lipFoloSigFeats,
                    metaTumorSigFeats, metaNormalSigFeats,
                    lipTumorSigFeats, lipNormalSigFeats))
numFeat <- rev(c(rep(nrow(metaBaseRes$data), 2), rep(nrow(lipBaseRes$data), 2),
                 rep(nrow(metaTumorRes$data), 2), rep(nrow(lipTumorRes$data), 2)))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = dat),
                             Data_modality = datModal,
                             Data_of = datOf,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill=Data_of, label=Feature_number)) +
  geom_bar(stat = 'identity') +
  ylim(0, 9) +
  coord_flip() +
  geom_text(size = 5, hjust = -0.2) +
  labs(y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Sample Type') +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 12),
        legend.title = element_text(size = 14), legend.text = element_text(size = 12))
# ggsave(paste0(result_path, 'AG_Hopf/proporSigFeats.png'), device = 'png', dpi = 400,
#        height = 8, width = 10)
```

**Regular significance test that does not account for missing values**
```{r}
# Barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats <- nrow(metaBaseRes$tFeatSigRes) / nrow(metaBaseRes$data) * 100
metaFoloSigFeats <- nrow(metaFoloRes$tFeatSigRes) / nrow(metaFoloRes$data) * 100
# metaPlasmaDiffSigFeats <- nrow(metaPlasmaDiffRes$tFeatSigRes) / nrow(metaPlasmaDiffRes$data) * 100
lipBaseSigFeats <- nrow(lipBaseRes$tFeatSigRes) / nrow(lipBaseRes$data) * 100
lipFoloSigFeats <- nrow(lipFoloRes$tFeatSigRes) / nrow(lipFoloRes$data) * 100
# lipPlasmaDiffSigFeats <- nrow(lipPlasmaDiffRes$tFeatSigRes) / nrow(lipPlasmaDiffRes$data) * 100
metaTumorSigFeats <- nrow(metaTumorRes$tFeatSigRes) / nrow(metaTumorRes$data) * 100
metaNormalSigFeats <- nrow(metaNormalRes$tFeatSigRes) / nrow(metaNormalRes$data) * 100
# metaTissueDiffSigFeats <- nrow(metaTissueDiffRes$tFeatSigRes) / nrow(metaTissueDiffRes$data) * 100
lipTumorSigFeats <- nrow(lipTumorRes$tFeatSigRes) / nrow(lipTumorRes$data) * 100
lipNormalSigFeats <- nrow(lipNormalRes$tFeatSigRes) / nrow(lipNormalRes$data) * 100
# lipTissueDiffSigFeats <- nrow(lipTissueDiffRes$tFeatSigRes) / nrow(lipTissueDiffRes$data) * 100

# Prepare needed information for barplot
dat <- rev(c('Baseline Plasma Metabolomics', 'Follow-up Plasma Metabolomics',#'Differential Plasma Metabolomics',
             'Baseline Plasma Lipidomics', 'Follow-up Plasma Lipidomics',#'Differential Plasma Lipidomics',
             'Tumor Tissue Metabolomics', 'Normal Tissue Metabolomics',#'Differential Tissue Metabolomics',
             'Tumor Tissue Lipidomics', 'Normal Tissue Lipidomics'))#'Differential Tissue Lipidomics'
datModal <- rev(c(rep('Plasma Metabolomics', 2), rep('Plasma Lipidomics', 2),
                  rep('Tissue Metabolomics', 2), rep('Tissue Lipidomics', 2)))
proportion <- rev(c(metaBaseSigFeats, metaFoloSigFeats, #metaPlasmaDiffSigFeats,
                    lipBaseSigFeats, lipFoloSigFeats, #lipPlasmaDiffSigFeats,
                    metaTumorSigFeats, metaNormalSigFeats, #metaTissueDiffSigFeats,
                    lipTumorSigFeats, lipNormalSigFeats)) #lipTissueDiffSigFeats
numFeat <- rev(c(rep(nrow(metaBaseRes$data), 2), rep(nrow(lipBaseRes$data), 2),
                 rep(nrow(metaTumorRes$data), 2), rep(nrow(lipTumorRes$data), 2)))
sigFeatPropTab <- data.frame(Data = factor(dat, levels = dat),
                             Data_modality = datModal,
                             Proportion = proportion,
                             Feature_number = numFeat)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill=Data_modality, label=Feature_number)) +
  geom_bar(stat = 'identity') +
  ylim(0, 11) +
  coord_flip() +
  geom_text(hjust = -0.4) +
  labs(y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Data modality')
```
1. Plasma datasets got overall higher proportions of Recurrence-related features
than Tissue while they have similar feature sizes. This unbiased result indicates
that Plasma samples can potentially provide more information in terms of separating
recurrence and non-recurrence patient groups and Tissue samples are more noisy.\
2. There is a way higher proportion of Recurrence-related features in Follow-up
Plasma Lipidomics compared to the results of the other datasets, and in the meantime,
there are much more replicated features (same m/z and retention time) in Plasma
Lipidomics dataset (check the preprocessing report of the Untargeted data). Are
many of these Recurrence-related features replicates? No, there are only 3 (out
of 255) replicates in the significance test result, which is negligible.
<br/>
<br/>

```{r, include = F, eval = F}
# Retrieve m/z and retention time information of features
featInfo <- tibble::as_tibble(rowData(lipPlasmaVsn), rownames = 'Feature')
# Collect duplicated features, i.e., identical m/z and retention time
dupMZ.RT <- rowData(lipPlasmaVsn)$`m/z_RT`
dupMZ.RT <- unique(dupMZ.RT[duplicated(dupMZ.RT)])
cat('There are', length(dupMZ.RT), 'features in replicate in Plasma Lipidomics,',
    'resulting in total', sum(featInfo$m.z_RT %in% dupMZ.RT), 'replicated features.')

# Display duplicated features in significance test result not accounting for missing
# values
dplyr::select(lipFoloRes$tFeatSigRes, Var1) %>%
  dplyr::mutate(MZ_RT = plyr::mapvalues(Var1,
                                        from = featInfo$Feature,
                                        to = featInfo$m.z_RT,
                                        warn_missing = F)) %>%
  dplyr::filter(MZ_RT %in% dupMZ.RT, duplicated(MZ_RT))
# Display duplicated features in significance test result accounting for missing
# values
# dplyr::filter(proDALipFoloRes, MZ_RT %in% dupMZ.RT)
```

Visualize Recurrence-related features through volcano plots. Significance results
were done by proDA R package that uses probabilistic dropout model to account for
data missingness, which makes t-test results more reliable. Log2-FC (up and down)
is recurrence to non-recurrence groups. To be clearer, entities on up side are more
abundant in recurrence group than non-recurrence group, and so forth.
```{r message = F}
# Volcano plots for summarizing association test results between features and
# cancer recurrence
# Prepare feature information for converting feature IDs to m/z ratio and retention
# time
metaPlasmaFeatInfo <- tibble::as_tibble(rowData(metaPlasmaVsn), rownames = 'Feature_ID')
lipPlasmaFeatInfo <- tibble::as_tibble(rowData(lipPlasmaVsn), rownames = 'Feature_ID')
metaTissueFeatInfo <- tibble::as_tibble(rowData(metaTissueVsn), rownames = 'Feature_ID')
lipTissueFeatInfo <- tibble::as_tibble(rowData(lipTissueVsn), rownames = 'Feature_ID')

# Prepare log2-fold change information
# PM
metaPlasmaMedi <- readRDS('./data/AG_Hopf/metaPlasmaMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPM
metaBaseLogFC <- dplyr::filter(metaPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPM
metaFoloLogFC <- dplyr::filter(metaPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# PL
lipPlasmaMedi <- readRDS('./data/AG_Hopf/lipPlasmaMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPL
lipBaseLogFC <- dplyr::filter(lipPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPL
lipFoloLogFC <- dplyr::filter(lipPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TM
metaTissueMedi <- readRDS('./data/AG_Hopf/metaTissueMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTM
metaTumorLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTM
metaNormalLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TL
lipTissueMedi <- readRDS('./data/AG_Hopf/lipTissueMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample_ID') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTL
lipTumorLogFC <- dplyr::filter(lipTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTL
lipNormalLogFC <- dplyr::filter(lipTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)


# Collect all needed information for volcano plots
# Baseline Plasma Metabolomics
metaBaseVolTab <- dplyr::select(all_proDAMetaBaseRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(metaBaseLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Baseline Plasma Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaPlasmaFeatInfo$Feature_ID,
                                        to = metaPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))
# Follow-up Plasma Metabolomics
metaFoloVolTab <- dplyr::select(all_proDAMetaFoloRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(metaFoloLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Follow-up Plasma Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaPlasmaFeatInfo$Feature_ID,
                                        to = metaPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))

# Baseline Plasma Lipidomics
lipBaseVolTab <- dplyr::select(all_proDALipBaseRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(lipBaseLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Baseline Plasma Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipPlasmaFeatInfo$Feature_ID,
                                        to = lipPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))
# Follow-up Plasma Lipidomics
lipFoloVolTab <- dplyr::select(all_proDALipFoloRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(lipFoloLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Follow-up Plasma Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipPlasmaFeatInfo$Feature_ID,
                                        to = lipPlasmaFeatInfo$m.z_RT,
                                        warn_missing = F))

# Tumor Tissue Metabolomics
metaTumorVolTab <- dplyr::select(all_proDAMetaTumorRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(metaTumorLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Tumor Tissue Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaTissueFeatInfo$Feature_ID,
                                        to = metaTissueFeatInfo$MZ.RT,
                                        warn_missing = F))
# Normal Tissue Metabolomics
metaNormalVolTab <- dplyr::select(all_proDAMetaNormalRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(metaNormalLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Normal Tissue Metabolomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = metaTissueFeatInfo$Feature_ID,
                                        to = metaTissueFeatInfo$MZ.RT,
                                        warn_missing = F))

# Tumor Tissue Lipidomics
lipTumorVolTab <- dplyr::select(all_proDALipTumorRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(lipTumorLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Tumor Tissue Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipTissueFeatInfo$Feature_ID,
                                        to = lipTissueFeatInfo$MZ.RT,
                                        warn_missing = F))
# Normal Tissue Lipidomics
lipNormalVolTab <- dplyr::select(all_proDALipNormalRes, name, pval) %>%
  dplyr::rename(Feature = name, pVal = pval) %>%
  dplyr::left_join(lipNormalLogFC, by = 'Feature') %>%
  dplyr::mutate(Data = 'Normal Tissue Lipidomics',
                MZ.RT = plyr::mapvalues(Feature,
                                        from = lipTissueFeatInfo$Feature_ID,
                                        to = lipTissueFeatInfo$MZ.RT,
                                        warn_missing = F))
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# BPM
volTab <- metaBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Metabolomics')
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# FPM
volTab <- metaFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Metabolomics')
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# BPL
volTab <- lipBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Lipidomics')
# ggsave('./output/AG_Hopf/volcano_BPL.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Log2-FC cutoffs are 1 (FC=2) and -1 (FC=0.5).
```{r}
# FPL
volTab <- lipFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 1] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -1] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-1, 1), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Lipidomics')
```

Log2-FC cutoffs are 0.5 (FC=1.4) and -0.5 (FC=0.7).
```{r}
# TTM
volTab <- metaTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Metabolomics')
```

Log2-FC cutoffs are 0.5 (FC=1.4) and -0.5 (FC=0.7).
```{r}
# NTM
volTab <- metaNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Metabolomics')
```

Log2-FC cutoffs are 0.7 (FC=1.6) and -0.7 (FC=0.6).
```{r}
# TTL
volTab <- lipTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Lipidomics')
```

Log2-FC cutoffs are 0.9 (FC=1.9) and -0.9 (FC=0.5).
```{r}
# NTL
volTab <- lipNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.9] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.9] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.9, 0.9), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 3, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Lipidomics')
```

```{r include = F, eval = F}
# Baseline and follow-up plasma datasets
# Combine result tables for plotting
volTab <- dplyr::bind_rows(metaBaseVolTab, metaFoloVolTab,
                           lipBaseVolTab, lipFoloVolTab)
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.9] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.9] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.9, 0.9), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 2, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  facet_wrap(vars(Data)) +
  labs(x = 'log2(FC)')

# Tumor and normal tissue datasets
# Combine result tables for plotting
volTab <- dplyr::bind_rows(metaTumorVolTab, metaNormalVolTab,
                           lipTumorVolTab, lipNormalVolTab)
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.9] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.9] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$MZ.RT[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.2) +
  geom_vline(xintercept = c(-0.9, 0.9), col = 'red', linewidth = 0.2) +
  geom_text_repel(size = 2, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  facet_wrap(vars(Data)) +
  labs(x = 'log2(FC)')
```
