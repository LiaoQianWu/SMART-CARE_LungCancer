---
title: 'Preprocessing: Untargeted Lipidomics of Discovery cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Preprocess Discovery Tissue and Plasma Untargeted Lipidomics
generated by Dr. Qiuqin Zhou from AG Hopf, including data cleansing, filtering (by
RT, QC RSD%, missing values, etc.), normalization (VSN), and batch correction if
needed. All needed information was then stored in SummarizedExperiment objects for
further analyses. Besides, datasets generated by different levels of within-batch
correction and batches used were compared to determine best parameters. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer')
```

Load libraries
```{r load libraries, message=F}
library(readr)
library(readxl)
library(vsn)
library(limma)
library(visdat)
library(ggrepel)
library(ggvenn)
library(SummarizedExperiment)
library(tidyverse)
# Load user-defined functions
source('./code/analysis_pipeline.R')
source('./code/misc.R')
source('./code/comparison_funcs.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
th4MissViz <- theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0,
                                               size = 11, face = 'bold'),
                    axis.text.y = element_blank(),
                    axis.title.y = element_text(size = 13, face = 'bold'),
                    legend.text = element_text(size = 12, face = 'bold'))
```

```{r prepare global info, message=F}
# Load sample metadata
smpMetadat <- readxl::read_excel('./data/sample_metadata.xlsx')
colnames(smpMetadat) <- smpMetadat[3,, drop = F]
smpMetadat <- dplyr::slice(smpMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Parents, Visit, `Material submitted`, `Date and time of collection or surgery`,
                  `SMART-CARE cohort identifier`)) %>%
  dplyr::rename(Sample = Code, Patient = Parents, TimePoint = Visit, SmpType = `Material submitted`,
                Date = `Date and time of collection or surgery`, Cohort = `SMART-CARE cohort identifier`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^SC_T_S_|^SC_DIS_S_|^SC_S_|_P'),
                Patient = stringr::str_remove(Patient, '^/THRX_SPACE/THRX_DB/'),
                TimePoint = dplyr::case_when(TimePoint == 'PRETHERAPEUTIC' ~ 'Baseline',
                                             TimePoint == 'FOLLOW-UP' ~ 'Follow-up',
                                             TimePoint == 'RECURRENCE' ~ 'Recurrence'),
                SmpType = dplyr::case_when(SmpType == 'EDTA_PLASMA' ~ 'Plasma',
                                           SmpType == 'FRESH_FROZEN_TISSUE' ~ 'Tissue'),
                Condition = dplyr::case_when(grepl('_TU|_TG', Sample) ~ 'Tumor',
                                             grepl('_NG', Sample) ~ 'Normal',
                                             !grepl('_TU|_TG|_NG', Sample) ~ TimePoint),
                TimePoint = dplyr::case_when(TimePoint %in% 'Recurrence' ~ 'Follow-up',
                                             !TimePoint %in% 'Recurrence' ~ TimePoint),
                Date = stringr::str_extract(Date, '^\\d+-\\d+-\\d+'),
                Cohort = dplyr::case_when(Cohort == 'DISCOVERY_COHORT' ~ 'Discovery',
                                          Cohort == 'METHOD_DEVELOPMENT_COHORT' ~ 'MethodDev'),
                Date = as.Date(Date, format = '%Y-%m-%d'))

# Load patient metadata
patientMetadat <- readxl::read_excel('./data/patient_metadata.xlsx')
colnames(patientMetadat) <- patientMetadat[3,, drop = F]
patientMetadat <- dplyr::slice(patientMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Gender, `Age at diagnosis`, `Pathological stage`, `Smoking status`,
                  `Adjuvant chemotherapy`,)) %>%
  dplyr::rename(Patient = Code, Age = `Age at diagnosis`, Stage = `Pathological stage`,
                Smoking = `Smoking status`, Adjuvant = `Adjuvant chemotherapy`) %>%
  dplyr::mutate(Gender = dplyr::case_when(Gender == 'MALE' ~ 'Male',
                                          Gender == 'FEMALE' ~ 'Female'),
                Smoking = dplyr::case_when(Smoking == 'SMOKER' ~ 'Smoker',
                                           Smoking == 'EX-SMOKER' ~ 'Ex-smoker',
                                           Smoking == 'NON-SMOKER' ~ 'Non-smoker'),
                Adjuvant = dplyr::case_when(Adjuvant == 'true' ~ 'True',
                                            Adjuvant == 'false' ~ 'False'),
                Age = as.numeric(Age))
# Include patient recurrence information in patient metadata
recurPats <- dplyr::filter(smpMetadat, Condition == 'Recurrence') %>%
  dplyr::pull(Patient)
patientMetadat <- dplyr::mutate(patientMetadat, Recurrence = dplyr::case_when(Patient %in% recurPats ~ 'Yes',
                                                                              !Patient %in% recurPats ~ 'No'))

# Load aliquot metadata
aliquotMetadat <- readxl::read_excel('./data/aliquot_metadata.xlsx')
colnames(aliquotMetadat) <- aliquotMetadat[3,, drop = F]
aliquotMetadat <- dplyr::slice(aliquotMetadat, -c(1:3)) %>%
  dplyr::select(Code, Parents, `Tumor Cell Content (%)`, `Cohort Identifier`, `Submission to`,
                `Delivered?`) %>%
  dplyr::rename(Aliquot = Code, Sample = Parents, TumorPurity = `Tumor Cell Content (%)`,
                Cohort = `Cohort Identifier`, To = `Submission to`, Delivered = `Delivered?`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^/THRX_SPACE/THRX_DB/SC_T_S_|_P'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_'),
                Cohort = dplyr::case_when(Cohort == 'method establishment' ~ 'MethodDev',
                                          Cohort == 'DISCOVERY_COHORT' ~ 'Discovery'),
                TumorPurity = as.numeric(TumorPurity),
                # Mislabeling??
                Sample = case_when(Sample %in% 'SDIR55_NG' ~ 'PDIR55_NG',
                                   Sample %in% 'SDIR55_TU' ~ 'PDIR55_TU',
                                   !Sample %in% c('SDIR55_NG', 'SDIR55_TU') ~ Sample)) %>%
  dplyr::filter(To %in% 'HOPF')
# Prepare tumor purity information
tumorPurityInfo <- dplyr::select(aliquotMetadat, Sample, TumorPurity)

# Combine all needed metadata
summMetadat <- dplyr::left_join(smpMetadat, patientMetadat, by = 'Patient') %>%
  dplyr::left_join(tumorPurityInfo, by = 'Sample')
summMetadat4Discovery <- dplyr::select(aliquotMetadat, Aliquot, Sample, TumorPurity) %>%
  dplyr::left_join(smpMetadat, by = 'Sample') %>%
  dplyr::left_join(patientMetadat, by = 'Patient')

# List sample annotations to keep in SE objects
smpAnno <- c('Patient', 'SmpType', 'TimePoint', 'Date', 'Cohort', 'Condition',
             'Recurrence', 'Gender', 'Age', 'Smoking', 'Stage', 'Adjuvant')
```

# Tissue Lipidomics

## WBC-25%

```{r message=F}
# Load data
lipTissueWBC25 <- readxl::read_excel('./data/Discovery/AG_Hopf/Feature table_Discoverycohort_tissue_lipids_20240320.xlsx',
                                     sheet = '25 percent within-batch correct')
# Assign column names
colnames(lipTissueWBC25) <- lipTissueWBC25[6,]
lipTissueWBC25 <- lipTissueWBC25[-seq_len(6),]
# Store red flag features (intensity blank / sample >= 3)
redFlagFeats <- lipTissueWBC25$Flags
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipTissueWBC25 <- dplyr::select(lipTissueWBC25, -c(`M meas,`, Ions, `MS/MS`, Boxplot)) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %>%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, '/', CCS, '/', MZ),
                Flags = redFlagFeats) %>%
  dplyr::filter(RT >= 0.3, RT <= 9) %>%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab <- lipTissueWBC25
if (!any(duplicated(tidyTab$Feature))) {
  summFilt <- c(`Ori feat num` = nrow(tidyTab), `m/z < 300` = sum(tidyTab$MZ < 300),
                `QC RSD% > 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD < 25, na.rm = T),
                `Red flag feats` = sum(grepl('RED', tidyTab$Flags)),
                `QC RSD% > 25` = sum(tidyTab$QC_RSD > 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat('There are duplicated features!')
}
WBC25 <- summFilt
rm(tidyTab, summFilt)
####

lipTissueWBC25 <- dplyr::filter(lipTissueWBC25, MZ >= 300, QC_RSD <= 25, !grepl('RED', Flags)) %>%
  dplyr::select(-c(QC_RSD, contains('Pooled QC Tissue'), contains('Processed blank'), Flags))

# Convert data into long data and combine it with summarized metadata
lipTissueWBC25 <- tidyr::pivot_longer(lipTissueWBC25, cols = -c('Feature', 'RT', 'CCS', 'MZ'),
                                      names_to = 'Aliquot', values_to = 'Abundance') %>%
  dplyr::mutate(Aliquot = stringr::str_remove(Aliquot, '_pos.+'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% 'SC_DIS_A_PDIR55_TU3' ~ 'SC_DIS_A_PDIR55_TU2',
                                    Aliquot %in% 'SC_DIS_A_1QFJ7P_TU3' ~ 'SC_DIS_A_1QFJ7P_TU1',
                                    Aliquot %in% 'SC_DIS_A_8ZSMVV_NG1' ~ 'SC_DIS_A_8ZSMVV_NG3',
                                    !Aliquot %in% c('SC_DIS_A_PDIR55_TU3',
                                                    'SC_DIS_A_1QFJ7P_TU3',
                                                    'SC_DIS_A_8ZSMVV_NG1') ~ Aliquot)) %>%
  dplyr::left_join(summMetadat4Discovery, by = 'Aliquot') %>%
  dplyr::select(-Aliquot)

# Keep only samples with good quality (decent tumor purity)
proTissue <- readRDS('./data/Discovery/AG_Krijgsveld/proTissueVsn.rds')
lipTissueWBC25 <- lipTissueWBC25[lipTissueWBC25$Patient %in% unique(colData(proTissue)$Patient),]
```

<font size='2'> **Vsn normalized data BEFORE filtered by missingness** for checking
associations between data and sample median expressions and missing levels </font>
```{r message=F}
# Normalize unfiltered data
lipTissueTab <- lipTissueWBC25
lipTissueUnfiltVsn <- doPreprocessing(lipTissueTab, feat = 'Feature', smp = 'Sample',
                                      val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                                      smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipTissueUnfiltVsnTab <- summExp2df(lipTissueUnfiltVsn, assay = 'Abundance',
                                    row_id = 'Feature', col_id = 'Sample') %>%
  # Prepare information of sample median expressions and missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MedianVsnAbun = median(Value, na.rm = T),
                OriMissLevel = sum(is.na(Value)) / length(Value)) %>%
  dplyr::ungroup()
# Create SE object containing information of sample median expressions and missing levels
colAnno <- dplyr::select(lipTissueUnfiltVsnTab, Sample, MedianVsnAbun, OriMissLevel) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
lipTissueUnfiltVsn <- SummarizedExperiment(assays = list(Abundance = assay(lipTissueUnfiltVsn)),
                                           colData = colAnno)
# Show dimensions of data
cat('Data dimensions:', dim(lipTissueUnfiltVsn)[2], 'samples and', dim(lipTissueUnfiltVsn)[1], 'features')

# Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Unfiltered data') +
  th4MissViz + theme(axis.text.x = element_text(size = 9))

# Visualize data distribution
ggplot(lipTissueUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 9))

# Visualize relationship between sample median expressions and missing levels
ggplot(lipTissueUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(x = 'Missing level', y = 'Median expression') +
  th

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipTissueUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Do PCA
pcaRes <- doSOA(lipTissueUnfiltVsn, meta_var = c('MedianVsnAbun', 'OriMissLevel'),
                pca_method = 'pca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes
```

```{r}
# Visualize relationship between PCs and sample median expressions and missing levels
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC2 (11.9%)`, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Median expression') +
  th

ggplot(pcTab, aes(x=`PC2 (11.9%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Missing level') +
  th
```

<font size='2'> **Vsn normalized data AFTER filtered by missingness** </font>\
Features quantified in less than 2/3 of samples are removed.
```{r}
# Filter and normalize data
lipTissueTab <- lipTissueWBC25
lipTissue <- doPreprocessing(lipTissueTab, feat = 'Feature', smp = 'Sample',
                             val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                             smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
lipTissueFilt <- lipTissue$filt.data
lipTissueFiltVsn <- lipTissue$vsn.data
# Prepare long data for plotting
lipTissueFiltVsnTab <- summExp2df(lipTissueFiltVsn, assay = 'Abundance',
                                  row_id = 'Feature', col_id = 'Sample')
# Show dimensions of data
cat('Data dimensions:', dim(lipTissueFiltVsn)[2], 'samples and', dim(lipTissueFiltVsn)[1], 'features')

# Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueFilt)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Filtered data') +
  th4MissViz + theme(axis.text.x = element_text(size = 9))

# Visualize data distribution
ggplot(lipTissueFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Filtered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 9))

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipTissueFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Save preprocessed data
saveRDS(lipTissueFiltVsn, './data/Discovery/AG_Hopf/lipTissueVsn_WBC25.rds')
```

**Do biological quality control**\
```{r}
# Do PCA
pcaRes <- doSOA(lipTissueFiltVsn, meta_var = c('Condition', 'Recurrence', 'Gender',
                                               'Age', 'Smoking', 'Stage', 'Adjuvant'),
                pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Label = case_when(Sample %in% c('1NL5BV_TU', '1NL5BV_NG',
                                                'I0HVOL_TU', 'I0HVOL_NG',
                                                '7EAOX7_TU', '7EAOX7_NG') ~ Sample))
ggplot(pcTab, aes(x=Condition, y=`PC1 (41.5%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

ggplot(pcTab, aes(x=`PC1 (41.5%)`, y=`PC2 (13.5%)`, col=Condition, label=Label)) +
  geom_point(size = 2.5) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  th
```
=> Tumor purity: I0HVOL_TU - 87% / 7EAOX7_TU - 70% / 1NL5BV_TU - 53%\
(Mean of sample tumor cell contents is 74%, ranging from 40% to 100%.)

```{r}
# Prepare information of sample missing levels
missInfo <- dplyr::group_by(lipTissueFiltVsnTab, Sample) %>%
  dplyr::summarise(MissLevel = sum(is.na(Value)) / length(Value)) %>%
  dplyr::filter(!duplicated(Sample))
# Show significant associations between PCs and sample missing levels
pcTab <- tibble::as_tibble(pcaRes$pcaRes@scores, rownames = 'Sample')
testAssociation(pcTab, missInfo, cmn_col = 'Sample') %>%
  dplyr::filter(pVal <= 0.05)

pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Label = case_when(Sample %in% c('1NL5BV_TU', '1NL5BV_NG',
                                                'I0HVOL_TU', 'I0HVOL_NG',
                                                '1VVXHY_TU', '1VVXHY_NG',
                                                'CMVZEW_TU', 'CMVZEW_NG',
                                                '1XUOU0_TU', '1XUOU0_NG',
                                                '1XGTDZ_TU', '1XGTDZ_NG',
                                                '11BMIX_TU', '11BMIX_NG',
                                                '1IHGAC_TU', '1IHGAC_NG',
                                                '1H3IW7_TU', '1H3IW7_NG',
                                                'Q7B5U6_TU', 'Q7B5U6_NG',
                                                'NVJH6R_TU', 'NVJH6R_NG',
                                                'Q89YQK_TU', 'Q89YQK_NG',
                                                'MJMTYR_TU', 'MJMTYR_NG') ~ Sample)) %>%
  dplyr::left_join(missInfo, by = 'Sample')

ggplot(pcTab, aes(x=`PC1 (41.5%)`, y=`PC2 (13.5%)`, col=MissLevel)) +
  geom_point(size = 2.5) +
  scale_color_continuous(name = 'Missing level (%)', type = 'viridis') +
  th

ggplot(pcTab, aes(x=`PC1 (41.5%)`, y=`PC2 (13.5%)`, col=Gender, label=Label)) +
  geom_point(size = 2.5) +
  geom_text_repel(size = 4, show.legend = F) +
  th
```

```{r}
lipTissueWBC25 <- lipTissueFiltVsn
WBC25 <- c(WBC25, `Filt feat num` = nrow(lipTissueWBC25))
```

## WBC-No

```{r message=F}
# Load data
lipTissueNoWBC <- readxl::read_excel('./data/Discovery/AG_Hopf/Feature table_Discoverycohort_tissue_lipids_20240320.xlsx',
                                     sheet = 'no within-batch correction')
# Assign column names
colnames(lipTissueNoWBC) <- lipTissueNoWBC[4,]
lipTissueNoWBC <- lipTissueNoWBC[-seq_len(4),]
# Store red flag features (intensity blank / sample >= 3)
redFlagFeats <- lipTissueNoWBC$Flags
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipTissueNoWBC <- dplyr::select(lipTissueNoWBC, -c(`M meas,`, Ions, `MS/MS`, Boxplot)) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %>%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, '/', CCS, '/', MZ),
                Flags = redFlagFeats) %>%
  dplyr::filter(RT >= 0.3, RT <= 9) %>%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab <- lipTissueNoWBC
if (!any(duplicated(tidyTab$Feature))) {
  summFilt <- c(`Ori feat num` = nrow(tidyTab), `m/z < 300` = sum(tidyTab$MZ < 300),
                `QC RSD% > 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD < 25, na.rm = T),
                `Red flag feats` = sum(grepl('RED', tidyTab$Flags)),
                `QC RSD% > 25` = sum(tidyTab$QC_RSD > 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat('There are duplicated features!')
}
NoWBC <- summFilt
rm(tidyTab, summFilt)
####

lipTissueNoWBC <- dplyr::filter(lipTissueNoWBC, MZ >= 300, QC_RSD <= 25, !grepl('RED', Flags)) %>%
  dplyr::select(-c(QC_RSD, contains('Pooled QC Tissue'), contains('Processed blank'), Flags))

# Convert data into long data and combine it with summarized metadata
lipTissueNoWBC <- tidyr::pivot_longer(lipTissueNoWBC, cols = -c('Feature', 'RT', 'CCS', 'MZ'),
                                      names_to = 'Aliquot', values_to = 'Abundance') %>%
  dplyr::mutate(Aliquot = stringr::str_remove(Aliquot, '_pos.+'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% 'SC_DIS_A_PDIR55_TU3' ~ 'SC_DIS_A_PDIR55_TU2',
                                    Aliquot %in% 'SC_DIS_A_1QFJ7P_TU3' ~ 'SC_DIS_A_1QFJ7P_TU1',
                                    Aliquot %in% 'SC_DIS_A_8ZSMVV_NG1' ~ 'SC_DIS_A_8ZSMVV_NG3',
                                    !Aliquot %in% c('SC_DIS_A_PDIR55_TU3',
                                                    'SC_DIS_A_1QFJ7P_TU3',
                                                    'SC_DIS_A_8ZSMVV_NG1') ~ Aliquot)) %>%
  dplyr::left_join(summMetadat4Discovery, by = 'Aliquot') %>%
  dplyr::select(-Aliquot)

# Keep only samples with good quality (decent tumor purity)
proTissue <- readRDS('./data/Discovery/AG_Krijgsveld/proTissueVsn.rds')
lipTissueNoWBC <- lipTissueNoWBC[lipTissueNoWBC$Patient %in% unique(colData(proTissue)$Patient),]
```

<font size='2'> **Vsn normalized data BEFORE filtered by missingness** for checking
associations between data and sample median expressions and missing levels </font>
```{r message=F}
# Normalize unfiltered data
lipTissueTab <- lipTissueNoWBC
lipTissueUnfiltVsn <- doPreprocessing(lipTissueTab, feat = 'Feature', smp = 'Sample',
                                      val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                                      smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipTissueUnfiltVsnTab <- summExp2df(lipTissueUnfiltVsn, assay = 'Abundance',
                                    row_id = 'Feature', col_id = 'Sample') %>%
  # Prepare information of sample median expressions and missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MedianVsnAbun = median(Value, na.rm = T),
                OriMissLevel = sum(is.na(Value)) / length(Value)) %>%
  dplyr::ungroup()
# Create SE object containing information of sample median expressions and missing levels
colAnno <- dplyr::select(lipTissueUnfiltVsnTab, Sample, MedianVsnAbun, OriMissLevel) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
lipTissueUnfiltVsn <- SummarizedExperiment(assays = list(Abundance = assay(lipTissueUnfiltVsn)),
                                           colData = colAnno)
# Show dimensions of data
cat('Data dimensions:', dim(lipTissueUnfiltVsn)[2], 'samples and', dim(lipTissueUnfiltVsn)[1], 'features')

# Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Unfiltered data') +
  th4MissViz + theme(axis.text.x = element_text(size = 9))

# Visualize data distribution
ggplot(lipTissueUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 9))

# Visualize relationship between sample median expressions and missing levels
ggplot(lipTissueUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(x = 'Missing level', y = 'Median expression') +
  th

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipTissueUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Do PCA
pcaRes <- doSOA(lipTissueUnfiltVsn, meta_var = c('MedianVsnAbun', 'OriMissLevel'),
                pca_method = 'pca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes
```

```{r}
# Visualize relationship between PCs and sample median expressions and missing levels
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC2 (12.5%)`, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Median expression') +
  th

ggplot(pcTab, aes(x=`PC2 (12.5%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Missing level') +
  th
```

<font size='2'> **Vsn normalized data AFTER filtered by missingness** </font>\
Features quantified in less than 2/3 of samples are removed.
```{r}
# Filter and normalize data
lipTissueTab <- lipTissueNoWBC
lipTissue <- doPreprocessing(lipTissueTab, feat = 'Feature', smp = 'Sample',
                             val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                             smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
lipTissueFilt <- lipTissue$filt.data
lipTissueFiltVsn <- lipTissue$vsn.data
# Prepare long data for plotting
lipTissueFiltVsnTab <- summExp2df(lipTissueFiltVsn, assay = 'Abundance',
                                  row_id = 'Feature', col_id = 'Sample')
# Show dimensions of data
cat('Data dimensions:', dim(lipTissueFiltVsn)[2], 'samples and', dim(lipTissueFiltVsn)[1], 'features')

# Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipTissueFilt)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Filtered data') +
  th4MissViz + theme(axis.text.x = element_text(size = 9))

# Visualize data distribution
ggplot(lipTissueFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Filtered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 9))

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipTissueFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th
```

**Do biological quality control**\
```{r}
# Do PCA
pcaRes <- doSOA(lipTissueFiltVsn, meta_var = c('Condition', 'Recurrence', 'Gender',
                                               'Age', 'Smoking', 'Stage', 'Adjuvant'),
                pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Label = case_when(Sample %in% c('1NL5BV_TU', '1NL5BV_NG',
                                                'I0HVOL_TU', 'I0HVOL_NG',
                                                '7EAOX7_TU', '7EAOX7_NG') ~ Sample))
ggplot(pcTab, aes(x=Condition, y=`PC1 (42%)`, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

ggplot(pcTab, aes(x=`PC1 (42%)`, y=`PC2 (13%)`, col=Condition, label=Label)) +
  geom_point(size = 2.5) +
  geom_text_repel(size = 4) +
  scale_color_brewer(palette = 'Dark2') +
  th
```
=> Tumor purity: I0HVOL_TU - 87% / 7EAOX7_TU - 70% / 1NL5BV_TU - 53%\
(Mean of sample tumor cell contents is 74%, ranging from 40% to 100%.)

```{r}
# Prepare information of sample missing levels
missInfo <- dplyr::group_by(lipTissueFiltVsnTab, Sample) %>%
  dplyr::summarise(MissLevel = sum(is.na(Value)) / length(Value)) %>%
  dplyr::filter(!duplicated(Sample))
# Show significant associations between PCs and sample missing levels
pcTab <- tibble::as_tibble(pcaRes$pcaRes@scores, rownames = 'Sample')
testAssociation(pcTab, missInfo, cmn_col = 'Sample') %>%
  dplyr::filter(pVal <= 0.05)

pcTab <- pcaRes$pcTab %>%
  dplyr::mutate(Label = case_when(Sample %in% c('1NL5BV_TU', '1NL5BV_NG',
                                                'I0HVOL_TU', 'I0HVOL_NG',
                                                '1VVXHY_TU', '1VVXHY_NG',
                                                'CMVZEW_TU', 'CMVZEW_NG',
                                                '1XUOU0_TU', '1XUOU0_NG',
                                                '1XGTDZ_TU', '1XGTDZ_NG',
                                                '11BMIX_TU', '11BMIX_NG',
                                                '1IHGAC_TU', '1IHGAC_NG',
                                                '1H3IW7_TU', '1H3IW7_NG',
                                                'Q7B5U6_TU', 'Q7B5U6_NG',
                                                'NVJH6R_TU', 'NVJH6R_NG',
                                                'Q89YQK_TU', 'Q89YQK_NG',
                                                'MJMTYR_TU', 'MJMTYR_NG') ~ Sample)) %>%
  dplyr::left_join(missInfo, by = 'Sample')

ggplot(pcTab, aes(x=`PC1 (42%)`, y=`PC2 (13%)`, col=MissLevel)) +
  geom_point(size = 2.5) +
  scale_color_continuous(name = 'Missing level (%)', type = 'viridis') +
  th

ggplot(pcTab, aes(x=`PC1 (42%)`, y=`PC2 (13%)`, col=Gender, label=Label)) +
  geom_point(size = 2.5) +
  geom_text_repel(size = 4, show.legend = F) +
  th
```

```{r}
lipTissueNoWBC <- lipTissueFiltVsn
NoWBC <- c(NoWBC, `Filt feat num` = nrow(lipTissueNoWBC))
```

## Summary

Visualize filtering\
**Original vs Filtered feature space (by m/z, QC RSD%, and blank relevant feature removal)**\
(Note that features with RT < 0.3 and > 9 were removed for original feature space,
which is consistent with Plasma Lipidomics)
```{r message=F}
# Visualize filtering in different datasets
# Prepare summarized filtering data
summFiltTab <- data.frame(WBC25, NoWBC) %>%
  dplyr::rename(`WBC-25%` = WBC25, `WBC-No` = NoWBC) %>%
  tibble::rownames_to_column('Filtering') %>%
  tidyr::pivot_longer(cols = -'Filtering', names_to = 'Dataset', values_to = 'Count') %>%
  dplyr::mutate(Dataset = factor(Dataset, levels = c('WBC-25%', 'WBC-No')))
featSpaceTab <- dplyr::filter(summFiltTab, Filtering %in% c('Ori feat num', 'Filt feat num')) %>%
  dplyr::rename(featSpace = Filtering) %>%
  dplyr::mutate(featSpace = case_when(featSpace %in% 'Ori feat num' ~ 'Original',
                                      featSpace %in% 'Filt feat num' ~ 'After filtering'),
                featSpace = factor(featSpace, levels = c('Original', 'After filtering')))
summFiltTab <- dplyr::filter(summFiltTab, !Filtering %in% c('Ori feat num', 'QC RSD% > 25 | NA', 'Filt feat num'))
# Plot feature spaces
ggplot(featSpaceTab, aes(x=Dataset, y=Count)) +
  geom_bar(aes(fill=featSpace), stat = 'identity', position = position_dodge(), alpha = 0.9) +
  scale_fill_grey(name = 'Feature space', start = 0.7, end = 0.3) +
  labs(x = 'Dataset (Within-batch correction)') +
  th
```

**Numbers of removed features**
```{r}
# Plot numbers of removed features
ggplot(summFiltTab, aes(x=Dataset, y=Count, col=Filtering, group=Filtering)) +
  geom_point(size = 4, show.legend = F) +
  geom_line(linewidth = 2, linetype = 'dashed') +
  scale_color_brewer(name = 'Filtering criteria', palette = 'Dark2') +
  labs(x = 'Dataset (Within-batch correction)') +
  th
```

Display intersection of filtered feature space\
(Note that filtering done here includes whatever aforementioned and missing levels,
which means fully preprocessed data)
```{r}
ggvenn(list(`WBC-25%` = rownames(lipTissueWBC25), `WBC-No` = rownames(lipTissueNoWBC)),
       fill_color = c('firebrick1', 'dodgerblue1'), fill_alpha = 0.6,
       set_name_color = c('firebrick1', 'dodgerblue1'), set_name_size = 10,
       text_size = 8, stroke_size = 1.5)
```

Display correlations of common features
```{r}
# Compute correlations of common features between two datasets
corrRes <- calcFeatCorr(lipTissueWBC25, lipTissueNoWBC, show_nFeats = F)
ggplot(corrRes, aes(x=Correlation)) +
  geom_histogram(binwidth = 0.1) +
  labs(y = 'Frequency', title = 'WBC-25% vs WBC-No') +
  th
```

Display association of **tissue type-related** feature significance between WBC-25%
and WBC-No Tissue Lipidomics\
**p-values (significance level = 0.05)**
```{r}
# Prepare summarized tables of comparison between two datasets
condiFeatAssoTabs <- summarizeFeatAssoRes(lipTissueWBC25, lipTissueNoWBC,
                                          'WBC-25%', 'WBC-No', meta_var = 'Condition',
                                          method = 'proDA', alpha = 0.05)
# Plot p-values
ggplot(condiFeatAssoTabs$tbl_pVal, aes(x=-log10(pVal_dat1), y=-log10(pVal_dat2), col=Significance)) +
  geom_point(size = 2) +
  geom_abline(intercept = 0, slope = 1, col = 'black', linewidth = 0.8) +
  scale_color_manual(values = c('red', 'darkgreen', 'navy', 'grey')) +
  labs(x = '-log10(pVal) of WBC-25%', y = '-log10(pVal) of WBC-No', title = 'Tumor vs Normal') +
  th
```

**log(FC)**
```{r}
# Plot log(FC)
ggplot(condiFeatAssoTabs$tbl_logFC, aes(x=logFC_dat1, y=logFC_dat2, col=Direction)) +
  geom_point(size = 2) +
  geom_abline(intercept = 0, slope = 1, col = 'black', linewidth = 0.8) +
  scale_color_manual(values = c('red', 'navy', 'grey')) +
  labs(x = 'log(FC) of WBC-25%', y = 'log(FC) of WBC-No', title = 'Tumor vs Normal') +
  th
```

Display proportions of **recurrence-related** significant features
```{r message=F}
# Display proportions of significant features and data power about recurrence prediction
# Subset data
lipTumorWBC25 <- lipTissueWBC25[, colData(lipTissueWBC25)$Condition %in% 'Tumor']
lipNormalWBC25 <- lipTissueWBC25[, colData(lipTissueWBC25)$Condition %in% 'Normal']
lipTumorNoWBC <- lipTissueNoWBC[, colData(lipTissueNoWBC)$Condition %in% 'Tumor']
lipNormalNoWBC <- lipTissueNoWBC[, colData(lipTissueNoWBC)$Condition %in% 'Normal']
# Do SOA
soaResTumorWBC25 <- doSOA(lipTumorWBC25, meta_var = 'Recurrence', pca_method = 'ppca',
                          num_PCs = 20, use_proDA = T)
soaResNormalWBC25 <- doSOA(lipNormalWBC25, meta_var = 'Recurrence', pca_method = 'ppca',
                           num_PCs = 20, use_proDA = T)
soaResTumorNoWBC <- doSOA(lipTumorNoWBC, meta_var = 'Recurrence', pca_method = 'ppca',
                          num_PCs = 20, use_proDA = T)
soaResNormalNoWBC <- doSOA(lipNormalNoWBC, meta_var = 'Recurrence', pca_method = 'ppca',
                           num_PCs = 20, use_proDA = T)

# Prepare summarized feature significance data
propSigFeatsTumorWBC25 <- nrow(soaResTumorWBC25$featSigAssoRes) / nrow(soaResTumorWBC25$data) * 100
propSigFeatsNormalWBC25 <- nrow(soaResNormalWBC25$featSigAssoRes) / nrow(soaResNormalWBC25$data) * 100
propSigFeatsTumorNoWBC <- nrow(soaResTumorNoWBC$featSigAssoRes) / nrow(soaResTumorNoWBC$data) * 100
propSigFeatsNormalNoWBC <- nrow(soaResNormalNoWBC$featSigAssoRes) / nrow(soaResNormalNoWBC$data) * 100
sigFeatPropTab <- data.frame(Dataset = factor(c('Tumor, WBC-25%', 'Normal, WBC-25%',
                                                'Tumor, WBC-No', 'Normal, WBC-No'),
                                              levels = c('Normal, WBC-No', 'Normal, WBC-25%',
                                                         'Tumor, WBC-No', 'Tumor, WBC-25%')),
                             Proportion = c(propSigFeatsTumorWBC25, propSigFeatsNormalWBC25,
                                            propSigFeatsTumorNoWBC, propSigFeatsNormalNoWBC),
                             AbsNum = c(nrow(soaResTumorWBC25$featSigAssoRes),
                                        nrow(soaResNormalWBC25$featSigAssoRes),
                                        nrow(soaResTumorNoWBC$featSigAssoRes),
                                        nrow(soaResNormalNoWBC$featSigAssoRes))) %>%
  dplyr::mutate(WBC = stringr::str_remove_all(Dataset, '^Tumor, |^Normal, '))

ggplot(sigFeatPropTab, aes(x=Dataset, y=Proportion, fill=WBC)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  scale_fill_grey(start = 0.3, end = 0.5) +
  labs(y = 'Percentage (%)', title = 'Recurrence vs Non-recurrence') +
  th
```

Display absolute counts of **recurrence-related** significant features
```{r}
ggplot(sigFeatPropTab, aes(x=Dataset, y=AbsNum, fill=WBC)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  scale_fill_grey(start = 0.3, end = 0.5) +
  labs(y = 'Count', title = 'Recurrence vs Non-recurrence') +
  th
```

Show **recurrence-related** significant PCs
```{r}
# Prepare summarized PC significance data
sigPCTabTumorWBC25 <- soaResTumorWBC25$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'Tumor, WBC-25%')
sigPCTabNormalWBC25 <- soaResNormalWBC25$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'Normal, WBC-25%')
sigPCTabTumorNoWBC <-soaResTumorNoWBC$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'Tumor, WBC-No')
sigPCTabNormalNoWBC <-soaResNormalNoWBC$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'Normal, WBC-No')
dplyr::bind_rows(sigPCTabTumorWBC25, sigPCTabNormalWBC25, sigPCTabTumorNoWBC, sigPCTabNormalNoWBC) %>%
  dplyr::relocate(Dataset)
```




# Plasma Lipidomics

## Batch1, WBC-25%

```{r message=F}
# Load data
lipPlasmaB1WBC25 <- readxl::read_excel('./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_20231130.xlsx',
                                       sheet = '14_Feature Table correction 25')
# Assign column names
colnames(lipPlasmaB1WBC25) <- lipPlasmaB1WBC25[1,]
lipPlasmaB1WBC25 <- lipPlasmaB1WBC25[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB1WBC25 <- dplyr::select(lipPlasmaB1WBC25, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %>%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, '/', CCS, '/', MZ)) %>%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab <- lipPlasmaB1WBC25
# Collect features captured in water processed blank
waterDat <- dplyr::select(tidyTab, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt <- c(`Ori feat num` = nrow(tidyTab), `m/z < 300` = sum(tidyTab$MZ < 300),
                `QC RSD% > 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD < 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% > 25` = sum(tidyTab$QC_RSD > 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat('There are duplicated features!')
}
B1WBC25 <- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB1WBC25 <- dplyr::filter(lipPlasmaB1WBC25, RT >= 0.3, RT <= 9, MZ >= 300, QC_RSD <= 25) %>%
  dplyr::select(-c(QC_RSD, contains('QC plasma'), contains('QCplasma')))

# Remove features captured in water processed blank, which is not of interest
waterDat <- dplyr::select(lipPlasmaB1WBC25, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats <- rownames(waterDat)[rmFeats]
lipPlasmaB1WBC25 <- dplyr::filter(lipPlasmaB1WBC25, !Feature %in% rmFeats) %>%
  dplyr::select(-contains('water'))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat <- readxl::read_excel('./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx')
colnames(smpPlateDat) <- c('Plate', 'Batch_Sample')
smpPlateDat <- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == 'Batch 3',
                             !grepl('^Box|QC plasma|QCplasma|water|ACN_H2O', Batch_Sample)) %>%
  dplyr::mutate(Plate = stringr::str_remove(Plate, ', Batch.+'),
                Plate = stringr::str_replace_all(Plate, 'Box |Box', 'Plate'),
                Plate = case_when(Plate %in% 'Plate3_4' ~ 'Plate4',
                                  !Plate %in% 'Plate3_4' ~ Plate),
                Plate2 = case_when(Plate %in% 'Plate4' ~ Plate,
                                   !Plate %in% 'Plate4' ~ 'Plate1|2|3'))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB1WBC25 <- tidyr::pivot_longer(lipPlasmaB1WBC25, cols = -c('Feature', 'RT', 'CCS', 'MZ'),
                                        names_to = 'Batch_Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, '_Left.+$'),
                Aliquot = stringr::str_remove_all(Batch_Sample, '^Batch\\d_'),
                Batch = stringr::str_extract(Batch_Sample, '^Batch\\d'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V2_2' ~ 'SC_DIS_A_F0X18FJY_P_V3_2',
                                    Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V6_2' ~ 'SC_DIS_A_F0X18FJY_P_V7_2',
                                    Aliquot %in% 'SC_DIS_A_1TK71I_P_V4_2' ~ 'SC_DIS_A_1TK71I_P_V3_2',
                                    !Aliquot %in% c('SC_DIS_A_F0X18FJY_P_V2_2',
                                                    'SC_DIS_A_F0X18FJY_P_V6_2',
                                                    'SC_DIS_A_1TK71I_P_V4_2') ~ Aliquot)) %>%
  dplyr::left_join(smpPlateDat, by = 'Batch_Sample') %>%
  dplyr::left_join(summMetadat4Discovery, by = 'Aliquot') %>%
  dplyr::select(-c(Batch_Sample, Aliquot, TumorPurity))
```

<font size='2'> **Vsn normalized data BEFORE filtered by missingness** for checking
associations between data and sample median expressions and missing levels </font>
```{r message=F}
# Normalize unfiltered data
lipPlasmaTab <- lipPlasmaB1WBC25
lipPlasmaUnfiltVsn <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Sample',
                                      val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                                      smpAnno = c(smpAnno, 'Batch', 'Plate', 'Plate2'), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipPlasmaUnfiltVsnTab <- summExp2df(lipPlasmaUnfiltVsn, assay = 'Abundance',
                                    row_id = 'Feature', col_id = 'Sample') %>%
  # Prepare information of sample median expressions and missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MedianVsnAbun = median(Value, na.rm = T),
                OriMissLevel = sum(is.na(Value)) / length(Value)) %>%
  dplyr::ungroup()
# Create SE object containing information of sample median expressions and missing levels
colAnno <- dplyr::select(lipPlasmaUnfiltVsnTab, Sample, MedianVsnAbun, OriMissLevel) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
lipPlasmaUnfiltVsn <- SummarizedExperiment(assays = list(Abundance = assay(lipPlasmaUnfiltVsn)),
                                           colData = colAnno)
# Show dimensions of data
cat('Data dimensions:', dim(lipPlasmaUnfiltVsn)[2], 'samples and', dim(lipPlasmaUnfiltVsn)[1], 'features')

# Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipPlasmaUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = 'Samples', y = 'Features', title = 'Missingness of Unfiltered data') +
  th4MissViz + theme(axis.text.x = element_blank())

# Visualize data distribution
ggplot(lipPlasmaUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_blank(),
             axis.ticks.x = element_blank())

# Visualize relationship between sample median expressions and missing levels
ggplot(lipPlasmaUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(x = 'Missing level', y = 'Median expression') +
  th

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipPlasmaUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Do PCA
pcaRes <- doSOA(lipPlasmaUnfiltVsn, meta_var = c('MedianVsnAbun', 'OriMissLevel'),
                pca_method = 'pca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes %>%
  dplyr::filter(grepl('^PC[1-9] \\(', Var1))
```

```{r}
# Visualize relationship between PCs and sample median expressions and missing levels
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC1 (15.8%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Missing level') +
  th

ggplot(pcTab, aes(x=`PC1 (15.8%)`, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Median expression') +
  th

ggplot(pcTab, aes(x=`PC1 (15.8%)`, y=`PC2 (11.3%)`, col=OriMissLevel)) +
  geom_point(size = 3.5) +
  scale_color_continuous(name = 'Missing level (%)', type = 'viridis') +
  th
```

**Take all plasma samples for normalization, and then subset Baseline samples**\
<font size='2'> **Vsn normalized data AFTER filtered by missingness** </font>\
Features quantified in less than 2/3 of samples are removed.
```{r}
# Filter and normalize data
lipPlasmaTab <- lipPlasmaB1WBC25
lipPlasma <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Sample',
                             val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                             smpAnno = c(smpAnno, 'Batch', 'Plate', 'Plate2'), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
# Subset Baseline samples
lipPlasmaFilt <- lipPlasma$filt.data
lipPlasmaFiltVsn <- lipPlasma$vsn.data
lipBaseFilt <- lipPlasmaFilt[, colData(lipPlasmaFilt)$TimePoint %in% 'Baseline']
lipBaseFiltVsn <- lipPlasmaFiltVsn[, colData(lipPlasmaFiltVsn)$TimePoint %in% 'Baseline']
# Prepare long data for plotting
lipBaseFiltVsnTab <- summExp2df(lipBaseFiltVsn, assay = 'Abundance',
                                row_id = 'Feature', col_id = 'Sample')
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseFiltVsn)[2], 'samples and', dim(lipBaseFiltVsn)[1], 'features')

# Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseFilt)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Filtered data') +
  th4MissViz

# Visualize data distribution
ggplot(lipBaseFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Filtered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Save preprocessed data
saveRDS(lipBaseFiltVsn, './data/Discovery/AG_Hopf/lipPlasmaVsn_B1WBC25.rds')
```

Show significant associations between PCs and plates where samples are located.
Samples in Plate4 were frozen at -80°C.
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseFiltVsn, meta_var = 'Plate2', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate2, y=`PC1 (20.4%)`, col=Plate2, fill=Plate2)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th
```

```{r}
lipBaseB1WBC25 <- lipBaseFiltVsn
B1WBC25 <- c(B1WBC25, `Filt feat num` = nrow(lipBaseB1WBC25))
```

## Batch1, WBC-15%

```{r message=F}
# Load data
lipPlasmaB1WBC15 <- readxl::read_excel('./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_20231130.xlsx',
                                       sheet = '10_Feature Table correction 15')
# Assign column names
colnames(lipPlasmaB1WBC15) <- lipPlasmaB1WBC15[1,]
lipPlasmaB1WBC15 <- lipPlasmaB1WBC15[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB1WBC15 <- dplyr::select(lipPlasmaB1WBC15, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %>%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, '/', CCS, '/', MZ)) %>%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab <- lipPlasmaB1WBC15
# Collect features captured in water processed blank
waterDat <- dplyr::select(tidyTab, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt <- c(`Ori feat num` = nrow(tidyTab), `m/z < 300` = sum(tidyTab$MZ < 300),
                `QC RSD% > 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD < 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% > 25` = sum(tidyTab$QC_RSD > 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat('There are duplicated features!')
}
B1WBC15 <- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB1WBC15 <- dplyr::filter(lipPlasmaB1WBC15, RT >= 0.3, RT <= 9, MZ >= 300, QC_RSD <= 25) %>%
  dplyr::select(-c(QC_RSD, contains('QC plasma'), contains('QCplasma')))

# Remove features captured in water processed blank, which is not of interest
waterDat <- dplyr::select(lipPlasmaB1WBC15, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats <- rownames(waterDat)[rmFeats]
lipPlasmaB1WBC15 <- dplyr::filter(lipPlasmaB1WBC15, !Feature %in% rmFeats) %>%
  dplyr::select(-contains('water'))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat <- readxl::read_excel('./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx')
colnames(smpPlateDat) <- c('Plate', 'Batch_Sample')
smpPlateDat <- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == 'Batch 3',
                             !grepl('^Box|QC plasma|QCplasma|water|ACN_H2O', Batch_Sample)) %>%
  dplyr::mutate(Plate = stringr::str_remove(Plate, ', Batch.+'),
                Plate = stringr::str_replace_all(Plate, 'Box |Box', 'Plate'),
                Plate = case_when(Plate %in% 'Plate3_4' ~ 'Plate4',
                                  !Plate %in% 'Plate3_4' ~ 'Plate1|2|3'))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB1WBC15 <- tidyr::pivot_longer(lipPlasmaB1WBC15, cols = -c('Feature', 'RT', 'CCS', 'MZ'),
                                        names_to = 'Batch_Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, '_Left.+$'),
                Aliquot = stringr::str_remove_all(Batch_Sample, '^Batch\\d_'),
                Batch = stringr::str_extract(Batch_Sample, '^Batch\\d'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V2_2' ~ 'SC_DIS_A_F0X18FJY_P_V3_2',
                                    Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V6_2' ~ 'SC_DIS_A_F0X18FJY_P_V7_2',
                                    Aliquot %in% 'SC_DIS_A_1TK71I_P_V4_2' ~ 'SC_DIS_A_1TK71I_P_V3_2',
                                    !Aliquot %in% c('SC_DIS_A_F0X18FJY_P_V2_2',
                                                    'SC_DIS_A_F0X18FJY_P_V6_2',
                                                    'SC_DIS_A_1TK71I_P_V4_2') ~ Aliquot)) %>%
  dplyr::left_join(smpPlateDat, by = 'Batch_Sample') %>%
  dplyr::left_join(summMetadat4Discovery, by = 'Aliquot') %>%
  dplyr::select(-c(Batch_Sample, Aliquot, TumorPurity))
```

<font size='2'> **Vsn normalized data BEFORE filtered by missingness** for checking
associations between data and sample median expressions and missing levels </font>
```{r message=F}
# Normalize unfiltered data
lipPlasmaTab <- lipPlasmaB1WBC15
lipPlasmaUnfiltVsn <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Sample',
                                      val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                                      smpAnno = c(smpAnno, 'Batch', 'Plate'), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipPlasmaUnfiltVsnTab <- summExp2df(lipPlasmaUnfiltVsn, assay = 'Abundance',
                                    row_id = 'Feature', col_id = 'Sample') %>%
  # Prepare information of sample median expressions and missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MedianVsnAbun = median(Value, na.rm = T),
                OriMissLevel = sum(is.na(Value)) / length(Value)) %>%
  dplyr::ungroup()
# Create SE object containing information of sample median expressions and missing levels
colAnno <- dplyr::select(lipPlasmaUnfiltVsnTab, Sample, MedianVsnAbun, OriMissLevel) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
lipPlasmaUnfiltVsn <- SummarizedExperiment(assays = list(Abundance = assay(lipPlasmaUnfiltVsn)),
                                           colData = colAnno)
# Show dimensions of data
cat('Data dimensions:', dim(lipPlasmaUnfiltVsn)[2], 'samples and', dim(lipPlasmaUnfiltVsn)[1], 'features')

# Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipPlasmaUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Unfiltered data') +
  th4MissViz + theme(axis.text.x = element_blank())

# Visualize data distribution
ggplot(lipPlasmaUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_blank(),
             axis.ticks.x = element_blank())

# Visualize relationship between sample median expressions and missing levels
ggplot(lipPlasmaUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(x = 'Missing level', y = 'Median expression') +
  th

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipPlasmaUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Do PCA
pcaRes <- doSOA(lipPlasmaUnfiltVsn, meta_var = c('MedianVsnAbun', 'OriMissLevel'),
                pca_method = 'pca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes %>%
  dplyr::filter(grepl('PC[1-9] \\(', Var1))
```

```{r}
# Visualize relationship between PCs and sample median expressions and missing levels
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC1 (17.1%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Missing level') +
  th

ggplot(pcTab, aes(x=`PC1 (17.1%)`, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Median expression') +
  th

ggplot(pcTab, aes(x=`PC1 (17.1%)`, y=`PC2 (11.2%)`, col=OriMissLevel)) +
  geom_point(size = 3.5) +
  scale_color_continuous(name = 'Missing level (%)', type = 'viridis') +
  th
```

**Take all plasma samples for normalization, and then subset Baseline samples**\
<font size='2'> **Vsn normalized data AFTER filtered by missingness** </font>\
Features quantified in less than 2/3 of samples are removed.
```{r}
# Filter and normalize data
lipPlasmaTab <- lipPlasmaB1WBC15
lipPlasma <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Sample',
                             val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                             smpAnno = c(smpAnno, 'Batch', 'Plate'), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
# Subset Baseline samples
lipPlasmaFilt <- lipPlasma$filt.data
lipPlasmaFiltVsn <- lipPlasma$vsn.data
lipBaseFilt <- lipPlasmaFilt[, colData(lipPlasmaFilt)$TimePoint %in% 'Baseline']
lipBaseFiltVsn <- lipPlasmaFiltVsn[, colData(lipPlasmaFiltVsn)$TimePoint %in% 'Baseline']
# Prepare long data for plotting
lipBaseFiltVsnTab <- summExp2df(lipBaseFiltVsn, assay = 'Abundance',
                                row_id = 'Feature', col_id = 'Sample')
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseFiltVsn)[2], 'samples and', dim(lipBaseFiltVsn)[1], 'features')

# Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseFilt)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Filtered data') +
  th4MissViz

# Visualize data distribution
ggplot(lipBaseFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Filtered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th
```

Show significant associations between PCs and plates where samples are located.
Samples in Plate4 were frozen at -80°C.
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseFiltVsn, meta_var = 'Plate', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC10 (3%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th

ggplot(pcTab, aes(x=Plate, y=`PC1 (23.9%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th
```

```{r}
lipBaseB1WBC15 <- lipBaseFiltVsn
B1WBC15 <- c(B1WBC15, `Filt feat num` = nrow(lipBaseB1WBC15))
```

## Batch1, WBC-No

```{r message=F}
# Load data
lipPlasmaB1NoWBC <- readxl::read_excel('./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_20231130.xlsx',
                                       sheet = '12_Feature Table no correction')
# Assign column names
colnames(lipPlasmaB1NoWBC) <- lipPlasmaB1NoWBC[1,]
lipPlasmaB1NoWBC <- lipPlasmaB1NoWBC[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB1NoWBC <- dplyr::select(lipPlasmaB1NoWBC, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %>%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, '/', CCS, '/', MZ)) %>%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab <- lipPlasmaB1NoWBC
# Collect features captured in water processed blank
waterDat <- dplyr::select(tidyTab, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt <- c(`Ori feat num` = nrow(tidyTab), `m/z < 300` = sum(tidyTab$MZ < 300),
                `QC RSD% > 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD < 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% > 25` = sum(tidyTab$QC_RSD > 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat('There are duplicated features!')
}
B1NoWBC <- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB1NoWBC <- dplyr::filter(lipPlasmaB1NoWBC, RT >= 0.3, RT <= 9, MZ >= 300, QC_RSD <= 25) %>%
  dplyr::select(-c(QC_RSD, contains('QC plasma'), contains('QCplasma')))

# Remove features captured in water processed blank, which is not of interest
waterDat <- dplyr::select(lipPlasmaB1NoWBC, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats <- rownames(waterDat)[rmFeats]
lipPlasmaB1NoWBC <- dplyr::filter(lipPlasmaB1NoWBC, !Feature %in% rmFeats) %>%
  dplyr::select(-contains('water'))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat <- readxl::read_excel('./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx')
colnames(smpPlateDat) <- c('Plate', 'Batch_Sample')
smpPlateDat <- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == 'Batch 3',
                             !grepl('^Box|QC plasma|QCplasma|water|ACN_H2O', Batch_Sample)) %>%
  dplyr::mutate(Plate = stringr::str_remove(Plate, ', Batch.+'),
                Plate = stringr::str_replace_all(Plate, 'Box |Box', 'Plate'),
                Plate = case_when(Plate %in% 'Plate3_4' ~ 'Plate4',
                                  !Plate %in% 'Plate3_4' ~ 'Plate1|2|3'))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB1NoWBC <- tidyr::pivot_longer(lipPlasmaB1NoWBC, cols = -c('Feature', 'RT', 'CCS', 'MZ'),
                                        names_to = 'Batch_Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, '_Left.+$'),
                Aliquot = stringr::str_remove_all(Batch_Sample, '^Batch\\d_'),
                Batch = stringr::str_extract(Batch_Sample, '^Batch\\d'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V2_2' ~ 'SC_DIS_A_F0X18FJY_P_V3_2',
                                    Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V6_2' ~ 'SC_DIS_A_F0X18FJY_P_V7_2',
                                    Aliquot %in% 'SC_DIS_A_1TK71I_P_V4_2' ~ 'SC_DIS_A_1TK71I_P_V3_2',
                                    !Aliquot %in% c('SC_DIS_A_F0X18FJY_P_V2_2',
                                                    'SC_DIS_A_F0X18FJY_P_V6_2',
                                                    'SC_DIS_A_1TK71I_P_V4_2') ~ Aliquot)) %>%
  dplyr::left_join(smpPlateDat, by = 'Batch_Sample') %>%
  dplyr::left_join(summMetadat4Discovery, by = 'Aliquot') %>%
  dplyr::select(-c(Batch_Sample, Aliquot, TumorPurity))
```

<font size='2'> **Vsn normalized data BEFORE filtered by missingness** for checking
associations between data and sample median expressions and missing levels </font>
```{r message=F}
# Normalize unfiltered data
lipPlasmaTab <- lipPlasmaB1NoWBC
lipPlasmaUnfiltVsn <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Sample',
                                      val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                                      smpAnno = c(smpAnno, 'Batch', 'Plate'), do_featFilt = F)$vsn.data
# Prepare long data for plotting
lipPlasmaUnfiltVsnTab <- summExp2df(lipPlasmaUnfiltVsn, assay = 'Abundance',
                                    row_id = 'Feature', col_id = 'Sample') %>%
  # Prepare information of sample median expressions and missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MedianVsnAbun = median(Value, na.rm = T),
                OriMissLevel = sum(is.na(Value)) / length(Value)) %>%
  dplyr::ungroup()
# Create SE object containing information of sample median expressions and missing levels
colAnno <- dplyr::select(lipPlasmaUnfiltVsnTab, Sample, MedianVsnAbun, OriMissLevel) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
lipPlasmaUnfiltVsn <- SummarizedExperiment(assays = list(Abundance = assay(lipPlasmaUnfiltVsn)),
                                           colData = colAnno)
# Show dimensions of data
cat('Data dimensions:', dim(lipPlasmaUnfiltVsn)[2], 'samples and', dim(lipPlasmaUnfiltVsn)[1], 'features')

# Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipPlasmaUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Unfiltered data') +
  th4MissViz + theme(axis.text.x = element_blank())

# Visualize data distribution
ggplot(lipPlasmaUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_blank(),
             axis.ticks.x = element_blank())

# Visualize relationship between sample median expressions and missing levels
ggplot(lipPlasmaUnfiltVsnTab, aes(x=OriMissLevel, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(x = 'Missing level', y = 'Median expression') +
  th

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipPlasmaUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Do PCA
pcaRes <- doSOA(lipPlasmaUnfiltVsn, meta_var = c('MedianVsnAbun', 'OriMissLevel'),
                pca_method = 'pca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes %>%
  dplyr::filter(grepl('PC[1-9] \\(', Var1))
```

```{r}
# Visualize relationship between PCs and sample median expressions and missing levels
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=`PC1 (20%)`, y=OriMissLevel)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Missing level') +
  th

ggplot(pcTab, aes(x=`PC1 (20%)`, y=MedianVsnAbun)) +
  geom_point(size = 3.5) +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 6) +
  labs(y = 'Median expression') +
  th

ggplot(pcTab, aes(x=`PC1 (20%)`, y=`PC2 (11.9%)`, col=OriMissLevel)) +
  geom_point(size = 3.5) +
  scale_color_continuous(name = 'Missing level (%)', type = 'viridis') +
  th
```

**Take all plasma samples for normalization, and then subset Baseline samples**\
<font size='2'> **Vsn normalized data AFTER filtered by missingness** </font>\
Features quantified in less than 2/3 of samples are removed.
```{r}
# Filter and normalize data
lipPlasmaTab <- lipPlasmaB1NoWBC
lipPlasma <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Sample',
                             val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                             smpAnno = c(smpAnno, 'Batch', 'Plate'), do_featFilt = T,
                             cutoff = 0.67, viz_miss = T)
# Subset Baseline samples
lipPlasmaFilt <- lipPlasma$filt.data
lipPlasmaFiltVsn <- lipPlasma$vsn.data
lipBaseFilt <- lipPlasmaFilt[, colData(lipPlasmaFilt)$TimePoint %in% 'Baseline']
lipBaseFiltVsn <- lipPlasmaFiltVsn[, colData(lipPlasmaFiltVsn)$TimePoint %in% 'Baseline']
# Prepare long data for plotting
lipBaseFiltVsnTab <- summExp2df(lipBaseFiltVsn, assay = 'Abundance',
                                row_id = 'Feature', col_id = 'Sample')
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseFiltVsn)[2], 'samples and', dim(lipBaseFiltVsn)[1], 'features')

# Check preprocessing quality
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseFilt)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Filtered data') +
  th4MissViz

# Visualize data distribution
ggplot(lipBaseFiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Filtered vsn normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseFiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th
```

Show significant associations between PCs and plates where samples are located.
Samples in Plate4 were frozen at -80°C.
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseFiltVsn, meta_var = 'Plate', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC1 (24.2%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th
```

```{r}
lipBaseB1NoWBC <- lipBaseFiltVsn
B1NoWBC <- c(B1NoWBC, `Filt feat num` = nrow(lipBaseB1NoWBC))
```

## Batch1&2, WBC-25%

```{r message=F}
# Load data
lipPlasmaB12WBC25 <- readxl::read_excel('./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_2_20231130.xlsx',
                                        sheet = '3_Feature Table correction 25')
# Assign column names
colnames(lipPlasmaB12WBC25) <- lipPlasmaB12WBC25[1,]
lipPlasmaB12WBC25 <- lipPlasmaB12WBC25[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB12WBC25 <- dplyr::select(lipPlasmaB12WBC25, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %>%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, '/', CCS, '/', MZ)) %>%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab <- lipPlasmaB12WBC25
# Collect features captured in water processed blank
waterDat <- dplyr::select(tidyTab, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt <- c(`Ori feat num` = nrow(tidyTab), `m/z < 300` = sum(tidyTab$MZ < 300),
                `QC RSD% > 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD < 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% > 25` = sum(tidyTab$QC_RSD > 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat('There are duplicated features!')
}
B12WBC25 <- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB12WBC25 <- dplyr::filter(lipPlasmaB12WBC25, RT >= 0.3, RT <= 9, MZ >= 300, QC_RSD <= 25) %>%
  dplyr::select(-c(QC_RSD, contains('QC plasma'), contains('QCplasma'), contains('Splash')))

# Remove features captured in water processed blank, which is not of interest
waterDat <- dplyr::select(lipPlasmaB12WBC25, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats <- rownames(waterDat)[rmFeats]
lipPlasmaB12WBC25 <- dplyr::filter(lipPlasmaB12WBC25, !Feature %in% rmFeats) %>%
  dplyr::select(-contains('water'))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat <- readxl::read_excel('./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx')
colnames(smpPlateDat) <- c('Plate', 'Batch_Sample')
smpPlateDat <- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == 'Batch 3',
                             !grepl('^Box|QC plasma|QCplasma|water|ACN_H2O', Batch_Sample)) %>%
  dplyr::mutate(Plate = stringr::str_remove(Plate, ', Batch.+'),
                Plate = stringr::str_replace_all(Plate, 'Box |Box', 'Plate'),
                Plate = case_when(Plate %in% 'Plate3_4' ~ 'Plate4',
                                  !Plate %in% 'Plate3_4' ~ 'Plate1|2|3'))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB12WBC25 <- tidyr::pivot_longer(lipPlasmaB12WBC25, cols = -c('Feature', 'RT', 'CCS', 'MZ'),
                                         names_to = 'Batch_Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, '_Left.+$'),
                Aliquot = stringr::str_remove_all(Batch_Sample, '^Batch\\d_'),
                Batch = stringr::str_extract(Batch_Sample, '^Batch\\d'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V2_2' ~ 'SC_DIS_A_F0X18FJY_P_V3_2',
                                    Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V6_2' ~ 'SC_DIS_A_F0X18FJY_P_V7_2',
                                    Aliquot %in% 'SC_DIS_A_1TK71I_P_V4_2' ~ 'SC_DIS_A_1TK71I_P_V3_2',
                                    !Aliquot %in% c('SC_DIS_A_F0X18FJY_P_V2_2',
                                                    'SC_DIS_A_F0X18FJY_P_V6_2',
                                                    'SC_DIS_A_1TK71I_P_V4_2') ~ Aliquot)) %>%
  dplyr::left_join(smpPlateDat, by = 'Batch_Sample') %>%
  dplyr::left_join(summMetadat4Discovery, by = 'Aliquot') %>%
  dplyr::select(-c(Aliquot, TumorPurity))
```

**Take all plasma samples from all batches for normalization, and then subset Baseline samples**\
**Normalize data without filtering by missingness** (because merging replicates
could improve data missingness)
```{r message=F}
# Normalize unfiltered data
lipPlasmaTab <- lipPlasmaB12WBC25
lipPlasmaUnfiltVsn <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Batch_Sample',
                                      val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                                      smpAnno = c(smpAnno, 'Sample', 'Batch', 'Plate'),
                                      do_featFilt = F)$vsn.data
# Subset Baseline samples
lipBaseUnfiltVsn <- lipPlasmaUnfiltVsn[, colData(lipPlasmaUnfiltVsn)$TimePoint %in% 'Baseline']
# Prepare long data for plotting
lipBaseUnfiltVsnTab <- summExp2df(lipBaseUnfiltVsn, assay = 'Abundance',
                                  row_id = 'Feature', col_id = 'Batch_Sample')
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseUnfiltVsn)[2], 'samples and', dim(lipBaseUnfiltVsn)[1], 'features')

# Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = 'Samples', y = 'Features', title = 'Missingness of Unfiltered data (Batch1 + Batch2)') +
  th4MissViz + theme(axis.text.x = element_blank(),
                     axis.title.x = element_text(size = 13, face = 'bold'))

# Visualize data distribution
ggplot(lipBaseUnfiltVsnTab, aes(x=Batch_Sample, y=Value, col=Batch)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Visualize standard deviations of each feature between replicates
featDiffs <- dplyr::group_by(lipBaseUnfiltVsnTab, Feature, Sample) %>%
  dplyr::summarise(Distance = abs(diff(Value))) %>%
  dplyr::ungroup() %>%
  dplyr::pull(Distance)
hist(featDiffs, breaks = 20, xlab = 'Difference', main = 'Histogram of distances of features between replicates')
```

```{r fig.height=12, fig.width=10}
# Visualize relationships between replicates
B1 <- dplyr::filter(lipBaseUnfiltVsnTab, Batch == 'Batch1') %>%
  dplyr::select(Feature, Sample, Value) %>%
  dplyr::rename(Batch1 = Value)
B2 <- dplyr::filter(lipBaseUnfiltVsnTab, Batch == 'Batch2') %>%
  dplyr::select(Feature, Sample, Value) %>%
  dplyr::rename(Batch2 = Value)
scatTabB12 <- dplyr::left_join(B1, B2, by = c('Feature', 'Sample'))
ggplot(scatTabB12, aes(x=Batch1, y=Batch2)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = 'Relationships of replicates in Unfiltered vsn normalized data') +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = 'red', linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = 'bold'),
                                   axis.title = element_text(size = 14, face = 'bold'))
```

Check if there exists batch effect\
**Hierarchical clustering**
```{r}
# Compute sample euclidean distances
d <- dist(t(assay(lipBaseUnfiltVsn)), method = 'euclidean')

# Visualize sample distances by heatmap with clustering
batchAnno <- dplyr::select(lipBaseUnfiltVsnTab, Batch_Sample, Batch) %>%
  dplyr::filter(!duplicated(Batch_Sample)) %>%
  tibble::column_to_rownames('Batch_Sample')
pheatmap(as.matrix(d), annotation_col = batchAnno, scale = 'row', #row scaling is across columns
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = 'ward.D2', fontsize_col = 6,
         annotation_colors = list(Batch = c(Batch1 = 'grey30', Batch2 = 'grey60')))

# Do hierarchical clustering
# hc <- hclust(d, method = 'ward.D2')
# # Plot clustering result
# plot(hc, hang = 0.04, cex = 0.5, frame.plot = T, main = NULL)
```
=> Sample '1H3IW7_V1' measured in different batches is not clustered.

**PCA**
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseUnfiltVsn, meta_var = 'Batch', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes
```

```{r include=F, eval=F}
# **Do batch correction using limma**\
# No PC is significantly associated with batches after batch correction.

# Perform batch correction to see if two batches can be combined even better
# Convert SE object into wide data
datMat <- assay(lipBaseUnfiltVsn)
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab <- tibble::as_tibble(colData(lipBaseUnfiltVsn), rownames = 'Batch_Sample')
design <- model.matrix(~ smpAnnoTab$Recurrence)
# Do batch correction
datMat_BC <- limma::removeBatchEffect(datMat, batch = smpAnnoTab$Batch, design = design)
lipBaseUnfiltVsn_BC <- lipBaseUnfiltVsn
assay(lipBaseUnfiltVsn_BC) <- datMat_BC

# Do single-omics analysis
pcaRes_BC <- doSOA(lipBaseUnfiltVsn_BC, meta_var = 'Batch', pca_method = 'ppca',
                   num_PCs = 20, do_onlyPCA = T)
# pcaRes_BC$pcSigAssoRes
```

**Merge replicates by taking their means**
```{r message=F}
# Merge replicates from different batches
# Prepare sample metadata
smpAnnoTab <- tibble::as_tibble(colData(lipBaseUnfiltVsn)) %>%
  dplyr::select(-Batch) %>%
  dplyr::distinct(Sample, .keep_all = T)
featAnnoTab <- tibble::as_tibble(rowData(lipBaseUnfiltVsn), rownames = 'Feature')
# Take means of replicates from different batches
merge_lipBaseUnfiltVsnTab <- summExp2df(lipBaseUnfiltVsn, assay = 'Abundance',
                                        row_id = 'Feature', col_id = 'Batch_Sample') %>%
  dplyr::group_by(Feature, Sample) %>%
  dplyr::summarise(Value = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::left_join(featAnnoTab, by = 'Feature')

# Visualize data distribution
ggplot(merge_lipBaseUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered Merged normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

**Remove features quantified in less than 2/3 of samples**
```{r}
# Remove features quantified in less than certain percent of samples
rmFeats <- dplyr::group_by(merge_lipBaseUnfiltVsnTab, Feature) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Value)) / length(Value), 2)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::pull(Feature)
merge_lipBaseFiltVsnTab <- dplyr::filter(merge_lipBaseUnfiltVsnTab, !Feature %in% rmFeats)

# Convert long data to SE object
lipBaseFiltVsn <- df2SummExp(merge_lipBaseFiltVsnTab, row_id = 'Feature', col_id = 'Sample',
                             values = 'Value', row_anno = c('RT', 'CCS', 'MZ'),
                             col_anno = c(smpAnno, 'Plate'))
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseFiltVsn)[2], 'samples and', dim(lipBaseFiltVsn)[1], 'features')

# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseFiltVsn)), cluster = T, sort_miss = T) +
  labs(y = 'Features', title = 'Missingness of Filtered Merged data') +
  th4MissViz
```

Show significant associations between PCs and plates where samples are located.
Samples in Plate4 were frozen at -80°C.
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseFiltVsn, meta_var = 'Plate', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC1 (18.8%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th
```

```{r}
lipBaseB12WBC25 <- lipBaseFiltVsn
B12WBC25 <- c(B12WBC25, `Filt feat num` = nrow(lipBaseB12WBC25))
```

## Batch1&2, WBC-15%

```{r message=F}
# Load data
lipPlasmaB12WBC15 <- readxl::read_excel('./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_2_20231130.xlsx',
                                        sheet = '1_Feature Table correction 15')
# Assign column names
colnames(lipPlasmaB12WBC15) <- lipPlasmaB12WBC15[1,]
lipPlasmaB12WBC15 <- lipPlasmaB12WBC15[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB12WBC15 <- dplyr::select(lipPlasmaB12WBC15, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %>%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, '/', CCS, '/', MZ)) %>%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab <- lipPlasmaB12WBC15
# Collect features captured in water processed blank
waterDat <- dplyr::select(tidyTab, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt <- c(`Ori feat num` = nrow(tidyTab), `m/z < 300` = sum(tidyTab$MZ < 300),
                `QC RSD% > 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD < 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% > 25` = sum(tidyTab$QC_RSD > 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat('There are duplicated features!')
}
B12WBC15 <- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB12WBC15 <- dplyr::filter(lipPlasmaB12WBC15, RT >= 0.3, RT <= 9, MZ >= 300, QC_RSD <= 25) %>%
  dplyr::select(-c(QC_RSD, contains('QC plasma'), contains('QCplasma'), contains('Splash')))

# Remove features captured in water processed blank, which is not of interest
waterDat <- dplyr::select(lipPlasmaB12WBC15, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats <- rownames(waterDat)[rmFeats]
lipPlasmaB12WBC15 <- dplyr::filter(lipPlasmaB12WBC15, !Feature %in% rmFeats) %>%
  dplyr::select(-contains('water'))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat <- readxl::read_excel('./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx')
colnames(smpPlateDat) <- c('Plate', 'Batch_Sample')
smpPlateDat <- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == 'Batch 3',
                             !grepl('^Box|QC plasma|QCplasma|water|ACN_H2O', Batch_Sample)) %>%
  dplyr::mutate(Plate = stringr::str_remove(Plate, ', Batch.+'),
                Plate = stringr::str_replace_all(Plate, 'Box |Box', 'Plate'),
                Plate = case_when(Plate %in% 'Plate3_4' ~ 'Plate4',
                                  !Plate %in% 'Plate3_4' ~ 'Plate1|2|3'))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB12WBC15 <- tidyr::pivot_longer(lipPlasmaB12WBC15, cols = -c('Feature', 'RT', 'CCS', 'MZ'),
                                         names_to = 'Batch_Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, '_Left.+$'),
                Aliquot = stringr::str_remove_all(Batch_Sample, '^Batch\\d_'),
                Batch = stringr::str_extract(Batch_Sample, '^Batch\\d'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V2_2' ~ 'SC_DIS_A_F0X18FJY_P_V3_2',
                                    Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V6_2' ~ 'SC_DIS_A_F0X18FJY_P_V7_2',
                                    Aliquot %in% 'SC_DIS_A_1TK71I_P_V4_2' ~ 'SC_DIS_A_1TK71I_P_V3_2',
                                    !Aliquot %in% c('SC_DIS_A_F0X18FJY_P_V2_2',
                                                    'SC_DIS_A_F0X18FJY_P_V6_2',
                                                    'SC_DIS_A_1TK71I_P_V4_2') ~ Aliquot)) %>%
  dplyr::left_join(smpPlateDat, by = 'Batch_Sample') %>%
  dplyr::left_join(summMetadat4Discovery, by = 'Aliquot') %>%
  dplyr::select(-c(Aliquot, TumorPurity))
```

**Take all plasma samples from all batches for normalization, and then subset Baseline samples**\
**Normalize data without filtering by missingness** (because merging replicates
could improve data missingness)
```{r message=F}
# Normalize unfiltered data
lipPlasmaTab <- lipPlasmaB12WBC15
lipPlasmaUnfiltVsn <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Batch_Sample',
                                      val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                                      smpAnno = c(smpAnno, 'Sample', 'Batch', 'Plate'),
                                      do_featFilt = F)$vsn.data
# Subset Baseline samples
lipBaseUnfiltVsn <- lipPlasmaUnfiltVsn[, colData(lipPlasmaUnfiltVsn)$TimePoint %in% 'Baseline']
# Prepare long data for plotting
lipBaseUnfiltVsnTab <- summExp2df(lipBaseUnfiltVsn, assay = 'Abundance',
                                  row_id = 'Feature', col_id = 'Batch_Sample')
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseUnfiltVsn)[2], 'samples and', dim(lipBaseUnfiltVsn)[1], 'features')

# Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = 'Samples', y = 'Features', title = 'Missingness of Unfiltered data (Batch1 + Batch2)') +
  th4MissViz + theme(axis.text.x = element_blank(),
                     axis.title.x = element_text(size = 13, face = 'bold'))

# Visualize data distribution
ggplot(lipBaseUnfiltVsnTab, aes(x=Batch_Sample, y=Value, col=Batch)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Visualize standard deviations of each feature between replicates
featDiffs <- dplyr::group_by(lipBaseUnfiltVsnTab, Feature, Sample) %>%
  dplyr::summarise(Distance = abs(diff(Value))) %>%
  dplyr::ungroup() %>%
  dplyr::pull(Distance)
hist(featDiffs, breaks = 20, xlab = 'Difference', main = 'Histogram of distances of features between replicates')
```

```{r fig.height=12, fig.width=10}
# Visualize relationships between replicates
B1 <- dplyr::filter(lipBaseUnfiltVsnTab, Batch == 'Batch1') %>%
  dplyr::select(Feature, Sample, Value) %>%
  dplyr::rename(Batch1 = Value)
B2 <- dplyr::filter(lipBaseUnfiltVsnTab, Batch == 'Batch2') %>%
  dplyr::select(Feature, Sample, Value) %>%
  dplyr::rename(Batch2 = Value)
scatTabB12 <- dplyr::left_join(B1, B2, by = c('Feature', 'Sample'))
ggplot(scatTabB12, aes(x=Batch1, y=Batch2)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = 'Relationships of replicates in Unfiltered vsn normalized data') +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = 'red', linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = 'bold'),
                                   axis.title = element_text(size = 14, face = 'bold'))
```

Check if there exists batch effect\
**Hierarchical clustering**
```{r}
# Compute sample euclidean distances
d <- dist(t(assay(lipBaseUnfiltVsn)), method = 'euclidean')

# Visualize sample distances by heatmap with clustering
batchAnno <- dplyr::select(lipBaseUnfiltVsnTab, Batch_Sample, Batch) %>%
  dplyr::filter(!duplicated(Batch_Sample)) %>%
  tibble::column_to_rownames('Batch_Sample')
pheatmap(as.matrix(d), annotation_col = batchAnno, scale = 'row', #row scaling is across columns
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = 'ward.D2', fontsize_col = 6,
         annotation_colors = list(Batch = c(Batch1 = 'grey30', Batch2 = 'grey60')))

# Do hierarchical clustering
# hc <- hclust(d, method = 'ward.D2')
# # Plot clustering result
# plot(hc, hang = 0.04, cex = 0.5, frame.plot = T, main = NULL)
```

**PCA**
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseUnfiltVsn, meta_var = 'Batch', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes
```

```{r include=F, eval=F}
# **Do batch correction using limma**\
# No PC is significantly associated with batches after batch correction.

# Perform batch correction to see if two batches can be combined even better
# Convert SE object into wide data
datMat <- assay(lipBaseUnfiltVsn)
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab <- tibble::as_tibble(colData(lipBaseUnfiltVsn), rownames = 'Batch_Sample')
design <- model.matrix(~ smpAnnoTab$Recurrence)
# Do batch correction
datMat_BC <- limma::removeBatchEffect(datMat, batch = smpAnnoTab$Batch, design = design)
lipBaseUnfiltVsn_BC <- lipBaseUnfiltVsn
assay(lipBaseUnfiltVsn_BC) <- datMat_BC

# Do single-omics analysis
pcaRes_BC <- doSOA(lipBaseUnfiltVsn_BC, meta_var = 'Batch', pca_method = 'ppca',
                   num_PCs = 20, do_onlyPCA = T)
# pcaRes_BC$pcSigAssoRes
```

**Merge replicates by taking their means**
```{r message=F}
# Merge replicates from different batches
# Prepare sample metadata
smpAnnoTab <- tibble::as_tibble(colData(lipBaseUnfiltVsn)) %>%
  dplyr::select(-Batch) %>%
  dplyr::distinct(Sample, .keep_all = T)
featAnnoTab <- tibble::as_tibble(rowData(lipBaseUnfiltVsn), rownames = 'Feature')
# Take means of replicates from different batches
merge_lipBaseUnfiltVsnTab <- summExp2df(lipBaseUnfiltVsn, assay = 'Abundance',
                                        row_id = 'Feature', col_id = 'Batch_Sample') %>%
  dplyr::group_by(Feature, Sample) %>%
  dplyr::summarise(Value = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::left_join(featAnnoTab, by = 'Feature')

# Visualize data distribution
ggplot(merge_lipBaseUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered Merged normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

**Remove features quantified in less than 2/3 of samples**
```{r}
# Remove features quantified in less than certain percent of samples
rmFeats <- dplyr::group_by(merge_lipBaseUnfiltVsnTab, Feature) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Value)) / length(Value), 2)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::pull(Feature)
merge_lipBaseFiltVsnTab <- dplyr::filter(merge_lipBaseUnfiltVsnTab, !Feature %in% rmFeats)

# Convert long data to SE object
lipBaseFiltVsn <- df2SummExp(merge_lipBaseFiltVsnTab, row_id = 'Feature', col_id = 'Sample',
                             values = 'Value', row_anno = c('RT', 'CCS', 'MZ'),
                             col_anno = c(smpAnno, 'Plate'))
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseFiltVsn)[2], 'samples and', dim(lipBaseFiltVsn)[1], 'features')
```

Show significant associations between PCs and plates where samples are located.
Samples in Plate4 were frozen at -80°C.
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseFiltVsn, meta_var = 'Plate', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC2 (16.8%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th
```

```{r}
lipBaseB12WBC15 <- lipBaseFiltVsn
B12WBC15 <- c(B12WBC15, `Filt feat num` = nrow(lipBaseB12WBC15))
```

## Batch1&2, WBC-No

```{r message=F}
# Load data
lipPlasmaB12NoWBC <- readxl::read_excel('./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_2_20231130.xlsx',
                                        sheet = '2_Feature Table no correction')
# Assign column names
colnames(lipPlasmaB12NoWBC) <- lipPlasmaB12NoWBC[1,]
lipPlasmaB12NoWBC <- lipPlasmaB12NoWBC[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB12NoWBC <- dplyr::select(lipPlasmaB12NoWBC, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`)) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %>%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, '/', CCS, '/', MZ)) %>%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab <- lipPlasmaB12NoWBC
# Collect features captured in water processed blank
waterDat <- dplyr::select(tidyTab, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt <- c(`Ori feat num` = nrow(tidyTab), `m/z < 300` = sum(tidyTab$MZ < 300),
                `QC RSD% > 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD < 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% > 25` = sum(tidyTab$QC_RSD > 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat('There are duplicated features!')
}
B12NoWBC <- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB12NoWBC <- dplyr::filter(lipPlasmaB12NoWBC, RT >= 0.3, RT <= 9, MZ >= 300, QC_RSD <= 25) %>%
  dplyr::select(-c(QC_RSD, contains('QC plasma'), contains('QCplasma'), contains('Splash')))

# Remove features captured in water processed blank, which is not of interest
waterDat <- dplyr::select(lipPlasmaB12NoWBC, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats <- rownames(waterDat)[rmFeats]
lipPlasmaB12NoWBC <- dplyr::filter(lipPlasmaB12NoWBC, !Feature %in% rmFeats) %>%
  dplyr::select(-contains('water'))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat <- readxl::read_excel('./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx')
colnames(smpPlateDat) <- c('Plate', 'Batch_Sample')
smpPlateDat <- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == 'Batch 3',
                             !grepl('^Box|QC plasma|QCplasma|water|ACN_H2O', Batch_Sample)) %>%
  dplyr::mutate(Plate = stringr::str_remove(Plate, ', Batch.+'),
                Plate = stringr::str_replace_all(Plate, 'Box |Box', 'Plate'),
                Plate = case_when(Plate %in% 'Plate3_4' ~ 'Plate4',
                                  !Plate %in% 'Plate3_4' ~ 'Plate1|2|3'))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB12NoWBC <- tidyr::pivot_longer(lipPlasmaB12NoWBC, cols = -c('Feature', 'RT', 'CCS', 'MZ'),
                                         names_to = 'Batch_Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, '_Left.+$'),
                Aliquot = stringr::str_remove_all(Batch_Sample, '^Batch\\d_'),
                Batch = stringr::str_extract(Batch_Sample, '^Batch\\d'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V2_2' ~ 'SC_DIS_A_F0X18FJY_P_V3_2',
                                    Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V6_2' ~ 'SC_DIS_A_F0X18FJY_P_V7_2',
                                    Aliquot %in% 'SC_DIS_A_1TK71I_P_V4_2' ~ 'SC_DIS_A_1TK71I_P_V3_2',
                                    !Aliquot %in% c('SC_DIS_A_F0X18FJY_P_V2_2',
                                                    'SC_DIS_A_F0X18FJY_P_V6_2',
                                                    'SC_DIS_A_1TK71I_P_V4_2') ~ Aliquot)) %>%
  dplyr::left_join(smpPlateDat, by = 'Batch_Sample') %>%
  dplyr::left_join(summMetadat4Discovery, by = 'Aliquot') %>%
  dplyr::select(-c(Aliquot, TumorPurity))
```

**Take all plasma samples from all batches for normalization, and then subset Baseline samples**\
**Normalize data without filtering by missingness** (because merging replicates
could improve data missingness)
```{r message=F}
# Normalize unfiltered data
lipPlasmaTab <- lipPlasmaB12NoWBC
lipPlasmaUnfiltVsn <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Batch_Sample',
                                      val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                                      smpAnno = c(smpAnno, 'Sample', 'Batch', 'Plate'),
                                      do_featFilt = F)$vsn.data
# Subset Baseline samples
lipBaseUnfiltVsn <- lipPlasmaUnfiltVsn[, colData(lipPlasmaUnfiltVsn)$TimePoint %in% 'Baseline']
# Prepare long data for plotting
lipBaseUnfiltVsnTab <- summExp2df(lipBaseUnfiltVsn, assay = 'Abundance',
                                  row_id = 'Feature', col_id = 'Batch_Sample')
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseUnfiltVsn)[2], 'samples and', dim(lipBaseUnfiltVsn)[1], 'features')

# Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = 'Samples', y = 'Features', title = 'Missingness of Unfiltered data (Batch1 + Batch2)') +
  th4MissViz + theme(axis.text.x = element_blank(),
                     axis.title.x = element_text(size = 13, face = 'bold'))

# Visualize data distribution
ggplot(lipBaseUnfiltVsnTab, aes(x=Batch_Sample, y=Value, col=Batch)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Visualize standard deviations of each feature between replicates
featDiffs <- dplyr::group_by(lipBaseUnfiltVsnTab, Feature, Sample) %>%
  dplyr::summarise(Distance = abs(diff(Value))) %>%
  dplyr::ungroup() %>%
  dplyr::pull(Distance)
hist(featDiffs, breaks = 20, xlab = 'Difference', main = 'Histogram of distances of features between replicates')
```

```{r fig.height=12, fig.width=10}
# Visualize relationships between replicates
B1 <- dplyr::filter(lipBaseUnfiltVsnTab, Batch == 'Batch1') %>%
  dplyr::select(Feature, Sample, Value) %>%
  dplyr::rename(Batch1 = Value)
B2 <- dplyr::filter(lipBaseUnfiltVsnTab, Batch == 'Batch2') %>%
  dplyr::select(Feature, Sample, Value) %>%
  dplyr::rename(Batch2 = Value)
scatTabB12 <- dplyr::left_join(B1, B2, by = c('Feature', 'Sample'))
ggplot(scatTabB12, aes(x=Batch1, y=Batch2)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = 'Relationships of replicates in Unfiltered vsn normalized data') +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = 'red', linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = 'bold'),
                                   axis.title = element_text(size = 14, face = 'bold'))
```

Check if there exists batch effect\
**Hierarchical clustering**
```{r}
# Compute sample euclidean distances
d <- dist(t(assay(lipBaseUnfiltVsn)), method = 'euclidean')

# Visualize sample distances by heatmap with clustering
batchAnno <- dplyr::select(lipBaseUnfiltVsnTab, Batch_Sample, Batch) %>%
  dplyr::filter(!duplicated(Batch_Sample)) %>%
  tibble::column_to_rownames('Batch_Sample')
pheatmap(as.matrix(d), annotation_col = batchAnno, scale = 'row', #row scaling is across columns
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = 'ward.D2', fontsize_col = 6,
         annotation_colors = list(Batch = c(Batch1 = 'grey30', Batch2 = 'grey60')))

# Do hierarchical clustering
# hc <- hclust(d, method = 'ward.D2')
# # Plot clustering result
# plot(hc, hang = 0.04, cex = 0.5, frame.plot = T, main = NULL)
```

**PCA**
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseUnfiltVsn, meta_var = 'Batch', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes
```

```{r include=F, eval=F}
# **Do batch correction using limma**

# Perform batch correction to see if two batches can be combined even better
# Convert SE object into wide data
datMat <- assay(lipBaseUnfiltVsn)
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab <- tibble::as_tibble(colData(lipBaseUnfiltVsn), rownames = 'Batch_Sample')
design <- model.matrix(~ smpAnnoTab$Recurrence)
# Do batch correction
datMat_BC <- limma::removeBatchEffect(datMat, batch = smpAnnoTab$Batch, design = design)
lipBaseUnfiltVsn_BC <- lipBaseUnfiltVsn
assay(lipBaseUnfiltVsn_BC) <- datMat_BC

# Do single-omics analysis
pcaRes_BC <- doSOA(lipBaseUnfiltVsn_BC, meta_var = 'Batch', pca_method = 'ppca',
                   num_PCs = 20, do_onlyPCA = T)
pcaRes_BC$pcSigAssoRes
```

**Merge replicates by taking their means**
```{r message=F}
# Merge replicates from different batches
# Prepare sample metadata
smpAnnoTab <- tibble::as_tibble(colData(lipBaseUnfiltVsn)) %>%
  dplyr::select(-Batch) %>%
  dplyr::distinct(Sample, .keep_all = T)
featAnnoTab <- tibble::as_tibble(rowData(lipBaseUnfiltVsn), rownames = 'Feature')
# Take means of replicates from different batches
merge_lipBaseUnfiltVsnTab <- summExp2df(lipBaseUnfiltVsn, assay = 'Abundance',
                                        row_id = 'Feature', col_id = 'Batch_Sample') %>%
  dplyr::group_by(Feature, Sample) %>%
  dplyr::summarise(Value = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::left_join(featAnnoTab, by = 'Feature')

# Visualize data distribution
ggplot(merge_lipBaseUnfiltVsnTab, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered Merged normalized data') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

**Remove features quantified in less than 2/3 of samples**
```{r}
# Remove features quantified in less than certain percent of samples
rmFeats <- dplyr::group_by(merge_lipBaseUnfiltVsnTab, Feature) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Value)) / length(Value), 2)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::pull(Feature)
merge_lipBaseFiltVsnTab <- dplyr::filter(merge_lipBaseUnfiltVsnTab, !Feature %in% rmFeats)

# Convert long data to SE object
lipBaseFiltVsn <- df2SummExp(merge_lipBaseFiltVsnTab, row_id = 'Feature', col_id = 'Sample',
                             values = 'Value', row_anno = c('RT', 'CCS', 'MZ'),
                             col_anno = c(smpAnno, 'Plate'))
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseFiltVsn)[2], 'samples and', dim(lipBaseFiltVsn)[1], 'features')
```

Show significant associations between PCs and plates where samples are located.
Samples in Plate4 were frozen at -80°C.
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseFiltVsn, meta_var = 'Plate', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and plates where samples are located
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=Plate, y=`PC1 (24.5%)`, col=Plate, fill=Plate)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th
```

```{r}
lipBaseB12NoWBC <- lipBaseFiltVsn
B12NoWBC <- c(B12NoWBC, `Filt feat num` = nrow(lipBaseB12NoWBC))
```

## Batch1&2&3, WBC-15%

```{r message=F}
# Load data
lipPlasmaB123WBC15 <- readxl::read_excel('./data/Discovery/AG_Hopf/Feature Tables_Discovery cohort plasma lipidomics Hopf all samples batch 1_2_3_20231129.xlsx',
                                         sheet = '2_Feature Table Correction 15')
# Assign column names
colnames(lipPlasmaB123WBC15) <- lipPlasmaB123WBC15[1,]
lipPlasmaB123WBC15 <- lipPlasmaB123WBC15[-1,]
# Tidy up data table, define features, and filter features based on RT, m/z, and QC RSD
lipPlasmaB123WBC15 <- dplyr::select(lipPlasmaB123WBC15, -c(`ΔCCS [%]`, `M meas,`, Ions, `MS/MS`,
                                                           Name, `Molecular Formula`, Annotations,
                                                           AQ, `Annotation Source`, Boxplot,
                                                           Flags, Include)) %>%
  dplyr::rename(RT = `RT [min]`, CCS = `CCS (Å²)`, MZ = `m/z meas,`, QC_RSD = `QC RSD [%]`) %>%
  dplyr::mutate(across(where(is.character), as.numeric),
                Feature = paste0(RT, '/', CCS, '/', MZ)) %>%
  dplyr::relocate(Feature)

####
# Record filtering
tidyTab <- lipPlasmaB123WBC15
# Collect features captured in water processed blank
waterDat <- dplyr::select(tidyTab, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
if (!any(duplicated(tidyTab$Feature))) {
  summFilt <- c(`Ori feat num` = nrow(tidyTab), `m/z < 300` = sum(tidyTab$MZ < 300),
                `QC RSD% > 25 | NA` = nrow(tidyTab) - sum(tidyTab$QC_RSD < 25, na.rm = T),
                `Feats in water` = sum(rmFeats),
                `QC RSD% > 25` = sum(tidyTab$QC_RSD > 25, na.rm = T),
                `QC RSD% = NA` = sum(is.na(tidyTab$QC_RSD)))
} else {
  cat('There are duplicated features!')
}
B123WBC15 <- summFilt
rm(tidyTab, summFilt, waterDat, rmFeats)
####

lipPlasmaB123WBC15 <- dplyr::filter(lipPlasmaB123WBC15, RT >= 0.3, RT <= 9, MZ >= 300, QC_RSD <= 25) %>%
  dplyr::select(-c(QC_RSD, contains('QC plasma'), contains('QCplasma')))

# Remove features captured in water processed blank, which is not of interest
waterDat <- dplyr::select(lipPlasmaB123WBC15, Feature, contains('water')) %>%
  tibble::column_to_rownames('Feature') %>%
  dplyr::mutate(across(everything(), ~ case_when(.x != 0 ~ T,
                                                 .x == 0 ~ F)))
rmFeats <- sapply(seq_len(nrow(waterDat)), function(i) {
  any(waterDat[i,])
})
rmFeats <- rownames(waterDat)[rmFeats]
lipPlasmaB123WBC15 <- dplyr::filter(lipPlasmaB123WBC15, !Feature %in% rmFeats) %>%
  dplyr::select(-contains('water'))

# Prepare sample allocation information, i.e., plate where certain sample is on
smpPlateDat <- readxl::read_excel('./data/Discovery/AG_Hopf/Summary of sample tables for overview_Hopf_20231129.xlsx')
colnames(smpPlateDat) <- c('Plate', 'Batch_Sample')
smpPlateDat <- dplyr::filter(smpPlateDat, !is.na(Plate), !Batch_Sample == 'Batch 3',
                             !grepl('^Box|QC plasma|QCplasma|water|ACN_H2O', Batch_Sample)) %>%
  dplyr::mutate(Plate = stringr::str_remove(Plate, ', Batch.+'),
                Plate = stringr::str_replace_all(Plate, 'Box |Box', 'Plate'),
                Plate = case_when(Plate %in% 'Plate3_4' ~ 'Plate4',
                                  !Plate %in% 'Plate3_4' ~ 'Plate1|2|3'))

# Convert data into long data and combine it with summarized metadata
lipPlasmaB123WBC15 <- tidyr::pivot_longer(lipPlasmaB123WBC15, cols = -c('Feature', 'RT', 'CCS', 'MZ'),
                                          names_to = 'Batch_Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Batch_Sample = stringr::str_remove(Batch_Sample, '_Left.+$'),
                Aliquot = stringr::str_remove_all(Batch_Sample, '^Batch\\d_'),
                Batch = stringr::str_extract(Batch_Sample, '^Batch\\d'),
                Abundance = replace(Abundance, Abundance == 0, NA),
                # Manually modify sample IDs to match up-to-date metadata
                Aliquot = case_when(Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V2_2' ~ 'SC_DIS_A_F0X18FJY_P_V3_2',
                                    Aliquot %in% 'SC_DIS_A_F0X18FJY_P_V6_2' ~ 'SC_DIS_A_F0X18FJY_P_V7_2',
                                    Aliquot %in% 'SC_DIS_A_1TK71I_P_V4_2' ~ 'SC_DIS_A_1TK71I_P_V3_2',
                                    !Aliquot %in% c('SC_DIS_A_F0X18FJY_P_V2_2',
                                                    'SC_DIS_A_F0X18FJY_P_V6_2',
                                                    'SC_DIS_A_1TK71I_P_V4_2') ~ Aliquot)) %>%
  dplyr::left_join(smpPlateDat, by = 'Batch_Sample') %>%
  dplyr::left_join(summMetadat4Discovery, by = 'Aliquot') %>%
  dplyr::select(-c(Aliquot, TumorPurity))
```

**Take all plasma samples from all batches for normalization, and then subset Baseline samples**\
**Normalize data without filtering by missingness** (because merging replicates
could improve data missingness)
```{r message=F}
# Normalize unfiltered data
lipPlasmaTab <- lipPlasmaB123WBC15
lipPlasmaUnfiltVsn <- doPreprocessing(lipPlasmaTab, feat = 'Feature', smp = 'Batch_Sample',
                                      val = 'Abundance', featAnno = c('RT', 'CCS', 'MZ'),
                                      smpAnno = c(smpAnno, 'Sample', 'Batch', 'Plate'),
                                      do_featFilt = F)$vsn.data
# Subset Baseline samples
lipBaseUnfiltVsn <- lipPlasmaUnfiltVsn[, colData(lipPlasmaUnfiltVsn)$TimePoint %in% 'Baseline']
# Prepare long data for plotting
lipBaseUnfiltVsnTab <- summExp2df(lipBaseUnfiltVsn, assay = 'Abundance',
                                  row_id = 'Feature', col_id = 'Batch_Sample')
# Show dimensions of data
cat('Data dimensions:', dim(lipBaseUnfiltVsn)[2], 'samples and', dim(lipBaseUnfiltVsn)[1], 'features')

# Check data quality and normalization
# Visualize data missingness
visdat::vis_miss(as.data.frame(assay(lipBaseUnfiltVsn)), cluster = T, sort_miss = T) +
  labs(x = 'Samples', y = 'Features', title = 'Missingness of Unfiltered data (Batch1 + Batch2 + Batch3)') +
  th4MissViz + theme(axis.text.x = element_blank(),
                     axis.title.x = element_text(size = 13, face = 'bold'))

# Visualize data distribution
ggplot(lipBaseUnfiltVsnTab, aes(x=Batch_Sample, y=Value, col=Batch)) +
  geom_boxplot() +
  labs(x = 'Sample', y = 'Abundance', title = 'Distribution of Unfiltered vsn normalized data') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

# Visualize mean-sd relationship
vsn::meanSdPlot(assay(lipBaseUnfiltVsn), ranks = T, plot = F, bins = 30)$gg +
  labs(x = 'Rank of mean', y = 'SD', title = 'Feature mean-sd relationship') +
  th

# Visualize standard deviations of each feature among replicates
featSDs <- dplyr::group_by(lipBaseUnfiltVsnTab, Feature, Sample) %>%
  dplyr::summarise(SD = sd(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::pull(SD)
hist(featSDs, breaks = 20, xlab = 'Standard deviation', main = 'Histogram of SDs of features among replicates')
```

```{r fig.height=12, fig.width=10}
# Visualize relationships between replicates
B1 <- dplyr::filter(lipBaseUnfiltVsnTab, Batch == 'Batch1') %>%
  dplyr::select(Feature, Sample, Value) %>%
  dplyr::rename(Batch1 = Value)
B2 <- dplyr::filter(lipBaseUnfiltVsnTab, Batch == 'Batch2') %>%
  dplyr::select(Feature, Sample, Value) %>%
  dplyr::rename(Batch2 = Value)
B3 <- dplyr::filter(lipBaseUnfiltVsnTab, Batch == 'Batch3') %>%
  dplyr::select(Feature, Sample, Value) %>%
  dplyr::rename(Batch3 = Value)

scatTabB12 <- dplyr::left_join(B1, B2, by = c('Feature', 'Sample'))
ggplot(scatTabB12, aes(x=Batch1, y=Batch2)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = 'Relationships of replicates in Unfiltered vsn normalized data') +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = 'red', linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = 'bold'),
                                   axis.title = element_text(size = 14, face = 'bold'))

scatTabB13 <- dplyr::left_join(B1, B3, by = c('Feature', 'Sample'))
ggplot(scatTabB13, aes(x=Batch1, y=Batch3)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = 'Relationships of replicates in Unfiltered vsn normalized data') +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = 'red', linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = 'bold'),
                                   axis.title = element_text(size = 14, face = 'bold'))

scatTabB23 <- dplyr::left_join(B2, B3, by = c('Feature', 'Sample'))
ggplot(scatTabB23, aes(x=Batch2, y=Batch3)) +
  geom_point() +
  facet_wrap(vars(Sample), ncol = 8) +
  labs(title = 'Relationships of replicates in Unfiltered vsn normalized data') +
  ggpubr::stat_cor(aes(label=after_stat(r.label)), method = 'pearson', size = 3.5) +
  geom_abline(intercept = 0, slope = 1, col = 'red', linewidth = 0.5) +
  theme_bw(base_size = 12) + theme(strip.text = element_text(face = 'bold'),
                                   axis.title = element_text(size = 14, face = 'bold'))
```

Check if there exists batch effect\
**Hierarchical clustering**
```{r fig.width=14}
# Compute sample euclidean distances
d <- dist(t(assay(lipBaseUnfiltVsn)), method = 'euclidean')

# Visualize sample distances by heatmap with clustering
batchAnno <- dplyr::select(lipBaseUnfiltVsnTab, Batch_Sample, Batch) %>%
  dplyr::filter(!duplicated(Batch_Sample)) %>%
  tibble::column_to_rownames('Batch_Sample')
pheatmap(as.matrix(d), annotation_col = batchAnno, scale = 'row', #row scaling is across columns
         color = colorRampPalette(c('navy', 'white', 'red'))(100),
         cluster_cols = T, cluster_rows = F, show_rownames = F,
         clustering_method = 'ward.D2', fontsize_col = 5,
         annotation_colors = list(Batch = c(Batch1 = 'grey30', Batch2 = 'grey60', Batch3 = 'grey90')))

# Do hierarchical clustering
# hc <- hclust(d, method = 'ward.D2')
# # Plot clustering result
# plot(hc, hang = 0.04, cex = 0.5, frame.plot = T, main = NULL)
```

**PCA**
```{r}
# Do PCA
pcaRes <- doSOA(lipBaseUnfiltVsn, meta_var = 'Batch', pca_method = 'ppca',
                num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes
# Visualize PCs
pcTab <- pcaRes$pcTab
ggplot(pcTab, aes(x=Batch, y=`PC16 (0.5%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

ggplot(pcTab, aes(x=Batch, y=`PC7 (3.3%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th

ggplot(pcTab, aes(x=Batch, y=`PC4 (7.2%)`, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th
```

```{r include=F, eval=F}
# **Do batch correction using limma**\
# No PC is significantly associated with batches after batch correction.

# Perform batch correction to see if two batches can be combined even better
# Convert SE object into wide data
datMat <- assay(lipBaseUnfiltVsn)
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab <- tibble::as_tibble(colData(lipBaseUnfiltVsn), rownames = 'Batch_Sample')
design <- model.matrix(~ smpAnnoTab$Recurrence)
# Do batch correction
datMat_BC <- limma::removeBatchEffect(datMat, batch = smpAnnoTab$Batch, design = design)
lipBaseUnfiltVsn_BC <- lipBaseUnfiltVsn
assay(lipBaseUnfiltVsn_BC) <- datMat_BC

# Do single-omics analysis
pcaRes_BC <- doSOA(lipBaseUnfiltVsn_BC, meta_var = 'Batch', pca_method = 'ppca',
                   num_PCs = 20, do_onlyPCA = T)
# pcaRes_BC$pcSigAssoRes
```

```{r message=F}
# **Merge replicates by taking their means**

# Merge replicates from different batches
# Prepare sample metadata
smpAnnoTab <- tibble::as_tibble(colData(lipBaseUnfiltVsn)) %>%
  dplyr::select(-Batch) %>%
  dplyr::distinct(Sample, .keep_all = T)
featAnnoTab <- tibble::as_tibble(rowData(lipBaseUnfiltVsn), rownames = 'Feature')
# Take means of replicates from different batches
merge_lipBaseUnfiltVsnTab <- summExp2df(lipBaseUnfiltVsn, assay = 'Abundance',
                                        row_id = 'Feature', col_id = 'Batch_Sample') %>%
  dplyr::group_by(Feature, Sample) %>%
  dplyr::summarise(Value = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::left_join(smpAnnoTab, by = 'Sample') %>%
  dplyr::left_join(featAnnoTab, by = 'Feature')

# **Remove features quantified in less than 2/3 of samples**

# Remove features quantified in less than certain percent of samples
rmFeats <- dplyr::group_by(merge_lipBaseUnfiltVsnTab, Feature) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Value)) / length(Value), 2)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::pull(Feature)
merge_lipBaseFiltVsnTab <- dplyr::filter(merge_lipBaseUnfiltVsnTab, !Feature %in% rmFeats)

# Convert long data to SE object
lipBaseFiltVsn <- df2SummExp(merge_lipBaseFiltVsnTab, row_id = 'Feature', col_id = 'Sample',
                             values = 'Value', row_anno = c('RT', 'CCS', 'MZ'),
                             col_anno = c(smpAnno, 'Plate'))
```

```{r}
B123WBC15 <- c(B123WBC15, `Filt feat num` = length(unique(lipPlasmaB123WBC15$Feature)))
```

## Summary

Visualize filtering\
**Original vs Filtered feature space (by m/z, QC RSD%, and blank relevant feature removal)**
```{r message=F}
# Visualize filtering in different datasets
# Prepare summarized filtering data
summFiltTab <- data.frame(B1WBC25, B1WBC15, B1NoWBC, B12WBC25, B12WBC15, B12NoWBC, B123WBC15) %>%
  dplyr::rename(`B1, WBC-25%` = B1WBC25, `B1, WBC-15%` = B1WBC15, `B1, WBC-No` = B1NoWBC,
                `B1&2, WBC-25%` = B12WBC25, `B1&2, WBC-15%` = B12WBC15, `B1&2, WBC-No` = B12NoWBC,
                `B1&2&3, WBC-15%` = B123WBC15) %>%
  tibble::rownames_to_column('Filtering') %>%
  tidyr::pivot_longer(cols = -'Filtering', names_to = 'Dataset', values_to = 'Count') %>%
  dplyr::mutate(Batch = stringr::str_remove(Dataset, ', .+'),
                Batch = stringr::str_replace(Batch, '^B', 'Batch'),
                WBC = stringr::str_extract(Dataset, 'WBC.+'),
                WBC = factor(WBC, levels = c('WBC-25%', 'WBC-15%', 'WBC-No')))
featSpaceTab <- dplyr::filter(summFiltTab, Filtering %in% c('Ori feat num', 'Filt feat num')) %>%
  dplyr::rename(featSpace = Filtering) %>%
  dplyr::mutate(featSpace = case_when(featSpace %in% 'Ori feat num' ~ 'Original',
                                      featSpace %in% 'Filt feat num' ~ 'After filtering'),
                featSpace = factor(featSpace, levels = c('Original', 'After filtering')))
summFiltTab <- dplyr::filter(summFiltTab, !Filtering %in% c('Ori feat num', 'QC RSD% > 25 | NA', 'Filt feat num'))
# Plot feature spaces
ggplot(featSpaceTab, aes(x=WBC, y=Count)) +
  geom_bar(aes(fill=featSpace), stat = 'identity', position = position_dodge(), alpha = 0.9) +
  scale_fill_grey(name = 'Feature space', start = 0.7, end = 0.3) +
  labs(x = 'Dataset (Within-batch correction)') +
  facet_wrap(~ Batch) +
  th + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
             strip.text = element_text(size = 16, face = 'bold'))
```

**Numbers of removed features**
```{r message=F}
# Plot numbers of removed features
ggplot(summFiltTab, aes(x=WBC, y=Count, col=Filtering, group=Filtering)) +
  geom_point(size = 4, show.legend = F) +
  geom_line(linewidth = 2, linetype = 'dashed') +
  scale_color_brewer(name = 'Filtering criteria', palette = 'Dark2') +
  labs(x = 'Dataset (Within-batch correction)') +
  facet_wrap(~ Batch) +
  th + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
             strip.text = element_text(size = 16, face = 'bold'))

# ggplot(featSpaceTab, aes(x=WBC, y=Count)) +
#   geom_bar(aes(fill=featSpace), stat = 'identity', position = position_dodge(), alpha = 0.9) +
#   geom_point(data = summFiltTab, aes(x=WBC, y=Count, col=Filtering), size = 2.5, show.legend = F) +
#   geom_line(data = summFiltTab, aes(col=Filtering, group=Filtering), linewidth = 1.2) +
#   scale_fill_grey(name = 'Feature space', start = 0.8, end = 0.6) +
#   scale_color_brewer(name = 'Filtering criteria', palette = 'Dark2') +
#   labs(x = 'Within-batch correction') +
#   facet_wrap(~ Batch) +
#   th + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
#              strip.text = element_text(size = 16, face = 'bold'))
```

Display proportions of **recurrence-related** significant features
```{r}
# Visualize proportions of significant features and data power about recurrence prediction
# Do SOA
soaResB1WBC25 <- doSOA(lipBaseB1WBC25, meta_var = 'Recurrence', pca_method = 'ppca',
                       num_PCs = 20, use_proDA = T, unwantVar = 'Plate')
soaResB1WBC15 <- doSOA(lipBaseB1WBC15, meta_var = 'Recurrence', pca_method = 'ppca',
                       num_PCs = 20, use_proDA = T, unwantVar = 'Plate')
soaResB1NoWBC <- doSOA(lipBaseB1NoWBC, meta_var = 'Recurrence', pca_method = 'ppca',
                       num_PCs = 20, use_proDA = T, unwantVar = 'Plate')
soaResB12WBC25 <- doSOA(lipBaseB12WBC25, meta_var = 'Recurrence', pca_method = 'ppca',
                        num_PCs = 20, use_proDA = T, unwantVar = 'Plate')
soaResB12WBC15 <- doSOA(lipBaseB12WBC15, meta_var = 'Recurrence', pca_method = 'ppca',
                        num_PCs = 20, use_proDA = T, unwantVar = 'Plate')
soaResB12NoWBC <- doSOA(lipBaseB12NoWBC, meta_var = 'Recurrence', pca_method = 'ppca',
                        num_PCs = 20, use_proDA = T, unwantVar = 'Plate')

# Prepare summarized feature significance data
propSigFeatsB1WBC25 <- nrow(soaResB1WBC25$featSigAssoRes) / nrow(soaResB1WBC25$data) * 100
propSigFeatsB1WBC15 <- nrow(soaResB1WBC15$featSigAssoRes) / nrow(soaResB1WBC15$data) * 100
propSigFeatsB1NoWBC <- nrow(soaResB1NoWBC$featSigAssoRes) / nrow(soaResB1NoWBC$data) * 100
propSigFeatsB12WBC25 <- nrow(soaResB12WBC25$featSigAssoRes) / nrow(soaResB12WBC25$data) * 100
propSigFeatsB12WBC15 <- nrow(soaResB12WBC15$featSigAssoRes) / nrow(soaResB12WBC15$data) * 100
propSigFeatsB12NoWBC <- nrow(soaResB12NoWBC$featSigAssoRes) / nrow(soaResB12NoWBC$data) * 100
sigFeatPropTab <- data.frame(Dataset = factor(c('B1, WBC-25%', 'B1, WBC-15%', 'B1, WBC-No',
                                                'B1&2, WBC-25%', 'B1&2, WBC-15%', 'B1&2, WBC-No'),
                                              levels = c('B1&2, WBC-No', 'B1&2, WBC-15%', 'B1&2, WBC-25%',
                                                         'B1, WBC-No', 'B1, WBC-15%', 'B1, WBC-25%')),
                             Proportion = c(propSigFeatsB1WBC25, propSigFeatsB1WBC15, propSigFeatsB1NoWBC,
                                            propSigFeatsB12WBC25, propSigFeatsB12WBC15, propSigFeatsB12NoWBC),
                             AbsNum = c(nrow(soaResB1WBC25$featSigAssoRes), nrow(soaResB1WBC15$featSigAssoRes),
                                        nrow(soaResB1NoWBC$featSigAssoRes), nrow(soaResB12WBC25$featSigAssoRes),
                                        nrow(soaResB12WBC15$featSigAssoRes), nrow(soaResB12NoWBC$featSigAssoRes))) %>%
  dplyr::mutate(Batch = stringr::str_remove(Dataset, ', .+'),
                Batch = stringr::str_replace(Batch, '^B', 'Batch'))

ggplot(sigFeatPropTab, aes(x=Dataset, y=Proportion, fill=Batch)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  scale_fill_grey(start = 0.3, end = 0.5) +
  labs(y = 'Percentage (%)', title = 'Recurrence vs Non-recurrence') +
  th
```

Display absolute counts of **recurrence-related** significant features
```{r}
ggplot(sigFeatPropTab, aes(x=Dataset, y=AbsNum, fill=Batch)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  scale_fill_grey(start = 0.3, end = 0.5) +
  labs(y = 'Count', title = 'Recurrence vs Non-recurrence') +
  th
```

Show **recurrence-related** significant PCs
```{r}
# Prepare summarized PC significance data
sigPCTabB1WBC25 <- soaResB1WBC25$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'B1, WBC-25%')
sigPCTabB1WBC15 <-soaResB1WBC15$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'B1, WBC-15%')
sigPCTabB1NoWBC <-soaResB1NoWBC$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'B1, WBC-No')
sigPCTabB12WBC25 <-soaResB12WBC25$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'B1&2, WBC-25%')
sigPCTabB12WBC15 <-soaResB12WBC15$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'B1&2, WBC-15%')
sigPCTabB12NoWBC <-soaResB12NoWBC$pcSigAssoRes %>%
  dplyr::mutate(Dataset = 'B1&2, WBC-No')
dplyr::bind_rows(sigPCTabB1WBC25, sigPCTabB1WBC15, sigPCTabB1NoWBC,
                 sigPCTabB12WBC25, sigPCTabB12WBC15, sigPCTabB12NoWBC) %>%
  dplyr::relocate(Dataset)

ggplot(soaResB1WBC25$pcTab, aes(x=Recurrence, y=`PC5 (7%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th

ggplot(soaResB12WBC25$pcTab, aes(x=Recurrence, y=`PC5 (7%)`, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.7, outliers = F) +
  geom_jitter(position = position_jitter(0.3), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             size = 6, show.legend = F) +
  th
```
