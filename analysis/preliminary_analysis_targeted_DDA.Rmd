---
title: 'Single-omics analysis: Method development lung cancer patient cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    code_folding: hide
---

<font size='4'> Description: Conduct univariate (association test) and multivariate
(PCA) analyses on individual datasets, Plasma and Tissue Targeted Metabolomics from
AG Hell and DDA Proteomics from AG Krijgsveld, to take an initial look at power of
each dataset in terms of predicting patient cancer recurrences and also potentially
to provide evidence for latter multi-omics analyses. Association test between each
feature (metabolite and protein level) and cancer recurrence was performed to capture
significant features that can separate recurrence and non-recurrence patients. PCA
was performed to see if there is any significant PC that can separate recurrence
and non-recurrence patients. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_MethodDev')
```

Load libraries
```{r library loading, message = FALSE}
library('SummarizedExperiment')
library('ggrepel')
library('ggfortify')
library('umap')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

# Plasma Metabolomics
Based on PCA result obtained by analyzing whole Plasma Metabolomics dataset that
includes Baseline and Follow-up samples, we found that PCA mainly captures source
of variation in time points, the unwanted variation. Besides, we attempt to identify
biomarkers that can predict whether patients WILL suffer from cancer recurrence or
not. Therefore, we decided to analyze Baseline and Follow-up samples separately.

```{r}
# Load normalized data
metaPlasmaNorm <- readRDS('./data/AG_Hell/metaPlasmaNorm.rds')
# Manually modify metadata information (time point, smoking, stage)
tmp_metadata <- as.data.frame(colData(metaPlasmaNorm)) %>%
  dplyr::mutate(
    TimePoint = dplyr::case_when(
      Condition == 'Baseline' ~ 'Baseline',
      Condition != 'Baseline' ~ '2 years later'
      ),
    everSmo_nonSmo = case_when(
      Smoking == 'Smoker' ~ 'Smoker',
      Smoking == 'Ex-smoker' ~ 'Smoker',
      Smoking == 'Non-smoker' ~ 'Non-smoker'
      ),
    Smo_exSmo = case_when(
      Smoking == 'Smoker' ~ 'Smoker',
      Smoking == 'Ex-smoker' ~ 'Ex-smoker'
      ),
    ToLymph = case_when(
      Stage == 'IIB' ~ 'Yes',
      Stage != 'IIB' ~ 'No'
    ))
colData(metaPlasmaNorm)['TimePoint'] <- tmp_metadata$TimePoint
colData(metaPlasmaNorm)['everSmo_nonSmo'] <- tmp_metadata$everSmo_nonSmo
colData(metaPlasmaNorm)['Smo_exSmo'] <- tmp_metadata$Smo_exSmo
colData(metaPlasmaNorm)['ToLymph'] <- tmp_metadata$ToLymph

# Perform analysis
metaPlasmaRes <- SOA(metaPlasmaNorm, fac = c('Recurrence', 'TimePoint', 'Gender'))
tPCASigRes <- metaPlasmaRes$tPCASigRes
pcaRes <- metaPlasmaRes$pcaRes
pcTab <- metaPlasmaRes$pcTab
```

Display associations between learned PCs (Var1) and factors (Var2). Basically
t-test was performed to test significance of difference between two groups, e.g.,
recurrence and non-recurrence patient groups or baseline and follow-up sample groups.
```{r}
# Display PCs of interest
tPCASigRes
```

PC2 explains quite some variation in data and separates patient samples by time points.
```{r}
# ggfortify
# ggplot2::autoplot(pcaRes, x = 1, y =2)

ggplot(pcTab, aes(x=PC1, y=PC2, col=TimePoint, shape=Recurrence,
                  group=Patient)) +
  geom_point(size = 4) +
  labs(x = 'PC1 (24.92%)', y = 'PC2 (16.79%)', title = 'Plasma metabolomics') +
  geom_line(col = 'grey50', linetype = 'dashed') +
  scale_color_discrete(name = 'Time point',
                       labels = c('Baseline', '2 years later')) +
  th
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Plasma metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Baseline samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(metaPlasmaNorm)$Condition == 'Baseline')
metaBase <- metaPlasmaNorm[, smpBaseIdx]

# Perform analysis
metaBaseRes <- SOA(metaBase, fac = c('Recurrence', 'Gender'), fac4uni = 'Recurrence', num_feats = 30)
datMat <- metaBaseRes$data
smpAnno <- metaBaseRes$smpMetadata
tFeatSigRes <- metaBaseRes$tFeatSigRes
tPCASigRes <- metaBaseRes$tPCASigRes
pcaRes <- metaBaseRes$pcaRes
pcTab <- metaBaseRes$pcTab
pcTopFeatTab <- metaBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', #row scaling is across columns
                   main = 'Baseline plasma metabolomics')
```

Visualize data of top 6 significant features
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free_y') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 4) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
# ggsave('./output/AG_Hell/boxplot_topSigFeats_BPM.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Baseline plasma metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC11 potentially separates recurrence and non-recurrence patients.
```{r}
# ggfortify
# ggplot2::autoplot(pcaRes, x = 11, y = 15)

# PC11
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC11, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # geom_text_repel(aes(label=Sample), size = 4, show.legend = F) +
  labs(y = 'PC11 (2.74%)', title = 'Baseline plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 7) +
  th
# ggsave('./output/AG_Hell/boxplot_pc11_BPM.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Plot molecular signatures captured by PC11 in input data. We took a look at top
20 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
There is no single feature that can decently hint if patients will suffer cancer
recurrence or not, which means each of these top features contributes a bit to
explaining variation between recurrence and non-recurrence patients.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC11$Feature[1:20]
# Order features by loadings
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
a <- pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Baseline plasma metabolomics - PC11')
# ggsave(paste0(result_path, 'AG_Hell/metaPlasma_baseline_heatmap_pc11.png'), a, device = 'png', dpi = 400)
```

Display top features that build the PC11
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC11
```

Another PC that significantly separates recurrence and non-recurrence patients
```{r}
# PC15
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC15, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # geom_text_repel(aes(label=Sample), size = 4, show.legend = F) +
  labs(y = 'PC15 (1.71%)') +#, title = 'Baseline plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 7) +
  th
# ggsave('./output/AG_Hell/boxplot_pc15_BPM.png', device = 'png', dpi = 400, height = 8, width = 10)

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC15$Feature[1:20]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
a <- pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Baseline plasma metabolomics - PC15')
# ggsave(paste0(result_path, 'AG_Hell/metaPlasma_baseline_heatmap_pc15.png'), a, device = 'png', dpi = 400)

# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC15
```

## Follow-up samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(metaPlasmaNorm)$Condition != 'Baseline')
metaFolo <- metaPlasmaNorm[, smpFoloIdx]

# Perform analysis
metaFoloRes <- SOA(metaFolo, fac = 'Recurrence', num_feats = 30)
datMat <- metaFoloRes$data
smpAnno <- metaFoloRes$smpMetadata
tFeatSigRes <- metaFoloRes$tFeatSigRes
tPCASigRes <- metaFoloRes$tPCASigRes
pcaRes <- metaFoloRes$pcaRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Follow-up plasma metabolomics')
```

Visualize data of top 6 significant features
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Follow-up plasma metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Changes in time course
Differences between Follow-up and Baseline samples (Follow-up matrix - baseline
matrix):\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(metaPlasmaNorm)$Condition == 'Baseline')
metaBase <- metaPlasmaNorm[, smpBaseIdx]
# Subset follow-up samples
smpFoloIdx <- which(colData(metaPlasmaNorm)$Condition != 'Baseline')
metaFolo <- metaPlasmaNorm[, smpFoloIdx]
# Modify sample names for matching two datasets
colnames(metaBase) <- stringr::str_remove(colnames(metaBase), '_P_B')
colnames(metaFolo) <- stringr::str_remove(colnames(metaFolo), '_P_R')
# Retrieve data matrix
metaBaseMat <- SummarizedExperiment::assay(metaBase)
metaFoloMat <- SummarizedExperiment::assay(metaFolo)
# Subtract follow-up matrix by baseline matrix
if (identical(colnames(metaBaseMat), colnames(metaFoloMat)) &
    identical(rownames(metaBaseMat), rownames(metaFoloMat))) {
  metaDiffMat <- metaFoloMat - metaBaseMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(metaBase)), Patient, Recurrence)
metaDiff <- SummarizedExperiment(assays = metaDiffMat, colData = colAnno)

# Perform analysis
metaPlasmaDiffRes <- SOA(metaDiff, fac = 'Recurrence', num_feats = 30)
datMat <- metaPlasmaDiffRes$data
smpAnno <- metaPlasmaDiffRes$smpMetadata
tFeatSigRes <- metaPlasmaDiffRes$tFeatSigRes
tPCASigRes <- metaPlasmaDiffRes$tPCASigRes
pcaRes <- metaPlasmaDiffRes$pcaRes
pcTab <- metaPlasmaDiffRes$pcTab
pcTopFeatTab <- metaPlasmaDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Differential plasma metabolomics')
```

Visualize data of top 6 significant features
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential plasma metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC17 potentially separates recurrence and non-recurrence patients
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC17, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential plasma metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th
```

Observe molecular signatures captured by PC17 in input data
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC17$Feature[1:10]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential plasma metabolomics - PC17')
```

Display top features that build PC17
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab
```




# Tissue Metabolomics
Based on PCA result obtained by analyzing whole Tissue Metabolomics dataset that
includes Tumor and Normal samples, we found that PCA mainly captures source of
variation in tissue conditions, which is not of direct interest. In addition,
Recurrence-related significant PCs do not work that well, perhaps because Tumor
and Normal samples are noise to each other. Therefore, we decided to analyze Tumor
and Normal samples separately.

```{r}
# Load normalized data
metaTissueNorm <- readRDS('./data/AG_Hell/metaTissueNorm.rds')

# Perform analysis
metaTissueRes <- SOA(metaTissueNorm, fac = c('Recurrence', 'Condition', 'Gender'))
tPCASigRes <- metaTissueRes$tPCASigRes
pcaRes <- metaTissueRes$pcaRes
pcTab <- metaTissueRes$pcTab
```

Display associations between learned PCs (Var1) and factors (Var2). Basically
t-test was performed to test significance of difference between two groups, e.g.,
recurrence and non-recurrence patient groups or tumor and normal sample groups.
```{r}
# Display PCs of interest
tPCASigRes
```

PC2 explains quite some variation in data and separates patient samples by tissue conditions.
```{r}
ggplot(pcTab, aes(x=Condition, y=PC2, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tissue metabolomics') +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)', title = 'Tissue metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

Visualize recurrence-related significant PCs
```{r}
ggplot(pcTab, aes(x=PC14, y=PC15, col=Recurrence, group=Patient)) +
  geom_point(size = 3) +
  labs(title = 'Tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  th

ggplot(pcTab, aes(x=Recurrence, y=PC14, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             show.legend = F) +
  th

ggplot(pcTab, aes(x=Recurrence, y=PC15, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th
```

## Tumor Samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(metaTissueNorm)$Condition == 'Tumor')
metaTumor <- metaTissueNorm[, smpTumorIdx]

# Perform analysis
metaTumorRes <- SOA(metaTumor, fac = 'Recurrence', num_feats = 30)
datMat <- metaTumorRes$data
smpAnno <- metaTumorRes$smpMetadata
tFeatSigRes <- metaTumorRes$tFeatSigRes
tPCASigRes <- metaTumorRes$tPCASigRes
pcaRes <- metaTumorRes$pcaRes
pcTab <- metaTumorRes$pcTab
pcTopFeatTab <- metaTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
a <- pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   fontsize = 18, fontsize_col = 14,
                   scale = 'row')#, main = 'Tumor Tissue metabolomics')
# ggsave('./output/AG_Hell/heatmap_sigFeats_TTM.png', a, device = 'png', dpi = 400, height = 8, width = 10)
```

Visualize data of top 6 significant features
```{r}
# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free_y') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 4) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
# ggsave('./output/AG_Hell/boxplot_topSigFeats_TTM.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Tumor tissue metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC16 potentially separates recurrence and non-recurrence patients.
```{r}
# ggplot2::autoplot(pcaRes, x = 15, y = 16)
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC16, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # geom_text_repel(aes(label=Sample), size = 4, show.legend = F) +
  labs(y = 'PC16 (1.37%)') +#title = 'Tumor tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 7, hjust = 0) +
  th
# ggsave('./output/AG_Hell/boxplot_pc16_TTM.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Plot molecular signatures captured by PC16 in input data. We took a look at top
10 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC16$Feature[1:10]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue metabolomics - PC16')
```

Display top features that build the PC16
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC16
```

## Normal samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(metaTissueNorm)$Condition == 'Normal')
metaNormal <- metaTissueNorm[, smpNormalIdx]

# Perform analysis
metaNormalRes <- SOA(metaNormal, fac = 'Recurrence', num_feats = 30)
datMat <- metaNormalRes$data
smpAnno <- metaNormalRes$smpMetadata
tFeatSigRes <- metaNormalRes$tFeatSigRes
tPCASigRes <- metaNormalRes$tPCASigRes
pcaRes <- metaNormalRes$pcaRes
pcTab <- metaNormalRes$pcTab
pcTopFeatTab <- metaNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Normal tissue metabolomics')
```

Visualize data of those 5 significant features
```{r}
# Visualize data of those 5 significant features
topSigFeats <- tFeatSigRes$Var1[1:5]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Normal tissue metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC6 potentially separates recurrence and non-recurrence patients.
```{r}
# PC6
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC6, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # geom_text_repel(aes(label=Sample), size = 4, show.legend = F) +
  labs(title = 'Normal tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th
```

Plot molecular signatures captured by PC6 in input data. We took a look at top
10 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC6$Feature[1:10]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Normal tissue metabolomics - PC6')
```

Display top features that build the PC6
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC6
```

Other PCs that significantly separate recurrence and non-recurrence patients
```{r}
# PC17
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC17, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # geom_text_repel(aes(label=Sample), size = 4, show.legend = F) +
  labs(title = 'Normal tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC17$Feature[1:10]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Normal tissue metabolomics - PC17')

# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC17


# PC9
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC9, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # geom_text_repel(aes(label=Sample), size = 4, show.legend = F) +
  labs(title = 'Normal tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th
```

## Difference in tissue conditions
Tumor matrix - Normal matrix\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset Tumor samples
smpTumorIdx <- which(colData(metaTissueNorm)$Condition == 'Tumor')
metaTumor <- metaTissueNorm[, smpTumorIdx]
# Subset Normal samples
smpNormalIdx <- which(colData(metaTissueNorm)$Condition == 'Normal')
metaNormal <- metaTissueNorm[, smpNormalIdx]
# Modify sample names for matching two datasets
colnames(metaTumor) <- stringr::str_remove(colnames(metaTumor), '_TG')
colnames(metaNormal) <- stringr::str_remove(colnames(metaNormal), '_NG')
# Retrieve data matrix
metaTumorMat <- SummarizedExperiment::assay(metaTumor)
metaNormalMat <- SummarizedExperiment::assay(metaNormal)
# Subtract follow-up matrix by baseline matrix
if (identical(colnames(metaTumorMat), colnames(metaNormalMat)) &
    identical(rownames(metaTumorMat), rownames(metaNormalMat))) {
  metaDiffMat <- metaTumorMat - metaNormalMat
} else {
  print('Align samples or features first.')
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(metaTumor)), Patient, Recurrence)
rowAnno <- as.data.frame(rowData(metaTumor))
metaDiff <- SummarizedExperiment(assays = metaDiffMat, colData = colAnno,
                                 rowData = rowAnno)

# Perform analysis
metaTissueDiffRes <- SOA(metaDiff, fac = 'Recurrence', num_feats = 30)
datMat <- metaTissueDiffRes$data
smpAnno <- metaTissueDiffRes$smpMetadata
tFeatSigRes <- metaTissueDiffRes$tFeatSigRes
tPCASigRes <- metaTissueDiffRes$tPCASigRes
pcaRes <- metaTissueDiffRes$pcaRes
pcTab <- metaTissueDiffRes$pcTab
pcTopFeatTab <- metaTissueDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
tFeatSigRes

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
pheatmap::pheatmap(datMat[featOrder, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Differential tissue metabolomics')
```

Visualize data of those 4 significant features
```{r}
# Visualize data of those 4 significant features
topSigFeats <- tFeatSigRes$Var1[1:4]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = factor(Feature, levels = topSigFeats)) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential tissue metabolomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

PC18 potentially separates recurrence and non-recurrence patients.
```{r}
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC18, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # geom_text_repel(aes(label=Sample), size = 4, show.legend = F) +
  labs(title = 'Differential tissue metabolomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th
```

Plot molecular signatures captured by PC18 in input data. We took a look at top
10 features with highest loadings and observed metabolite levels of these top
features through heatmap. Note that features in heatmap are ordered by their loadings.
```{r}
# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC18$Feature[1:10]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
pheatmap::pheatmap(datMat[topFeatsIdx, smpOrder],
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential tissue metabolomics - PC18')
```

Display top features that build the PC18
```{r}
# Display top features with highest loadings of PC of interest
pcTopFeatTab$PC18
```




# Plasma Proteomics
As described in Plasma Metabolomics section, we analyzed Baseline and Follow-up
samples separately.

```{r}
# Load normalized data
proPlasmaNorm <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm.rds')
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(proPlasmaNorm), rownames = 'PG.Groups')
# Add time point information into data
timePoint <- as.data.frame(colData(proPlasmaNorm)) %>%
  dplyr::mutate(TimePoint = dplyr::case_when(
    Condition == 'Baseline' ~ 'Baseline',
    Condition != 'Baseline' ~ '2 years later')) %>%
  dplyr::select(TimePoint)
colData(proPlasmaNorm)['TimePoint'] <- timePoint

# Perform analysis
proPlasmaRes <- SOA(proPlasmaNorm, fac = c('Recurrence', 'TimePoint', 'Gender'))
tPCASigRes <- proPlasmaRes$tPCASigRes
pcaRes <- proPlasmaRes$pcaRes
pcTab <- proPlasmaRes$pcTab

# Display PCs of interest
tPCASigRes

ggplot(pcTab, aes(x=PC26, y=PC27, col=TimePoint, shape=Recurrence, group=Patient)) +
  geom_point(size = 3) +
  labs(title = 'Plasma proteomics') +
  geom_line(col = 'grey50', linetype = 'dashed') +
  scale_color_discrete(name = 'Time point',
                       labels = c('Baseline', '2 years later')) +
  th

ggplot(pcTab, aes(x=Recurrence, y=PC14, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)', title = 'Plasma proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Baseline samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(proPlasmaNorm)$Condition == 'Baseline')
proBase <- proPlasmaNorm[, smpBaseIdx]

# Perform analysis
proBaseRes <- SOA(proBase, fac = 'Recurrence', num_feats = 30)
datMat <- proBaseRes$data
smpAnno <- proBaseRes$smpMetadata
tFeatSigRes <- proBaseRes$tFeatSigRes
tPCASigRes <- proBaseRes$tPCASigRes
pcaRes <- proBaseRes$pcaRes
pcTab <- proBaseRes$pcTab
pcTopFeatTab <- proBaseRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$PG.Groups,
                                                  to = featInfo$PG.Genes,
                                                  warn_missing = F))

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Baseline plasma proteomics')

# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$PG.Groups,
                                          to = featInfo$PG.Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$PG.Groups,
                                                                   to = featInfo$PG.Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Baseline plasma proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

# PC11
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC11, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # geom_text_repel(aes(label=Sample), size = 4, show.legend = F) +
  labs(title = 'Baseline plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC11$Feature[1:20]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Baseline plasma proteomics - PC11')

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC11, Gene = plyr::mapvalues(Feature,
                                                        from = featInfo$PG.Groups,
                                                        to = featInfo$PG.Genes,
                                                        warn_missing = F))

# PC13
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC13, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  # geom_text_repel(aes(label=Sample), size = 4, show.legend = F) +
  labs(title = 'Baseline plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC13$Feature[1:20]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Baseline plasma proteomics - PC13')

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC13, Gene = plyr::mapvalues(Feature,
                                                        from = featInfo$PG.Groups,
                                                        to = featInfo$PG.Genes,
                                                        warn_missing = F))
```

## Follow-up samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset follow-up samples
smpFoloIdx <- which(colData(proPlasmaNorm)$Condition != 'Baseline')
proFolo <- proPlasmaNorm[, smpFoloIdx]

# Perform analysis
proFoloRes <- SOA(proFolo, fac = 'Recurrence', num_feats = 30)
datMat <- proFoloRes$data
smpAnno <- proFoloRes$smpMetadata
tFeatSigRes <- proFoloRes$tFeatSigRes
tPCASigRes <- proFoloRes$tPCASigRes
pcaRes <- proFoloRes$pcaRes
pcTab <- proFoloRes$pcTab
pcTopFeatTab <- proFoloRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$PG.Groups,
                                                  to = featInfo$PG.Genes,
                                                  warn_missing = F))

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Follow-up plasma proteomics')

# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$PG.Groups,
                                          to = featInfo$PG.Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$PG.Groups,
                                                                   to = featInfo$PG.Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Follow-up plasma proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC9, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Follow-up plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC9$Feature[1:20]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Follow-up plasma proteomics - PC9')

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC9, Gene = plyr::mapvalues(Feature,
                                                       from = featInfo$PG.Groups,
                                                       to = featInfo$PG.Genes,
                                                       warn_missing = F))
```

## Changes in time course
Follow-up matrix - baseline matrix\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset baseline samples
smpBaseIdx <- which(colData(proPlasmaNorm)$Condition == 'Baseline')
proBase <- proPlasmaNorm[, smpBaseIdx]
# Subset follow-up samples
smpFoloIdx <- which(colData(proPlasmaNorm)$Condition != 'Baseline')
proFolo <- proPlasmaNorm[, smpFoloIdx]
# Modify sample names for matching two datasets
colnames(proBase) <- stringr::str_remove(colnames(proBase), '_P_B')
colnames(proFolo) <- stringr::str_remove(colnames(proFolo), '_P_R')
# Retrieve data matrix
proBaseMat <- SummarizedExperiment::assay(proBase)
proFoloMat <- SummarizedExperiment::assay(proFolo)
# Subtract follow-up matrix by baseline matrix
# if (identical(colnames(proBaseMat), colnames(proFoloMat)) &
#     identical(rownames(proBaseMat), rownames(proFoloMat))) {
#   proDiffMat <- proFoloMat - proBaseMat
# } else {
#   print('Align samples or features first.')
# }
#### Manually align samples ####
if (identical(sort(colnames(proBaseMat)), sort(colnames(proFoloMat)))) {
  smpOrder <- sort(colnames(proBaseMat))
  # For computing difference between Tumor and Normal samples
  proBaseMat <- proBaseMat[, smpOrder]
  proFoloMat <- proFoloMat[, smpOrder]
  proDiffMat <- proFoloMat - proBaseMat
  # For Creating SE object
  proBase <- proBase[, smpOrder]
  proFolo <- proFolo[, smpOrder]
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(proBase)), Patient, Recurrence)
rowAnno <- as.data.frame(rowData(proBase))
proDiff <- SummarizedExperiment(assays = proDiffMat, colData = colAnno,
                                rowData = rowAnno)

# Perform analysis
proPlasmaDiffRes <- SOA(proDiff, fac = 'Recurrence', num_feats = 30)
datMat <- proPlasmaDiffRes$data
smpAnno <- proPlasmaDiffRes$smpMetadata
tFeatSigRes <- proPlasmaDiffRes$tFeatSigRes
tPCASigRes <- proPlasmaDiffRes$tPCASigRes
pcaRes <- proPlasmaDiffRes$pcaRes
pcTab <- proPlasmaDiffRes$pcTab
pcTopFeatTab <- proPlasmaDiffRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$PG.Groups,
                                                  to = featInfo$PG.Genes,
                                                  warn_missing = F))

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = T,
                   scale = 'row', main = 'Differential plasma proteomics')

# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$PG.Groups,
                                          to = featInfo$PG.Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$PG.Groups,
                                                                   to = featInfo$PG.Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)',
       title = 'Differential plasma proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

# Visualize PCs
ggplot(pcTab, aes(x=PC9, y=PC8, col=Recurrence)) +
  geom_point(size = 3) +
  labs(title = 'Differential plasma proteomics') +
  th

# PC9
ggplot(pcTab, aes(x=Recurrence, y=PC9, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC9$Feature[1:10]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential plasma proteomics - PC9')

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC9, Gene = plyr::mapvalues(Feature,
                                                       from = featInfo$PG.Groups,
                                                       to = featInfo$PG.Genes,
                                                       warn_missing = F))

# PC8
ggplot(pcTab, aes(x=Recurrence, y=PC8, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Differential plasma proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC8$Feature[1:10]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Differential plasma proteomics - PC8')

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC8, Gene = plyr::mapvalues(Feature,
                                                       from = featInfo$PG.Groups,
                                                       to = featInfo$PG.Genes,
                                                       warn_missing = F))
```




# Tissue Proteomics
As described in Tissue Metabolomics section, we analyzed Tumor and Normal samples
separately.

```{r}
# Load normalized data
proTissueNorm <- readRDS('./data/AG_Krijgsveld/proTissueNorm.rds')
# Prepare protein-gene table for changing protein names to gene names
featInfo <- tibble::as_tibble(rowData(proTissueNorm), rownames = 'PG.Groups')

# Perform analysis
proTissueRes <- SOA(proTissueNorm, fac = c('Recurrence', 'Condition', 'Gender'))
tPCASigRes <- proTissueRes$tPCASigRes
pcaRes <- proTissueRes$pcaRes
pcTab <- proTissueRes$pcTab

# Display PCs of interest
tPCASigRes

ggplot(pcTab, aes(x=Condition, y=PC1, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tissue proteomics') +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

ggplot(pcTab, aes(x=Recurrence, y=PC18, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)', title = 'Tissue proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Tumor Samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset tumor samples
smpTumorIdx <- which(colData(proTissueNorm)$Condition == 'Tumor')
proTumor <- proTissueNorm[, smpTumorIdx]

# Perform analysis
proTumorRes <- SOA(proTumor, fac = 'Recurrence', num_feats = 30)
datMat <- proTumorRes$data
smpAnno <- proTumorRes$smpMetadata
tFeatSigRes <- proTumorRes$tFeatSigRes
tPCASigRes <- proTumorRes$tPCASigRes
pcaRes <- proTumorRes$pcaRes
pcTab <- proTumorRes$pcTab
pcTopFeatTab <- proTumorRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$PG.Groups,
                                                  to = featInfo$PG.Genes,
                                                  warn_missing = F))

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Tumor Tissue proteomics')

# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$PG.Groups,
                                          to = featInfo$PG.Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$PG.Groups,
                                                                   to = featInfo$PG.Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free_y') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F, size = 4) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
# ggsave('./output/AG_Krijgsveld/boxplot_topSigFeats_TTP.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)', title = 'Tumor tissue proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC14, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Tumor tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC14$Feature[1:30]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Tumor tissue proteomics - PC14')

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC14, Gene = plyr::mapvalues(Feature,
                                                        from = featInfo$PG.Groups,
                                                        to = featInfo$PG.Genes,
                                                        warn_missing = F))
```

## Normal samples

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset normal samples
smpNormalIdx <- which(colData(proTissueNorm)$Condition == 'Normal')
proNormal <- proTissueNorm[, smpNormalIdx]

# Perform analysis
proNormalRes <- SOA(proNormal, fac = 'Recurrence', num_feats = 30)
datMat <- proNormalRes$data
smpAnno <- proNormalRes$smpMetadata
tFeatSigRes <- proNormalRes$tFeatSigRes
tPCASigRes <- proNormalRes$tPCASigRes
pcaRes <- proNormalRes$pcaRes
pcTab <- proNormalRes$pcTab
pcTopFeatTab <- proNormalRes$pcTopFeatTab

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$PG.Groups,
                                                  to = featInfo$PG.Genes,
                                                  warn_missing = F))

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Normal tissue proteomics')

# Visualize data of top 6 significant features
topSigFeats <- tFeatSigRes$Var1[1:6]
topSigFeatData <- tibble::as_tibble(datMat[topSigFeats,], rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Feature = plyr::mapvalues(Feature,
                                          from = featInfo$PG.Groups,
                                          to = featInfo$PG.Genes,
                                          warn_missing = F),
                Feature = factor(Feature, levels = plyr::mapvalues(topSigFeats,
                                                                   from = featInfo$PG.Groups,
                                                                   to = featInfo$PG.Genes,
                                                                   warn_missing = F))) %>%
  dplyr::left_join(smpAnno, by = 'Sample')

ggplot(topSigFeatData, aes(x=Recurrence, y=Abundance, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  facet_wrap(vars(Feature), scales = 'free') +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th + theme(strip.text = element_text(size = 13, face = 'bold'))
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes

# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes$sdev^2 / sum(pcaRes$sdev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)', title = 'Normal tissue proteomics') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

# PC4
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC4, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Normal tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC4$Feature[1:30]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Normal tissue proteomics - PC4')

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC4, Gene = plyr::mapvalues(Feature,
                                                       from = featInfo$PG.Groups,
                                                       to = featInfo$PG.Genes,
                                                       warn_missing = F))

# PC15
# Visualize PCs
ggplot(pcTab, aes(x=Recurrence, y=PC15, col=Recurrence, fill=Recurrence)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  labs(title = 'Normal tissue proteomics') +
  scale_color_manual(values=c('#00BFC4', '#F8766D')) +
  scale_fill_manual(values=c('#00BFC4', '#F8766D')) +
  ggpubr::stat_compare_means(method = 't.test', paired = F, size = 5,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

# Plot molecular signatures in input data
# Extract top features with highest loadings
topFeats <- pcTopFeatTab$PC15$Feature[1:30]
topFeatsIdx <- sapply(topFeats, function(feat) {which(rownames(datMat) == feat)})
# Change protein names to gene names
datMatSub <- datMat[topFeatsIdx, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F,
                   scale = 'row', main = 'Normal tissue proteomics - PC15')

# Display top features with highest loadings of PC of interest
dplyr::mutate(pcTopFeatTab$PC15, Gene = plyr::mapvalues(Feature,
                                                        from = featInfo$PG.Groups,
                                                        to = featInfo$PG.Genes,
                                                        warn_missing = F))
```

## Difference in tissue conditions
Tumor matrix - Normal matrix\

Display significant associations between features (Var1) and cancer recurrence
(Var2) and observe molecular signatures in input data through heatmap. Note that
features in heatmap are ordered by their t-statistics.
```{r}
# Subset Tumor samples
smpTumorIdx <- which(colData(proTissueNorm)$Condition == 'Tumor')
proTumor <- proTissueNorm[, smpTumorIdx]
# Subset Normal samples
smpNormalIdx <- which(colData(proTissueNorm)$Condition == 'Normal')
proNormal <- proTissueNorm[, smpNormalIdx]
# Modify sample names for matching two datasets
colnames(proTumor) <- stringr::str_remove(colnames(proTumor), '_TG')
colnames(proNormal) <- stringr::str_remove(colnames(proNormal), '_NG')
# Retrieve data matrix
proTumorMat <- SummarizedExperiment::assay(proTumor)
proNormalMat <- SummarizedExperiment::assay(proNormal)
# Subtract follow-up matrix by baseline matrix
# if (identical(colnames(proTumorMat), colnames(proNormalMat)) &
#     identical(rownames(proTumorMat), rownames(proNormalMat))) {
#   proDiffMat <- proTumorMat - proNormalMat
# } else {
#   print('Align samples or features first.')
# }
#### Manually align samples ####
if (identical(sort(colnames(proTumorMat)), sort(colnames(proNormalMat)))) {
  smpOrder <- sort(colnames(proTumorMat))
  # For computing difference between Tumor and Normal samples
  proTumorMat <- proTumorMat[, smpOrder]
  proNormalMat <- proNormalMat[, smpOrder]
  proDiffMat <- proTumorMat - proNormalMat
  # For Creating SE object
  proTumor <- proTumor[, smpOrder]
  proNormal <- proNormal[, smpOrder]
}
# Retrieve samples metadata for creating SE object
colAnno <- dplyr::select(as.data.frame(colData(proTumor)), Patient, Recurrence)
rowAnno <- as.data.frame(rowData(proTumor))
proDiff <- SummarizedExperiment(assays = proDiffMat, colData = colAnno,
                                rowData = rowAnno)

# Perform analysis
proTissueDiffRes <- SOA(proDiff, fac = 'Recurrence', num_feats = 30)
datMat <- proTissueDiffRes$data
smpAnno <- proTissueDiffRes$smpMetadata
tFeatSigRes <- proTissueDiffRes$tFeatSigRes
tPCASigRes <- proTissueDiffRes$tPCASigRes
pcaRes <- proTissueDiffRes$pcaRes

# Display features that can significantly separate recurrence and non-recurrence
# patients
dplyr::mutate(tFeatSigRes, Gene = plyr::mapvalues(Var1,
                                                  from = featInfo$PG.Groups,
                                                  to = featInfo$PG.Genes,
                                                  warn_missing = F))

# Plot molecular signatures in input data
# Order features according to t-statistics
featOrder <- dplyr::arrange(tFeatSigRes, dplyr::desc(tStats))$Var1
# Arrange samples to make same groups in same clusters
smpOrder <- c(which(smpAnno$Recurrence == 'No'),
              which(smpAnno$Recurrence == 'Yes'))
# Prepare recurrence table for annotating samples in heatmap
smpRecur <- dplyr::select(smpAnno, Sample, Recurrence) %>%
  tibble::column_to_rownames('Sample')
# Change protein names to gene names
datMatSub <- datMat[featOrder, smpOrder]
rownames(datMatSub) <- plyr::mapvalues(rownames(datMatSub),
                                       from = featInfo$PG.Groups,
                                       to = featInfo$PG.Genes,
                                       warn_missing = F)
pheatmap::pheatmap(datMatSub,
                   annotation_col = smpRecur,
                   color = colorRampPalette(c('navy', 'white', 'red'))(100),
                   cluster_rows = F, cluster_cols = F, show_rownames = F,
                   scale = 'row', main = 'Differential plasma proteomics')
```

Display significant associations between PCs (Var1) and cancer recurrence (Var2)
```{r}
# Display PCs that can significantly separate recurrence and non-recurrence
# patients
tPCASigRes
```




# Summary

Display proportion of significant features in each dataset in terms of separating
cancer recurrence and non-recurrence patient groups. Plasma and Tissue Metabolomics
has 630 features, Plasma Proteomics has 435 features, and Tissue Proteomics has
5193 features.
```{r}
# Barplot about proportion of significant features in each dataset
# Compute proportion of significant features
metaBaseSigFeats <- nrow(metaBaseRes$tFeatSigRes) / nrow(metaBaseRes$data) * 100
metaFoloSigFeats <- nrow(metaFoloRes$tFeatSigRes) / nrow(metaFoloRes$data) * 100
# metaPlasmaDiffSigFeats <- nrow(metaPlasmaDiffRes$tFeatSigRes) / nrow(metaPlasmaDiffRes$data) * 100
proBaseSigFeats <- nrow(proBaseRes$tFeatSigRes) / nrow(proBaseRes$data) * 100
proFoloSigFeats <- nrow(proFoloRes$tFeatSigRes) / nrow(proFoloRes$data) * 100
# proPlasmaDiffSigFeats <- nrow(proPlasmaDiffRes$tFeatSigRes) / nrow(proPlasmaDiffRes$data) * 100
metaTumorSigFeats <- nrow(metaTumorRes$tFeatSigRes) / nrow(metaTumorRes$data) * 100
metaNormalSigFeats <- nrow(metaNormalRes$tFeatSigRes) / nrow(metaNormalRes$data) * 100
# metaTissueDiffSigFeats <- nrow(metaTissueDiffRes$tFeatSigRes) / nrow(metaTissueDiffRes$data) * 100
proTumorSigFeats <- nrow(proTumorRes$tFeatSigRes) / nrow(proTumorRes$data) * 100
proNormalSigFeats <- nrow(proNormalRes$tFeatSigRes) / nrow(proNormalRes$data) * 100
# proTissueDiffSigFeats <- nrow(proTissueDiffRes$tFeatSigRes) /nrow(proTissueDiffRes$data) * 100

# Prepare needed information for barplot
dat <- rev(c('Baseline Plasma Metabolomics', 'Follow-up Plasma Metabolomics',#'Differential Plasma Metabolomics',
             'Baseline Plasma Proteomics', 'Follow-up Plasma Proteomics',#'Differential Plasma Proteomics',
             'Tumor Tissue Metabolomics', 'Normal Tissue Metabolomics',#'Differential Tissue Metabolomics',
             'Tumor Tissue Proteomics', 'Normal Tissue Proteomics'))#,'Differential Tissue Proteomics'
datModal <- rev(c(rep('Plasma Metabolomics', 2), rep('Plasma Proteomics', 2),
                  rep('Tissue Metabolomics', 2), rep('Tissue Proteomics', 2)))
proportion <- rev(c(metaBaseSigFeats, metaFoloSigFeats, #metaPlasmaDiffSigFeats,
                    proBaseSigFeats, proFoloSigFeats, #proPlasmaDiffSigFeats,
                    metaTumorSigFeats, metaNormalSigFeats, #metaTissueDiffSigFeats,
                    proTumorSigFeats, proNormalSigFeats)) #,proTissueDiffSigFeats
sigFeatPropTab <- data.frame(Data = factor(dat, levels = dat),
                             Data_modality = datModal,
                             Proportion = proportion)

ggplot(sigFeatPropTab, aes(x=Data, y=Proportion, fill=Data_modality)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  labs(y = 'Percentage (%)',
       title = 'Proportion of Cancer Recurrence-Related Features') +
  scale_fill_discrete(name = 'Data modality') +
  th + theme(title = element_text(size = 11))
```
1. All sorts of datasets in this script provide information for predicting patient
cancer recurrence and the PCA models built on them have more or less similar performance.
If I must pick one most impressive, I would say Targeted (Tumor and Differential)
Tissue Metabolomics from AG Hell is a little bit more surprising. Targeted Plasma
and Tissue Metabolomics contains the same feature list and Plasma even results in
more significant features, but Tissue can somehow slightly better predict cancer
recurrences. It might be that Tissue Metabolomics has fewer but more robust
Recurrence-related features.\
2. Overall, Plasma datasets got higher proportions of Recurrence-related features
than Tissue when they have the same feature list (Metabolomics) or even Tissue have
much larger feature space (Proteomics). Hence, Plasma samples seem to be more informative
and Tissue samples are more noisy. Yet, since Targeted and DDA methods are biased
(and sample size is very small), these hypotheses have to be validated by unbiased
methods, like Untargeted (please check analysis results of the data from AG Hopf)
and DIA.
<br/>
<br/>

Visualize Recurrence-related features through volcano plots. Log2-FC (up and down)
is recurrence to non-recurrence groups. To be clearer, entities on up side are more
abundant in recurrence group than non-recurrence group, and so forth.
```{r message = F}
# Prepare protein-gene table for annotations
proPlasmaFeatInfo <- tibble::as_tibble(rowData(proPlasmaNorm), rownames = 'PG.Groups')
proTissueFeatInfo <- tibble::as_tibble(rowData(proTissueNorm), rownames = 'PG.Groups')

# Compute log2(FC)
# PM
metaPlasmaMedi <- readRDS('./data/AG_Hell/metaPlasmaMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPM
metaBaseLogFC <- dplyr::filter(metaPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPM
metaFoloLogFC <- dplyr::filter(metaPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TM
metaTissueMedi <- readRDS('./data/AG_Hell/metaTissueMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTM
metaTumorLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTM
metaNormalLogFC <- dplyr::filter(metaTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# PP
proPlasmaMedi <- readRDS('./data/AG_Krijgsveld/proPlasmaMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# BPP
proBaseLogFC <- dplyr::filter(proPlasmaMedi, Condition == 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# FPP
proFoloLogFC <- dplyr::filter(proPlasmaMedi, Condition != 'Baseline') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# TP
proTissueMedi <- readRDS('./data/AG_Krijgsveld/proTissueMedi.rds') %>%
  summExp2df(assay = 'mediAbundance', row_id = 'Feature', col_id = 'Sample') %>%
  dplyr::select(Feature, Value, Condition, Recurrence)
# TTP
proTumorLogFC <- dplyr::filter(proTissueMedi, Condition == 'Tumor') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)
# NTP
proNormalLogFC <- dplyr::filter(proTissueMedi, Condition == 'Normal') %>%
  dplyr::group_by(Feature, Recurrence) %>%
  dplyr::summarise(Mean = mean(Value, na.rm = T)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = 'Recurrence', values_from = 'Mean') %>%
  dplyr::mutate(logFC = Yes - No) %>%
  dplyr::select(Feature, logFC)

# Collect all needed information for volcano plots
# BPM
metaBaseVolTab <- dplyr::select(metaBaseRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaBaseLogFC, by = 'Feature')
# FPM
metaFoloVolTab <- dplyr::select(metaFoloRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaFoloLogFC, by = 'Feature')
# TTM
metaTumorVolTab <- dplyr::select(metaTumorRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaTumorLogFC, by = 'Feature')
# NTM
metaNormalVolTab <- dplyr::select(metaNormalRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(metaNormalLogFC, by = 'Feature')
# BPP
proBaseVolTab <- dplyr::select(proBaseRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proBaseLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proPlasmaFeatInfo$PG.Groups,
                                       to = proPlasmaFeatInfo$PG.Genes,
                                       warn_missing = F))
# FPP
proFoloVolTab <- dplyr::select(proFoloRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proFoloLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proPlasmaFeatInfo$PG.Groups,
                                       to = proPlasmaFeatInfo$PG.Genes,
                                       warn_missing = F))
# TTP
proTumorVolTab <- dplyr::select(proTumorRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proTumorLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proTissueFeatInfo$PG.Groups,
                                       to = proTissueFeatInfo$PG.Genes,
                                       warn_missing = F))
# NTP
proNormalVolTab <- dplyr::select(proNormalRes$tFeatRes, Var1, pVal) %>%
  dplyr::rename(Feature = Var1) %>%
  dplyr::left_join(proNormalLogFC, by = 'Feature') %>%
  dplyr::mutate(Gene = plyr::mapvalues(Feature,
                                       from = proTissueFeatInfo$PG.Groups,
                                       to = proTissueFeatInfo$PG.Genes,
                                       warn_missing = F))
```

Log2-FC cutoffs are 0.55 (FC=1.46) and -0.55 (FC=0.68).
```{r}
# BPM
volTab <- metaBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.55] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.55] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Feature[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.55, 0.55), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Metabolomics') +
  th
```

Log2-FC cutoffs are 0.6 (FC=1.52) and -0.6 (FC=0.66).
```{r}
# FPM
volTab <- metaFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.6] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.6] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Feature[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.6, 0.6), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Metabolomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# TTM
volTab <- metaTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Feature[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 5, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Metabolomics') +
  th + theme(axis.title = element_text(size = 26), axis.text = element_text(size = 20),
             legend.title = element_text(size = 22), legend.text = element_text(size = 22)) +
  scale_x_continuous(breaks = c(-4, -3, -2, -1, 0, 1, 2, 3))
# ggsave('./output/AG_Hell/volcano_TTM.png', device = 'png', dpi = 400, height = 8, width = 10)
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# NTM
volTab <- metaNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Feature[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Metabolomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# BPP
volTab <- proBaseVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Baseline Plasma Proteomics') +
  th
```

Log2-FC cutoffs are 0.5 (FC=1.41) and -0.5 (FC=0.71).
```{r}
# FPP
volTab <- proFoloVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.5] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.5] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.5, 0.5), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Follow-up Plasma Proteomics') +
  th
```

Log2-FC cutoffs are 0.8 (FC=1.74) and -0.8 (FC=0.57).
```{r}
# TTP
volTab <- proTumorVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.8] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.8] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.8, 0.8), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Tumor Tissue Proteomics') +
  th
```

Log2-FC cutoffs are 0.7 (FC=1.62) and -0.7 (FC=0.62).
```{r}
# NTP
volTab <- proNormalVolTab
volTab['DE'] <- 'Not significant'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC > 0.7] <- 'Up'
volTab$DE[volTab$pVal <= 0.05 & volTab$logFC < -0.7] <- 'Down'
volTab['Label'] <- NA
label4SigFeats <- volTab$Gene[volTab$DE != 'Not significant']
volTab$Label[volTab$DE != 'Not significant'] <- label4SigFeats

ggplot(volTab, aes(x=logFC, y=-log10(pVal), col=DE, label=Label)) +
  geom_point(size = 2) +
  geom_hline(yintercept = -log10(0.05), col = 'red', linewidth = 0.4) +
  geom_vline(xintercept = c(-0.7, 0.7), col = 'red', linewidth = 0.4) +
  geom_text_repel(size = 4, show.legend = F) +
  scale_color_manual(values = c('navy', 'grey', 'red')) +
  labs(x = 'log2(FC)', title = 'Normal Tissue Proteomics') +
  th
```




```{r umap-proPlasma, include = F, eval = F}
# UMAP
# UMAP (non-linear method) was performed to see separation of Plasma samples.

## Plasma Proteomics

# UMAP

# Run UMAP to see non-linear relationships between plasma samples
# Plasma proteomics
resUMAP <- umap(t(assay(proPlasmaNorm)))
embedding <- tibble::as_tibble(resUMAP$layout, rownames = 'Sample') %>%
  dplyr::left_join(as_tibble(colData(proPlasmaNorm)), by = 'Sample') %>%
  dplyr::select(-Sample_IDs) %>%
  dplyr::rename(UMAP1 = V1, UMAP2 = V2)
ggplot(embedding, aes(x=UMAP1, y=UMAP2, col=Condition, group=Patient)) +
  geom_point() +
  geom_line(col = 'grey50', linetype = 'dashed') +
  ggtitle('Plasma Proteomics') + theme(plot.title = element_text(hjust = 0.5))
```

```{r pca-proPlasma, include = F, eval = F}
# PCA results for comparisons

# PCA
# Plasma proteomics
exprMat <- assay(proPlasmaNorm)
resPC <- prcomp(t(exprMat), center = T, scale. = F)
proPlasmaNorm4Plot <- as_tibble(resPC$x[, 1:10], rownames = 'Sample') %>%
  dplyr::left_join(as_tibble(colData(proPlasmaNorm)), by = 'Sample')
ggplot(proPlasmaNorm4Plot, aes(x=PC1, y=PC2, col=Condition, group=Patient)) +
  geom_point() +
  geom_line(col = 'grey50', linetype = 'dashed') +
  ggtitle('Plasma Proteomics') +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r umap-metaPlasma, include = F, eval = F}
## Plasma Metabolomics

# UMAP

# Plasma metabolomics
resUMAP <- umap(t(assay(metaPlasmaNorm)))
embedding <- tibble::as_tibble(resUMAP$layout, rownames = 'Sample') %>%
  dplyr::left_join(as_tibble(colData(metaPlasmaNorm), rownames = 'Sample'),
                   by = 'Sample') %>%
  dplyr::rename(UMAP1 = V1, UMAP2 = V2)
ggplot(embedding, aes(x=UMAP1, y=UMAP2, col=Condition, group=Patient)) +
  geom_point() +
  geom_line(col = 'grey50', linetype = 'dashed') +
  ggtitle('Plasma Metabolomics') + theme(plot.title = element_text(hjust = 0.5))
```

```{r pca-metaPlasma, include = F, eval = F}
# PCA results for comparisons

# Plasma metabolomics
exprMat <- assay(metaPlasmaNorm)
sd <- rowSds(exprMat)
# exprMatSub <- exprMat[order(sd, decreasing = TRUE)[1:100],]
resPC <- prcomp(t(exprMat), center = T, scale. = F)
metaPlasmaNorm4Plot <- as_tibble(resPC$x[,1:10], rownames = 'Sample') %>%
  left_join(as_tibble(colData(metaPlasmaNorm), rownames = 'Sample'), by = 'Sample')
ggplot(metaPlasmaNorm4Plot, aes(x=PC1, y=PC2, col=Condition, group=Patient)) +
  geom_point() +
  geom_line(col = 'grey50', linetype = 'dashed') +
  ggtitle('Plasma Metabolomics') +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r include = F, eval = F}
# Tissue proteomics
# resUMAP <- umap(t(assay(proTissueNorm)))
# embedding <- tibble::as_tibble(resUMAP$layout, rownames = 'Sample') %>%
# dplyr::left_join(as_tibble(colData(proTissueNorm)), by = 'Sample') %>%
# dplyr::select(-Sample_IDs) %>%
# dplyr::rename(UMAP1 = V1, UMAP2 = V2)
# ggplot(embedding, aes(x=UMAP1, y=UMAP2, col=Condition, group=Patient)) +
#   geom_point() +
#   geom_line(col = 'grey50', linetype = 'dashed') +
#   ggtitle('Tissue Proteomics') + theme(plot.title = element_text(hjust = 0.5))

# Tissue metabolomics
# exprMat <- assay(metaTissueNorm)
# exprMat <- exprMat[which(rownames(exprMat) != c('Ala', 'Histamine')),]
# resUMAP <- umap(t(exprMat))
# embedding <- tibble::as_tibble(resUMAP$layout, rownames = 'Sample') %>%
# dplyr::left_join(as_tibble(colData(metaTissueNorm), rownames = 'Sample'), by = 'Sample') %>%
# dplyr::rename(UMAP1 = V1, UMAP2 = V2)
# ggplot(embedding, aes(x=UMAP1, y=UMAP2, col=Condition, group=Patient)) +
#   geom_point() +
#   geom_line(col = 'grey50', linetype = 'dashed') +
#   ggtitle('Tissue Metabolomics') + theme(plot.title = element_text(hjust = 0.5))
```
