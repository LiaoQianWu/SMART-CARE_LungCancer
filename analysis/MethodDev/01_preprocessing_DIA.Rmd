---
title: 'Preprocessing: Method development lung cancer patient cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: yes
    toc_float: yes
    code_folding: hide
---

<font size='4'> Description: Preprocess Plasma and Tissue DIA Proteomics generated
by Karim Aljakouch from AG Krijgsveld, simply including data cleansing and data
normalization (VSN). All needed information of each dataset (2 in total) was then
stored in SummarizedExperiment objects for further analyses.\
Q: All samples from Patient N02PM0LW, FH49U7TY, and F04ERF3M are missing? A: They
were dropped out from study.\

Update: Remove features quantified in less than 2/3 of samples in all sample groups
of interest before conducting VSN.\

Update2: Preprocess Tissue DIA Proteomics generated by AG Klingmüller.\
Q: Samples from Patient D04XHF7F (P05) and E04NMF53 (P19) are missing?\

Update3: Modify feature filtering criterion: Remove features quantified in less
than 2/3 of samples to avoid analysis results that one subgroup is fully missing
since we got a great deal of significant cancer recurrence-related features. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_MethodDev')
```

Load libraries
```{r library loading, message = FALSE}
library('readr')
library('readxl')
library('vsn')
library('visdat')
library('SummarizedExperiment')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))

# List sample annotations to keep in SE objects
anno <- c('Condition', 'Patient', 'Recurrence', 'Gender', 'Age', 'Smoking',
          'Stage', 'Identifier')
```

# Plasma Proteomics (AG Krijgsveld)

```{r message = F}
# Load unprocessed data
proPlasmaTab <- readr::read_tsv('./data/AG_Krijgsveld/20230104_MarcS_Method_Estab_Plasma.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Identifier',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Identifier = stringr::str_remove_all(Identifier, 'D:.*oecf4.*Exploris_|_4\\.raw'))

# Load sample metadata from preprocessed Targeted Metabolomics SE object
smpAnno <- colData(readRDS('./data/AG_Hell/metaPlasmaNorm.rds')) %>%
  tibble::as_tibble(rownames = 'Sample') %>%
  dplyr::mutate(Identifier = stringr::str_remove(Identifier, '_3$'),
                TimePoint = dplyr::case_when(Condition == 'Baseline' ~ 'Bseline',
                                             Condition != 'Baseline' ~ '2 years later'))

# Combine all information into a table
proPlasmaTab <- dplyr::left_join(proPlasmaTab, smpAnno, by = 'Identifier')

# Convert long data to SE object (wide data)
proPlasma <- df2SummExp(proPlasmaTab, row_id = 'Protein.Group', col_id = 'Sample',
                        values = 'Abundance', row_anno = c('Protein.Names', 'Genes'),
                        col_anno = anno)
```

Display dimensions of data (34 samples and 505 features)
```{r}
dim(proPlasma)
```

Display data missingness
```{r}
exprMat <- SummarizedExperiment::assay(proPlasma)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 11, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 13, face = 'bold'),
        legend.text = element_text(size = 12, face = 'bold'))
```

```{r include=F, eval=F}
exprMat <- SummarizedExperiment::assay(proPlasma)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 12, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 22, face = 'bold'),
        legend.text = element_text(size = 22, face = 'bold'))
ggsave('./output/group_meeting/proPlasma_Kri_DIA_missingness.png', device = 'png',
       dpi = 400, height = 8, width = 8)
```

Display distribution of original data
```{r}
ggplot(proPlasmaTab, aes(x=Sample, y=Abundance)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

**Remove features quantified in less than 2/3 of samples for more reliable data normalization**
```{r message=F}
# Remove features quantified in less than 2/3 of samples
rmFeats <- dplyr::group_by(proPlasmaTab, Protein.Group) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Abundance)) / length(Abundance), 2)) %>%
  dplyr::ungroup() %>%
  # Keep proteins observed in less than 2/3 of samples of groups
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::pull(Protein.Group)
proPlasmaTab <- dplyr::filter(proPlasmaTab, !Protein.Group %in% rmFeats)

# Convert long data to SE object
proPlasma <- df2SummExp(proPlasmaTab, row_id = 'Protein.Group', col_id = 'Sample',
                        values = 'Abundance', row_anno = c('Protein.Names', 'Genes'),
                        col_anno = anno)
```

```{r message = F, eval=F}
# Remove features quantified in less than 2/3 of samples in all four sample groups
# of interest (Baseline/Follow-up Recurrence/Non-recurrence) for more reliable data normalization\
# Missing data is more likely to happen in proteins with small abundances due to detection
# limit. Image comparison between two sample groups, certain proteins are highly missing
# in one group and present in the other

# Remove features quantified in less than 2/3 of samples in all sample groups of interest
# Grouping like this since Baseline and Follow-up samples will be analyzed separately
rmFeats <- dplyr::group_by(proPlasmaTab, Protein.Group, TimePoint, Recurrence) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Abundance)) / length(Abundance), 2)) %>%
  dplyr::ungroup() %>%
  # Keep proteins observed in less than 2/3 of samples of groups
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::group_by(Protein.Group) %>%
  dplyr::summarise(Count = length(Protein.Group)) %>%
  # Keep proteins observed in less than 2/3 of samples of all groups
  dplyr::filter(Count == 4) %>%
  dplyr::pull(Protein.Group)
proPlasmaTab <- dplyr::filter(proPlasmaTab, !Protein.Group %in% rmFeats)

# Convert long data to SE object
proPlasma <- df2SummExp(proPlasmaTab, row_id = 'Protein.Group', col_id = 'Sample',
                        values = 'Abundance', row_anno = c('Protein.Names', 'Genes'),
                        col_anno = anno)

# Got 445 features after filtering
```

Display dimensions of filtered data (34 samples and 421 features)
```{r}
dim(proPlasma)
```

Display data missingness
```{r}
exprMat <- SummarizedExperiment::assay(proPlasma)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 11, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 13, face = 'bold'),
        legend.text = element_text(size = 12, face = 'bold'))
```

```{r include=F, eval=F}
exprMat <- SummarizedExperiment::assay(proPlasma)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 12, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 22, face = 'bold'),
        legend.text = element_text(size = 22, face = 'bold'))
ggsave('./output/group_meeting/proPlasma_Kri_DIA_missingness_after_filtering.png',
       device = 'png', dpi = 400, height = 8, width = 8)
```

Display distribution of filtered data
```{r}
ggplot(proPlasmaTab, aes(x=Sample, y=Abundance)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

Perform VSN and display distribution of normalized data
```{r}
# Perform VSN
exprMat <- as.matrix(SummarizedExperiment::assay(proPlasma))
fit <- vsnMatrix(exprMat)
proPlasmaNorm <- proPlasma
SummarizedExperiment::assay(proPlasmaNorm) <- predict(fit, exprMat)

# Save normalized data
# saveRDS(proPlasmaNorm, './data/AG_Krijgsveld/proPlasmaNorm_DIA.rds')

# Convert SE object to long data for plotting
proPlasmaTabNorm <- summExp2df(proPlasmaNorm, assay = 'Abundance',
                               row_id = 'Protein.Group', col_id = 'Sample')

ggplot(proPlasmaTabNorm, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(y = 'Normalized protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r eval=F}
# Store median normalized data for computing log2(FC)
exprMat <- as.matrix(assay(proPlasma))
sampleAnno <- tibble::as_tibble(colData(proPlasma), rownames = 'Sample')
featAnno <- tibble::as_tibble(rowData(proPlasma), rownames = 'Feature')
proPlasmaMediTab <- limma::normalizeBetweenArrays(exprMat, method = 'scale') %>%
  tibble::as_tibble(rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample',
                      values_to = 'mediAbundance') %>%
  dplyr::mutate(mediAbundance = log2(mediAbundance)) %>%
  dplyr::left_join(sampleAnno, by = 'Sample') %>%
  dplyr::left_join(featAnno, by = 'Feature')

ggplot(proPlasmaMediTab, aes(x=Sample, y=mediAbundance)) +
  geom_boxplot() +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

proPlasmaMedi <- df2SummExp(proPlasmaMediTab, row_id = 'Feature', col_id = 'Sample',
                            values = 'mediAbundance', row_anno = c('Protein.Names', 'Genes'),
                            col_anno = anno)
# saveRDS(proPlasmaMedi, './data/AG_Krijgsveld/proPlasmaMedi_DIA.rds')
```




# Tissue Proteomics (AG Krijgsveld)

```{r message = F}
# Load unprocessed data
proTissueTab <- readr::read_tsv('./data/AG_Krijgsveld/20230104_MarcS_Method_Estab_Tissue.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Identifier',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Identifier = stringr::str_remove_all(Identifier, 'D:.*oecf4.*Exploris_|_4\\.raw'))

# Load sample metadata from preprocessed Targeted Metabolomics SE object
smpAnno <- colData(readRDS('./data/AG_Hell/metaTissueNorm.rds')) %>%
  tibble::as_tibble(rownames = 'Sample') %>%
  dplyr::mutate(Identifier = stringr::str_remove(Identifier, '_3$'))

# Combine all information into a table
proTissueTab <- dplyr::left_join(proTissueTab, smpAnno, by = 'Identifier')

# Convert long data to SE object (wide data)
proTissue <- df2SummExp(proTissueTab, row_id = 'Protein.Group', col_id = 'Sample',
                        values = 'Abundance', row_anno = c('Protein.Names', 'Genes'),
                        col_anno = anno)
```

Display dimensions of data (34 samples and 6929 features)
```{r}
dim(proTissue)
```

Display data missingness
```{r}
exprMat <- SummarizedExperiment::assay(proTissue)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 11, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 13, face = 'bold'),
        legend.text = element_text(size = 12, face = 'bold'))
```

```{r include=F, eval=F}
exprMat <- SummarizedExperiment::assay(proTissue)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 12, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 22, face = 'bold'),
        legend.text = element_text(size = 22, face = 'bold'))
ggsave('./output/group_meeting/proTissue_Kri_DIA_missingness.png', device = 'png',
       dpi = 400, height = 8, width = 8)
```

Display distribution of original data
```{r}
ggplot(proTissueTab, aes(x=Sample, y=Abundance)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

**Remove features quantified in less than 2/3 of samples for more reliable data normalization**
```{r message=F}
# Remove features quantified in less than 2/3 of samples
rmFeats <- dplyr::group_by(proTissueTab, Protein.Group) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Abundance)) / length(Abundance), 2)) %>%
  dplyr::ungroup() %>%
  # Keep proteins observed in less than 2/3 of samples of groups
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::pull(Protein.Group)
proTissueTab <- dplyr::filter(proTissueTab, !Protein.Group %in% rmFeats)

# Convert long data to SE object
proTissue <- df2SummExp(proTissueTab, row_id = 'Protein.Group', col_id = 'Sample',
                        values = 'Abundance', row_anno = c('Protein.Names', 'Genes'),
                        col_anno = anno)
```

```{r message = F, eval=F}
# Remove features quantified in less than 2/3 of samples in all four sample groups
# of interest (Normal/Tumor Recurrence/Non-recurrence) for more reliable data normalization

# Remove features quantified in less than 2/3 of samples in all sample groups of interest
rmFeats <- dplyr::group_by(proTissueTab, Protein.Group, Condition, Recurrence) %>%
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Abundance)) / length(Abundance), 2)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::group_by(Protein.Group) %>%
  dplyr::summarise(Count = length(Protein.Group)) %>%
  dplyr::filter(Count == 4) %>%
  dplyr::pull(Protein.Group)
proTissueTab <- dplyr::filter(proTissueTab, !Protein.Group %in% rmFeats)

# Convert long data to SE object
proTissue <- df2SummExp(proTissueTab, row_id = 'Protein.Group', col_id = 'Sample',
                        values = 'Abundance', row_anno = c('Protein.Names', 'Genes'),
                        col_anno = anno)

# Got 5658 features after filtering
```

Display dimensions of filtered data (34 samples and 5057 features)
```{r}
dim(proTissue)
```

Display data missingness
```{r}
exprMat <- SummarizedExperiment::assay(proTissue)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 11, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 13, face = 'bold'),
        legend.text = element_text(size = 12, face = 'bold'))
```

```{r include=F, eval=F}
exprMat <- SummarizedExperiment::assay(proTissue)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 12, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 22, face = 'bold'),
        legend.text = element_text(size = 22, face = 'bold'))
ggsave('./output/group_meeting/proTissue_Kri_DIA_missingness_after_filtering.png',
       device = 'png', dpi = 400, height = 8, width = 8)
```

Display distribution of filtered data
```{r}
ggplot(proTissueTab, aes(x=Sample, y=Abundance)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

Perform VSN and display distribution of normalized data
```{r}
# Perform VSN
exprMat <- as.matrix(SummarizedExperiment::assay(proTissue))
fit <- vsnMatrix(exprMat)
proTissueNorm <- proTissue
SummarizedExperiment::assay(proTissueNorm) <- predict(fit, exprMat)

# Save normalized data
# saveRDS(proTissueNorm, './data/AG_Krijgsveld/proTissueNorm_DIA.rds')

# Convert SE object to long data for plotting
proTissueTabNorm <- summExp2df(proTissueNorm, assay = 'Abundance',
                               row_id = 'Protein.Group', col_id = 'Sample')

ggplot(proTissueTabNorm, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(y = 'Normalized protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r eval=F}
# Store median normalized data for computing log2(FC)
exprMat <- as.matrix(assay(proTissue))
sampleAnno <- tibble::as_tibble(colData(proTissue), rownames = 'Sample')
featAnno <- tibble::as_tibble(rowData(proTissue), rownames = 'Feature')
proTissueMediTab <- limma::normalizeBetweenArrays(exprMat, method = 'scale') %>%
  tibble::as_tibble(rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample',
                      values_to = 'mediAbundance') %>%
  dplyr::mutate(mediAbundance = log2(mediAbundance)) %>%
  dplyr::left_join(sampleAnno, by = 'Sample') %>%
  dplyr::left_join(featAnno, by = 'Feature')

ggplot(proTissueMediTab, aes(x=Sample, y=mediAbundance)) +
  geom_boxplot() +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

proTissueMedi <- df2SummExp(proTissueMediTab, row_id = 'Feature', col_id = 'Sample',
                            values = 'mediAbundance', row_anno = c('Protein.Names', 'Genes'),
                            col_anno = anno)
# saveRDS(proTissueMedi, './data/AG_Krijgsveld/proTissueMedi_DIA.rds')
```




# Tissue Proteomics (AG Klingmüller)

```{r message = F}
# Load data
proTissueTab_Klin <- readr::read_tsv('./data/AG_Klingmuller/20230309_103228_SmartCare_TumorFree_Tumor_Yang001_Report.tsv') %>%
  dplyr::select(-c(PG.ProteinDescriptions, contains('PG.NrOfPrecursorsIdentified'),
                   contains('PG.IBAQ'), contains('PG.IsIdentified'))) %>%
  tidyr::pivot_longer(cols = -c('PG.ProteinGroups', 'PG.Genes'),
                      names_to = 'Experiment_ID',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Experiment_ID = stringr::str_remove_all(Experiment_ID, '\\[.*\\] |\\.PG\\.Quantity'),
                Abundance = gsub(',', '\\.', Abundance),
                Abundance = as.numeric(Abundance))
proTissueTab_Klin$Abundance[is.nan(proTissueTab_Klin$Abundance)] <- NA

# Load sample annotations
smpAnno <- readxl::read_excel('./data/AG_Klingmuller/230620_SMART-CARE_overview_OpenBIS_BH.xlsx') %>%
  dplyr::rename(Sample = `Patient ID`, Identifier = `Aliquot ID`, Experiment_ID = `Experimental ID`,
                Condition = `Tissue type`) %>%
  dplyr::mutate(Condition = dplyr::case_when(Condition == 'Normal Tissue' ~ 'Normal',
                                             Condition == 'Tumor Tissue' ~ 'Tumor'),
                Sample = dplyr::case_when(Condition == 'Normal' ~ paste0(Sample, '_NG'),
                                          Condition == 'Tumor' ~ paste0(Sample, '_TG')),
                Patient = stringr::str_remove(Sample, '_.*$'),
                Batch = dplyr::case_when(Batch == 'first' ~ '1', Batch == 'second' ~ '2'))
# Manually correct typo
smpAnno[which(smpAnno$Experiment_ID == 'Recurrence _TumorFree_P21'), 'Experiment_ID'] <- 'Recurrence_TumorFree_P21'
smpAnno[which(smpAnno$Experiment_ID == 'Recurrence _Tumor_P21'), 'Experiment_ID'] <- 'Recurrence_Tumor_P21'

# Load patient metadata
metadataTab <- readr::read_tsv('./data/patient_metadata.tsv') %>%
  dplyr::select(Code, Gender, `Age at diagnosis`, `Smoking status`, `Pathological stage`,
                `Adjuvant chemotherapy`) %>%
  dplyr::rename(Patient = Code, Age = `Age at diagnosis`, Smoking = `Smoking status`,
                Stage = `Pathological stage`, Adjuvant = `Adjuvant chemotherapy`) %>%
  dplyr::filter(Patient %in% smpAnno$Patient) %>%
  dplyr::mutate(Gender = dplyr::case_when(Gender == 'MALE' ~ 'Male',
                                          Gender == 'FEMALE' ~ 'Female'),
                Smoking = dplyr::case_when(Smoking == 'SMOKER' ~ 'Smoker',
                                           Smoking == 'EX-SMOKER' ~ 'Ex-smoker',
                                           Smoking == 'NON-SMOKER' ~ 'Non-smoker'))

# Retrieve patient recurrence information
recurAnno <- readxl::read_excel(
  './data/AG_Hell/Thorax cohort_not-normalized_subset plasma.xlsx', skip = 1) %>%
  filter(!is.na(parents)) %>%
  dplyr::select(c(Individual_ID, Status)) %>%
  dplyr::rename(Patient = 'Individual_ID',
                Condition = 'Status') %>%
  dplyr::filter(Condition != 'BASELINE_SURGERY') %>%
  dplyr::mutate(Recurrence = dplyr::case_when(
    Condition == 'FOLLOW-UP' ~ 'No',
    Condition == 'RECURRENCE' ~ 'Yes'
  )) %>%
  dplyr::select(-Condition)

# Combine all information into a table
smpAnno <- dplyr::left_join(smpAnno, metadataTab, by = 'Patient')
smpAnno <- dplyr::left_join(smpAnno, recurAnno, by = 'Patient')
proTissueTab_Klin <- dplyr::left_join(proTissueTab_Klin, smpAnno, by = 'Experiment_ID') %>%
  dplyr::select(-Experiment_ID)

# Convert long data to SE object (wide data)
proTissue_Klin <- df2SummExp(proTissueTab_Klin, row_id = 'PG.ProteinGroups', col_id = 'Sample',
                             values = 'Abundance', row_anno = c('PG.Genes'),
                             col_anno = c(anno, 'Adjuvant', 'Batch'))
```

Display dimensions of data (78 samples and 9659 features)
```{r}
dim(proTissue_Klin)
```

Display data missingness
```{r}
exprMat <- SummarizedExperiment::assay(proTissue_Klin)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 10, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 13, face = 'bold'),
        legend.text = element_text(size = 12, face = 'bold'))
```

Display distribution of original data
```{r}
ggplot(proTissueTab_Klin, aes(x=Sample, y=Abundance)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Protein abundance') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

**Remove features quantified in less than 2/3 of samples for more reliable data normalization**
```{r message=F}
# Remove features quantified in less than 2/3 of samples
rmFeats <- dplyr::group_by(proTissueTab_Klin, PG.ProteinGroups) %>%
  # Compute proportion of observed data points of each group
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Abundance)) / length(Abundance), 2)) %>%
  dplyr::ungroup() %>%
  # Keep proteins observed in less than 2/3 of samples of groups
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::pull(PG.ProteinGroups)
proTissueTab_Klin <- dplyr::filter(proTissueTab_Klin, !PG.ProteinGroups %in% rmFeats)

# Convert long data to SE object
proTissue_Klin <- df2SummExp(proTissueTab_Klin, row_id = 'PG.ProteinGroups', col_id = 'Sample',
                             values = 'Abundance', row_anno = c('PG.Genes'),
                             col_anno = c(anno, 'Adjuvant', 'Batch'))
```

```{r message = F, eval=F}
# Remove features quantified in less than 2/3 of samples in sample groups of interest (Normal/Tumor)

# Remove features quantified in less than 2/3 of samples in all sample groups of interest
rmFeats <- dplyr::group_by(proTissueTab_Klin, PG.ProteinGroups, Condition) %>%
  dplyr::summarise(frac_nonNA = round(sum(!is.na(Abundance)) / length(Abundance), 2)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(frac_nonNA < 0.67) %>%
  dplyr::group_by(PG.ProteinGroups) %>%
  dplyr::summarise(Count = length(PG.ProteinGroups)) %>%
  dplyr::filter(Count == 2) %>%
  dplyr::pull(PG.ProteinGroups)
proTissueTab_Klin <- dplyr::filter(proTissueTab_Klin, !PG.ProteinGroups %in% rmFeats)

# Convert long data to SE object
proTissue_Klin <- df2SummExp(proTissueTab_Klin, row_id = 'PG.ProteinGroups', col_id = 'Sample',
                             values = 'Abundance', row_anno = c('PG.Genes'),
                             col_anno = c(anno, 'Adjuvant', 'Batch'))

# Got 8257 features after filtering
```

Display dimensions of filtered data (78 samples and 7693 features)
```{r}
dim(proTissue_Klin)
```

Display data missingness
```{r}
exprMat <- SummarizedExperiment::assay(proTissue_Klin)
visdat::vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 10, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 13, face = 'bold'),
        legend.text = element_text(size = 12, face = 'bold'))
```

Display distribution of filtered data
```{r}
ggplot(proTissueTab_Klin, aes(x=Sample, y=Abundance)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Protein abundance') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

Perform VSN and display distribution of normalized data
```{r}
# Perform VSN
exprMat <- as.matrix(SummarizedExperiment::assay(proTissue_Klin))
fit <- vsnMatrix(exprMat)
proTissueNorm_Klin <- proTissue_Klin
SummarizedExperiment::assay(proTissueNorm_Klin) <- predict(fit, exprMat)

# Save normalized data
# saveRDS(proTissueNorm_Klin, './data/AG_Klingmuller/proTissueNorm_DIA.rds')

# Convert SE object to long data for plotting
proTissueTabNorm_Klin <- summExp2df(proTissueNorm_Klin, assay = 'Abundance',
                                    row_id = 'Feature', col_id = 'Sample')

ggplot(proTissueTabNorm_Klin, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(y = 'Normalized protein abundance') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

Display significant associations between learned PCs (Var1) and tissue conditions or batches (Var2)
```{r}
# Perform PCA
proTissueRes_Klin <- doSOA(proTissueNorm_Klin, meta_var = c('Condition', 'Batch'),
                           pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
pcaRes <- proTissueRes_Klin$pcaRes
pcTab <- proTissueRes_Klin$pcTab

# Display PCs of interest
proTissueRes_Klin$tPCASigRes
```

Display variance explained by each PC
```{r}
# Display proportion of total variance captured by all PCs explained by each PC
varExplained <- pcaRes@sDev^2 / sum(pcaRes@sDev^2)
PC <- paste0('PC', seq(length(varExplained)))
varTab <- data.frame(PC = factor(PC, levels = PC),
                     Var_explained = varExplained)
ggplot(varTab, aes(x=PC, y=Var_explained*100)) +
  geom_col() +
  labs(x = '', y = 'Variance explained (%)') +
  th + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

Visualize some significant PCs\

Outlier in Tumor group is Patient I0HVOL
```{r}
ggplot(pcTab, aes(x=Condition, y=PC1, col=Condition, fill=Condition)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

ggplot(pcTab, aes(x=Batch, y=PC8, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

ggplot(pcTab, aes(x=Batch, y=PC2, col=Batch, fill=Batch)) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.2), size = 2, show.legend = F) +
  ggpubr::stat_compare_means(method = 't.test', paired = F,
                             method.args = list(var.equal = T),
                             show.legend = F) +
  th

ggplot(pcTab, aes(x=PC2, y=PC8, col=Batch, group=Patient)) +
  geom_point(size = 4) +
  geom_line(col = 'grey50', linetype = 'dashed') +
  th
```
=> There is slight batch effect between Method Development and Discovery samples.
However, for current data analysis (single- and multi-omics), Discovery samples
are excluded, so batch correction is not going to be performed yet.

```{r eval=F}
# Store median normalized data for computing log2(FC)
exprMat <- as.matrix(assay(proTissue_Klin))
sampleAnno <- tibble::as_tibble(colData(proTissue_Klin), rownames = 'Sample')
featAnno <- tibble::as_tibble(rowData(proTissue_Klin), rownames = 'Feature')
proTissueMediTab_Klin <- limma::normalizeBetweenArrays(exprMat, method = 'scale') %>%
  tibble::as_tibble(rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample',
                      values_to = 'mediAbundance') %>%
  dplyr::mutate(mediAbundance = log2(mediAbundance)) %>%
  dplyr::left_join(sampleAnno, by = 'Sample') %>%
  dplyr::left_join(featAnno, by = 'Feature')

ggplot(proTissueMediTab_Klin, aes(x=Sample, y=mediAbundance)) +
  geom_boxplot() +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

proTissueMedi_Klin <- df2SummExp(proTissueMediTab_Klin, row_id = 'Feature', col_id = 'Sample',
                                 values = 'mediAbundance', row_anno = c('PG.Genes'),
                                 col_anno = c(anno, 'Adjuvant', 'Batch'))
# saveRDS(proTissueMedi_Klin, './data/AG_Klingmuller/proTissueMedi_DIA.rds')
```
