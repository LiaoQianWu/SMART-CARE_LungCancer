---
title: 'Preprocessing: Method development lung cancer patient cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: yes
    toc_float: yes
    code_folding: hide
---

<font size='4'> Description: Preprocess Plasma and Tissue DIA Proteomics generated
by Karim Aljakouch from AG Krijgsveld, simply including data cleansing and data
normalization (VSN). All needed information of each dataset (2 in total) was then
stored in SummarizedExperiment objects for further analyses.\
Q: All samples from Patient N02PM0LW, FH49U7TY, and F04ERF3M are missing. </font>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer_MethodDev')
```

Load libraries
```{r library loading, message = FALSE}
library('readr')
library('vsn')
library('visdat')
library('SummarizedExperiment')
library('tidyverse')
# Load user-defined functions
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

# Plasma Proteomics

```{r message = F}
# Load unprocessed data
proPlasmaTab <- readr::read_tsv('./data/AG_Krijgsveld/20230104_MarcS_Method_Estab_Plasma.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Identifier',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Identifier = stringr::str_remove_all(Identifier, 'D:.*oecf4.*Exploris_|_4\\.raw'))

# Load sample metadata from preprocessed Targeted Metabolomics SE object
smpAnno <- colData(readRDS('./data/AG_Hell/metaPlasmaNorm.rds')) %>%
  tibble::as_tibble(rownames = 'Sample') %>%
  dplyr::mutate(Identifier = stringr::str_remove(Identifier, '_3$'))

# Combine all information into a table
proPlasmaTab <- dplyr::left_join(proPlasmaTab, smpAnno, by = 'Identifier')

# Convert long data to SE object (wide data)
proPlasma <- df2SummExp(proPlasmaTab, row_id = 'Protein.Group', col_id = 'Sample',
                        values = 'Abundance', row_anno = c('Protein.Names', 'Genes'),
                        col_anno = c('Condition', 'Patient', 'Recurrence', 'Gender',
                                     'Smoking', 'Stage', 'Identifier'))
```

Display dimensions of data (34 samples and 505 features)
```{r}
dim(proPlasma)
```

Display distribution of original data
```{r}
ggplot(proPlasmaTab, aes(x=Sample, y=Abundance)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

Display data missingness
```{r}
exprMat <- SummarizedExperiment::assay(proPlasma)
vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 11, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 13, face = 'bold'),
        legend.text = element_text(size = 12, face = 'bold'))
```

Perform VSN and display distribution of normalized data
```{r}
# Perform VSN
exprMat <- as.matrix(SummarizedExperiment::assay(proPlasma))
fit <- vsnMatrix(exprMat)
proPlasmaNorm <- proPlasma
SummarizedExperiment::assay(proPlasmaNorm) <- predict(fit, exprMat)

# Save normalized data
# saveRDS(proPlasmaNorm, './data/AG_Krijgsveld/proPlasmaNorm_DIA.rds')

# Convert SE object to long data for plotting
proPlasmaTabNorm <- summExp2df(proPlasmaNorm, assay = 'Abundance',
                               row_id = 'Protein.Group', col_id = 'Sample')

ggplot(proPlasmaTabNorm, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(y = 'Normalized protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r eval = F}
# Store median normalized data for computing log2(FC)
exprMat <- as.matrix(assay(proPlasma))
sampleAnno <- tibble::as_tibble(colData(proPlasma), rownames = 'Sample')
featAnno <- tibble::as_tibble(rowData(proPlasma), rownames = 'Feature')
proPlasmaMediTab <- limma::normalizeBetweenArrays(exprMat, method = 'scale') %>%
  tibble::as_tibble(rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample',
                      values_to = 'mediAbundance') %>%
  dplyr::mutate(mediAbundance = log2(mediAbundance)) %>%
  dplyr::left_join(sampleAnno, by = 'Sample') %>%
  dplyr::left_join(featAnno, by = 'Feature')

ggplot(proPlasmaMediTab, aes(x=Sample, y=mediAbundance)) +
  geom_boxplot() +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

proPlasmaMedi <- df2SummExp(proPlasmaMediTab, row_id = 'Feature', col_id = 'Sample',
                            values = 'mediAbundance', row_anno = c('Protein.Names', 'Genes'),
                            col_anno = c('Condition', 'Patient', 'Recurrence', 'Gender',
                                         'Smoking', 'Stage', 'Identifier'))
# saveRDS(proPlasmaMedi, './data/AG_Krijgsveld/proPlasmaMedi_DIA.rds')
```




# Tissue Proteomics

```{r message = F}
# Load unprocessed data
proTissueTab <- readr::read_tsv('./data/AG_Krijgsveld/20230104_MarcS_Method_Estab_Tissue.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Identifier',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Identifier = stringr::str_remove_all(Identifier, 'D:.*oecf4.*Exploris_|_4\\.raw'))

# Load sample metadata from preprocessed Targeted Metabolomics SE object
smpAnno <- colData(readRDS('./data/AG_Hell/metaTissueNorm.rds')) %>%
  tibble::as_tibble(rownames = 'Sample') %>%
  dplyr::mutate(Identifier = stringr::str_remove(Identifier, '_3$'))

# Combine all information into a table
proTissueTab <- dplyr::left_join(proTissueTab, smpAnno, by = 'Identifier')

# Convert long data to SE object (wide data)
proTissue <- df2SummExp(proTissueTab, row_id = 'Protein.Group', col_id = 'Sample',
                        values = 'Abundance', row_anno = c('Protein.Names', 'Genes'),
                        col_anno = c('Condition', 'Patient', 'Recurrence', 'Gender',
                                     'Smoking', 'Stage', 'Identifier'))
```

Display dimensions of data (34 samples and 6929 features)
```{r}
dim(proTissue)
```

Display distribution of original data
```{r}
ggplot(proTissueTab, aes(x=Sample, y=Abundance)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = 'Protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

Display data missingness
```{r}
exprMat <- SummarizedExperiment::assay(proTissue)
vis_miss(exprMat, cluster = T, sort_miss = T) +
  labs(y = 'Features') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0, size = 11, face = 'bold'),
        axis.text.y = element_blank(),
        axis.title.y = element_text(size = 13, face = 'bold'),
        legend.text = element_text(size = 12, face = 'bold'))
```

Perform VSN and display distribution of normalized data
```{r}
# Perform VSN
exprMat <- as.matrix(SummarizedExperiment::assay(proTissue))
fit <- vsnMatrix(exprMat)
proTissueNorm <- proTissue
SummarizedExperiment::assay(proTissueNorm) <- predict(fit, exprMat)

# Save normalized data
# saveRDS(proTissueNorm, './data/AG_Krijgsveld/proTissueNorm_DIA.rds')

# Convert SE object to long data for plotting
proTissueTabNorm <- summExp2df(proTissueNorm, assay = 'Abundance',
                               row_id = 'Protein.Group', col_id = 'Sample')

ggplot(proTissueTabNorm, aes(x=Sample, y=Value)) +
  geom_boxplot() +
  labs(y = 'Normalized protein abundance') +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r eval = F}
# Store median normalized data for computing log2(FC)
exprMat <- as.matrix(assay(proTissue))
sampleAnno <- tibble::as_tibble(colData(proTissue), rownames = 'Sample')
featAnno <- tibble::as_tibble(rowData(proTissue), rownames = 'Feature')
proTissueMediTab <- limma::normalizeBetweenArrays(exprMat, method = 'scale') %>%
  tibble::as_tibble(rownames = 'Feature') %>%
  tidyr::pivot_longer(cols = -'Feature',
                      names_to = 'Sample',
                      values_to = 'mediAbundance') %>%
  dplyr::mutate(mediAbundance = log2(mediAbundance)) %>%
  dplyr::left_join(sampleAnno, by = 'Sample') %>%
  dplyr::left_join(featAnno, by = 'Feature')

ggplot(proTissueMediTab, aes(x=Sample, y=mediAbundance)) +
  geom_boxplot() +
  th + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

proTissueMedi <- df2SummExp(proTissueMediTab, row_id = 'Feature', col_id = 'Sample',
                            values = 'mediAbundance', row_anno = c('Protein.Names', 'Genes'),
                            col_anno = c('Condition', 'Patient', 'Recurrence', 'Gender',
                                         'Smoking', 'Stage', 'Identifier'))
# saveRDS(proTissueMedi, './data/AG_Krijgsveld/proTissueMedi_DIA.rds')
```




# Protein abundance comparisons
Plasma vs Tissue:\
Compare overall protein abundance between Plasma and Tissue samples
```{r}
# Load normalized data
proPlasmaNorm <- readRDS('./data/AG_Krijgsveld/proPlasmaNorm_DIA.rds')
proTissueNorm <- readRDS('./data/AG_Krijgsveld/proTissueNorm_DIA.rds')
```

```{r}
# Plasma Proteomics
proPlasmaTabNorm <- summExp2df(proPlasmaNorm, assay = 'Abundance',
                               row_id = 'Protein.Group', col_id = 'Sample') %>%
  dplyr::select(c('Protein.Group', 'Sample', 'Value')) %>%
  dplyr::mutate(Sample = paste0('Plasma_', Sample),
                Sample.Type = 'Plasma')
# Tissue Proteomics
proTissueTabNorm <- summExp2df(proTissueNorm, assay = 'Abundance',
                               row_id = 'Protein.Group', col_id = 'Sample') %>%
  dplyr::select(c('Protein.Group', 'Sample', 'Value')) %>%
  dplyr::mutate(Sample = paste0('Tissue_', Sample),
                Sample.Type = 'Tissue')
# Concatenate two tables
proTab <- rbind(proPlasmaTabNorm, proTissueTabNorm)

ggplot(proTab, aes(x=Sample, y=Value, col=Sample.Type)) +
  geom_boxplot(width = 0.7) +
  labs(y = 'Protein abundance', col = 'Sample type') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```
