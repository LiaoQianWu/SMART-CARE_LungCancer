---
title: 'Preprocessing: DIA Proteomics of Discovery cohort'
author: "Qian-Wu Liao"
output:
  workflowr::wflow_html:
    toc: yes
    toc_float: yes
    code_folding: hide
---

<font size='4'> Description: Preprocess Discovery Tissue and Plasma DIA Proteomics
generated by Karim Aljakouch from AG Krijgsveld, including data cleansing, filtering,
and normalization (VSN). All needed information was then stored in SummarizedExperiment
objects for further analyses.</font>

Q: There is no '1HTNWJ_TU' and got extra Tumor sample '6EY5JO_II_TU'?

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10, warning = F)
knitr::opts_knit$set(root.dir = '/Users/qianwu/Desktop/SMART-CARE_LungCancer')
```

Load libraries
```{r load libraries, message=F}
library(readr)
library(readxl)
library(vsn)
library(limma)
library(visdat)
library(ggrepel)
library(SummarizedExperiment)
library(tidyverse)
# Load user-defined functions
source('./code/analysis_pipeline.R')
source('./code/misc.R')

# Set plot theme
th <- theme_bw(base_size = 15) +
  theme(axis.title = element_text(face = 'bold'),
        axis.text = element_text(face = 'bold'),
        axis.ticks = element_line(linewidth = 0.8),
        legend.text = element_text(size = 15))
```

```{r prepare global info, message=F}
# Load sample metadata
smpMetadat <- readxl::read_excel('./data/sample_metadata.xlsx')
colnames(smpMetadat) <- smpMetadat[3,, drop = F]
smpMetadat <- dplyr::slice(smpMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Parents, Visit, `Material submitted`, `Date and time of collection or surgery`,
                  `SMART-CARE cohort identifier`)) %>%
  dplyr::rename(Sample = Code, Patient = Parents, TimePoint = Visit, SmpType = `Material submitted`,
                Date = `Date and time of collection or surgery`, Cohort = `SMART-CARE cohort identifier`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^SC_T_S_|^SC_DIS_S_|^SC_S_|_P'),
                Patient = stringr::str_remove(Patient, '^/THRX_SPACE/THRX_DB/'),
                TimePoint = dplyr::case_when(TimePoint == 'PRETHERAPEUTIC' ~ 'Baseline',
                                             TimePoint == 'FOLLOW-UP' ~ 'Follow-up',
                                             TimePoint == 'RECURRENCE' ~ 'Recurrence'),
                SmpType = dplyr::case_when(SmpType == 'EDTA_PLASMA' ~ 'Plasma',
                                           SmpType == 'FRESH_FROZEN_TISSUE' ~ 'Tissue'),
                Condition = dplyr::case_when(grepl('_TU|_TG', Sample) ~ 'Tumor',
                                             grepl('_NG', Sample) ~ 'Normal',
                                             !grepl('_TU|_TG|_NG', Sample) ~ TimePoint),
                TimePoint = dplyr::case_when(TimePoint %in% 'Recurrence' ~ 'Follow-up',
                                             !TimePoint %in% 'Recurrence' ~ TimePoint),
                Date = stringr::str_extract(Date, '^\\d+-\\d+-\\d+'),
                Cohort = dplyr::case_when(Cohort == 'DISCOVERY_COHORT' ~ 'Discovery',
                                          Cohort == 'METHOD_DEVELOPMENT_COHORT' ~ 'MethodDev'),
                Date = as.Date(Date, format = '%Y-%m-%d'))

# Load patient metadata
patientMetadat <- readxl::read_excel('./data/patient_metadata.xlsx')
colnames(patientMetadat) <- patientMetadat[3,, drop = F]
patientMetadat <- dplyr::slice(patientMetadat, -c(1:3)) %>%
  dplyr::select(c(Code, Gender, `Age at diagnosis`, `Pathological stage`, `Smoking status`,
                  `Adjuvant chemotherapy`,)) %>%
  dplyr::rename(Patient = Code, Age = `Age at diagnosis`, Stage = `Pathological stage`,
                Smoking = `Smoking status`, Adjuvant = `Adjuvant chemotherapy`) %>%
  dplyr::mutate(Gender = dplyr::case_when(Gender == 'MALE' ~ 'Male',
                                          Gender == 'FEMALE' ~ 'Female'),
                Smoking = dplyr::case_when(Smoking == 'SMOKER' ~ 'Smoker',
                                           Smoking == 'EX-SMOKER' ~ 'Ex-smoker',
                                           Smoking == 'NON-SMOKER' ~ 'Non-smoker'),
                Adjuvant = dplyr::case_when(Adjuvant == 'true' ~ 'True',
                                            Adjuvant == 'false' ~ 'False'),
                Age = as.numeric(Age))
# Include patient recurrence information in patient metadata
recurPats <- dplyr::filter(smpMetadat, Condition == 'Recurrence') %>%
  dplyr::pull(Patient)
patientMetadat <- dplyr::mutate(patientMetadat, Recurrence = dplyr::case_when(Patient %in% recurPats ~ 'Yes',
                                                                              !Patient %in% recurPats ~ 'No'))

# Load aliquot metadata
aliquotMetadat <- readxl::read_excel('./data/aliquot_metadata.xlsx')
colnames(aliquotMetadat) <- aliquotMetadat[3,, drop = F]
aliquotMetadat <- dplyr::slice(aliquotMetadat, -c(1:3)) %>%
  dplyr::select(Code, Parents, `Tumor Cell Content (%)`, `Cohort Identifier`, `Submission to`,
                `Delivered?`) %>%
  dplyr::rename(Aliquot = Code, Sample = Parents, TumorPurity = `Tumor Cell Content (%)`,
                Cohort = `Cohort Identifier`, To = `Submission to`, Delivered = `Delivered?`) %>%
  dplyr::mutate(Sample = stringr::str_remove_all(Sample, '^/THRX_SPACE/THRX_DB/SC_T_S_|_P'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_S_'),
                Sample = stringr::str_remove(Sample, '^/THRX_SPACE/THRX_DB/SC_DIS_'),
                Cohort = dplyr::case_when(Cohort == 'method establishment' ~ 'MethodDev',
                                          Cohort == 'DISCOVERY_COHORT' ~ 'Discovery'),
                TumorPurity = as.numeric(TumorPurity)) %>%
  dplyr::filter(To == 'KRIJGSVELD')
# Prepare tumor purity information
tumorPurityInfo <- dplyr::select(aliquotMetadat, Sample, TumorPurity)

# Combine all needed metadata
summMetadat <- dplyr::left_join(smpMetadat, patientMetadat, by = 'Patient') %>%
  dplyr::left_join(tumorPurityInfo, by = 'Sample')
summMetadat4methodDev <- dplyr::select(aliquotMetadat, Aliquot, Sample, TumorPurity) %>%
  dplyr::left_join(smpMetadat, by = 'Sample') %>%
  dplyr::left_join(patientMetadat, by = 'Patient')

# List sample annotations to keep in SE objects
smpAnno <- c('Patient', 'SmpType', 'TimePoint', 'Date', 'Cohort', 'Condition',
             'Recurrence', 'Gender', 'Age', 'Smoking', 'Stage', 'Adjuvant')
```

# Tissue Proteomics

## Discovery cohort

```{r message=F}
# Load unprocessed data
proTissueTab <- readr::read_tsv('./data/Discovery/AG_Krijgsveld/20230815_MarcS_Discovery_Tissue.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Sample = stringr::str_remove_all(Sample, '^.+SC_A_|^.+SC_DIS_A_|4\\.raw$'))
# Include summarized metadata
# Manually add an extra sample to summarized metadata
tmp_summMetadat <- summMetadat
smp <- summMetadat[summMetadat$Sample == '6EY5JO_TU',]
smp[1, 1] <- '6EY5JO_II_TU'
tmp_summMetadat <- rbind(tmp_summMetadat, smp)
proTissueTab <- dplyr::left_join(proTissueTab, tmp_summMetadat, by = 'Sample')
```

Show dimensions of original data (86 samples and 7986 features)
```{r}
# Preprocess data
proTissue <- doPreprocessing(proTissueTab, feat = 'Protein.Group', smp = 'Sample',
                             val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                             smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = T,
                             cutoff = 0.5, viz_miss = T)#, save_path = './data/Discovery/AG_Krijgsveld/proTissue')
dim(proTissue$ori.data)
```

Show missingness of original data
```{r}
proTissue$ori.data.miss +
  theme(axis.text.x = element_text(size = 10))
```

Show distribution of original data
```{r}
proTissue$ori.data.dist +
  theme(axis.text.x = element_text(size = 10))
```

Show significant associations between data and sample median expressions and missing levels
```{r message=F}
# Normalize unfiltered data
proTissueUnfiltVsn <- doPreprocessing(proTissueTab, feat = 'Protein.Group', smp = 'Sample',
                                      val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                                      smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = F)$vsn.data
# Prepare long data for computing sample median expressions and missing levels
proTissueUnfiltVsnTab <- summExp2df(proTissueUnfiltVsn, assay = 'Abundance',
                                    row_id = 'Protein.Group', col_id = 'Sample') %>%
  # Prepare information of sample median expressions and missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MedianVsnAbun = median(Value, na.rm = T),
                OriMissLevel = sum(is.na(Value)) / length(Value)) %>%
  dplyr::ungroup()
# Create SE object containing information of sample median expressions and missing levels
colAnno <- dplyr::select(proTissueUnfiltVsnTab, Sample, MedianVsnAbun, OriMissLevel) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
proTissueUnfiltVsn <- SummarizedExperiment(assays = list(Abundance = assay(proTissueUnfiltVsn)),
                                           colData = colAnno)

# Do PCA
pcaRes <- doSOA(proTissueUnfiltVsn, meta_var = c('MedianVsnAbun', 'OriMissLevel'),
                pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes
```

**Remove features quantified in less than 1/2 of samples**\
Show dimensions of filtered data (86 samples and 6077 features)
```{r}
dim(proTissue$filt.data)
```

Show missingness of filtered data
```{r}
proTissue$filt.data.miss +
  theme(axis.text.x = element_text(size = 10))
```

**Normalize filtered data by VSN**\
Show distribution of vsn normalized data
```{r}
proTissue$vsn.data.dist +
  theme(axis.text.x = element_text(size = 10))
```

Show feature mean-variance relationship of vsn normalized data
```{r}
proTissue$vsn.feat.mean.var
```

**Do metadata-assisted quality control**
```{r}
# Do single-omics analysis
proTissueSOA <- doSOA(proTissue$vsn.data, meta_var = 'Condition', pca_method = 'ppca',
                      do_onlyPCA = T)
# Prepare labels for samples of interest
pcTab <- proTissueSOA$pcTab %>%
  dplyr::mutate(Label = dplyr::case_when(Sample %in% c('I0HVOL_TU', '7EAOX7_TU',
                                                       'MJMTYR_TU', 'XFKHGP_TU',
                                                       'XFKHGP_NG', 'MJMTYR_NG',
                                                       'I0HVOL_NG', '7EAOX7_NG') ~ Sample))
ggplot(pcTab, aes(x=Condition, y=`PC1 (31.5%)`, col=Condition, fill=Condition, label=Label)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  geom_text_repel(show.legend = F, size = 5) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  labs(x = 'Sample condition') +
  th #+ theme(axis.title = element_text(size = 28),
             # axis.text.x = element_text(size = 24), axis.text.y = element_text(size = 18),
             # legend.title = element_text(size = 26), legend.text = element_text(size = 24))
# ggsave('./output/Discovery/group_meeting/quality_control_pca_Discovery_proTissue_Krij_condi.png',
#        device = 'png', dpi = 400, height = 8, width = 10)
```
=> Tumor purity: I0HVOL_TU - 87% / 7EAOX7_TU - 70% / MJMTYR_TU - 40% / XFKHGP_TU - 100%\
(Mean of sample tumor cell contents is 74%, ranging from 40% to 100%.)

```{r include=F, eval=F}
## Tumor samples
# **Remove features quantified in less than 1/2 of samples**\
# Show dimensions of filtered data (43 samples and 6350 features)
# Subset certain samples
proTumorTab <- dplyr::filter(proTissueTab, Condition == 'Tumor')
# Preprocess data
proTumor <- doPreprocessing(proTumorTab, feat = 'Protein.Group', smp = 'Sample',
                            val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                            smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = T,
                            cutoff = 0.5, viz_miss = T)#, save_path = './data/Discovery/AG_Krijgsveld/proTumor')
dim(proTumor$filt.data)

# Show missingness of filtered data
proTumor$filt.data.miss

# **Normalize filtered data by VSN**\
# Show distribution of vsn normalized data
proTumor$vsn.data.dist

# Show feature mean-variance relationship of vsn normalized data
proTumor$vsn.feat.mean.var


## Normal samples
# **Remove features quantified in less than 1/2 of samples**\
# Show dimensions of filtered data (43 samples and 5778 features)
# Subset certain samples
proNormalTab <- dplyr::filter(proTissueTab, Condition == 'Normal')
# Preprocess data
proNormal <- doPreprocessing(proNormalTab, feat = 'Protein.Group', smp = 'Sample',
                             val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                             smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = T,
                             cutoff = 0.5, viz_miss = T)#, save_path = './data/Discovery/AG_Krijgsveld/proNormal')
dim(proNormal$filt.data)

# Show missingness of filtered data
proNormal$filt.data.miss

# **Normalize filtered data by VSN**\
# Show distribution of vsn normalized data
proNormal$vsn.data.dist

# Show feature mean-variance relationship of vsn normalized data
proNormal$vsn.feat.mean.var
```

## Combined data
Combine Discovery and Method Development cohorts

```{r message=F}
# Prepare long data containing original data and needed information
# Discovery
# Load original data
proTissueTab_Discovery <- readr::read_tsv('./data/Discovery/AG_Krijgsveld/20230815_MarcS_Discovery_Tissue.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Sample = stringr::str_remove_all(Sample, '^.+SC_A_|^.+SC_DIS_A_|4\\.raw$'))
# Include summarized metadata
# Manually add an extra sample to summarized metadata
tmp_summMetadat <- summMetadat
smp <- summMetadat[summMetadat$Sample == '6EY5JO_TU',]
smp[1, 1] <- '6EY5JO_II_TU'
tmp_summMetadat <- rbind(tmp_summMetadat, smp)
proTissueTab_Discovery <- dplyr::left_join(proTissueTab_Discovery, tmp_summMetadat, by = 'Sample')

# MethodDev
# Load and tidy up original data and include summarized metadata into it
proTissueTab_MethodDev <- readr::read_delim('./data/MethodDev/AG_Krijgsveld/20230726_Thorax_Method_Est_tissue.txt') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Aliquot',
                      values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Aliquot = stringr::str_remove_all(Aliquot, '\\.raw$')) %>%
  dplyr::left_join(summMetadat4methodDev, by = 'Aliquot') %>%
  dplyr::select(-Aliquot)

# Extract common features for combining data
featSpace_Discovery <- unique(proTissueTab_Discovery$Protein.Group)
featSpace_MethodDev <- unique(proTissueTab_MethodDev$Protein.Group)
cmnFeats <- intersect(featSpace_Discovery, featSpace_MethodDev)
# Filter common features
proTissueTab_Discovery <- dplyr::filter(proTissueTab_Discovery, Protein.Group %in% cmnFeats)
proTissueTab_MethodDev <- dplyr::filter(proTissueTab_MethodDev, Protein.Group %in% cmnFeats)
# Combine data
proTissueTab_Combined <- dplyr::bind_rows(proTissueTab_Discovery, proTissueTab_MethodDev)

# Preprocess data
proTissue_Combined <- doPreprocessing(proTissueTab_Combined, feat = 'Protein.Group', smp = 'Sample',
                                      val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                                      smpAnno = c(smpAnno, 'TumorPurity'), do_featFilt = T,
                                      cutoff = 0.5, viz_miss = T)#, save_path = './data/Discovery/AG_Krijgsveld/combined_proTissue')
```

Show dimensions of original combined data (126 samples and 7091 common features)
```{r}
dim(proTissue_Combined$ori.data)
```

Show missingness of original combined data
```{r}
proTissue_Combined$ori.data.miss +
  theme(axis.text.x = element_text(size = 7))
```

Show distribution of original combined data
```{r}
# Convert SE object into long data
longData <- summExp2df(proTissue_Combined$ori.data, row_id = 'Protein.Group', col_id = 'Sample')
# Order samples based on cohorts so that same cohorts are clustered in plot
smpLevels <- dplyr::arrange(longData, Cohort) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  dplyr::pull(Sample)
longData <- dplyr::mutate(longData, Sample = factor(Sample, levels = smpLevels))
ggplot(longData, aes(x=Sample, y=Value, col=Cohort)) +
  geom_boxplot(outlier.size = 0.8) +
  scale_color_brewer(palette = 'Set2') +
  scale_y_log10() +
  labs(y = 'Abundance') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

**Remove features quantified in less than 1/2 of samples**\
Show dimensions of filtered data (126 samples and 6126 features)
```{r}
dim(proTissue_Combined$filt.data)
```

Show missingness of filtered data
```{r}
proTissue_Combined$filt.data.miss +
  theme(axis.text.x = element_text(size = 7))
```

**Normalize filtered data by VSN**\
Show distribution of vsn normalized data
```{r}
# Convert SE object into long data
longData <- summExp2df(proTissue_Combined$vsn.data, row_id = 'Protein.Group', col_id = 'Sample')
# Order samples based on cohorts so that same cohorts are clustered in plot
smpLevels <- dplyr::arrange(longData, Cohort) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  dplyr::pull(Sample)
longData <- dplyr::mutate(longData, Sample = factor(Sample, levels = smpLevels))
ggplot(longData, aes(x=Sample, y=Value, col=Cohort)) +
  geom_boxplot(outlier.size = 0.8) +
  scale_color_brewer(palette = 'Set2') +
  labs(y = 'Abundance') +
  th + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

Show feature mean-variance relationship of vsn normalized data
```{r}
proTissue_Combined$vsn.feat.mean.var
```

**Do metadata-assisted quality control**\
Show significant associations between PCs and sample conditions and data cohorts
```{r}
# Do single-omics analysis
proTissueSOA_Combined <- doSOA(proTissue_Combined$vsn.data, meta_var = c('Condition', 'Cohort'),
                               pca_method = 'ppca', do_onlyPCA = T)
proTissueSOA_Combined$pcSigAssoRes
```

Visualize significant PCs
```{r}
pcTab <- proTissueSOA_Combined$pcTab
ggplot(pcTab, aes(x=`PC1 (34%)`, y=`PC2 (24.9%)`, col=Cohort, shape=Condition)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th #+ theme(axis.title = element_text(size = 28),
#              axis.text.x = element_text(size = 24), axis.text.y = element_text(size = 18),
#              legend.title = element_text(size = 26), legend.text = element_text(size = 24))
# ggsave('./output/Discovery/group_meeting/quality_control_beforeBC_combined_proTissue_Krij_condi.png',
#        device = 'png', dpi = 400, height = 8, width = 10)

# ggplot(pcTab, aes(x=Condition, y=`PC1 (34%)`, col=Condition, fill=Condition)) +
#   geom_boxplot(alpha = 0.7, outlier.shape = NA) +
#   geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
#   scale_color_brewer(palette = 'Dark2') +
#   scale_fill_brewer(palette = 'Dark2') +
#   ggpubr::stat_compare_means(method = 't.test', paired = F,
#                              method.args = list(var.equal = T),
#                              size = 6, show.legend = F) +
#   th
```

**Do batch correction using limma**\
There is no PC significantly associated with data cohorts after batch correction,
which supports that batch effects are linear. Batch factor (Cohort) should be included
in linear model for statistical analysis.
```{r}
# Perform batch correction to see if two cohorts can be merged
# Convert SE object into wide data
datMat <- SummarizedExperiment::assay(proTissue_Combined$vsn.data)
# Define design matrix to keep particular effects, e.g., treatments
smpAnnoTab <- as_tibble(colData(proTissue_Combined$vsn.data), rownames = 'Sample')
design <- model.matrix(~ smpAnnoTab$Condition + smpAnnoTab$Recurrence)
# Do batch correction
datMat_BC <- limma::removeBatchEffect(datMat, batch = smpAnnoTab$Cohort, design = design)
proTissueSE_BC <- proTissue_Combined$vsn.data
assay(proTissueSE_BC) <- datMat_BC
# Save batch corrected data
# saveRDS(proTissueSE_BC, './data/Discovery/AG_Krijgsveld/combined_proTissueVsnBC.rds')

# Do single-omics analysis
proTissueSOA_BC <- doSOA(proTissueSE_BC, meta_var = c('Condition', 'Cohort'),
                         pca_method = 'ppca', do_onlyPCA = T)
proTissueSOA_BC$pcSigAssoRes
```

Visualize PCs
```{r}
pcTab <- proTissueSOA_BC$pcTab %>%
  dplyr::mutate(Label = dplyr::case_when(Sample %in% c('I0HVOL_TU', '7EAOX7_TU',
                                                       'MJMTYR_TU', 'XFKHGP_TU',
                                                       'XFKHGP_NG', 'MJMTYR_NG',
                                                       'I0HVOL_NG', '7EAOX7_NG') ~ Sample))
ggplot(pcTab, aes(x=`PC1 (38%)`, y=`PC2 (9.2%)`, col=Cohort, shape=Condition)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = 'Set2') +
  scale_shape_manual(values = c(0, 16)) +
  th #+ theme(axis.title = element_text(size = 28),
#              axis.text.x = element_text(size = 24), axis.text.y = element_text(size = 18),
#              legend.title = element_text(size = 26), legend.text = element_text(size = 24))
# ggsave('./output/Discovery/group_meeting/quality_control_afterBC_combined_proTissue_Krij_condi.png',
#        device = 'png', dpi = 400, height = 8, width = 10)

ggplot(pcTab, aes(x=Condition, y=`PC1 (38%)`, col=Condition, fill=Condition, label = Label)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.3), size = 3, show.legend = F) +
  geom_text_repel(show.legend = F, size = 5) +
  scale_color_brewer(palette = 'Dark2') +
  scale_fill_brewer(palette = 'Dark2') +
  th
```
=> Tumor purity: I0HVOL_TU - 87% / 7EAOX7_TU - 70% / MJMTYR_TU - 40% / XFKHGP_TU - 100%\
(Mean of sample tumor cell contents is 74%, ranging from 40% to 100%.)




# Plasma Proteomics
Due to complexity of plasma samples, we will be focusing on analysis of Baseline
samples. 63 out of 81 patients got Baseline samples and they were extracted and
preprocessed to preserve maximal amounts of reliable features.

```{r message=F}
# Load unprocessed data
proPlasmaTab <- readr::read_tsv('./data/Discovery/AG_Krijgsveld/20230811_MarcS_Discovery_Plasma.pg_matrix.tsv') %>%
  dplyr::select(-c(Protein.Ids, First.Protein.Description)) %>%
  tidyr::pivot_longer(cols = -c('Protein.Group', 'Protein.Names', 'Genes'),
                      names_to = 'Sample', values_to = 'Abundance') %>%
  dplyr::mutate(Protein.Names = stringr::str_remove_all(Protein.Names, '_HUMAN'),
                Sample = stringr::str_remove_all(Sample, '^.+SC_DIS_A_|_4\\.raw$|\\.raw$|^.+KA_|_P'),
                Sample = stringr::str_replace(Sample, 'P_', '_'),
                Sample = stringr::str_remove(Sample, '^SC_A_'),
                Sample = dplyr::case_when(Sample == 'FD01075852' ~ 'R1WTOP_V1',
                                          Sample == 'FD05926483' ~ 'R1WTOP_V2',
                                          Sample == 'FD01282286' ~ 'R1WTOP_V3',
                                          Sample == 'FD07174643' ~ 'R1WTOP_V4',
                                          !Sample %in% c('FD01075852', 'FD05926483',
                                                         'FD01282286', 'FD07174643') ~ Sample),
                Sample = stringr::str_remove_all(Sample, '_FD\\d+|_LV\\d+'),
                # Manually update sample names from data
                Sample = dplyr::case_when(Sample == '1TK71I_V4' ~ '1TK71I_V3',
                                          Sample == 'Y4W4L7_V2' ~ 'D1174FWT_V2',
                                          !Sample %in% c('1TK71I_V4', 'Y4W4L7_V2') ~ Sample))
# Include summarized metadata
proPlasmaTab <- dplyr::left_join(proPlasmaTab, summMetadat, by = 'Sample')
```

Explore time points and exact dates of plasma samples
```{r fig.height=10}
# Explore time points of plasma samples
dplyr::select(proPlasmaTab, Sample, TimePoint, Date) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  DT::datatable()

# Visualize exact dates of plasma samples
tmp_proPlasmaTab <- dplyr::mutate(proPlasmaTab,
                                  Label = dplyr::case_when(TimePoint == 'Baseline' ~ 'Baseline',
                                                           TimePoint != 'Baseline' ~ 'Follow-up'))
ggplot(tmp_proPlasmaTab, aes(x=Date, y=Patient, color=Label)) +
  geom_point(size = 2) +
  labs(title = 'Exact Dates') +
  scale_x_date(date_breaks = 'year', date_labels = '%Y') +
  scale_color_manual(name = 'Time Point', values = c('red2', 'grey40')) +
  theme_minimal() +
  theme(axis.title = element_text(size = 12, face = 'bold'),
        axis.text.x = element_text(size = 10, angle = 60, vjust = 1, hjust = 1),
        plot.title = element_text(size = 14, face = 'bold', hjust = 0.5),
        legend.title = element_text(size = 12), legend.text = element_text(size = 10))
#   theme(axis.title = element_text(size = 24, face = 'bold'),
#         axis.text.x = element_text(size = 12, angle = 60, vjust = 1, hjust = 1),
#         legend.title = element_text(size = 22), legend.text = element_text(size = 20))
# ggsave('./output/group_meeting/smp_dates_proPlasma_Krij.png', device = 'png', dpi = 400, height = 10, width = 12)
```

Show dimensions of original data (289 samples and 969 features)
```{r}
# Preprocess data
proPlasma <- doPreprocessing(proPlasmaTab, feat = 'Protein.Group', smp = 'Sample',
                             val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                             smpAnno = smpAnno, do_featFilt = T, cutoff = 0.5,
                             viz_miss = T, bins = 20)#, save_path = './data/Discovery/AG_Krijgsveld/proPlasma')
# Show dimensions of original data (289 samples and 969 features)
dim(proPlasma$ori.data)
```

Show missingness of original data
```{r}
# Show missingness of original data
proPlasma$ori.data.miss +
  labs(x = 'Samples') +
  theme(axis.text.x = element_blank(), axis.title = element_text(size = 13, face = 'bold'),
        panel.grid.major.y = element_blank())
```

Show sample mean-sd relationship of original data
```{r}
proPlasma$ori.smp.mean.var
```

Show significant associations between data and sample median expressions and missing levels
```{r message=F}
# Normalize unfiltered data
proPlasmaUnfiltVsn <- doPreprocessing(proPlasmaTab, feat = 'Protein.Group', smp = 'Sample',
                                      val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                                      smpAnno = smpAnno, do_featFilt = F)$vsn.data
# Prepare long data for computing sample median expressions and missing levels
proPlasmaUnfiltVsnTab <- summExp2df(proPlasmaUnfiltVsn, assay = 'Abundance',
                                    row_id = 'Protein.Group', col_id = 'Sample') %>%
  # Prepare information of sample median expressions and missing levels
  dplyr::group_by(Sample) %>%
  dplyr::mutate(MedianVsnAbun = median(Value, na.rm = T),
                OriMissLevel = sum(is.na(Value)) / length(Value)) %>%
  dplyr::ungroup()
# Create SE object containing information of sample median expressions and missing levels
colAnno <- dplyr::select(proPlasmaUnfiltVsnTab, Sample, MedianVsnAbun, OriMissLevel) %>%
  dplyr::filter(!duplicated(Sample)) %>%
  tibble::column_to_rownames('Sample')
proPlasmaUnfiltVsn <- SummarizedExperiment(assays = list(Abundance = assay(proPlasmaUnfiltVsn)),
                                           colData = colAnno)

# Do PCA
pcaRes <- doSOA(proPlasmaUnfiltVsn, meta_var = c('MedianVsnAbun', 'OriMissLevel'),
                pca_method = 'ppca', num_PCs = 20, do_onlyPCA = T)
# Show significant associations between PCs and sample median expressions and missing levels
pcaRes$pcSigAssoRes
```

**Remove features quantified in less than 1/2 of samples**\
Show dimensions of filtered data (289 samples and 607 features)
```{r}
dim(proPlasma$filt.data)
```

Show missingness of filtered data
```{r}
proPlasma$filt.data.miss +
  labs(x = 'Samples') +
  theme(axis.text.x = element_blank(), axis.title = element_text(size = 13, face = 'bold'))
```

**Normalize filtered data by VSN**\
Show sample mean-sd relationship of vsn normalized data
```{r}
proPlasma$vsn.smp.mean.var +
  ylim(2.4, 3.6)
```

Show feature mean-sd relationship of vsn normalized data
```{r}
proPlasma$vsn.feat.mean.var
```

## Baseline samples

*Preprocess only Baseline Plasma samples, instead of all Plasma samples, to obtain larger feature space*

Show dimensions of original data (63 samples and 969 features)
```{r}
# Subset certain samples
proBaseTab <- dplyr::filter(proPlasmaTab, TimePoint == 'Baseline')
# Preprocess data
proBase <- doPreprocessing(proBaseTab, feat = 'Protein.Group', smp = 'Sample',
                           val = 'Abundance', featAnno = c('Protein.Names', 'Genes'),
                           smpAnno = smpAnno, do_featFilt = T, cutoff = 0.5,
                           viz_miss = T, bins = 20)#, save_path = './data/Discovery/AG_Krijgsveld/proBase')
dim(proBase$ori.data)
```

Show missingness of original data
```{r}
proBase$ori.data.miss +
  theme(panel.grid.minor.y = element_blank())
```

Show distribution of original data
```{r}
proBase$ori.data.dist
```

**Remove features quantified in less than 1/2 of samples**\
Show dimensions of filtered data (63 samples and 613 features)
```{r}
dim(proBase$filt.data)
```

Show missingness of filtered data
```{r}
proBase$filt.data.miss
```

**Normalize filtered data by VSN**\
Show distribution of vsn normalized data
```{r}
proBase$vsn.data.dist
```

Show feature mean-variance relationship of vsn normalized data
```{r}
proBase$vsn.feat.mean.var
```
